import{Client as e,xml as t}from"@xmpp/client-core";import n from"@xmpp/reconnect";import r from"@xmpp/websocket";import o from"@xmpp/middleware";import i from"@xmpp/stream-features";import s from"@xmpp/iq/caller";import a from"@xmpp/iq/callee";import c from"@xmpp/resolve";import u from"@xmpp/sasl";import l from"@xmpp/resource-binding";import d from"@xmpp/session-establishment";import p from"@xmpp/sasl-anonymous";import f from"@xmpp/sasl-plain";import h from"eventemitter3";var m,g,v=function(e){return y?btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,(function(e,t){return String.fromCharCode(parseInt(t,16))}))):Buffer.from(e).toString("base64")},y="object"==typeof window&&"object"==typeof document,b="object"==typeof process&&"object"==typeof process.versions&&!!process.versions.node,C=!1,S=!1,T=b?require("node-fetch"):fetch,w=b?require("form-data"):FormData,I=y?window.navigator:void 0,E=y&&I?I.mediaDevices:void 0,k=y?window.MediaStream:void 0,x=y?window.MediaStreamTrack:void 0,D=y?window.RTCIceCandidate:void 0,A=y?window.RTCPeerConnection:void 0,R=y?window.RTCRtpReceiver:void 0,O=y?window.RTCRtpSender:void 0,P=y?window.RTCSessionDescription:void 0,L=!!y&&Boolean(E&&(null===window||void 0===window?void 0:window.RTCPeerConnection)),j=y?window.adapter:void 0,M=Object.freeze({__proto__:null,MediaStream:k,MediaStreamTrack:x,RTCIceCandidate:D,RTCPeerConnection:A,RTCRtpReceiver:R,RTCRtpSender:O,RTCSessionDescription:P,adapter:j,base64Encode:v,fetchImpl:T,formDataImpl:w,isBrowser:y,isExpo:S,isNodeJS:b,isReactNative:C,isWebRTCAvailable:L,mediaDevices:E,navigator:I});!function(e){e[e.BOSH=1]="BOSH",e[e.WS=2]="WS"}(m||(m={})),function(e){e.ALL="all",e.TRACE="trace",e.DEBUG="debug",e.VDEBUG="vdebug",e.LOG="log",e.WARN="warn",e.ERROR="error"}(g||(g={}));var N=function(){function e(){this.version="4.0.0",this.creds={appId:"",authKey:""},this.endpoints={api:"api.connectycube.com",chat:"chat.connectycube.com",muc:"muc.chat.connectycube.com"},this.chatProtocol={bosh:"https://chat.connectycube.com:5281",websocket:"wss://chat.connectycube.com:5291",active:2},this.chat={contactList:{subscriptionMode:{mutual:!0}},streamManagement:{enable:!1},ping:{enable:!1,timeInterval:60},reconnect:{enable:!0,timeInterval:5}},this.videochat={alwaysRelayCalls:!1,answerTimeInterval:60,dialingTimeInterval:5,disconnectTimeInterval:30,statsReportTimeInterval:null,iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:turn.connectycube.com"},{urls:"turn:turn.connectycube.com:5349?transport=udp",username:"connectycube",credential:"4c29501ca9207b7fb9c4b4b6b04faeb1"},{urls:"turn:turn.connectycube.com:5349?transport=tcp",username:"connectycube",credential:"4c29501ca9207b7fb9c4b4b6b04faeb1"}]},this.conference={server:"wss://janus.connectycube.com:8989",debug:g.ALL},this.whiteboard={server:"https://whiteboard.connectycube.com"},this.urls={session:"session",login:"login",users:"users",chat:"chat",blobs:"blobs",subscriptions:"subscriptions",events:"events",data:"data",addressbook:"address_book",meetings:"meetings",whiteboards:"whiteboards",calls:"calls",type:".json"},this.on={sessionExpired:void 0,xmppDataWrite:void 0,xmppDataRead:void 0},this.timeout=null,this.debug={mode:1}}return e.getInstance=function(){return e.instance||(e.instance=new e),e.instance},e.prototype.set=function(e){var t=this;e.endpoints&&e.endpoints.chat&&(this.endpoints.muc="muc.".concat(e.endpoints.chat),this.chatProtocol.bosh="https://".concat(e.endpoints.chat,":5281"),this.chatProtocol.websocket="wss://".concat(e.endpoints.chat,":5291")),Object.keys(e).forEach((function(n){if("set"!==n&&t.hasOwnProperty(n)){var r=e[n];"object"!=typeof r?t[n]=r:Object.keys(r).forEach((function(e){var o;(null===(o=t[n])||void 0===o?void 0:o.hasOwnProperty(e))&&(t[n][e]=r[e])}))}}))},e}().getInstance(),U=function(){return U=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},U.apply(this,arguments)};function _(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))}function J(e,t){var n,r,o,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return s.next=a(0),s.throw=a(1),s.return=a(2),"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(a){return function(c){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;s&&(s=0,a[0]&&(i=0)),i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!(o=i.trys,(o=o.length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}}function V(e,t,n){if(n||2===arguments.length)for(var r,o=0,i=t.length;o<i;o++)!r&&o in t||(r||(r=Array.prototype.slice.call(t,0,o)),r[o]=t[o]);return e.concat(r||Array.prototype.slice.call(t))}"function"==typeof SuppressedError&&SuppressedError;var F,z,q=function(){function e(){}return e.safeCallbackCall=function(e){return void 0===e&&(e=function(){}),function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];if("function"==typeof e)try{e.apply(void 0,t)}catch(t){console.error("Error in listener:",t,"Check the code:\n>>>\n".concat(e.toString(),"\n<<<"))}}},e.getUrl=function(e,t,n){var r=t?"/".concat(t):"",o=n?"/".concat(n):"";return"https://".concat(N.endpoints.api,"/").concat(e).concat(r).concat(o).concat(N.urls.type)},e.isArray=function(e){return Array.isArray(e)},e.isObject=function(e){return"[object Object]"===Object.prototype.toString.call(e)},e.getBsonObjectId=function(){var e={machine:Math.floor(16777216*Math.random()).toString(16),pid:Math.floor(32767*Math.random()).toString(16),increment:0},t=Math.floor(Date.now()/1e3).toString(16),n=(e.increment++).toString(16);return parseInt(n,16)>16777215&&(e.increment=0),t.padStart(8,"0")+e.machine.padStart(6,"0")+e.pid.padStart(4,"0")+n.padStart(6,"0")},e.DLog=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];if(e.loggers.length>0)e.loggers.forEach((function(e){return e(t)}));else{if("object"==typeof N.debug)(Array.isArray(N.debug.mode)?N.debug.mode:[N.debug.mode]).forEach((function(t){1===t&&e.loggers.push((function(e){console.log.apply(console,e)}))}));e.loggers.forEach((function(e){return e(t)}))}},e.mergeArrays=function(t,n){for(var r=e.cloneObject(t),o=function(e){var t=r.find((function(t){return t.user_id===e.user_id}));t?Object.assign(t,e):r.push(e)},i=0,s=n;i<s.length;i++){o(s[i])}return r},e.toBase64=function(e){return y?btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,(function(e,t){return String.fromCharCode(parseInt(t,16))}))):Buffer.from(e).toString("base64")},e.callTrafficUsageCallback=function(e,t){if("function"==typeof N.on[e]){var n=function(e){return new Blob([e]).size};N.on[e](function(e){void 0===e&&(e={});var t=e.body,r=e.headers,o=0;return t&&(o+=n("string"==typeof t?t:JSON.stringify(t))),r&&(o+=n(JSON.stringify(r))),o}(t))}},e.cloneObject=function(e,t){void 0===e&&(e={}),void 0===t&&(t=!1);try{var n=JSON.stringify(e),r=t?n.replace(/null/g,'""'):n;return JSON.parse(r)}catch(t){return e}},e.loggers=[],e.env={isReactNative:C,isBrowser:y,isNodeJS:b,isExpo:S},e}();!function(e){e.GET="GET",e.POST="POST",e.PUT="PUT",e.PATCH="PATCH",e.DELETE="DELETE",e.HEAD="HEAD"}(F||(F={})),function(e){e.JSON="json",e.TEXT="text"}(z||(z={}));var W=function(){function e(e){this.route=N.urls.addressbook,this.proxy=e}return e.prototype.uploadAddressBook=function(){return _(this,arguments,void 0,(function(e,t){var n;return void 0===e&&(e=[]),void 0===t&&(t={}),J(this,(function(r){if(!q.isArray(e))throw new Error("First parameter must be an Array.");return n={type:F.POST,url:q.getUrl(this.route),data:U({contacts:e},t)},[2,this.proxy.ajax(n)]}))}))},e.prototype.get=function(e){return _(this,void 0,void 0,(function(){var t;return J(this,(function(n){return t={type:F.GET,url:q.getUrl(this.route),data:e?{udid:e}:void 0},[2,this.proxy.ajax(t)]}))}))},e.prototype.getRegisteredUsers=function(){return _(this,arguments,void 0,(function(e){var t;return void 0===e&&(e=!1),J(this,(function(n){return t={type:F.GET,url:q.getUrl(this.route,"registered_users"),data:"boolean"==typeof e?{compact:e?1:0}:e},[2,this.proxy.ajax(t)]}))}))},e}(),G=function(){function e(e){var t=this;this.routes={session:N.urls.session,login:N.urls.login},this.setSession=function(e){t.proxy.setSession(e)},this.getSession=function(){return _(t,void 0,void 0,(function(){var e;return J(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),e={type:F.GET,url:q.getUrl(this.routes.session)},[4,this.proxy.ajax(e)];case 1:return[2,t.sent().session];case 2:throw t.sent();case 3:return[2]}}))}))},this.createSession=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return _(t,V([],e,!0),void 0,(function(e){var t,n;return void 0===e&&(e={}),J(this,(function(r){switch(r.label){case 0:if(""===N.creds.appId||""===N.creds.authKey)throw new Error('Cannot create a new session without "appId" and "authKey"');r.label=1;case 1:return r.trys.push([1,3,,4]),t={type:F.POST,url:q.getUrl(this.routes.session),data:this.generateCreateSessionParams(e)},[4,this.proxy.ajax(t)];case 2:return n=r.sent(),this.proxy.setSession(n.session),this.proxy.setCurrentUserId(n.session.user_id),[2,n.session];case 3:throw r.sent();case 4:return[2]}}))}))},this.destroySession=function(){return _(t,void 0,void 0,(function(){var e;return J(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),e={type:F.DELETE,url:q.getUrl(this.routes.session),dataType:z.TEXT},[4,this.proxy.ajax(e)];case 1:return t.sent(),this.proxy.setSession(null),this.proxy.setCurrentUserId(null),[3,3];case 2:throw t.sent();case 3:return[2]}}))}))},this.login=function(e){return _(t,void 0,void 0,(function(){var t,n;return J(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),t={type:F.POST,url:q.getUrl(this.routes.login),data:e},[4,this.proxy.ajax(t)];case 1:return n=r.sent().user,this.proxy.setCurrentUserId(n.id),[2,n];case 2:throw r.sent();case 3:return[2]}}))}))},this.logout=function(){return _(t,void 0,void 0,(function(){var e;return J(this,(function(t){return e={type:F.DELETE,url:q.getUrl(this.routes.login),dataType:z.TEXT},this.proxy.setCurrentUserId(null),[2,this.proxy.ajax(e)]}))}))},this.proxy=e}return e.prototype.generateCreateSessionParams=function(e){void 0===e&&(e={});var t={application_id:N.creds.appId,auth_key:N.creds.authKey};return"guest"in e?t.user=e:"login"in e&&"password"in e?t.user={login:e.login,password:e.password}:"email"in e&&"password"in e?t.user={email:e.email,password:e.password}:"provider"in e&&(t.provider=e.provider,"keys"in e&&(t.keys=e.keys),"firebase_phone"in e&&(t.firebase_phone=e.firebase_phone),"firebase_email"in e&&(t.firebase_email=e.firebase_email)),t},e}();function B(t){var h=t.resource,m=t.credentials,g=t.username,v=t.password,y=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}return n}(t,["resource","credentials","username","password"]),b=y.domain,C=y.service;!b&&C&&(y.domain=(C.split("://")[1]||C).split(":")[0].split("/")[0]);var S=new e(y),T=n({entity:S}),w=r({entity:S}),I=o({entity:S}),E=i({middleware:I}),k=s({middleware:I,entity:S}),x=a({middleware:I,entity:S}),D=o({entity:S}),A=c({entity:S}),R=u({streamFeatures:E},m||{username:g,password:v}),O=l({iqCaller:k,streamFeatures:E},h),P=d({iqCaller:k,streamFeatures:E}),L=Object.entries({plain:f,anonymous:p}).map((function(e){var t,n=e[0],r=e[1];return(t={})[n]=r(R),t}));return Object.assign(S,{entity:S,reconnect:T,websocket:w,middleware:I,streamFeatures:E,iqCaller:k,iqCallee:x,starttls:D,resolve:A,sasl:R,resourceBinding:O,sessionEstablishment:P,mechanisms:L})}var H,X,K,Q=t,Y=function(){function e(e){this.route="".concat(N.urls.chat,"/Dialog"),this.subscribeToPublic=this.subscribe,this.unsubscribeFromPublic=this.unsubscribe,this.proxy=e}return e.prototype.list=function(){return _(this,arguments,void 0,(function(e){var t;return void 0===e&&(e={}),J(this,(function(n){return t={type:F.GET,url:q.getUrl(this.route),data:e},[2,this.proxy.ajax(t)]}))}))},e.prototype.create=function(){return _(this,arguments,void 0,(function(e){var t,n;return void 0===e&&(e={type:null}),J(this,(function(r){return t=q.cloneObject(e),q.isArray(null==t?void 0:t.occupants_ids)&&(t.occupants_ids=t.occupants_ids.join(", ")),q.isArray(null==t?void 0:t.admins_ids)&&(t.admins_ids=t.admins_ids.join(", ")),n={type:F.POST,url:q.getUrl(this.route),data:t},[2,this.proxy.ajax(n)]}))}))},e.prototype.update=function(e){return _(this,arguments,void 0,(function(e,t){var n;return void 0===t&&(t={}),J(this,(function(r){return n={type:F.PUT,url:q.getUrl(this.route,e),data:t},[2,this.proxy.ajax(n)]}))}))},e.prototype.delete=function(e){return _(this,arguments,void 0,(function(e,t){var n,r;return void 0===t&&(t={}),J(this,(function(o){return n="string"==typeof e?e.split(",").map((function(e){return e.trim()})):e,r={type:F.DELETE,url:q.getUrl(this.route,n.toString()),dataType:1===n.length?z.TEXT:z.JSON,data:t},[2,this.proxy.ajax(r)]}))}))},e.prototype.addAdmins=function(e,t){return _(this,void 0,void 0,(function(){var n;return J(this,(function(r){return n={type:F.PUT,url:q.getUrl(this.route,e,"admins"),data:{push_all:{admins_ids:t}}},[2,this.proxy.ajax(n)]}))}))},e.prototype.removeAdmins=function(e,t){return _(this,void 0,void 0,(function(){var n;return J(this,(function(r){return n={type:F.PUT,url:q.getUrl(this.route,e,"admins"),data:{pull_all:{admins_ids:t}}},[2,this.proxy.ajax(n)]}))}))},e.prototype.subscribe=function(e){return _(this,void 0,void 0,(function(){var t;return J(this,(function(n){return t={type:F.POST,url:q.getUrl(this.route,e,"subscribe")},[2,this.proxy.ajax(t)]}))}))},e.prototype.unsubscribe=function(e){return _(this,void 0,void 0,(function(){var t;return J(this,(function(n){return t={type:F.DELETE,url:q.getUrl(this.route,e,"subscribe"),dataType:z.TEXT},[2,this.proxy.ajax(t)]}))}))},e.prototype.updateNotificationsSettings=function(e,t){return _(this,void 0,void 0,(function(){var n;return J(this,(function(r){return n={type:F.PUT,url:q.getUrl(this.route,e,"notifications"),data:{enabled:t?1:0}},[2,this.proxy.ajax(n)]}))}))},e.prototype.getNotificationsSettings=function(e){return _(this,void 0,void 0,(function(){var t;return J(this,(function(n){return t={type:F.GET,url:q.getUrl(this.route,e,"notifications")},[2,this.proxy.ajax(t)]}))}))},e.prototype.getPublicOccupants=function(e){return _(this,arguments,void 0,(function(e,t){var n;return void 0===t&&(t={}),J(this,(function(r){return n={type:F.GET,url:q.getUrl(this.route,e,"occupants"),data:t},[2,this.proxy.ajax(n)]}))}))},e.prototype.clearHistory=function(e){return _(this,void 0,void 0,(function(){var t;return J(this,(function(n){return t={type:F.DELETE,url:q.getUrl(this.route,"clearHistory",e),dataType:z.TEXT},[2,this.proxy.ajax(t)]}))}))},e}(),$=function(){function e(e){this.route="".concat(N.urls.chat,"/Message"),this.proxy=e}return e.prototype.list=function(){return _(this,arguments,void 0,(function(e){var t;return void 0===e&&(e={}),J(this,(function(n){return t={url:q.getUrl(this.route),data:e},[2,this.proxy.ajax(t)]}))}))},e.prototype.create=function(){return _(this,arguments,void 0,(function(e){var t;return void 0===e&&(e={}),J(this,(function(n){return t={url:q.getUrl(this.route),type:F.POST,data:e},[2,this.proxy.ajax(t)]}))}))},e.prototype.update=function(e){return _(this,arguments,void 0,(function(e,t){var n;return void 0===t&&(t={}),J(this,(function(r){return n={type:F.PUT,dataType:z.TEXT,url:q.getUrl(this.route,e),data:t},[2,this.proxy.ajax(n)]}))}))},e.prototype.delete=function(e,t){return _(this,void 0,void 0,(function(){var n;return J(this,(function(r){return n={url:q.getUrl(this.route,e),type:F.DELETE,dataType:z.TEXT,data:t},[2,this.proxy.ajax(n)]}))}))},e.prototype.createSystem=function(e){return _(this,void 0,void 0,(function(){var t;return J(this,(function(n){return t={type:F.POST,url:q.getUrl(this.route,"system"),data:e},[2,this.proxy.ajax(t)]}))}))},e.prototype.unreadCount=function(){return _(this,arguments,void 0,(function(e){var t,n;return void 0===e&&(e={}),J(this,(function(r){return(t=q.cloneObject(e))&&t.chat_dialog_ids&&q.isArray(t.chat_dialog_ids)&&(t.chat_dialog_ids=t.chat_dialog_ids.join(", ")),n={url:q.getUrl(this.route,"unread"),data:t},[2,this.proxy.ajax(n)]}))}))},e.prototype.listReactions=function(){return _(this,arguments,void 0,(function(e){var t;return void 0===e&&(e="_"),J(this,(function(n){return t={type:F.GET,dataType:z.JSON,url:q.getUrl(this.route,e,"reactions")},[2,this.proxy.ajax(t)]}))}))},e.prototype.addReaction=function(e,t){return _(this,void 0,void 0,(function(){return J(this,(function(n){return[2,this.updateReaction(e,t)]}))}))},e.prototype.removeReaction=function(e,t){return _(this,void 0,void 0,(function(){return J(this,(function(n){return[2,this.updateReaction(e,void 0,t)]}))}))},e.prototype.updateReaction=function(e,t,n){return _(this,void 0,void 0,(function(){return J(this,(function(r){return[2,this.putReaction(e,{add:t,remove:n})]}))}))},e.prototype.putReaction=function(e,t){return _(this,void 0,void 0,(function(){var n;return J(this,(function(r){return n={type:F.PUT,dataType:z.TEXT,url:q.getUrl(this.route,e,"reactions"),data:t},[2,this.proxy.ajax(n)]}))}))},e}(),Z=function(){function e(){}return e.buildUserJid=function(e){void 0===e&&(e={});var t=e.userId,n=e.resource,r=e.jid,o=N.creds.appId,i=N.endpoints.chat;return t?"".concat(t,"-").concat(o,"@").concat(i).concat(n?"/".concat(n):""):r},e.buildUserJidLocalPart=function(e){return"".concat(e,"-").concat(N.creds.appId)},e.createMessageStanza=function(e){return Q("message",e)},e.createIqStanza=function(e){return Q("iq",e)},e.createPresenceStanza=function(e){return Q("presence",e)},e.createNonza=function(e,t){return Q(e,t)},e.getAttr=function(e,t){return(null==e?void 0:e.getAttr(t))||(null==e?void 0:e.attrs[t])||null},e.getElement=function(e,t){return null==e?void 0:e.getChild(t)},e.getName=function(e){return(null==e?void 0:e.getName())||null},e.getText=function(e){return(null==e?void 0:e.getText())||null},e.getChildElements=function(e){return(null==e?void 0:e.getChildElements())||[]},e.isErrorStanza=function(e){return!!(null==e?void 0:e.getChild("error"))},e.getAllElements=function(e,t){return(null==e?void 0:e.getChildren(t))||[]},e.getElementText=function(e,t){return(null==e?void 0:e.getChildText(t))||null},e.getElementTreePath=function(t,n){return n.reduce((function(t,n){return t?e.getElement(t,n):t}),t)},e.assignObjectToXml=function(t,n,r){return t=t.c(r),Object.keys(n).forEach((function(r){"object"==typeof n[r]?e.assignObjectToXml(t,n[r],r):t=t.c(r).t(n[r]).up()})),t=t.up()},e.assignExtraParamsToXml=function(t,n){var r=e.getElement(t,"extraParams");return Object.keys(n).forEach((function(t){"attachments"===t?n[t].forEach((function(e){r.c("attachment",e).up()})):"object"==typeof n[t]?e.assignObjectToXml(r,n[t],t):r.c(t).t(n[t]).up()})),t.up(),t},e.assignXmlToObject=function(t,n){var r,o=t.children,i=t.name,s=((r={})[i]={},r);return o.forEach((function(t){"string"==typeof t?s[i]=t:t.children.length>0?e.assignXmlToObject(t,s[i]):s[i][t.name]=e.getText(t)})),Object.assign(n,s)},e.parseExtraParams=function(t){if(!t)return null;var n={attachments:[]},r=null;return t.children.forEach((function(o){if("string"!=typeof o){if("attachment"===o.name){var i={};Object.keys(o.attrs).forEach((function(e){i[e]="size"===e?parseInt(o.attrs.size):o.attrs[e]})),n.attachments.push(i)}else"dialog_id"===o.name&&(r=e.getElementText(t,"dialog_id"),n.dialog_id=r);o.children.length&&e.assignXmlToObject(o,n)}})),0===n.attachments.length&&delete n.attachments,n.moduleIdentifier&&delete n.moduleIdentifier,{extension:n,dialogId:r}},e.buildErrorFromXMPPErrorStanza=function(t){var n=e.getElement(t,"error");return{code:parseInt(e.getAttr(n,"code")),info:e.getElementText(n,"text")}},e.getUniqueId=function(e){var t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}));return"string"==typeof e||"number"==typeof e?"".concat(t,":").concat(e):t},e.parseReactions=function(t){return e.getChildElements(t).map((function(t){return{add:"true"===e.getAttr(t,"add"),remove:"true"===e.getAttr(t,"remove"),reaction:e.getAttr(t,"type")}})).reduce((function(e,t){var n=t.add,r=t.remove,o=t.reaction;return n?e.add=o:r&&(e.remove=o),e}),{})},e}(),ee=function(){function e(){this.getUniqueId=Z.getUniqueId,this.getBsonObjectId=q.getBsonObjectId,this.xmppJID=""}return Object.defineProperty(e.prototype,"userCurrentJid",{get:function(){return this.xmppJID},set:function(e){this.xmppJID=e||""},enumerable:!1,configurable:!0}),e.prototype.isNumeric=function(e){return/^-?\d+$/.test(e)||/^\d+\.\d+$/.test(e)},e.prototype.jidOrUserId=function(e){return"string"==typeof e?this.isNumeric(e)?this.getUserJid(e):e.includes("@")?e:this.getRoomJidFromDialogId(e):this.getUserJid(e)},e.prototype.typeChat=function(e){switch(typeof e){case"string":return this.isNumeric(e)?"chat":e.includes("@")?e.includes("muc")?"groupchat":"chat":"groupchat";case"number":return"chat";default:throw new Error("Unsupported chat type")}},e.prototype.getUserJid=function(e){return"".concat(e,"-").concat(N.creds.appId,"@").concat(N.endpoints.chat)},e.prototype.getUserNickWithMucDomain=function(e){return"".concat(N.endpoints.muc,"/").concat(e)},e.prototype.getUserIdFromJID=function(e){return void 0===e&&(e=this.userCurrentJid),(null==e?void 0:e.includes("@"))?parseInt(e.split("@")[0].split("-")[0]):null},e.prototype.getDialogIdFromJID=function(e){return(null==e?void 0:e.includes("@"))?e.split("@")[0].split("_")[1]:null},e.prototype.getRoomJidFromDialogId=function(e){return"".concat(N.creds.appId,"_").concat(e,"@").concat(N.endpoints.muc)},e.prototype.getRoomJid=function(e){return"".concat(e,"/").concat(this.getUserIdFromJID(this.userCurrentJid))},e.prototype.getIdFromResource=function(e){var t=e.split("/");return t.length>1?parseInt(t.slice(1).join("/")):null},e.prototype.getRoomJidFromRoomFullJid=function(e){var t=e.split("/");return t.length>1?t[0]:null},e.prototype.getUserIdFromRoomJid=function(e){var t=e.split("/");return t.length>1?parseInt(t[t.length-1]):null},e.prototype.getDialogJid=function(e){return e.indexOf("@")>0?e:this.getRoomJidFromDialogId(e)},e}(),te=function(){function e(){var e=this;this.xmlns="urn:xmpp:sm:3",this.enabled=!1,this.clientProcessedStanzasCounter=0,this.clientSentStanzasCounter=0,this.lastAck=0,this.unackedQueue=[],this.incomingStanzaHandler=function(t){if("enabled"!==t.name)if(Z.getAttr(t,"xmlns")!==e.xmlns&&++e.clientProcessedStanzasCounter,"r"!==t.name){if("a"===t.name){var n=parseInt(Z.getAttr(t,"h")),r=n-e.lastAck;q.DLog("[Chat][SM][checkCounterOnIncomeStanza]",r,n,e.lastAck);for(var o=0;o<r&&e.unackedQueue.length>0;o++)e.sentMessageCallback(null,e.unackedQueue.shift().message);e.lastAck=n}}else{var i={xmlns:e.xmlns,h:e.clientProcessedStanzasCounter},s=Z.createNonza("a",i);e.originalSend.call(e.xmppClient,s)}else e.enabled=!0}}return e.prototype.enable=function(e){this.enabled||(this.xmppClient=e,this.originalSend=this.xmppClient.send,this.xmppClient.send=this.send.bind(this)),this.clientProcessedStanzasCounter=0,this.clientSentStanzasCounter=0,this.lastAck=0,this.removeElementHandler(),this.addElementHandler();var t=Z.createNonza("enable",{xmlns:this.xmlns});this.xmppClient.send(t)},e.prototype.removeElementHandler=function(){this.xmppClient.removeListener("element",this.incomingStanzaHandler)},e.prototype.addElementHandler=function(){this.xmppClient.on("element",this.incomingStanzaHandler)},e.prototype.send=function(e,t){var n=Z.getAttr(e,"type"),r=Z.getElementText(e,"body"),o=Z.getAllElements(e,"attachment"),i="message"===e.name,s="chat"===n||"groupchat"===n,a=r||o.length;if(this.originalSend.call(this.xmppClient,e),this.enabled&&i&&s&&a){this.unackedQueue.push({message:t,expect:this.clientSentStanzasCounter});var c=Z.createNonza("r",{xmlns:this.xmlns});this.originalSend.call(this.xmppClient,c)}++this.clientSentStanzasCounter},e}(),ne=function(){function e(e){this.xmlns="jabber:iq:roster",this.contacts={},this.helpers=e.helpers,this.xmppClient=e.xmppClient,this.stanzasCallbacks=e.stanzasCallbacks}return e.prototype.get=function(){return _(this,void 0,void 0,(function(){var e=this;return J(this,(function(t){return[2,new Promise((function(t,n){var r={},o=Z.getUniqueId("getRoster"),i=Z.createIqStanza({type:"get",from:e.helpers.userCurrentJid,id:o});i.c("query",{xmlns:e.xmlns}),e.stanzasCallbacks[o]=function(n){for(var o=Z.getAllElements(n,"query"),i=0,s=o.length;i<s;i++){var a=e.helpers.getUserIdFromJID(Z.getAttr(o[i],"jid")),c=Z.getAttr(o[i],"ask"),u=Z.getAttr(o[i],"subscription"),l=Z.getAttr(o[i],"name"),d="".concat(a,"-").concat(N.creds.appId)!==l;r[a]={subscription:u,ask:c||null,name:d?l:null}}t(r)},e.xmppClient.send(i)}))]}))}))},e.prototype.add=function(e){return _(this,void 0,void 0,(function(){var t=this;return J(this,(function(n){return[2,new Promise((function(n,r){var o="object"==typeof e?e.userId:e,i="object"==typeof e?e.name:null,s=t.helpers.jidOrUserId(o),a=Z.getUniqueId("addContactInRoster"),c=Z.createIqStanza({type:"set",from:t.helpers.userCurrentJid,id:a});c.c("query",{xmlns:t.xmlns}).c("item",{jid:s,name:i}),t.contacts[o]={subscription:"none",ask:"subscribe",name:i},t.stanzasCallbacks[a]=function(){t.sendSubscriptionPresence({jid:s,type:"subscribe"}),n()},t.xmppClient.send(c)}))]}))}))},e.prototype.confirm=function(e){return _(this,void 0,void 0,(function(){var t,n;return J(this,(function(r){switch(r.label){case 0:return t="object"==typeof e?e.userId:e,n=this.helpers.jidOrUserId(t),this.sendSubscriptionPresence({jid:n,type:"subscribed"}),N.chat.contactList.subscriptionMode.mutual?[4,this.add(e)]:[3,2];case 1:r.sent(),r.label=2;case 2:return[2]}}))}))},e.prototype.reject=function(e){return _(this,void 0,void 0,(function(){var t=this;return J(this,(function(n){return[2,new Promise((function(n,r){var o=t.helpers.jidOrUserId(e);t.contacts[e]={subscription:"none",ask:null},t.sendSubscriptionPresence({jid:o,type:"unsubscribed"}),n()}))]}))}))},e.prototype.updateName=function(e){return _(this,void 0,void 0,(function(){var t=this;return J(this,(function(n){return[2,new Promise((function(n,r){var o=e.userId,i=e.name,s=void 0===i?null:i,a=t.helpers.jidOrUserId(o),c=Z.getUniqueId("updateContactInRoster");if(q.isObject(t.contacts[o])){t.contacts[o].name=s;var u=Z.createIqStanza({type:"set",from:t.helpers.userCurrentJid,id:c});u.c("query",{xmlns:t.xmlns}).c("item",{jid:a,name:s}),t.stanzasCallbacks[c]=function(e){"result"===Z.getAttr(e,"type")?n():r(e)},t.xmppClient.send(u)}else r("No contact exists with provided user id")}))]}))}))},e.prototype.remove=function(e){return _(this,void 0,void 0,(function(){var t=this;return J(this,(function(n){return[2,new Promise((function(n,r){var o=t.helpers.jidOrUserId(e),i=Z.getUniqueId("removeContactInRoster"),s=Z.createIqStanza({type:"set",from:t.helpers.userCurrentJid,id:i});s.c("query",{xmlns:t.xmlns}).c("item",{jid:o,subscription:"remove"}),t.stanzasCallbacks[i]=function(){delete t.contacts[e],n()},t.xmppClient.send(s)}))]}))}))},e.prototype.sendSubscriptionPresence=function(e){var t={to:e.jid,type:e.type},n=Z.createPresenceStanza(t);this.xmppClient.send(n)},e}(),re=function(){function e(e){this.xmlns="jabber:iq:privacy",this.helpers=e.helpers,this.xmppClient=e.xmppClient,this.stanzasCallbacks=e.stanzasCallbacks}return e.prototype.create=function(e){return _(this,void 0,void 0,(function(){var t=this;return J(this,(function(n){return[2,new Promise((function(n,r){var o=e.items.reduce((function(e,t){var n=t.user_id,r=t.action,o=t.mutualBlock;return e[n]={action:r,mutualBlock:o},e}),{}),i=Object.keys(o),s={type:"set",from:t.helpers.userCurrentJid,id:Z.getUniqueId("edit")},a=Z.createIqStanza(s);a.c("query",{xmlns:t.xmlns}).c("list",{name:e.name});for(var c=0,u=0,l=i.length;c<l;c++,u+=2){var d=i[c],p=o[d],f=p.action,h=p.mutualBlock&&"deny"===f,m=t.helpers.jidOrUserId(parseInt(d,10)),g=t.helpers.getUserNickWithMucDomain(d);t.assignPrivacyItem(a,{order:u+1,value:m,action:f,isMutual:h}),t.assignPrivacyItem(a,{order:u+2,value:g,action:f,isMutual:h})}t.stanzasCallbacks[s.id]=function(e){Z.isErrorStanza(e)?r(Z.buildErrorFromXMPPErrorStanza(e)):n()},t.xmppClient.send(a)}))]}))}))},e.prototype.getList=function(e){return _(this,void 0,void 0,(function(){var t=this;return J(this,(function(n){return[2,new Promise((function(n,r){var o=Z.getUniqueId("getlist"),i=Z.createIqStanza({type:"get",from:t.helpers.userCurrentJid,id:o});i.c("query",{xmlns:t.xmlns}).c("list",{name:e}),t.stanzasCallbacks[o]=function(e){var r=Z.getElement(e,"query"),i=Z.getElement(r,"list"),s={name:Z.getAttr(i,"name"),items:Z.getChildElements(i).map((function(e,n){if(n%2==0){var r=e.attrs,o=r.action,i=r.value;return{user_id:t.helpers.getUserIdFromJID(i),action:o}}return null})).filter((function(e){return null!==e}))};n(s),delete t.stanzasCallbacks[o]},t.xmppClient.send(i)}))]}))}))},e.prototype.update=function(e){return _(this,void 0,void 0,(function(){var t,n;return J(this,(function(r){switch(r.label){case 0:return r.trys.push([0,3,,4]),[4,this.getList(e.name)];case 1:return t=r.sent(),n={items:q.mergeArrays(t.items,e.items),name:e.name},[4,this.create(n)];case 2:return r.sent(),[3,4];case 3:throw r.sent();case 4:return[2]}}))}))},e.prototype.getNames=function(){return _(this,void 0,void 0,(function(){var e=this;return J(this,(function(t){return[2,new Promise((function(t,n){var r=Z.getUniqueId("getNames"),o=Z.createIqStanza({type:"get",from:e.helpers.userCurrentJid,id:r});o.c("query",{xmlns:e.xmlns}),e.stanzasCallbacks[r]=function(e){if(Z.isErrorStanza(e))n(Z.buildErrorFromXMPPErrorStanza(e));else{var r=Z.getElement(e,"query"),o=Z.getElement(r,"default"),i=Z.getElement(r,"active"),s=Z.getAttr(o,"name"),a=Z.getAttr(i,"name"),c=Z.getChildElements(r).map((function(e){return Z.getAttr(e,"name")}));t({default:s,active:a,names:c})}},e.xmppClient.send(o)}))]}))}))},e.prototype.delete=function(e){return _(this,void 0,void 0,(function(){var t=this;return J(this,(function(n){return[2,new Promise((function(n,r){var o=Z.getUniqueId("remove"),i=Z.createIqStanza({type:"set",from:t.helpers.userCurrentJid,id:o});i.c("query",{xmlns:t.xmlns}).c("list",{name:e||""}),t.stanzasCallbacks[o]=function(e){Z.isErrorStanza(e)?r(Z.buildErrorFromXMPPErrorStanza(e)):n()},t.xmppClient.send(i)}))]}))}))},e.prototype.setAsDefault=function(e){return _(this,void 0,void 0,(function(){var t=this;return J(this,(function(n){return[2,new Promise((function(n,r){var o=Z.getUniqueId("default"),i=Z.createIqStanza({type:"set",from:t.helpers.userCurrentJid,id:o});i.c("query",{xmlns:t.xmlns}).c("default",e&&e.length>0?{name:e}:{}),t.stanzasCallbacks[o]=function(e){Z.isErrorStanza(e)?r(Z.buildErrorFromXMPPErrorStanza(e)):n()},t.xmppClient.send(i)}))]}))}))},e.prototype.assignPrivacyItem=function(e,t){var n=t.value,r=t.action,o=t.order,i=t.isMutual,s=Z.getElement(e,"query"),a=Z.getElement(s,"list").c("item",{type:"jid",value:n,action:r,order:o});i?(a.up(),o%2==0&&e.up().up()):a.c("message",{}).up().c("presence-in",{}).up().c("presence-out",{}).up().c("iq",{}).up().up()},e}(),oe=function(){function e(e){this.xmlns="http://jabber.org/protocol/muc",this.helpers=e.helpers,this.xmppClient=e.xmppClient,this.stanzasCallbacks=e.stanzasCallbacks}return e.prototype.join=function(e){return _(this,void 0,void 0,(function(){var t=this;return J(this,(function(n){return[2,new Promise((function(n,r){var o=Z.getUniqueId("join"),i=t.helpers.getDialogJid(e),s=Z.createPresenceStanza({id:o,from:t.helpers.userCurrentJid,to:t.helpers.getRoomJid(i)});s.c("x",{xmlns:t.xmlns}).c("history",{maxstanzas:0}),t.stanzasCallbacks[o]=function(e){var s=Z.getElement(e,"x"),a=Z.getElement(s,"status"),c=Z.getAttr(a,"code");if(a&&"110"==c)t.joinedRooms[i]=!0,n();else{var u=Z.getAttr(s,"xmlns")===t.xmlns&&o.endsWith(":join"),l="error"===Z.getAttr(e,"type");if(u&&l){var d=Z.getElement(e,"error"),p={code:Z.getAttr(d,"code"),message:Z.getElementText(d,"text")||"Unknown issue"};r(p)}}},t.xmppClient.send(s)}))]}))}))},e.prototype.leave=function(e){return _(this,void 0,void 0,(function(){var t=this;return J(this,(function(n){return[2,new Promise((function(n,r){var o=t.helpers.getDialogJid(e),i=Z.createPresenceStanza({type:"unavailable",from:t.helpers.userCurrentJid,to:t.helpers.getRoomJid(o)});delete t.joinedRooms[o],t.stanzasCallbacks["muc:leave"]=function(e){n()},t.xmppClient.send(i)}))]}))}))},e.prototype.listOnlineUsers=function(e){return _(this,void 0,void 0,(function(){var t=this;return J(this,(function(n){return[2,new Promise((function(n,r){var o=Z.getUniqueId("muc_disco_items"),i=Z.createIqStanza({type:"get",to:t.helpers.getDialogJid(e),from:t.helpers.userCurrentJid,id:o});i.c("query",{xmlns:"http://jabber.org/protocol/disco#items"}),t.stanzasCallbacks[o]=function(e){var r=Z.getAttr(e,"id");if(t.stanzasCallbacks[r]){var o=Z.getAttr(e,"query"),i=Z.getChildElements(o).map((function(e){var n=Z.getAttr(e,"jid");return t.helpers.getUserIdFromRoomJid(n)}));n(i)}},t.xmppClient.send(i)}))]}))}))},e}();!function(e){e.CHAT="chat",e.GROUPCHAT="groupchat"}(H||(H={})),function(e){e.STATUS="status",e.ERROR="error",e.DISCONNECTED="disconnected",e.RECONNECTED="reconnected",e.MESSAGE="message",e.SYSTEM_MESSAGE="system-message",e.ERROR_MESSAGE="error-message",e.TYPING_MESSAGE="typing-message",e.UPDATE_MESSAGE="update-message",e.DELETE_MESSAGE="delete-message",e.REACTIONS_MESSAGE="reactions-message",e.DELIVERED_MESSAGE="delivered-message",e.READ_MESSAGE="read-message",e.SENT_MESSAGE="sent-message",e.USER_LAST_ACTIVITY="user-last-activity",e.ROSTER_SUBSCRIBE="roster-subscribe",e.ROSTER_CONFIRM="roster-confirm",e.ROSTER_REJECT="roster-reject",e.ROSTER_LIST="roster-list",e.JOIN="join",e.LEAVE="leave",e.KICK="kick"}(X||(X={})),function(e){e.ALLOW="allow",e.DENY="deny"}(K||(K={}));var ie=function(){function e(e){var t=this;this.isConnected=!1,this.isConnecting=!1,this.isLogout=!1,this.isReconnect=!1,this.stanzasCallbacks={},this.xmppClientListeners=new Map,this.connectPromise=null,this.earlyIncomingMessagesQueue=[],this.pingTimer=null,this.proxy=e,this.dialog=new Y(e),this.message=new $(e),this.helpers=new ee,this.xmppClient=B({service:N.chatProtocol.websocket,credentials:function(e,n){return e({username:t.xmppClient.options.username||"",password:t.xmppClient.options.password||""})}}),N.chat.reconnect.enable&&(this.xmppClient.reconnect.delay=1e3*N.chat.reconnect.timeInterval);var n={xmppClient:this.xmppClient,helpers:this.helpers,stanzasCallbacks:this.stanzasCallbacks};this.contactlist=new ne(n),this.privacylist=new re(n),this.muc=new oe(n),this.isStreamManagementSupported&&(this.streamManagement=new te)}return Object.defineProperty(e.prototype,"connectionStatus",{get:function(){return this.xmppClient.status},enumerable:!1,configurable:!0}),e.prototype.connect=function(e){return _(this,void 0,void 0,(function(){var t=this;return J(this,(function(n){return this.connectPromise=new Promise((function(n,r){return q.DLog("[Chat]","Connect with parameter:",e),t.isConnecting?(q.DLog("[Chat]","Warning! Already in CONNECTING state"),void n(!1)):t.isConnected?(q.DLog("[Chat]","Warning! Chat is already connected!"),void n(!1)):(t.isConnecting=!0,t.isLogout=!1,t.removeAllXMPPClientListeners(),t.addXMPPClientListener("connect",(function(){q.DLog("[Chat]",t.isReconnect?"RECONNECTING":"CONNECTING")})),t.addXMPPClientListener("online",(function(){q.DLog("[Chat]","ONLINE"),t.startPingTimer(),t.postConnectActions(),n(!0),t.connectPromise=null})),t.addXMPPClientListener("offline",(function(){q.DLog("[Chat]","OFFLINE")})),t.addXMPPClientListener("disconnect",(function(){q.DLog("[Chat]","DISCONNECTED"),q.safeCallbackCall(t.onDisconnectedListener)(),N.chat.reconnect.enable?(t.isConnected=!1,t.isConnecting=!1):t.disconnect(),t.stopPingTimer()})),t.addXMPPClientListener("status",(function(e,n){q.DLog("[Chat]","status - ".concat(e),"object"==typeof n?JSON.stringify(n):""),q.safeCallbackCall(t.onChatStatusListener)(e)})),t.addXMPPClientListener("stanza",(function(e){if(e.is("message")&&!t.isConnected)return t.earlyIncomingMessagesQueue.push(e),void q.DLog("[Chat]","on 'stanza': enqueue incoming stanza (isConnected=false)");e.is("presence")?t.onPresence(e):e.is("iq")?t.onIQ(e):e.is("message")&&("headline"===e.attrs.type?t.onSystemMessage(e):"error"===e.attrs.type?t.onMessageError(e):t.onMessage(e))})),t.addXMPPClientListener("error",(function(e){q.DLog("[Chat]","ERROR:",e,{isReconnect:t.isReconnect,connectPromise:!!t.connectPromise}),t.connectPromise?t.isReconnect||("SASLError"==e.name&&(e=e.condition),r(e),t.connectPromise=null):q.safeCallbackCall(t.onConnectionErrorListener)()})),t.addXMPPClientListener("output",(function(e){q.callTrafficUsageCallback("xmppDataWrite",{body:e}),q.DLog("[Chat]","SENT:",e)})),t.addXMPPClientListener("input",(function(e){q.callTrafficUsageCallback("xmppDataRead",{body:e}),q.DLog("[Chat]","RECV:",e)})),t.xmppClient.options.username=Z.buildUserJidLocalPart(e.userId),t.xmppClient.options.password=e.password,void t.xmppClient.start().catch((function(e){console.error("[Chat] xmppClient.start error",e),t.connectPromise?(r(e),t.connectPromise=null):q.safeCallbackCall(t.onConnectionErrorListener)()})))})),[2,this.connectPromise]}))}))},e.prototype.getContacts=function(){return _(this,void 0,void 0,(function(){var e;return J(this,(function(t){switch(t.label){case 0:console.warn("[Deprecated][Chat][ContactList][[XMPP][Roster]]","ConnectyCube.chat.getContacts() and the ConnectyCube.chat.contactlist class will be removed in the next major release."),t.label=1;case 1:return t.trys.push([1,3,,4]),[4,this.contactlist.get()];case 2:return e=t.sent(),this.contactlist.contacts=e,[2,e];case 3:throw t.sent();case 4:return[2]}}))}))},e.prototype.ping=function(){return _(this,void 0,void 0,(function(){var e=this;return J(this,(function(t){return[2,new Promise((function(t,n){var r=Z.getUniqueId("ping"),o=Z.createIqStanza({id:r,type:"get",to:N.endpoints.chat});o.c("ping",{xmlns:"urn:xmpp:ping"}),e.stanzasCallbacks[r]=function(e){var r=Z.getElement(e,"error");r?n(Z.buildErrorFromXMPPErrorStanza(r)):t()},e.xmppClient.send(o)}))]}))}))},e.prototype.pingWithTimeout=function(){return _(this,arguments,void 0,(function(e){return void 0===e&&(e=5e3),J(this,(function(t){return[2,Promise.race([this.ping(),new Promise((function(t,n){return setTimeout((function(){return n(new Error("Chat ping() timed out"))}),e)}))])]}))}))},e.prototype.startPingTimer=function(){var e=this;if(this.stopPingTimer(),N.chat.ping.enable){var t=N.chat.ping.timeInterval<30?30:N.chat.ping.timeInterval;this.pingTimer=setInterval((function(){e.ping()}),1e3*t)}},e.prototype.stopPingTimer=function(){this.pingTimer&&(clearInterval(this.pingTimer),this.pingTimer=null)},e.prototype.send=function(e,t){var n,r;void 0===t&&(t={});var o=null!==(n=t.id)&&void 0!==n?n:q.getBsonObjectId(),i=Z.createMessageStanza({from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e),type:null!==(r=t.type)&&void 0!==r?r:this.helpers.typeChat(e),id:o});return t.id||(t.id=o),t.body&&i.c("body").t(t.body).up(),t.markable&&i.c("markable",{xmlns:"urn:xmpp:chat-markers:0"}).up(),t.extension&&(i.c("extraParams",{xmlns:"jabber:client"}),Z.assignExtraParamsToXml(i,t.extension)),this.isStreamManagementSupported?this.xmppClient.send(i,t):this.xmppClient.send(i),o},e.prototype.sendSystemMessage=function(e,t){var n,r=null!==(n=t.id)&&void 0!==n?n:q.getBsonObjectId(),o=Z.createMessageStanza({type:"headline",id:r,to:this.helpers.jidOrUserId(e)});return t.body&&o.c("body").t(t.body).up(),t.extension&&(o.c("extraParams",{xmlns:"jabber:client"}).c("moduleIdentifier").t("SystemNotifications").up(),Z.assignExtraParamsToXml(o,t.extension)),this.xmppClient.send(o),r},e.prototype.sendIsTypingStatus=function(e){var t=Z.createMessageStanza({from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e),type:this.helpers.typeChat(e)});t.c("composing",{xmlns:"http://jabber.org/protocol/chatstates"}),this.xmppClient.send(t)},e.prototype.sendIsStopTypingStatus=function(e){var t=Z.createMessageStanza({from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e),type:this.helpers.typeChat(e)});t.c("paused",{xmlns:"http://jabber.org/protocol/chatstates"}),this.xmppClient.send(t)},e.prototype.sendDeliveredStatus=function(e){var t=Z.createMessageStanza({type:"chat",from:this.helpers.userCurrentJid,id:q.getBsonObjectId(),to:this.helpers.jidOrUserId(e.userId)});t.c("received",{xmlns:"urn:xmpp:chat-markers:0",id:e.messageId}).up(),t.c("extraParams",{xmlns:"jabber:client"}).c("dialog_id").t(e.dialogId),this.xmppClient.send(t)},e.prototype.sendReadStatus=function(e){var t=Z.createMessageStanza({type:"chat",from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e.userId),id:q.getBsonObjectId()});t.c("displayed",{xmlns:"urn:xmpp:chat-markers:0",id:e.messageId}).up(),t.c("extraParams",{xmlns:"jabber:client"}).c("dialog_id").t(e.dialogId),this.xmppClient.send(t)},e.prototype.editMessage=function(e){var t=Z.createMessageStanza({from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e.to),type:this.helpers.typeChat(e.to),id:q.getBsonObjectId()});t.c("body").t(e.body).up(),t.c("replace",{xmlns:"urn:xmpp:message-correct:0",id:e.originMessageId,last:e.last?"true":"false"}).up(),t.c("extraParams",{xmlns:"jabber:client"}).c("dialog_id").t(e.dialogId),e.extension&&Z.assignExtraParamsToXml(t,e.extension),this.xmppClient.send(t)},e.prototype.deleteMessage=function(e){var t=Z.createMessageStanza({from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e.to),type:this.helpers.typeChat(e.to),id:q.getBsonObjectId()});t.c("remove",{xmlns:"urn:xmpp:message-delete:0",id:e.messageId}).up(),t.c("extraParams",{xmlns:"jabber:client"}).c("dialog_id").t(e.dialogId),this.xmppClient.send(t)},e.prototype.getLastUserActivity=function(e){var t=this;return new Promise((function(n,r){var o=Z.getUniqueId("lastActivity"),i=Z.createIqStanza({type:"get",from:t.helpers.userCurrentJid,to:t.helpers.jidOrUserId(e),id:o});i.c("query",{xmlns:"jabber:iq:last"}),t.stanzasCallbacks[o]=function(e){Z.getElement(e,"error")?r(Z.buildErrorFromXMPPErrorStanza(e)):n(t.onLastActivityStanza(e))},t.xmppClient.send(i)}))},e.prototype.onLastActivityStanza=function(e){var t=Z.getAttr(e,"from"),n=this.helpers.getUserIdFromJID(t),r=Z.getElement(e,"query"),o=r?parseInt(Z.getAttr(r,"seconds")):0;return q.safeCallbackCall(this.onLastUserActivityListener)(n,o),{userId:n,seconds:o}},e.prototype.markActive=function(){var e=Z.createIqStanza({id:this.helpers.getUniqueId("markActive"),type:"set"});e.c("mobile",{xmlns:"http://tigase.org/protocol/mobile#v2",enable:"false"}),this.xmppClient.send(e)},e.prototype.markInactive=function(){var e=Z.createIqStanza({id:this.helpers.getUniqueId("markActive"),type:"set"});e.c("mobile",{xmlns:"http://tigase.org/protocol/mobile#v2",enable:"true"}),this.xmppClient.send(e)},e.prototype.disconnect=function(){return _(this,void 0,void 0,(function(){return J(this,(function(e){switch(e.label){case 0:if(q.DLog("[Chat]","disconnect"),this.isLogout)return q.DLog("[Chat]","Warning! Chat is already disconnected!"),[2,!0];this.muc.joinedRooms={},this.isConnected=!1,this.isConnecting=!1,this.isLogout=!0,this.isReconnect=!1,this.helpers.userCurrentJid="",this.isStreamManagementSupported&&this.streamManagement.removeElementHandler(),e.label=1;case 1:return e.trys.push([1,3,,4]),[4,this.xmppClient.stop()];case 2:return e.sent(),[2,!0];case 3:return e.sent(),[2,!1];case 4:return[2]}}))}))},e.prototype.search=function(e){return _(this,void 0,void 0,(function(){var t,n;return J(this,(function(r){return(t=Object.assign({},e)).start_date&&(t.start_date=new Date(t.start_date).toISOString()),t.end_date&&(t.end_date=new Date(t.end_date).toISOString()),q.isArray(t.chat_dialog_ids)&&(t.chat_dialog_ids=t.chat_dialog_ids.join(",")),n={type:F.GET,url:q.getUrl("".concat(N.urls.chat,"/search")),data:t},[2,this.proxy.ajax(n)]}))}))},e.prototype.onMessage=function(e){var t,n,r,o=Z.getElementTreePath(e,["sent","forwarded","message"]),i=o||e,s=Z.getAttr(i,"from"),a=Z.getAttr(i,"type"),c=Z.getElement(i,"invite"),u=(null===(t=this.xmppClient.jid)||void 0===t?void 0:t.getResource())||"",l="chat"===a;if(!(l&&s.includes(u)||c)){var d=Z.getAttr(i,"id"),p=Z.getElement(i,"markable"),f=Z.getElement(i,"received"),h=Z.getElement(i,"displayed"),m=Z.getElement(i,"replace"),g=Z.getElement(i,"reactions"),v=Z.getElement(i,"remove"),y=Boolean(Z.getElement(i,"composing")),b=Z.getElement(i,"paused"),C=Z.getElement(i,"delay"),S=Z.getElement(i,"extraParams"),T=Z.getElementText(i,"body"),w=Boolean(o),I="groupchat"===a,E=l?Z.getAttr(i,"to"):null,k=E?this.helpers.getUserIdFromJID(E):null,x=S?Z.parseExtraParams(S):null,D=x?x.extension:null,A=I?this.helpers.getDialogIdFromJID(s):null!==(n=null==x?void 0:x.dialogId)&&void 0!==n?n:null,R=I?this.helpers.getIdFromResource(s):this.helpers.getUserIdFromJID(s),O=null===(r=this.xmppClient.jid)||void 0===r?void 0:r.toString(),P=O?this.helpers.getUserIdFromJID(O):0;if(y||b)(l||I||!C)&&q.safeCallbackCall(this.onMessageTypingListener)(y,R,A);else if(m)q.safeCallbackCall(this.onMessageUpdateListener)(Z.getAttr(m,"id"),"true"===Z.getAttr(m,"last"),T,A,R,D);else if(g){if(w&&I)return;var L=Z.getAttr(g,"message_id"),j=parseInt(Z.getAttr(g,"user_id")),M=Z.parseReactions(g),N=M.add,U=M.remove;q.safeCallbackCall(this.onMessageReactionsListener)(L,j,A,N,U)}else if(v){var _=Z.getAttr(v,"id");q.safeCallbackCall(this.onMessageDeleteListener)(_,A,R)}else if(f||h){if(f&&l){var J=Z.getAttr(f,"id");q.safeCallbackCall(this.onDeliveredStatusListener)(J,A,R)}if(h&&l){J=Z.getAttr(h,"id");q.safeCallbackCall(this.onReadStatusListener)(J,A,R)}}else{p&&A&&R&&R!==P&&this.sendDeliveredStatus({messageId:d,dialogId:A,userId:R});var V={id:d,dialog_id:A,recipient_id:k,is_forwarded:w,type:a,body:T,extension:D,delay:C};p&&(V.markable=1),(l||I)&&q.safeCallbackCall(this.onMessageListener)(R,V)}}},e.prototype.onPresence=function(e){var t,n,r,o,i,s=Z.getAttr(e,"from"),a=Z.getAttr(e,"id"),c=Z.getAttr(e,"type"),u=null===(t=this.xmppClient.jid)||void 0===t?void 0:t.toString(),l=this.helpers.getUserIdFromJID(u),d=Z.getElement(e,"x"),p=d?Z.getAttr(d,"xmlns"):null,f=d?Z.getElement(d,"xmlns"):null,h=f?Z.getElementText(f,"code"):null;if(p&&p.startsWith("http://jabber.org/protocol/muc")){if("error"===c)return void(a.endsWith(":join")&&q.safeCallbackCall(this.stanzasCallbacks[a])(e));var m=this.helpers.getDialogIdFromJID(s),g=this.helpers.getUserIdFromRoomJid(s);if(f){if("301"===h){var v=Z.getElement(e,"item"),y=v?Z.getElement(v,"actor"):null,b=y?Z.getAttr(y,"jid"):null,C=this.helpers.getUserIdFromJID(b),S=this.helpers.getRoomJidFromRoomFullJid(s);return q.safeCallbackCall(this.onKickOccupant)(m,C),void(S&&delete this.muc.joinedRooms[S])}if("unavailable"===c)return void(f&&"110"===h&&q.safeCallbackCall(this.stanzasCallbacks["muc:leave"])(null));if(a.endsWith(":join")&&f&&"110"===h)return void(null===(r=(n=this.stanzasCallbacks)[a])||void 0===r||r.call(n,e))}else if(g!=l){var T="unavailable"===c?"onLeaveOccupant":"onJoinOccupant";return void q.safeCallbackCall(this[T])(m,g)}}var w=null!==(o=this.helpers.getUserIdFromJID(s))&&void 0!==o?o:0,I=null!==(i=this.contactlist.contacts[w])&&void 0!==i?i:{ask:null,subscription:null};switch(c){case"subscribe":"to"===(null==I?void 0:I.subscription)?(I.ask=null,I.subscription="both",this.contactlist.sendSubscriptionPresence({jid:s,type:"subscribed"})):q.safeCallbackCall(this.onSubscribeListener)(w);break;case"subscribed":"from"===(null==I?void 0:I.subscription)?(I.ask=null,I.subscription="both"):(I.ask=null,I.subscription="to",q.safeCallbackCall(this.onConfirmSubscribeListener)(w));break;case"unsubscribed":I.ask=null,I.subscription="none",q.safeCallbackCall(this.onRejectSubscribeListener)(w);break;case"unsubscribe":I.ask=null,I.subscription="to";break;case"unavailable":"none"!==(null==I?void 0:I.subscription)&&q.safeCallbackCall(this.onContactListListener)(w,"unavailable"),w===l&&this.xmppClient.send(Z.createPresenceStanza());break;default:"none"!==(null==I?void 0:I.subscription)&&q.safeCallbackCall(this.onContactListListener)(w,"available")}},e.prototype.onIQ=function(e){var t=Z.getAttr(e,"id");if(this.stanzasCallbacks[t])q.safeCallbackCall(this.stanzasCallbacks[t])(e),delete this.stanzasCallbacks[t];else{var n=Z.getAttr(e,"from"),r=Z.getElement(e,"query");n&&r&&this.onLastActivityStanza(e)}},e.prototype.onSystemMessage=function(e){var t=Z.getElementTreePath(e,["sent","forwarded","message"])||e,n=Z.getAttr(t,"from"),r=Z.getAttr(t,"id"),o=Z.getElement(t,"extraParams"),i=this.helpers.getUserIdFromJID(n),s=Z.getElement(t,"delay"),a=o?Z.getElementText(o,"moduleIdentifier"):null,c=Z.getElementText(t,"body"),u=o?Z.parseExtraParams(o):null,l=u?u.extension:null;switch(a){case"SystemNotifications":q.safeCallbackCall(this.onSystemMessageListener)({id:r,userId:i,body:c,extension:l});break;case"WebRTCVideoChat":this.webrtcSignalingProcessor&&!s&&q.safeCallbackCall(this.webrtcSignalingProcessor.onMessage)(i,o)}},e.prototype.onMessageError=function(e){var t=Z.getAttr(e,"id"),n=Z.buildErrorFromXMPPErrorStanza(e);q.safeCallbackCall(this.onMessageErrorListener)(t,n)},e.prototype.postConnectActions=function(){var e,t,n=this;q.DLog("[Chat]",this.isReconnect?"RECONNECTED":"CONNECTED");var r=Z.createPresenceStanza();if(this.isStreamManagementSupported&&(this.streamManagement.enable(this.xmppClient),this.streamManagement.sentMessageCallback=function(e,t){q.safeCallbackCall(n.onSentMessageCallback)(t?null:e,t)}),this.helpers.userCurrentJid=null!==(t=null===(e=this.xmppClient.jid)||void 0===e?void 0:e.toString())&&void 0!==t?t:null,this.isConnected=!0,this.isConnecting=!1,this.enableCarbons(),this.xmppClient.send(r),this.isReconnect?q.safeCallbackCall(this.onReconnectListener)():this.isReconnect=!0,this.earlyIncomingMessagesQueue.length>0){q.DLog("[Chat]","Flush 'earlyIncomingMessagesQueue' (length=".concat(this.earlyIncomingMessagesQueue.length,")"));var o=this.xmppClientListeners.get("stanza");this.earlyIncomingMessagesQueue.forEach((function(e){null==o||o(e)})),this.earlyIncomingMessagesQueue=[]}},e.prototype.enableCarbons=function(){var e=Z.createIqStanza({type:"set",from:this.helpers.userCurrentJid,id:Z.getUniqueId("enableCarbons")});e.c("enable",{xmlns:"urn:xmpp:carbons:2"}),this.xmppClient.send(e)},e.prototype.setSubscriptionToUserLastActivity=function(e,t){var n=Z.createIqStanza({id:this.helpers.getUniqueId("statusStreaming"),type:"set"});n.c("subscribe",{xmlns:"https://connectycube.com/protocol/status_streaming",user_jid:this.helpers.jidOrUserId(e),enable:t}),this.xmppClient.send(n)},e.prototype.subscribeToUserLastActivityStatus=function(e){this.setSubscriptionToUserLastActivity(e,!0)},e.prototype.unsubscribeFromUserLastActivityStatus=function(e){this.setSubscriptionToUserLastActivity(e,!1)},Object.defineProperty(e.prototype,"isStreamManagementSupported",{get:function(){var e,t=!!(null===(e=N.chat.streamManagement)||void 0===e?void 0:e.enable),n=2===N.chatProtocol.active;return t&&!n&&q.DLog("[Chat]","Stream Management is disabled for BOSH"),t&&n},enumerable:!1,configurable:!0}),e.prototype.addXMPPClientListener=function(e,t){this.xmppClient.on(e,t),this.xmppClientListeners.set(e,t)},e.prototype.removeXMPPClientListener=function(e){var t=this.xmppClientListeners.get(e);t&&this.xmppClient.removeListener(e,t),this.xmppClientListeners.delete(e)},e.prototype.removeAllXMPPClientListeners=function(){var e=this;this.xmppClientListeners.forEach((function(t,n){return e.removeXMPPClientListener(n)}))},e.prototype.getListenerByName=function(e){switch(e){case X.STATUS:return"onChatStatusListener";case X.ERROR:return"onConnectionErrorListener";case X.DISCONNECTED:return"onDisconnectedListener";case X.RECONNECTED:return"onReconnectListener";case X.MESSAGE:return"onMessageListener";case X.SYSTEM_MESSAGE:return"onSystemMessageListener";case X.ERROR_MESSAGE:return"onMessageErrorListener";case X.TYPING_MESSAGE:return"onMessageTypingListener";case X.UPDATE_MESSAGE:return"onMessageUpdateListener";case X.DELETE_MESSAGE:return"onMessageDeleteListener";case X.REACTIONS_MESSAGE:return"onMessageReactionsListener";case X.DELIVERED_MESSAGE:return"onDeliveredStatusListener";case X.READ_MESSAGE:return"onReadStatusListener";case X.SENT_MESSAGE:return"onSentMessageCallback";case X.USER_LAST_ACTIVITY:return"onLastUserActivityListener";case X.ROSTER_SUBSCRIBE:return"onSubscribeListener";case X.ROSTER_CONFIRM:return"onConfirmSubscribeListener";case X.ROSTER_REJECT:return"onRejectSubscribeListener";case X.ROSTER_LIST:return"onContactListListener";case X.JOIN:return"onJoinOccupant";case X.LEAVE:return"onLeaveOccupant";case X.KICK:return"onKickOccupant";default:return null}},e.prototype.addListener=function(e,t){var n=this.getListenerByName(e);return n&&(this[n]=t),this.removeListener.bind(this,e)},e.prototype.removeListener=function(e){var t=this.getListenerByName(e);t&&(this[t]=void 0)},e.prototype.removeAllListeners=function(){var e=this;Object.keys(this).forEach((function(t){t.startsWith("on")&&t.endsWith("Listener")&&"function"==typeof e[t]&&(e[t]=void 0)}))},e}();function se(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function ae(e){if(e.__esModule)return e;var t=e.default;if("function"==typeof t){var n=function e(){return this instanceof e?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};n.prototype=t.prototype}else n={};return Object.defineProperty(n,"__esModule",{value:!0}),Object.keys(e).forEach((function(t){var r=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(n,t,r.get?r:{enumerable:!0,get:function(){return e[t]}})})),n}var ce,ue,le=ae(M);var de,pe,fe,he,me,ge=function(){if(ue)return ce;ue=1;const{adapter:e,navigator:t,MediaStream:n,MediaStreamTrack:r,RTCPeerConnection:o,RTCRtpReceiver:i,RTCRtpSender:s,isReactNative:a}=le;u.sessions={},u.mobile=a,u.isExtensionEnabled=function(){if(u.mobile)return!1;if(t.mediaDevices&&t.mediaDevices.getDisplayMedia)return!0;if(window.navigator.userAgent.match("Chrome")){let e=parseInt(window.navigator.userAgent.match(/Chrome\/(.*) /)[1],10),t=33;return window.navigator.userAgent.match("Linux")&&(t=35),e>=26&&e<=t||u.extension.isInstalled()}return!0};const c={extensionId:"hapfgfdkleiggjjpfpenajgdnfckjpaj",isInstalled:function(){return!u.mobile&&null!==document.querySelector("#janus-extension-installed")},getScreen:function(e){if(u.mobile)e();else{let t=window.setTimeout((function(){let t=new Error("NavigatorUserMediaError");return t.name='The required Chrome extension is not installed: click <a href="#">here</a> to install it. (NOTE: this will need you to refresh the page)',e(t)}),1e3);this.cache[t]=e,window.postMessage({type:"janusGetScreen",id:t},"*")}},init:function(){let e={};this.cache=e,u.mobile||window.addEventListener("message",(function(t){if(t.origin==window.location.origin)if("janusGotScreen"==t.data.type&&e[t.data.id]){let n=e[t.data.id];if(delete e[t.data.id],""===t.data.sourceId){let e=new Error("NavigatorUserMediaError");e.name="You cancelled the request for permission, giving up...",n(e)}else n(null,t.data.sourceId)}else"janusGetScreenPending"==t.data.type&&window.clearTimeout(t.data.id)}))}};function u(e){if((e=e||{}).success="function"==typeof e.success?e.success:u.noop,e.error="function"==typeof e.error?e.error:u.noop,e.destroyed="function"==typeof e.destroyed?e.destroyed:u.noop,!u.initDone)return e.error("Library not initialized"),{};if(!u.isWebrtcSupported())return e.error("WebRTC not supported by this browser"),{};if(u.log("Library initialized: "+u.initDone),!e.server)return e.error("Invalid server url"),{};let a=!1,c=null,l={},d=null,p=null,f=0,h=e.server;u.isArray(h)?(u.log("Multiple servers provided ("+h.length+"), will use the first that works"),h=null,p=e.server,u.debug(p)):0===h.indexOf("ws")?(a=!0,u.log("Using WebSockets to contact Janus: "+h)):(a=!1,u.log("Using REST API to contact Janus: "+h));let m=e.iceServers||[{urls:"stun:stun.l.google.com:19302"}],g=e.iceTransportPolicy,v=e.bundlePolicy,y=!1;void 0!==e.withCredentials&&null!==e.withCredentials&&(y=!0===e.withCredentials);let b=10;void 0!==e.max_poll_events&&null!==e.max_poll_events&&(b=e.max_poll_events),b<1&&(b=1);let C=null;void 0!==e.token&&null!==e.token&&(C=e.token);let S=null;void 0!==e.apisecret&&null!==e.apisecret&&(S=e.apisecret),this.destroyOnUnload=!0,void 0!==e.destroyOnUnload&&null!==e.destroyOnUnload&&(this.destroyOnUnload=!0===e.destroyOnUnload);let T=25e3;void 0!==e.keepAlivePeriod&&null!==e.keepAlivePeriod&&(T=e.keepAlivePeriod),isNaN(T)&&(T=25e3);let w=6e4;function I(e){let t={high:9e5,medium:3e5,low:1e5};return null!=e&&(e.high&&(t.high=e.high),e.medium&&(t.medium=e.medium),e.low&&(t.low=e.low)),t}void 0!==e.longPollTimeout&&null!==e.longPollTimeout&&(w=e.longPollTimeout),isNaN(w)&&(w=6e4);let E=!1,k=null,x={},D=this,A=0,R={};function O(){if(null==k)return;if(u.debug("Long poll..."),!E)return void u.warn("Is the server down? (connected=false)");let t=h+"/"+k+"?rid="+(new Date).getTime();b&&(t=t+"&maxev="+b),C&&(t=t+"&token="+encodeURIComponent(C)),S&&(t=t+"&apisecret="+encodeURIComponent(S)),u.httpAPICall(t,{verb:"GET",withCredentials:y,success:P,timeout:w,error:function(t,n){if(u.error(t+":",n),A++,A>3)return E=!1,void e.error("Lost connection to the server (is it down?)");O()}})}function P(e,t){if(A=0,a||null==k||!0===t||O(),a||!u.isArray(e))if("keepalive"!==e.janus)if("server_info"!==e.janus)if("ack"!==e.janus)if("success"!==e.janus)if("trickle"===e.janus){const t=e.sender;if(!t)return void u.warn("Missing sender...");const n=x[t];if(!n)return void u.debug("This handle is not attached to this session");let r=e.candidate;u.debug("Got a trickled candidate on session "+k),u.debug(r);let o=n.webrtcStuff;o.pc&&o.remoteSdp?(u.debug("Adding remote candidate:",r),r&&!0!==r.completed?o.pc.addIceCandidate(r):o.pc.addIceCandidate(u.endOfCandidates)):(u.debug("We didn't do setRemoteDescription (trickle got here before the offer?), caching candidate"),o.candidates||(o.candidates=[]),o.candidates.push(r),u.debug(o.candidates))}else{if("webrtcup"===e.janus){u.debug("Got a webrtcup event on session "+k),u.debug(e);const t=e.sender;if(!t)return void u.warn("Missing sender...");const n=x[t];return n?void n.webrtcState(!0):void u.debug("This handle is not attached to this session")}if("hangup"===e.janus){u.debug("Got a hangup event on session "+k),u.debug(e);const t=e.sender;if(!t)return void u.warn("Missing sender...");const n=x[t];if(!n)return void u.debug("This handle is not attached to this session");n.webrtcState(!1,e.reason),n.hangup()}else if("detached"===e.janus){u.debug("Got a detached event on session "+k),u.debug(e);const t=e.sender;if(!t)return void u.warn("Missing sender...");const n=x[t];if(!n)return;n.ondetached(),n.detach()}else if("media"===e.janus){u.debug("Got a media event on session "+k),u.debug(e);const t=e.sender;if(!t)return void u.warn("Missing sender...");const n=x[t];if(!n)return void u.debug("This handle is not attached to this session");n.mediaState(e.type,e.receiving,e.mid)}else if("slowlink"===e.janus){u.debug("Got a slowlink event on session "+k),u.debug(e);const t=e.sender;if(!t)return void u.warn("Missing sender...");const n=x[t];if(!n)return void u.debug("This handle is not attached to this session");n.slowLink(e.uplink,e.lost,e.mid)}else{if("error"===e.janus){u.error("Ooops: "+e.error.code+" "+e.error.reason),u.debug(e);let t=e.transaction;if(t){let n=R[t];n&&n(e),delete R[t]}return}if("event"===e.janus){u.debug("Got a plugin event on session "+k),u.debug(e);const t=e.sender;if(!t)return void u.warn("Missing sender...");let n=e.plugindata;if(!n)return void u.warn("Missing plugindata...");u.debug("  -- Event is coming from "+t+" ("+n.plugin+")");let r=n.data;u.debug(r);const o=x[t];if(!o)return void u.warn("This handle is not attached to this session");let i=e.jsep;i&&(u.debug("Handling SDP as well..."),u.debug(i));let s=o.onmessage;s?(u.debug("Notifying application..."),s(r,i)):u.debug("No provided notification callback")}else{if("timeout"===e.janus)return u.error("Timeout on session "+k),u.debug(e),void(a&&c.close(3504,"Gateway timeout"));u.warn("Unknown message/event  '"+e.janus+"' on session "+k),u.debug(e)}}}else{u.debug("Got a success on session "+k),u.debug(e);const t=e.transaction;if(t){const n=R[t];n&&n(e),delete R[t]}}else{u.debug("Got an ack on session "+k),u.debug(e);const t=e.transaction;if(t){const n=R[t];n&&n(e),delete R[t]}}else{u.debug("Got info on the Janus instance"),u.debug(e);const t=e.transaction;if(t){const n=R[t];n&&n(e),delete R[t]}}else u.vdebug("Got a keepalive on session "+k);else for(let t=0;t<e.length;t++)P(e[t],!0)}function L(){if(!h||!a||!E)return;d=setTimeout(L,T);let e={janus:"keepalive",session_id:k,transaction:u.randomString(12)};C&&(e.token=C),S&&(e.apisecret=S),c.send(JSON.stringify(e))}function j(t){let n=u.randomString(12),r={janus:"create",transaction:n};if(t.reconnect&&(E=!1,r.janus="claim",r.session_id=k,c&&(c.onopen=null,c.onerror=null,c.onclose=null,d&&(clearTimeout(d),d=null))),C&&(r.token=C),S&&(r.apisecret=S),!h&&u.isArray(p)&&(h=p[f],0===h.indexOf("ws")?(a=!0,u.log("Server #"+(f+1)+": trying WebSockets to contact Janus ("+h+")")):(a=!1,u.log("Server #"+(f+1)+": trying REST API to contact Janus ("+h+")"))),a){c=u.newWebSocket(h,"janus-protocol"),l={error:function(){if(u.error("Error connecting to the Janus WebSockets server... "+h),u.isArray(p)&&!t.reconnect)return f++,f===p.length?void t.error("Error connecting to any of the provided Janus servers: Is the server down?"):(h=null,void setTimeout((function(){j(t)}),200));t.error("Error connecting to the Janus WebSockets server: Is the server down?")},open:function(){R[n]=function(e){if(u.debug(e),"success"!==e.janus)return u.error("Ooops: "+e.error.code+" "+e.error.reason),void t.error(e.error.reason);d=setTimeout(L,T),E=!0,k=e.session_id?e.session_id:e.data.id,t.reconnect?u.log("Claimed session: "+k):u.log("Created session: "+k),u.sessions[k]=D,t.success()},c.send(JSON.stringify(r))},message:function(e){P(JSON.parse(e.data))},close:function(){h&&E&&(E=!1,e.error("Lost connection to the server (is it down?)"))}};for(let e in l)c.addEventListener(e,l[e])}else u.httpAPICall(h,{verb:"POST",withCredentials:y,body:r,success:function(e){if(u.debug(e),"success"!==e.janus)return u.error("Ooops: "+e.error.code+" "+e.error.reason),void t.error(e.error.reason);E=!0,k=e.session_id?e.session_id:e.data.id,t.reconnect?u.log("Claimed session: "+k):u.log("Created session: "+k),u.sessions[k]=D,O(),t.success()},error:function(e,n){if(u.error(e+":",n),u.isArray(p)&&!t.reconnect)return f++,f===p.length?void t.error("Error connecting to any of the provided Janus servers: Is the server down?"):(h=null,void setTimeout((function(){j(t)}),200));""===n?t.error(e+": Is the server down?"):n&&n.error?t.error(e+": "+n.error.message):t.error(e+": "+n)}})}function M(e,t){if((t=t||{}).success="function"==typeof t.success?t.success:u.noop,t.error="function"==typeof t.error?t.error:u.noop,!E)return u.warn("Is the server down? (connected=false)"),void t.error("Is the server down? (connected=false)");let n=x[e];if(!n||!n.webrtcStuff)return u.warn("Invalid handle"),void t.error("Invalid handle");let r=t.message,o=t.jsep,i=u.randomString(12),s={janus:"message",body:r,transaction:i};if(n.token&&(s.token=n.token),S&&(s.apisecret=S),o&&(s.jsep={type:o.type,sdp:o.sdp},o.e2ee&&(s.jsep.e2ee=!0),"hml"!==o.rid_order&&"lmh"!==o.rid_order||(s.jsep.rid_order=o.rid_order),o.force_relay&&(s.jsep.force_relay=!0)),u.debug("Sending message to plugin (handle="+e+"):"),u.debug(s),a)return s.session_id=k,s.handle_id=e,R[i]=function(e){if(u.debug("Message sent!"),u.debug(e),"success"===e.janus){let n=e.plugindata;if(!n)return u.warn("Request succeeded, but missing plugindata..."),void t.success();u.log("Synchronous transaction successful ("+n.plugin+")");let r=n.data;return u.debug(r),void t.success(r)}"ack"===e.janus?t.success():e.error?(u.error("Ooops: "+e.error.code+" "+e.error.reason),t.error(e.error.code+" "+e.error.reason)):(u.error("Unknown error"),t.error("Unknown error"))},void c.send(JSON.stringify(s));u.httpAPICall(h+"/"+k+"/"+e,{verb:"POST",withCredentials:y,body:s,success:function(e){if(u.debug("Message sent!"),u.debug(e),"success"===e.janus){let n=e.plugindata;if(!n)return u.warn("Request succeeded, but missing plugindata..."),void t.success();u.log("Synchronous transaction successful ("+n.plugin+")");let r=n.data;return u.debug(r),void t.success(r)}"ack"===e.janus?t.success():e.error?(u.error("Ooops: "+e.error.code+" "+e.error.reason),t.error(e.error.code+" "+e.error.reason)):(u.error("Unknown error"),t.error("Unknown error"))},error:function(e,n){u.error(e+":",n),t.error(e+": "+n)}})}function N(e,t){if(!E)return void u.warn("Is the server down? (connected=false)");let n=x[e];if(!n||!n.webrtcStuff)return void u.warn("Invalid handle");let r={janus:"trickle",candidate:t,transaction:u.randomString(12)};if(n.token&&(r.token=n.token),S&&(r.apisecret=S),u.vdebug("Sending trickle candidate (handle="+e+"):"),u.vdebug(r),a)return r.session_id=k,r.handle_id=e,void c.send(JSON.stringify(r));u.httpAPICall(h+"/"+k+"/"+e,{verb:"POST",withCredentials:y,body:r,success:function(e){u.vdebug("Candidate sent!"),u.vdebug(e),"ack"===e.janus||u.error("Ooops: "+e.error.code+" "+e.error.reason)},error:function(e,t){u.error(e+":",t)}})}function U(e,t,n,r,o){let i=x[e];if(!i||!i.webrtcStuff)return void u.warn("Invalid handle");let s=i.webrtcStuff;if(!s.pc)return void u.warn("Invalid PeerConnection");let a=function(e){u.log("Received state change on data channel:",e);let t=e.target.label,n=e.target.protocol,r=s.dataChannel[t]?s.dataChannel[t].readyState:"null";if(u.log("State change on <"+t+"> data channel: "+r),"open"===r){if(s.dataChannel[t].pending&&s.dataChannel[t].pending.length>0){u.log("Sending pending messages on <"+t+">:",s.dataChannel[t].pending.length);for(let e of s.dataChannel[t].pending)u.log("Sending data on data channel <"+t+">"),u.debug(e),s.dataChannel[t].send(e);s.dataChannel[t].pending=[]}i.ondataopen(t,n)}};if(r)s.dataChannel[t]=r;else{let e=s.dataChannelOptions;n&&(e.protocol=n),s.dataChannel[t]=s.pc.createDataChannel(t,e)}s.dataChannel[t].onmessage=function(e){u.log("Received message on data channel:",e);let t=e.target.label;i.ondata(e.data,t)},s.dataChannel[t].onopen=a,s.dataChannel[t].onclose=a,s.dataChannel[t].onerror=function(e){u.error("Got error on data channel:",e)},s.dataChannel[t].pending=[],o&&s.dataChannel[t].pending.push(o)}function _(e,t){(t=t||{}).success="function"==typeof t.success?t.success:u.noop,t.error="function"==typeof t.error?t.error:u.noop;let n=x[e];if(!n||!n.webrtcStuff)return u.warn("Invalid handle"),void t.error("Invalid handle");let r=n.webrtcStuff,o=t.text||t.data;if(!o)return u.warn("Invalid data"),void t.error("Invalid data");let i=t.label?t.label:u.dataChanDefaultLabel;return r.dataChannel[i]?"open"!==r.dataChannel[i].readyState?(r.dataChannel[i].pending.push(o),void t.success()):(u.log("Sending data on data channel <"+i+">"),u.debug(o),r.dataChannel[i].send(o),void t.success()):(U(e,i,t.protocol,!1,o,t.protocol),void t.success())}function J(e,t){(t=t||{}).success="function"==typeof t.success?t.success:u.noop,t.error="function"==typeof t.error?t.error:u.noop;let n=x[e];if(!n||!n.webrtcStuff)return u.warn("Invalid handle"),void t.error("Invalid handle");let r=n.webrtcStuff;if(!r.dtmfSender){if(r.pc){let e=r.pc.getSenders().find((function(e){return e.track&&"audio"===e.track.kind}));if(!e)return u.warn("Invalid DTMF configuration (no audio track)"),void t.error("Invalid DTMF configuration (no audio track)");r.dtmfSender=e.dtmf,r.dtmfSender&&(u.log("Created DTMF Sender"),r.dtmfSender.ontonechange=function(e){u.debug("Sent DTMF tone: "+e.tone)})}if(!r.dtmfSender)return u.warn("Invalid DTMF configuration"),void t.error("Invalid DTMF configuration")}let o=t.dtmf;if(!o)return u.warn("Invalid DTMF parameters"),void t.error("Invalid DTMF parameters");let i=o.tones;if(!i)return u.warn("Invalid DTMF string"),void t.error("Invalid DTMF string");let s="number"==typeof o.duration?o.duration:500,a="number"==typeof o.gap?o.gap:50;u.debug("Sending DTMF string "+i+" (duration "+s+"ms, gap "+a+"ms)"),r.dtmfSender.insertDTMF(i,s,a),t.success()}function V(e,t){(t=t||{}).success="function"==typeof t.success?t.success:u.noop,t.error="function"==typeof t.error?t.error:u.noop;let n=!0===t.noRequest;u.log("Destroying handle "+e+" (only-locally="+n+")"),ee(e);let r=x[e];if(!r||r.detached)return delete x[e],void t.success();if(r.detached=!0,n)return delete x[e],void t.success();if(!E)return u.warn("Is the server down? (connected=false)"),void t.error("Is the server down? (connected=false)");let o={janus:"detach",transaction:u.randomString(12)};if(r.token&&(o.token=r.token),S&&(o.apisecret=S),a)return o.session_id=k,o.handle_id=e,c.send(JSON.stringify(o)),delete x[e],void t.success();u.httpAPICall(h+"/"+k+"/"+e,{verb:"POST",withCredentials:y,body:o,success:function(n){u.log("Destroyed handle:"),u.debug(n),"success"!==n.janus&&u.error("Ooops: "+n.error.code+" "+n.error.reason),delete x[e],t.success()},error:function(n,r){u.error(n+":",r),delete x[e],t.success()}})}function F(e,t){let n=x[e];if(!n||!n.webrtcStuff)throw u.warn("Invalid handle"),"Invalid handle";let r=n.webrtcStuff;if(r.pc)return;let i={iceServers:m,iceTransportPolicy:g,bundlePolicy:v,sdpSemantics:"unified-plan"},a=!1;if(t.tracks)for(let e of t.tracks)if(e.transforms&&(e.transforms.sender||e.transforms.receiver)){a=!0;break}s&&(s.prototype.createEncodedStreams||s.prototype.createEncodedAudioStreams&&s.prototype.createEncodedVideoStreams)&&a&&(r.insertableStreams=!0,i.forceEncodedAudioInsertableStreams=!0,i.forceEncodedVideoInsertableStreams=!0,i.encodedInsertableStreams=!0),u.log("Creating PeerConnection"),r.pc=new o(i),u.debug(r.pc),r.pc.getStats&&(r.volume={},r.bitrate.value="0 kbits/sec"),u.log("Preparing local SDP and gathering candidates (trickle="+r.trickle+")"),r.pc.oniceconnectionstatechange=function(){r.pc&&n.iceState(r.pc.iceConnectionState)},r.pc.onicecandidate=function(n){if(!n.candidate||n.candidate.candidate&&n.candidate.candidate.indexOf("endOfCandidates")>0)u.log("End of candidates."),r.iceDone=!0,!0===r.trickle?N(e,{completed:!0}):function(e,t){t=t||{},t.success="function"==typeof t.success?t.success:u.noop,t.error="function"==typeof t.error?t.error:u.noop;let n=x[e];if(!n||!n.webrtcStuff)return void u.warn("Invalid handle, not sending anything");let r=n.webrtcStuff;if(u.log("Sending offer/answer SDP..."),!r.mySdp)return void u.warn("Local SDP instance is invalid, not sending anything...");r.mySdp={type:r.pc.localDescription.type,sdp:r.pc.localDescription.sdp},!1===r.trickle&&(r.mySdp.trickle=!1);u.debug(t),r.sdpSent=!0,t.success(r.mySdp)}(e,t);else{let t={candidate:n.candidate.candidate,sdpMid:n.candidate.sdpMid,sdpMLineIndex:n.candidate.sdpMLineIndex};!0===r.trickle&&N(e,t)}},r.pc.ontrack=function(e){if(u.log("Handling Remote Track",e),!e.streams)return;if(!e.track)return;let t=e.transceiver?e.transceiver.mid||e.transceiver._mid:e.track.id;try{n.onremotetrack(e.track,t,!0,{reason:"created"})}catch(e){u.error("Error calling onremotetrack",e)}if(e.track.onended)return;let o=null;u.log("Adding onended callback to track:",e.track),e.track.onended=function(e){u.log("Remote track removed:",e),clearTimeout(o);let t=r.pc?r.pc.getTransceivers():null,i=t?t.find((t=>{const n=t.receiver||t._receiver;return(n.track||n._track)===e.target})):null,s=i?i.mid||i._mid:e.target.id;try{n.onremotetrack(e.target,s,!1,{reason:"ended"})}catch(e){u.error("Error calling onremotetrack on removal",e)}},e.track.onmute=function(e){if(u.log("Remote track muted:",e),!o){const t=e.target;o=setTimeout((function(){u.log("Removing remote track");let e=r.pc?r.pc.getTransceivers():null,i=e?e.find((e=>{const n=e.receiver||e._receiver;return(n.track||n._track)===t})):null,s=i?i.mid||i._mid:t.id;try{n.onremotetrack(t,s,!1,{reason:"mute"})}catch(e){u.error("Error calling onremotetrack on mute",e)}o=null}),2520)}},e.track.onunmute=function(e){if(u.log("Remote track flowing again:",e),null!=o)clearTimeout(o),o=null;else try{let t=r.pc?r.pc.getTransceivers():null,o=t?t.find((t=>{const n=t.receiver||t._receiver;return(n.track||n._track)===e.target})):null,i=o?o.mid||o._mid:e.target.id;n.onremotetrack(e.target,i,!0,{reason:"unmute"})}catch(e){u.error("Error calling onremotetrack on unmute",e)}}}}async function z(e,t,n){(n=n||{}).success="function"==typeof n.success?n.success:u.noop,n.error="function"==typeof n.error?n.error:Z;let r=n.jsep;if(t&&r)return u.error("Provided a JSEP to a createOffer"),void n.error("Provided a JSEP to a createOffer");if(!(t||r&&r.type&&r.sdp))return u.error("A valid JSEP is required for createAnswer"),void n.error("A valid JSEP is required for createAnswer");if(n.media&&!n.tracks){if(n.tracks=u.mediaToTracks(n.media),!0===n.simulcast||!0===n.simulcast2||n.svc)for(let e of n.tracks)if("video"===e.type){!0===n.simulcast||!0===n.simulcast2?e.simulcast=!0:n.svc&&(e.svc=n.svc);break}u.warn("Deprecated media object passed, use tracks instead. Automatically translated to:",n.tracks)}if(n.tracks&&!Array.isArray(n.tracks))return u.error("Tracks must be an array"),void n.error("Tracks must be an array");let o=x[e];if(!o||!o.webrtcStuff)return u.warn("Invalid handle"),void n.error("Invalid handle");let i=o.webrtcStuff;var s;i.trickle=(s=n.trickle,u.debug("isTrickleEnabled:",s),!1!==s);try{if(F(e,n),t&&await G(e,n),r){if(await i.pc.setRemoteDescription(r),u.log("Remote description accepted!"),i.remoteSdp=r.sdp,i.candidates&&i.candidates.length>0){for(let e=0;e<i.candidates.length;e++){let t=i.candidates[e];u.debug("Adding remote candidate:",t),t&&!0!==t.completed?i.pc.addIceCandidate(t):i.pc.addIceCandidate(u.endOfCandidates)}i.candidates=[]}await G(e,n);let t=await async function(e,t){t=t||{},t.customizeSdp="function"==typeof t.customizeSdp?t.customizeSdp:u.noop;let n=x[e];if(!n||!n.webrtcStuff)throw u.warn("Invalid handle"),"Invalid handle";let r=n.webrtcStuff;u.log("Creating answer (iceDone="+r.iceDone+")");let o=await r.pc.createAnswer();u.debug(o);let i={type:"answer",sdp:o.sdp};if(t.customizeSdp(i),o.sdp=i.sdp,u.log("Setting local description"),r.mySdp={type:"answer",sdp:o.sdp},await r.pc.setLocalDescription(o),!r.iceDone&&!r.trickle)return u.log("Waiting for all candidates..."),null;r.insertableStreams&&(o.e2ee=!0);return o}(e,n);n.success(t)}else{let t=await async function(e,t){t=t||{},t.customizeSdp="function"==typeof t.customizeSdp?t.customizeSdp:u.noop;let n=x[e];if(!n||!n.webrtcStuff)throw u.warn("Invalid handle"),"Invalid handle";let r=n.webrtcStuff;u.log("Creating offer (iceDone="+r.iceDone+")");let o={},i=!0===t.iceRestart;i&&(o.iceRestart=!0);u.debug(o);let s=await r.pc.createOffer(o);u.debug(s);let a={type:"offer",sdp:s.sdp};if(t.customizeSdp(a),s.sdp=a.sdp,u.log("Setting local description"),r.mySdp={type:"offer",sdp:s.sdp},await r.pc.setLocalDescription(s),r.mediaConstraints=o,!r.iceDone&&!r.trickle)return u.log("Waiting for all candidates..."),null;r.insertableStreams&&(s.e2ee=!0);return s}(e,n);n.success(t)}}catch(e){u.error(e),n.error(e)}}function q(e,t){(t=t||{}).success="function"==typeof t.success?t.success:u.noop,t.error="function"==typeof t.error?t.error:Z,t.customizeSdp="function"==typeof t.customizeSdp?t.customizeSdp:u.noop;let n=t.jsep,r=x[e];if(!r||!r.webrtcStuff)return u.warn("Invalid handle"),void t.error("Invalid handle");let o=r.webrtcStuff;if(n){if(!o.pc)return u.warn("Wait, no PeerConnection?? if this is an answer, use createAnswer and not handleRemoteJsep"),void t.error("No PeerConnection: if this is an answer, use createAnswer and not handleRemoteJsep");t.customizeSdp(n),o.pc.setRemoteDescription(n).then((function(){if(u.log("Remote description accepted!"),o.remoteSdp=n.sdp,o.candidates&&o.candidates.length>0){for(let e=0;e<o.candidates.length;e++){let t=o.candidates[e];u.debug("Adding remote candidate:",t),t&&!0!==t.completed?o.pc.addIceCandidate(t):o.pc.addIceCandidate(u.endOfCandidates)}o.candidates=[]}t.success()}),t.error)}else t.error("Invalid JSEP")}async function W(e,t){if((t=t||{}).success="function"==typeof t.success?t.success:u.noop,t.error="function"==typeof t.error?t.error:u.noop,t.tracks&&!Array.isArray(t.tracks))return u.error("Tracks must be an array"),void t.error("Tracks must be an array");for(let e of t.tracks)(e.add||!e.replace&&!e.remove)&&(e.replace=!0);try{await G(e,t),t.success()}catch(e){u.error(e),t.error(e)}}async function G(e,o){let a=x[e];if(!a||!a.webrtcStuff)throw u.warn("Invalid handle, not sending anything"),"Invalid handle";let c=a.webrtcStuff;if(!c.pc)throw u.warn("Invalid PeerConnection"),"Invalid PeerConnection";let l=o.tracks;if(!l||!Array.isArray(l)||0===l.length)return;let d=!1,p={};for(let e of l){if(delete e.gumGroup,!e.type||!["audio","video"].includes(e.type))continue;if(!e.capture||e.capture instanceof r)continue;let t=e.group?e.group:"default";p[t]||(p[t]={}),p[t][e.type]||(e.gumGroup=t,p[t][e.type]=e)}let f=Object.keys(p);for(let e of f){let t=p[e];t.audio&&t.video||(t.audio&&delete t.audio.gumGroup,t.video&&delete t.video.gumGroup,delete p[e])}let h=!!o.jsep;for(let o of l){if(!o.type){u.warn("Missing track type:",o);continue}if("data"===o.type){if(c.pc.ondatachannel){u.warn("Data channel exists already, not creating another one");continue}u.log("Creating default data channel"),U(e,u.dataChanDefaultLabel,null,!1),c.pc.ondatachannel=function(t){u.log("Data channel created by Janus:",t),U(e,t.channel.label,t.channel.protocol,t.channel)};continue}if(void 0===o.add&&null===o.add&&void 0===o.remove&&null===o.remove&&void 0===o.replace&&null===o.replace&&(o.add=!0),o.add&&o.remove||o.add&&o.remove&&o.replace){u.warn("Conflicting actions for track, ignoring:",o);continue}o.add&&o.replace?(u.warn("Both add and replace provided, falling back to replace:",o),delete o.add):o.remove&&o.replace&&(u.warn("Both remove and replace provided, falling back to remove:",o),delete o.replace);let l=o.type;"screen"===o.type&&(l="video");let f=null,m=null;if(f=o.mid?c.pc.getTransceivers().find((e=>e.mid===o.mid&&e.receiver.track.kind===l)):c.pc.getTransceivers().find((e=>e.receiver.track.kind===l)),o.replace||o.remove){if(!f){u.warn("Couldn't find a transceiver for track:",o);continue}if(!f.sender){u.warn("No sender in the transceiver for track:",o);continue}m=f.sender}if(h&&!f&&(f=c.pc.getTransceivers().find((e=>e.receiver.track.kind===l)),!f)){u.warn("Couldn't find a transceiver for track:",o);continue}let g=null,v=null;if(o.remove)u.log("Removing track from PeerConnection",o),v=m.track?m.track.id:null,await m.replaceTrack(null);else if(o.capture){if(o.gumGroup&&p[o.gumGroup]&&p[o.gumGroup].stream){let e=p[o.gumGroup].stream;g="audio"===o.type?e.getAudioTracks()[0]:e.getVideoTracks()[0],delete p[o.gumGroup].stream,delete p[o.gumGroup],delete o.gumGroup}else if(o.capture instanceof r)g=o.capture;else{d||(d=!0,a.consentDialog(!0));let e=u.trackConstraints(o),n=null;if("audio"===o.type||"video"===o.type){if(o.gumGroup){let t="audio"===o.type?"video":"audio";if(p[o.gumGroup]&&p[o.gumGroup][t]){let n=p[o.gumGroup][t],r=u.trackConstraints(n);e[t]=r[t]}}n=await t.mediaDevices.getUserMedia(e),o.gumGroup&&e.audio&&e.video&&(p[o.gumGroup].stream=n,delete o.gumGroup)}else n=await t.mediaDevices.getDisplayMedia(e);g="audio"===o.type?n.getAudioTracks()[0]:n.getVideoTracks()[0]}if(o.replace){await m.replaceTrack(g);let e="sendrecv";!1!==o.recv&&"inactive"!==f.direction&&"sendonly"!==f.direction||(e="sendonly"),f.setDirection?f.setDirection(e):f.direction=e}else{if(c.myStream||(c.myStream=new n),"audio"===l||!o.simulcast&&!o.svc)m=c.pc.addTrack(g,c.myStream),f=c.pc.getTransceivers().find((e=>e.sender===m));else if(o.simulcast){if("firefox"!==u.webRTCAdapter.browserDetails.browser){u.log("Enabling rid-based simulcasting:",g);let e=I(o.simulcastMaxBitrates);f=c.pc.addTransceiver(g,{direction:"sendrecv",streams:[c.myStream],sendEncodings:o.sendEncodings||[{rid:"h",active:!0,maxBitrate:e.high},{rid:"m",active:!0,maxBitrate:e.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:e.low,scaleResolutionDownBy:4}]})}else if(u.log("Enabling Simulcasting for Firefox (RID)"),f=c.pc.addTransceiver(g,{direction:"sendrecv",streams:[c.myStream]}),m=f?f.sender:null,m){let e=m.getParameters();e||(e={});let t=I(o.simulcastMaxBitrates);e.encodings=o.sendEncodings||[{rid:"h",active:!0,maxBitrate:t.high},{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:t.low,scaleResolutionDownBy:4}],m.setParameters(e)}}else u.log("Enabling SVC ("+o.svc+"):",g),f=c.pc.addTransceiver(g,{direction:"sendrecv",streams:[c.myStream],sendEncodings:[{scalabilityMode:o.svc}]});if(m||(m=f?f.sender:null),o.codec)if("firefox"===u.webRTCAdapter.browserDetails.browser)u.warn("setCodecPreferences not supported in Firefox, ignoring codec for track:",o);else if("string"!=typeof o.codec)u.warn("Invalid codec value, ignoring for track:",o);else{let e=l+"/"+o.codec.toLowerCase(),t=i.getCapabilities(l).codecs.filter((function(t){return t.mimeType.toLowerCase()===e}));if(t&&0!==t.length){if(f)try{f.setCodecPreferences(t)}catch(e){u.warn("Failed enforcing codec for this "+l+" track:",e)}}else u.warn("Codec not supported in this browser for this track, ignoring:",o)}if(o.bitrate)if(o.simulcast||o.svc)u.warn("Ignoring bitrate for simulcast/SVC track, use sendEncodings for that");else if(isNaN(o.bitrate)||o.bitrate<0)u.warn("Ignoring invalid bitrate for track:",o);else if(m){let e=m.getParameters();e&&e.encodings&&0!==e.encodings.length?(e.encodings[0].maxBitrate=o.bitrate,await m.setParameters(e)):u.warn("No encodings in the sender parameters, ignoring bitrate for track:",o)}if("video"===l&&o.framerate)if(o.simulcast||o.svc)u.warn("Ignoring framerate for simulcast/SVC track, use sendEncodings for that");else if(isNaN(o.framerate)||o.framerate<0)u.warn("Ignoring invalid framerate for track:",o);else if(m){let e=m.getParameters();e&&e.encodings&&0!==e.encodings.length?(e.encodings[0].maxFramerate=o.framerate,await m.setParameters(e)):u.warn("No encodings in the sender parameters, ignoring framerate for track:",o)}if(o.transforms){if(m&&o.transforms.sender){let e=null;s.prototype.createEncodedStreams?e=m.createEncodedStreams():(s.prototype.createAudioEncodedStreams||s.prototype.createEncodedVideoStreams)&&("audio"===l?e=m.createEncodedAudioStreams():"video"===l&&(e=m.createEncodedVideoStreams())),e&&(u.log("Insertable Streams sender transform:",e),e.readableStream&&e.writableStream?e.readableStream.pipeThrough(o.transforms.sender).pipeTo(e.writableStream):e.readable&&e.writable&&e.readable.pipeThrough(o.transforms.sender).pipeTo(e.writable))}if(f&&f.receiver&&o.transforms.receiver){let e=null;i.prototype.createEncodedStreams?e=f.receiver.createEncodedStreams():(i.prototype.createAudioEncodedStreams||i.prototype.createEncodedVideoStreams)&&("audio"===l?e=f.receiver.createEncodedAudioStreams():"video"===l&&(e=f.receiver.createEncodedVideoStreams())),e&&(u.log("Insertable Streams receiver transform:",e),e.readableStream&&e.writableStream?e.readableStream.pipeThrough(o.transforms.receiver).pipeTo(e.writableStream):e.readable&&e.writable&&e.readable.pipeThrough(o.transforms.receiver).pipeTo(e.writable))}}}g&&!0===o.dontStop&&(g.dontStop=!0)}else if(o.recv&&!f&&(f=c.pc.addTransceiver(l),f)){if(o.codec)if("firefox"===u.webRTCAdapter.browserDetails.browser)u.warn("setCodecPreferences not supported in Firefox, ignoring codec for track:",o);else if("string"!=typeof o.codec)u.warn("Invalid codec value, ignoring for track:",o);else{let e=l+"/"+o.codec.toLowerCase(),t=i.getCapabilities(l).codecs.filter((function(t){return t.mimeType.toLowerCase()===e}));if(t&&0!==t.length)try{f.setCodecPreferences(t)}catch(e){u.warn("Failed enforcing codec for this "+l+" track:",e)}else u.warn("Codec not supported in this browser for this track, ignoring:",o)}if(f.receiver&&o.transforms&&o.transforms.receiver){let e=null;i.prototype.createEncodedStreams?e=f.receiver.createEncodedStreams():(i.prototype.createAudioEncodedStreams||i.prototype.createEncodedVideoStreams)&&("audio"===l?e=f.receiver.createEncodedAudioStreams():"video"===l&&(e=f.receiver.createEncodedVideoStreams())),e&&(u.log("Insertable Streams receiver transform:",e),e.readableStream&&e.writableStream?e.readableStream.pipeThrough(o.transforms.receiver).pipeTo(e.writableStream):e.readable&&e.writable&&e.readable.pipeThrough(o.transforms.receiver).pipeTo(e.writable))}}if(v&&c.myStream){let e=null;if("audio"===l&&c.myStream.getAudioTracks()&&c.myStream.getAudioTracks().length)for(let t of c.myStream.getAudioTracks())t.id===v&&(e=t,u.log("Removing audio track:",e));else if("video"===l&&c.myStream.getVideoTracks()&&c.myStream.getVideoTracks().length)for(let t of c.myStream.getVideoTracks())t.id===v&&(e=t,u.log("Removing video track:",e));if(e){try{c.myStream.removeTrack(e),a.onlocaltrack(e,!1)}catch(e){u.error("Error calling onlocaltrack on removal for renegotiation",e)}if(!0!==e.dontStop)try{e.stop()}catch(e){}}}if(g){c.myStream.addTrack(g),g.onended=function(e){u.log("Local track removed:",e);try{a.onlocaltrack(e.target,!1)}catch(e){u.error("Error calling onlocaltrack following end",e)}};try{a.onlocaltrack(g,!0)}catch(e){u.error("Error calling onlocaltrack for track add",e)}}if(f){let e=f.direction,t=null,n=g&&f.sender.track,r=!1!==o.recv&&f.receiver.track;n&&r?t="sendrecv":n&&!r?t="sendonly":!n&&r?t="recvonly":n||r||(t="inactive"),t&&t!==e&&(u.warn("Changing direction of transceiver to "+t+" (was "+e+")",o),f.setDirection?f.setDirection(t):f.direction=t)}}d&&a.consentDialog(!1)}function B(e){let t=x[e];if(!t||!t.webrtcStuff)return u.warn("Invalid handle"),null;let n=t.webrtcStuff;if(!n.pc)return u.warn("Invalid PeerConnection"),null;let r=[],o=n.pc.getTransceivers();for(let e of o){let t=null;e.sender&&e.sender.track&&(t={mid:e.mid},t.type=e.sender.track.kind,t.id=e.sender.track.id,t.label=e.sender.track.label),t&&r.push(t)}return r}function H(e){let t=x[e];if(!t||!t.webrtcStuff)return u.warn("Invalid handle"),null;let n=t.webrtcStuff;if(!n.pc)return u.warn("Invalid PeerConnection"),null;let r=[],o=n.pc.getTransceivers();for(let e of o){let t=null;e.receiver&&e.receiver.track&&(t={mid:e.mid},t.type=e.receiver.track.kind,t.id=e.receiver.track.id,t.label=e.receiver.track.label),t&&r.push(t)}return r}function X(e,t,n,r){r="function"==typeof r?r:u.noop;let o=x[e];if(!o||!o.webrtcStuff)return u.warn("Invalid handle"),void r(0);let i=n?"remote":"local",s=o.webrtcStuff;if(s.volume[i]||(s.volume[i]={value:0}),s.pc&&s.pc.getStats&&("chrome"===u.webRTCAdapter.browserDetails.browser||"safari"===u.webRTCAdapter.browserDetails.browser)){let e=s.pc;if(t){let o=s.pc.getTransceivers().find((e=>e.mid===t&&"audio"===e.receiver.track.kind));if(!o)return u.warn("No audio transceiver with mid "+t),void r(0);if(n&&!o.receiver)return u.warn("Remote transceiver track unavailable"),void r(0);if(!n&&!o.sender)return u.warn("Local transceiver track unavailable"),void r(0);e=n?o.receiver:o.sender}return e.getStats().then((function(e){e.forEach((function(e){e&&"audio"===e.kind&&(n&&!e.remoteSource||!n&&"media-source"!==e.type||r(e.audioLevel?e.audioLevel:0))}))})),s.volume[i].value}return u.warn("Getting the "+i+" volume unsupported by browser"),void r(0)}function K(e,t,n){let r=x[e];if(!r||!r.webrtcStuff)return u.warn("Invalid handle"),!0;let o=r.webrtcStuff;if(!o.pc)return u.warn("Invalid PeerConnection"),!0;if(!o.myStream)return u.warn("Invalid local MediaStream"),!0;if(n){if(!o.myStream.getVideoTracks()||0===o.myStream.getVideoTracks().length)return u.warn("No video track"),!0;if(t){let e=o.pc.getTransceivers().find((e=>e.mid===t&&"video"===e.receiver.track.kind));return e?e.sender&&e.sender.track?!e.sender.track.enabled:(u.warn("No video sender with mid "+t),!0):(u.warn("No video transceiver with mid "+t),!0)}return!o.myStream.getVideoTracks()[0].enabled}if(!o.myStream.getAudioTracks()||0===o.myStream.getAudioTracks().length)return u.warn("No audio track"),!0;if(t){let e=o.pc.getTransceivers().find((e=>e.mid===t&&"audio"===e.receiver.track.kind));return e?e.sender&&e.sender.track?!e.sender.track.enabled:(u.warn("No audio sender with mid "+t),!0):(u.warn("No audio transceiver with mid "+t),!0)}return!o.myStream.getAudioTracks()[0].enabled}function Q(e,t,n,r){let o=x[e];if(!o||!o.webrtcStuff)return u.warn("Invalid handle"),!1;let i=o.webrtcStuff;if(!i.pc)return u.warn("Invalid PeerConnection"),!1;if(!i.myStream)return u.warn("Invalid local MediaStream"),!1;if(n){if(!i.myStream.getVideoTracks()||0===i.myStream.getVideoTracks().length)return u.warn("No video track"),!1;if(t){let e=i.pc.getTransceivers().find((e=>e.mid===t&&"video"===e.receiver.track.kind));if(!e)return u.warn("No video transceiver with mid "+t),!1;if(!e.sender||!e.sender.track)return u.warn("No video sender with mid "+t),!1;e.sender.track.enabled=!r}else for(const e of i.myStream.getVideoTracks())e.enabled=!r}else{if(!i.myStream.getAudioTracks()||0===i.myStream.getAudioTracks().length)return u.warn("No audio track"),!1;if(t){let e=i.pc.getTransceivers().find((e=>e.mid===t&&"audio"===e.receiver.track.kind));if(!e)return u.warn("No audio transceiver with mid "+t),!1;if(!e.sender||!e.sender.track)return u.warn("No audio sender with mid "+t),!1;e.sender.track.enabled=!r}else for(const e of i.myStream.getAudioTracks())e.enabled=!r}return!0}function Y(e,t){let n=x[e];if(!n||!n.webrtcStuff)return u.warn("Invalid handle"),"Invalid handle";let r=n.webrtcStuff;if(!r.pc)return"Invalid PeerConnection";if(r.pc.getStats){let e=r.pc,n=t||"default";if(t){let n=r.pc.getTransceivers().find((e=>e.mid===t&&"video"===e.receiver.track.kind));if(!n)return u.warn("No video transceiver with mid "+t),"No video transceiver with mid "+t;if(!n.receiver)return u.warn("No video receiver with mid "+t),"No video receiver with mid "+t;e=n.receiver}return r.bitrate[n]||(r.bitrate[n]={timer:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,value:"0 kbits/sec"}),r.bitrate[n].timer?r.bitrate[n].value:(u.log("Starting bitrate timer"+(t?" for mid "+t:"")+" (via getStats)"),r.bitrate[n].timer=setInterval((function(){e.getStats().then((function(e){e.forEach((function(e){if(!e)return;let t=!1;if(("video"===e.mediaType||e.id.toLowerCase().indexOf("video")>-1)&&"inbound-rtp"===e.type&&e.id.indexOf("rtcp")<0?t=!0:"ssrc"!=e.type||!e.bytesReceived||"VP8"!==e.googCodecName&&""!==e.googCodecName||(t=!0),t)if(r.bitrate[n].bsnow=e.bytesReceived,r.bitrate[n].tsnow=e.timestamp,null===r.bitrate[n].bsbefore||null===r.bitrate[n].tsbefore)r.bitrate[n].bsbefore=r.bitrate[n].bsnow,r.bitrate[n].tsbefore=r.bitrate[n].tsnow;else{let e=r.bitrate[n].tsnow-r.bitrate[n].tsbefore;"safari"===u.webRTCAdapter.browserDetails.browser&&(e/=1e3);let t=Math.round(8*(r.bitrate[n].bsnow-r.bitrate[n].bsbefore)/e);"safari"===u.webRTCAdapter.browserDetails.browser&&(t=parseInt(t/1e3)),r.bitrate[n].value=t+" kbits/sec",r.bitrate[n].bsbefore=r.bitrate[n].bsnow,r.bitrate[n].tsbefore=r.bitrate[n].tsnow}}))}))}),1e3),"0 kbits/sec")}return u.warn("Getting the video bitrate unsupported by browser"),"Feature unsupported by browser"}function $(e,t,n){let r=x[e];if(!r||!r.webrtcStuff)return void u.warn("Invalid handle");let o=r.webrtcStuff;if(!o.pc)return void u.warn("Invalid PeerConnection");let i=o.pc.getTransceivers().find((e=>e.mid===t));if(!i)return void u.warn("No transceiver with mid",t);if(!i.sender)return void u.warn("No sender for transceiver with mid",t);let s=i.sender.getParameters();s&&s.encodings&&0!==s.encodings.length?s.encodings.length>1?u.warn("Ignoring bitrate for simulcast track, use sendEncodings for that"):isNaN(n)||n<0?u.warn("Invalid bitrate (must be a positive integer)"):(s.encodings[0].maxBitrate=n,i.sender.setParameters(s)):u.warn("No parameters encodings")}function Z(e){u.error("WebRTC error:",e)}function ee(e,t){u.log("Cleaning WebRTC stuff");let n=x[e];if(!n)return;let r=n.webrtcStuff;if(r){if(!0===t){let t={janus:"hangup",transaction:u.randomString(12)};n.token&&(t.token=n.token),S&&(t.apisecret=S),u.debug("Sending hangup request (handle="+e+"):"),u.debug(t),a?(t.session_id=k,t.handle_id=e,c.send(JSON.stringify(t))):u.httpAPICall(h+"/"+k+"/"+e,{verb:"POST",withCredentials:y,body:t})}r.volume&&(r.volume.local&&r.volume.local.timer&&clearInterval(r.volume.local.timer),r.volume.remote&&r.volume.remote.timer&&clearInterval(r.volume.remote.timer));for(let e in r.bitrate)r.bitrate[e].timer&&clearInterval(r.bitrate[e].timer);r.bitrate={},!r.streamExternal&&r.myStream&&(u.log("Stopping local stream tracks"),u.stopAllTracks(r.myStream)),r.streamExternal=!1,r.myStream=null;try{r.pc.close()}catch(e){}r.pc=null,r.candidates=null,r.mySdp=null,r.remoteSdp=null,r.iceDone=!1,r.dataChannel={},r.dtmfSender=null,r.insertableStreams=!1}n.oncleanup()}j(e),this.getServer=function(){return h},this.isConnected=function(){return E},this.reconnect=function(e){(e=e||{}).success="function"==typeof e.success?e.success:u.noop,e.error="function"==typeof e.error?e.error:u.noop,e.reconnect=!0,j(e)},this.getSessionId=function(){return k},this.getInfo=function(e){!function(e){if(e=e||{},e.success="function"==typeof e.success?e.success:u.noop,e.error="function"==typeof e.error?e.error:u.noop,u.log("Getting info on Janus instance"),!E)return u.warn("Is the server down? (connected=false)"),void e.error("Is the server down? (connected=false)");let t=u.randomString(12),n={janus:"info",transaction:t};C&&(n.token=C);S&&(n.apisecret=S);if(a)return R[t]=function(t){u.log("Server info:"),u.debug(t),"server_info"!==t.janus&&u.error("Ooops: "+t.error.code+" "+t.error.reason),e.success(t)},void c.send(JSON.stringify(n));u.httpAPICall(h,{verb:"POST",withCredentials:y,body:n,success:function(t){u.log("Server info:"),u.debug(t),"server_info"!==t.janus&&u.error("Ooops: "+t.error.code+" "+t.error.reason),e.success(t)},error:function(t,n){u.error(t+":",n),""===n?e.error(t+": Is the server down?"):e.error(t+": "+n)}})}(e)},this.destroy=function(n){!function(n){n=n||{},n.success="function"==typeof n.success?n.success:u.noop,n.error="function"==typeof n.error?n.error:u.noop;let r=!0===n.unload,o=!0;void 0!==n.notifyDestroyed&&null!==n.notifyDestroyed&&(o=!0===n.notifyDestroyed);let i=!0===n.cleanupHandles;if(u.log("Destroying session "+k+" (unload="+r+")"),!k)return u.warn("No session to destroy"),n.success(),void(o&&e.destroyed());if(i)for(let e in x)V(e,{noRequest:!0});if(!E)return u.warn("Is the server down? (connected=false)"),k=null,void n.success();let s={janus:"destroy",transaction:u.randomString(12)};C&&(s.token=C);S&&(s.apisecret=S);if(r)return a?(c.onclose=null,c.close(),c=null):t.sendBeacon(h+"/"+k,JSON.stringify(s)),u.log("Destroyed session:"),k=null,E=!1,n.success(),void(o&&e.destroyed());if(a){s.session_id=k;let t=function(){for(let e in l)c.removeEventListener(e,l[e]);c.removeEventListener("message",r),c.removeEventListener("error",i),d&&clearTimeout(d),c.close()},r=function(r){let i=JSON.parse(r.data);i.session_id==s.session_id&&i.transaction==s.transaction&&(t(),n.success(),o&&e.destroyed())},i=function(){t(),n.error("Failed to destroy the server: Is the server down?"),o&&e.destroyed()};return c.addEventListener("message",r),c.addEventListener("error",i),void(1===c.readyState?c.send(JSON.stringify(s)):i())}u.httpAPICall(h+"/"+k,{verb:"POST",withCredentials:y,body:s,success:function(t){u.log("Destroyed session:"),u.debug(t),k=null,E=!1,"success"!==t.janus&&u.error("Ooops: "+t.error.code+" "+t.error.reason),n.success(),o&&e.destroyed()},error:function(t,r){u.error(t+":",r),k=null,E=!1,n.success(),o&&e.destroyed()}})}(n)},this.attach=function(e){!function(e){if(e=e||{},e.success="function"==typeof e.success?e.success:u.noop,e.error="function"==typeof e.error?e.error:u.noop,e.dataChannelOptions=e.dataChannelOptions||{ordered:!0},e.consentDialog="function"==typeof e.consentDialog?e.consentDialog:u.noop,e.iceState="function"==typeof e.iceState?e.iceState:u.noop,e.mediaState="function"==typeof e.mediaState?e.mediaState:u.noop,e.webrtcState="function"==typeof e.webrtcState?e.webrtcState:u.noop,e.slowLink="function"==typeof e.slowLink?e.slowLink:u.noop,e.onmessage="function"==typeof e.onmessage?e.onmessage:u.noop,e.onlocaltrack="function"==typeof e.onlocaltrack?e.onlocaltrack:u.noop,e.onremotetrack="function"==typeof e.onremotetrack?e.onremotetrack:u.noop,e.ondata="function"==typeof e.ondata?e.ondata:u.noop,e.ondataopen="function"==typeof e.ondataopen?e.ondataopen:u.noop,e.oncleanup="function"==typeof e.oncleanup?e.oncleanup:u.noop,e.ondetached="function"==typeof e.ondetached?e.ondetached:u.noop,!E)return u.warn("Is the server down? (connected=false)"),void e.error("Is the server down? (connected=false)");let t=e.plugin;if(!t)return u.error("Invalid plugin"),void e.error("Invalid plugin");let n=e.opaqueId,r=e.loopIndex,o=e.token?e.token:C,i=u.randomString(12),s={janus:"attach",plugin:t,opaque_id:n,loop_index:r,transaction:i};o&&(s.token=o);S&&(s.apisecret=S);if(a)return R[i]=function(n){if(u.debug(n),"success"!==n.janus)return u.error("Ooops: "+n.error.code+" "+n.error.reason),void e.error("Ooops: "+n.error.code+" "+n.error.reason);let r=n.data.id;u.log("Created handle: "+r);let i={session:D,plugin:t,id:r,token:o,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,mySdp:null,mediaConstraints:null,pc:null,dataChannelOptions:e.dataChannelOptions,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,bitrate:{}},getId:function(){return r},getPlugin:function(){return t},getVolume:function(e,t){return X(r,e,!0,t)},getRemoteVolume:function(e,t){return X(r,e,!0,t)},getLocalVolume:function(e,t){return X(r,e,!1,t)},isAudioMuted:function(e){return K(r,e,!1)},muteAudio:function(e){return Q(r,e,!1,!0)},unmuteAudio:function(e){return Q(r,e,!1,!1)},isVideoMuted:function(e){return K(r,e,!0)},muteVideo:function(e){return Q(r,e,!0,!0)},unmuteVideo:function(e){return Q(r,e,!0,!1)},getBitrate:function(e){return Y(r,e)},setMaxBitrate:function(e,t){return $(r,e,t)},send:function(e){M(r,e)},data:function(e){_(r,e)},dtmf:function(e){J(r,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){z(r,!0,e)},createAnswer:function(e){z(r,!1,e)},handleRemoteJsep:function(e){q(r,e)},replaceTracks:function(e){W(r,e)},getLocalTracks:function(){return B(r)},getRemoteTracks:function(){return H(r)},onlocaltrack:e.onlocaltrack,onremotetrack:e.onremotetrack,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){ee(r,!0===e)},detach:function(e){V(r,e)}};x[r]=i,e.success(i)},s.session_id=k,void c.send(JSON.stringify(s));u.httpAPICall(h+"/"+k,{verb:"POST",withCredentials:y,body:s,success:function(n){if(u.debug(n),"success"!==n.janus)return u.error("Ooops: "+n.error.code+" "+n.error.reason),void e.error("Ooops: "+n.error.code+" "+n.error.reason);let r=n.data.id;u.log("Created handle: "+r);let i={session:D,plugin:t,id:r,token:o,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,mySdp:null,mediaConstraints:null,pc:null,dataChannelOptions:e.dataChannelOptions,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,bitrate:{}},getId:function(){return r},getPlugin:function(){return t},getVolume:function(e,t){return X(r,e,!0,t)},getRemoteVolume:function(e,t){return X(r,e,!0,t)},getLocalVolume:function(e,t){return X(r,e,!1,t)},isAudioMuted:function(e){return K(r,e,!1)},muteAudio:function(e){return Q(r,e,!1,!0)},unmuteAudio:function(e){return Q(r,e,!1,!1)},isVideoMuted:function(e){return K(r,e,!0)},muteVideo:function(e){return Q(r,e,!0,!0)},unmuteVideo:function(e){return Q(r,e,!0,!1)},getBitrate:function(e){return Y(r,e)},setMaxBitrate:function(e,t){return $(r,e,t)},send:function(e){M(r,e)},data:function(e){_(r,e)},dtmf:function(e){J(r,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){z(r,!0,e)},createAnswer:function(e){z(r,!1,e)},handleRemoteJsep:function(e){q(r,e)},replaceTracks:function(e){W(r,e)},getLocalTracks:function(){return B(r)},getRemoteTracks:function(){return H(r)},onlocaltrack:e.onlocaltrack,onremotetrack:e.onremotetrack,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){ee(r,!0===e)},detach:function(e){V(r,e)}};x[r]=i,e.success(i)},error:function(t,n){u.error(t+":",n),""===n?e.error(t+": Is the server down?"):e.error(t+": "+n)}})}(e)}}return u.useDefaultDependencies=function(t){let n=t&&t.fetch||fetch,r=t&&t.Promise||Promise,o=t&&t.WebSocket||WebSocket;return{newWebSocket:function(e,t){return new o(e,t)},extension:t&&t.extension||c,isArray:function(e){return Array.isArray(e)},webRTCAdapter:t&&t.adapter||e,httpAPICall:function(e,t){let o={method:t.verb,headers:{Accept:"application/json, text/plain, */*"},cache:"no-cache"};"POST"===t.verb&&(o.headers["Content-Type"]="application/json"),void 0!==t.withCredentials&&(o.credentials=!0===t.withCredentials?"include":t.withCredentials?t.withCredentials:"omit"),t.body&&(o.body=JSON.stringify(t.body));let i=n(e,o).catch((function(e){return r.reject({message:"Probably a network error, is the server down?",error:e})}));if(t.timeout){let e=new r((function(e,n){let r=setTimeout((function(){return clearTimeout(r),n({message:"Request timed out",timeout:t.timeout})}),t.timeout)}));i=r.race([i,e])}return i.then((function(e){return e.ok?typeof t.success==typeof u.noop?e.json().then((function(e){try{t.success(e)}catch(e){u.error("Unhandled httpAPICall success callback error",e)}}),(function(t){return r.reject({message:"Failed to parse response body",error:t,response:e})})):void 0:r.reject({message:"API call failed",response:e})})).catch((function(e){typeof t.error==typeof u.noop&&t.error(e.message||"<< internal error >>",e)})),i}}},u.useOldDependencies=function(t){let n=t&&t.jQuery||jQuery,r=t&&t.WebSocket||WebSocket;return{newWebSocket:function(e,t){return new r(e,t)},isArray:function(e){return n.isArray(e)},extension:t&&t.extension||c,webRTCAdapter:t&&t.adapter||e,httpAPICall:function(e,t){let r=void 0!==t.body?{contentType:"application/json",data:JSON.stringify(t.body)}:{},o=void 0!==t.withCredentials?{xhrFields:{withCredentials:t.withCredentials}}:{};return n.ajax(n.extend(r,o,{url:e,type:t.verb,cache:!1,dataType:"json",async:t.async,timeout:t.timeout,success:function(e){typeof t.success==typeof u.noop&&t.success(e)},error:function(e,n,r){typeof t.error==typeof u.noop&&t.error(n,r)}}))}}},u.mediaToTracks=function(e){let t=[];if(e){if(!e.keepAudio&&!1!==e.audio&&(void 0===e.audio||e.audio||e.audioSend||e.audioRecv||e.addAudio||e.replaceAudio||e.removeAudio)){let n={type:"audio"};e.removeAudio?n.remove=!0:(e.addAudio?n.add=!0:e.replaceAudio&&(n.replace=!0),!1!==e.audioSend&&(n.capture=e.audio||!0),!1!==e.audioRecv&&(n.recv=!0)),(n.remove||n.capture||n.recv)&&t.push(n)}if(!e.keepVideo&&!1!==e.video&&(void 0===e.video||e.video||e.videoSend||e.videoRecv||e.addVideo||e.replaceVideo||e.removeVideo)){let n={type:"video"};e.removeVideo?n.remove=!0:(e.addVideo?n.add=!0:e.replaceVideo&&(n.replace=!0),!1!==e.videoSend&&(n.capture=e.video||!0,["screen","window","desktop"].includes(n.capture)&&(n.type="screen",n.capture={video:{}},e.screenshareFrameRate&&(n.capture.frameRate=e.screenshareFrameRate),e.screenshareHeight&&(n.capture.height=e.screenshareHeight),e.screenshareWidth&&(n.capture.width=e.screenshareWidth))),!1!==e.videoRecv&&(n.recv=!0)),(n.remove||n.capture||n.recv)&&t.push(n)}e.data&&t.push({type:"data"})}else t.push({type:"audio",capture:!0,recv:!0}),t.push({type:"video",capture:!0,recv:!0});return t},u.trackConstraints=function(e){let t={};if(!e||!e.capture)return t;if("audio"===e.type)t.audio=e.capture;else if("video"===e.type)if((e.simulcast||e.svc)&&!0===e.capture&&(e.capture="hires"),!0===e.capture||"object"==typeof e.capture)t.video=e.capture;else{let n=0,r=0;"lowres"===e.capture?(n=320,r=240):"lowres-16:9"===e.capture?(n=320,r=180):"hires"===e.capture||"hires-16:9"===e.capture||"hdres"===e.capture?(n=1280,r=720):"fhdres"===e.capture?(n=1920,r=1080):"4kres"===e.capture?(n=3840,r=2160):"stdres"===e.capture?(n=640,r=480):"stdres-16:9"===e.capture?(n=640,r=360):(u.log("Default video setting is stdres 4:3"),n=640,r=480),t.video={width:{ideal:n},height:{ideal:r}}}else"screen"===e.type&&(t.video=e.capture);return t},u.noop=function(){},u.dataChanDefaultLabel="JanusDataChannel",u.endOfCandidates=null,u.stopAllTracks=function(e){try{let t=e.getTracks();for(let e of t)u.log(e),e&&!0!==e.dontStop&&e.stop()}catch(e){}},u.init=function(e){if((e=e||{}).callback="function"==typeof e.callback?e.callback:u.noop,u.initDone)e.callback();else{if(void 0===console.log&&(console.log=function(){}),u.trace=u.noop,u.debug=u.noop,u.vdebug=u.noop,u.log=u.noop,u.warn=u.noop,u.error=u.noop,!0===e.debug||"all"===e.debug)u.trace=console.trace.bind(console),u.debug=console.debug.bind(console),u.vdebug=console.debug.bind(console),u.log=console.log.bind(console),u.warn=console.warn.bind(console),u.error=console.error.bind(console);else if(Array.isArray(e.debug))for(let t of e.debug)switch(t){case"trace":u.trace=console.trace.bind(console);break;case"debug":u.debug=console.debug.bind(console);break;case"vdebug":u.vdebug=console.debug.bind(console);break;case"log":u.log=console.log.bind(console);break;case"warn":u.warn=console.warn.bind(console);break;case"error":u.error=console.error.bind(console);break;default:console.error("Unknown debugging option '"+t+"' (supported: 'trace', 'debug', 'vdebug', 'log', warn', 'error')")}u.log("Initializing library");let n=e.dependencies||u.useDefaultDependencies();if(u.isArray=n.isArray,u.webRTCAdapter=n.webRTCAdapter,u.httpAPICall=n.httpAPICall,u.newWebSocket=n.newWebSocket,u.extension=n.extension,u.extension.init(),u.listDevices=function(e,n){e="function"==typeof e?e:u.noop,n||(n={audio:!0,video:!0}),u.isGetUserMediaAvailable()?t.mediaDevices.getUserMedia(n).then((function(n){t.mediaDevices.enumerateDevices().then((function(t){u.debug(t),e(t),u.stopAllTracks(n)}))})).catch((function(t){u.error(t),e([])})):(u.warn("navigator.mediaDevices unavailable"),e([]))},u.safariVp8=!1,"safari"===u.webRTCAdapter.browserDetails.browser&&u.webRTCAdapter.browserDetails.version>=605)if(s&&s.getCapabilities&&s.getCapabilities("video")&&s.getCapabilities("video").codecs&&s.getCapabilities("video").codecs.length){for(let e of s.getCapabilities("video").codecs)if(e&&e.mimeType&&"video/vp8"===e.mimeType.toLowerCase()){u.safariVp8=!0;break}u.safariVp8?u.log("This version of Safari supports VP8"):u.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu")}else{let e=new o({});e.createOffer({offerToReceiveVideo:!0}).then((function(t){u.safariVp8=-1!==t.sdp.indexOf("VP8"),u.safariVp8?u.log("This version of Safari supports VP8"):u.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu"),e.close(),e=null}))}u.initDone=!0,e.callback()}},u.isWebrtcSupported=function(){return!!o},u.isGetUserMediaAvailable=function(){return t.mediaDevices&&t.mediaDevices.getUserMedia},u.randomString=function(e){let t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n="";for(let r=0;r<e;r++){let e=Math.floor(62*Math.random());n+=t.charAt(e)}return n},ce=u}(),ve=se(ge);!function(e){e.VIDEO="video",e.AUDIO="audio"}(de||(de={})),function(e){e.VIDEO="videoinput",e.AUDIO="audioinput"}(pe||(pe={})),function(e){e.PARTICIPANT_JOINED="participant_joined",e.PARTICIPANT_LEFT="participant_left",e.LOCAL_STREAM="local_stream",e.REMOTE_STREAM="remote_stream",e.REMOTE_TRACKS_UPDATED="remote_tracks_updated",e.DATA_CHANNEL_OPEN="data_channel_open",e.DATA_CHANNEL_MESSAGE="data_channel_message",e.ERROR="error"}(fe||(fe={})),function(e){e.CREATED="created",e.ENDED="ended",e.MUTE="mute",e.UNMUTE="unmute"}(he||(he={})),function(e){e.JOIN="join",e.LEFT="left",e.SLOW_LINK="slow-link",e.REMOTE_TRACKS_UPDATED="remote-tracks",e.REMOTE_STREAM="remote-stream",e.REMOTE_CONNECTION_STATE="remote-connection-state",e.DATA_CHANNEL_OPENED="data-channel-opened",e.DATA_CHANNEL_MESSAGE="data-channel-message",e.SESSION_CONNECTION_STATE="session-connection-state",e.ERROR="error"}(me||(me={}));var ye,be,Ce,Se,Te,we,Ie=function(){function e(e){var t;if(this.videoRoomPlugin=null,this.isOnlyAudio=!1,this.currentRoomId=null,this.currentUserId=null,this.remoteFeeds={},this.remoteJseps={},this.remoteFeedsAttachingInProgress={},this.bitrateTimers={},this.emitter=new h,!q.env.isReactNative&&!j)throw"Error: in order to use this library please connect adapter.js. More info https://github.com/webrtc/adapter";if(this.token=e,this.server=N.conference.server,this.debug=null!==(t=N.conference.debug)&&void 0!==t?t:g.ALL,!this.server)throw"'server' parameter is mandatory";this.server.includes("http")&&(this.server+="/janus")}return e.prototype.createSession=function(e){var t=this,n=e.success,r=void 0===n?function(){}:n,o=e.error,i=void 0===o?function(){}:o,s=e.destroyed,a=void 0===s?function(){}:s,c=e.timeoutSessionCallback,u=void 0===c?function(){}:c;ve.init({debug:this.debug,callback:function(){ve.isWebrtcSupported()?t.engine=new ve({server:t.server,iceServers:N.videochat.iceServers,token:t.token,success:function(){return q.safeCallbackCall(r)()},error:function(e){return q.safeCallbackCall(i)(e)},destroyed:function(){return q.safeCallbackCall(a)()},timeoutSessionCallback:function(){return q.safeCallbackCall(u)()}}):q.safeCallbackCall(i)("Your browser does not support WebRTC, so you can't use this functionality.")}})},e.prototype.getSessionId=function(){var e,t;return null!==(t=null===(e=this.engine)||void 0===e?void 0:e.getSessionId())&&void 0!==t?t:null},e.prototype.destroySession=function(e){var t=e.success,n=void 0===t?function(){}:t,r=e.error,o=void 0===r?function(){}:r;this.engine.destroy({success:function(){return q.safeCallbackCall(n)()},error:function(e){return q.safeCallbackCall(o)(e)}})},e.prototype.attachVideoConferencingPlugin=function(e,t,n,r){var o=this,i=null,s=r.localStream;delete r.localStream;var a=r.displayName;delete r.displayName,this.engine.attach({plugin:"janus.plugin.videoroom",success:function(n){if(e){(i=n).userId=t,o.remoteFeedsAttachingInProgress[t]=i;var s={request:"join",room:o.currentRoomId,ptype:"listener",feed:t,display:a};null==i||i.send({message:s})}else o.videoRoomPlugin=n;q.safeCallbackCall(r.success)()},error:function(e){q.safeCallbackCall(r.error)(e)},consentDialog:function(e){q.safeCallbackCall(r.consentDialog)(e)},mediaState:function(e,t){q.safeCallbackCall(r.mediaState)(e,t)},webrtcState:function(e){q.safeCallbackCall(r.webrtcState)(e)},slowLink:function(e,t){q.safeCallbackCall(r.slowLink)(e,t)},iceState:function(e){q.safeCallbackCall(r.iceState)(e)},onmessage:function(t,i){var a=t.videoroom;if(e){if(a)if("attached"===a){var c=t.id;o.remoteFeeds[c]=o.remoteFeedsAttachingInProgress[c],o.remoteFeedsAttachingInProgress[c]=null}else t.error&&q.safeCallbackCall(r.error)(t.error);if(i){c=t.id;o.remoteJseps[c]=i,o.createAnswer({remoteFeed:o.remoteFeeds[c],jsep:i},s,{success:function(){},error:function(e){q.safeCallbackCall(r.error)(e)}})}}else{if(a)if("joined"===a){var u={media:n?{audio:!1,video:!1}:{audio:!0,video:!0},stream:n?void 0:s};o.createOffer(u,{success:function(){if(t.publishers){var e=t.publishers;for(var n in e){var r=e[n].id,i=e[n].display;o.emitter.emit(fe.PARTICIPANT_JOINED,r,i,!0)}}},error:function(e){q.safeCallbackCall(r.error)(e)}})}else if("event"===a)if(t.publishers){var l=t.publishers;for(var d in l){var p=l[d].id,f=l[d].display;o.emitter.emit(fe.PARTICIPANT_JOINED,p,f,!1)}}else if(t.leaving){c=t.leaving;o.detachRemoteFeed(c)&&o.emitter.emit(fe.PARTICIPANT_LEFT,c,null)}else if(t.unpublished){if("ok"!=(c=t.unpublished))o.detachRemoteFeed(c)&&o.emitter.emit(fe.PARTICIPANT_LEFT,c,null)}else t.error&&(q.DLog("[janus error message]",t.error),o.emitter.emit(fe.ERROR,t),q.safeCallbackCall(r.error)(t.error));i&&o.videoRoomPlugin.handleRemoteJsep({jsep:i})}},onlocaltrack:function(e,t){q.DLog("[onlocaltrack]",e,t),o.onLocalTrack(e,t)},onremotetrack:function(e,t,n,r){q.DLog("[onremotetrack]",e,t,n,r),o.onRemoteTrack(i,e,t,n,r)},ondataopen:function(e){q.DLog("[ondataopen]",e),o.emitter.emit(fe.DATA_CHANNEL_OPEN,e)},ondata:function(e,t){q.DLog("[ondata]",t,e),o.emitter.emit(fe.DATA_CHANNEL_MESSAGE,t,e)},oncleanup:function(){q.safeCallbackCall(r.oncleanup)()},detached:function(){}})},e.prototype.onLocalTrack=function(e,t){},e.prototype.onRemoteTrack=function(e,t,n,r,o){var i,s=o&&o.reason;if(s===he.CREATED){var a=!e.stream||!e.tracks;a?(e.tracks=((i={})[n]=t,i),e.stream=new k([t])):(e.tracks[n]=t,e.stream.addTrack(t)),a&&this.emitter.emit(fe.REMOTE_STREAM,e.userId,e.stream)}else if(s===he.ENDED){delete e.tracks[n];var c=e.stream.getTracks().find((function(e){return e.kind===t.kind}));e.stream.removeTrack(c)}this.emitter.emit(fe.REMOTE_TRACKS_UPDATED,e.userId,t,s)},e.prototype.getPluginId=function(){var e,t;return null!==(t=null===(e=this.videoRoomPlugin)||void 0===e?void 0:e.getId())&&void 0!==t?t:null},e.prototype.detachVideoConferencingPlugin=function(e){var t=this,n=function(){t.videoRoomPlugin=null,Object.keys(t.remoteFeeds).forEach((function(e){t.detachRemoteFeed(Number(e))})),t.remoteFeeds={},t.remoteJseps={}};this.videoRoomPlugin.detach({success:function(){n(),q.safeCallbackCall(e.success)()},error:function(t){n(),q.safeCallbackCall(e.error)(t)}})},e.prototype.join=function(e,t,n,r){var o=this,i=r.displayName;delete r.displayName,this.isOnlyAudio=n,q.DLog("isOnlyAudio: "+this.isOnlyAudio);var s={request:"join",room:e,ptype:"publisher",id:t,display:i};this.videoRoomPlugin.send({message:s,success:function(n){o.currentRoomId=e,o.currentUserId=t,q.safeCallbackCall(r.success)()},error:function(e){q.safeCallbackCall(r.error)(e)}})},e.prototype.leave=function(e){if(q.DLog("leave"),this.engine.isConnected()){var t={request:"leave",room:this.currentRoomId,id:this.currentUserId};this.videoRoomPlugin&&this.videoRoomPlugin.send({message:t}),this.currentRoomId=null,this.currentUserId=null,q.safeCallbackCall(e.success)()}else q.safeCallbackCall(e.success)()},e.prototype.listOnlineParticipants=function(e,t){var n={request:"listparticipants",room:e};this.videoRoomPlugin.send({message:n,success:function(e){var n=e?e.participants:[];q.safeCallbackCall(t.success)(n)},error:function(e){q.safeCallbackCall(t.error)(e)}})},e.prototype.toggleAudioMute=function(){return this.videoRoomPlugin.isAudioMuted()?this.videoRoomPlugin.unmuteAudio():this.videoRoomPlugin.muteAudio(),this.videoRoomPlugin.isAudioMuted()},e.prototype.isAudioMuted=function(){return this.videoRoomPlugin.isAudioMuted()},e.prototype.toggleRemoteAudioMute=function(e){var t=this.remoteFeeds[e];if(!t)return!1;var n=t.stream.getAudioTracks();if(n&&n.length>0){for(var r=0;r<n.length;++r)n[r].enabled=!n[r].enabled;return!n[0].enabled}return!1},e.prototype.isRemoteAudioMuted=function(e){var t=this.remoteFeeds[e];if(!t)return!1;var n=t.stream.getAudioTracks();return!!(n&&n.length>0)&&!n[0].enabled},e.prototype.toggleVideoMute=function(){return this.videoRoomPlugin.isVideoMuted()?this.videoRoomPlugin.unmuteVideo():this.videoRoomPlugin.muteVideo(),this.videoRoomPlugin.isVideoMuted()},e.prototype.isVideoMuted=function(){return this.videoRoomPlugin.isVideoMuted()},e.prototype.toggleRemoteVideoMute=function(e){var t=this.remoteFeeds[e];if(!t)return!1;var n=t.stream.getVideoTracks();if(n&&n.length>0){for(var r=0;r<n.length;++r)n[r].enabled=!n[r].enabled;return!n[0].enabled}return!1},e.prototype.isRemoteVideoMuted=function(e){var t=this.remoteFeeds[e];if(!t)return!1;var n=t.stream.getVideoTracks();return!!(n&&n.length>0)&&!n[0].enabled},e.prototype.sendKeyframeRequest=function(e,t){var n={request:"configure",room:e,keyframe:!0};this.videoRoomPlugin.send({message:n,success:function(e){q.safeCallbackCall(t.success)(e)},error:function(e){q.safeCallbackCall(t.error)(e)}})},e.prototype.getTracksFromStream=function(e){var t=[],n=e.getAudioTracks();if(n.length){var r=n[0];t.push({type:"audio",capture:r,recv:!1})}var o=e.getVideoTracks();if(o.length){var i=o[0];t.push({type:"video",capture:i,recv:!1})}return t},e.prototype.createOffer=function(e,t){var n=this;q.DLog("[JanusWrapper][createOffer]",e);var r=e.stream,o=e.media,i=e.replace,s={tracks:[{type:"data"}]};if(r){var a=this.getTracksFromStream(r);s.tracks=s.tracks.concat(a)}else if(o){var c=[];o.audio&&c.push({type:"audio",capture:o.audio,recv:!1,replace:!!i}),o.video&&c.push({type:"video",capture:o.video,recv:!1,replace:!!i}),s.tracks=s.tracks.concat(c)}else s.tracks=s.tracks.concat([{type:"audio",capture:!0,recv:!1,replace:!!i},{type:"video",capture:!0,recv:!1,replace:!!i}]);q.DLog("[JanusWrapper][createOffer][params]",s),s.customizeSdp=function(e){},s.success=function(e){var r={request:"configure",audio:!!o.audio,video:!!o.video};q.DLog("[JanusWrapper][createOffer][success]",r),n.videoRoomPlugin.send({message:r,jsep:e}),q.safeCallbackCall(t.success)()},s.error=function(e){q.DLog("[JanusWrapper][createOffer][error]",e),o.audio?n.createOffer({media:{video:!1,audio:!1}},t):q.safeCallbackCall(t.error)(e)},this.videoRoomPlugin.createOffer(s)},e.prototype.getTracksMidsFromStream=function(e){var t=[],n=e.getAudioTracks();if(n.length){var r=n[0];t.push({type:"audio",mid:r.id,recv:!0})}var o=e.getVideoTracks();if(o.length){var i=o[0];t.push({type:"video",mid:i.id,recv:!0})}return t},e.prototype.createAnswer=function(e,t,n){var r=this,o=e.remoteFeed,i=e.jsep;q.DLog("[JanusWrapper][createAnswer]",i,t);var s=[{type:"data"}];if(t){var a=this.getTracksMidsFromStream(t);s=s.concat(a)}q.DLog("[JanusWrapper][createAnswer][tracks]",s),o.createAnswer({jsep:i,tracks:s,success:function(e){var t={request:"start",room:r.currentRoomId};q.DLog("[JanusWrapper][createAnswer][success]",t),o.send({message:t,jsep:e}),q.safeCallbackCall(n.success)()},error:function(e){q.DLog("[JanusWrapper][createAnswer][error]",e),q.safeCallbackCall(n.error)(e)}})},e.prototype.detachRemoteFeed=function(e){var t=this.remoteFeeds[e];return!!t&&(t.detach(),this.remoteFeeds[e]=null,this.remoteJseps[e]=null,!0)},e.prototype.getUserBitrate=function(e){return this.remoteFeeds[e].getBitrate()},e.prototype.getVolume=function(e){return this.videoRoomPlugin.getLocalVolume(null,e)},e.prototype.getUserVolume=function(e,t){return this.remoteFeeds[e].getRemoteVolume(null,t)},e.prototype.showBitrate=function(e,t){var n=this.remoteFeeds[e];q.env.isReactNative||"chrome"!==j.browserDetails.browser&&"firefox"!==j.browserDetails.browser||(this.bitrateTimers[e]=setInterval((function(){var e=n.getBitrate();t.text(e)}),1e3))},e.prototype.hideBitrate=function(e,t){this.bitrateTimers[e]&&clearInterval(this.bitrateTimers[e]),this.bitrateTimers[e]=null,t.text=null},e.prototype.on=function(e,t){return this.emitter.addListener(e,t)},e.prototype.removeAllListeners=function(e){return this.emitter.removeAllListeners(e)},e}(),Ee=function(){function e(e){var t=this;this.id="".concat(Math.random()),this.mediaParams={},this.onParticipantJoined=function(e,n,r){q.DLog("[onParticipantJoined]",e,n,r),t.createHandler(e,!0,!1),q.safeCallbackCall(t.onParticipantJoinedListener)(t,e,n,r)},this.onParticipantLeft=function(e,n){q.DLog("[onParticipantLeft]",e,n),q.safeCallbackCall(t.onParticipantLeftListener)(t,e,n)},this.onError=function(e){q.DLog("[onError]",JSON.stringify(e)),q.safeCallbackCall(t.onErrorListener)(t,e)},this.onDataChannelOpen=function(e){q.DLog("[onDataChannelOpen]",e),q.safeCallbackCall(t.onDataChannelOpenedListener)(t,e)},this.onDataChannelMessage=function(e,n){q.DLog("[onDataChannelMessage]",e,n),q.safeCallbackCall(t.onDataChannelMessageListener)(t,e,n)},this.onLocalIceStateChanged=function(e){q.DLog("[onLocalIceStateChanged]",e),q.safeCallbackCall(t.onSessionConnectionStateChangedListener)(t,e)},this.onRemoteIceStateChanged=function(e,n){q.DLog("[onRemoteIceStateChanged]",e,n),q.safeCallbackCall(t.onRemoteConnectionStateChangedListener)(t,e,n)},this.onRemoteStream=function(e,n){q.DLog("[onRemoteStream]",e,n),q.safeCallbackCall(t.onRemoteStreamListener)(t,e,n)},this.onRemoteTracksUpdated=function(e,n,r){q.DLog("[onRemoteTracksUpdated]",e,n,r),q.safeCallbackCall(t.onRemoteTracksUpdatedListener)(t,e,n,r)},this.onSlowLink=function(e,n,r){q.DLog("[onSlowLink]",e,n,r),q.safeCallbackCall(t.onSlowLinkListener)(t,e,n,r)},this.client=new Ie(e),this.client.on(fe.PARTICIPANT_JOINED,this.onParticipantJoined),this.client.on(fe.PARTICIPANT_LEFT,this.onParticipantLeft),this.client.on(fe.REMOTE_STREAM,this.onRemoteStream),this.client.on(fe.REMOTE_TRACKS_UPDATED,this.onRemoteTracksUpdated),this.client.on(fe.DATA_CHANNEL_OPEN,this.onDataChannelOpen),this.client.on(fe.DATA_CHANNEL_MESSAGE,this.onDataChannelMessage),this.client.on(fe.ERROR,this.onError)}return Object.defineProperty(e.prototype,"currentRoomId",{get:function(){return this.client.currentRoomId},set:function(e){this.client.currentRoomId=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currentPublisherPC",{get:function(){return this.client.videoRoomPlugin.webrtcStuff.pc},enumerable:!1,configurable:!0}),e.prototype.createSession=function(){return _(this,void 0,void 0,(function(){var e,t=this;return J(this,(function(n){return e=!1,[2,new Promise((function(n,r){t.client.createSession({success:function(){e=!0,n(void 0)},error:function(n){e?t.onError(n):r(n)}})}))]}))}))},e.prototype.join=function(e,t,n){return _(this,void 0,void 0,(function(){return J(this,(function(r){switch(r.label){case 0:return this.currentUserDisplayName=n,this.currentRoomId=e,[4,this.createSession()];case 1:return r.sent(),[4,this.createHandler(t,!1,!1)];case 2:return r.sent(),[4,this.joinInternal(this.currentRoomId,t)];case 3:return r.sent(),[2]}}))}))},e.prototype.joinAsListener=function(e,t,n){return _(this,void 0,void 0,(function(){return J(this,(function(r){switch(r.label){case 0:return this.currentUserDisplayName=n,this.currentRoomId=e,[4,this.createSession()];case 1:return r.sent(),[4,this.createHandler(t,!1,!0)];case 2:return r.sent(),[4,this.joinInternal(this.currentRoomId,t)];case 3:return r.sent(),[2]}}))}))},e.prototype.sendKeyframeRequest=function(e){return _(this,void 0,void 0,(function(){var t=this;return J(this,(function(n){return[2,new Promise((function(n,r){t.client.sendKeyframeRequest(e,{success:n,error:r})}))]}))}))},e.prototype.createHandler=function(e,t){return _(this,arguments,void 0,(function(e,t,n){var r=this;return void 0===n&&(n=!1),J(this,(function(o){return[2,new Promise((function(o,i){r.client.attachVideoConferencingPlugin(t,e,n,{success:o,error:i,iceState:t?function(t){return r.onRemoteIceStateChanged(e,t)}:function(e){return r.onLocalIceStateChanged(e)},slowLink:t?function(t,n){return r.onSlowLink(e,t,n)}:function(e,t){return r.onSlowLink(null,e,t)},localStream:r.localStream,displayName:r.currentUserDisplayName})}))]}))}))},e.prototype.joinInternal=function(e,t){return _(this,void 0,void 0,(function(){var n=this;return J(this,(function(r){return[2,new Promise((function(r,o){n.client.join(e,t,!1,{success:r,error:o,displayName:n.currentUserDisplayName})}))]}))}))},e.prototype.listOfOnlineParticipants=function(){return _(this,void 0,void 0,(function(){var e=this;return J(this,(function(t){return[2,new Promise((function(t,n){e.currentRoomId?e.client.listOnlineParticipants(e.currentRoomId,{success:t,error:n}):n("Room ID is not set")}))]}))}))},e.prototype.leave=function(){return _(this,void 0,void 0,(function(){return J(this,(function(e){switch(e.label){case 0:return this.currentRoomId=null,this.currentUserDisplayName=void 0,[4,this.leaveGroup()];case 1:return e.sent(),[4,this.detachVideoConferencingPlugin()];case 2:return e.sent(),[4,this.destroy()];case 3:return e.sent(),this.localStream&&(this.localStream.getTracks().forEach((function(e){return e.stop()})),this.localStream=void 0,this.mediaParams={}),[2]}}))}))},e.prototype.leaveGroup=function(){return _(this,void 0,void 0,(function(){var e=this;return J(this,(function(t){return[2,new Promise((function(t,n){e.client.leave({success:t,error:n})}))]}))}))},e.prototype.destroy=function(){return _(this,void 0,void 0,(function(){var e=this;return J(this,(function(t){return[2,new Promise((function(t,n){e.client.destroySession({success:t,error:n})}))]}))}))},e.prototype.detachVideoConferencingPlugin=function(){return _(this,void 0,void 0,(function(){var e=this;return J(this,(function(t){return[2,new Promise((function(t,n){e.client.detachVideoConferencingPlugin({success:t,error:n})}))]}))}))},e.prototype.getDisplayMedia=function(e){return _(this,void 0,void 0,(function(){var t,n,r,o;return J(this,(function(i){switch(i.label){case 0:if(!E.getDisplayMedia)throw new Error("Your environment does not support 'getDisplayMedia' API");t=e&&e.elementId,n=e&&e.options,r=U({},e),this.mediaParams=r,delete r.elementId,delete r.options,i.label=1;case 1:return i.trys.push([1,3,,4]),[4,E.getDisplayMedia(r)];case 2:return o=i.sent(),[2,this.upsertStream(o,t,n)];case 3:throw i.sent();case 4:return[2]}}))}))},e.prototype.getUserMedia=function(e){return _(this,void 0,void 0,(function(){var t,n,r,o;return J(this,(function(i){switch(i.label){case 0:t=e&&e.elementId,n=e&&e.options,r=U({},e),this.mediaParams=r,delete r.elementId,delete r.options,i.label=1;case 1:return i.trys.push([1,3,,4]),[4,E.getUserMedia(r)];case 2:return o=i.sent(),[2,this.upsertStream(o,t,n)];case 3:throw i.sent();case 4:return[2]}}))}))},e.prototype.upsertStream=function(e,t,n){void 0===t&&(t=null),void 0===n&&(n={});var r=!!this.localStream;if(r?this.replaceTracks(e):this.localStream=e,!this.localStream)throw new Error("Local stream is not defined");return t&&(r&&this.detachMediaStream(t,n),this.attachMediaStream(t,this.localStream,n)),this.localStream},e.prototype.replaceTracks=function(e){var t,n=this;if(null===(t=this.localStream)||void 0===t||t.getTracks().forEach((function(t){var r;t.kind===de.AUDIO&&0===e.getAudioTracks().length||(t.stop(),null===(r=n.localStream)||void 0===r||r.removeTrack(t))})),e.getTracks().forEach((function(e){var t,r,o,i,s,a=n.currentPublisherPC.getSenders().find((function(t){var n=t.track;return e.kind===n.kind}));e.kind===de.AUDIO?e.enabled=null===(r=null===(t=n.localStream)||void 0===t?void 0:t.getAudioTracks().every((function(e){return e.enabled})))||void 0===r||r:e.enabled=null===(i=null===(o=n.localStream)||void 0===o?void 0:o.getVideoTracks().every((function(e){return e.enabled})))||void 0===i||i,a?(a.replaceTrack(e),null===(s=n.localStream)||void 0===s||s.addTrack(e)):console.warn("No sender found for track kind: ".concat(e.kind))})),!this.localStream)throw new Error("Local stream is not defined");return this.localStream},e.prototype.switchMediaTracks=function(e){return _(this,void 0,void 0,(function(){var t,n,r,o,i,s,a=this;return J(this,(function(c){switch(c.label){case 0:[de.AUDIO,de.VIDEO].forEach((function(t){var n,r=t===de.AUDIO?e.audio:t===de.VIDEO?e.video:{},o="string"==typeof r?r:null!==(n=null==r?void 0:r.deviceId)&&void 0!==n?n:null;o&&("object"==typeof a.mediaParams[t]?a.mediaParams[t].deviceId=o:a.mediaParams[t]={deviceId:o})})),c.label=1;case 1:return c.trys.push([1,3,,4]),t={audio:null!==(o=null===(r=this.mediaParams)||void 0===r?void 0:r.audio)&&void 0!==o&&o,video:null!==(s=null===(i=this.mediaParams)||void 0===i?void 0:i.video)&&void 0!==s&&s},[4,E.getDisplayMedia(t)];case 2:return n=c.sent(),[2,this.replaceTracks(n)];case 3:throw c.sent();case 4:return[2]}}))}))},e.prototype.muteVideo=function(){this.isVideoMuted()||this.client.toggleVideoMute()},e.prototype.unmuteVideo=function(){this.isVideoMuted()&&this.client.toggleVideoMute()},e.prototype.muteAudio=function(){this.isAudioMuted()||this.client.toggleAudioMute()},e.prototype.unmuteAudio=function(){this.isAudioMuted()&&this.client.toggleAudioMute()},e.prototype.isVideoMuted=function(){return this.client.isVideoMuted()},e.prototype.isAudioMuted=function(){return this.client.isAudioMuted()},e.prototype.getUserVolume=function(){return _(this,void 0,void 0,(function(){var e=this;return J(this,(function(t){return[2,new Promise((function(t,n){return e.client.getVolume(t)}))]}))}))},e.prototype.getRemoteUserBitrate=function(e){return this.client.getUserBitrate(e)},e.prototype.getRemoteUserVolume=function(e){return _(this,void 0,void 0,(function(){var t=this;return J(this,(function(n){return[2,new Promise((function(n,r){return t.client.getUserVolume(e,n)}))]}))}))},e.prototype.attachMediaStream=function(e,t,n){var r=document.getElementById(e);if(!("srcObject"in r))throw new Error("Unable to attach media stream, element #".concat(e," is undefined"));r.srcObject=t,r.style.transform=(null==n?void 0:n.mirror)?"scaleX(-1)":"none","boolean"==typeof(null==n?void 0:n.muted)&&(r.muted=null==n?void 0:n.muted),r.onloadedmetadata=function(e){r.play()}},e.prototype.detachMediaStream=function(e,t){var n=document.getElementById(e);if(!("srcObject"in n))throw new Error("Unable to attach media stream, element #".concat(e," is undefined"));n.pause(),n.srcObject=null,n.style.transform=(null==t?void 0:t.mirror)?"scaleX(-1)":"none","boolean"==typeof(null==t?void 0:t.muted)&&(n.muted=null==t?void 0:t.muted)},e.prototype.sendData=function(e,t){return _(this,void 0,void 0,(function(){var n=this;return J(this,(function(r){return[2,new Promise((function(r,o){n.client.videoRoomPlugin.data({data:e,label:t,success:r,error:o})}))]}))}))},e}(),ke=function(){function e(e){this.DeviceInputType=pe,this.CallType=de,this.sessionsStore={},this.proxy=e}return e.prototype.createNewSession=function(){var e=new Ee(this.getCurrentSessionToken());return this.sessionsStore[e.id]=e,e.onParticipantJoinedListener=this.onParticipantJoinedListener,e.onParticipantLeftListener=this.onParticipantLeftListener,e.onSlowLinkListener=this.onSlowLinkListener,e.onRemoteStreamListener=this.onRemoteStreamListener,e.onRemoteTracksUpdatedListener=this.onRemoteTracksUpdatedListener,e.onRemoteConnectionStateChangedListener=this.onRemoteConnectionStateChangedListener,e.onDataChannelOpenedListener=this.onDataChannelOpenedListener,e.onDataChannelMessageListener=this.onDataChannelMessageListener,e.onSessionConnectionStateChangedListener=this.onSessionConnectionStateChangedListener,e.onErrorListener=this.onErrorListener,e},e.prototype.getMediaDevices=function(e){return _(this,void 0,void 0,(function(){var t;return J(this,(function(n){switch(n.label){case 0:return(null==E?void 0:E.enumerateDevices)?[4,E.enumerateDevices()]:[3,2];case 1:return t=n.sent(),[2,e?t.filter((function(t){return t.kind===e})):t];case 2:throw new Error("No 'enumerateDevices' API supported")}}))}))},e.prototype.clearSession=function(e){delete this.sessionsStore[e]},e.prototype.getCurrentSessionToken=function(){var e=this.proxy.getSession();if(null==e?void 0:e.token)return e.token;throw new Error("Session does not exist")},e.prototype.getListenerByName=function(e){switch(e){case me.JOIN:return"onParticipantJoinedListener";case me.LEFT:return"onParticipantLeftListener";case me.SLOW_LINK:return"onSlowLinkListener";case me.REMOTE_STREAM:return"onRemoteStreamListener";case me.REMOTE_TRACKS_UPDATED:return"onRemoteTracksUpdatedListener";case me.REMOTE_CONNECTION_STATE:return"onRemoteConnectionStateChangedListener";case me.DATA_CHANNEL_OPENED:return"onDataChannelOpenedListener";case me.DATA_CHANNEL_MESSAGE:return"onDataChannelMessageListener";case me.SESSION_CONNECTION_STATE:return"onSessionConnectionStateChangedListener";case me.ERROR:return"onErrorListener";default:return null}},e.prototype.addListener=function(e,t){var n=this.getListenerByName(e);return n&&(this[n]=t),this.removeListener.bind(this,e)},e.prototype.removeListener=function(e){var t=this.getListenerByName(e);t&&(this[t]=void 0)},e.prototype.removeAllListeners=function(){var e=this;Object.keys(this).forEach((function(t){t.startsWith("on")&&t.endsWith("Listener")&&"function"==typeof e[t]&&(e[t]=void 0)}))},e}(),xe=function(){function e(e){this.route=N.urls.data,this.proxy=e}return e.prototype.create=function(e){return _(this,arguments,void 0,(function(e,t){var n,r,o;return void 0===t&&(t={}),J(this,(function(i){return n=q.isArray(t),r=n?"multi":void 0,o={type:F.POST,url:q.getUrl(this.route,e,r),data:n?{record:this.createRecord(t)}:t},[2,this.proxy.ajax(o)]}))}))},e.prototype.list=function(e){return _(this,arguments,void 0,(function(e,t){var n,r;return void 0===t&&(t={}),J(this,(function(o){return n="string"==typeof t?t:q.isArray(t)?t.toString():void 0,r={url:q.getUrl(this.route,e,n),data:n?void 0:t},[2,this.proxy.ajax(r)]}))}))},e.prototype.readPermissions=function(e,t){return _(this,void 0,void 0,(function(){var n;return J(this,(function(r){return n={url:q.getUrl(this.route,e,t),data:{permissions:1}},[2,this.proxy.ajax(n)]}))}))},e.prototype.update=function(e){return _(this,arguments,void 0,(function(e,t){var n,r,o,i;return void 0===t&&(t={}),J(this,(function(s){return n=q.isArray(t),r=!n&&t.search_criteria,o=n?"multi":r?"by_criteria":t.id||t._id,i={type:F.PUT,url:q.getUrl(this.route,e,o),data:n?{record:this.createRecord(t)}:t},[2,this.proxy.ajax(i)]}))}))},e.prototype.delete=function(e,t){return _(this,void 0,void 0,(function(){var n,r,o,i;return J(this,(function(s){return n=q.isObject(t),r="string"==typeof t||q.isArray(t)&&1===t.length,o=n?"by_criteria":t.toString(),i={type:F.DELETE,url:q.getUrl(this.route,e,o),data:n?t:void 0,dataType:r?z.TEXT:void 0},[2,this.proxy.ajax(i)]}))}))},e.prototype.createRecord=function(e){return void 0===e&&(e=[]),e.reduce((function(e,t,n){var r,o=n+1,i=t.id||t._id,s=i?U(U({},t),{id:i}):t;return U(U({},e),((r={})[o]=s,r))}),{})},e}(),De=function(){function e(e){this.route=N.urls.meetings,this.proxy=e}return e.prototype.get=function(){return _(this,arguments,void 0,(function(e){var t;return void 0===e&&(e={}),J(this,(function(n){return t={type:F.GET,url:q.getUrl(this.route),data:e},[2,this.proxy.ajax(t)]}))}))},e.prototype.create=function(){return _(this,arguments,void 0,(function(e){var t,n,r,o,i;return void 0===e&&(e={}),J(this,(function(s){return t=Math.ceil(Date.now()/1e3),n=t+3600,r=new Date(t).toLocaleString("en",{year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric"}),o={name:r,start_date:t,end_date:n,attendees:[],record:!1,chat:!1},i={type:F.POST,url:q.getUrl(this.route),data:U(U({},o),e)},[2,this.proxy.ajax(i)]}))}))},e.prototype.update=function(e,t){return _(this,void 0,void 0,(function(){var n;return J(this,(function(r){return n={type:F.PUT,url:q.getUrl(this.route,e),data:t},[2,this.proxy.ajax(n)]}))}))},e.prototype.delete=function(e){return _(this,void 0,void 0,(function(){var t;return J(this,(function(n){return t={type:F.DELETE,url:q.getUrl(this.route,e),dataType:z.TEXT},[2,this.proxy.ajax(t)]}))}))},e.prototype.getRecordings=function(e){return _(this,void 0,void 0,(function(){var t;return J(this,(function(n){return t={type:F.GET,url:q.getUrl(this.route,"recordings",e)},[2,this.proxy.ajax(t)]}))}))},e}(),Ae=function(){function e(){this.sdkInstance={config:N,session:null},this.requestsNumber=0,this.fetchImpl=T,this.abortControllersMap={},this.requestMethod=F,this.responseType=z}return e.prototype.setSession=function(e){this.sdkInstance.session=e,e&&e.user_id&&this.setCurrentUserId(e.user_id)},e.prototype.getSession=function(){return this.sdkInstance.session},e.prototype.setCurrentUserId=function(e){this.currentUserId=e||void 0},e.prototype.getCurrentUserId=function(){return this.currentUserId},e.prototype.logRequest=function(e,t){q.DLog("[Request][".concat(t,"]"),"".concat(e.type||"GET"," ").concat(e.url),e)},e.prototype.logResponse=function(e,t){q.DLog("[Response][".concat(t,"]"),e)},e.prototype.buildRequestAndURL=function(e){var t,n=!e.type||"GET"===e.type||"HEAD"===e.type,r=!!e.type&&("POST"===e.type||"PUT"===e.type),o=this.sdkInstance&&this.sdkInstance.session&&this.sdkInstance.session.token,i=-1===e.url.indexOf("s3.amazonaws.com"),s=!1===e.contentType,a=e.authKey,c=e.url,u={};return u.method=e.type||"GET",e.data&&(t=this.buildRequestBody(e,s,r),n?c+="?".concat(t):u.body=t),s||(u.headers={"Content-Type":r?"application/json;charset=utf-8":"application/x-www-form-urlencoded; charset=UTF-8"}),i&&(u.headers||(u.headers={}),u.headers["CB-SDK"]="JS ".concat(N.version," - Client"),o?u.headers["CB-Token"]=o:a&&(u.headers["CB-AuthKey"]=a)),N.timeout&&(u.timeout=N.timeout),[u,c]},e.prototype.buildRequestBody=function(e,t,n){var r,o=e.data,i=e.useArrayQuery;return t?(r=new w,Object.keys(o).forEach((function(t){e.fileToCustomObject&&"file"===t?r.append(t,o[t].data,o[t].name):r.append(t,e.data[t])}))):r=n?JSON.stringify(o):this.serializeQueryParams(o,"",i,0),r},e.prototype.serializeQueryParams=function(e,t,n,r){void 0===r&&(r=0);var o=[];for(var i in e){var s=this.encodeURIComponent(i);q.isArray(e)&&(s="");var a=t?t+"[".concat(s,"]"):s,c=e[i],u=q.isArray(c);u&&(n||0===r)||q.isObject(c)?o.push(this.serializeQueryParams(c,a,n,++r)):(c=u?c.sort().join(","):c,o.push("".concat(a,"=").concat(this.encodeURIComponent(c))))}return o.sort().join("&")},e.prototype.encodeURIComponent=function(e){return encodeURIComponent(e).replace(/[#$&+,/:;=?@\[\]]/g,(function(e){return"%".concat(e.charCodeAt(0).toString(16))}))},e.prototype.abortRequest=function(e){this.abortControllersMap[e]&&(this.abortControllersMap[e].controllers||[]).forEach((function(e){e.abort()}))},e.prototype.processSuccessfulOrFailedRequest=function(e){if(e&&this.abortControllersMap[e]){var t=this.abortControllersMap[e].controllers||[];this.abortControllersMap[e].doneRequestsCount?this.abortControllersMap[e].doneRequestsCount+=1:this.abortControllersMap[e].doneRequestsCount=1,this.abortControllersMap[e].doneRequestsCount===t.length&&delete this.abortControllersMap[e]}},e.prototype.ajax=function(e){return _(this,void 0,void 0,(function(){var t,n=this;return J(this,(function(r){return t=++this.requestsNumber,[2,new Promise((function(r,o){n.logRequest(e,t);var i,s=n.buildRequestAndURL(e),a=s[0],c=s[1],u=e.abort_id;if(u){var l=0;if(n.abortControllersMap[u]){var d=n.abortControllersMap[u].controllers||[];n.abortControllersMap[u].controllers.push(new AbortController),l=d.length-1}else n.abortControllersMap[u]={controllers:[new AbortController]};var p=n.abortControllersMap[u].controllers[l].signal;Object.assign(a,{signal:p})}T(c,a).then((function(t){return i=t,(e.dataType||z.JSON)===z.TEXT?i.text():i.json()})).then((function(s){n.processSuccessfulOrFailedRequest(u),i.ok?n.processAjaxResponse(s,r,t):n.processAjaxError(i,s,null,o,r,e,t)})).catch((function(s){n.processSuccessfulOrFailedRequest(u),n.processAjaxError(i," ",s,o,r,e,t)}))}))]}))}))},e.prototype.processAjaxResponse=function(e,t,n){var r=e&&" "!==e?e:"empty body";this.logResponse(r,n),t(e)},e.prototype.processAjaxError=function(e,t,n,r,o,i,s){if(e||!n||n.code){var a=null==e?void 0:e.status,c={code:e&&a||n&&n.code,info:(t&&"string"==typeof t&&" "!==t?JSON.parse(t):t)||n&&n.errno},u=t||n||t.errors;this.logResponse(u,s),-1===(null==e?void 0:e.url.indexOf(N.urls.session))&&this.isExpiredSessionError(c)&&"function"==typeof N.on.sessionExpired?this.handleExpiredSessionResponse(c,null,r,o,i):r(c)}else r(n)},e.prototype.handleExpiredSessionResponse=function(e,t,n,r,o){var i=this;"function"==typeof N.on.sessionExpired&&N.on.sessionExpired((function(){e?n(e):r(t)}),(function(e){e&&(i.setSession(e),i.ajax(o).then(r).catch(n))}))},e.prototype.isExpiredSessionError=function(e){var t,n,r;try{return e&&401===e.code&&"Required session does not exist"===(null===(r=null===(n=null===(t=e.info)||void 0===t?void 0:t.errors)||void 0===n?void 0:n.base)||void 0===r?void 0:r[0])}catch(e){return!1}},e}(),Re=function(e){this.base64Encode=v,this.proxy=e,this.subscriptions=new Oe(e),this.events=new Pe(e)},Oe=function(){function e(e){this.route=N.urls.subscriptions,this.proxy=e}return e.prototype.create=function(e){return _(this,void 0,void 0,(function(){var t;return J(this,(function(n){return t={type:F.POST,url:q.getUrl(this.route),data:e},[2,this.proxy.ajax(t)]}))}))},e.prototype.list=function(){return _(this,void 0,void 0,(function(){var e;return J(this,(function(t){return e={type:F.GET,url:q.getUrl(this.route)},[2,this.proxy.ajax(e)]}))}))},e.prototype.delete=function(e){return _(this,void 0,void 0,(function(){var t;return J(this,(function(n){return t={type:F.DELETE,dataType:z.TEXT,url:q.getUrl(this.route,e)},[2,this.proxy.ajax(t)]}))}))},e}(),Pe=function(){function e(e){this.route=N.urls.events,this.proxy=e}return e.prototype.create=function(e){return _(this,void 0,void 0,(function(){var t;return J(this,(function(n){return t={type:F.POST,url:q.getUrl(this.route),data:{event:e}},[2,this.proxy.ajax(t)]}))}))},e}(),Le=function(){function e(e){this.route=N.urls.blobs,this.proxy=e}return e.prototype.list=function(){return _(this,arguments,void 0,(function(e){var t;return void 0===e&&(e={}),J(this,(function(n){return t={type:F.GET,url:q.getUrl(this.route),data:e},[2,this.proxy.ajax(t)]}))}))},e.prototype.create=function(e){return _(this,void 0,void 0,(function(){var t;return J(this,(function(n){return t={type:F.POST,url:q.getUrl(this.route),data:{blob:e}},[2,this.proxy.ajax(t)]}))}))},e.prototype.delete=function(e){return _(this,void 0,void 0,(function(){var t;return J(this,(function(n){return t={type:F.DELETE,url:q.getUrl(this.route,e),dataType:z.TEXT},[2,this.proxy.ajax(t)]}))}))},e.prototype.createAndUpload=function(e){return _(this,void 0,void 0,(function(){var t,n,r,o,i,s,a,c,u=this;return J(this,(function(l){return t=e.name,n=e.file,r=e.size,o=e.abort_id,i=e.type,s=e.public,a={name:t,content_type:i,public:void 0===s||s},[2,this.create(a).then((function(e){var t,r=e.blob;c=r;var i=u.parseUri(null===(t=c.blob_object_access)||void 0===t?void 0:t.params),s={url:"".concat(i.protocol,"://").concat(i.authority).concat(i.path),data:{}};return o&&(s.abort_id=o),Object.keys(i.queryKey).forEach((function(e){s.data[e]=decodeURIComponent(i.queryKey[e])})),s.data.file=n,u.upload(s).then((function(){return c}))})).then((function(e){return u.markUploaded({id:e.id,size:r}).then((function(){return e}))})).then((function(e){return U(U({},e),{size:r})}))]}))}))},e.prototype.upload=function(e){return _(this,void 0,void 0,(function(){var t;return J(this,(function(n){return t=U(U({},e),{type:F.POST,dataType:z.TEXT,contentType:!1}),[2,this.proxy.ajax(t)]}))}))},e.prototype.markUploaded=function(e){return _(this,void 0,void 0,(function(){var t;return J(this,(function(n){return t={type:F.PUT,url:q.getUrl(this.route,e.id,"complete"),data:{size:e.size},dataType:z.TEXT},[2,this.proxy.ajax(t)]}))}))},e.prototype.getInfo=function(e){return _(this,void 0,void 0,(function(){var t;return J(this,(function(n){return t={url:q.getUrl(this.route,e)},[2,this.proxy.ajax(t)]}))}))},e.prototype.getFile=function(e){return _(this,void 0,void 0,(function(){var t;return J(this,(function(n){return t={url:q.getUrl(this.route,e)},[2,this.proxy.ajax(t)]}))}))},e.prototype.getFileObject=function(e,t){return _(this,void 0,void 0,(function(){var n;return J(this,(function(r){return n={type:F.GET,url:q.getUrl(this.route,e,"object"),data:t},[2,this.proxy.ajax(n)]}))}))},e.prototype.update=function(e){return _(this,void 0,void 0,(function(){var t,n;return J(this,(function(r){return t={blob:{}},void 0!==e.name&&(t.blob.name=e.name),n={url:q.getUrl(this.route,e.id),data:t},[2,this.proxy.ajax(n)]}))}))},e.prototype.privateUrl=function(e){var t;return void 0===e&&(e=""),"https://".concat(N.endpoints.api,"/blobs/").concat(e,"?token=").concat(null===(t=this.proxy.getSession())||void 0===t?void 0:t.token)},e.prototype.publicUrl=function(e){return void 0===e&&(e=""),"https://".concat(N.endpoints.api,"/blobs/").concat(e)},e.prototype.parseUri=function(e){var t;void 0===e&&(e="");for(var n={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},r=null!==(t=n.parser.loose.exec(e))&&void 0!==t?t:{},o={},i=14;i--;)o[n.key[i]]=r[i]||"";return o[n.q.name]={},o[n.key[12]].replace(n.q.parser,(function(e,t,r){t&&(o[n.q.name][t]=r)})),o},e}(),je=function(){function e(e){this.route=N.urls.users,this.proxy=e}return e.prototype.getV2=function(e){return _(this,void 0,void 0,(function(){var t;return J(this,(function(n){return t={type:F.GET,url:q.getUrl(this.route,"v2"),useArrayQuery:!0,data:e},[2,this.proxy.ajax(t)]}))}))},e.prototype.signup=function(e,t){return _(this,void 0,void 0,(function(){var n;return J(this,(function(r){return n={authKey:null!=t?t:N.creds.authKey,type:F.POST,url:q.getUrl(this.route),data:{user:e}},[2,this.proxy.ajax(n)]}))}))},e.prototype.update=function(){return _(this,arguments,void 0,(function(e){var t;return void 0===e&&(e={}),J(this,(function(n){return t={type:F.PUT,url:q.getUrl(this.route,this.proxy.getCurrentUserId()),data:{user:e}},[2,this.proxy.ajax(t)]}))}))},e.prototype.delete=function(){return _(this,void 0,void 0,(function(){var e;return J(this,(function(t){return e={type:F.DELETE,url:q.getUrl(this.route,this.proxy.getCurrentUserId()),dataType:z.TEXT},[2,this.proxy.ajax(e)]}))}))},e.prototype.resetPassword=function(){return _(this,arguments,void 0,(function(e){var t;return void 0===e&&(e=""),J(this,(function(n){return t={type:F.POST,url:q.getUrl(this.route,"password","reset"),data:{email:e},dataType:z.TEXT},[2,this.proxy.ajax(t)]}))}))},e.prototype.get=function(e){return _(this,void 0,void 0,(function(){function t(e){var t=q.cloneObject(e),n=i.includes(t.field)?"date":typeof t.value;return q.isArray(t.value)&&("object"===n&&(n=typeof t.value[0]),t.value=t.value.toString()),[n,t.field,t.param,t.value].join(" ")}var n,r,o,i,s,a,c,u,l;return J(this,(function(d){if(n=q.cloneObject(e),r="",o=[],i=["created_at","updated_at","last_request_at"],s=["id","external_user_id"],a={login:"by_login",full_name:"by_full_name",facebook_id:"by_facebook_id",twitter_id:"by_twitter_id",phone:"phone",email:"by_email",tags:"by_tags",external:"external"},n.order&&(c=n.order.field in i?"date":n.order.field in s?"number":"string",n.order=[n.order.sort,c,n.order.field].join(" ")),n&&n.filter&&(q.isArray(n.filter)?n.filter.forEach((function(e){o.push(t(e))})):o.push(t(n.filter)),n.filter=o),"number"==typeof n)r=n,n=void 0;else for(u in a)if(n[u]){r=a[u],u===a.external&&(r+="/".concat(n[a.external]),n=void 0);break}return l={type:F.GET,url:q.getUrl(this.route,r),data:n},[2,this.proxy.ajax(l)]}))}))},e}(),Me=function(){function e(){}return e.getUserJid=function(e){return"".concat(e,"-").concat(N.creds.appId,"@").concat(N.endpoints.chat)},e.getUserIdFromJID=function(e){return(null==e?void 0:e.includes("@"))?parseInt(e.split("@")[0].split("-")[0]):null},e.trace=function(e){N.debug&&console.log("[VideoChat]:",e)},e.traceWarning=function(e){N.debug&&console.warn("[VideoChat]:",e)},e.traceError=function(e){N.debug&&console.error("[VideoChat]:",e)},Object.defineProperty(e,"getVersionFirefox",{get:function(){var e,t=null!==(e=null===navigator||void 0===navigator?void 0:navigator.userAgent)&&void 0!==e?e:null,n=0;if(t){var r=t.match(/(?:firefox)[ \/](\d+)/i)||[];n=r[1]?+r[1]:0}return"string"==typeof n?parseInt(n):n},enumerable:!1,configurable:!0}),Object.defineProperty(e,"getVersionSafari",{get:function(){var e,t=null!==(e=null===navigator||void 0===navigator?void 0:navigator.userAgent)&&void 0!==e?e:null,n=0;if(t&&(t.match(/(?:safari)[ \/](\d+)/i)||[]).length){var r=t.match(/(?:version)[ \/](\d+)/i)||[];r&&(n=r[1]?+r[1]:0)}return"string"==typeof n?parseInt(n):n},enumerable:!1,configurable:!0}),e}();!function(e){e.CALL="call",e.ACCEPT="accept",e.REJECT="reject",e.STOP="hangUp",e.RESTART="iceRestart",e.RESTART_ACCEPT="iceRestartAccept",e.CANDIDATE="iceCandidates"}(ye||(ye={})),function(e){e[e.UNDEFINED=0]="UNDEFINED",e[e.CONNECTING=1]="CONNECTING",e[e.CONNECTED=2]="CONNECTED",e[e.FAILED=3]="FAILED",e[e.DISCONNECTED=4]="DISCONNECTED",e[e.CLOSED=5]="CLOSED",e[e.COMPLETED=6]="COMPLETED"}(be||(be={})),function(e){e[e.NEW=1]="NEW",e[e.ACTIVE=2]="ACTIVE",e[e.HUNGUP=3]="HUNGUP",e[e.REJECTED=4]="REJECTED",e[e.CLOSED=5]="CLOSED"}(Ce||(Ce={})),function(e){e[e.NEW=1]="NEW",e[e.CONNECTING=2]="CONNECTING",e[e.CHECKING=3]="CHECKING",e[e.CONNECTED=4]="CONNECTED",e[e.DISCONNECTED=5]="DISCONNECTED",e[e.FAILED=6]="FAILED",e[e.CLOSED=7]="CLOSED",e[e.COMPLETED=8]="COMPLETED"}(Se||(Se={})),function(e){e[e.VIDEO=1]="VIDEO",e[e.AUDIO=2]="AUDIO"}(Te||(Te={})),function(e){e.CALL="call",e.ACCEPT="accept",e.REJECT="reject",e.HUNG_UP="hang-up",e.INVALID="invalid",e.NOT_ANSWER="not-answer",e.REMOTE_STREAM="remote-stream",e.CONNECTION_STATE="connection-state",e.CLOSE="close",e.STATS_REPORT="stats-report",e.DEVICES="devices"}(we||(we={}));var Ne=function(){function e(e,t,n){var r=this;this.remoteSDP=null,this.state=Se.NEW,this.iceCandidates=[],this.remoteStream=new k,this.answerTimeInterval=0,this.onStatusClosedChecker=null,this.dialingTimer=null,this.statsReportTimer=null,this.waitingReconnectTimeoutCallback=null,this.released=!1,this.onMediaTrackHandler=function(e){r.remoteStream.addTrack(e.track),(1==r.session.callType&&r.remoteStream.getVideoTracks().length||2==r.session.callType&&r.remoteStream.getAudioTracks().length)&&r.session.onRemoteStream(r.userID,r.remoteStream),r.getWrappedStats()},this.onIceCandidateHandler=function(e){if(e.candidate){var t=e.candidate,n={sdpMLineIndex:t.sdpMLineIndex,sdpMid:t.sdpMid,candidate:t.candidate};"stable"===r.signalingState?r.session.processIceCandidates(r.userID,[n]):r.iceCandidates.push(n)}},this.onSignalingStateHandler=function(){Me.trace("onSignalingStateHandler: ".concat(r.signalingState)),"stable"===r.signalingState&&r.iceCandidates.length>0&&(r.session.processIceCandidates(r.userID,r.iceCandidates),r.iceCandidates.length=0)},this.onIceConnectionStateHandler=function(){switch(Me.trace("onIceConnectionStateHandler: ".concat(r.iceConnectionState)),r.onStatusClosedChecker&&Me.getVersionSafari>=11&&clearTimeout(r.onStatusClosedChecker),r.iceConnectionState){case"checking":r.state=Se.CHECKING,r.session.onSessionConnectionStateChanged(r.userID,be.CONNECTING);break;case"connected":r.state=Se.CONNECTED,r.clearWaitingReconnectTimer(),r.session.onSessionConnectionStateChanged(r.userID,be.CONNECTED);break;case"completed":r.state=Se.COMPLETED,r.clearWaitingReconnectTimer(),r.session.onSessionConnectionStateChanged(r.userID,be.COMPLETED);break;case"failed":r.state=Se.FAILED,r.session.onSessionConnectionStateChanged(r.userID,be.FAILED);break;case"disconnected":r.state=Se.DISCONNECTED,r.startWaitingReconnectTimer(),r.session.onSessionConnectionStateChanged(r.userID,be.DISCONNECTED),Me.getVersionSafari>=11&&(r.onStatusClosedChecker=setTimeout((function(){r.onIceConnectionStateHandler()}),500));break;case"closed":r.state=Se.CLOSED,r.clearWaitingReconnectTimer(),r.session.onSessionConnectionStateChanged(r.userID,be.CLOSED)}},this.create(),this.setup(e,t,n)}return e.prototype.create=function(){var e={iceTransportPolicy:N.videochat.alwaysRelayCalls?"relay":"all",iceServers:N.videochat.iceServers.map((function(e){var t;return{urls:null!==(t=e.urls)&&void 0!==t?t:e.url,username:e.username,credential:e.credential}}))};this.original=A?new A(e):{},Me.trace("new RTCPeerConnection(".concat(JSON.stringify(e,null,2),")"))},e.prototype.setup=function(e,t,n){this.type=n,this.userID=t,this.session=e,this.session.startCallTime=new Date,this.original.ontrack=this.onMediaTrackHandler,this.original.onicecandidate=this.onIceCandidateHandler,this.original.onsignalingstatechange=this.onSignalingStateHandler,this.original.oniceconnectionstatechange=this.onIceConnectionStateHandler,Me.trace("RTCPeerConnection init. userID: ".concat(t,", sessionID: ").concat(e.ID,", type: ").concat(n))},e.prototype.clearWaitingReconnectTimer=function(){this.waitingReconnectTimeoutCallback&&(Me.trace("clearWaitingReconnectTimer"),clearTimeout(this.waitingReconnectTimeoutCallback),this.waitingReconnectTimeoutCallback=null)},e.prototype.startWaitingReconnectTimer=function(){var e=this,t=1e3*N.videochat.disconnectTimeInterval;Me.trace("startWaitingReconnectTimer, timeout: ".concat(t)),this.waitingReconnectTimeoutCallback=setTimeout((function(){Me.trace("waitingReconnectTimeoutCallback"),e.waitingReconnectTimeoutCallback&&clearTimeout(e.waitingReconnectTimeoutCallback),e.release(),e.session.closeSessionIfAllConnectionsClosed()}),t)},e.prototype.clearStatsReportTimer=function(){this.statsReportTimer&&(clearInterval(this.statsReportTimer),this.statsReportTimer=null)},e.prototype.addCandidates=function(e){return _(this,void 0,void 0,(function(){var t,n=this;return J(this,(function(r){return t=e.reduce((function(e,t){var r=t.sdpMLineIndex,o=t.sdpMid,i=t.candidate;if(i){var s=new D({sdpMLineIndex:r,sdpMid:o,candidate:i}),a=n.addIceCandidate(s).catch((function(e){Me.traceError("Error on 'addIceCandidate': ".concat(e))}));e.push(a)}return e}),[]),[2,Promise.all(t)]}))}))},e.prototype.release=function(){this.clearDialingTimer(),this.clearStatsReportTimer(),this.close(),Me.getVersionSafari>=11&&this.onIceConnectionStateHandler(),this.released=!0},e.prototype.clearDialingTimer=function(){this.dialingTimer&&(Me.trace("clearDialingTimer"),clearInterval(this.dialingTimer),this.dialingTimer=null,this.answerTimeInterval=0)},e.prototype.getAndSetLocalSessionDescription=function(e){return _(this,arguments,void 0,(function(e,t){var n,r,o;return void 0===t&&(t=!1),J(this,(function(i){switch(i.label){case 0:this.state=Se.CONNECTING,i.label=1;case 1:return i.trys.push([1,8,,9]),n=t?{iceRestart:t}:void 0,"offer"!==this.type?[3,3]:[4,this.createOffer(n)];case 2:return o=i.sent(),[3,5];case 3:return[4,this.createAnswer()];case 4:o=i.sent(),i.label=5;case 5:return r=o,[4,this.setLocalDescription(r)];case 6:return i.sent(),[4,this.setRTCRtpSenderMaxBandwidth(e)];case 7:return i.sent(),[2,r];case 8:throw i.sent();case 9:return[2]}}))}))},e.prototype.setRTCRtpSenderMaxBandwidth=function(e){return _(this,void 0,void 0,(function(){var t,n,r=this;return J(this,(function(o){return t=this.getSenders()||[],n=t.reduce((function(t,n){var o,i;if("video"===(null===(o=n.track)||void 0===o?void 0:o.kind)){var s=n.getParameters();s.encodings||(s.encodings=[]),e?s.encodings[0].maxBitrate=1e3*e:null===(i=s.encodings[0])||void 0===i||delete i.maxBitrate,t.push(n.setParameters(s).then((function(){Me.trace("Set maxBandwidth success [".concat(r.userID,"]: ").concat(e," kbps"))})).catch((function(e){Me.trace("Set maxBandwidth error [".concat(r.userID,"]: ").concat(e))})))}return t}),[]),[2,Promise.all(n)]}))}))},e.prototype.startDialingTimer=function(e,t){var n=this,r=1e3*N.videochat.dialingTimeInterval;Me.trace("startDialingTimer, dialingTimeInterval: ".concat(JSON.stringify(r)));var o=function(e,t,r){r||(n.answerTimeInterval+=1e3*N.videochat.dialingTimeInterval),Me.trace("dialingCallback, extension: ".concat(JSON.stringify(e))),n.answerTimeInterval>=1e3*N.videochat.answerTimeInterval?(n.clearDialingTimer(),t&&n.session.processOnNotAnswer(n)):n.session.processCall(n,e)};this.dialingTimer=setInterval(o,r,e,t,!1),o(e,t,!0)},e.prototype.setRemoteSessionDescription=function(e,t){return _(this,void 0,void 0,(function(){var n;return J(this,(function(r){return n=new P({sdp:t,type:e}),[2,this.setRemoteDescription(n)]}))}))},e.prototype.getWrappedStats=function(){var e,t=this;N.videochat.statsReportTimeInterval&&(Me.trace("Stats tracker has been started"),this.statsReportTimer=setInterval((function(){t.getStatsCustom(e,(function(n,r){e=r,t.session.onCallStatsReport(t.userID,n)}),(function(e){Me.traceError("Get stats error. ".concat(e.name,": ").concat(e.message)),t.session.onCallStatsReport(t.userID,null,e)}))}),1e3*N.videochat.statsReportTimeInterval))},Object.defineProperty(e.prototype,"sdpRemote",{get:function(){return this.remoteSDP},set:function(e){e&&(this.remoteSDP=e)},enumerable:!1,configurable:!0}),e.prototype.toString=function(){return"sessionID: ".concat(this.session.ID,", userID: ").concat(this.userID,", type: ").concat(this.type,", state: ").concat(this.state)},e.prototype.getStatsCustom=function(e,t,n){var r=this,o={audio:{},video:{},candidate:{}},i={local:Object.assign({},o),remote:Object.assign({},o)};if(Me.getVersionFirefox){var s=this.session.localStream,a=null==s?void 0:s.getVideoTracks()[0].getSettings();a&&(i.local.video.frameHeight=a.height,i.local.video.frameWidth=a.width)}this.getStats().then((function(n){n.forEach((function(t){var n;t.bytesReceived&&"inbound-rtp"===t.type?((n=i.remote[t.mediaType]).bitrate=r.getBitratePerSecond(t,e,!1),n.bytesReceived=t.bytesReceived,n.packetsReceived=t.packetsReceived,n.timestamp=t.timestamp,"video"===t.mediaType&&t.framerateMean&&(n.framesPerSecond=Math.round(10*t.framerateMean)/10)):t.bytesSent&&"outbound-rtp"===t.type?((n=i.local[t.mediaType]).bitrate=r.getBitratePerSecond(t,e,!0),n.bytesSent=t.bytesSent,n.packetsSent=t.packetsSent,n.timestamp=t.timestamp,"video"===t.mediaType&&t.framerateMean&&(n.framesPerSecond=Math.round(10*t.framerateMean)/10)):"local-candidate"===t.type?(n=i.local.candidate,"host"===t.candidateType&&"udp"===t.mozLocalTransport&&"udp"===t.transport?(n.protocol=t.transport,n.ip=t.ipAddress,n.port=t.portNumber):Me.getVersionFirefox||(n.protocol=t.protocol,n.ip=t.ip,n.port=t.port)):"remote-candidate"===t.type?((n=i.remote.candidate).protocol=t.protocol||t.transport,n.ip=t.ip||t.ipAddress,n.port=t.port||t.portNumber):"track"!==t.type||"video"!==t.kind||Me.getVersionFirefox||(t.remoteSource?((n=i.remote.video).frameHeight=t.frameHeight,n.frameWidth=t.frameWidth,n.framesPerSecond=r.getFramesPerSecond(t,e,!1)):((n=i.local.video).frameHeight=t.frameHeight,n.frameWidth=t.frameWidth,n.framesPerSecond=r.getFramesPerSecond(t,e,!0)))})),t(i,n)}),n)},e.prototype.getBitratePerSecond=function(e,t,n){var r=t.get(e.id),o=r?(e.timestamp-r.timestamp)/1e3:5,i=r?n?8*(e.bytesSent-r.bytesSent)/(1024*o):8*(e.bytesReceived-r.bytesReceived)/(1024*o):0;return Math.round(i)},e.prototype.getFramesPerSecond=function(e,t,n){var r=t&&t.get(e.id),o=r?(e.timestamp-r.timestamp)/1e3:5,i=r?n?(e.framesSent-r.framesSent)/o:(e.framesReceived-r.framesReceived)/o:0;return Math.round(10*i)/10},e.prototype.getSenders=function(){var e,t,n;return null!==(n=null===(t=(e=this.original).getSenders)||void 0===t?void 0:t.call(e))&&void 0!==n?n:[]},e.prototype.createOffer=function(e){var t,n,r;return null!==(r=null===(n=(t=this.original).createOffer)||void 0===n?void 0:n.call(t,e))&&void 0!==r?r:Promise.resolve({})},e.prototype.createAnswer=function(e){var t,n,r;return null!==(r=null===(n=(t=this.original).createAnswer)||void 0===n?void 0:n.call(t,e))&&void 0!==r?r:Promise.resolve({})},e.prototype.setRemoteDescription=function(e){var t,n,r;return null!==(r=null===(n=(t=this.original).setRemoteDescription)||void 0===n?void 0:n.call(t,e))&&void 0!==r?r:Promise.resolve()},e.prototype.setLocalDescription=function(e){var t,n,r;return null!==(r=null===(n=(t=this.original).setLocalDescription)||void 0===n?void 0:n.call(t,e))&&void 0!==r?r:Promise.resolve()},e.prototype.getStats=function(){var e,t,n;return null!==(n=null===(t=(e=this.original).getStats)||void 0===t?void 0:t.call(e))&&void 0!==n?n:Promise.resolve(new Map)},e.prototype.close=function(){var e,t;null===(t=(e=this.original).close)||void 0===t||t.call(e)},e.prototype.addIceCandidate=function(e){var t,n,r;return null!==(r=null===(n=(t=this.original).addIceCandidate)||void 0===n?void 0:n.call(t,e))&&void 0!==r?r:Promise.resolve()},e.prototype.addTrack=function(e,t){var n,r,o;return null!==(o=null===(r=(n=this.original).addTrack)||void 0===r?void 0:r.call(n,e,t))&&void 0!==o?o:{}},Object.defineProperty(e.prototype,"localDescription",{get:function(){var e;return null!==(e=this.original.localDescription)&&void 0!==e?e:{type:"",sdp:""}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"signalingState",{get:function(){var e;return null!==(e=this.original.signalingState)&&void 0!==e?e:"closed"},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"iceConnectionState",{get:function(){var e;return null!==(e=this.original.iceConnectionState)&&void 0!==e?e:"closed"},enumerable:!1,configurable:!0}),e}(),Ue=function(){function e(e){var t,n,r;this.ID=null,this.state=Ce.NEW,this.maxBandwidth=0,this.peerConnections={},this.mediaParams={},this.answerTimer=null,this.waitingOfferOrAnswerTimer=null,Object.assign(this,e,{ID:null!==(t=e.ID)&&void 0!==t?t:(n=(new Date).getTime(),r="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=(n+16*Math.random())%16|0;return n=Math.floor(n/16),("x"==e?t:3&t|8).toString(16)})),r)})}return e.prototype.getDisplayMedia=function(e){return _(this,void 0,void 0,(function(){var t,n,r,o;return J(this,(function(i){switch(i.label){case 0:if(!E.getDisplayMedia)throw new Error("Your environment does not support 'getDisplayMedia' API");t=e&&e.elementId,n=e&&e.options,r=U({},e),this.mediaParams=r,delete r.elementId,delete r.options,i.label=1;case 1:return i.trys.push([1,3,,4]),[4,E.getDisplayMedia(r)];case 2:return o=i.sent(),[2,this.upsertStream(o,t,n)];case 3:throw i.sent();case 4:return[2]}}))}))},e.prototype.getUserMedia=function(e){return _(this,void 0,void 0,(function(){var t,n,r,o;return J(this,(function(i){switch(i.label){case 0:t=e&&e.elementId,n=e&&e.options,r=U({},e),this.mediaParams=r,delete r.elementId,delete r.options,i.label=1;case 1:return i.trys.push([1,3,,4]),[4,E.getUserMedia(r)];case 2:return o=i.sent(),[2,this.upsertStream(o,t,n)];case 3:throw i.sent();case 4:return[2]}}))}))},e.prototype.upsertStream=function(e,t,n){var r=!!this.localStream;if(r?this.replaceTracks(e):this.localStream=e,!this.localStream)throw new Error("Local stream is not defined");return t&&(r&&this.detachMediaStream(t,n),this.attachMediaStream(t,this.localStream,n)),this.localStream},e.prototype.replaceTracks=function(e){var t,n=this;if(null===(t=this.localStream)||void 0===t||t.getTracks().forEach((function(t){var r;"audio"===t.kind&&0===e.getAudioTracks().length||(t.stop(),null===(r=n.localStream)||void 0===r||r.removeTrack(t))})),e.getTracks().forEach((function(e){var t,r,o,i,s;"audio"===e.kind?e.enabled=null===(r=null===(t=n.localStream)||void 0===t?void 0:t.getAudioTracks().every((function(e){return e.enabled})))||void 0===r||r:e.enabled=null===(i=null===(o=n.localStream)||void 0===o?void 0:o.getVideoTracks().every((function(e){return e.enabled})))||void 0===i||i,e&&(Object.values(n.peerConnections).forEach((function(t){var n;null===(n=t.getSenders().find((function(t){var n=t.track;return e.kind===(null==n?void 0:n.kind)})))||void 0===n||n.replaceTrack(e)})),null===(s=n.localStream)||void 0===s||s.addTrack(e))})),!this.localStream)throw new Error("Local stream is not defined");return this.localStream},e.prototype.setMaxBandwidth=function(e){return _(this,void 0,void 0,(function(){var t,n;return J(this,(function(r){return t=this.peerConnections,(n=Object.keys(t)).length<1?(Me.trace("No 'RTCPeerConnection' to set 'maxBandwidth'"),[2]):[2,Promise.all(n.map((function(n){return t[n].setRTCRtpSenderMaxBandwidth(e)})))]}))}))},e.prototype.connectionStateForUser=function(e){var t=this.peerConnections[e];return t?t.state:null},e.prototype.attachMediaStream=function(e,t,n){var r=document.getElementById(e);if(!("srcObject"in r))throw new Error("Unable to attach media stream, element #".concat(e," is undefined"));r.srcObject=t,r.style.transform=(null==n?void 0:n.mirror)?"scaleX(-1)":"none","boolean"==typeof(null==n?void 0:n.muted)&&(r.muted=null==n?void 0:n.muted),r.onloadedmetadata=function(e){r.play()}},e.prototype.detachMediaStream=function(e,t){var n=document.getElementById(e);if(!("srcObject"in n))throw new Error("Unable to attach media stream, element #".concat(e," is undefined"));n.pause(),n.srcObject=null,n.style.transform=(null==t?void 0:t.mirror)?"scaleX(-1)":"none","boolean"==typeof(null==t?void 0:t.muted)&&(n.muted=null==t?void 0:t.muted)},e.prototype.switchMediaTracks=function(){return _(this,arguments,void 0,(function(e){var t,n,r=this;return void 0===e&&(e={}),J(this,(function(o){switch(o.label){case 0:q.DLog("switchMediaTracks:",e),["audio","video"].forEach((function(t){var n="audio"===t?e.audio:"audio"===t?e.video:{},o="string"==typeof n?n:null==n?void 0:n.deviceId;o&&("object"!=typeof r.mediaParams[t]?r.mediaParams[t].deviceId=o:r.mediaParams[t]={deviceId:o})})),o.label=1;case 1:return o.trys.push([1,3,,4]),t={audio:this.mediaParams.audio||!1,video:this.mediaParams.video||!1},[4,E.getUserMedia(t)];case 2:return n=o.sent(),[2,this.replaceTracks(n)];case 3:throw o.sent();case 4:return[2]}}))}))},e.prototype.call=function(e){var t,n,r=this;void 0===e&&(e={});var o=_e(e);Me.trace("Call, extension: ".concat(JSON.stringify(o))),this.state=Ce.ACTIVE,this.maxBandwidth=Number(null!==(n=null===(t=o.userInfo)||void 0===t?void 0:t.maxBandwidth)&&void 0!==n?n:0),this.opponentsIDs.forEach((function(e){r.callInternal(e,o,!0)}))},e.prototype.callInternal=function(e,t,n){return _(this,void 0,void 0,(function(){var r,o,i,s=this;return J(this,(function(a){switch(a.label){case 0:r=new Ne(this,e,"offer"),null===(i=this.localStream)||void 0===i||i.getTracks().forEach((function(e){s.localStream&&r.addTrack(e,s.localStream)})),this.peerConnections[e]=r,a.label=1;case 1:return a.trys.push([1,3,,4]),[4,r.getAndSetLocalSessionDescription(this.maxBandwidth)];case 2:return a.sent(),r.startDialingTimer(t,n),Me.trace("getAndSetLocalSessionDescription success"),[3,4];case 3:return o=a.sent(),Me.traceError("getAndSetLocalSessionDescription error: ".concat(o)),[3,4];case 4:return[2]}}))}))},e.prototype.accept=function(e){var t=this;void 0===e&&(e={});var n=_e(e);if(Me.trace("Accept, extension: ".concat(JSON.stringify(n))),this.state!==Ce.ACTIVE){if(this.state===Ce.CLOSED)return Me.traceError("Can't accept, the session is already closed, return"),void this.stop({});this.state=Ce.ACTIVE,this.acceptCallTime=new Date,this.clearAnswerTimer(),this.acceptInternal(this.initiatorID,n);var r=this.opponentsIDs.filter((function(e){return e!==t.initiatorID}));r.length>0&&(this.startWaitingOfferOrAnswerTimer(),r.forEach((function(n){t.currentUserID>n&&t.callInternal(n,e,!0)})))}else Me.traceError("Can't accept, the session is already active, return")},e.prototype.acceptInternal=function(e,t){return _(this,void 0,void 0,(function(){var n,r,o,i,s=this;return J(this,(function(a){switch(a.label){case 0:if(!(n=this.peerConnections[e])||!n.sdpRemote)return Me.traceError("Can't accept the call, there is no information about peer connection by some reason"),[2];null===(i=this.localStream)||void 0===i||i.getTracks().forEach((function(e){s.localStream&&n.addTrack(e,s.localStream)})),a.label=1;case 1:return a.trys.push([1,4,,5]),[4,n.setRemoteSessionDescription("offer",n.sdpRemote)];case 2:return a.sent(),[4,n.getAndSetLocalSessionDescription(this.maxBandwidth)];case 3:return a.sent(),r=Object.assign({},t,{sessionID:this.ID,callType:this.callType,callerID:this.initiatorID,opponentsIDs:this.opponentsIDs,sdp:n.localDescription.sdp}),this.signalingProvider.sendMessage(e,r,ye.ACCEPT),[3,5];case 4:return o=a.sent(),Me.traceError("[acceptInternal] Error: ".concat(o)),[3,5];case 5:return[2]}}))}))},e.prototype.reject=function(e){var t=this;void 0===e&&(e={});var n=_e(e);Me.trace("Reject, extension: ".concat(JSON.stringify(n.userInfo))),this.state=Ce.REJECTED,this.clearAnswerTimer(),Object.assign(n,{sessionID:this.ID,callType:this.callType,callerID:this.initiatorID,opponentsIDs:this.opponentsIDs}),Object.keys(this.peerConnections).forEach((function(e){t.signalingProvider.sendMessage(Number(e),n,ye.REJECT)})),this.close()},e.prototype.stop=function(e){var t=this;void 0===e&&(e={});var n=_e(e);Me.trace("Stop, extension: ".concat(JSON.stringify(n.userInfo))),this.state=Ce.HUNGUP,this.answerTimer&&this.clearAnswerTimer(),Object.assign(n,{sessionID:this.ID,callType:this.callType,callerID:this.initiatorID,opponentsIDs:this.opponentsIDs}),Object.keys(this.peerConnections).forEach((function(e){t.signalingProvider.sendMessage(Number(e),n,ye.STOP)})),this.close()},e.prototype.canInitiateIceRestart=function(e){var t;return"offer"===(null===(t=this.peerConnections[e])||void 0===t?void 0:t.type)},e.prototype.iceRestart=function(e){return _(this,void 0,void 0,(function(){var t,n,r,o,i;return J(this,(function(s){switch(s.label){case 0:if(!(t=this.peerConnections[e]))return Me.traceError("Can't restart ice, there is no information about peer connection by some reason"),[2];s.label=1;case 1:return s.trys.push([1,3,,4]),[4,t.getAndSetLocalSessionDescription(this.maxBandwidth,!0)];case 2:return n=s.sent().sdp,r={sessionID:null!==(i=this.ID)&&void 0!==i?i:"",sdp:n},this.signalingProvider.sendMessage(e,r,ye.RESTART),Me.trace("[iceRestart] OK"),[3,4];case 3:return o=s.sent(),Me.traceError("[iceRestart] Error: ".concat(o)),[3,4];case 4:return[2]}}))}))},e.prototype.processOnCall=function(e,t){var n=this;V([this.initiatorID],this.opponentsIDs.filter((function(e){return e!==n.currentUserID})),!0).forEach((function(r){var o=n.peerConnections[r];if(o)r===e&&(o.sdpRemote=t.sdp,e!==n.initiatorID&&n.state===Ce.ACTIVE&&n.acceptInternal(e,t));else{var i=r!==e&&n.currentUserID>r?"offer":"answer",s=new Ne(n,r,i);r===e&&(s.sdpRemote=t.sdp,n.startAnswerTimer()),n.peerConnections[r]=s}}))},e.prototype.processOnAccept=function(e,t){return _(this,void 0,void 0,(function(){var n,r;return J(this,(function(o){switch(o.label){case 0:(n=this.peerConnections[e])||Me.traceWarning("Ignore 'OnAccept', there is no information about peer connection by some reason"),o.label=1;case 1:return o.trys.push([1,3,,4]),n.clearDialingTimer(),[4,n.setRemoteSessionDescription("answer",t.sdp)];case 2:return o.sent(),Me.trace("'setRemoteSessionDescription' success"),[3,4];case 3:return r=o.sent(),Me.traceError("'setRemoteSessionDescription' error: ".concat(r)),[3,4];case 4:return[2]}}))}))},e.prototype.processOnReject=function(e){var t=this.peerConnections[e];this.clearWaitingOfferOrAnswerTimer(),t?t.release():Me.traceWarning("Ignore 'OnReject', there is no information about peer connection by some reason"),this.closeSessionIfAllConnectionsClosed()},e.prototype.processOnStop=function(e){var t=this;if(this.clearAnswerTimer(),e===this.initiatorID){var n=Object.keys(this.peerConnections);n.length>0?n.forEach((function(e){t.peerConnections[e].release()})):Me.traceWarning("Ignore 'OnStop', there is no information about peer connections by some reason")}else{var r=this.peerConnections[e];r?r.release():Me.traceWarning('Ignore "OnStop", there is no information about peer connection by some reason')}this.closeSessionIfAllConnectionsClosed()},e.prototype.processOnIceCandidates=function(e,t){return _(this,void 0,void 0,(function(){var n;return J(this,(function(r){switch(r.label){case 0:return(n=this.peerConnections[e])||Me.traceWarning('Ignore "OnIceCandidates", there is no information about peer connection by some reason'),t.iceCandidates?[4,n.addCandidates(t.iceCandidates)]:[3,2];case 1:r.sent(),r.label=2;case 2:return[2]}}))}))},e.prototype.processOnIceRestart=function(e,t){return _(this,void 0,void 0,(function(){var n,r,o,i,s;return J(this,(function(a){switch(a.label){case 0:(n=this.peerConnections[e])||Me.traceWarning('Ignore "OnIceRestart", there is no information about peer connection by some reason'),a.label=1;case 1:return a.trys.push([1,4,,5]),[4,n.setRemoteSessionDescription("offer",t.sdp)];case 2:return a.sent(),[4,n.getAndSetLocalSessionDescription(this.maxBandwidth)];case 3:return r=a.sent().sdp,o={sessionID:null!==(s=this.ID)&&void 0!==s?s:"",sdp:r},this.signalingProvider.sendMessage(e,o,ye.RESTART_ACCEPT),Me.trace("[processOnIceRestart] Success"),[3,5];case 4:return i=a.sent(),Me.traceError("[processOnIceRestart] Error: ".concat(i)),[3,5];case 5:return[2]}}))}))},e.prototype.processOnIceRestartAccept=function(e,t){return _(this,void 0,void 0,(function(){var n,r;return J(this,(function(o){switch(o.label){case 0:(n=this.peerConnections[e])||Me.traceWarning('Ignore "OnIceRestartAccept", there is no information about peer connection by some reason'),o.label=1;case 1:return o.trys.push([1,3,,4]),[4,n.setRemoteSessionDescription("answer",t.sdp)];case 2:return o.sent(),Me.trace("[processOnIceRestartAccept] Success"),[3,4];case 3:return r=o.sent(),Me.traceError("[processOnIceRestartAccept] Error: ".concat(r)),[3,4];case 4:return[2]}}))}))},e.prototype.processCall=function(e,t){void 0===t&&(t={});var n=Object.assign({userInfo:{}},t,{sessionID:this.ID,callType:this.callType,callerID:this.initiatorID,opponentsIDs:this.opponentsIDs,sdp:e.localDescription.sdp});this.signalingProvider.sendMessage(e.userID,n,ye.CALL)},e.prototype.processIceCandidates=function(e,t){var n,r={sessionID:null!==(n=this.ID)&&void 0!==n?n:"",callType:this.callType,callerID:this.initiatorID,opponentsIDs:this.opponentsIDs};this.signalingProvider.sendCandidate(e,t,r)},e.prototype.processOnNotAnswer=function(e){Me.trace("Answer timeout callback for session ".concat(this.ID," for user ").concat(e.userID)),this.clearWaitingOfferOrAnswerTimer(),e.release(),q.safeCallbackCall(this.onUserNotAnswerListener)(this,e.userID),this.closeSessionIfAllConnectionsClosed()},e.prototype.onRemoteStream=function(e,t){q.safeCallbackCall(this.onRemoteStreamListener)(this,e,t)},e.prototype.onCallStatsReport=function(e,t,n){q.safeCallbackCall(this.onCallStatsReportListener)(this,e,t,n)},e.prototype.onSessionConnectionStateChanged=function(e,t){q.safeCallbackCall(this.onSessionConnectionStateChangedListener)(this,e,t)},e.prototype.close=function(){Object.values(this.peerConnections).forEach((function(e){try{e.release()}catch(e){q.DLog("Peer close error: ".concat(e))}})),this.closeLocalMediaStream(),this.state=Ce.CLOSED,q.safeCallbackCall(this.onSessionCloseListener)(this)},e.prototype.closeSessionIfAllConnectionsClosed=function(){var e=!0;Object.values(this.peerConnections).forEach((function(t){var n=!1;try{n="closed"===t.iceConnectionState||"closed"===t.signalingState||t.released}catch(e){Me.traceError(e),n=!0}e=n})),Me.trace("All peer connections closed: ".concat(e)),e&&(this.closeLocalMediaStream(),q.safeCallbackCall(this.onSessionCloseListener)(this),this.state=Ce.CLOSED)},e.prototype.closeLocalMediaStream=function(){this.localStream&&(this.localStream.getTracks().forEach((function(e){return e.stop()})),this.localStream=void 0,this.mediaParams={})},e.prototype.mute=function(e){this.muteStream(!1,e)},e.prototype.unmute=function(e){this.muteStream(!0,e)},e.prototype.muteStream=function(e,t){var n,r;void 0===t&&(t="none");var o="audio"===t?null===(n=this.localStream)||void 0===n?void 0:n.getAudioTracks():"video"===t?null===(r=this.localStream)||void 0===r?void 0:r.getVideoTracks():[];null==o||o.forEach((function(t){t.enabled=e}))},e.prototype.clearAnswerTimer=function(){this.answerTimer&&(Me.trace("clearAnswerTimer"),clearTimeout(this.answerTimer),this.answerTimer=null)},e.prototype.startAnswerTimer=function(){var e=this;Me.trace("startAnswerTimer"),this.answerTimer=setTimeout((function(){Me.trace("answerTimeoutCallback"),e.close(),e.answerTimer=null}),1e3*N.videochat.answerTimeInterval)},e.prototype.clearWaitingOfferOrAnswerTimer=function(){this.waitingOfferOrAnswerTimer&&(Me.trace("clearWaitingOfferOrAnswerTimer"),clearTimeout(this.waitingOfferOrAnswerTimer),this.waitingOfferOrAnswerTimer=null)},e.prototype.startWaitingOfferOrAnswerTimer=function(){var e=this,t=(this.acceptCallTime-this.startCallTime)/1e3,n=Math.max(N.videochat.answerTimeInterval-t,1);Me.trace("startWaitingOfferOrAnswerTimer, timeout: ".concat(n)),this.waitingOfferOrAnswerTimer=setTimeout((function(){Me.trace("waitingOfferOrAnswerTimeoutCallback"),Object.values(e.peerConnections).forEach((function(t){t.state!==Se.CONNECTING&&t.state!==Se.NEW||e.processOnNotAnswer(t)})),e.waitingOfferOrAnswerTimer=null}),1e3*n)},e.prototype.toString=function(){return"ID: ".concat(this.ID,", initiatorID: ").concat(this.initiatorID,", opponentsIDs: ").concat(this.opponentsIDs,", state: ").concat(this.state,", callType: ").concat(this.callType)},Object.defineProperty(e.prototype,"startCallTime",{get:function(){return this.startCallDate.getTime()},set:function(e){this.startCallDate=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"acceptCallTime",{get:function(){return this.acceptCallDate.getTime()},set:function(e){this.acceptCallDate=e},enumerable:!1,configurable:!0}),e}();function _e(e){void 0===e&&(e={});var t={userInfo:e};try{q.isObject(e)?t.userInfo=q.cloneObject(e,!0):Me.traceWarning('Ignore "prepareExtension", must be an object')}catch(e){Me.traceWarning(e.message)}return t}var Je=function(){function e(e){var t=this;this.onMessage=function(e,n){var r,o=t.getExtension(n),i=null!==(r=null==o?void 0:o.sessionID)&&void 0!==r?r:"",s=null==o?void 0:o.signalType;switch(null==o||delete o.moduleIdentifier,null==o||delete o.sessionID,null==o||delete o.signalType,s){case ye.CALL:t.delegate.onCallHandler(e,i,o);break;case ye.ACCEPT:t.delegate.onAcceptHandler(e,i,o);break;case ye.REJECT:t.delegate.onRejectHandler(e,i,o);break;case ye.STOP:t.delegate.onStopHandler(e,i,o);break;case ye.CANDIDATE:t.delegate.onIceCandidatesHandler(e,i,o);break;case ye.RESTART:t.delegate.onIceRestartHandler(e,i,o);break;case ye.RESTART_ACCEPT:t.delegate.onIceRestartAcceptHandler(e,i,o)}},this.delegate=e}return e.prototype.getExtension=function(e){var t,n;if(!e)return{};var r={iceCandidates:[],opponentsIDs:[]};return Z.getChildElements(e).forEach((function(e){var t,n=Z.getChildElements(e),o=null!==(t=Z.getName(e))&&void 0!==t?t:"";switch(o){case"callerID":r[o]=parseInt(Z.getText(e)||"0");break;case"callType":var i=Z.getText(e);r[o]="1"===i?Te.VIDEO:"2"===i?Te.AUDIO:void 0;break;case"iceCandidates":n.forEach((function(e){var t,n={};Z.getChildElements(e).forEach((function(e){var t=Z.getName(e)||"",r=Z.getText(e);n[t]="sdpMLineIndex"===t?parseInt(r||"0"):r})),null===(t=r.iceCandidates)||void 0===t||t.push(n)}));break;case"opponentsIDs":n.forEach((function(e){var t;null===(t=r.opponentsIDs)||void 0===t||t.push(parseInt(Z.getText(e)||"0"))}));break;default:n.length>1?(Z.getText(e)||"").length>4096?r[o]=n.reduce((function(e,t){return e+Z.getText(t)}),""):Z.assignXmlToObject(e,r):"userInfo"===o?Z.assignXmlToObject(e,r):r[o]=Z.getText(e)}})),0===(null===(t=r.iceCandidates)||void 0===t?void 0:t.length)&&delete r.iceCandidates,0===(null===(n=r.opponentsIDs)||void 0===n?void 0:n.length)&&delete r.opponentsIDs,r},e}(),Ve=function(){function e(e){this.signalingConnection=e}return e.prototype.sendCandidate=function(e,t,n){void 0===n&&(n={});var r=Object.assign({},n,{iceCandidates:t});this.sendMessage(e,r,ye.CANDIDATE)},e.prototype.sendMessage=function(e,t,n){var r=Object.assign({},t);r.moduleIdentifier="WebRTCVideoChat",r.signalType=n,r.platform=q.env.isBrowser?"web":q.env.isReactNative||q.env.isExpo?"mobile":"node",r.userInfo&&(Object.keys(r.userInfo).length?0===r.userInfo.maxBandwidth&&delete r.userInfo.maxBandwidth:delete r.userInfo);var o=Z.createMessageStanza({to:Me.getUserJid(e),type:"headline",id:q.getBsonObjectId()}).c("extraParams",{xmlns:"jabber:client"});Object.keys(r).forEach((function(e){var t=r[e];"iceCandidates"===e?(o=o.c("iceCandidates"),t.forEach((function(e){o=o.c("iceCandidate"),Object.keys(e).forEach((function(t){o=o.c(t).t(e[t]).up()})),o=o.up()})),o=o.up()):"opponentsIDs"===e?(o=o.c("opponentsIDs"),t.forEach((function(e){o=o.c("opponentID").t(e).up()})),o=o.up()):"object"==typeof t?Z.assignObjectToXml(o,t,e):o=o.c(e).t(t).up()})),o=o.up(),this.signalingConnection.send(o)},e}(),Fe=function(){function e(e,t){this.SessionConnectionState=be,this.PeerConnectionState=Se,this.CallType=Te,this.sessions={},this.onDevicesChangeListener=function(){},this.connection=e,this.proxy=t,this.signalingProcessor=new Je(this),this.signalingProvider=new Ve(e),E&&(E.ondevicechange=q.safeCallbackCall(this.onDevicesChangeListener))}return e.prototype.getMediaDevices=function(e){return _(this,void 0,void 0,(function(){var t;return J(this,(function(n){switch(n.label){case 0:return(null==E?void 0:E.enumerateDevices)?[4,E.enumerateDevices()]:[3,2];case 1:return t=n.sent(),[2,e?t.filter((function(t){return t.kind===e})):t];case 2:throw new Error("No 'enumerateDevices' API supported")}}))}))},e.prototype.createNewSession=function(e,t,n){var r,o,i,s,a=null!==(o=null===(r=this.connection.jid)||void 0===r?void 0:r.toString())&&void 0!==o?o:"",c=null!==(i=Me.getUserIdFromJID(a))&&void 0!==i?i:0,u=null!==(s=(null==n?void 0:n.maxBandwidth)||(null==n?void 0:n.bandwidth))&&void 0!==s?s:0;if(!e)throw new Error("Can't create a session without opponentsIDs");return this.createAndStoreSession(null,c,e,t,u)},e.prototype.createAndStoreSession=function(e,t,n,r,o){var i,s,a;void 0===o&&(o=0);var c=null!==(s=null===(i=this.connection.jid)||void 0===i?void 0:i.toString())&&void 0!==s?s:"",u=null!==(a=Me.getUserIdFromJID(c))&&void 0!==a?a:0,l=new Ue({ID:e,initiatorID:t,opponentsIDs:n,callType:r,signalingProvider:this.signalingProvider,currentUserID:u,maxBandwidth:o});return l.onUserNotAnswerListener=this.onUserNotAnswerListener,l.onRemoteStreamListener=this.onRemoteStreamListener,l.onSessionConnectionStateChangedListener=this.onSessionConnectionStateChangedListener,l.onSessionCloseListener=this.onSessionCloseListener,l.onCallStatsReportListener=this.onCallStatsReport,(null==l?void 0:l.ID)&&(this.sessions[l.ID]=l),l},e.prototype.clearSession=function(e){delete this.sessions[e]},e.prototype.callRejectRequest=function(e){var t={type:F.POST,url:q.getUrl(N.urls.calls,"reject"),data:e};return this.proxy.ajax(t)},e.prototype.onCallHandler=function(e,t,n){var r,o=n.userInfo||{},i=Number(null!==(r=o.maxBandwidth)&&void 0!==r?r:0),s=this.sessions[t];Me.trace("onCall. userID: ".concat(e,", sessionID: ").concat(t,", extension: ").concat(JSON.stringify(n))),s||(s=this.createAndStoreSession(t,n.callerID||0,n.opponentsIDs||[],n.callType||Te.VIDEO,i),q.safeCallbackCall(this.onCallListener)(s,o)),s.processOnCall(e,n)},e.prototype.onAcceptHandler=function(e,t,n){var r=this.sessions[t],o=n.userInfo||{};Me.trace("onAccept. UserID: ".concat(e,", sessionID: ").concat(t,", extension: ").concat(JSON.stringify(n))),!r||r.state!==Ce.ACTIVE&&r.state!==Ce.NEW?Me.traceWarning("Ignore 'onAccept', there is no information about session ".concat(t)):(q.safeCallbackCall(this.onAcceptCallListener)(r,e,o),r.processOnAccept(e,n))},e.prototype.onRejectHandler=function(e,t,n){var r=this.sessions[t];if(Me.trace("onReject. UserID: ".concat(e,", sessionID: ").concat(t,", extension: ").concat(JSON.stringify(n))),r){var o=n.userInfo||{};q.safeCallbackCall(this.onRejectCallListener)(r,e,o),r.processOnReject(e)}else Me.traceWarning("Ignore 'onReject', there is no information about session ".concat(t))},e.prototype.onStopHandler=function(e,t,n){Me.trace("onStop. UserID: ".concat(e,", sessionID: ").concat(t,", extension: ").concat(JSON.stringify(n)));var r=this.sessions[t],o=n.userInfo||{};!r||r.state!==Ce.ACTIVE&&r.state!==Ce.NEW?(q.safeCallbackCall(this.onInvalidEventsListener)(r,e,o),Me.traceWarning("Ignore 'onStop', there is no information about session ".concat(t," by some reason"))):(r.processOnStop(e),q.safeCallbackCall(this.onStopCallListener)(r,e,o))},e.prototype.onIceCandidatesHandler=function(e,t,n){var r,o,i=this.sessions[t];Me.trace("onIceCandidates. UserID: ".concat(e,". SessionID: ").concat(t,". ICE candidates count: ").concat(null!==(o=null===(r=n.iceCandidates)||void 0===r?void 0:r.length)&&void 0!==o?o:0)),i?i.state===Ce.ACTIVE?i.processOnIceCandidates(e,n):Me.traceWarning("Ignore 'OnIceCandidates', the session ( ".concat(t," ) has invalid state")):Me.traceWarning("Ignore 'OnIceCandidates', there is no information about session ".concat(t))},e.prototype.onIceRestartHandler=function(e,t,n){var r=this.sessions[t];Me.trace("onIceRestart. UserID: ".concat(e,". SessionID: ").concat(t,". Extension: ").concat(JSON.stringify(n))),r?r.state===Ce.ACTIVE?r.processOnIceRestart(e,n):Me.traceWarning("Ignore 'OnIceRestart', the session (".concat(t,") has invalid state")):Me.traceWarning("Ignore 'OnIceRestart', there is no information about session ".concat(t))},e.prototype.onIceRestartAcceptHandler=function(e,t,n){var r=this.sessions[t];Me.trace("onIceRestartAccept. UserID: ".concat(e,". SessionID: ").concat(t,". Extension: ").concat(JSON.stringify(n))),r?r.state===Ce.ACTIVE?r.processOnIceRestartAccept(e,n):Me.traceWarning("Ignore 'onIceRestartAccept', the session (".concat(t,") has invalid state")):Me.traceWarning("Ignore 'onIceRestartAccept', there is no information about session ".concat(t))},e.prototype.getListenerByName=function(e){switch(e){case we.CALL:return"onCallListener";case we.ACCEPT:return"onAcceptCallListener";case we.REJECT:return"onRejectCallListener";case we.HUNG_UP:return"onStopCallListener";case we.INVALID:return"onInvalidEventsListener";case we.NOT_ANSWER:return"onUserNotAnswerListener";case we.REMOTE_STREAM:return"onRemoteStreamListener";case we.CONNECTION_STATE:return"onSessionConnectionStateChangedListener";case we.CLOSE:return"onSessionCloseListener";case we.STATS_REPORT:return"onCallStatsReport";case we.DEVICES:return"onDevicesChangeListener";default:return null}},e.prototype.addListener=function(e,t){var n=this.getListenerByName(e);return n&&(this[n]=t),this.removeListener.bind(this,e)},e.prototype.removeListener=function(e){var t=this.getListenerByName(e);t&&(this[t]=e===we.DEVICES?function(){}:void 0)},e.prototype.removeAllListeners=function(){var e=this;Object.keys(this).forEach((function(t){t.startsWith("on")&&t.endsWith("Listener")&&"function"==typeof e[t]&&(e[t]="onDevicesChangeListener"===t?function(){}:void 0)}))},e}(),ze=function(){function e(e){this.route=N.urls.whiteboards,this.server=N.whiteboard.server,this.proxy=e}return e.prototype.getURL=function(e){var t=e.id,n=e.title,r=e.username;return"".concat(this.server,"?whiteboardid=").concat(t,"&username=").concat(r,"&title=").concat(n)},e.prototype.get=function(e){return _(this,void 0,void 0,(function(){var t;return J(this,(function(n){return t={type:F.GET,url:q.getUrl(this.route),data:"string"==typeof e?{chat_dialog_id:e}:e},[2,this.proxy.ajax(t)]}))}))},e.prototype.create=function(e){return _(this,void 0,void 0,(function(){var t;return J(this,(function(n){return t={type:F.POST,url:q.getUrl(this.route),data:e},[2,this.proxy.ajax(t)]}))}))},e.prototype.update=function(e,t){return _(this,void 0,void 0,(function(){var n;return J(this,(function(r){return n={type:F.PUT,url:q.getUrl(this.route,e),data:t},[2,this.proxy.ajax(n)]}))}))},e.prototype.delete=function(e){return _(this,void 0,void 0,(function(){var t;return J(this,(function(n){return t={type:F.DELETE,url:q.getUrl(this.route,e),dataType:z.TEXT},[2,this.proxy.ajax(t)]}))}))},e}(),qe=new(function(){function e(){this.ConnectyCube=e}return e.prototype.init=function(e,t){void 0===t&&(t={}),t&&"object"==typeof t&&N.set(t),this.utils=q,this.service=new Ae,this.auth=new G(this.service),this.users=new je(this.service),this.storage=new Le(this.service),this.pushnotifications=new Re(this.service),this.data=new xe(this.service),this.addressbook=new W(this.service),this.chat=new ie(this.service),this.meeting=new De(this.service),this.whiteboard=new ze(this.service),L&&(this.videochat=new Fe(this.chat.xmppClient,this.service),this.videochatconference=new ke(this.service),this.chat.webrtcSignalingProcessor=this.videochat.signalingProcessor),e.token?(N.creds.appId=e.appId,this.service.setSession({token:e.token})):(N.creds.appId=e.appId,N.creds.authKey=e.authKey),this.setSession=this.auth.setSession,this.getSession=this.auth.getSession,this.createSession=this.auth.createSession,this.destroySession=this.auth.destroySession,this.login=this.auth.login,this.logout=this.auth.logout},e}());export{qe as default};
//# sourceMappingURL=index.js.map
