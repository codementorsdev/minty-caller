"use strict";var e,t,n=require("@xmpp/client-core"),r=require("@xmpp/reconnect"),i=require("@xmpp/websocket"),o=require("@xmpp/middleware"),s=require("@xmpp/stream-features"),a=require("@xmpp/iq/caller"),c=require("@xmpp/iq/callee"),u=require("@xmpp/resolve"),l=require("@xmpp/sasl"),d=require("@xmpp/resource-binding"),p=require("@xmpp/session-establishment"),f=require("@xmpp/sasl-anonymous"),h=require("@xmpp/sasl-plain"),m=require("eventemitter3"),g=function(e){return v?btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,(function(e,t){return String.fromCharCode(parseInt(t,16))}))):Buffer.from(e).toString("base64")},v="object"==typeof window&&"object"==typeof document,y="object"==typeof process&&"object"==typeof process.versions&&!!process.versions.node,b=!1,C=!1,S=y?require("node-fetch"):fetch,T=y?require("form-data"):FormData,w=v?window.navigator:void 0,I=v&&w?w.mediaDevices:void 0,E=v?window.MediaStream:void 0,k=v?window.MediaStreamTrack:void 0,x=v?window.RTCIceCandidate:void 0,D=v?window.RTCPeerConnection:void 0,A=v?window.RTCRtpReceiver:void 0,R=v?window.RTCRtpSender:void 0,O=v?window.RTCSessionDescription:void 0,P=!!v&&Boolean(I&&(null===window||void 0===window?void 0:window.RTCPeerConnection)),L=v?window.adapter:void 0,j=Object.freeze({__proto__:null,MediaStream:E,MediaStreamTrack:k,RTCIceCandidate:x,RTCPeerConnection:D,RTCRtpReceiver:A,RTCRtpSender:R,RTCSessionDescription:O,adapter:L,base64Encode:g,fetchImpl:S,formDataImpl:T,isBrowser:v,isExpo:C,isNodeJS:y,isReactNative:b,isWebRTCAvailable:P,mediaDevices:I,navigator:w});!function(e){e[e.BOSH=1]="BOSH",e[e.WS=2]="WS"}(e||(e={})),function(e){e.ALL="all",e.TRACE="trace",e.DEBUG="debug",e.VDEBUG="vdebug",e.LOG="log",e.WARN="warn",e.ERROR="error"}(t||(t={}));var M=function(){function e(){this.version="4.0.0",this.creds={appId:"",authKey:""},this.endpoints={api:"api.connectycube.com",chat:"chat.connectycube.com",muc:"muc.chat.connectycube.com"},this.chatProtocol={bosh:"https://chat.connectycube.com:5281",websocket:"wss://chat.connectycube.com:5291",active:2},this.chat={contactList:{subscriptionMode:{mutual:!0}},streamManagement:{enable:!1},ping:{enable:!1,timeInterval:60},reconnect:{enable:!0,timeInterval:5}},this.videochat={alwaysRelayCalls:!1,answerTimeInterval:60,dialingTimeInterval:5,disconnectTimeInterval:30,statsReportTimeInterval:null,iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:turn.connectycube.com"},{urls:"turn:turn.connectycube.com:5349?transport=udp",username:"connectycube",credential:"4c29501ca9207b7fb9c4b4b6b04faeb1"},{urls:"turn:turn.connectycube.com:5349?transport=tcp",username:"connectycube",credential:"4c29501ca9207b7fb9c4b4b6b04faeb1"}]},this.conference={server:"wss://janus.connectycube.com:8989",debug:t.ALL},this.whiteboard={server:"https://whiteboard.connectycube.com"},this.urls={session:"session",login:"login",users:"users",chat:"chat",blobs:"blobs",subscriptions:"subscriptions",events:"events",data:"data",addressbook:"address_book",meetings:"meetings",whiteboards:"whiteboards",calls:"calls",type:".json"},this.on={sessionExpired:void 0,xmppDataWrite:void 0,xmppDataRead:void 0},this.timeout=null,this.debug={mode:1}}return e.getInstance=function(){return e.instance||(e.instance=new e),e.instance},e.prototype.set=function(e){var t=this;e.endpoints&&e.endpoints.chat&&(this.endpoints.muc="muc.".concat(e.endpoints.chat),this.chatProtocol.bosh="https://".concat(e.endpoints.chat,":5281"),this.chatProtocol.websocket="wss://".concat(e.endpoints.chat,":5291")),Object.keys(e).forEach((function(n){if("set"!==n&&t.hasOwnProperty(n)){var r=e[n];"object"!=typeof r?t[n]=r:Object.keys(r).forEach((function(e){var i;(null===(i=t[n])||void 0===i?void 0:i.hasOwnProperty(e))&&(t[n][e]=r[e])}))}}))},e}().getInstance(),N=function(){return N=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},N.apply(this,arguments)};function U(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))}function _(e,t){var n,r,i,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return s.next=a(0),s.throw=a(1),s.return=a(2),"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(a){return function(c){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;s&&(s=0,a[0]&&(o=0)),o;)try{if(n=1,r&&(i=2&a[0]?r.return:a[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;switch(r=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,r=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){o=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){o.label=a[1];break}if(6===a[0]&&o.label<i[1]){o.label=i[1],i=a;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(a);break}i[2]&&o.ops.pop(),o.trys.pop();continue}a=t.call(e,o)}catch(e){a=[6,e],r=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}}function J(e,t,n){if(n||2===arguments.length)for(var r,i=0,o=t.length;i<o;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))}"function"==typeof SuppressedError&&SuppressedError;var V,q,F=function(){function e(){}return e.safeCallbackCall=function(e){return void 0===e&&(e=function(){}),function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];if("function"==typeof e)try{e.apply(void 0,t)}catch(t){console.error("Error in listener:",t,"Check the code:\n>>>\n".concat(e.toString(),"\n<<<"))}}},e.getUrl=function(e,t,n){var r=t?"/".concat(t):"",i=n?"/".concat(n):"";return"https://".concat(M.endpoints.api,"/").concat(e).concat(r).concat(i).concat(M.urls.type)},e.isArray=function(e){return Array.isArray(e)},e.isObject=function(e){return"[object Object]"===Object.prototype.toString.call(e)},e.getBsonObjectId=function(){var e={machine:Math.floor(16777216*Math.random()).toString(16),pid:Math.floor(32767*Math.random()).toString(16),increment:0},t=Math.floor(Date.now()/1e3).toString(16),n=(e.increment++).toString(16);return parseInt(n,16)>16777215&&(e.increment=0),t.padStart(8,"0")+e.machine.padStart(6,"0")+e.pid.padStart(4,"0")+n.padStart(6,"0")},e.DLog=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];if(e.loggers.length>0)e.loggers.forEach((function(e){return e(t)}));else{if("object"==typeof M.debug)(Array.isArray(M.debug.mode)?M.debug.mode:[M.debug.mode]).forEach((function(t){1===t&&e.loggers.push((function(e){console.log.apply(console,e)}))}));e.loggers.forEach((function(e){return e(t)}))}},e.mergeArrays=function(t,n){for(var r=e.cloneObject(t),i=function(e){var t=r.find((function(t){return t.user_id===e.user_id}));t?Object.assign(t,e):r.push(e)},o=0,s=n;o<s.length;o++){i(s[o])}return r},e.toBase64=function(e){return v?btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,(function(e,t){return String.fromCharCode(parseInt(t,16))}))):Buffer.from(e).toString("base64")},e.callTrafficUsageCallback=function(e,t){if("function"==typeof M.on[e]){var n=function(e){return new Blob([e]).size};M.on[e](function(e){void 0===e&&(e={});var t=e.body,r=e.headers,i=0;return t&&(i+=n("string"==typeof t?t:JSON.stringify(t))),r&&(i+=n(JSON.stringify(r))),i}(t))}},e.cloneObject=function(e,t){void 0===e&&(e={}),void 0===t&&(t=!1);try{var n=JSON.stringify(e),r=t?n.replace(/null/g,'""'):n;return JSON.parse(r)}catch(t){return e}},e.loggers=[],e.env={isReactNative:b,isBrowser:v,isNodeJS:y,isExpo:C},e}();!function(e){e.GET="GET",e.POST="POST",e.PUT="PUT",e.PATCH="PATCH",e.DELETE="DELETE",e.HEAD="HEAD"}(V||(V={})),function(e){e.JSON="json",e.TEXT="text"}(q||(q={}));var z=function(){function e(e){this.route=M.urls.addressbook,this.proxy=e}return e.prototype.uploadAddressBook=function(){return U(this,arguments,void 0,(function(e,t){var n;return void 0===e&&(e=[]),void 0===t&&(t={}),_(this,(function(r){if(!F.isArray(e))throw new Error("First parameter must be an Array.");return n={type:V.POST,url:F.getUrl(this.route),data:N({contacts:e},t)},[2,this.proxy.ajax(n)]}))}))},e.prototype.get=function(e){return U(this,void 0,void 0,(function(){var t;return _(this,(function(n){return t={type:V.GET,url:F.getUrl(this.route),data:e?{udid:e}:void 0},[2,this.proxy.ajax(t)]}))}))},e.prototype.getRegisteredUsers=function(){return U(this,arguments,void 0,(function(e){var t;return void 0===e&&(e=!1),_(this,(function(n){return t={type:V.GET,url:F.getUrl(this.route,"registered_users"),data:"boolean"==typeof e?{compact:e?1:0}:e},[2,this.proxy.ajax(t)]}))}))},e}(),W=function(){function e(e){var t=this;this.routes={session:M.urls.session,login:M.urls.login},this.setSession=function(e){t.proxy.setSession(e)},this.getSession=function(){return U(t,void 0,void 0,(function(){var e;return _(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),e={type:V.GET,url:F.getUrl(this.routes.session)},[4,this.proxy.ajax(e)];case 1:return[2,t.sent().session];case 2:throw t.sent();case 3:return[2]}}))}))},this.createSession=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return U(t,J([],e,!0),void 0,(function(e){var t,n;return void 0===e&&(e={}),_(this,(function(r){switch(r.label){case 0:if(""===M.creds.appId||""===M.creds.authKey)throw new Error('Cannot create a new session without "appId" and "authKey"');r.label=1;case 1:return r.trys.push([1,3,,4]),t={type:V.POST,url:F.getUrl(this.routes.session),data:this.generateCreateSessionParams(e)},[4,this.proxy.ajax(t)];case 2:return n=r.sent(),this.proxy.setSession(n.session),this.proxy.setCurrentUserId(n.session.user_id),[2,n.session];case 3:throw r.sent();case 4:return[2]}}))}))},this.destroySession=function(){return U(t,void 0,void 0,(function(){var e;return _(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),e={type:V.DELETE,url:F.getUrl(this.routes.session),dataType:q.TEXT},[4,this.proxy.ajax(e)];case 1:return t.sent(),this.proxy.setSession(null),this.proxy.setCurrentUserId(null),[3,3];case 2:throw t.sent();case 3:return[2]}}))}))},this.login=function(e){return U(t,void 0,void 0,(function(){var t,n;return _(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),t={type:V.POST,url:F.getUrl(this.routes.login),data:e},[4,this.proxy.ajax(t)];case 1:return n=r.sent().user,this.proxy.setCurrentUserId(n.id),[2,n];case 2:throw r.sent();case 3:return[2]}}))}))},this.logout=function(){return U(t,void 0,void 0,(function(){var e;return _(this,(function(t){return e={type:V.DELETE,url:F.getUrl(this.routes.login),dataType:q.TEXT},this.proxy.setCurrentUserId(null),[2,this.proxy.ajax(e)]}))}))},this.proxy=e}return e.prototype.generateCreateSessionParams=function(e){void 0===e&&(e={});var t={application_id:M.creds.appId,auth_key:M.creds.authKey};return"guest"in e?t.user=e:"login"in e&&"password"in e?t.user={login:e.login,password:e.password}:"email"in e&&"password"in e?t.user={email:e.email,password:e.password}:"provider"in e&&(t.provider=e.provider,"keys"in e&&(t.keys=e.keys),"firebase_phone"in e&&(t.firebase_phone=e.firebase_phone),"firebase_email"in e&&(t.firebase_email=e.firebase_email)),t},e}();function G(e){var t=e.resource,m=e.credentials,g=e.username,v=e.password,y=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(n[r[i]]=e[r[i]])}return n}(e,["resource","credentials","username","password"]),b=y.domain,C=y.service;!b&&C&&(y.domain=(C.split("://")[1]||C).split(":")[0].split("/")[0]);var S=new n.Client(y),T=r({entity:S}),w=i({entity:S}),I=o({entity:S}),E=s({middleware:I}),k=a({middleware:I,entity:S}),x=c({middleware:I,entity:S}),D=o({entity:S}),A=u({entity:S}),R=l({streamFeatures:E},m||{username:g,password:v}),O=d({iqCaller:k,streamFeatures:E},t),P=p({iqCaller:k,streamFeatures:E}),L=Object.entries({plain:h,anonymous:f}).map((function(e){var t,n=e[0],r=e[1];return(t={})[n]=r(R),t}));return Object.assign(S,{entity:S,reconnect:T,websocket:w,middleware:I,streamFeatures:E,iqCaller:k,iqCallee:x,starttls:D,resolve:A,sasl:R,resourceBinding:O,sessionEstablishment:P,mechanisms:L})}var B,H,X,K=n.xml,Q=function(){function e(e){this.route="".concat(M.urls.chat,"/Dialog"),this.subscribeToPublic=this.subscribe,this.unsubscribeFromPublic=this.unsubscribe,this.proxy=e}return e.prototype.list=function(){return U(this,arguments,void 0,(function(e){var t;return void 0===e&&(e={}),_(this,(function(n){return t={type:V.GET,url:F.getUrl(this.route),data:e},[2,this.proxy.ajax(t)]}))}))},e.prototype.create=function(){return U(this,arguments,void 0,(function(e){var t,n;return void 0===e&&(e={type:null}),_(this,(function(r){return t=F.cloneObject(e),F.isArray(null==t?void 0:t.occupants_ids)&&(t.occupants_ids=t.occupants_ids.join(", ")),F.isArray(null==t?void 0:t.admins_ids)&&(t.admins_ids=t.admins_ids.join(", ")),n={type:V.POST,url:F.getUrl(this.route),data:t},[2,this.proxy.ajax(n)]}))}))},e.prototype.update=function(e){return U(this,arguments,void 0,(function(e,t){var n;return void 0===t&&(t={}),_(this,(function(r){return n={type:V.PUT,url:F.getUrl(this.route,e),data:t},[2,this.proxy.ajax(n)]}))}))},e.prototype.delete=function(e){return U(this,arguments,void 0,(function(e,t){var n,r;return void 0===t&&(t={}),_(this,(function(i){return n="string"==typeof e?e.split(",").map((function(e){return e.trim()})):e,r={type:V.DELETE,url:F.getUrl(this.route,n.toString()),dataType:1===n.length?q.TEXT:q.JSON,data:t},[2,this.proxy.ajax(r)]}))}))},e.prototype.addAdmins=function(e,t){return U(this,void 0,void 0,(function(){var n;return _(this,(function(r){return n={type:V.PUT,url:F.getUrl(this.route,e,"admins"),data:{push_all:{admins_ids:t}}},[2,this.proxy.ajax(n)]}))}))},e.prototype.removeAdmins=function(e,t){return U(this,void 0,void 0,(function(){var n;return _(this,(function(r){return n={type:V.PUT,url:F.getUrl(this.route,e,"admins"),data:{pull_all:{admins_ids:t}}},[2,this.proxy.ajax(n)]}))}))},e.prototype.subscribe=function(e){return U(this,void 0,void 0,(function(){var t;return _(this,(function(n){return t={type:V.POST,url:F.getUrl(this.route,e,"subscribe")},[2,this.proxy.ajax(t)]}))}))},e.prototype.unsubscribe=function(e){return U(this,void 0,void 0,(function(){var t;return _(this,(function(n){return t={type:V.DELETE,url:F.getUrl(this.route,e,"subscribe"),dataType:q.TEXT},[2,this.proxy.ajax(t)]}))}))},e.prototype.updateNotificationsSettings=function(e,t){return U(this,void 0,void 0,(function(){var n;return _(this,(function(r){return n={type:V.PUT,url:F.getUrl(this.route,e,"notifications"),data:{enabled:t?1:0}},[2,this.proxy.ajax(n)]}))}))},e.prototype.getNotificationsSettings=function(e){return U(this,void 0,void 0,(function(){var t;return _(this,(function(n){return t={type:V.GET,url:F.getUrl(this.route,e,"notifications")},[2,this.proxy.ajax(t)]}))}))},e.prototype.getPublicOccupants=function(e){return U(this,arguments,void 0,(function(e,t){var n;return void 0===t&&(t={}),_(this,(function(r){return n={type:V.GET,url:F.getUrl(this.route,e,"occupants"),data:t},[2,this.proxy.ajax(n)]}))}))},e.prototype.clearHistory=function(e){return U(this,void 0,void 0,(function(){var t;return _(this,(function(n){return t={type:V.DELETE,url:F.getUrl(this.route,"clearHistory",e),dataType:q.TEXT},[2,this.proxy.ajax(t)]}))}))},e}(),Y=function(){function e(e){this.route="".concat(M.urls.chat,"/Message"),this.proxy=e}return e.prototype.list=function(){return U(this,arguments,void 0,(function(e){var t;return void 0===e&&(e={}),_(this,(function(n){return t={url:F.getUrl(this.route),data:e},[2,this.proxy.ajax(t)]}))}))},e.prototype.create=function(){return U(this,arguments,void 0,(function(e){var t;return void 0===e&&(e={}),_(this,(function(n){return t={url:F.getUrl(this.route),type:V.POST,data:e},[2,this.proxy.ajax(t)]}))}))},e.prototype.update=function(e){return U(this,arguments,void 0,(function(e,t){var n;return void 0===t&&(t={}),_(this,(function(r){return n={type:V.PUT,dataType:q.TEXT,url:F.getUrl(this.route,e),data:t},[2,this.proxy.ajax(n)]}))}))},e.prototype.delete=function(e,t){return U(this,void 0,void 0,(function(){var n;return _(this,(function(r){return n={url:F.getUrl(this.route,e),type:V.DELETE,dataType:q.TEXT,data:t},[2,this.proxy.ajax(n)]}))}))},e.prototype.createSystem=function(e){return U(this,void 0,void 0,(function(){var t;return _(this,(function(n){return t={type:V.POST,url:F.getUrl(this.route,"system"),data:e},[2,this.proxy.ajax(t)]}))}))},e.prototype.unreadCount=function(){return U(this,arguments,void 0,(function(e){var t,n;return void 0===e&&(e={}),_(this,(function(r){return(t=F.cloneObject(e))&&t.chat_dialog_ids&&F.isArray(t.chat_dialog_ids)&&(t.chat_dialog_ids=t.chat_dialog_ids.join(", ")),n={url:F.getUrl(this.route,"unread"),data:t},[2,this.proxy.ajax(n)]}))}))},e.prototype.listReactions=function(){return U(this,arguments,void 0,(function(e){var t;return void 0===e&&(e="_"),_(this,(function(n){return t={type:V.GET,dataType:q.JSON,url:F.getUrl(this.route,e,"reactions")},[2,this.proxy.ajax(t)]}))}))},e.prototype.addReaction=function(e,t){return U(this,void 0,void 0,(function(){return _(this,(function(n){return[2,this.updateReaction(e,t)]}))}))},e.prototype.removeReaction=function(e,t){return U(this,void 0,void 0,(function(){return _(this,(function(n){return[2,this.updateReaction(e,void 0,t)]}))}))},e.prototype.updateReaction=function(e,t,n){return U(this,void 0,void 0,(function(){return _(this,(function(r){return[2,this.putReaction(e,{add:t,remove:n})]}))}))},e.prototype.putReaction=function(e,t){return U(this,void 0,void 0,(function(){var n;return _(this,(function(r){return n={type:V.PUT,dataType:q.TEXT,url:F.getUrl(this.route,e,"reactions"),data:t},[2,this.proxy.ajax(n)]}))}))},e}(),$=function(){function e(){}return e.buildUserJid=function(e){void 0===e&&(e={});var t=e.userId,n=e.resource,r=e.jid,i=M.creds.appId,o=M.endpoints.chat;return t?"".concat(t,"-").concat(i,"@").concat(o).concat(n?"/".concat(n):""):r},e.buildUserJidLocalPart=function(e){return"".concat(e,"-").concat(M.creds.appId)},e.createMessageStanza=function(e){return K("message",e)},e.createIqStanza=function(e){return K("iq",e)},e.createPresenceStanza=function(e){return K("presence",e)},e.createNonza=function(e,t){return K(e,t)},e.getAttr=function(e,t){return(null==e?void 0:e.getAttr(t))||(null==e?void 0:e.attrs[t])||null},e.getElement=function(e,t){return null==e?void 0:e.getChild(t)},e.getName=function(e){return(null==e?void 0:e.getName())||null},e.getText=function(e){return(null==e?void 0:e.getText())||null},e.getChildElements=function(e){return(null==e?void 0:e.getChildElements())||[]},e.isErrorStanza=function(e){return!!(null==e?void 0:e.getChild("error"))},e.getAllElements=function(e,t){return(null==e?void 0:e.getChildren(t))||[]},e.getElementText=function(e,t){return(null==e?void 0:e.getChildText(t))||null},e.getElementTreePath=function(t,n){return n.reduce((function(t,n){return t?e.getElement(t,n):t}),t)},e.assignObjectToXml=function(t,n,r){return t=t.c(r),Object.keys(n).forEach((function(r){"object"==typeof n[r]?e.assignObjectToXml(t,n[r],r):t=t.c(r).t(n[r]).up()})),t=t.up()},e.assignExtraParamsToXml=function(t,n){var r=e.getElement(t,"extraParams");return Object.keys(n).forEach((function(t){"attachments"===t?n[t].forEach((function(e){r.c("attachment",e).up()})):"object"==typeof n[t]?e.assignObjectToXml(r,n[t],t):r.c(t).t(n[t]).up()})),t.up(),t},e.assignXmlToObject=function(t,n){var r,i=t.children,o=t.name,s=((r={})[o]={},r);return i.forEach((function(t){"string"==typeof t?s[o]=t:t.children.length>0?e.assignXmlToObject(t,s[o]):s[o][t.name]=e.getText(t)})),Object.assign(n,s)},e.parseExtraParams=function(t){if(!t)return null;var n={attachments:[]},r=null;return t.children.forEach((function(i){if("string"!=typeof i){if("attachment"===i.name){var o={};Object.keys(i.attrs).forEach((function(e){o[e]="size"===e?parseInt(i.attrs.size):i.attrs[e]})),n.attachments.push(o)}else"dialog_id"===i.name&&(r=e.getElementText(t,"dialog_id"),n.dialog_id=r);i.children.length&&e.assignXmlToObject(i,n)}})),0===n.attachments.length&&delete n.attachments,n.moduleIdentifier&&delete n.moduleIdentifier,{extension:n,dialogId:r}},e.buildErrorFromXMPPErrorStanza=function(t){var n=e.getElement(t,"error");return{code:parseInt(e.getAttr(n,"code")),info:e.getElementText(n,"text")}},e.getUniqueId=function(e){var t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}));return"string"==typeof e||"number"==typeof e?"".concat(t,":").concat(e):t},e.parseReactions=function(t){return e.getChildElements(t).map((function(t){return{add:"true"===e.getAttr(t,"add"),remove:"true"===e.getAttr(t,"remove"),reaction:e.getAttr(t,"type")}})).reduce((function(e,t){var n=t.add,r=t.remove,i=t.reaction;return n?e.add=i:r&&(e.remove=i),e}),{})},e}(),Z=function(){function e(){this.getUniqueId=$.getUniqueId,this.getBsonObjectId=F.getBsonObjectId,this.xmppJID=""}return Object.defineProperty(e.prototype,"userCurrentJid",{get:function(){return this.xmppJID},set:function(e){this.xmppJID=e||""},enumerable:!1,configurable:!0}),e.prototype.isNumeric=function(e){return/^-?\d+$/.test(e)||/^\d+\.\d+$/.test(e)},e.prototype.jidOrUserId=function(e){return"string"==typeof e?this.isNumeric(e)?this.getUserJid(e):e.includes("@")?e:this.getRoomJidFromDialogId(e):this.getUserJid(e)},e.prototype.typeChat=function(e){switch(typeof e){case"string":return this.isNumeric(e)?"chat":e.includes("@")?e.includes("muc")?"groupchat":"chat":"groupchat";case"number":return"chat";default:throw new Error("Unsupported chat type")}},e.prototype.getUserJid=function(e){return"".concat(e,"-").concat(M.creds.appId,"@").concat(M.endpoints.chat)},e.prototype.getUserNickWithMucDomain=function(e){return"".concat(M.endpoints.muc,"/").concat(e)},e.prototype.getUserIdFromJID=function(e){return void 0===e&&(e=this.userCurrentJid),(null==e?void 0:e.includes("@"))?parseInt(e.split("@")[0].split("-")[0]):null},e.prototype.getDialogIdFromJID=function(e){return(null==e?void 0:e.includes("@"))?e.split("@")[0].split("_")[1]:null},e.prototype.getRoomJidFromDialogId=function(e){return"".concat(M.creds.appId,"_").concat(e,"@").concat(M.endpoints.muc)},e.prototype.getRoomJid=function(e){return"".concat(e,"/").concat(this.getUserIdFromJID(this.userCurrentJid))},e.prototype.getIdFromResource=function(e){var t=e.split("/");return t.length>1?parseInt(t.slice(1).join("/")):null},e.prototype.getRoomJidFromRoomFullJid=function(e){var t=e.split("/");return t.length>1?t[0]:null},e.prototype.getUserIdFromRoomJid=function(e){var t=e.split("/");return t.length>1?parseInt(t[t.length-1]):null},e.prototype.getDialogJid=function(e){return e.indexOf("@")>0?e:this.getRoomJidFromDialogId(e)},e}(),ee=function(){function e(){var e=this;this.xmlns="urn:xmpp:sm:3",this.enabled=!1,this.clientProcessedStanzasCounter=0,this.clientSentStanzasCounter=0,this.lastAck=0,this.unackedQueue=[],this.incomingStanzaHandler=function(t){if("enabled"!==t.name)if($.getAttr(t,"xmlns")!==e.xmlns&&++e.clientProcessedStanzasCounter,"r"!==t.name){if("a"===t.name){var n=parseInt($.getAttr(t,"h")),r=n-e.lastAck;F.DLog("[Chat][SM][checkCounterOnIncomeStanza]",r,n,e.lastAck);for(var i=0;i<r&&e.unackedQueue.length>0;i++)e.sentMessageCallback(null,e.unackedQueue.shift().message);e.lastAck=n}}else{var o={xmlns:e.xmlns,h:e.clientProcessedStanzasCounter},s=$.createNonza("a",o);e.originalSend.call(e.xmppClient,s)}else e.enabled=!0}}return e.prototype.enable=function(e){this.enabled||(this.xmppClient=e,this.originalSend=this.xmppClient.send,this.xmppClient.send=this.send.bind(this)),this.clientProcessedStanzasCounter=0,this.clientSentStanzasCounter=0,this.lastAck=0,this.removeElementHandler(),this.addElementHandler();var t=$.createNonza("enable",{xmlns:this.xmlns});this.xmppClient.send(t)},e.prototype.removeElementHandler=function(){this.xmppClient.removeListener("element",this.incomingStanzaHandler)},e.prototype.addElementHandler=function(){this.xmppClient.on("element",this.incomingStanzaHandler)},e.prototype.send=function(e,t){var n=$.getAttr(e,"type"),r=$.getElementText(e,"body"),i=$.getAllElements(e,"attachment"),o="message"===e.name,s="chat"===n||"groupchat"===n,a=r||i.length;if(this.originalSend.call(this.xmppClient,e),this.enabled&&o&&s&&a){this.unackedQueue.push({message:t,expect:this.clientSentStanzasCounter});var c=$.createNonza("r",{xmlns:this.xmlns});this.originalSend.call(this.xmppClient,c)}++this.clientSentStanzasCounter},e}(),te=function(){function e(e){this.xmlns="jabber:iq:roster",this.contacts={},this.helpers=e.helpers,this.xmppClient=e.xmppClient,this.stanzasCallbacks=e.stanzasCallbacks}return e.prototype.get=function(){return U(this,void 0,void 0,(function(){var e=this;return _(this,(function(t){return[2,new Promise((function(t,n){var r={},i=$.getUniqueId("getRoster"),o=$.createIqStanza({type:"get",from:e.helpers.userCurrentJid,id:i});o.c("query",{xmlns:e.xmlns}),e.stanzasCallbacks[i]=function(n){for(var i=$.getAllElements(n,"query"),o=0,s=i.length;o<s;o++){var a=e.helpers.getUserIdFromJID($.getAttr(i[o],"jid")),c=$.getAttr(i[o],"ask"),u=$.getAttr(i[o],"subscription"),l=$.getAttr(i[o],"name"),d="".concat(a,"-").concat(M.creds.appId)!==l;r[a]={subscription:u,ask:c||null,name:d?l:null}}t(r)},e.xmppClient.send(o)}))]}))}))},e.prototype.add=function(e){return U(this,void 0,void 0,(function(){var t=this;return _(this,(function(n){return[2,new Promise((function(n,r){var i="object"==typeof e?e.userId:e,o="object"==typeof e?e.name:null,s=t.helpers.jidOrUserId(i),a=$.getUniqueId("addContactInRoster"),c=$.createIqStanza({type:"set",from:t.helpers.userCurrentJid,id:a});c.c("query",{xmlns:t.xmlns}).c("item",{jid:s,name:o}),t.contacts[i]={subscription:"none",ask:"subscribe",name:o},t.stanzasCallbacks[a]=function(){t.sendSubscriptionPresence({jid:s,type:"subscribe"}),n()},t.xmppClient.send(c)}))]}))}))},e.prototype.confirm=function(e){return U(this,void 0,void 0,(function(){var t,n;return _(this,(function(r){switch(r.label){case 0:return t="object"==typeof e?e.userId:e,n=this.helpers.jidOrUserId(t),this.sendSubscriptionPresence({jid:n,type:"subscribed"}),M.chat.contactList.subscriptionMode.mutual?[4,this.add(e)]:[3,2];case 1:r.sent(),r.label=2;case 2:return[2]}}))}))},e.prototype.reject=function(e){return U(this,void 0,void 0,(function(){var t=this;return _(this,(function(n){return[2,new Promise((function(n,r){var i=t.helpers.jidOrUserId(e);t.contacts[e]={subscription:"none",ask:null},t.sendSubscriptionPresence({jid:i,type:"unsubscribed"}),n()}))]}))}))},e.prototype.updateName=function(e){return U(this,void 0,void 0,(function(){var t=this;return _(this,(function(n){return[2,new Promise((function(n,r){var i=e.userId,o=e.name,s=void 0===o?null:o,a=t.helpers.jidOrUserId(i),c=$.getUniqueId("updateContactInRoster");if(F.isObject(t.contacts[i])){t.contacts[i].name=s;var u=$.createIqStanza({type:"set",from:t.helpers.userCurrentJid,id:c});u.c("query",{xmlns:t.xmlns}).c("item",{jid:a,name:s}),t.stanzasCallbacks[c]=function(e){"result"===$.getAttr(e,"type")?n():r(e)},t.xmppClient.send(u)}else r("No contact exists with provided user id")}))]}))}))},e.prototype.remove=function(e){return U(this,void 0,void 0,(function(){var t=this;return _(this,(function(n){return[2,new Promise((function(n,r){var i=t.helpers.jidOrUserId(e),o=$.getUniqueId("removeContactInRoster"),s=$.createIqStanza({type:"set",from:t.helpers.userCurrentJid,id:o});s.c("query",{xmlns:t.xmlns}).c("item",{jid:i,subscription:"remove"}),t.stanzasCallbacks[o]=function(){delete t.contacts[e],n()},t.xmppClient.send(s)}))]}))}))},e.prototype.sendSubscriptionPresence=function(e){var t={to:e.jid,type:e.type},n=$.createPresenceStanza(t);this.xmppClient.send(n)},e}(),ne=function(){function e(e){this.xmlns="jabber:iq:privacy",this.helpers=e.helpers,this.xmppClient=e.xmppClient,this.stanzasCallbacks=e.stanzasCallbacks}return e.prototype.create=function(e){return U(this,void 0,void 0,(function(){var t=this;return _(this,(function(n){return[2,new Promise((function(n,r){var i=e.items.reduce((function(e,t){var n=t.user_id,r=t.action,i=t.mutualBlock;return e[n]={action:r,mutualBlock:i},e}),{}),o=Object.keys(i),s={type:"set",from:t.helpers.userCurrentJid,id:$.getUniqueId("edit")},a=$.createIqStanza(s);a.c("query",{xmlns:t.xmlns}).c("list",{name:e.name});for(var c=0,u=0,l=o.length;c<l;c++,u+=2){var d=o[c],p=i[d],f=p.action,h=p.mutualBlock&&"deny"===f,m=t.helpers.jidOrUserId(parseInt(d,10)),g=t.helpers.getUserNickWithMucDomain(d);t.assignPrivacyItem(a,{order:u+1,value:m,action:f,isMutual:h}),t.assignPrivacyItem(a,{order:u+2,value:g,action:f,isMutual:h})}t.stanzasCallbacks[s.id]=function(e){$.isErrorStanza(e)?r($.buildErrorFromXMPPErrorStanza(e)):n()},t.xmppClient.send(a)}))]}))}))},e.prototype.getList=function(e){return U(this,void 0,void 0,(function(){var t=this;return _(this,(function(n){return[2,new Promise((function(n,r){var i=$.getUniqueId("getlist"),o=$.createIqStanza({type:"get",from:t.helpers.userCurrentJid,id:i});o.c("query",{xmlns:t.xmlns}).c("list",{name:e}),t.stanzasCallbacks[i]=function(e){var r=$.getElement(e,"query"),o=$.getElement(r,"list"),s={name:$.getAttr(o,"name"),items:$.getChildElements(o).map((function(e,n){if(n%2==0){var r=e.attrs,i=r.action,o=r.value;return{user_id:t.helpers.getUserIdFromJID(o),action:i}}return null})).filter((function(e){return null!==e}))};n(s),delete t.stanzasCallbacks[i]},t.xmppClient.send(o)}))]}))}))},e.prototype.update=function(e){return U(this,void 0,void 0,(function(){var t,n;return _(this,(function(r){switch(r.label){case 0:return r.trys.push([0,3,,4]),[4,this.getList(e.name)];case 1:return t=r.sent(),n={items:F.mergeArrays(t.items,e.items),name:e.name},[4,this.create(n)];case 2:return r.sent(),[3,4];case 3:throw r.sent();case 4:return[2]}}))}))},e.prototype.getNames=function(){return U(this,void 0,void 0,(function(){var e=this;return _(this,(function(t){return[2,new Promise((function(t,n){var r=$.getUniqueId("getNames"),i=$.createIqStanza({type:"get",from:e.helpers.userCurrentJid,id:r});i.c("query",{xmlns:e.xmlns}),e.stanzasCallbacks[r]=function(e){if($.isErrorStanza(e))n($.buildErrorFromXMPPErrorStanza(e));else{var r=$.getElement(e,"query"),i=$.getElement(r,"default"),o=$.getElement(r,"active"),s=$.getAttr(i,"name"),a=$.getAttr(o,"name"),c=$.getChildElements(r).map((function(e){return $.getAttr(e,"name")}));t({default:s,active:a,names:c})}},e.xmppClient.send(i)}))]}))}))},e.prototype.delete=function(e){return U(this,void 0,void 0,(function(){var t=this;return _(this,(function(n){return[2,new Promise((function(n,r){var i=$.getUniqueId("remove"),o=$.createIqStanza({type:"set",from:t.helpers.userCurrentJid,id:i});o.c("query",{xmlns:t.xmlns}).c("list",{name:e||""}),t.stanzasCallbacks[i]=function(e){$.isErrorStanza(e)?r($.buildErrorFromXMPPErrorStanza(e)):n()},t.xmppClient.send(o)}))]}))}))},e.prototype.setAsDefault=function(e){return U(this,void 0,void 0,(function(){var t=this;return _(this,(function(n){return[2,new Promise((function(n,r){var i=$.getUniqueId("default"),o=$.createIqStanza({type:"set",from:t.helpers.userCurrentJid,id:i});o.c("query",{xmlns:t.xmlns}).c("default",e&&e.length>0?{name:e}:{}),t.stanzasCallbacks[i]=function(e){$.isErrorStanza(e)?r($.buildErrorFromXMPPErrorStanza(e)):n()},t.xmppClient.send(o)}))]}))}))},e.prototype.assignPrivacyItem=function(e,t){var n=t.value,r=t.action,i=t.order,o=t.isMutual,s=$.getElement(e,"query"),a=$.getElement(s,"list").c("item",{type:"jid",value:n,action:r,order:i});o?(a.up(),i%2==0&&e.up().up()):a.c("message",{}).up().c("presence-in",{}).up().c("presence-out",{}).up().c("iq",{}).up().up()},e}(),re=function(){function e(e){this.xmlns="http://jabber.org/protocol/muc",this.helpers=e.helpers,this.xmppClient=e.xmppClient,this.stanzasCallbacks=e.stanzasCallbacks}return e.prototype.join=function(e){return U(this,void 0,void 0,(function(){var t=this;return _(this,(function(n){return[2,new Promise((function(n,r){var i=$.getUniqueId("join"),o=t.helpers.getDialogJid(e),s=$.createPresenceStanza({id:i,from:t.helpers.userCurrentJid,to:t.helpers.getRoomJid(o)});s.c("x",{xmlns:t.xmlns}).c("history",{maxstanzas:0}),t.stanzasCallbacks[i]=function(e){var s=$.getElement(e,"x"),a=$.getElement(s,"status"),c=$.getAttr(a,"code");if(a&&"110"==c)t.joinedRooms[o]=!0,n();else{var u=$.getAttr(s,"xmlns")===t.xmlns&&i.endsWith(":join"),l="error"===$.getAttr(e,"type");if(u&&l){var d=$.getElement(e,"error"),p={code:$.getAttr(d,"code"),message:$.getElementText(d,"text")||"Unknown issue"};r(p)}}},t.xmppClient.send(s)}))]}))}))},e.prototype.leave=function(e){return U(this,void 0,void 0,(function(){var t=this;return _(this,(function(n){return[2,new Promise((function(n,r){var i=t.helpers.getDialogJid(e),o=$.createPresenceStanza({type:"unavailable",from:t.helpers.userCurrentJid,to:t.helpers.getRoomJid(i)});delete t.joinedRooms[i],t.stanzasCallbacks["muc:leave"]=function(e){n()},t.xmppClient.send(o)}))]}))}))},e.prototype.listOnlineUsers=function(e){return U(this,void 0,void 0,(function(){var t=this;return _(this,(function(n){return[2,new Promise((function(n,r){var i=$.getUniqueId("muc_disco_items"),o=$.createIqStanza({type:"get",to:t.helpers.getDialogJid(e),from:t.helpers.userCurrentJid,id:i});o.c("query",{xmlns:"http://jabber.org/protocol/disco#items"}),t.stanzasCallbacks[i]=function(e){var r=$.getAttr(e,"id");if(t.stanzasCallbacks[r]){var i=$.getAttr(e,"query"),o=$.getChildElements(i).map((function(e){var n=$.getAttr(e,"jid");return t.helpers.getUserIdFromRoomJid(n)}));n(o)}},t.xmppClient.send(o)}))]}))}))},e}();!function(e){e.CHAT="chat",e.GROUPCHAT="groupchat"}(B||(B={})),function(e){e.STATUS="status",e.ERROR="error",e.DISCONNECTED="disconnected",e.RECONNECTED="reconnected",e.MESSAGE="message",e.SYSTEM_MESSAGE="system-message",e.ERROR_MESSAGE="error-message",e.TYPING_MESSAGE="typing-message",e.UPDATE_MESSAGE="update-message",e.DELETE_MESSAGE="delete-message",e.REACTIONS_MESSAGE="reactions-message",e.DELIVERED_MESSAGE="delivered-message",e.READ_MESSAGE="read-message",e.SENT_MESSAGE="sent-message",e.USER_LAST_ACTIVITY="user-last-activity",e.ROSTER_SUBSCRIBE="roster-subscribe",e.ROSTER_CONFIRM="roster-confirm",e.ROSTER_REJECT="roster-reject",e.ROSTER_LIST="roster-list",e.JOIN="join",e.LEAVE="leave",e.KICK="kick"}(H||(H={})),function(e){e.ALLOW="allow",e.DENY="deny"}(X||(X={}));var ie=function(){function e(e){var t=this;this.isConnected=!1,this.isConnecting=!1,this.isLogout=!1,this.isReconnect=!1,this.stanzasCallbacks={},this.xmppClientListeners=new Map,this.connectPromise=null,this.earlyIncomingMessagesQueue=[],this.pingTimer=null,this.proxy=e,this.dialog=new Q(e),this.message=new Y(e),this.helpers=new Z,this.xmppClient=G({service:M.chatProtocol.websocket,credentials:function(e,n){return e({username:t.xmppClient.options.username||"",password:t.xmppClient.options.password||""})}}),M.chat.reconnect.enable&&(this.xmppClient.reconnect.delay=1e3*M.chat.reconnect.timeInterval);var n={xmppClient:this.xmppClient,helpers:this.helpers,stanzasCallbacks:this.stanzasCallbacks};this.contactlist=new te(n),this.privacylist=new ne(n),this.muc=new re(n),this.isStreamManagementSupported&&(this.streamManagement=new ee)}return Object.defineProperty(e.prototype,"connectionStatus",{get:function(){return this.xmppClient.status},enumerable:!1,configurable:!0}),e.prototype.connect=function(e){return U(this,void 0,void 0,(function(){var t=this;return _(this,(function(n){return this.connectPromise=new Promise((function(n,r){return F.DLog("[Chat]","Connect with parameter:",e),t.isConnecting?(F.DLog("[Chat]","Warning! Already in CONNECTING state"),void n(!1)):t.isConnected?(F.DLog("[Chat]","Warning! Chat is already connected!"),void n(!1)):(t.isConnecting=!0,t.isLogout=!1,t.removeAllXMPPClientListeners(),t.addXMPPClientListener("connect",(function(){F.DLog("[Chat]",t.isReconnect?"RECONNECTING":"CONNECTING")})),t.addXMPPClientListener("online",(function(){F.DLog("[Chat]","ONLINE"),t.startPingTimer(),t.postConnectActions(),n(!0),t.connectPromise=null})),t.addXMPPClientListener("offline",(function(){F.DLog("[Chat]","OFFLINE")})),t.addXMPPClientListener("disconnect",(function(){F.DLog("[Chat]","DISCONNECTED"),F.safeCallbackCall(t.onDisconnectedListener)(),M.chat.reconnect.enable?(t.isConnected=!1,t.isConnecting=!1):t.disconnect(),t.stopPingTimer()})),t.addXMPPClientListener("status",(function(e,n){F.DLog("[Chat]","status - ".concat(e),"object"==typeof n?JSON.stringify(n):""),F.safeCallbackCall(t.onChatStatusListener)(e)})),t.addXMPPClientListener("stanza",(function(e){if(e.is("message")&&!t.isConnected)return t.earlyIncomingMessagesQueue.push(e),void F.DLog("[Chat]","on 'stanza': enqueue incoming stanza (isConnected=false)");e.is("presence")?t.onPresence(e):e.is("iq")?t.onIQ(e):e.is("message")&&("headline"===e.attrs.type?t.onSystemMessage(e):"error"===e.attrs.type?t.onMessageError(e):t.onMessage(e))})),t.addXMPPClientListener("error",(function(e){F.DLog("[Chat]","ERROR:",e,{isReconnect:t.isReconnect,connectPromise:!!t.connectPromise}),t.connectPromise?t.isReconnect||("SASLError"==e.name&&(e=e.condition),r(e),t.connectPromise=null):F.safeCallbackCall(t.onConnectionErrorListener)()})),t.addXMPPClientListener("output",(function(e){F.callTrafficUsageCallback("xmppDataWrite",{body:e}),F.DLog("[Chat]","SENT:",e)})),t.addXMPPClientListener("input",(function(e){F.callTrafficUsageCallback("xmppDataRead",{body:e}),F.DLog("[Chat]","RECV:",e)})),t.xmppClient.options.username=$.buildUserJidLocalPart(e.userId),t.xmppClient.options.password=e.password,void t.xmppClient.start().catch((function(e){console.error("[Chat] xmppClient.start error",e),t.connectPromise?(r(e),t.connectPromise=null):F.safeCallbackCall(t.onConnectionErrorListener)()})))})),[2,this.connectPromise]}))}))},e.prototype.getContacts=function(){return U(this,void 0,void 0,(function(){var e;return _(this,(function(t){switch(t.label){case 0:console.warn("[Deprecated][Chat][ContactList][[XMPP][Roster]]","ConnectyCube.chat.getContacts() and the ConnectyCube.chat.contactlist class will be removed in the next major release."),t.label=1;case 1:return t.trys.push([1,3,,4]),[4,this.contactlist.get()];case 2:return e=t.sent(),this.contactlist.contacts=e,[2,e];case 3:throw t.sent();case 4:return[2]}}))}))},e.prototype.ping=function(){return U(this,void 0,void 0,(function(){var e=this;return _(this,(function(t){return[2,new Promise((function(t,n){var r=$.getUniqueId("ping"),i=$.createIqStanza({id:r,type:"get",to:M.endpoints.chat});i.c("ping",{xmlns:"urn:xmpp:ping"}),e.stanzasCallbacks[r]=function(e){var r=$.getElement(e,"error");r?n($.buildErrorFromXMPPErrorStanza(r)):t()},e.xmppClient.send(i)}))]}))}))},e.prototype.pingWithTimeout=function(){return U(this,arguments,void 0,(function(e){return void 0===e&&(e=5e3),_(this,(function(t){return[2,Promise.race([this.ping(),new Promise((function(t,n){return setTimeout((function(){return n(new Error("Chat ping() timed out"))}),e)}))])]}))}))},e.prototype.startPingTimer=function(){var e=this;if(this.stopPingTimer(),M.chat.ping.enable){var t=M.chat.ping.timeInterval<30?30:M.chat.ping.timeInterval;this.pingTimer=setInterval((function(){e.ping()}),1e3*t)}},e.prototype.stopPingTimer=function(){this.pingTimer&&(clearInterval(this.pingTimer),this.pingTimer=null)},e.prototype.send=function(e,t){var n,r;void 0===t&&(t={});var i=null!==(n=t.id)&&void 0!==n?n:F.getBsonObjectId(),o=$.createMessageStanza({from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e),type:null!==(r=t.type)&&void 0!==r?r:this.helpers.typeChat(e),id:i});return t.id||(t.id=i),t.body&&o.c("body").t(t.body).up(),t.markable&&o.c("markable",{xmlns:"urn:xmpp:chat-markers:0"}).up(),t.extension&&(o.c("extraParams",{xmlns:"jabber:client"}),$.assignExtraParamsToXml(o,t.extension)),this.isStreamManagementSupported?this.xmppClient.send(o,t):this.xmppClient.send(o),i},e.prototype.sendSystemMessage=function(e,t){var n,r=null!==(n=t.id)&&void 0!==n?n:F.getBsonObjectId(),i=$.createMessageStanza({type:"headline",id:r,to:this.helpers.jidOrUserId(e)});return t.body&&i.c("body").t(t.body).up(),t.extension&&(i.c("extraParams",{xmlns:"jabber:client"}).c("moduleIdentifier").t("SystemNotifications").up(),$.assignExtraParamsToXml(i,t.extension)),this.xmppClient.send(i),r},e.prototype.sendIsTypingStatus=function(e){var t=$.createMessageStanza({from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e),type:this.helpers.typeChat(e)});t.c("composing",{xmlns:"http://jabber.org/protocol/chatstates"}),this.xmppClient.send(t)},e.prototype.sendIsStopTypingStatus=function(e){var t=$.createMessageStanza({from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e),type:this.helpers.typeChat(e)});t.c("paused",{xmlns:"http://jabber.org/protocol/chatstates"}),this.xmppClient.send(t)},e.prototype.sendDeliveredStatus=function(e){var t=$.createMessageStanza({type:"chat",from:this.helpers.userCurrentJid,id:F.getBsonObjectId(),to:this.helpers.jidOrUserId(e.userId)});t.c("received",{xmlns:"urn:xmpp:chat-markers:0",id:e.messageId}).up(),t.c("extraParams",{xmlns:"jabber:client"}).c("dialog_id").t(e.dialogId),this.xmppClient.send(t)},e.prototype.sendReadStatus=function(e){var t=$.createMessageStanza({type:"chat",from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e.userId),id:F.getBsonObjectId()});t.c("displayed",{xmlns:"urn:xmpp:chat-markers:0",id:e.messageId}).up(),t.c("extraParams",{xmlns:"jabber:client"}).c("dialog_id").t(e.dialogId),this.xmppClient.send(t)},e.prototype.editMessage=function(e){var t=$.createMessageStanza({from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e.to),type:this.helpers.typeChat(e.to),id:F.getBsonObjectId()});t.c("body").t(e.body).up(),t.c("replace",{xmlns:"urn:xmpp:message-correct:0",id:e.originMessageId,last:e.last?"true":"false"}).up(),t.c("extraParams",{xmlns:"jabber:client"}).c("dialog_id").t(e.dialogId),e.extension&&$.assignExtraParamsToXml(t,e.extension),this.xmppClient.send(t)},e.prototype.deleteMessage=function(e){var t=$.createMessageStanza({from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e.to),type:this.helpers.typeChat(e.to),id:F.getBsonObjectId()});t.c("remove",{xmlns:"urn:xmpp:message-delete:0",id:e.messageId}).up(),t.c("extraParams",{xmlns:"jabber:client"}).c("dialog_id").t(e.dialogId),this.xmppClient.send(t)},e.prototype.getLastUserActivity=function(e){var t=this;return new Promise((function(n,r){var i=$.getUniqueId("lastActivity"),o=$.createIqStanza({type:"get",from:t.helpers.userCurrentJid,to:t.helpers.jidOrUserId(e),id:i});o.c("query",{xmlns:"jabber:iq:last"}),t.stanzasCallbacks[i]=function(e){$.getElement(e,"error")?r($.buildErrorFromXMPPErrorStanza(e)):n(t.onLastActivityStanza(e))},t.xmppClient.send(o)}))},e.prototype.onLastActivityStanza=function(e){var t=$.getAttr(e,"from"),n=this.helpers.getUserIdFromJID(t),r=$.getElement(e,"query"),i=r?parseInt($.getAttr(r,"seconds")):0;return F.safeCallbackCall(this.onLastUserActivityListener)(n,i),{userId:n,seconds:i}},e.prototype.markActive=function(){var e=$.createIqStanza({id:this.helpers.getUniqueId("markActive"),type:"set"});e.c("mobile",{xmlns:"http://tigase.org/protocol/mobile#v2",enable:"false"}),this.xmppClient.send(e)},e.prototype.markInactive=function(){var e=$.createIqStanza({id:this.helpers.getUniqueId("markActive"),type:"set"});e.c("mobile",{xmlns:"http://tigase.org/protocol/mobile#v2",enable:"true"}),this.xmppClient.send(e)},e.prototype.disconnect=function(){return U(this,void 0,void 0,(function(){return _(this,(function(e){switch(e.label){case 0:if(F.DLog("[Chat]","disconnect"),this.isLogout)return F.DLog("[Chat]","Warning! Chat is already disconnected!"),[2,!0];this.muc.joinedRooms={},this.isConnected=!1,this.isConnecting=!1,this.isLogout=!0,this.isReconnect=!1,this.helpers.userCurrentJid="",this.isStreamManagementSupported&&this.streamManagement.removeElementHandler(),e.label=1;case 1:return e.trys.push([1,3,,4]),[4,this.xmppClient.stop()];case 2:return e.sent(),[2,!0];case 3:return e.sent(),[2,!1];case 4:return[2]}}))}))},e.prototype.search=function(e){return U(this,void 0,void 0,(function(){var t,n;return _(this,(function(r){return(t=Object.assign({},e)).start_date&&(t.start_date=new Date(t.start_date).toISOString()),t.end_date&&(t.end_date=new Date(t.end_date).toISOString()),F.isArray(t.chat_dialog_ids)&&(t.chat_dialog_ids=t.chat_dialog_ids.join(",")),n={type:V.GET,url:F.getUrl("".concat(M.urls.chat,"/search")),data:t},[2,this.proxy.ajax(n)]}))}))},e.prototype.onMessage=function(e){var t,n,r,i=$.getElementTreePath(e,["sent","forwarded","message"]),o=i||e,s=$.getAttr(o,"from"),a=$.getAttr(o,"type"),c=$.getElement(o,"invite"),u=(null===(t=this.xmppClient.jid)||void 0===t?void 0:t.getResource())||"",l="chat"===a;if(!(l&&s.includes(u)||c)){var d=$.getAttr(o,"id"),p=$.getElement(o,"markable"),f=$.getElement(o,"received"),h=$.getElement(o,"displayed"),m=$.getElement(o,"replace"),g=$.getElement(o,"reactions"),v=$.getElement(o,"remove"),y=Boolean($.getElement(o,"composing")),b=$.getElement(o,"paused"),C=$.getElement(o,"delay"),S=$.getElement(o,"extraParams"),T=$.getElementText(o,"body"),w=Boolean(i),I="groupchat"===a,E=l?$.getAttr(o,"to"):null,k=E?this.helpers.getUserIdFromJID(E):null,x=S?$.parseExtraParams(S):null,D=x?x.extension:null,A=I?this.helpers.getDialogIdFromJID(s):null!==(n=null==x?void 0:x.dialogId)&&void 0!==n?n:null,R=I?this.helpers.getIdFromResource(s):this.helpers.getUserIdFromJID(s),O=null===(r=this.xmppClient.jid)||void 0===r?void 0:r.toString(),P=O?this.helpers.getUserIdFromJID(O):0;if(y||b)(l||I||!C)&&F.safeCallbackCall(this.onMessageTypingListener)(y,R,A);else if(m)F.safeCallbackCall(this.onMessageUpdateListener)($.getAttr(m,"id"),"true"===$.getAttr(m,"last"),T,A,R,D);else if(g){if(w&&I)return;var L=$.getAttr(g,"message_id"),j=parseInt($.getAttr(g,"user_id")),M=$.parseReactions(g),N=M.add,U=M.remove;F.safeCallbackCall(this.onMessageReactionsListener)(L,j,A,N,U)}else if(v){var _=$.getAttr(v,"id");F.safeCallbackCall(this.onMessageDeleteListener)(_,A,R)}else if(f||h){if(f&&l){var J=$.getAttr(f,"id");F.safeCallbackCall(this.onDeliveredStatusListener)(J,A,R)}if(h&&l){J=$.getAttr(h,"id");F.safeCallbackCall(this.onReadStatusListener)(J,A,R)}}else{p&&A&&R&&R!==P&&this.sendDeliveredStatus({messageId:d,dialogId:A,userId:R});var V={id:d,dialog_id:A,recipient_id:k,is_forwarded:w,type:a,body:T,extension:D,delay:C};p&&(V.markable=1),(l||I)&&F.safeCallbackCall(this.onMessageListener)(R,V)}}},e.prototype.onPresence=function(e){var t,n,r,i,o,s=$.getAttr(e,"from"),a=$.getAttr(e,"id"),c=$.getAttr(e,"type"),u=null===(t=this.xmppClient.jid)||void 0===t?void 0:t.toString(),l=this.helpers.getUserIdFromJID(u),d=$.getElement(e,"x"),p=d?$.getAttr(d,"xmlns"):null,f=d?$.getElement(d,"xmlns"):null,h=f?$.getElementText(f,"code"):null;if(p&&p.startsWith("http://jabber.org/protocol/muc")){if("error"===c)return void(a.endsWith(":join")&&F.safeCallbackCall(this.stanzasCallbacks[a])(e));var m=this.helpers.getDialogIdFromJID(s),g=this.helpers.getUserIdFromRoomJid(s);if(f){if("301"===h){var v=$.getElement(e,"item"),y=v?$.getElement(v,"actor"):null,b=y?$.getAttr(y,"jid"):null,C=this.helpers.getUserIdFromJID(b),S=this.helpers.getRoomJidFromRoomFullJid(s);return F.safeCallbackCall(this.onKickOccupant)(m,C),void(S&&delete this.muc.joinedRooms[S])}if("unavailable"===c)return void(f&&"110"===h&&F.safeCallbackCall(this.stanzasCallbacks["muc:leave"])(null));if(a.endsWith(":join")&&f&&"110"===h)return void(null===(r=(n=this.stanzasCallbacks)[a])||void 0===r||r.call(n,e))}else if(g!=l){var T="unavailable"===c?"onLeaveOccupant":"onJoinOccupant";return void F.safeCallbackCall(this[T])(m,g)}}var w=null!==(i=this.helpers.getUserIdFromJID(s))&&void 0!==i?i:0,I=null!==(o=this.contactlist.contacts[w])&&void 0!==o?o:{ask:null,subscription:null};switch(c){case"subscribe":"to"===(null==I?void 0:I.subscription)?(I.ask=null,I.subscription="both",this.contactlist.sendSubscriptionPresence({jid:s,type:"subscribed"})):F.safeCallbackCall(this.onSubscribeListener)(w);break;case"subscribed":"from"===(null==I?void 0:I.subscription)?(I.ask=null,I.subscription="both"):(I.ask=null,I.subscription="to",F.safeCallbackCall(this.onConfirmSubscribeListener)(w));break;case"unsubscribed":I.ask=null,I.subscription="none",F.safeCallbackCall(this.onRejectSubscribeListener)(w);break;case"unsubscribe":I.ask=null,I.subscription="to";break;case"unavailable":"none"!==(null==I?void 0:I.subscription)&&F.safeCallbackCall(this.onContactListListener)(w,"unavailable"),w===l&&this.xmppClient.send($.createPresenceStanza());break;default:"none"!==(null==I?void 0:I.subscription)&&F.safeCallbackCall(this.onContactListListener)(w,"available")}},e.prototype.onIQ=function(e){var t=$.getAttr(e,"id");if(this.stanzasCallbacks[t])F.safeCallbackCall(this.stanzasCallbacks[t])(e),delete this.stanzasCallbacks[t];else{var n=$.getAttr(e,"from"),r=$.getElement(e,"query");n&&r&&this.onLastActivityStanza(e)}},e.prototype.onSystemMessage=function(e){var t=$.getElementTreePath(e,["sent","forwarded","message"])||e,n=$.getAttr(t,"from"),r=$.getAttr(t,"id"),i=$.getElement(t,"extraParams"),o=this.helpers.getUserIdFromJID(n),s=$.getElement(t,"delay"),a=i?$.getElementText(i,"moduleIdentifier"):null,c=$.getElementText(t,"body"),u=i?$.parseExtraParams(i):null,l=u?u.extension:null;switch(a){case"SystemNotifications":F.safeCallbackCall(this.onSystemMessageListener)({id:r,userId:o,body:c,extension:l});break;case"WebRTCVideoChat":this.webrtcSignalingProcessor&&!s&&F.safeCallbackCall(this.webrtcSignalingProcessor.onMessage)(o,i)}},e.prototype.onMessageError=function(e){var t=$.getAttr(e,"id"),n=$.buildErrorFromXMPPErrorStanza(e);F.safeCallbackCall(this.onMessageErrorListener)(t,n)},e.prototype.postConnectActions=function(){var e,t,n=this;F.DLog("[Chat]",this.isReconnect?"RECONNECTED":"CONNECTED");var r=$.createPresenceStanza();if(this.isStreamManagementSupported&&(this.streamManagement.enable(this.xmppClient),this.streamManagement.sentMessageCallback=function(e,t){F.safeCallbackCall(n.onSentMessageCallback)(t?null:e,t)}),this.helpers.userCurrentJid=null!==(t=null===(e=this.xmppClient.jid)||void 0===e?void 0:e.toString())&&void 0!==t?t:null,this.isConnected=!0,this.isConnecting=!1,this.enableCarbons(),this.xmppClient.send(r),this.isReconnect?F.safeCallbackCall(this.onReconnectListener)():this.isReconnect=!0,this.earlyIncomingMessagesQueue.length>0){F.DLog("[Chat]","Flush 'earlyIncomingMessagesQueue' (length=".concat(this.earlyIncomingMessagesQueue.length,")"));var i=this.xmppClientListeners.get("stanza");this.earlyIncomingMessagesQueue.forEach((function(e){null==i||i(e)})),this.earlyIncomingMessagesQueue=[]}},e.prototype.enableCarbons=function(){var e=$.createIqStanza({type:"set",from:this.helpers.userCurrentJid,id:$.getUniqueId("enableCarbons")});e.c("enable",{xmlns:"urn:xmpp:carbons:2"}),this.xmppClient.send(e)},e.prototype.setSubscriptionToUserLastActivity=function(e,t){var n=$.createIqStanza({id:this.helpers.getUniqueId("statusStreaming"),type:"set"});n.c("subscribe",{xmlns:"https://connectycube.com/protocol/status_streaming",user_jid:this.helpers.jidOrUserId(e),enable:t}),this.xmppClient.send(n)},e.prototype.subscribeToUserLastActivityStatus=function(e){this.setSubscriptionToUserLastActivity(e,!0)},e.prototype.unsubscribeFromUserLastActivityStatus=function(e){this.setSubscriptionToUserLastActivity(e,!1)},Object.defineProperty(e.prototype,"isStreamManagementSupported",{get:function(){var e,t=!!(null===(e=M.chat.streamManagement)||void 0===e?void 0:e.enable),n=2===M.chatProtocol.active;return t&&!n&&F.DLog("[Chat]","Stream Management is disabled for BOSH"),t&&n},enumerable:!1,configurable:!0}),e.prototype.addXMPPClientListener=function(e,t){this.xmppClient.on(e,t),this.xmppClientListeners.set(e,t)},e.prototype.removeXMPPClientListener=function(e){var t=this.xmppClientListeners.get(e);t&&this.xmppClient.removeListener(e,t),this.xmppClientListeners.delete(e)},e.prototype.removeAllXMPPClientListeners=function(){var e=this;this.xmppClientListeners.forEach((function(t,n){return e.removeXMPPClientListener(n)}))},e.prototype.getListenerByName=function(e){switch(e){case H.STATUS:return"onChatStatusListener";case H.ERROR:return"onConnectionErrorListener";case H.DISCONNECTED:return"onDisconnectedListener";case H.RECONNECTED:return"onReconnectListener";case H.MESSAGE:return"onMessageListener";case H.SYSTEM_MESSAGE:return"onSystemMessageListener";case H.ERROR_MESSAGE:return"onMessageErrorListener";case H.TYPING_MESSAGE:return"onMessageTypingListener";case H.UPDATE_MESSAGE:return"onMessageUpdateListener";case H.DELETE_MESSAGE:return"onMessageDeleteListener";case H.REACTIONS_MESSAGE:return"onMessageReactionsListener";case H.DELIVERED_MESSAGE:return"onDeliveredStatusListener";case H.READ_MESSAGE:return"onReadStatusListener";case H.SENT_MESSAGE:return"onSentMessageCallback";case H.USER_LAST_ACTIVITY:return"onLastUserActivityListener";case H.ROSTER_SUBSCRIBE:return"onSubscribeListener";case H.ROSTER_CONFIRM:return"onConfirmSubscribeListener";case H.ROSTER_REJECT:return"onRejectSubscribeListener";case H.ROSTER_LIST:return"onContactListListener";case H.JOIN:return"onJoinOccupant";case H.LEAVE:return"onLeaveOccupant";case H.KICK:return"onKickOccupant";default:return null}},e.prototype.addListener=function(e,t){var n=this.getListenerByName(e);return n&&(this[n]=t),this.removeListener.bind(this,e)},e.prototype.removeListener=function(e){var t=this.getListenerByName(e);t&&(this[t]=void 0)},e.prototype.removeAllListeners=function(){var e=this;Object.keys(this).forEach((function(t){t.startsWith("on")&&t.endsWith("Listener")&&"function"==typeof e[t]&&(e[t]=void 0)}))},e}();function oe(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function se(e){if(e.__esModule)return e;var t=e.default;if("function"==typeof t){var n=function e(){return this instanceof e?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};n.prototype=t.prototype}else n={};return Object.defineProperty(n,"__esModule",{value:!0}),Object.keys(e).forEach((function(t){var r=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(n,t,r.get?r:{enumerable:!0,get:function(){return e[t]}})})),n}var ae,ce,ue=se(j);var le,de,pe,fe,he,me=function(){if(ce)return ae;ce=1;const{adapter:e,navigator:t,MediaStream:n,MediaStreamTrack:r,RTCPeerConnection:i,RTCRtpReceiver:o,RTCRtpSender:s,isReactNative:a}=ue;u.sessions={},u.mobile=a,u.isExtensionEnabled=function(){if(u.mobile)return!1;if(t.mediaDevices&&t.mediaDevices.getDisplayMedia)return!0;if(window.navigator.userAgent.match("Chrome")){let e=parseInt(window.navigator.userAgent.match(/Chrome\/(.*) /)[1],10),t=33;return window.navigator.userAgent.match("Linux")&&(t=35),e>=26&&e<=t||u.extension.isInstalled()}return!0};const c={extensionId:"hapfgfdkleiggjjpfpenajgdnfckjpaj",isInstalled:function(){return!u.mobile&&null!==document.querySelector("#janus-extension-installed")},getScreen:function(e){if(u.mobile)e();else{let t=window.setTimeout((function(){let t=new Error("NavigatorUserMediaError");return t.name='The required Chrome extension is not installed: click <a href="#">here</a> to install it. (NOTE: this will need you to refresh the page)',e(t)}),1e3);this.cache[t]=e,window.postMessage({type:"janusGetScreen",id:t},"*")}},init:function(){let e={};this.cache=e,u.mobile||window.addEventListener("message",(function(t){if(t.origin==window.location.origin)if("janusGotScreen"==t.data.type&&e[t.data.id]){let n=e[t.data.id];if(delete e[t.data.id],""===t.data.sourceId){let e=new Error("NavigatorUserMediaError");e.name="You cancelled the request for permission, giving up...",n(e)}else n(null,t.data.sourceId)}else"janusGetScreenPending"==t.data.type&&window.clearTimeout(t.data.id)}))}};function u(e){if((e=e||{}).success="function"==typeof e.success?e.success:u.noop,e.error="function"==typeof e.error?e.error:u.noop,e.destroyed="function"==typeof e.destroyed?e.destroyed:u.noop,!u.initDone)return e.error("Library not initialized"),{};if(!u.isWebrtcSupported())return e.error("WebRTC not supported by this browser"),{};if(u.log("Library initialized: "+u.initDone),!e.server)return e.error("Invalid server url"),{};let a=!1,c=null,l={},d=null,p=null,f=0,h=e.server;u.isArray(h)?(u.log("Multiple servers provided ("+h.length+"), will use the first that works"),h=null,p=e.server,u.debug(p)):0===h.indexOf("ws")?(a=!0,u.log("Using WebSockets to contact Janus: "+h)):(a=!1,u.log("Using REST API to contact Janus: "+h));let m=e.iceServers||[{urls:"stun:stun.l.google.com:19302"}],g=e.iceTransportPolicy,v=e.bundlePolicy,y=!1;void 0!==e.withCredentials&&null!==e.withCredentials&&(y=!0===e.withCredentials);let b=10;void 0!==e.max_poll_events&&null!==e.max_poll_events&&(b=e.max_poll_events),b<1&&(b=1);let C=null;void 0!==e.token&&null!==e.token&&(C=e.token);let S=null;void 0!==e.apisecret&&null!==e.apisecret&&(S=e.apisecret),this.destroyOnUnload=!0,void 0!==e.destroyOnUnload&&null!==e.destroyOnUnload&&(this.destroyOnUnload=!0===e.destroyOnUnload);let T=25e3;void 0!==e.keepAlivePeriod&&null!==e.keepAlivePeriod&&(T=e.keepAlivePeriod),isNaN(T)&&(T=25e3);let w=6e4;function I(e){let t={high:9e5,medium:3e5,low:1e5};return null!=e&&(e.high&&(t.high=e.high),e.medium&&(t.medium=e.medium),e.low&&(t.low=e.low)),t}void 0!==e.longPollTimeout&&null!==e.longPollTimeout&&(w=e.longPollTimeout),isNaN(w)&&(w=6e4);let E=!1,k=null,x={},D=this,A=0,R={};function O(){if(null==k)return;if(u.debug("Long poll..."),!E)return void u.warn("Is the server down? (connected=false)");let t=h+"/"+k+"?rid="+(new Date).getTime();b&&(t=t+"&maxev="+b),C&&(t=t+"&token="+encodeURIComponent(C)),S&&(t=t+"&apisecret="+encodeURIComponent(S)),u.httpAPICall(t,{verb:"GET",withCredentials:y,success:P,timeout:w,error:function(t,n){if(u.error(t+":",n),A++,A>3)return E=!1,void e.error("Lost connection to the server (is it down?)");O()}})}function P(e,t){if(A=0,a||null==k||!0===t||O(),a||!u.isArray(e))if("keepalive"!==e.janus)if("server_info"!==e.janus)if("ack"!==e.janus)if("success"!==e.janus)if("trickle"===e.janus){const t=e.sender;if(!t)return void u.warn("Missing sender...");const n=x[t];if(!n)return void u.debug("This handle is not attached to this session");let r=e.candidate;u.debug("Got a trickled candidate on session "+k),u.debug(r);let i=n.webrtcStuff;i.pc&&i.remoteSdp?(u.debug("Adding remote candidate:",r),r&&!0!==r.completed?i.pc.addIceCandidate(r):i.pc.addIceCandidate(u.endOfCandidates)):(u.debug("We didn't do setRemoteDescription (trickle got here before the offer?), caching candidate"),i.candidates||(i.candidates=[]),i.candidates.push(r),u.debug(i.candidates))}else{if("webrtcup"===e.janus){u.debug("Got a webrtcup event on session "+k),u.debug(e);const t=e.sender;if(!t)return void u.warn("Missing sender...");const n=x[t];return n?void n.webrtcState(!0):void u.debug("This handle is not attached to this session")}if("hangup"===e.janus){u.debug("Got a hangup event on session "+k),u.debug(e);const t=e.sender;if(!t)return void u.warn("Missing sender...");const n=x[t];if(!n)return void u.debug("This handle is not attached to this session");n.webrtcState(!1,e.reason),n.hangup()}else if("detached"===e.janus){u.debug("Got a detached event on session "+k),u.debug(e);const t=e.sender;if(!t)return void u.warn("Missing sender...");const n=x[t];if(!n)return;n.ondetached(),n.detach()}else if("media"===e.janus){u.debug("Got a media event on session "+k),u.debug(e);const t=e.sender;if(!t)return void u.warn("Missing sender...");const n=x[t];if(!n)return void u.debug("This handle is not attached to this session");n.mediaState(e.type,e.receiving,e.mid)}else if("slowlink"===e.janus){u.debug("Got a slowlink event on session "+k),u.debug(e);const t=e.sender;if(!t)return void u.warn("Missing sender...");const n=x[t];if(!n)return void u.debug("This handle is not attached to this session");n.slowLink(e.uplink,e.lost,e.mid)}else{if("error"===e.janus){u.error("Ooops: "+e.error.code+" "+e.error.reason),u.debug(e);let t=e.transaction;if(t){let n=R[t];n&&n(e),delete R[t]}return}if("event"===e.janus){u.debug("Got a plugin event on session "+k),u.debug(e);const t=e.sender;if(!t)return void u.warn("Missing sender...");let n=e.plugindata;if(!n)return void u.warn("Missing plugindata...");u.debug("  -- Event is coming from "+t+" ("+n.plugin+")");let r=n.data;u.debug(r);const i=x[t];if(!i)return void u.warn("This handle is not attached to this session");let o=e.jsep;o&&(u.debug("Handling SDP as well..."),u.debug(o));let s=i.onmessage;s?(u.debug("Notifying application..."),s(r,o)):u.debug("No provided notification callback")}else{if("timeout"===e.janus)return u.error("Timeout on session "+k),u.debug(e),void(a&&c.close(3504,"Gateway timeout"));u.warn("Unknown message/event  '"+e.janus+"' on session "+k),u.debug(e)}}}else{u.debug("Got a success on session "+k),u.debug(e);const t=e.transaction;if(t){const n=R[t];n&&n(e),delete R[t]}}else{u.debug("Got an ack on session "+k),u.debug(e);const t=e.transaction;if(t){const n=R[t];n&&n(e),delete R[t]}}else{u.debug("Got info on the Janus instance"),u.debug(e);const t=e.transaction;if(t){const n=R[t];n&&n(e),delete R[t]}}else u.vdebug("Got a keepalive on session "+k);else for(let t=0;t<e.length;t++)P(e[t],!0)}function L(){if(!h||!a||!E)return;d=setTimeout(L,T);let e={janus:"keepalive",session_id:k,transaction:u.randomString(12)};C&&(e.token=C),S&&(e.apisecret=S),c.send(JSON.stringify(e))}function j(t){let n=u.randomString(12),r={janus:"create",transaction:n};if(t.reconnect&&(E=!1,r.janus="claim",r.session_id=k,c&&(c.onopen=null,c.onerror=null,c.onclose=null,d&&(clearTimeout(d),d=null))),C&&(r.token=C),S&&(r.apisecret=S),!h&&u.isArray(p)&&(h=p[f],0===h.indexOf("ws")?(a=!0,u.log("Server #"+(f+1)+": trying WebSockets to contact Janus ("+h+")")):(a=!1,u.log("Server #"+(f+1)+": trying REST API to contact Janus ("+h+")"))),a){c=u.newWebSocket(h,"janus-protocol"),l={error:function(){if(u.error("Error connecting to the Janus WebSockets server... "+h),u.isArray(p)&&!t.reconnect)return f++,f===p.length?void t.error("Error connecting to any of the provided Janus servers: Is the server down?"):(h=null,void setTimeout((function(){j(t)}),200));t.error("Error connecting to the Janus WebSockets server: Is the server down?")},open:function(){R[n]=function(e){if(u.debug(e),"success"!==e.janus)return u.error("Ooops: "+e.error.code+" "+e.error.reason),void t.error(e.error.reason);d=setTimeout(L,T),E=!0,k=e.session_id?e.session_id:e.data.id,t.reconnect?u.log("Claimed session: "+k):u.log("Created session: "+k),u.sessions[k]=D,t.success()},c.send(JSON.stringify(r))},message:function(e){P(JSON.parse(e.data))},close:function(){h&&E&&(E=!1,e.error("Lost connection to the server (is it down?)"))}};for(let e in l)c.addEventListener(e,l[e])}else u.httpAPICall(h,{verb:"POST",withCredentials:y,body:r,success:function(e){if(u.debug(e),"success"!==e.janus)return u.error("Ooops: "+e.error.code+" "+e.error.reason),void t.error(e.error.reason);E=!0,k=e.session_id?e.session_id:e.data.id,t.reconnect?u.log("Claimed session: "+k):u.log("Created session: "+k),u.sessions[k]=D,O(),t.success()},error:function(e,n){if(u.error(e+":",n),u.isArray(p)&&!t.reconnect)return f++,f===p.length?void t.error("Error connecting to any of the provided Janus servers: Is the server down?"):(h=null,void setTimeout((function(){j(t)}),200));""===n?t.error(e+": Is the server down?"):n&&n.error?t.error(e+": "+n.error.message):t.error(e+": "+n)}})}function M(e,t){if((t=t||{}).success="function"==typeof t.success?t.success:u.noop,t.error="function"==typeof t.error?t.error:u.noop,!E)return u.warn("Is the server down? (connected=false)"),void t.error("Is the server down? (connected=false)");let n=x[e];if(!n||!n.webrtcStuff)return u.warn("Invalid handle"),void t.error("Invalid handle");let r=t.message,i=t.jsep,o=u.randomString(12),s={janus:"message",body:r,transaction:o};if(n.token&&(s.token=n.token),S&&(s.apisecret=S),i&&(s.jsep={type:i.type,sdp:i.sdp},i.e2ee&&(s.jsep.e2ee=!0),"hml"!==i.rid_order&&"lmh"!==i.rid_order||(s.jsep.rid_order=i.rid_order),i.force_relay&&(s.jsep.force_relay=!0)),u.debug("Sending message to plugin (handle="+e+"):"),u.debug(s),a)return s.session_id=k,s.handle_id=e,R[o]=function(e){if(u.debug("Message sent!"),u.debug(e),"success"===e.janus){let n=e.plugindata;if(!n)return u.warn("Request succeeded, but missing plugindata..."),void t.success();u.log("Synchronous transaction successful ("+n.plugin+")");let r=n.data;return u.debug(r),void t.success(r)}"ack"===e.janus?t.success():e.error?(u.error("Ooops: "+e.error.code+" "+e.error.reason),t.error(e.error.code+" "+e.error.reason)):(u.error("Unknown error"),t.error("Unknown error"))},void c.send(JSON.stringify(s));u.httpAPICall(h+"/"+k+"/"+e,{verb:"POST",withCredentials:y,body:s,success:function(e){if(u.debug("Message sent!"),u.debug(e),"success"===e.janus){let n=e.plugindata;if(!n)return u.warn("Request succeeded, but missing plugindata..."),void t.success();u.log("Synchronous transaction successful ("+n.plugin+")");let r=n.data;return u.debug(r),void t.success(r)}"ack"===e.janus?t.success():e.error?(u.error("Ooops: "+e.error.code+" "+e.error.reason),t.error(e.error.code+" "+e.error.reason)):(u.error("Unknown error"),t.error("Unknown error"))},error:function(e,n){u.error(e+":",n),t.error(e+": "+n)}})}function N(e,t){if(!E)return void u.warn("Is the server down? (connected=false)");let n=x[e];if(!n||!n.webrtcStuff)return void u.warn("Invalid handle");let r={janus:"trickle",candidate:t,transaction:u.randomString(12)};if(n.token&&(r.token=n.token),S&&(r.apisecret=S),u.vdebug("Sending trickle candidate (handle="+e+"):"),u.vdebug(r),a)return r.session_id=k,r.handle_id=e,void c.send(JSON.stringify(r));u.httpAPICall(h+"/"+k+"/"+e,{verb:"POST",withCredentials:y,body:r,success:function(e){u.vdebug("Candidate sent!"),u.vdebug(e),"ack"===e.janus||u.error("Ooops: "+e.error.code+" "+e.error.reason)},error:function(e,t){u.error(e+":",t)}})}function U(e,t,n,r,i){let o=x[e];if(!o||!o.webrtcStuff)return void u.warn("Invalid handle");let s=o.webrtcStuff;if(!s.pc)return void u.warn("Invalid PeerConnection");let a=function(e){u.log("Received state change on data channel:",e);let t=e.target.label,n=e.target.protocol,r=s.dataChannel[t]?s.dataChannel[t].readyState:"null";if(u.log("State change on <"+t+"> data channel: "+r),"open"===r){if(s.dataChannel[t].pending&&s.dataChannel[t].pending.length>0){u.log("Sending pending messages on <"+t+">:",s.dataChannel[t].pending.length);for(let e of s.dataChannel[t].pending)u.log("Sending data on data channel <"+t+">"),u.debug(e),s.dataChannel[t].send(e);s.dataChannel[t].pending=[]}o.ondataopen(t,n)}};if(r)s.dataChannel[t]=r;else{let e=s.dataChannelOptions;n&&(e.protocol=n),s.dataChannel[t]=s.pc.createDataChannel(t,e)}s.dataChannel[t].onmessage=function(e){u.log("Received message on data channel:",e);let t=e.target.label;o.ondata(e.data,t)},s.dataChannel[t].onopen=a,s.dataChannel[t].onclose=a,s.dataChannel[t].onerror=function(e){u.error("Got error on data channel:",e)},s.dataChannel[t].pending=[],i&&s.dataChannel[t].pending.push(i)}function _(e,t){(t=t||{}).success="function"==typeof t.success?t.success:u.noop,t.error="function"==typeof t.error?t.error:u.noop;let n=x[e];if(!n||!n.webrtcStuff)return u.warn("Invalid handle"),void t.error("Invalid handle");let r=n.webrtcStuff,i=t.text||t.data;if(!i)return u.warn("Invalid data"),void t.error("Invalid data");let o=t.label?t.label:u.dataChanDefaultLabel;return r.dataChannel[o]?"open"!==r.dataChannel[o].readyState?(r.dataChannel[o].pending.push(i),void t.success()):(u.log("Sending data on data channel <"+o+">"),u.debug(i),r.dataChannel[o].send(i),void t.success()):(U(e,o,t.protocol,!1,i,t.protocol),void t.success())}function J(e,t){(t=t||{}).success="function"==typeof t.success?t.success:u.noop,t.error="function"==typeof t.error?t.error:u.noop;let n=x[e];if(!n||!n.webrtcStuff)return u.warn("Invalid handle"),void t.error("Invalid handle");let r=n.webrtcStuff;if(!r.dtmfSender){if(r.pc){let e=r.pc.getSenders().find((function(e){return e.track&&"audio"===e.track.kind}));if(!e)return u.warn("Invalid DTMF configuration (no audio track)"),void t.error("Invalid DTMF configuration (no audio track)");r.dtmfSender=e.dtmf,r.dtmfSender&&(u.log("Created DTMF Sender"),r.dtmfSender.ontonechange=function(e){u.debug("Sent DTMF tone: "+e.tone)})}if(!r.dtmfSender)return u.warn("Invalid DTMF configuration"),void t.error("Invalid DTMF configuration")}let i=t.dtmf;if(!i)return u.warn("Invalid DTMF parameters"),void t.error("Invalid DTMF parameters");let o=i.tones;if(!o)return u.warn("Invalid DTMF string"),void t.error("Invalid DTMF string");let s="number"==typeof i.duration?i.duration:500,a="number"==typeof i.gap?i.gap:50;u.debug("Sending DTMF string "+o+" (duration "+s+"ms, gap "+a+"ms)"),r.dtmfSender.insertDTMF(o,s,a),t.success()}function V(e,t){(t=t||{}).success="function"==typeof t.success?t.success:u.noop,t.error="function"==typeof t.error?t.error:u.noop;let n=!0===t.noRequest;u.log("Destroying handle "+e+" (only-locally="+n+")"),ee(e);let r=x[e];if(!r||r.detached)return delete x[e],void t.success();if(r.detached=!0,n)return delete x[e],void t.success();if(!E)return u.warn("Is the server down? (connected=false)"),void t.error("Is the server down? (connected=false)");let i={janus:"detach",transaction:u.randomString(12)};if(r.token&&(i.token=r.token),S&&(i.apisecret=S),a)return i.session_id=k,i.handle_id=e,c.send(JSON.stringify(i)),delete x[e],void t.success();u.httpAPICall(h+"/"+k+"/"+e,{verb:"POST",withCredentials:y,body:i,success:function(n){u.log("Destroyed handle:"),u.debug(n),"success"!==n.janus&&u.error("Ooops: "+n.error.code+" "+n.error.reason),delete x[e],t.success()},error:function(n,r){u.error(n+":",r),delete x[e],t.success()}})}function q(e,t){let n=x[e];if(!n||!n.webrtcStuff)throw u.warn("Invalid handle"),"Invalid handle";let r=n.webrtcStuff;if(r.pc)return;let o={iceServers:m,iceTransportPolicy:g,bundlePolicy:v,sdpSemantics:"unified-plan"},a=!1;if(t.tracks)for(let e of t.tracks)if(e.transforms&&(e.transforms.sender||e.transforms.receiver)){a=!0;break}s&&(s.prototype.createEncodedStreams||s.prototype.createEncodedAudioStreams&&s.prototype.createEncodedVideoStreams)&&a&&(r.insertableStreams=!0,o.forceEncodedAudioInsertableStreams=!0,o.forceEncodedVideoInsertableStreams=!0,o.encodedInsertableStreams=!0),u.log("Creating PeerConnection"),r.pc=new i(o),u.debug(r.pc),r.pc.getStats&&(r.volume={},r.bitrate.value="0 kbits/sec"),u.log("Preparing local SDP and gathering candidates (trickle="+r.trickle+")"),r.pc.oniceconnectionstatechange=function(){r.pc&&n.iceState(r.pc.iceConnectionState)},r.pc.onicecandidate=function(n){if(!n.candidate||n.candidate.candidate&&n.candidate.candidate.indexOf("endOfCandidates")>0)u.log("End of candidates."),r.iceDone=!0,!0===r.trickle?N(e,{completed:!0}):function(e,t){t=t||{},t.success="function"==typeof t.success?t.success:u.noop,t.error="function"==typeof t.error?t.error:u.noop;let n=x[e];if(!n||!n.webrtcStuff)return void u.warn("Invalid handle, not sending anything");let r=n.webrtcStuff;if(u.log("Sending offer/answer SDP..."),!r.mySdp)return void u.warn("Local SDP instance is invalid, not sending anything...");r.mySdp={type:r.pc.localDescription.type,sdp:r.pc.localDescription.sdp},!1===r.trickle&&(r.mySdp.trickle=!1);u.debug(t),r.sdpSent=!0,t.success(r.mySdp)}(e,t);else{let t={candidate:n.candidate.candidate,sdpMid:n.candidate.sdpMid,sdpMLineIndex:n.candidate.sdpMLineIndex};!0===r.trickle&&N(e,t)}},r.pc.ontrack=function(e){if(u.log("Handling Remote Track",e),!e.streams)return;if(!e.track)return;let t=e.transceiver?e.transceiver.mid||e.transceiver._mid:e.track.id;try{n.onremotetrack(e.track,t,!0,{reason:"created"})}catch(e){u.error("Error calling onremotetrack",e)}if(e.track.onended)return;let i=null;u.log("Adding onended callback to track:",e.track),e.track.onended=function(e){u.log("Remote track removed:",e),clearTimeout(i);let t=r.pc?r.pc.getTransceivers():null,o=t?t.find((t=>{const n=t.receiver||t._receiver;return(n.track||n._track)===e.target})):null,s=o?o.mid||o._mid:e.target.id;try{n.onremotetrack(e.target,s,!1,{reason:"ended"})}catch(e){u.error("Error calling onremotetrack on removal",e)}},e.track.onmute=function(e){if(u.log("Remote track muted:",e),!i){const t=e.target;i=setTimeout((function(){u.log("Removing remote track");let e=r.pc?r.pc.getTransceivers():null,o=e?e.find((e=>{const n=e.receiver||e._receiver;return(n.track||n._track)===t})):null,s=o?o.mid||o._mid:t.id;try{n.onremotetrack(t,s,!1,{reason:"mute"})}catch(e){u.error("Error calling onremotetrack on mute",e)}i=null}),2520)}},e.track.onunmute=function(e){if(u.log("Remote track flowing again:",e),null!=i)clearTimeout(i),i=null;else try{let t=r.pc?r.pc.getTransceivers():null,i=t?t.find((t=>{const n=t.receiver||t._receiver;return(n.track||n._track)===e.target})):null,o=i?i.mid||i._mid:e.target.id;n.onremotetrack(e.target,o,!0,{reason:"unmute"})}catch(e){u.error("Error calling onremotetrack on unmute",e)}}}}async function F(e,t,n){(n=n||{}).success="function"==typeof n.success?n.success:u.noop,n.error="function"==typeof n.error?n.error:Z;let r=n.jsep;if(t&&r)return u.error("Provided a JSEP to a createOffer"),void n.error("Provided a JSEP to a createOffer");if(!(t||r&&r.type&&r.sdp))return u.error("A valid JSEP is required for createAnswer"),void n.error("A valid JSEP is required for createAnswer");if(n.media&&!n.tracks){if(n.tracks=u.mediaToTracks(n.media),!0===n.simulcast||!0===n.simulcast2||n.svc)for(let e of n.tracks)if("video"===e.type){!0===n.simulcast||!0===n.simulcast2?e.simulcast=!0:n.svc&&(e.svc=n.svc);break}u.warn("Deprecated media object passed, use tracks instead. Automatically translated to:",n.tracks)}if(n.tracks&&!Array.isArray(n.tracks))return u.error("Tracks must be an array"),void n.error("Tracks must be an array");let i=x[e];if(!i||!i.webrtcStuff)return u.warn("Invalid handle"),void n.error("Invalid handle");let o=i.webrtcStuff;var s;o.trickle=(s=n.trickle,u.debug("isTrickleEnabled:",s),!1!==s);try{if(q(e,n),t&&await G(e,n),r){if(await o.pc.setRemoteDescription(r),u.log("Remote description accepted!"),o.remoteSdp=r.sdp,o.candidates&&o.candidates.length>0){for(let e=0;e<o.candidates.length;e++){let t=o.candidates[e];u.debug("Adding remote candidate:",t),t&&!0!==t.completed?o.pc.addIceCandidate(t):o.pc.addIceCandidate(u.endOfCandidates)}o.candidates=[]}await G(e,n);let t=await async function(e,t){t=t||{},t.customizeSdp="function"==typeof t.customizeSdp?t.customizeSdp:u.noop;let n=x[e];if(!n||!n.webrtcStuff)throw u.warn("Invalid handle"),"Invalid handle";let r=n.webrtcStuff;u.log("Creating answer (iceDone="+r.iceDone+")");let i=await r.pc.createAnswer();u.debug(i);let o={type:"answer",sdp:i.sdp};if(t.customizeSdp(o),i.sdp=o.sdp,u.log("Setting local description"),r.mySdp={type:"answer",sdp:i.sdp},await r.pc.setLocalDescription(i),!r.iceDone&&!r.trickle)return u.log("Waiting for all candidates..."),null;r.insertableStreams&&(i.e2ee=!0);return i}(e,n);n.success(t)}else{let t=await async function(e,t){t=t||{},t.customizeSdp="function"==typeof t.customizeSdp?t.customizeSdp:u.noop;let n=x[e];if(!n||!n.webrtcStuff)throw u.warn("Invalid handle"),"Invalid handle";let r=n.webrtcStuff;u.log("Creating offer (iceDone="+r.iceDone+")");let i={},o=!0===t.iceRestart;o&&(i.iceRestart=!0);u.debug(i);let s=await r.pc.createOffer(i);u.debug(s);let a={type:"offer",sdp:s.sdp};if(t.customizeSdp(a),s.sdp=a.sdp,u.log("Setting local description"),r.mySdp={type:"offer",sdp:s.sdp},await r.pc.setLocalDescription(s),r.mediaConstraints=i,!r.iceDone&&!r.trickle)return u.log("Waiting for all candidates..."),null;r.insertableStreams&&(s.e2ee=!0);return s}(e,n);n.success(t)}}catch(e){u.error(e),n.error(e)}}function z(e,t){(t=t||{}).success="function"==typeof t.success?t.success:u.noop,t.error="function"==typeof t.error?t.error:Z,t.customizeSdp="function"==typeof t.customizeSdp?t.customizeSdp:u.noop;let n=t.jsep,r=x[e];if(!r||!r.webrtcStuff)return u.warn("Invalid handle"),void t.error("Invalid handle");let i=r.webrtcStuff;if(n){if(!i.pc)return u.warn("Wait, no PeerConnection?? if this is an answer, use createAnswer and not handleRemoteJsep"),void t.error("No PeerConnection: if this is an answer, use createAnswer and not handleRemoteJsep");t.customizeSdp(n),i.pc.setRemoteDescription(n).then((function(){if(u.log("Remote description accepted!"),i.remoteSdp=n.sdp,i.candidates&&i.candidates.length>0){for(let e=0;e<i.candidates.length;e++){let t=i.candidates[e];u.debug("Adding remote candidate:",t),t&&!0!==t.completed?i.pc.addIceCandidate(t):i.pc.addIceCandidate(u.endOfCandidates)}i.candidates=[]}t.success()}),t.error)}else t.error("Invalid JSEP")}async function W(e,t){if((t=t||{}).success="function"==typeof t.success?t.success:u.noop,t.error="function"==typeof t.error?t.error:u.noop,t.tracks&&!Array.isArray(t.tracks))return u.error("Tracks must be an array"),void t.error("Tracks must be an array");for(let e of t.tracks)(e.add||!e.replace&&!e.remove)&&(e.replace=!0);try{await G(e,t),t.success()}catch(e){u.error(e),t.error(e)}}async function G(e,i){let a=x[e];if(!a||!a.webrtcStuff)throw u.warn("Invalid handle, not sending anything"),"Invalid handle";let c=a.webrtcStuff;if(!c.pc)throw u.warn("Invalid PeerConnection"),"Invalid PeerConnection";let l=i.tracks;if(!l||!Array.isArray(l)||0===l.length)return;let d=!1,p={};for(let e of l){if(delete e.gumGroup,!e.type||!["audio","video"].includes(e.type))continue;if(!e.capture||e.capture instanceof r)continue;let t=e.group?e.group:"default";p[t]||(p[t]={}),p[t][e.type]||(e.gumGroup=t,p[t][e.type]=e)}let f=Object.keys(p);for(let e of f){let t=p[e];t.audio&&t.video||(t.audio&&delete t.audio.gumGroup,t.video&&delete t.video.gumGroup,delete p[e])}let h=!!i.jsep;for(let i of l){if(!i.type){u.warn("Missing track type:",i);continue}if("data"===i.type){if(c.pc.ondatachannel){u.warn("Data channel exists already, not creating another one");continue}u.log("Creating default data channel"),U(e,u.dataChanDefaultLabel,null,!1),c.pc.ondatachannel=function(t){u.log("Data channel created by Janus:",t),U(e,t.channel.label,t.channel.protocol,t.channel)};continue}if(void 0===i.add&&null===i.add&&void 0===i.remove&&null===i.remove&&void 0===i.replace&&null===i.replace&&(i.add=!0),i.add&&i.remove||i.add&&i.remove&&i.replace){u.warn("Conflicting actions for track, ignoring:",i);continue}i.add&&i.replace?(u.warn("Both add and replace provided, falling back to replace:",i),delete i.add):i.remove&&i.replace&&(u.warn("Both remove and replace provided, falling back to remove:",i),delete i.replace);let l=i.type;"screen"===i.type&&(l="video");let f=null,m=null;if(f=i.mid?c.pc.getTransceivers().find((e=>e.mid===i.mid&&e.receiver.track.kind===l)):c.pc.getTransceivers().find((e=>e.receiver.track.kind===l)),i.replace||i.remove){if(!f){u.warn("Couldn't find a transceiver for track:",i);continue}if(!f.sender){u.warn("No sender in the transceiver for track:",i);continue}m=f.sender}if(h&&!f&&(f=c.pc.getTransceivers().find((e=>e.receiver.track.kind===l)),!f)){u.warn("Couldn't find a transceiver for track:",i);continue}let g=null,v=null;if(i.remove)u.log("Removing track from PeerConnection",i),v=m.track?m.track.id:null,await m.replaceTrack(null);else if(i.capture){if(i.gumGroup&&p[i.gumGroup]&&p[i.gumGroup].stream){let e=p[i.gumGroup].stream;g="audio"===i.type?e.getAudioTracks()[0]:e.getVideoTracks()[0],delete p[i.gumGroup].stream,delete p[i.gumGroup],delete i.gumGroup}else if(i.capture instanceof r)g=i.capture;else{d||(d=!0,a.consentDialog(!0));let e=u.trackConstraints(i),n=null;if("audio"===i.type||"video"===i.type){if(i.gumGroup){let t="audio"===i.type?"video":"audio";if(p[i.gumGroup]&&p[i.gumGroup][t]){let n=p[i.gumGroup][t],r=u.trackConstraints(n);e[t]=r[t]}}n=await t.mediaDevices.getUserMedia(e),i.gumGroup&&e.audio&&e.video&&(p[i.gumGroup].stream=n,delete i.gumGroup)}else n=await t.mediaDevices.getDisplayMedia(e);g="audio"===i.type?n.getAudioTracks()[0]:n.getVideoTracks()[0]}if(i.replace){await m.replaceTrack(g);let e="sendrecv";!1!==i.recv&&"inactive"!==f.direction&&"sendonly"!==f.direction||(e="sendonly"),f.setDirection?f.setDirection(e):f.direction=e}else{if(c.myStream||(c.myStream=new n),"audio"===l||!i.simulcast&&!i.svc)m=c.pc.addTrack(g,c.myStream),f=c.pc.getTransceivers().find((e=>e.sender===m));else if(i.simulcast){if("firefox"!==u.webRTCAdapter.browserDetails.browser){u.log("Enabling rid-based simulcasting:",g);let e=I(i.simulcastMaxBitrates);f=c.pc.addTransceiver(g,{direction:"sendrecv",streams:[c.myStream],sendEncodings:i.sendEncodings||[{rid:"h",active:!0,maxBitrate:e.high},{rid:"m",active:!0,maxBitrate:e.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:e.low,scaleResolutionDownBy:4}]})}else if(u.log("Enabling Simulcasting for Firefox (RID)"),f=c.pc.addTransceiver(g,{direction:"sendrecv",streams:[c.myStream]}),m=f?f.sender:null,m){let e=m.getParameters();e||(e={});let t=I(i.simulcastMaxBitrates);e.encodings=i.sendEncodings||[{rid:"h",active:!0,maxBitrate:t.high},{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:t.low,scaleResolutionDownBy:4}],m.setParameters(e)}}else u.log("Enabling SVC ("+i.svc+"):",g),f=c.pc.addTransceiver(g,{direction:"sendrecv",streams:[c.myStream],sendEncodings:[{scalabilityMode:i.svc}]});if(m||(m=f?f.sender:null),i.codec)if("firefox"===u.webRTCAdapter.browserDetails.browser)u.warn("setCodecPreferences not supported in Firefox, ignoring codec for track:",i);else if("string"!=typeof i.codec)u.warn("Invalid codec value, ignoring for track:",i);else{let e=l+"/"+i.codec.toLowerCase(),t=o.getCapabilities(l).codecs.filter((function(t){return t.mimeType.toLowerCase()===e}));if(t&&0!==t.length){if(f)try{f.setCodecPreferences(t)}catch(e){u.warn("Failed enforcing codec for this "+l+" track:",e)}}else u.warn("Codec not supported in this browser for this track, ignoring:",i)}if(i.bitrate)if(i.simulcast||i.svc)u.warn("Ignoring bitrate for simulcast/SVC track, use sendEncodings for that");else if(isNaN(i.bitrate)||i.bitrate<0)u.warn("Ignoring invalid bitrate for track:",i);else if(m){let e=m.getParameters();e&&e.encodings&&0!==e.encodings.length?(e.encodings[0].maxBitrate=i.bitrate,await m.setParameters(e)):u.warn("No encodings in the sender parameters, ignoring bitrate for track:",i)}if("video"===l&&i.framerate)if(i.simulcast||i.svc)u.warn("Ignoring framerate for simulcast/SVC track, use sendEncodings for that");else if(isNaN(i.framerate)||i.framerate<0)u.warn("Ignoring invalid framerate for track:",i);else if(m){let e=m.getParameters();e&&e.encodings&&0!==e.encodings.length?(e.encodings[0].maxFramerate=i.framerate,await m.setParameters(e)):u.warn("No encodings in the sender parameters, ignoring framerate for track:",i)}if(i.transforms){if(m&&i.transforms.sender){let e=null;s.prototype.createEncodedStreams?e=m.createEncodedStreams():(s.prototype.createAudioEncodedStreams||s.prototype.createEncodedVideoStreams)&&("audio"===l?e=m.createEncodedAudioStreams():"video"===l&&(e=m.createEncodedVideoStreams())),e&&(u.log("Insertable Streams sender transform:",e),e.readableStream&&e.writableStream?e.readableStream.pipeThrough(i.transforms.sender).pipeTo(e.writableStream):e.readable&&e.writable&&e.readable.pipeThrough(i.transforms.sender).pipeTo(e.writable))}if(f&&f.receiver&&i.transforms.receiver){let e=null;o.prototype.createEncodedStreams?e=f.receiver.createEncodedStreams():(o.prototype.createAudioEncodedStreams||o.prototype.createEncodedVideoStreams)&&("audio"===l?e=f.receiver.createEncodedAudioStreams():"video"===l&&(e=f.receiver.createEncodedVideoStreams())),e&&(u.log("Insertable Streams receiver transform:",e),e.readableStream&&e.writableStream?e.readableStream.pipeThrough(i.transforms.receiver).pipeTo(e.writableStream):e.readable&&e.writable&&e.readable.pipeThrough(i.transforms.receiver).pipeTo(e.writable))}}}g&&!0===i.dontStop&&(g.dontStop=!0)}else if(i.recv&&!f&&(f=c.pc.addTransceiver(l),f)){if(i.codec)if("firefox"===u.webRTCAdapter.browserDetails.browser)u.warn("setCodecPreferences not supported in Firefox, ignoring codec for track:",i);else if("string"!=typeof i.codec)u.warn("Invalid codec value, ignoring for track:",i);else{let e=l+"/"+i.codec.toLowerCase(),t=o.getCapabilities(l).codecs.filter((function(t){return t.mimeType.toLowerCase()===e}));if(t&&0!==t.length)try{f.setCodecPreferences(t)}catch(e){u.warn("Failed enforcing codec for this "+l+" track:",e)}else u.warn("Codec not supported in this browser for this track, ignoring:",i)}if(f.receiver&&i.transforms&&i.transforms.receiver){let e=null;o.prototype.createEncodedStreams?e=f.receiver.createEncodedStreams():(o.prototype.createAudioEncodedStreams||o.prototype.createEncodedVideoStreams)&&("audio"===l?e=f.receiver.createEncodedAudioStreams():"video"===l&&(e=f.receiver.createEncodedVideoStreams())),e&&(u.log("Insertable Streams receiver transform:",e),e.readableStream&&e.writableStream?e.readableStream.pipeThrough(i.transforms.receiver).pipeTo(e.writableStream):e.readable&&e.writable&&e.readable.pipeThrough(i.transforms.receiver).pipeTo(e.writable))}}if(v&&c.myStream){let e=null;if("audio"===l&&c.myStream.getAudioTracks()&&c.myStream.getAudioTracks().length)for(let t of c.myStream.getAudioTracks())t.id===v&&(e=t,u.log("Removing audio track:",e));else if("video"===l&&c.myStream.getVideoTracks()&&c.myStream.getVideoTracks().length)for(let t of c.myStream.getVideoTracks())t.id===v&&(e=t,u.log("Removing video track:",e));if(e){try{c.myStream.removeTrack(e),a.onlocaltrack(e,!1)}catch(e){u.error("Error calling onlocaltrack on removal for renegotiation",e)}if(!0!==e.dontStop)try{e.stop()}catch(e){}}}if(g){c.myStream.addTrack(g),g.onended=function(e){u.log("Local track removed:",e);try{a.onlocaltrack(e.target,!1)}catch(e){u.error("Error calling onlocaltrack following end",e)}};try{a.onlocaltrack(g,!0)}catch(e){u.error("Error calling onlocaltrack for track add",e)}}if(f){let e=f.direction,t=null,n=g&&f.sender.track,r=!1!==i.recv&&f.receiver.track;n&&r?t="sendrecv":n&&!r?t="sendonly":!n&&r?t="recvonly":n||r||(t="inactive"),t&&t!==e&&(u.warn("Changing direction of transceiver to "+t+" (was "+e+")",i),f.setDirection?f.setDirection(t):f.direction=t)}}d&&a.consentDialog(!1)}function B(e){let t=x[e];if(!t||!t.webrtcStuff)return u.warn("Invalid handle"),null;let n=t.webrtcStuff;if(!n.pc)return u.warn("Invalid PeerConnection"),null;let r=[],i=n.pc.getTransceivers();for(let e of i){let t=null;e.sender&&e.sender.track&&(t={mid:e.mid},t.type=e.sender.track.kind,t.id=e.sender.track.id,t.label=e.sender.track.label),t&&r.push(t)}return r}function H(e){let t=x[e];if(!t||!t.webrtcStuff)return u.warn("Invalid handle"),null;let n=t.webrtcStuff;if(!n.pc)return u.warn("Invalid PeerConnection"),null;let r=[],i=n.pc.getTransceivers();for(let e of i){let t=null;e.receiver&&e.receiver.track&&(t={mid:e.mid},t.type=e.receiver.track.kind,t.id=e.receiver.track.id,t.label=e.receiver.track.label),t&&r.push(t)}return r}function X(e,t,n,r){r="function"==typeof r?r:u.noop;let i=x[e];if(!i||!i.webrtcStuff)return u.warn("Invalid handle"),void r(0);let o=n?"remote":"local",s=i.webrtcStuff;if(s.volume[o]||(s.volume[o]={value:0}),s.pc&&s.pc.getStats&&("chrome"===u.webRTCAdapter.browserDetails.browser||"safari"===u.webRTCAdapter.browserDetails.browser)){let e=s.pc;if(t){let i=s.pc.getTransceivers().find((e=>e.mid===t&&"audio"===e.receiver.track.kind));if(!i)return u.warn("No audio transceiver with mid "+t),void r(0);if(n&&!i.receiver)return u.warn("Remote transceiver track unavailable"),void r(0);if(!n&&!i.sender)return u.warn("Local transceiver track unavailable"),void r(0);e=n?i.receiver:i.sender}return e.getStats().then((function(e){e.forEach((function(e){e&&"audio"===e.kind&&(n&&!e.remoteSource||!n&&"media-source"!==e.type||r(e.audioLevel?e.audioLevel:0))}))})),s.volume[o].value}return u.warn("Getting the "+o+" volume unsupported by browser"),void r(0)}function K(e,t,n){let r=x[e];if(!r||!r.webrtcStuff)return u.warn("Invalid handle"),!0;let i=r.webrtcStuff;if(!i.pc)return u.warn("Invalid PeerConnection"),!0;if(!i.myStream)return u.warn("Invalid local MediaStream"),!0;if(n){if(!i.myStream.getVideoTracks()||0===i.myStream.getVideoTracks().length)return u.warn("No video track"),!0;if(t){let e=i.pc.getTransceivers().find((e=>e.mid===t&&"video"===e.receiver.track.kind));return e?e.sender&&e.sender.track?!e.sender.track.enabled:(u.warn("No video sender with mid "+t),!0):(u.warn("No video transceiver with mid "+t),!0)}return!i.myStream.getVideoTracks()[0].enabled}if(!i.myStream.getAudioTracks()||0===i.myStream.getAudioTracks().length)return u.warn("No audio track"),!0;if(t){let e=i.pc.getTransceivers().find((e=>e.mid===t&&"audio"===e.receiver.track.kind));return e?e.sender&&e.sender.track?!e.sender.track.enabled:(u.warn("No audio sender with mid "+t),!0):(u.warn("No audio transceiver with mid "+t),!0)}return!i.myStream.getAudioTracks()[0].enabled}function Q(e,t,n,r){let i=x[e];if(!i||!i.webrtcStuff)return u.warn("Invalid handle"),!1;let o=i.webrtcStuff;if(!o.pc)return u.warn("Invalid PeerConnection"),!1;if(!o.myStream)return u.warn("Invalid local MediaStream"),!1;if(n){if(!o.myStream.getVideoTracks()||0===o.myStream.getVideoTracks().length)return u.warn("No video track"),!1;if(t){let e=o.pc.getTransceivers().find((e=>e.mid===t&&"video"===e.receiver.track.kind));if(!e)return u.warn("No video transceiver with mid "+t),!1;if(!e.sender||!e.sender.track)return u.warn("No video sender with mid "+t),!1;e.sender.track.enabled=!r}else for(const e of o.myStream.getVideoTracks())e.enabled=!r}else{if(!o.myStream.getAudioTracks()||0===o.myStream.getAudioTracks().length)return u.warn("No audio track"),!1;if(t){let e=o.pc.getTransceivers().find((e=>e.mid===t&&"audio"===e.receiver.track.kind));if(!e)return u.warn("No audio transceiver with mid "+t),!1;if(!e.sender||!e.sender.track)return u.warn("No audio sender with mid "+t),!1;e.sender.track.enabled=!r}else for(const e of o.myStream.getAudioTracks())e.enabled=!r}return!0}function Y(e,t){let n=x[e];if(!n||!n.webrtcStuff)return u.warn("Invalid handle"),"Invalid handle";let r=n.webrtcStuff;if(!r.pc)return"Invalid PeerConnection";if(r.pc.getStats){let e=r.pc,n=t||"default";if(t){let n=r.pc.getTransceivers().find((e=>e.mid===t&&"video"===e.receiver.track.kind));if(!n)return u.warn("No video transceiver with mid "+t),"No video transceiver with mid "+t;if(!n.receiver)return u.warn("No video receiver with mid "+t),"No video receiver with mid "+t;e=n.receiver}return r.bitrate[n]||(r.bitrate[n]={timer:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,value:"0 kbits/sec"}),r.bitrate[n].timer?r.bitrate[n].value:(u.log("Starting bitrate timer"+(t?" for mid "+t:"")+" (via getStats)"),r.bitrate[n].timer=setInterval((function(){e.getStats().then((function(e){e.forEach((function(e){if(!e)return;let t=!1;if(("video"===e.mediaType||e.id.toLowerCase().indexOf("video")>-1)&&"inbound-rtp"===e.type&&e.id.indexOf("rtcp")<0?t=!0:"ssrc"!=e.type||!e.bytesReceived||"VP8"!==e.googCodecName&&""!==e.googCodecName||(t=!0),t)if(r.bitrate[n].bsnow=e.bytesReceived,r.bitrate[n].tsnow=e.timestamp,null===r.bitrate[n].bsbefore||null===r.bitrate[n].tsbefore)r.bitrate[n].bsbefore=r.bitrate[n].bsnow,r.bitrate[n].tsbefore=r.bitrate[n].tsnow;else{let e=r.bitrate[n].tsnow-r.bitrate[n].tsbefore;"safari"===u.webRTCAdapter.browserDetails.browser&&(e/=1e3);let t=Math.round(8*(r.bitrate[n].bsnow-r.bitrate[n].bsbefore)/e);"safari"===u.webRTCAdapter.browserDetails.browser&&(t=parseInt(t/1e3)),r.bitrate[n].value=t+" kbits/sec",r.bitrate[n].bsbefore=r.bitrate[n].bsnow,r.bitrate[n].tsbefore=r.bitrate[n].tsnow}}))}))}),1e3),"0 kbits/sec")}return u.warn("Getting the video bitrate unsupported by browser"),"Feature unsupported by browser"}function $(e,t,n){let r=x[e];if(!r||!r.webrtcStuff)return void u.warn("Invalid handle");let i=r.webrtcStuff;if(!i.pc)return void u.warn("Invalid PeerConnection");let o=i.pc.getTransceivers().find((e=>e.mid===t));if(!o)return void u.warn("No transceiver with mid",t);if(!o.sender)return void u.warn("No sender for transceiver with mid",t);let s=o.sender.getParameters();s&&s.encodings&&0!==s.encodings.length?s.encodings.length>1?u.warn("Ignoring bitrate for simulcast track, use sendEncodings for that"):isNaN(n)||n<0?u.warn("Invalid bitrate (must be a positive integer)"):(s.encodings[0].maxBitrate=n,o.sender.setParameters(s)):u.warn("No parameters encodings")}function Z(e){u.error("WebRTC error:",e)}function ee(e,t){u.log("Cleaning WebRTC stuff");let n=x[e];if(!n)return;let r=n.webrtcStuff;if(r){if(!0===t){let t={janus:"hangup",transaction:u.randomString(12)};n.token&&(t.token=n.token),S&&(t.apisecret=S),u.debug("Sending hangup request (handle="+e+"):"),u.debug(t),a?(t.session_id=k,t.handle_id=e,c.send(JSON.stringify(t))):u.httpAPICall(h+"/"+k+"/"+e,{verb:"POST",withCredentials:y,body:t})}r.volume&&(r.volume.local&&r.volume.local.timer&&clearInterval(r.volume.local.timer),r.volume.remote&&r.volume.remote.timer&&clearInterval(r.volume.remote.timer));for(let e in r.bitrate)r.bitrate[e].timer&&clearInterval(r.bitrate[e].timer);r.bitrate={},!r.streamExternal&&r.myStream&&(u.log("Stopping local stream tracks"),u.stopAllTracks(r.myStream)),r.streamExternal=!1,r.myStream=null;try{r.pc.close()}catch(e){}r.pc=null,r.candidates=null,r.mySdp=null,r.remoteSdp=null,r.iceDone=!1,r.dataChannel={},r.dtmfSender=null,r.insertableStreams=!1}n.oncleanup()}j(e),this.getServer=function(){return h},this.isConnected=function(){return E},this.reconnect=function(e){(e=e||{}).success="function"==typeof e.success?e.success:u.noop,e.error="function"==typeof e.error?e.error:u.noop,e.reconnect=!0,j(e)},this.getSessionId=function(){return k},this.getInfo=function(e){!function(e){if(e=e||{},e.success="function"==typeof e.success?e.success:u.noop,e.error="function"==typeof e.error?e.error:u.noop,u.log("Getting info on Janus instance"),!E)return u.warn("Is the server down? (connected=false)"),void e.error("Is the server down? (connected=false)");let t=u.randomString(12),n={janus:"info",transaction:t};C&&(n.token=C);S&&(n.apisecret=S);if(a)return R[t]=function(t){u.log("Server info:"),u.debug(t),"server_info"!==t.janus&&u.error("Ooops: "+t.error.code+" "+t.error.reason),e.success(t)},void c.send(JSON.stringify(n));u.httpAPICall(h,{verb:"POST",withCredentials:y,body:n,success:function(t){u.log("Server info:"),u.debug(t),"server_info"!==t.janus&&u.error("Ooops: "+t.error.code+" "+t.error.reason),e.success(t)},error:function(t,n){u.error(t+":",n),""===n?e.error(t+": Is the server down?"):e.error(t+": "+n)}})}(e)},this.destroy=function(n){!function(n){n=n||{},n.success="function"==typeof n.success?n.success:u.noop,n.error="function"==typeof n.error?n.error:u.noop;let r=!0===n.unload,i=!0;void 0!==n.notifyDestroyed&&null!==n.notifyDestroyed&&(i=!0===n.notifyDestroyed);let o=!0===n.cleanupHandles;if(u.log("Destroying session "+k+" (unload="+r+")"),!k)return u.warn("No session to destroy"),n.success(),void(i&&e.destroyed());if(o)for(let e in x)V(e,{noRequest:!0});if(!E)return u.warn("Is the server down? (connected=false)"),k=null,void n.success();let s={janus:"destroy",transaction:u.randomString(12)};C&&(s.token=C);S&&(s.apisecret=S);if(r)return a?(c.onclose=null,c.close(),c=null):t.sendBeacon(h+"/"+k,JSON.stringify(s)),u.log("Destroyed session:"),k=null,E=!1,n.success(),void(i&&e.destroyed());if(a){s.session_id=k;let t=function(){for(let e in l)c.removeEventListener(e,l[e]);c.removeEventListener("message",r),c.removeEventListener("error",o),d&&clearTimeout(d),c.close()},r=function(r){let o=JSON.parse(r.data);o.session_id==s.session_id&&o.transaction==s.transaction&&(t(),n.success(),i&&e.destroyed())},o=function(){t(),n.error("Failed to destroy the server: Is the server down?"),i&&e.destroyed()};return c.addEventListener("message",r),c.addEventListener("error",o),void(1===c.readyState?c.send(JSON.stringify(s)):o())}u.httpAPICall(h+"/"+k,{verb:"POST",withCredentials:y,body:s,success:function(t){u.log("Destroyed session:"),u.debug(t),k=null,E=!1,"success"!==t.janus&&u.error("Ooops: "+t.error.code+" "+t.error.reason),n.success(),i&&e.destroyed()},error:function(t,r){u.error(t+":",r),k=null,E=!1,n.success(),i&&e.destroyed()}})}(n)},this.attach=function(e){!function(e){if(e=e||{},e.success="function"==typeof e.success?e.success:u.noop,e.error="function"==typeof e.error?e.error:u.noop,e.dataChannelOptions=e.dataChannelOptions||{ordered:!0},e.consentDialog="function"==typeof e.consentDialog?e.consentDialog:u.noop,e.iceState="function"==typeof e.iceState?e.iceState:u.noop,e.mediaState="function"==typeof e.mediaState?e.mediaState:u.noop,e.webrtcState="function"==typeof e.webrtcState?e.webrtcState:u.noop,e.slowLink="function"==typeof e.slowLink?e.slowLink:u.noop,e.onmessage="function"==typeof e.onmessage?e.onmessage:u.noop,e.onlocaltrack="function"==typeof e.onlocaltrack?e.onlocaltrack:u.noop,e.onremotetrack="function"==typeof e.onremotetrack?e.onremotetrack:u.noop,e.ondata="function"==typeof e.ondata?e.ondata:u.noop,e.ondataopen="function"==typeof e.ondataopen?e.ondataopen:u.noop,e.oncleanup="function"==typeof e.oncleanup?e.oncleanup:u.noop,e.ondetached="function"==typeof e.ondetached?e.ondetached:u.noop,!E)return u.warn("Is the server down? (connected=false)"),void e.error("Is the server down? (connected=false)");let t=e.plugin;if(!t)return u.error("Invalid plugin"),void e.error("Invalid plugin");let n=e.opaqueId,r=e.loopIndex,i=e.token?e.token:C,o=u.randomString(12),s={janus:"attach",plugin:t,opaque_id:n,loop_index:r,transaction:o};i&&(s.token=i);S&&(s.apisecret=S);if(a)return R[o]=function(n){if(u.debug(n),"success"!==n.janus)return u.error("Ooops: "+n.error.code+" "+n.error.reason),void e.error("Ooops: "+n.error.code+" "+n.error.reason);let r=n.data.id;u.log("Created handle: "+r);let o={session:D,plugin:t,id:r,token:i,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,mySdp:null,mediaConstraints:null,pc:null,dataChannelOptions:e.dataChannelOptions,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,bitrate:{}},getId:function(){return r},getPlugin:function(){return t},getVolume:function(e,t){return X(r,e,!0,t)},getRemoteVolume:function(e,t){return X(r,e,!0,t)},getLocalVolume:function(e,t){return X(r,e,!1,t)},isAudioMuted:function(e){return K(r,e,!1)},muteAudio:function(e){return Q(r,e,!1,!0)},unmuteAudio:function(e){return Q(r,e,!1,!1)},isVideoMuted:function(e){return K(r,e,!0)},muteVideo:function(e){return Q(r,e,!0,!0)},unmuteVideo:function(e){return Q(r,e,!0,!1)},getBitrate:function(e){return Y(r,e)},setMaxBitrate:function(e,t){return $(r,e,t)},send:function(e){M(r,e)},data:function(e){_(r,e)},dtmf:function(e){J(r,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){F(r,!0,e)},createAnswer:function(e){F(r,!1,e)},handleRemoteJsep:function(e){z(r,e)},replaceTracks:function(e){W(r,e)},getLocalTracks:function(){return B(r)},getRemoteTracks:function(){return H(r)},onlocaltrack:e.onlocaltrack,onremotetrack:e.onremotetrack,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){ee(r,!0===e)},detach:function(e){V(r,e)}};x[r]=o,e.success(o)},s.session_id=k,void c.send(JSON.stringify(s));u.httpAPICall(h+"/"+k,{verb:"POST",withCredentials:y,body:s,success:function(n){if(u.debug(n),"success"!==n.janus)return u.error("Ooops: "+n.error.code+" "+n.error.reason),void e.error("Ooops: "+n.error.code+" "+n.error.reason);let r=n.data.id;u.log("Created handle: "+r);let o={session:D,plugin:t,id:r,token:i,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,mySdp:null,mediaConstraints:null,pc:null,dataChannelOptions:e.dataChannelOptions,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,bitrate:{}},getId:function(){return r},getPlugin:function(){return t},getVolume:function(e,t){return X(r,e,!0,t)},getRemoteVolume:function(e,t){return X(r,e,!0,t)},getLocalVolume:function(e,t){return X(r,e,!1,t)},isAudioMuted:function(e){return K(r,e,!1)},muteAudio:function(e){return Q(r,e,!1,!0)},unmuteAudio:function(e){return Q(r,e,!1,!1)},isVideoMuted:function(e){return K(r,e,!0)},muteVideo:function(e){return Q(r,e,!0,!0)},unmuteVideo:function(e){return Q(r,e,!0,!1)},getBitrate:function(e){return Y(r,e)},setMaxBitrate:function(e,t){return $(r,e,t)},send:function(e){M(r,e)},data:function(e){_(r,e)},dtmf:function(e){J(r,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){F(r,!0,e)},createAnswer:function(e){F(r,!1,e)},handleRemoteJsep:function(e){z(r,e)},replaceTracks:function(e){W(r,e)},getLocalTracks:function(){return B(r)},getRemoteTracks:function(){return H(r)},onlocaltrack:e.onlocaltrack,onremotetrack:e.onremotetrack,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){ee(r,!0===e)},detach:function(e){V(r,e)}};x[r]=o,e.success(o)},error:function(t,n){u.error(t+":",n),""===n?e.error(t+": Is the server down?"):e.error(t+": "+n)}})}(e)}}return u.useDefaultDependencies=function(t){let n=t&&t.fetch||fetch,r=t&&t.Promise||Promise,i=t&&t.WebSocket||WebSocket;return{newWebSocket:function(e,t){return new i(e,t)},extension:t&&t.extension||c,isArray:function(e){return Array.isArray(e)},webRTCAdapter:t&&t.adapter||e,httpAPICall:function(e,t){let i={method:t.verb,headers:{Accept:"application/json, text/plain, */*"},cache:"no-cache"};"POST"===t.verb&&(i.headers["Content-Type"]="application/json"),void 0!==t.withCredentials&&(i.credentials=!0===t.withCredentials?"include":t.withCredentials?t.withCredentials:"omit"),t.body&&(i.body=JSON.stringify(t.body));let o=n(e,i).catch((function(e){return r.reject({message:"Probably a network error, is the server down?",error:e})}));if(t.timeout){let e=new r((function(e,n){let r=setTimeout((function(){return clearTimeout(r),n({message:"Request timed out",timeout:t.timeout})}),t.timeout)}));o=r.race([o,e])}return o.then((function(e){return e.ok?typeof t.success==typeof u.noop?e.json().then((function(e){try{t.success(e)}catch(e){u.error("Unhandled httpAPICall success callback error",e)}}),(function(t){return r.reject({message:"Failed to parse response body",error:t,response:e})})):void 0:r.reject({message:"API call failed",response:e})})).catch((function(e){typeof t.error==typeof u.noop&&t.error(e.message||"<< internal error >>",e)})),o}}},u.useOldDependencies=function(t){let n=t&&t.jQuery||jQuery,r=t&&t.WebSocket||WebSocket;return{newWebSocket:function(e,t){return new r(e,t)},isArray:function(e){return n.isArray(e)},extension:t&&t.extension||c,webRTCAdapter:t&&t.adapter||e,httpAPICall:function(e,t){let r=void 0!==t.body?{contentType:"application/json",data:JSON.stringify(t.body)}:{},i=void 0!==t.withCredentials?{xhrFields:{withCredentials:t.withCredentials}}:{};return n.ajax(n.extend(r,i,{url:e,type:t.verb,cache:!1,dataType:"json",async:t.async,timeout:t.timeout,success:function(e){typeof t.success==typeof u.noop&&t.success(e)},error:function(e,n,r){typeof t.error==typeof u.noop&&t.error(n,r)}}))}}},u.mediaToTracks=function(e){let t=[];if(e){if(!e.keepAudio&&!1!==e.audio&&(void 0===e.audio||e.audio||e.audioSend||e.audioRecv||e.addAudio||e.replaceAudio||e.removeAudio)){let n={type:"audio"};e.removeAudio?n.remove=!0:(e.addAudio?n.add=!0:e.replaceAudio&&(n.replace=!0),!1!==e.audioSend&&(n.capture=e.audio||!0),!1!==e.audioRecv&&(n.recv=!0)),(n.remove||n.capture||n.recv)&&t.push(n)}if(!e.keepVideo&&!1!==e.video&&(void 0===e.video||e.video||e.videoSend||e.videoRecv||e.addVideo||e.replaceVideo||e.removeVideo)){let n={type:"video"};e.removeVideo?n.remove=!0:(e.addVideo?n.add=!0:e.replaceVideo&&(n.replace=!0),!1!==e.videoSend&&(n.capture=e.video||!0,["screen","window","desktop"].includes(n.capture)&&(n.type="screen",n.capture={video:{}},e.screenshareFrameRate&&(n.capture.frameRate=e.screenshareFrameRate),e.screenshareHeight&&(n.capture.height=e.screenshareHeight),e.screenshareWidth&&(n.capture.width=e.screenshareWidth))),!1!==e.videoRecv&&(n.recv=!0)),(n.remove||n.capture||n.recv)&&t.push(n)}e.data&&t.push({type:"data"})}else t.push({type:"audio",capture:!0,recv:!0}),t.push({type:"video",capture:!0,recv:!0});return t},u.trackConstraints=function(e){let t={};if(!e||!e.capture)return t;if("audio"===e.type)t.audio=e.capture;else if("video"===e.type)if((e.simulcast||e.svc)&&!0===e.capture&&(e.capture="hires"),!0===e.capture||"object"==typeof e.capture)t.video=e.capture;else{let n=0,r=0;"lowres"===e.capture?(n=320,r=240):"lowres-16:9"===e.capture?(n=320,r=180):"hires"===e.capture||"hires-16:9"===e.capture||"hdres"===e.capture?(n=1280,r=720):"fhdres"===e.capture?(n=1920,r=1080):"4kres"===e.capture?(n=3840,r=2160):"stdres"===e.capture?(n=640,r=480):"stdres-16:9"===e.capture?(n=640,r=360):(u.log("Default video setting is stdres 4:3"),n=640,r=480),t.video={width:{ideal:n},height:{ideal:r}}}else"screen"===e.type&&(t.video=e.capture);return t},u.noop=function(){},u.dataChanDefaultLabel="JanusDataChannel",u.endOfCandidates=null,u.stopAllTracks=function(e){try{let t=e.getTracks();for(let e of t)u.log(e),e&&!0!==e.dontStop&&e.stop()}catch(e){}},u.init=function(e){if((e=e||{}).callback="function"==typeof e.callback?e.callback:u.noop,u.initDone)e.callback();else{if(void 0===console.log&&(console.log=function(){}),u.trace=u.noop,u.debug=u.noop,u.vdebug=u.noop,u.log=u.noop,u.warn=u.noop,u.error=u.noop,!0===e.debug||"all"===e.debug)u.trace=console.trace.bind(console),u.debug=console.debug.bind(console),u.vdebug=console.debug.bind(console),u.log=console.log.bind(console),u.warn=console.warn.bind(console),u.error=console.error.bind(console);else if(Array.isArray(e.debug))for(let t of e.debug)switch(t){case"trace":u.trace=console.trace.bind(console);break;case"debug":u.debug=console.debug.bind(console);break;case"vdebug":u.vdebug=console.debug.bind(console);break;case"log":u.log=console.log.bind(console);break;case"warn":u.warn=console.warn.bind(console);break;case"error":u.error=console.error.bind(console);break;default:console.error("Unknown debugging option '"+t+"' (supported: 'trace', 'debug', 'vdebug', 'log', warn', 'error')")}u.log("Initializing library");let n=e.dependencies||u.useDefaultDependencies();if(u.isArray=n.isArray,u.webRTCAdapter=n.webRTCAdapter,u.httpAPICall=n.httpAPICall,u.newWebSocket=n.newWebSocket,u.extension=n.extension,u.extension.init(),u.listDevices=function(e,n){e="function"==typeof e?e:u.noop,n||(n={audio:!0,video:!0}),u.isGetUserMediaAvailable()?t.mediaDevices.getUserMedia(n).then((function(n){t.mediaDevices.enumerateDevices().then((function(t){u.debug(t),e(t),u.stopAllTracks(n)}))})).catch((function(t){u.error(t),e([])})):(u.warn("navigator.mediaDevices unavailable"),e([]))},u.safariVp8=!1,"safari"===u.webRTCAdapter.browserDetails.browser&&u.webRTCAdapter.browserDetails.version>=605)if(s&&s.getCapabilities&&s.getCapabilities("video")&&s.getCapabilities("video").codecs&&s.getCapabilities("video").codecs.length){for(let e of s.getCapabilities("video").codecs)if(e&&e.mimeType&&"video/vp8"===e.mimeType.toLowerCase()){u.safariVp8=!0;break}u.safariVp8?u.log("This version of Safari supports VP8"):u.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu")}else{let e=new i({});e.createOffer({offerToReceiveVideo:!0}).then((function(t){u.safariVp8=-1!==t.sdp.indexOf("VP8"),u.safariVp8?u.log("This version of Safari supports VP8"):u.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu"),e.close(),e=null}))}u.initDone=!0,e.callback()}},u.isWebrtcSupported=function(){return!!i},u.isGetUserMediaAvailable=function(){return t.mediaDevices&&t.mediaDevices.getUserMedia},u.randomString=function(e){let t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n="";for(let r=0;r<e;r++){let e=Math.floor(62*Math.random());n+=t.charAt(e)}return n},ae=u}(),ge=oe(me);!function(e){e.VIDEO="video",e.AUDIO="audio"}(le||(le={})),function(e){e.VIDEO="videoinput",e.AUDIO="audioinput"}(de||(de={})),function(e){e.PARTICIPANT_JOINED="participant_joined",e.PARTICIPANT_LEFT="participant_left",e.LOCAL_STREAM="local_stream",e.REMOTE_STREAM="remote_stream",e.REMOTE_TRACKS_UPDATED="remote_tracks_updated",e.DATA_CHANNEL_OPEN="data_channel_open",e.DATA_CHANNEL_MESSAGE="data_channel_message",e.ERROR="error"}(pe||(pe={})),function(e){e.CREATED="created",e.ENDED="ended",e.MUTE="mute",e.UNMUTE="unmute"}(fe||(fe={})),function(e){e.JOIN="join",e.LEFT="left",e.SLOW_LINK="slow-link",e.REMOTE_TRACKS_UPDATED="remote-tracks",e.REMOTE_STREAM="remote-stream",e.REMOTE_CONNECTION_STATE="remote-connection-state",e.DATA_CHANNEL_OPENED="data-channel-opened",e.DATA_CHANNEL_MESSAGE="data-channel-message",e.SESSION_CONNECTION_STATE="session-connection-state",e.ERROR="error"}(he||(he={}));var ve,ye,be,Ce,Se,Te,we=function(){function e(e){var n;if(this.videoRoomPlugin=null,this.isOnlyAudio=!1,this.currentRoomId=null,this.currentUserId=null,this.remoteFeeds={},this.remoteJseps={},this.remoteFeedsAttachingInProgress={},this.bitrateTimers={},this.emitter=new m,!F.env.isReactNative&&!L)throw"Error: in order to use this library please connect adapter.js. More info https://github.com/webrtc/adapter";if(this.token=e,this.server=M.conference.server,this.debug=null!==(n=M.conference.debug)&&void 0!==n?n:t.ALL,!this.server)throw"'server' parameter is mandatory";this.server.includes("http")&&(this.server+="/janus")}return e.prototype.createSession=function(e){var t=this,n=e.success,r=void 0===n?function(){}:n,i=e.error,o=void 0===i?function(){}:i,s=e.destroyed,a=void 0===s?function(){}:s,c=e.timeoutSessionCallback,u=void 0===c?function(){}:c;ge.init({debug:this.debug,callback:function(){ge.isWebrtcSupported()?t.engine=new ge({server:t.server,iceServers:M.videochat.iceServers,token:t.token,success:function(){return F.safeCallbackCall(r)()},error:function(e){return F.safeCallbackCall(o)(e)},destroyed:function(){return F.safeCallbackCall(a)()},timeoutSessionCallback:function(){return F.safeCallbackCall(u)()}}):F.safeCallbackCall(o)("Your browser does not support WebRTC, so you can't use this functionality.")}})},e.prototype.getSessionId=function(){var e,t;return null!==(t=null===(e=this.engine)||void 0===e?void 0:e.getSessionId())&&void 0!==t?t:null},e.prototype.destroySession=function(e){var t=e.success,n=void 0===t?function(){}:t,r=e.error,i=void 0===r?function(){}:r;this.engine.destroy({success:function(){return F.safeCallbackCall(n)()},error:function(e){return F.safeCallbackCall(i)(e)}})},e.prototype.attachVideoConferencingPlugin=function(e,t,n,r){var i=this,o=null,s=r.localStream;delete r.localStream;var a=r.displayName;delete r.displayName,this.engine.attach({plugin:"janus.plugin.videoroom",success:function(n){if(e){(o=n).userId=t,i.remoteFeedsAttachingInProgress[t]=o;var s={request:"join",room:i.currentRoomId,ptype:"listener",feed:t,display:a};null==o||o.send({message:s})}else i.videoRoomPlugin=n;F.safeCallbackCall(r.success)()},error:function(e){F.safeCallbackCall(r.error)(e)},consentDialog:function(e){F.safeCallbackCall(r.consentDialog)(e)},mediaState:function(e,t){F.safeCallbackCall(r.mediaState)(e,t)},webrtcState:function(e){F.safeCallbackCall(r.webrtcState)(e)},slowLink:function(e,t){F.safeCallbackCall(r.slowLink)(e,t)},iceState:function(e){F.safeCallbackCall(r.iceState)(e)},onmessage:function(t,o){var a=t.videoroom;if(e){if(a)if("attached"===a){var c=t.id;i.remoteFeeds[c]=i.remoteFeedsAttachingInProgress[c],i.remoteFeedsAttachingInProgress[c]=null}else t.error&&F.safeCallbackCall(r.error)(t.error);if(o){c=t.id;i.remoteJseps[c]=o,i.createAnswer({remoteFeed:i.remoteFeeds[c],jsep:o},s,{success:function(){},error:function(e){F.safeCallbackCall(r.error)(e)}})}}else{if(a)if("joined"===a){var u={media:n?{audio:!1,video:!1}:{audio:!0,video:!0},stream:n?void 0:s};i.createOffer(u,{success:function(){if(t.publishers){var e=t.publishers;for(var n in e){var r=e[n].id,o=e[n].display;i.emitter.emit(pe.PARTICIPANT_JOINED,r,o,!0)}}},error:function(e){F.safeCallbackCall(r.error)(e)}})}else if("event"===a)if(t.publishers){var l=t.publishers;for(var d in l){var p=l[d].id,f=l[d].display;i.emitter.emit(pe.PARTICIPANT_JOINED,p,f,!1)}}else if(t.leaving){c=t.leaving;i.detachRemoteFeed(c)&&i.emitter.emit(pe.PARTICIPANT_LEFT,c,null)}else if(t.unpublished){if("ok"!=(c=t.unpublished))i.detachRemoteFeed(c)&&i.emitter.emit(pe.PARTICIPANT_LEFT,c,null)}else t.error&&(F.DLog("[janus error message]",t.error),i.emitter.emit(pe.ERROR,t),F.safeCallbackCall(r.error)(t.error));o&&i.videoRoomPlugin.handleRemoteJsep({jsep:o})}},onlocaltrack:function(e,t){F.DLog("[onlocaltrack]",e,t),i.onLocalTrack(e,t)},onremotetrack:function(e,t,n,r){F.DLog("[onremotetrack]",e,t,n,r),i.onRemoteTrack(o,e,t,n,r)},ondataopen:function(e){F.DLog("[ondataopen]",e),i.emitter.emit(pe.DATA_CHANNEL_OPEN,e)},ondata:function(e,t){F.DLog("[ondata]",t,e),i.emitter.emit(pe.DATA_CHANNEL_MESSAGE,t,e)},oncleanup:function(){F.safeCallbackCall(r.oncleanup)()},detached:function(){}})},e.prototype.onLocalTrack=function(e,t){},e.prototype.onRemoteTrack=function(e,t,n,r,i){var o,s=i&&i.reason;if(s===fe.CREATED){var a=!e.stream||!e.tracks;a?(e.tracks=((o={})[n]=t,o),e.stream=new E([t])):(e.tracks[n]=t,e.stream.addTrack(t)),a&&this.emitter.emit(pe.REMOTE_STREAM,e.userId,e.stream)}else if(s===fe.ENDED){delete e.tracks[n];var c=e.stream.getTracks().find((function(e){return e.kind===t.kind}));e.stream.removeTrack(c)}this.emitter.emit(pe.REMOTE_TRACKS_UPDATED,e.userId,t,s)},e.prototype.getPluginId=function(){var e,t;return null!==(t=null===(e=this.videoRoomPlugin)||void 0===e?void 0:e.getId())&&void 0!==t?t:null},e.prototype.detachVideoConferencingPlugin=function(e){var t=this,n=function(){t.videoRoomPlugin=null,Object.keys(t.remoteFeeds).forEach((function(e){t.detachRemoteFeed(Number(e))})),t.remoteFeeds={},t.remoteJseps={}};this.videoRoomPlugin.detach({success:function(){n(),F.safeCallbackCall(e.success)()},error:function(t){n(),F.safeCallbackCall(e.error)(t)}})},e.prototype.join=function(e,t,n,r){var i=this,o=r.displayName;delete r.displayName,this.isOnlyAudio=n,F.DLog("isOnlyAudio: "+this.isOnlyAudio);var s={request:"join",room:e,ptype:"publisher",id:t,display:o};this.videoRoomPlugin.send({message:s,success:function(n){i.currentRoomId=e,i.currentUserId=t,F.safeCallbackCall(r.success)()},error:function(e){F.safeCallbackCall(r.error)(e)}})},e.prototype.leave=function(e){if(F.DLog("leave"),this.engine.isConnected()){var t={request:"leave",room:this.currentRoomId,id:this.currentUserId};this.videoRoomPlugin&&this.videoRoomPlugin.send({message:t}),this.currentRoomId=null,this.currentUserId=null,F.safeCallbackCall(e.success)()}else F.safeCallbackCall(e.success)()},e.prototype.listOnlineParticipants=function(e,t){var n={request:"listparticipants",room:e};this.videoRoomPlugin.send({message:n,success:function(e){var n=e?e.participants:[];F.safeCallbackCall(t.success)(n)},error:function(e){F.safeCallbackCall(t.error)(e)}})},e.prototype.toggleAudioMute=function(){return this.videoRoomPlugin.isAudioMuted()?this.videoRoomPlugin.unmuteAudio():this.videoRoomPlugin.muteAudio(),this.videoRoomPlugin.isAudioMuted()},e.prototype.isAudioMuted=function(){return this.videoRoomPlugin.isAudioMuted()},e.prototype.toggleRemoteAudioMute=function(e){var t=this.remoteFeeds[e];if(!t)return!1;var n=t.stream.getAudioTracks();if(n&&n.length>0){for(var r=0;r<n.length;++r)n[r].enabled=!n[r].enabled;return!n[0].enabled}return!1},e.prototype.isRemoteAudioMuted=function(e){var t=this.remoteFeeds[e];if(!t)return!1;var n=t.stream.getAudioTracks();return!!(n&&n.length>0)&&!n[0].enabled},e.prototype.toggleVideoMute=function(){return this.videoRoomPlugin.isVideoMuted()?this.videoRoomPlugin.unmuteVideo():this.videoRoomPlugin.muteVideo(),this.videoRoomPlugin.isVideoMuted()},e.prototype.isVideoMuted=function(){return this.videoRoomPlugin.isVideoMuted()},e.prototype.toggleRemoteVideoMute=function(e){var t=this.remoteFeeds[e];if(!t)return!1;var n=t.stream.getVideoTracks();if(n&&n.length>0){for(var r=0;r<n.length;++r)n[r].enabled=!n[r].enabled;return!n[0].enabled}return!1},e.prototype.isRemoteVideoMuted=function(e){var t=this.remoteFeeds[e];if(!t)return!1;var n=t.stream.getVideoTracks();return!!(n&&n.length>0)&&!n[0].enabled},e.prototype.sendKeyframeRequest=function(e,t){var n={request:"configure",room:e,keyframe:!0};this.videoRoomPlugin.send({message:n,success:function(e){F.safeCallbackCall(t.success)(e)},error:function(e){F.safeCallbackCall(t.error)(e)}})},e.prototype.getTracksFromStream=function(e){var t=[],n=e.getAudioTracks();if(n.length){var r=n[0];t.push({type:"audio",capture:r,recv:!1})}var i=e.getVideoTracks();if(i.length){var o=i[0];t.push({type:"video",capture:o,recv:!1})}return t},e.prototype.createOffer=function(e,t){var n=this;F.DLog("[JanusWrapper][createOffer]",e);var r=e.stream,i=e.media,o=e.replace,s={tracks:[{type:"data"}]};if(r){var a=this.getTracksFromStream(r);s.tracks=s.tracks.concat(a)}else if(i){var c=[];i.audio&&c.push({type:"audio",capture:i.audio,recv:!1,replace:!!o}),i.video&&c.push({type:"video",capture:i.video,recv:!1,replace:!!o}),s.tracks=s.tracks.concat(c)}else s.tracks=s.tracks.concat([{type:"audio",capture:!0,recv:!1,replace:!!o},{type:"video",capture:!0,recv:!1,replace:!!o}]);F.DLog("[JanusWrapper][createOffer][params]",s),s.customizeSdp=function(e){},s.success=function(e){var r={request:"configure",audio:!!i.audio,video:!!i.video};F.DLog("[JanusWrapper][createOffer][success]",r),n.videoRoomPlugin.send({message:r,jsep:e}),F.safeCallbackCall(t.success)()},s.error=function(e){F.DLog("[JanusWrapper][createOffer][error]",e),i.audio?n.createOffer({media:{video:!1,audio:!1}},t):F.safeCallbackCall(t.error)(e)},this.videoRoomPlugin.createOffer(s)},e.prototype.getTracksMidsFromStream=function(e){var t=[],n=e.getAudioTracks();if(n.length){var r=n[0];t.push({type:"audio",mid:r.id,recv:!0})}var i=e.getVideoTracks();if(i.length){var o=i[0];t.push({type:"video",mid:o.id,recv:!0})}return t},e.prototype.createAnswer=function(e,t,n){var r=this,i=e.remoteFeed,o=e.jsep;F.DLog("[JanusWrapper][createAnswer]",o,t);var s=[{type:"data"}];if(t){var a=this.getTracksMidsFromStream(t);s=s.concat(a)}F.DLog("[JanusWrapper][createAnswer][tracks]",s),i.createAnswer({jsep:o,tracks:s,success:function(e){var t={request:"start",room:r.currentRoomId};F.DLog("[JanusWrapper][createAnswer][success]",t),i.send({message:t,jsep:e}),F.safeCallbackCall(n.success)()},error:function(e){F.DLog("[JanusWrapper][createAnswer][error]",e),F.safeCallbackCall(n.error)(e)}})},e.prototype.detachRemoteFeed=function(e){var t=this.remoteFeeds[e];return!!t&&(t.detach(),this.remoteFeeds[e]=null,this.remoteJseps[e]=null,!0)},e.prototype.getUserBitrate=function(e){return this.remoteFeeds[e].getBitrate()},e.prototype.getVolume=function(e){return this.videoRoomPlugin.getLocalVolume(null,e)},e.prototype.getUserVolume=function(e,t){return this.remoteFeeds[e].getRemoteVolume(null,t)},e.prototype.showBitrate=function(e,t){var n=this.remoteFeeds[e];F.env.isReactNative||"chrome"!==L.browserDetails.browser&&"firefox"!==L.browserDetails.browser||(this.bitrateTimers[e]=setInterval((function(){var e=n.getBitrate();t.text(e)}),1e3))},e.prototype.hideBitrate=function(e,t){this.bitrateTimers[e]&&clearInterval(this.bitrateTimers[e]),this.bitrateTimers[e]=null,t.text=null},e.prototype.on=function(e,t){return this.emitter.addListener(e,t)},e.prototype.removeAllListeners=function(e){return this.emitter.removeAllListeners(e)},e}(),Ie=function(){function e(e){var t=this;this.id="".concat(Math.random()),this.mediaParams={},this.onParticipantJoined=function(e,n,r){F.DLog("[onParticipantJoined]",e,n,r),t.createHandler(e,!0,!1),F.safeCallbackCall(t.onParticipantJoinedListener)(t,e,n,r)},this.onParticipantLeft=function(e,n){F.DLog("[onParticipantLeft]",e,n),F.safeCallbackCall(t.onParticipantLeftListener)(t,e,n)},this.onError=function(e){F.DLog("[onError]",JSON.stringify(e)),F.safeCallbackCall(t.onErrorListener)(t,e)},this.onDataChannelOpen=function(e){F.DLog("[onDataChannelOpen]",e),F.safeCallbackCall(t.onDataChannelOpenedListener)(t,e)},this.onDataChannelMessage=function(e,n){F.DLog("[onDataChannelMessage]",e,n),F.safeCallbackCall(t.onDataChannelMessageListener)(t,e,n)},this.onLocalIceStateChanged=function(e){F.DLog("[onLocalIceStateChanged]",e),F.safeCallbackCall(t.onSessionConnectionStateChangedListener)(t,e)},this.onRemoteIceStateChanged=function(e,n){F.DLog("[onRemoteIceStateChanged]",e,n),F.safeCallbackCall(t.onRemoteConnectionStateChangedListener)(t,e,n)},this.onRemoteStream=function(e,n){F.DLog("[onRemoteStream]",e,n),F.safeCallbackCall(t.onRemoteStreamListener)(t,e,n)},this.onRemoteTracksUpdated=function(e,n,r){F.DLog("[onRemoteTracksUpdated]",e,n,r),F.safeCallbackCall(t.onRemoteTracksUpdatedListener)(t,e,n,r)},this.onSlowLink=function(e,n,r){F.DLog("[onSlowLink]",e,n,r),F.safeCallbackCall(t.onSlowLinkListener)(t,e,n,r)},this.client=new we(e),this.client.on(pe.PARTICIPANT_JOINED,this.onParticipantJoined),this.client.on(pe.PARTICIPANT_LEFT,this.onParticipantLeft),this.client.on(pe.REMOTE_STREAM,this.onRemoteStream),this.client.on(pe.REMOTE_TRACKS_UPDATED,this.onRemoteTracksUpdated),this.client.on(pe.DATA_CHANNEL_OPEN,this.onDataChannelOpen),this.client.on(pe.DATA_CHANNEL_MESSAGE,this.onDataChannelMessage),this.client.on(pe.ERROR,this.onError)}return Object.defineProperty(e.prototype,"currentRoomId",{get:function(){return this.client.currentRoomId},set:function(e){this.client.currentRoomId=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currentPublisherPC",{get:function(){return this.client.videoRoomPlugin.webrtcStuff.pc},enumerable:!1,configurable:!0}),e.prototype.createSession=function(){return U(this,void 0,void 0,(function(){var e,t=this;return _(this,(function(n){return e=!1,[2,new Promise((function(n,r){t.client.createSession({success:function(){e=!0,n(void 0)},error:function(n){e?t.onError(n):r(n)}})}))]}))}))},e.prototype.join=function(e,t,n){return U(this,void 0,void 0,(function(){return _(this,(function(r){switch(r.label){case 0:return this.currentUserDisplayName=n,this.currentRoomId=e,[4,this.createSession()];case 1:return r.sent(),[4,this.createHandler(t,!1,!1)];case 2:return r.sent(),[4,this.joinInternal(this.currentRoomId,t)];case 3:return r.sent(),[2]}}))}))},e.prototype.joinAsListener=function(e,t,n){return U(this,void 0,void 0,(function(){return _(this,(function(r){switch(r.label){case 0:return this.currentUserDisplayName=n,this.currentRoomId=e,[4,this.createSession()];case 1:return r.sent(),[4,this.createHandler(t,!1,!0)];case 2:return r.sent(),[4,this.joinInternal(this.currentRoomId,t)];case 3:return r.sent(),[2]}}))}))},e.prototype.sendKeyframeRequest=function(e){return U(this,void 0,void 0,(function(){var t=this;return _(this,(function(n){return[2,new Promise((function(n,r){t.client.sendKeyframeRequest(e,{success:n,error:r})}))]}))}))},e.prototype.createHandler=function(e,t){return U(this,arguments,void 0,(function(e,t,n){var r=this;return void 0===n&&(n=!1),_(this,(function(i){return[2,new Promise((function(i,o){r.client.attachVideoConferencingPlugin(t,e,n,{success:i,error:o,iceState:t?function(t){return r.onRemoteIceStateChanged(e,t)}:function(e){return r.onLocalIceStateChanged(e)},slowLink:t?function(t,n){return r.onSlowLink(e,t,n)}:function(e,t){return r.onSlowLink(null,e,t)},localStream:r.localStream,displayName:r.currentUserDisplayName})}))]}))}))},e.prototype.joinInternal=function(e,t){return U(this,void 0,void 0,(function(){var n=this;return _(this,(function(r){return[2,new Promise((function(r,i){n.client.join(e,t,!1,{success:r,error:i,displayName:n.currentUserDisplayName})}))]}))}))},e.prototype.listOfOnlineParticipants=function(){return U(this,void 0,void 0,(function(){var e=this;return _(this,(function(t){return[2,new Promise((function(t,n){e.currentRoomId?e.client.listOnlineParticipants(e.currentRoomId,{success:t,error:n}):n("Room ID is not set")}))]}))}))},e.prototype.leave=function(){return U(this,void 0,void 0,(function(){return _(this,(function(e){switch(e.label){case 0:return this.currentRoomId=null,this.currentUserDisplayName=void 0,[4,this.leaveGroup()];case 1:return e.sent(),[4,this.detachVideoConferencingPlugin()];case 2:return e.sent(),[4,this.destroy()];case 3:return e.sent(),this.localStream&&(this.localStream.getTracks().forEach((function(e){return e.stop()})),this.localStream=void 0,this.mediaParams={}),[2]}}))}))},e.prototype.leaveGroup=function(){return U(this,void 0,void 0,(function(){var e=this;return _(this,(function(t){return[2,new Promise((function(t,n){e.client.leave({success:t,error:n})}))]}))}))},e.prototype.destroy=function(){return U(this,void 0,void 0,(function(){var e=this;return _(this,(function(t){return[2,new Promise((function(t,n){e.client.destroySession({success:t,error:n})}))]}))}))},e.prototype.detachVideoConferencingPlugin=function(){return U(this,void 0,void 0,(function(){var e=this;return _(this,(function(t){return[2,new Promise((function(t,n){e.client.detachVideoConferencingPlugin({success:t,error:n})}))]}))}))},e.prototype.getDisplayMedia=function(e){return U(this,void 0,void 0,(function(){var t,n,r,i;return _(this,(function(o){switch(o.label){case 0:if(!I.getDisplayMedia)throw new Error("Your environment does not support 'getDisplayMedia' API");t=e&&e.elementId,n=e&&e.options,r=N({},e),this.mediaParams=r,delete r.elementId,delete r.options,o.label=1;case 1:return o.trys.push([1,3,,4]),[4,I.getDisplayMedia(r)];case 2:return i=o.sent(),[2,this.upsertStream(i,t,n)];case 3:throw o.sent();case 4:return[2]}}))}))},e.prototype.getUserMedia=function(e){return U(this,void 0,void 0,(function(){var t,n,r,i;return _(this,(function(o){switch(o.label){case 0:t=e&&e.elementId,n=e&&e.options,r=N({},e),this.mediaParams=r,delete r.elementId,delete r.options,o.label=1;case 1:return o.trys.push([1,3,,4]),[4,I.getUserMedia(r)];case 2:return i=o.sent(),[2,this.upsertStream(i,t,n)];case 3:throw o.sent();case 4:return[2]}}))}))},e.prototype.upsertStream=function(e,t,n){void 0===t&&(t=null),void 0===n&&(n={});var r=!!this.localStream;if(r?this.replaceTracks(e):this.localStream=e,!this.localStream)throw new Error("Local stream is not defined");return t&&(r&&this.detachMediaStream(t,n),this.attachMediaStream(t,this.localStream,n)),this.localStream},e.prototype.replaceTracks=function(e){var t,n=this;if(null===(t=this.localStream)||void 0===t||t.getTracks().forEach((function(t){var r;t.kind===le.AUDIO&&0===e.getAudioTracks().length||(t.stop(),null===(r=n.localStream)||void 0===r||r.removeTrack(t))})),e.getTracks().forEach((function(e){var t,r,i,o,s,a=n.currentPublisherPC.getSenders().find((function(t){var n=t.track;return e.kind===n.kind}));e.kind===le.AUDIO?e.enabled=null===(r=null===(t=n.localStream)||void 0===t?void 0:t.getAudioTracks().every((function(e){return e.enabled})))||void 0===r||r:e.enabled=null===(o=null===(i=n.localStream)||void 0===i?void 0:i.getVideoTracks().every((function(e){return e.enabled})))||void 0===o||o,a?(a.replaceTrack(e),null===(s=n.localStream)||void 0===s||s.addTrack(e)):console.warn("No sender found for track kind: ".concat(e.kind))})),!this.localStream)throw new Error("Local stream is not defined");return this.localStream},e.prototype.switchMediaTracks=function(e){return U(this,void 0,void 0,(function(){var t,n,r,i,o,s,a=this;return _(this,(function(c){switch(c.label){case 0:[le.AUDIO,le.VIDEO].forEach((function(t){var n,r=t===le.AUDIO?e.audio:t===le.VIDEO?e.video:{},i="string"==typeof r?r:null!==(n=null==r?void 0:r.deviceId)&&void 0!==n?n:null;i&&("object"==typeof a.mediaParams[t]?a.mediaParams[t].deviceId=i:a.mediaParams[t]={deviceId:i})})),c.label=1;case 1:return c.trys.push([1,3,,4]),t={audio:null!==(i=null===(r=this.mediaParams)||void 0===r?void 0:r.audio)&&void 0!==i&&i,video:null!==(s=null===(o=this.mediaParams)||void 0===o?void 0:o.video)&&void 0!==s&&s},[4,I.getDisplayMedia(t)];case 2:return n=c.sent(),[2,this.replaceTracks(n)];case 3:throw c.sent();case 4:return[2]}}))}))},e.prototype.muteVideo=function(){this.isVideoMuted()||this.client.toggleVideoMute()},e.prototype.unmuteVideo=function(){this.isVideoMuted()&&this.client.toggleVideoMute()},e.prototype.muteAudio=function(){this.isAudioMuted()||this.client.toggleAudioMute()},e.prototype.unmuteAudio=function(){this.isAudioMuted()&&this.client.toggleAudioMute()},e.prototype.isVideoMuted=function(){return this.client.isVideoMuted()},e.prototype.isAudioMuted=function(){return this.client.isAudioMuted()},e.prototype.getUserVolume=function(){return U(this,void 0,void 0,(function(){var e=this;return _(this,(function(t){return[2,new Promise((function(t,n){return e.client.getVolume(t)}))]}))}))},e.prototype.getRemoteUserBitrate=function(e){return this.client.getUserBitrate(e)},e.prototype.getRemoteUserVolume=function(e){return U(this,void 0,void 0,(function(){var t=this;return _(this,(function(n){return[2,new Promise((function(n,r){return t.client.getUserVolume(e,n)}))]}))}))},e.prototype.attachMediaStream=function(e,t,n){var r=document.getElementById(e);if(!("srcObject"in r))throw new Error("Unable to attach media stream, element #".concat(e," is undefined"));r.srcObject=t,r.style.transform=(null==n?void 0:n.mirror)?"scaleX(-1)":"none","boolean"==typeof(null==n?void 0:n.muted)&&(r.muted=null==n?void 0:n.muted),r.onloadedmetadata=function(e){r.play()}},e.prototype.detachMediaStream=function(e,t){var n=document.getElementById(e);if(!("srcObject"in n))throw new Error("Unable to attach media stream, element #".concat(e," is undefined"));n.pause(),n.srcObject=null,n.style.transform=(null==t?void 0:t.mirror)?"scaleX(-1)":"none","boolean"==typeof(null==t?void 0:t.muted)&&(n.muted=null==t?void 0:t.muted)},e.prototype.sendData=function(e,t){return U(this,void 0,void 0,(function(){var n=this;return _(this,(function(r){return[2,new Promise((function(r,i){n.client.videoRoomPlugin.data({data:e,label:t,success:r,error:i})}))]}))}))},e}(),Ee=function(){function e(e){this.DeviceInputType=de,this.CallType=le,this.sessionsStore={},this.proxy=e}return e.prototype.createNewSession=function(){var e=new Ie(this.getCurrentSessionToken());return this.sessionsStore[e.id]=e,e.onParticipantJoinedListener=this.onParticipantJoinedListener,e.onParticipantLeftListener=this.onParticipantLeftListener,e.onSlowLinkListener=this.onSlowLinkListener,e.onRemoteStreamListener=this.onRemoteStreamListener,e.onRemoteTracksUpdatedListener=this.onRemoteTracksUpdatedListener,e.onRemoteConnectionStateChangedListener=this.onRemoteConnectionStateChangedListener,e.onDataChannelOpenedListener=this.onDataChannelOpenedListener,e.onDataChannelMessageListener=this.onDataChannelMessageListener,e.onSessionConnectionStateChangedListener=this.onSessionConnectionStateChangedListener,e.onErrorListener=this.onErrorListener,e},e.prototype.getMediaDevices=function(e){return U(this,void 0,void 0,(function(){var t;return _(this,(function(n){switch(n.label){case 0:return(null==I?void 0:I.enumerateDevices)?[4,I.enumerateDevices()]:[3,2];case 1:return t=n.sent(),[2,e?t.filter((function(t){return t.kind===e})):t];case 2:throw new Error("No 'enumerateDevices' API supported")}}))}))},e.prototype.clearSession=function(e){delete this.sessionsStore[e]},e.prototype.getCurrentSessionToken=function(){var e=this.proxy.getSession();if(null==e?void 0:e.token)return e.token;throw new Error("Session does not exist")},e.prototype.getListenerByName=function(e){switch(e){case he.JOIN:return"onParticipantJoinedListener";case he.LEFT:return"onParticipantLeftListener";case he.SLOW_LINK:return"onSlowLinkListener";case he.REMOTE_STREAM:return"onRemoteStreamListener";case he.REMOTE_TRACKS_UPDATED:return"onRemoteTracksUpdatedListener";case he.REMOTE_CONNECTION_STATE:return"onRemoteConnectionStateChangedListener";case he.DATA_CHANNEL_OPENED:return"onDataChannelOpenedListener";case he.DATA_CHANNEL_MESSAGE:return"onDataChannelMessageListener";case he.SESSION_CONNECTION_STATE:return"onSessionConnectionStateChangedListener";case he.ERROR:return"onErrorListener";default:return null}},e.prototype.addListener=function(e,t){var n=this.getListenerByName(e);return n&&(this[n]=t),this.removeListener.bind(this,e)},e.prototype.removeListener=function(e){var t=this.getListenerByName(e);t&&(this[t]=void 0)},e.prototype.removeAllListeners=function(){var e=this;Object.keys(this).forEach((function(t){t.startsWith("on")&&t.endsWith("Listener")&&"function"==typeof e[t]&&(e[t]=void 0)}))},e}(),ke=function(){function e(e){this.route=M.urls.data,this.proxy=e}return e.prototype.create=function(e){return U(this,arguments,void 0,(function(e,t){var n,r,i;return void 0===t&&(t={}),_(this,(function(o){return n=F.isArray(t),r=n?"multi":void 0,i={type:V.POST,url:F.getUrl(this.route,e,r),data:n?{record:this.createRecord(t)}:t},[2,this.proxy.ajax(i)]}))}))},e.prototype.list=function(e){return U(this,arguments,void 0,(function(e,t){var n,r;return void 0===t&&(t={}),_(this,(function(i){return n="string"==typeof t?t:F.isArray(t)?t.toString():void 0,r={url:F.getUrl(this.route,e,n),data:n?void 0:t},[2,this.proxy.ajax(r)]}))}))},e.prototype.readPermissions=function(e,t){return U(this,void 0,void 0,(function(){var n;return _(this,(function(r){return n={url:F.getUrl(this.route,e,t),data:{permissions:1}},[2,this.proxy.ajax(n)]}))}))},e.prototype.update=function(e){return U(this,arguments,void 0,(function(e,t){var n,r,i,o;return void 0===t&&(t={}),_(this,(function(s){return n=F.isArray(t),r=!n&&t.search_criteria,i=n?"multi":r?"by_criteria":t.id||t._id,o={type:V.PUT,url:F.getUrl(this.route,e,i),data:n?{record:this.createRecord(t)}:t},[2,this.proxy.ajax(o)]}))}))},e.prototype.delete=function(e,t){return U(this,void 0,void 0,(function(){var n,r,i,o;return _(this,(function(s){return n=F.isObject(t),r="string"==typeof t||F.isArray(t)&&1===t.length,i=n?"by_criteria":t.toString(),o={type:V.DELETE,url:F.getUrl(this.route,e,i),data:n?t:void 0,dataType:r?q.TEXT:void 0},[2,this.proxy.ajax(o)]}))}))},e.prototype.createRecord=function(e){return void 0===e&&(e=[]),e.reduce((function(e,t,n){var r,i=n+1,o=t.id||t._id,s=o?N(N({},t),{id:o}):t;return N(N({},e),((r={})[i]=s,r))}),{})},e}(),xe=function(){function e(e){this.route=M.urls.meetings,this.proxy=e}return e.prototype.get=function(){return U(this,arguments,void 0,(function(e){var t;return void 0===e&&(e={}),_(this,(function(n){return t={type:V.GET,url:F.getUrl(this.route),data:e},[2,this.proxy.ajax(t)]}))}))},e.prototype.create=function(){return U(this,arguments,void 0,(function(e){var t,n,r,i,o;return void 0===e&&(e={}),_(this,(function(s){return t=Math.ceil(Date.now()/1e3),n=t+3600,r=new Date(t).toLocaleString("en",{year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric"}),i={name:r,start_date:t,end_date:n,attendees:[],record:!1,chat:!1},o={type:V.POST,url:F.getUrl(this.route),data:N(N({},i),e)},[2,this.proxy.ajax(o)]}))}))},e.prototype.update=function(e,t){return U(this,void 0,void 0,(function(){var n;return _(this,(function(r){return n={type:V.PUT,url:F.getUrl(this.route,e),data:t},[2,this.proxy.ajax(n)]}))}))},e.prototype.delete=function(e){return U(this,void 0,void 0,(function(){var t;return _(this,(function(n){return t={type:V.DELETE,url:F.getUrl(this.route,e),dataType:q.TEXT},[2,this.proxy.ajax(t)]}))}))},e.prototype.getRecordings=function(e){return U(this,void 0,void 0,(function(){var t;return _(this,(function(n){return t={type:V.GET,url:F.getUrl(this.route,"recordings",e)},[2,this.proxy.ajax(t)]}))}))},e}(),De=function(){function e(){this.sdkInstance={config:M,session:null},this.requestsNumber=0,this.fetchImpl=S,this.abortControllersMap={},this.requestMethod=V,this.responseType=q}return e.prototype.setSession=function(e){this.sdkInstance.session=e,e&&e.user_id&&this.setCurrentUserId(e.user_id)},e.prototype.getSession=function(){return this.sdkInstance.session},e.prototype.setCurrentUserId=function(e){this.currentUserId=e||void 0},e.prototype.getCurrentUserId=function(){return this.currentUserId},e.prototype.logRequest=function(e,t){F.DLog("[Request][".concat(t,"]"),"".concat(e.type||"GET"," ").concat(e.url),e)},e.prototype.logResponse=function(e,t){F.DLog("[Response][".concat(t,"]"),e)},e.prototype.buildRequestAndURL=function(e){var t,n=!e.type||"GET"===e.type||"HEAD"===e.type,r=!!e.type&&("POST"===e.type||"PUT"===e.type),i=this.sdkInstance&&this.sdkInstance.session&&this.sdkInstance.session.token,o=-1===e.url.indexOf("s3.amazonaws.com"),s=!1===e.contentType,a=e.authKey,c=e.url,u={};return u.method=e.type||"GET",e.data&&(t=this.buildRequestBody(e,s,r),n?c+="?".concat(t):u.body=t),s||(u.headers={"Content-Type":r?"application/json;charset=utf-8":"application/x-www-form-urlencoded; charset=UTF-8"}),o&&(u.headers||(u.headers={}),u.headers["CB-SDK"]="JS ".concat(M.version," - Client"),i?u.headers["CB-Token"]=i:a&&(u.headers["CB-AuthKey"]=a)),M.timeout&&(u.timeout=M.timeout),[u,c]},e.prototype.buildRequestBody=function(e,t,n){var r,i=e.data,o=e.useArrayQuery;return t?(r=new T,Object.keys(i).forEach((function(t){e.fileToCustomObject&&"file"===t?r.append(t,i[t].data,i[t].name):r.append(t,e.data[t])}))):r=n?JSON.stringify(i):this.serializeQueryParams(i,"",o,0),r},e.prototype.serializeQueryParams=function(e,t,n,r){void 0===r&&(r=0);var i=[];for(var o in e){var s=this.encodeURIComponent(o);F.isArray(e)&&(s="");var a=t?t+"[".concat(s,"]"):s,c=e[o],u=F.isArray(c);u&&(n||0===r)||F.isObject(c)?i.push(this.serializeQueryParams(c,a,n,++r)):(c=u?c.sort().join(","):c,i.push("".concat(a,"=").concat(this.encodeURIComponent(c))))}return i.sort().join("&")},e.prototype.encodeURIComponent=function(e){return encodeURIComponent(e).replace(/[#$&+,/:;=?@\[\]]/g,(function(e){return"%".concat(e.charCodeAt(0).toString(16))}))},e.prototype.abortRequest=function(e){this.abortControllersMap[e]&&(this.abortControllersMap[e].controllers||[]).forEach((function(e){e.abort()}))},e.prototype.processSuccessfulOrFailedRequest=function(e){if(e&&this.abortControllersMap[e]){var t=this.abortControllersMap[e].controllers||[];this.abortControllersMap[e].doneRequestsCount?this.abortControllersMap[e].doneRequestsCount+=1:this.abortControllersMap[e].doneRequestsCount=1,this.abortControllersMap[e].doneRequestsCount===t.length&&delete this.abortControllersMap[e]}},e.prototype.ajax=function(e){return U(this,void 0,void 0,(function(){var t,n=this;return _(this,(function(r){return t=++this.requestsNumber,[2,new Promise((function(r,i){n.logRequest(e,t);var o,s=n.buildRequestAndURL(e),a=s[0],c=s[1],u=e.abort_id;if(u){var l=0;if(n.abortControllersMap[u]){var d=n.abortControllersMap[u].controllers||[];n.abortControllersMap[u].controllers.push(new AbortController),l=d.length-1}else n.abortControllersMap[u]={controllers:[new AbortController]};var p=n.abortControllersMap[u].controllers[l].signal;Object.assign(a,{signal:p})}S(c,a).then((function(t){return o=t,(e.dataType||q.JSON)===q.TEXT?o.text():o.json()})).then((function(s){n.processSuccessfulOrFailedRequest(u),o.ok?n.processAjaxResponse(s,r,t):n.processAjaxError(o,s,null,i,r,e,t)})).catch((function(s){n.processSuccessfulOrFailedRequest(u),n.processAjaxError(o," ",s,i,r,e,t)}))}))]}))}))},e.prototype.processAjaxResponse=function(e,t,n){var r=e&&" "!==e?e:"empty body";this.logResponse(r,n),t(e)},e.prototype.processAjaxError=function(e,t,n,r,i,o,s){if(e||!n||n.code){var a=null==e?void 0:e.status,c={code:e&&a||n&&n.code,info:(t&&"string"==typeof t&&" "!==t?JSON.parse(t):t)||n&&n.errno},u=t||n||t.errors;this.logResponse(u,s),-1===(null==e?void 0:e.url.indexOf(M.urls.session))&&this.isExpiredSessionError(c)&&"function"==typeof M.on.sessionExpired?this.handleExpiredSessionResponse(c,null,r,i,o):r(c)}else r(n)},e.prototype.handleExpiredSessionResponse=function(e,t,n,r,i){var o=this;"function"==typeof M.on.sessionExpired&&M.on.sessionExpired((function(){e?n(e):r(t)}),(function(e){e&&(o.setSession(e),o.ajax(i).then(r).catch(n))}))},e.prototype.isExpiredSessionError=function(e){var t,n,r;try{return e&&401===e.code&&"Required session does not exist"===(null===(r=null===(n=null===(t=e.info)||void 0===t?void 0:t.errors)||void 0===n?void 0:n.base)||void 0===r?void 0:r[0])}catch(e){return!1}},e}(),Ae=function(e){this.base64Encode=g,this.proxy=e,this.subscriptions=new Re(e),this.events=new Oe(e)},Re=function(){function e(e){this.route=M.urls.subscriptions,this.proxy=e}return e.prototype.create=function(e){return U(this,void 0,void 0,(function(){var t;return _(this,(function(n){return t={type:V.POST,url:F.getUrl(this.route),data:e},[2,this.proxy.ajax(t)]}))}))},e.prototype.list=function(){return U(this,void 0,void 0,(function(){var e;return _(this,(function(t){return e={type:V.GET,url:F.getUrl(this.route)},[2,this.proxy.ajax(e)]}))}))},e.prototype.delete=function(e){return U(this,void 0,void 0,(function(){var t;return _(this,(function(n){return t={type:V.DELETE,dataType:q.TEXT,url:F.getUrl(this.route,e)},[2,this.proxy.ajax(t)]}))}))},e}(),Oe=function(){function e(e){this.route=M.urls.events,this.proxy=e}return e.prototype.create=function(e){return U(this,void 0,void 0,(function(){var t;return _(this,(function(n){return t={type:V.POST,url:F.getUrl(this.route),data:{event:e}},[2,this.proxy.ajax(t)]}))}))},e}(),Pe=function(){function e(e){this.route=M.urls.blobs,this.proxy=e}return e.prototype.list=function(){return U(this,arguments,void 0,(function(e){var t;return void 0===e&&(e={}),_(this,(function(n){return t={type:V.GET,url:F.getUrl(this.route),data:e},[2,this.proxy.ajax(t)]}))}))},e.prototype.create=function(e){return U(this,void 0,void 0,(function(){var t;return _(this,(function(n){return t={type:V.POST,url:F.getUrl(this.route),data:{blob:e}},[2,this.proxy.ajax(t)]}))}))},e.prototype.delete=function(e){return U(this,void 0,void 0,(function(){var t;return _(this,(function(n){return t={type:V.DELETE,url:F.getUrl(this.route,e),dataType:q.TEXT},[2,this.proxy.ajax(t)]}))}))},e.prototype.createAndUpload=function(e){return U(this,void 0,void 0,(function(){var t,n,r,i,o,s,a,c,u=this;return _(this,(function(l){return t=e.name,n=e.file,r=e.size,i=e.abort_id,o=e.type,s=e.public,a={name:t,content_type:o,public:void 0===s||s},[2,this.create(a).then((function(e){var t,r=e.blob;c=r;var o=u.parseUri(null===(t=c.blob_object_access)||void 0===t?void 0:t.params),s={url:"".concat(o.protocol,"://").concat(o.authority).concat(o.path),data:{}};return i&&(s.abort_id=i),Object.keys(o.queryKey).forEach((function(e){s.data[e]=decodeURIComponent(o.queryKey[e])})),s.data.file=n,u.upload(s).then((function(){return c}))})).then((function(e){return u.markUploaded({id:e.id,size:r}).then((function(){return e}))})).then((function(e){return N(N({},e),{size:r})}))]}))}))},e.prototype.upload=function(e){return U(this,void 0,void 0,(function(){var t;return _(this,(function(n){return t=N(N({},e),{type:V.POST,dataType:q.TEXT,contentType:!1}),[2,this.proxy.ajax(t)]}))}))},e.prototype.markUploaded=function(e){return U(this,void 0,void 0,(function(){var t;return _(this,(function(n){return t={type:V.PUT,url:F.getUrl(this.route,e.id,"complete"),data:{size:e.size},dataType:q.TEXT},[2,this.proxy.ajax(t)]}))}))},e.prototype.getInfo=function(e){return U(this,void 0,void 0,(function(){var t;return _(this,(function(n){return t={url:F.getUrl(this.route,e)},[2,this.proxy.ajax(t)]}))}))},e.prototype.getFile=function(e){return U(this,void 0,void 0,(function(){var t;return _(this,(function(n){return t={url:F.getUrl(this.route,e)},[2,this.proxy.ajax(t)]}))}))},e.prototype.getFileObject=function(e,t){return U(this,void 0,void 0,(function(){var n;return _(this,(function(r){return n={type:V.GET,url:F.getUrl(this.route,e,"object"),data:t},[2,this.proxy.ajax(n)]}))}))},e.prototype.update=function(e){return U(this,void 0,void 0,(function(){var t,n;return _(this,(function(r){return t={blob:{}},void 0!==e.name&&(t.blob.name=e.name),n={url:F.getUrl(this.route,e.id),data:t},[2,this.proxy.ajax(n)]}))}))},e.prototype.privateUrl=function(e){var t;return void 0===e&&(e=""),"https://".concat(M.endpoints.api,"/blobs/").concat(e,"?token=").concat(null===(t=this.proxy.getSession())||void 0===t?void 0:t.token)},e.prototype.publicUrl=function(e){return void 0===e&&(e=""),"https://".concat(M.endpoints.api,"/blobs/").concat(e)},e.prototype.parseUri=function(e){var t;void 0===e&&(e="");for(var n={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},r=null!==(t=n.parser.loose.exec(e))&&void 0!==t?t:{},i={},o=14;o--;)i[n.key[o]]=r[o]||"";return i[n.q.name]={},i[n.key[12]].replace(n.q.parser,(function(e,t,r){t&&(i[n.q.name][t]=r)})),i},e}(),Le=function(){function e(e){this.route=M.urls.users,this.proxy=e}return e.prototype.getV2=function(e){return U(this,void 0,void 0,(function(){var t;return _(this,(function(n){return t={type:V.GET,url:F.getUrl(this.route,"v2"),useArrayQuery:!0,data:e},[2,this.proxy.ajax(t)]}))}))},e.prototype.signup=function(e,t){return U(this,void 0,void 0,(function(){var n;return _(this,(function(r){return n={authKey:null!=t?t:M.creds.authKey,type:V.POST,url:F.getUrl(this.route),data:{user:e}},[2,this.proxy.ajax(n)]}))}))},e.prototype.update=function(){return U(this,arguments,void 0,(function(e){var t;return void 0===e&&(e={}),_(this,(function(n){return t={type:V.PUT,url:F.getUrl(this.route,this.proxy.getCurrentUserId()),data:{user:e}},[2,this.proxy.ajax(t)]}))}))},e.prototype.delete=function(){return U(this,void 0,void 0,(function(){var e;return _(this,(function(t){return e={type:V.DELETE,url:F.getUrl(this.route,this.proxy.getCurrentUserId()),dataType:q.TEXT},[2,this.proxy.ajax(e)]}))}))},e.prototype.resetPassword=function(){return U(this,arguments,void 0,(function(e){var t;return void 0===e&&(e=""),_(this,(function(n){return t={type:V.POST,url:F.getUrl(this.route,"password","reset"),data:{email:e},dataType:q.TEXT},[2,this.proxy.ajax(t)]}))}))},e.prototype.get=function(e){return U(this,void 0,void 0,(function(){function t(e){var t=F.cloneObject(e),n=o.includes(t.field)?"date":typeof t.value;return F.isArray(t.value)&&("object"===n&&(n=typeof t.value[0]),t.value=t.value.toString()),[n,t.field,t.param,t.value].join(" ")}var n,r,i,o,s,a,c,u,l;return _(this,(function(d){if(n=F.cloneObject(e),r="",i=[],o=["created_at","updated_at","last_request_at"],s=["id","external_user_id"],a={login:"by_login",full_name:"by_full_name",facebook_id:"by_facebook_id",twitter_id:"by_twitter_id",phone:"phone",email:"by_email",tags:"by_tags",external:"external"},n.order&&(c=n.order.field in o?"date":n.order.field in s?"number":"string",n.order=[n.order.sort,c,n.order.field].join(" ")),n&&n.filter&&(F.isArray(n.filter)?n.filter.forEach((function(e){i.push(t(e))})):i.push(t(n.filter)),n.filter=i),"number"==typeof n)r=n,n=void 0;else for(u in a)if(n[u]){r=a[u],u===a.external&&(r+="/".concat(n[a.external]),n=void 0);break}return l={type:V.GET,url:F.getUrl(this.route,r),data:n},[2,this.proxy.ajax(l)]}))}))},e}(),je=function(){function e(){}return e.getUserJid=function(e){return"".concat(e,"-").concat(M.creds.appId,"@").concat(M.endpoints.chat)},e.getUserIdFromJID=function(e){return(null==e?void 0:e.includes("@"))?parseInt(e.split("@")[0].split("-")[0]):null},e.trace=function(e){M.debug&&console.log("[VideoChat]:",e)},e.traceWarning=function(e){M.debug&&console.warn("[VideoChat]:",e)},e.traceError=function(e){M.debug&&console.error("[VideoChat]:",e)},Object.defineProperty(e,"getVersionFirefox",{get:function(){var e,t=null!==(e=null===navigator||void 0===navigator?void 0:navigator.userAgent)&&void 0!==e?e:null,n=0;if(t){var r=t.match(/(?:firefox)[ \/](\d+)/i)||[];n=r[1]?+r[1]:0}return"string"==typeof n?parseInt(n):n},enumerable:!1,configurable:!0}),Object.defineProperty(e,"getVersionSafari",{get:function(){var e,t=null!==(e=null===navigator||void 0===navigator?void 0:navigator.userAgent)&&void 0!==e?e:null,n=0;if(t&&(t.match(/(?:safari)[ \/](\d+)/i)||[]).length){var r=t.match(/(?:version)[ \/](\d+)/i)||[];r&&(n=r[1]?+r[1]:0)}return"string"==typeof n?parseInt(n):n},enumerable:!1,configurable:!0}),e}();!function(e){e.CALL="call",e.ACCEPT="accept",e.REJECT="reject",e.STOP="hangUp",e.RESTART="iceRestart",e.RESTART_ACCEPT="iceRestartAccept",e.CANDIDATE="iceCandidates"}(ve||(ve={})),function(e){e[e.UNDEFINED=0]="UNDEFINED",e[e.CONNECTING=1]="CONNECTING",e[e.CONNECTED=2]="CONNECTED",e[e.FAILED=3]="FAILED",e[e.DISCONNECTED=4]="DISCONNECTED",e[e.CLOSED=5]="CLOSED",e[e.COMPLETED=6]="COMPLETED"}(ye||(ye={})),function(e){e[e.NEW=1]="NEW",e[e.ACTIVE=2]="ACTIVE",e[e.HUNGUP=3]="HUNGUP",e[e.REJECTED=4]="REJECTED",e[e.CLOSED=5]="CLOSED"}(be||(be={})),function(e){e[e.NEW=1]="NEW",e[e.CONNECTING=2]="CONNECTING",e[e.CHECKING=3]="CHECKING",e[e.CONNECTED=4]="CONNECTED",e[e.DISCONNECTED=5]="DISCONNECTED",e[e.FAILED=6]="FAILED",e[e.CLOSED=7]="CLOSED",e[e.COMPLETED=8]="COMPLETED"}(Ce||(Ce={})),function(e){e[e.VIDEO=1]="VIDEO",e[e.AUDIO=2]="AUDIO"}(Se||(Se={})),function(e){e.CALL="call",e.ACCEPT="accept",e.REJECT="reject",e.HUNG_UP="hang-up",e.INVALID="invalid",e.NOT_ANSWER="not-answer",e.REMOTE_STREAM="remote-stream",e.CONNECTION_STATE="connection-state",e.CLOSE="close",e.STATS_REPORT="stats-report",e.DEVICES="devices"}(Te||(Te={}));var Me=function(){function e(e,t,n){var r=this;this.remoteSDP=null,this.state=Ce.NEW,this.iceCandidates=[],this.remoteStream=new E,this.answerTimeInterval=0,this.onStatusClosedChecker=null,this.dialingTimer=null,this.statsReportTimer=null,this.waitingReconnectTimeoutCallback=null,this.released=!1,this.onMediaTrackHandler=function(e){r.remoteStream.addTrack(e.track),(1==r.session.callType&&r.remoteStream.getVideoTracks().length||2==r.session.callType&&r.remoteStream.getAudioTracks().length)&&r.session.onRemoteStream(r.userID,r.remoteStream),r.getWrappedStats()},this.onIceCandidateHandler=function(e){if(e.candidate){var t=e.candidate,n={sdpMLineIndex:t.sdpMLineIndex,sdpMid:t.sdpMid,candidate:t.candidate};"stable"===r.signalingState?r.session.processIceCandidates(r.userID,[n]):r.iceCandidates.push(n)}},this.onSignalingStateHandler=function(){je.trace("onSignalingStateHandler: ".concat(r.signalingState)),"stable"===r.signalingState&&r.iceCandidates.length>0&&(r.session.processIceCandidates(r.userID,r.iceCandidates),r.iceCandidates.length=0)},this.onIceConnectionStateHandler=function(){switch(je.trace("onIceConnectionStateHandler: ".concat(r.iceConnectionState)),r.onStatusClosedChecker&&je.getVersionSafari>=11&&clearTimeout(r.onStatusClosedChecker),r.iceConnectionState){case"checking":r.state=Ce.CHECKING,r.session.onSessionConnectionStateChanged(r.userID,ye.CONNECTING);break;case"connected":r.state=Ce.CONNECTED,r.clearWaitingReconnectTimer(),r.session.onSessionConnectionStateChanged(r.userID,ye.CONNECTED);break;case"completed":r.state=Ce.COMPLETED,r.clearWaitingReconnectTimer(),r.session.onSessionConnectionStateChanged(r.userID,ye.COMPLETED);break;case"failed":r.state=Ce.FAILED,r.session.onSessionConnectionStateChanged(r.userID,ye.FAILED);break;case"disconnected":r.state=Ce.DISCONNECTED,r.startWaitingReconnectTimer(),r.session.onSessionConnectionStateChanged(r.userID,ye.DISCONNECTED),je.getVersionSafari>=11&&(r.onStatusClosedChecker=setTimeout((function(){r.onIceConnectionStateHandler()}),500));break;case"closed":r.state=Ce.CLOSED,r.clearWaitingReconnectTimer(),r.session.onSessionConnectionStateChanged(r.userID,ye.CLOSED)}},this.create(),this.setup(e,t,n)}return e.prototype.create=function(){var e={iceTransportPolicy:M.videochat.alwaysRelayCalls?"relay":"all",iceServers:M.videochat.iceServers.map((function(e){var t;return{urls:null!==(t=e.urls)&&void 0!==t?t:e.url,username:e.username,credential:e.credential}}))};this.original=D?new D(e):{},je.trace("new RTCPeerConnection(".concat(JSON.stringify(e,null,2),")"))},e.prototype.setup=function(e,t,n){this.type=n,this.userID=t,this.session=e,this.session.startCallTime=new Date,this.original.ontrack=this.onMediaTrackHandler,this.original.onicecandidate=this.onIceCandidateHandler,this.original.onsignalingstatechange=this.onSignalingStateHandler,this.original.oniceconnectionstatechange=this.onIceConnectionStateHandler,je.trace("RTCPeerConnection init. userID: ".concat(t,", sessionID: ").concat(e.ID,", type: ").concat(n))},e.prototype.clearWaitingReconnectTimer=function(){this.waitingReconnectTimeoutCallback&&(je.trace("clearWaitingReconnectTimer"),clearTimeout(this.waitingReconnectTimeoutCallback),this.waitingReconnectTimeoutCallback=null)},e.prototype.startWaitingReconnectTimer=function(){var e=this,t=1e3*M.videochat.disconnectTimeInterval;je.trace("startWaitingReconnectTimer, timeout: ".concat(t)),this.waitingReconnectTimeoutCallback=setTimeout((function(){je.trace("waitingReconnectTimeoutCallback"),e.waitingReconnectTimeoutCallback&&clearTimeout(e.waitingReconnectTimeoutCallback),e.release(),e.session.closeSessionIfAllConnectionsClosed()}),t)},e.prototype.clearStatsReportTimer=function(){this.statsReportTimer&&(clearInterval(this.statsReportTimer),this.statsReportTimer=null)},e.prototype.addCandidates=function(e){return U(this,void 0,void 0,(function(){var t,n=this;return _(this,(function(r){return t=e.reduce((function(e,t){var r=t.sdpMLineIndex,i=t.sdpMid,o=t.candidate;if(o){var s=new x({sdpMLineIndex:r,sdpMid:i,candidate:o}),a=n.addIceCandidate(s).catch((function(e){je.traceError("Error on 'addIceCandidate': ".concat(e))}));e.push(a)}return e}),[]),[2,Promise.all(t)]}))}))},e.prototype.release=function(){this.clearDialingTimer(),this.clearStatsReportTimer(),this.close(),je.getVersionSafari>=11&&this.onIceConnectionStateHandler(),this.released=!0},e.prototype.clearDialingTimer=function(){this.dialingTimer&&(je.trace("clearDialingTimer"),clearInterval(this.dialingTimer),this.dialingTimer=null,this.answerTimeInterval=0)},e.prototype.getAndSetLocalSessionDescription=function(e){return U(this,arguments,void 0,(function(e,t){var n,r,i;return void 0===t&&(t=!1),_(this,(function(o){switch(o.label){case 0:this.state=Ce.CONNECTING,o.label=1;case 1:return o.trys.push([1,8,,9]),n=t?{iceRestart:t}:void 0,"offer"!==this.type?[3,3]:[4,this.createOffer(n)];case 2:return i=o.sent(),[3,5];case 3:return[4,this.createAnswer()];case 4:i=o.sent(),o.label=5;case 5:return r=i,[4,this.setLocalDescription(r)];case 6:return o.sent(),[4,this.setRTCRtpSenderMaxBandwidth(e)];case 7:return o.sent(),[2,r];case 8:throw o.sent();case 9:return[2]}}))}))},e.prototype.setRTCRtpSenderMaxBandwidth=function(e){return U(this,void 0,void 0,(function(){var t,n,r=this;return _(this,(function(i){return t=this.getSenders()||[],n=t.reduce((function(t,n){var i,o;if("video"===(null===(i=n.track)||void 0===i?void 0:i.kind)){var s=n.getParameters();s.encodings||(s.encodings=[]),e?s.encodings[0].maxBitrate=1e3*e:null===(o=s.encodings[0])||void 0===o||delete o.maxBitrate,t.push(n.setParameters(s).then((function(){je.trace("Set maxBandwidth success [".concat(r.userID,"]: ").concat(e," kbps"))})).catch((function(e){je.trace("Set maxBandwidth error [".concat(r.userID,"]: ").concat(e))})))}return t}),[]),[2,Promise.all(n)]}))}))},e.prototype.startDialingTimer=function(e,t){var n=this,r=1e3*M.videochat.dialingTimeInterval;je.trace("startDialingTimer, dialingTimeInterval: ".concat(JSON.stringify(r)));var i=function(e,t,r){r||(n.answerTimeInterval+=1e3*M.videochat.dialingTimeInterval),je.trace("dialingCallback, extension: ".concat(JSON.stringify(e))),n.answerTimeInterval>=1e3*M.videochat.answerTimeInterval?(n.clearDialingTimer(),t&&n.session.processOnNotAnswer(n)):n.session.processCall(n,e)};this.dialingTimer=setInterval(i,r,e,t,!1),i(e,t,!0)},e.prototype.setRemoteSessionDescription=function(e,t){return U(this,void 0,void 0,(function(){var n;return _(this,(function(r){return n=new O({sdp:t,type:e}),[2,this.setRemoteDescription(n)]}))}))},e.prototype.getWrappedStats=function(){var e,t=this;M.videochat.statsReportTimeInterval&&(je.trace("Stats tracker has been started"),this.statsReportTimer=setInterval((function(){t.getStatsCustom(e,(function(n,r){e=r,t.session.onCallStatsReport(t.userID,n)}),(function(e){je.traceError("Get stats error. ".concat(e.name,": ").concat(e.message)),t.session.onCallStatsReport(t.userID,null,e)}))}),1e3*M.videochat.statsReportTimeInterval))},Object.defineProperty(e.prototype,"sdpRemote",{get:function(){return this.remoteSDP},set:function(e){e&&(this.remoteSDP=e)},enumerable:!1,configurable:!0}),e.prototype.toString=function(){return"sessionID: ".concat(this.session.ID,", userID: ").concat(this.userID,", type: ").concat(this.type,", state: ").concat(this.state)},e.prototype.getStatsCustom=function(e,t,n){var r=this,i={audio:{},video:{},candidate:{}},o={local:Object.assign({},i),remote:Object.assign({},i)};if(je.getVersionFirefox){var s=this.session.localStream,a=null==s?void 0:s.getVideoTracks()[0].getSettings();a&&(o.local.video.frameHeight=a.height,o.local.video.frameWidth=a.width)}this.getStats().then((function(n){n.forEach((function(t){var n;t.bytesReceived&&"inbound-rtp"===t.type?((n=o.remote[t.mediaType]).bitrate=r.getBitratePerSecond(t,e,!1),n.bytesReceived=t.bytesReceived,n.packetsReceived=t.packetsReceived,n.timestamp=t.timestamp,"video"===t.mediaType&&t.framerateMean&&(n.framesPerSecond=Math.round(10*t.framerateMean)/10)):t.bytesSent&&"outbound-rtp"===t.type?((n=o.local[t.mediaType]).bitrate=r.getBitratePerSecond(t,e,!0),n.bytesSent=t.bytesSent,n.packetsSent=t.packetsSent,n.timestamp=t.timestamp,"video"===t.mediaType&&t.framerateMean&&(n.framesPerSecond=Math.round(10*t.framerateMean)/10)):"local-candidate"===t.type?(n=o.local.candidate,"host"===t.candidateType&&"udp"===t.mozLocalTransport&&"udp"===t.transport?(n.protocol=t.transport,n.ip=t.ipAddress,n.port=t.portNumber):je.getVersionFirefox||(n.protocol=t.protocol,n.ip=t.ip,n.port=t.port)):"remote-candidate"===t.type?((n=o.remote.candidate).protocol=t.protocol||t.transport,n.ip=t.ip||t.ipAddress,n.port=t.port||t.portNumber):"track"!==t.type||"video"!==t.kind||je.getVersionFirefox||(t.remoteSource?((n=o.remote.video).frameHeight=t.frameHeight,n.frameWidth=t.frameWidth,n.framesPerSecond=r.getFramesPerSecond(t,e,!1)):((n=o.local.video).frameHeight=t.frameHeight,n.frameWidth=t.frameWidth,n.framesPerSecond=r.getFramesPerSecond(t,e,!0)))})),t(o,n)}),n)},e.prototype.getBitratePerSecond=function(e,t,n){var r=t.get(e.id),i=r?(e.timestamp-r.timestamp)/1e3:5,o=r?n?8*(e.bytesSent-r.bytesSent)/(1024*i):8*(e.bytesReceived-r.bytesReceived)/(1024*i):0;return Math.round(o)},e.prototype.getFramesPerSecond=function(e,t,n){var r=t&&t.get(e.id),i=r?(e.timestamp-r.timestamp)/1e3:5,o=r?n?(e.framesSent-r.framesSent)/i:(e.framesReceived-r.framesReceived)/i:0;return Math.round(10*o)/10},e.prototype.getSenders=function(){var e,t,n;return null!==(n=null===(t=(e=this.original).getSenders)||void 0===t?void 0:t.call(e))&&void 0!==n?n:[]},e.prototype.createOffer=function(e){var t,n,r;return null!==(r=null===(n=(t=this.original).createOffer)||void 0===n?void 0:n.call(t,e))&&void 0!==r?r:Promise.resolve({})},e.prototype.createAnswer=function(e){var t,n,r;return null!==(r=null===(n=(t=this.original).createAnswer)||void 0===n?void 0:n.call(t,e))&&void 0!==r?r:Promise.resolve({})},e.prototype.setRemoteDescription=function(e){var t,n,r;return null!==(r=null===(n=(t=this.original).setRemoteDescription)||void 0===n?void 0:n.call(t,e))&&void 0!==r?r:Promise.resolve()},e.prototype.setLocalDescription=function(e){var t,n,r;return null!==(r=null===(n=(t=this.original).setLocalDescription)||void 0===n?void 0:n.call(t,e))&&void 0!==r?r:Promise.resolve()},e.prototype.getStats=function(){var e,t,n;return null!==(n=null===(t=(e=this.original).getStats)||void 0===t?void 0:t.call(e))&&void 0!==n?n:Promise.resolve(new Map)},e.prototype.close=function(){var e,t;null===(t=(e=this.original).close)||void 0===t||t.call(e)},e.prototype.addIceCandidate=function(e){var t,n,r;return null!==(r=null===(n=(t=this.original).addIceCandidate)||void 0===n?void 0:n.call(t,e))&&void 0!==r?r:Promise.resolve()},e.prototype.addTrack=function(e,t){var n,r,i;return null!==(i=null===(r=(n=this.original).addTrack)||void 0===r?void 0:r.call(n,e,t))&&void 0!==i?i:{}},Object.defineProperty(e.prototype,"localDescription",{get:function(){var e;return null!==(e=this.original.localDescription)&&void 0!==e?e:{type:"",sdp:""}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"signalingState",{get:function(){var e;return null!==(e=this.original.signalingState)&&void 0!==e?e:"closed"},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"iceConnectionState",{get:function(){var e;return null!==(e=this.original.iceConnectionState)&&void 0!==e?e:"closed"},enumerable:!1,configurable:!0}),e}(),Ne=function(){function e(e){var t,n,r;this.ID=null,this.state=be.NEW,this.maxBandwidth=0,this.peerConnections={},this.mediaParams={},this.answerTimer=null,this.waitingOfferOrAnswerTimer=null,Object.assign(this,e,{ID:null!==(t=e.ID)&&void 0!==t?t:(n=(new Date).getTime(),r="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=(n+16*Math.random())%16|0;return n=Math.floor(n/16),("x"==e?t:3&t|8).toString(16)})),r)})}return e.prototype.getDisplayMedia=function(e){return U(this,void 0,void 0,(function(){var t,n,r,i;return _(this,(function(o){switch(o.label){case 0:if(!I.getDisplayMedia)throw new Error("Your environment does not support 'getDisplayMedia' API");t=e&&e.elementId,n=e&&e.options,r=N({},e),this.mediaParams=r,delete r.elementId,delete r.options,o.label=1;case 1:return o.trys.push([1,3,,4]),[4,I.getDisplayMedia(r)];case 2:return i=o.sent(),[2,this.upsertStream(i,t,n)];case 3:throw o.sent();case 4:return[2]}}))}))},e.prototype.getUserMedia=function(e){return U(this,void 0,void 0,(function(){var t,n,r,i;return _(this,(function(o){switch(o.label){case 0:t=e&&e.elementId,n=e&&e.options,r=N({},e),this.mediaParams=r,delete r.elementId,delete r.options,o.label=1;case 1:return o.trys.push([1,3,,4]),[4,I.getUserMedia(r)];case 2:return i=o.sent(),[2,this.upsertStream(i,t,n)];case 3:throw o.sent();case 4:return[2]}}))}))},e.prototype.upsertStream=function(e,t,n){var r=!!this.localStream;if(r?this.replaceTracks(e):this.localStream=e,!this.localStream)throw new Error("Local stream is not defined");return t&&(r&&this.detachMediaStream(t,n),this.attachMediaStream(t,this.localStream,n)),this.localStream},e.prototype.replaceTracks=function(e){var t,n=this;if(null===(t=this.localStream)||void 0===t||t.getTracks().forEach((function(t){var r;"audio"===t.kind&&0===e.getAudioTracks().length||(t.stop(),null===(r=n.localStream)||void 0===r||r.removeTrack(t))})),e.getTracks().forEach((function(e){var t,r,i,o,s;"audio"===e.kind?e.enabled=null===(r=null===(t=n.localStream)||void 0===t?void 0:t.getAudioTracks().every((function(e){return e.enabled})))||void 0===r||r:e.enabled=null===(o=null===(i=n.localStream)||void 0===i?void 0:i.getVideoTracks().every((function(e){return e.enabled})))||void 0===o||o,e&&(Object.values(n.peerConnections).forEach((function(t){var n;null===(n=t.getSenders().find((function(t){var n=t.track;return e.kind===(null==n?void 0:n.kind)})))||void 0===n||n.replaceTrack(e)})),null===(s=n.localStream)||void 0===s||s.addTrack(e))})),!this.localStream)throw new Error("Local stream is not defined");return this.localStream},e.prototype.setMaxBandwidth=function(e){return U(this,void 0,void 0,(function(){var t,n;return _(this,(function(r){return t=this.peerConnections,(n=Object.keys(t)).length<1?(je.trace("No 'RTCPeerConnection' to set 'maxBandwidth'"),[2]):[2,Promise.all(n.map((function(n){return t[n].setRTCRtpSenderMaxBandwidth(e)})))]}))}))},e.prototype.connectionStateForUser=function(e){var t=this.peerConnections[e];return t?t.state:null},e.prototype.attachMediaStream=function(e,t,n){var r=document.getElementById(e);if(!("srcObject"in r))throw new Error("Unable to attach media stream, element #".concat(e," is undefined"));r.srcObject=t,r.style.transform=(null==n?void 0:n.mirror)?"scaleX(-1)":"none","boolean"==typeof(null==n?void 0:n.muted)&&(r.muted=null==n?void 0:n.muted),r.onloadedmetadata=function(e){r.play()}},e.prototype.detachMediaStream=function(e,t){var n=document.getElementById(e);if(!("srcObject"in n))throw new Error("Unable to attach media stream, element #".concat(e," is undefined"));n.pause(),n.srcObject=null,n.style.transform=(null==t?void 0:t.mirror)?"scaleX(-1)":"none","boolean"==typeof(null==t?void 0:t.muted)&&(n.muted=null==t?void 0:t.muted)},e.prototype.switchMediaTracks=function(){return U(this,arguments,void 0,(function(e){var t,n,r=this;return void 0===e&&(e={}),_(this,(function(i){switch(i.label){case 0:F.DLog("switchMediaTracks:",e),["audio","video"].forEach((function(t){var n="audio"===t?e.audio:"audio"===t?e.video:{},i="string"==typeof n?n:null==n?void 0:n.deviceId;i&&("object"!=typeof r.mediaParams[t]?r.mediaParams[t].deviceId=i:r.mediaParams[t]={deviceId:i})})),i.label=1;case 1:return i.trys.push([1,3,,4]),t={audio:this.mediaParams.audio||!1,video:this.mediaParams.video||!1},[4,I.getUserMedia(t)];case 2:return n=i.sent(),[2,this.replaceTracks(n)];case 3:throw i.sent();case 4:return[2]}}))}))},e.prototype.call=function(e){var t,n,r=this;void 0===e&&(e={});var i=Ue(e);je.trace("Call, extension: ".concat(JSON.stringify(i))),this.state=be.ACTIVE,this.maxBandwidth=Number(null!==(n=null===(t=i.userInfo)||void 0===t?void 0:t.maxBandwidth)&&void 0!==n?n:0),this.opponentsIDs.forEach((function(e){r.callInternal(e,i,!0)}))},e.prototype.callInternal=function(e,t,n){return U(this,void 0,void 0,(function(){var r,i,o,s=this;return _(this,(function(a){switch(a.label){case 0:r=new Me(this,e,"offer"),null===(o=this.localStream)||void 0===o||o.getTracks().forEach((function(e){s.localStream&&r.addTrack(e,s.localStream)})),this.peerConnections[e]=r,a.label=1;case 1:return a.trys.push([1,3,,4]),[4,r.getAndSetLocalSessionDescription(this.maxBandwidth)];case 2:return a.sent(),r.startDialingTimer(t,n),je.trace("getAndSetLocalSessionDescription success"),[3,4];case 3:return i=a.sent(),je.traceError("getAndSetLocalSessionDescription error: ".concat(i)),[3,4];case 4:return[2]}}))}))},e.prototype.accept=function(e){var t=this;void 0===e&&(e={});var n=Ue(e);if(je.trace("Accept, extension: ".concat(JSON.stringify(n))),this.state!==be.ACTIVE){if(this.state===be.CLOSED)return je.traceError("Can't accept, the session is already closed, return"),void this.stop({});this.state=be.ACTIVE,this.acceptCallTime=new Date,this.clearAnswerTimer(),this.acceptInternal(this.initiatorID,n);var r=this.opponentsIDs.filter((function(e){return e!==t.initiatorID}));r.length>0&&(this.startWaitingOfferOrAnswerTimer(),r.forEach((function(n){t.currentUserID>n&&t.callInternal(n,e,!0)})))}else je.traceError("Can't accept, the session is already active, return")},e.prototype.acceptInternal=function(e,t){return U(this,void 0,void 0,(function(){var n,r,i,o,s=this;return _(this,(function(a){switch(a.label){case 0:if(!(n=this.peerConnections[e])||!n.sdpRemote)return je.traceError("Can't accept the call, there is no information about peer connection by some reason"),[2];null===(o=this.localStream)||void 0===o||o.getTracks().forEach((function(e){s.localStream&&n.addTrack(e,s.localStream)})),a.label=1;case 1:return a.trys.push([1,4,,5]),[4,n.setRemoteSessionDescription("offer",n.sdpRemote)];case 2:return a.sent(),[4,n.getAndSetLocalSessionDescription(this.maxBandwidth)];case 3:return a.sent(),r=Object.assign({},t,{sessionID:this.ID,callType:this.callType,callerID:this.initiatorID,opponentsIDs:this.opponentsIDs,sdp:n.localDescription.sdp}),this.signalingProvider.sendMessage(e,r,ve.ACCEPT),[3,5];case 4:return i=a.sent(),je.traceError("[acceptInternal] Error: ".concat(i)),[3,5];case 5:return[2]}}))}))},e.prototype.reject=function(e){var t=this;void 0===e&&(e={});var n=Ue(e);je.trace("Reject, extension: ".concat(JSON.stringify(n.userInfo))),this.state=be.REJECTED,this.clearAnswerTimer(),Object.assign(n,{sessionID:this.ID,callType:this.callType,callerID:this.initiatorID,opponentsIDs:this.opponentsIDs}),Object.keys(this.peerConnections).forEach((function(e){t.signalingProvider.sendMessage(Number(e),n,ve.REJECT)})),this.close()},e.prototype.stop=function(e){var t=this;void 0===e&&(e={});var n=Ue(e);je.trace("Stop, extension: ".concat(JSON.stringify(n.userInfo))),this.state=be.HUNGUP,this.answerTimer&&this.clearAnswerTimer(),Object.assign(n,{sessionID:this.ID,callType:this.callType,callerID:this.initiatorID,opponentsIDs:this.opponentsIDs}),Object.keys(this.peerConnections).forEach((function(e){t.signalingProvider.sendMessage(Number(e),n,ve.STOP)})),this.close()},e.prototype.canInitiateIceRestart=function(e){var t;return"offer"===(null===(t=this.peerConnections[e])||void 0===t?void 0:t.type)},e.prototype.iceRestart=function(e){return U(this,void 0,void 0,(function(){var t,n,r,i,o;return _(this,(function(s){switch(s.label){case 0:if(!(t=this.peerConnections[e]))return je.traceError("Can't restart ice, there is no information about peer connection by some reason"),[2];s.label=1;case 1:return s.trys.push([1,3,,4]),[4,t.getAndSetLocalSessionDescription(this.maxBandwidth,!0)];case 2:return n=s.sent().sdp,r={sessionID:null!==(o=this.ID)&&void 0!==o?o:"",sdp:n},this.signalingProvider.sendMessage(e,r,ve.RESTART),je.trace("[iceRestart] OK"),[3,4];case 3:return i=s.sent(),je.traceError("[iceRestart] Error: ".concat(i)),[3,4];case 4:return[2]}}))}))},e.prototype.processOnCall=function(e,t){var n=this;J([this.initiatorID],this.opponentsIDs.filter((function(e){return e!==n.currentUserID})),!0).forEach((function(r){var i=n.peerConnections[r];if(i)r===e&&(i.sdpRemote=t.sdp,e!==n.initiatorID&&n.state===be.ACTIVE&&n.acceptInternal(e,t));else{var o=r!==e&&n.currentUserID>r?"offer":"answer",s=new Me(n,r,o);r===e&&(s.sdpRemote=t.sdp,n.startAnswerTimer()),n.peerConnections[r]=s}}))},e.prototype.processOnAccept=function(e,t){return U(this,void 0,void 0,(function(){var n,r;return _(this,(function(i){switch(i.label){case 0:(n=this.peerConnections[e])||je.traceWarning("Ignore 'OnAccept', there is no information about peer connection by some reason"),i.label=1;case 1:return i.trys.push([1,3,,4]),n.clearDialingTimer(),[4,n.setRemoteSessionDescription("answer",t.sdp)];case 2:return i.sent(),je.trace("'setRemoteSessionDescription' success"),[3,4];case 3:return r=i.sent(),je.traceError("'setRemoteSessionDescription' error: ".concat(r)),[3,4];case 4:return[2]}}))}))},e.prototype.processOnReject=function(e){var t=this.peerConnections[e];this.clearWaitingOfferOrAnswerTimer(),t?t.release():je.traceWarning("Ignore 'OnReject', there is no information about peer connection by some reason"),this.closeSessionIfAllConnectionsClosed()},e.prototype.processOnStop=function(e){var t=this;if(this.clearAnswerTimer(),e===this.initiatorID){var n=Object.keys(this.peerConnections);n.length>0?n.forEach((function(e){t.peerConnections[e].release()})):je.traceWarning("Ignore 'OnStop', there is no information about peer connections by some reason")}else{var r=this.peerConnections[e];r?r.release():je.traceWarning('Ignore "OnStop", there is no information about peer connection by some reason')}this.closeSessionIfAllConnectionsClosed()},e.prototype.processOnIceCandidates=function(e,t){return U(this,void 0,void 0,(function(){var n;return _(this,(function(r){switch(r.label){case 0:return(n=this.peerConnections[e])||je.traceWarning('Ignore "OnIceCandidates", there is no information about peer connection by some reason'),t.iceCandidates?[4,n.addCandidates(t.iceCandidates)]:[3,2];case 1:r.sent(),r.label=2;case 2:return[2]}}))}))},e.prototype.processOnIceRestart=function(e,t){return U(this,void 0,void 0,(function(){var n,r,i,o,s;return _(this,(function(a){switch(a.label){case 0:(n=this.peerConnections[e])||je.traceWarning('Ignore "OnIceRestart", there is no information about peer connection by some reason'),a.label=1;case 1:return a.trys.push([1,4,,5]),[4,n.setRemoteSessionDescription("offer",t.sdp)];case 2:return a.sent(),[4,n.getAndSetLocalSessionDescription(this.maxBandwidth)];case 3:return r=a.sent().sdp,i={sessionID:null!==(s=this.ID)&&void 0!==s?s:"",sdp:r},this.signalingProvider.sendMessage(e,i,ve.RESTART_ACCEPT),je.trace("[processOnIceRestart] Success"),[3,5];case 4:return o=a.sent(),je.traceError("[processOnIceRestart] Error: ".concat(o)),[3,5];case 5:return[2]}}))}))},e.prototype.processOnIceRestartAccept=function(e,t){return U(this,void 0,void 0,(function(){var n,r;return _(this,(function(i){switch(i.label){case 0:(n=this.peerConnections[e])||je.traceWarning('Ignore "OnIceRestartAccept", there is no information about peer connection by some reason'),i.label=1;case 1:return i.trys.push([1,3,,4]),[4,n.setRemoteSessionDescription("answer",t.sdp)];case 2:return i.sent(),je.trace("[processOnIceRestartAccept] Success"),[3,4];case 3:return r=i.sent(),je.traceError("[processOnIceRestartAccept] Error: ".concat(r)),[3,4];case 4:return[2]}}))}))},e.prototype.processCall=function(e,t){void 0===t&&(t={});var n=Object.assign({userInfo:{}},t,{sessionID:this.ID,callType:this.callType,callerID:this.initiatorID,opponentsIDs:this.opponentsIDs,sdp:e.localDescription.sdp});this.signalingProvider.sendMessage(e.userID,n,ve.CALL)},e.prototype.processIceCandidates=function(e,t){var n,r={sessionID:null!==(n=this.ID)&&void 0!==n?n:"",callType:this.callType,callerID:this.initiatorID,opponentsIDs:this.opponentsIDs};this.signalingProvider.sendCandidate(e,t,r)},e.prototype.processOnNotAnswer=function(e){je.trace("Answer timeout callback for session ".concat(this.ID," for user ").concat(e.userID)),this.clearWaitingOfferOrAnswerTimer(),e.release(),F.safeCallbackCall(this.onUserNotAnswerListener)(this,e.userID),this.closeSessionIfAllConnectionsClosed()},e.prototype.onRemoteStream=function(e,t){F.safeCallbackCall(this.onRemoteStreamListener)(this,e,t)},e.prototype.onCallStatsReport=function(e,t,n){F.safeCallbackCall(this.onCallStatsReportListener)(this,e,t,n)},e.prototype.onSessionConnectionStateChanged=function(e,t){F.safeCallbackCall(this.onSessionConnectionStateChangedListener)(this,e,t)},e.prototype.close=function(){Object.values(this.peerConnections).forEach((function(e){try{e.release()}catch(e){F.DLog("Peer close error: ".concat(e))}})),this.closeLocalMediaStream(),this.state=be.CLOSED,F.safeCallbackCall(this.onSessionCloseListener)(this)},e.prototype.closeSessionIfAllConnectionsClosed=function(){var e=!0;Object.values(this.peerConnections).forEach((function(t){var n=!1;try{n="closed"===t.iceConnectionState||"closed"===t.signalingState||t.released}catch(e){je.traceError(e),n=!0}e=n})),je.trace("All peer connections closed: ".concat(e)),e&&(this.closeLocalMediaStream(),F.safeCallbackCall(this.onSessionCloseListener)(this),this.state=be.CLOSED)},e.prototype.closeLocalMediaStream=function(){this.localStream&&(this.localStream.getTracks().forEach((function(e){return e.stop()})),this.localStream=void 0,this.mediaParams={})},e.prototype.mute=function(e){this.muteStream(!1,e)},e.prototype.unmute=function(e){this.muteStream(!0,e)},e.prototype.muteStream=function(e,t){var n,r;void 0===t&&(t="none");var i="audio"===t?null===(n=this.localStream)||void 0===n?void 0:n.getAudioTracks():"video"===t?null===(r=this.localStream)||void 0===r?void 0:r.getVideoTracks():[];null==i||i.forEach((function(t){t.enabled=e}))},e.prototype.clearAnswerTimer=function(){this.answerTimer&&(je.trace("clearAnswerTimer"),clearTimeout(this.answerTimer),this.answerTimer=null)},e.prototype.startAnswerTimer=function(){var e=this;je.trace("startAnswerTimer"),this.answerTimer=setTimeout((function(){je.trace("answerTimeoutCallback"),e.close(),e.answerTimer=null}),1e3*M.videochat.answerTimeInterval)},e.prototype.clearWaitingOfferOrAnswerTimer=function(){this.waitingOfferOrAnswerTimer&&(je.trace("clearWaitingOfferOrAnswerTimer"),clearTimeout(this.waitingOfferOrAnswerTimer),this.waitingOfferOrAnswerTimer=null)},e.prototype.startWaitingOfferOrAnswerTimer=function(){var e=this,t=(this.acceptCallTime-this.startCallTime)/1e3,n=Math.max(M.videochat.answerTimeInterval-t,1);je.trace("startWaitingOfferOrAnswerTimer, timeout: ".concat(n)),this.waitingOfferOrAnswerTimer=setTimeout((function(){je.trace("waitingOfferOrAnswerTimeoutCallback"),Object.values(e.peerConnections).forEach((function(t){t.state!==Ce.CONNECTING&&t.state!==Ce.NEW||e.processOnNotAnswer(t)})),e.waitingOfferOrAnswerTimer=null}),1e3*n)},e.prototype.toString=function(){return"ID: ".concat(this.ID,", initiatorID: ").concat(this.initiatorID,", opponentsIDs: ").concat(this.opponentsIDs,", state: ").concat(this.state,", callType: ").concat(this.callType)},Object.defineProperty(e.prototype,"startCallTime",{get:function(){return this.startCallDate.getTime()},set:function(e){this.startCallDate=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"acceptCallTime",{get:function(){return this.acceptCallDate.getTime()},set:function(e){this.acceptCallDate=e},enumerable:!1,configurable:!0}),e}();function Ue(e){void 0===e&&(e={});var t={userInfo:e};try{F.isObject(e)?t.userInfo=F.cloneObject(e,!0):je.traceWarning('Ignore "prepareExtension", must be an object')}catch(e){je.traceWarning(e.message)}return t}var _e=function(){function e(e){var t=this;this.onMessage=function(e,n){var r,i=t.getExtension(n),o=null!==(r=null==i?void 0:i.sessionID)&&void 0!==r?r:"",s=null==i?void 0:i.signalType;switch(null==i||delete i.moduleIdentifier,null==i||delete i.sessionID,null==i||delete i.signalType,s){case ve.CALL:t.delegate.onCallHandler(e,o,i);break;case ve.ACCEPT:t.delegate.onAcceptHandler(e,o,i);break;case ve.REJECT:t.delegate.onRejectHandler(e,o,i);break;case ve.STOP:t.delegate.onStopHandler(e,o,i);break;case ve.CANDIDATE:t.delegate.onIceCandidatesHandler(e,o,i);break;case ve.RESTART:t.delegate.onIceRestartHandler(e,o,i);break;case ve.RESTART_ACCEPT:t.delegate.onIceRestartAcceptHandler(e,o,i)}},this.delegate=e}return e.prototype.getExtension=function(e){var t,n;if(!e)return{};var r={iceCandidates:[],opponentsIDs:[]};return $.getChildElements(e).forEach((function(e){var t,n=$.getChildElements(e),i=null!==(t=$.getName(e))&&void 0!==t?t:"";switch(i){case"callerID":r[i]=parseInt($.getText(e)||"0");break;case"callType":var o=$.getText(e);r[i]="1"===o?Se.VIDEO:"2"===o?Se.AUDIO:void 0;break;case"iceCandidates":n.forEach((function(e){var t,n={};$.getChildElements(e).forEach((function(e){var t=$.getName(e)||"",r=$.getText(e);n[t]="sdpMLineIndex"===t?parseInt(r||"0"):r})),null===(t=r.iceCandidates)||void 0===t||t.push(n)}));break;case"opponentsIDs":n.forEach((function(e){var t;null===(t=r.opponentsIDs)||void 0===t||t.push(parseInt($.getText(e)||"0"))}));break;default:n.length>1?($.getText(e)||"").length>4096?r[i]=n.reduce((function(e,t){return e+$.getText(t)}),""):$.assignXmlToObject(e,r):"userInfo"===i?$.assignXmlToObject(e,r):r[i]=$.getText(e)}})),0===(null===(t=r.iceCandidates)||void 0===t?void 0:t.length)&&delete r.iceCandidates,0===(null===(n=r.opponentsIDs)||void 0===n?void 0:n.length)&&delete r.opponentsIDs,r},e}(),Je=function(){function e(e){this.signalingConnection=e}return e.prototype.sendCandidate=function(e,t,n){void 0===n&&(n={});var r=Object.assign({},n,{iceCandidates:t});this.sendMessage(e,r,ve.CANDIDATE)},e.prototype.sendMessage=function(e,t,n){var r=Object.assign({},t);r.moduleIdentifier="WebRTCVideoChat",r.signalType=n,r.platform=F.env.isBrowser?"web":F.env.isReactNative||F.env.isExpo?"mobile":"node",r.userInfo&&(Object.keys(r.userInfo).length?0===r.userInfo.maxBandwidth&&delete r.userInfo.maxBandwidth:delete r.userInfo);var i=$.createMessageStanza({to:je.getUserJid(e),type:"headline",id:F.getBsonObjectId()}).c("extraParams",{xmlns:"jabber:client"});Object.keys(r).forEach((function(e){var t=r[e];"iceCandidates"===e?(i=i.c("iceCandidates"),t.forEach((function(e){i=i.c("iceCandidate"),Object.keys(e).forEach((function(t){i=i.c(t).t(e[t]).up()})),i=i.up()})),i=i.up()):"opponentsIDs"===e?(i=i.c("opponentsIDs"),t.forEach((function(e){i=i.c("opponentID").t(e).up()})),i=i.up()):"object"==typeof t?$.assignObjectToXml(i,t,e):i=i.c(e).t(t).up()})),i=i.up(),this.signalingConnection.send(i)},e}(),Ve=function(){function e(e,t){this.SessionConnectionState=ye,this.PeerConnectionState=Ce,this.CallType=Se,this.sessions={},this.onDevicesChangeListener=function(){},this.connection=e,this.proxy=t,this.signalingProcessor=new _e(this),this.signalingProvider=new Je(e),I&&(I.ondevicechange=F.safeCallbackCall(this.onDevicesChangeListener))}return e.prototype.getMediaDevices=function(e){return U(this,void 0,void 0,(function(){var t;return _(this,(function(n){switch(n.label){case 0:return(null==I?void 0:I.enumerateDevices)?[4,I.enumerateDevices()]:[3,2];case 1:return t=n.sent(),[2,e?t.filter((function(t){return t.kind===e})):t];case 2:throw new Error("No 'enumerateDevices' API supported")}}))}))},e.prototype.createNewSession=function(e,t,n){var r,i,o,s,a=null!==(i=null===(r=this.connection.jid)||void 0===r?void 0:r.toString())&&void 0!==i?i:"",c=null!==(o=je.getUserIdFromJID(a))&&void 0!==o?o:0,u=null!==(s=(null==n?void 0:n.maxBandwidth)||(null==n?void 0:n.bandwidth))&&void 0!==s?s:0;if(!e)throw new Error("Can't create a session without opponentsIDs");return this.createAndStoreSession(null,c,e,t,u)},e.prototype.createAndStoreSession=function(e,t,n,r,i){var o,s,a;void 0===i&&(i=0);var c=null!==(s=null===(o=this.connection.jid)||void 0===o?void 0:o.toString())&&void 0!==s?s:"",u=null!==(a=je.getUserIdFromJID(c))&&void 0!==a?a:0,l=new Ne({ID:e,initiatorID:t,opponentsIDs:n,callType:r,signalingProvider:this.signalingProvider,currentUserID:u,maxBandwidth:i});return l.onUserNotAnswerListener=this.onUserNotAnswerListener,l.onRemoteStreamListener=this.onRemoteStreamListener,l.onSessionConnectionStateChangedListener=this.onSessionConnectionStateChangedListener,l.onSessionCloseListener=this.onSessionCloseListener,l.onCallStatsReportListener=this.onCallStatsReport,(null==l?void 0:l.ID)&&(this.sessions[l.ID]=l),l},e.prototype.clearSession=function(e){delete this.sessions[e]},e.prototype.callRejectRequest=function(e){var t={type:V.POST,url:F.getUrl(M.urls.calls,"reject"),data:e};return this.proxy.ajax(t)},e.prototype.onCallHandler=function(e,t,n){var r,i=n.userInfo||{},o=Number(null!==(r=i.maxBandwidth)&&void 0!==r?r:0),s=this.sessions[t];je.trace("onCall. userID: ".concat(e,", sessionID: ").concat(t,", extension: ").concat(JSON.stringify(n))),s||(s=this.createAndStoreSession(t,n.callerID||0,n.opponentsIDs||[],n.callType||Se.VIDEO,o),F.safeCallbackCall(this.onCallListener)(s,i)),s.processOnCall(e,n)},e.prototype.onAcceptHandler=function(e,t,n){var r=this.sessions[t],i=n.userInfo||{};je.trace("onAccept. UserID: ".concat(e,", sessionID: ").concat(t,", extension: ").concat(JSON.stringify(n))),!r||r.state!==be.ACTIVE&&r.state!==be.NEW?je.traceWarning("Ignore 'onAccept', there is no information about session ".concat(t)):(F.safeCallbackCall(this.onAcceptCallListener)(r,e,i),r.processOnAccept(e,n))},e.prototype.onRejectHandler=function(e,t,n){var r=this.sessions[t];if(je.trace("onReject. UserID: ".concat(e,", sessionID: ").concat(t,", extension: ").concat(JSON.stringify(n))),r){var i=n.userInfo||{};F.safeCallbackCall(this.onRejectCallListener)(r,e,i),r.processOnReject(e)}else je.traceWarning("Ignore 'onReject', there is no information about session ".concat(t))},e.prototype.onStopHandler=function(e,t,n){je.trace("onStop. UserID: ".concat(e,", sessionID: ").concat(t,", extension: ").concat(JSON.stringify(n)));var r=this.sessions[t],i=n.userInfo||{};!r||r.state!==be.ACTIVE&&r.state!==be.NEW?(F.safeCallbackCall(this.onInvalidEventsListener)(r,e,i),je.traceWarning("Ignore 'onStop', there is no information about session ".concat(t," by some reason"))):(r.processOnStop(e),F.safeCallbackCall(this.onStopCallListener)(r,e,i))},e.prototype.onIceCandidatesHandler=function(e,t,n){var r,i,o=this.sessions[t];je.trace("onIceCandidates. UserID: ".concat(e,". SessionID: ").concat(t,". ICE candidates count: ").concat(null!==(i=null===(r=n.iceCandidates)||void 0===r?void 0:r.length)&&void 0!==i?i:0)),o?o.state===be.ACTIVE?o.processOnIceCandidates(e,n):je.traceWarning("Ignore 'OnIceCandidates', the session ( ".concat(t," ) has invalid state")):je.traceWarning("Ignore 'OnIceCandidates', there is no information about session ".concat(t))},e.prototype.onIceRestartHandler=function(e,t,n){var r=this.sessions[t];je.trace("onIceRestart. UserID: ".concat(e,". SessionID: ").concat(t,". Extension: ").concat(JSON.stringify(n))),r?r.state===be.ACTIVE?r.processOnIceRestart(e,n):je.traceWarning("Ignore 'OnIceRestart', the session (".concat(t,") has invalid state")):je.traceWarning("Ignore 'OnIceRestart', there is no information about session ".concat(t))},e.prototype.onIceRestartAcceptHandler=function(e,t,n){var r=this.sessions[t];je.trace("onIceRestartAccept. UserID: ".concat(e,". SessionID: ").concat(t,". Extension: ").concat(JSON.stringify(n))),r?r.state===be.ACTIVE?r.processOnIceRestartAccept(e,n):je.traceWarning("Ignore 'onIceRestartAccept', the session (".concat(t,") has invalid state")):je.traceWarning("Ignore 'onIceRestartAccept', there is no information about session ".concat(t))},e.prototype.getListenerByName=function(e){switch(e){case Te.CALL:return"onCallListener";case Te.ACCEPT:return"onAcceptCallListener";case Te.REJECT:return"onRejectCallListener";case Te.HUNG_UP:return"onStopCallListener";case Te.INVALID:return"onInvalidEventsListener";case Te.NOT_ANSWER:return"onUserNotAnswerListener";case Te.REMOTE_STREAM:return"onRemoteStreamListener";case Te.CONNECTION_STATE:return"onSessionConnectionStateChangedListener";case Te.CLOSE:return"onSessionCloseListener";case Te.STATS_REPORT:return"onCallStatsReport";case Te.DEVICES:return"onDevicesChangeListener";default:return null}},e.prototype.addListener=function(e,t){var n=this.getListenerByName(e);return n&&(this[n]=t),this.removeListener.bind(this,e)},e.prototype.removeListener=function(e){var t=this.getListenerByName(e);t&&(this[t]=e===Te.DEVICES?function(){}:void 0)},e.prototype.removeAllListeners=function(){var e=this;Object.keys(this).forEach((function(t){t.startsWith("on")&&t.endsWith("Listener")&&"function"==typeof e[t]&&(e[t]="onDevicesChangeListener"===t?function(){}:void 0)}))},e}(),qe=function(){function e(e){this.route=M.urls.whiteboards,this.server=M.whiteboard.server,this.proxy=e}return e.prototype.getURL=function(e){var t=e.id,n=e.title,r=e.username;return"".concat(this.server,"?whiteboardid=").concat(t,"&username=").concat(r,"&title=").concat(n)},e.prototype.get=function(e){return U(this,void 0,void 0,(function(){var t;return _(this,(function(n){return t={type:V.GET,url:F.getUrl(this.route),data:"string"==typeof e?{chat_dialog_id:e}:e},[2,this.proxy.ajax(t)]}))}))},e.prototype.create=function(e){return U(this,void 0,void 0,(function(){var t;return _(this,(function(n){return t={type:V.POST,url:F.getUrl(this.route),data:e},[2,this.proxy.ajax(t)]}))}))},e.prototype.update=function(e,t){return U(this,void 0,void 0,(function(){var n;return _(this,(function(r){return n={type:V.PUT,url:F.getUrl(this.route,e),data:t},[2,this.proxy.ajax(n)]}))}))},e.prototype.delete=function(e){return U(this,void 0,void 0,(function(){var t;return _(this,(function(n){return t={type:V.DELETE,url:F.getUrl(this.route,e),dataType:q.TEXT},[2,this.proxy.ajax(t)]}))}))},e}(),Fe=new(function(){function e(){this.ConnectyCube=e}return e.prototype.init=function(e,t){void 0===t&&(t={}),t&&"object"==typeof t&&M.set(t),this.utils=F,this.service=new De,this.auth=new W(this.service),this.users=new Le(this.service),this.storage=new Pe(this.service),this.pushnotifications=new Ae(this.service),this.data=new ke(this.service),this.addressbook=new z(this.service),this.chat=new ie(this.service),this.meeting=new xe(this.service),this.whiteboard=new qe(this.service),P&&(this.videochat=new Ve(this.chat.xmppClient,this.service),this.videochatconference=new Ee(this.service),this.chat.webrtcSignalingProcessor=this.videochat.signalingProcessor),e.token?(M.creds.appId=e.appId,this.service.setSession({token:e.token})):(M.creds.appId=e.appId,M.creds.authKey=e.authKey),this.setSession=this.auth.setSession,this.getSession=this.auth.getSession,this.createSession=this.auth.createSession,this.destroySession=this.auth.destroySession,this.login=this.auth.login,this.logout=this.auth.logout},e}());module.exports=Fe;
//# sourceMappingURL=index.cjs.map
