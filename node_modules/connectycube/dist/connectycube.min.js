!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("node-fetch")):"function"==typeof define&&define.amd?define(["node-fetch"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).ConnectyCube=t(e.nodeFetch)}(this,(function(e){"use strict";var t,n,r=function(e){return i?btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,(function(e,t){return String.fromCharCode(parseInt(t,16))}))):Buffer.from(e).toString("base64")},i="object"==typeof window&&"object"==typeof document,o="object"==typeof process&&"object"==typeof process.versions&&!!process.versions.node,s=!1,a=!1,c=o?require("node-fetch"):fetch,l=o?require("form-data"):FormData,u=i?window.navigator:void 0,d=i&&u?u.mediaDevices:void 0,h=i?window.MediaStream:void 0,f=i?window.MediaStreamTrack:void 0,p=i?window.RTCIceCandidate:void 0,m=i?window.RTCPeerConnection:void 0,g=i?window.RTCRtpReceiver:void 0,v=i?window.RTCRtpSender:void 0,y=i?window.RTCSessionDescription:void 0,b=!!i&&Boolean(d&&(null===window||void 0===window?void 0:window.RTCPeerConnection)),_=i?window.adapter:void 0,w=Object.freeze({__proto__:null,MediaStream:h,MediaStreamTrack:f,RTCIceCandidate:p,RTCPeerConnection:m,RTCRtpReceiver:g,RTCRtpSender:v,RTCSessionDescription:y,adapter:_,base64Encode:r,fetchImpl:c,formDataImpl:l,isBrowser:i,isExpo:a,isNodeJS:o,isReactNative:s,isWebRTCAvailable:b,mediaDevices:d,navigator:u});!function(e){e[e.BOSH=1]="BOSH",e[e.WS=2]="WS"}(t||(t={})),function(e){e.ALL="all",e.TRACE="trace",e.DEBUG="debug",e.VDEBUG="vdebug",e.LOG="log",e.WARN="warn",e.ERROR="error"}(n||(n={}));var S=function(){function e(){this.version="4.0.0",this.creds={appId:"",authKey:""},this.endpoints={api:"api.connectycube.com",chat:"chat.connectycube.com",muc:"muc.chat.connectycube.com"},this.chatProtocol={bosh:"https://chat.connectycube.com:5281",websocket:"wss://chat.connectycube.com:5291",active:2},this.chat={contactList:{subscriptionMode:{mutual:!0}},streamManagement:{enable:!1},ping:{enable:!1,timeInterval:60},reconnect:{enable:!0,timeInterval:5}},this.videochat={alwaysRelayCalls:!1,answerTimeInterval:60,dialingTimeInterval:5,disconnectTimeInterval:30,statsReportTimeInterval:null,iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:turn.connectycube.com"},{urls:"turn:turn.connectycube.com:5349?transport=udp",username:"connectycube",credential:"4c29501ca9207b7fb9c4b4b6b04faeb1"},{urls:"turn:turn.connectycube.com:5349?transport=tcp",username:"connectycube",credential:"4c29501ca9207b7fb9c4b4b6b04faeb1"}]},this.conference={server:"wss://janus.connectycube.com:8989",debug:n.ALL},this.whiteboard={server:"https://whiteboard.connectycube.com"},this.urls={session:"session",login:"login",users:"users",chat:"chat",blobs:"blobs",subscriptions:"subscriptions",events:"events",data:"data",addressbook:"address_book",meetings:"meetings",whiteboards:"whiteboards",calls:"calls",type:".json"},this.on={sessionExpired:void 0,xmppDataWrite:void 0,xmppDataRead:void 0},this.timeout=null,this.debug={mode:1}}return e.getInstance=function(){return e.instance||(e.instance=new e),e.instance},e.prototype.set=function(e){var t=this;e.endpoints&&e.endpoints.chat&&(this.endpoints.muc="muc.".concat(e.endpoints.chat),this.chatProtocol.bosh="https://".concat(e.endpoints.chat,":5281"),this.chatProtocol.websocket="wss://".concat(e.endpoints.chat,":5291")),Object.keys(e).forEach((function(n){if("set"!==n&&t.hasOwnProperty(n)){var r=e[n];"object"!=typeof r?t[n]=r:Object.keys(r).forEach((function(e){var i;(null===(i=t[n])||void 0===i?void 0:i.hasOwnProperty(e))&&(t[n][e]=r[e])}))}}))},e}(),E=S.getInstance(),C=function(){return C=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},C.apply(this,arguments)};function k(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))}function T(e,t){var n,r,i,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return s.next=a(0),s.throw=a(1),s.return=a(2),"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(a){return function(c){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;s&&(s=0,a[0]&&(o=0)),o;)try{if(n=1,r&&(i=2&a[0]?r.return:a[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;switch(r=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,r=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){o=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){o.label=a[1];break}if(6===a[0]&&o.label<i[1]){o.label=i[1],i=a;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(a);break}i[2]&&o.ops.pop(),o.trys.pop();continue}a=t.call(e,o)}catch(e){a=[6,e],r=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}}function x(e,t,n){if(n||2===arguments.length)for(var r,i=0,o=t.length;i<o;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))}"function"==typeof SuppressedError&&SuppressedError;var I,R,O=function(){function e(){}return e.safeCallbackCall=function(e){return void 0===e&&(e=function(){}),function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];if("function"==typeof e)try{e.apply(void 0,t)}catch(t){console.error("Error in listener:",t,"Check the code:\n>>>\n".concat(e.toString(),"\n<<<"))}}},e.getUrl=function(e,t,n){var r=t?"/".concat(t):"",i=n?"/".concat(n):"";return"https://".concat(E.endpoints.api,"/").concat(e).concat(r).concat(i).concat(E.urls.type)},e.isArray=function(e){return Array.isArray(e)},e.isObject=function(e){return"[object Object]"===Object.prototype.toString.call(e)},e.getBsonObjectId=function(){var e={machine:Math.floor(16777216*Math.random()).toString(16),pid:Math.floor(32767*Math.random()).toString(16),increment:0},t=Math.floor(Date.now()/1e3).toString(16),n=(e.increment++).toString(16);return parseInt(n,16)>16777215&&(e.increment=0),t.padStart(8,"0")+e.machine.padStart(6,"0")+e.pid.padStart(4,"0")+n.padStart(6,"0")},e.DLog=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];if(e.loggers.length>0)e.loggers.forEach((function(e){return e(t)}));else{if("object"==typeof E.debug)(Array.isArray(E.debug.mode)?E.debug.mode:[E.debug.mode]).forEach((function(t){1===t&&e.loggers.push((function(e){console.log.apply(console,e)}))}));e.loggers.forEach((function(e){return e(t)}))}},e.mergeArrays=function(t,n){for(var r=e.cloneObject(t),i=function(e){var t=r.find((function(t){return t.user_id===e.user_id}));t?Object.assign(t,e):r.push(e)},o=0,s=n;o<s.length;o++){i(s[o])}return r},e.toBase64=function(e){return i?btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,(function(e,t){return String.fromCharCode(parseInt(t,16))}))):Buffer.from(e).toString("base64")},e.callTrafficUsageCallback=function(e,t){if("function"==typeof E.on[e]){var n=function(e){return new Blob([e]).size};E.on[e](function(e){void 0===e&&(e={});var t=e.body,r=e.headers,i=0;return t&&(i+=n("string"==typeof t?t:JSON.stringify(t))),r&&(i+=n(JSON.stringify(r))),i}(t))}},e.cloneObject=function(e,t){void 0===e&&(e={}),void 0===t&&(t=!1);try{var n=JSON.stringify(e),r=t?n.replace(/null/g,'""'):n;return JSON.parse(r)}catch(t){return e}},e.loggers=[],e.env={isReactNative:s,isBrowser:i,isNodeJS:o,isExpo:a},e}();!function(e){e.GET="GET",e.POST="POST",e.PUT="PUT",e.PATCH="PATCH",e.DELETE="DELETE",e.HEAD="HEAD"}(I||(I={})),function(e){e.JSON="json",e.TEXT="text"}(R||(R={}));var A=function(){function e(e){this.route=E.urls.addressbook,this.proxy=e}return e.prototype.uploadAddressBook=function(){return k(this,arguments,void 0,(function(e,t){var n;return void 0===e&&(e=[]),void 0===t&&(t={}),T(this,(function(r){if(!O.isArray(e))throw new Error("First parameter must be an Array.");return n={type:I.POST,url:O.getUrl(this.route),data:C({contacts:e},t)},[2,this.proxy.ajax(n)]}))}))},e.prototype.get=function(e){return k(this,void 0,void 0,(function(){var t;return T(this,(function(n){return t={type:I.GET,url:O.getUrl(this.route),data:e?{udid:e}:void 0},[2,this.proxy.ajax(t)]}))}))},e.prototype.getRegisteredUsers=function(){return k(this,arguments,void 0,(function(e){var t;return void 0===e&&(e=!1),T(this,(function(n){return t={type:I.GET,url:O.getUrl(this.route,"registered_users"),data:"boolean"==typeof e?{compact:e?1:0}:e},[2,this.proxy.ajax(t)]}))}))},e}(),L=function(){function e(e){var t=this;this.routes={session:E.urls.session,login:E.urls.login},this.setSession=function(e){t.proxy.setSession(e)},this.getSession=function(){return k(t,void 0,void 0,(function(){var e;return T(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),e={type:I.GET,url:O.getUrl(this.routes.session)},[4,this.proxy.ajax(e)];case 1:return[2,t.sent().session];case 2:throw t.sent();case 3:return[2]}}))}))},this.createSession=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return k(t,x([],e,!0),void 0,(function(e){var t,n;return void 0===e&&(e={}),T(this,(function(r){switch(r.label){case 0:if(""===E.creds.appId||""===E.creds.authKey)throw new Error('Cannot create a new session without "appId" and "authKey"');r.label=1;case 1:return r.trys.push([1,3,,4]),t={type:I.POST,url:O.getUrl(this.routes.session),data:this.generateCreateSessionParams(e)},[4,this.proxy.ajax(t)];case 2:return n=r.sent(),this.proxy.setSession(n.session),this.proxy.setCurrentUserId(n.session.user_id),[2,n.session];case 3:throw r.sent();case 4:return[2]}}))}))},this.destroySession=function(){return k(t,void 0,void 0,(function(){var e;return T(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),e={type:I.DELETE,url:O.getUrl(this.routes.session),dataType:R.TEXT},[4,this.proxy.ajax(e)];case 1:return t.sent(),this.proxy.setSession(null),this.proxy.setCurrentUserId(null),[3,3];case 2:throw t.sent();case 3:return[2]}}))}))},this.login=function(e){return k(t,void 0,void 0,(function(){var t,n;return T(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),t={type:I.POST,url:O.getUrl(this.routes.login),data:e},[4,this.proxy.ajax(t)];case 1:return n=r.sent().user,this.proxy.setCurrentUserId(n.id),[2,n];case 2:throw r.sent();case 3:return[2]}}))}))},this.logout=function(){return k(t,void 0,void 0,(function(){var e;return T(this,(function(t){return e={type:I.DELETE,url:O.getUrl(this.routes.login),dataType:R.TEXT},this.proxy.setCurrentUserId(null),[2,this.proxy.ajax(e)]}))}))},this.proxy=e}return e.prototype.generateCreateSessionParams=function(e){void 0===e&&(e={});var t={application_id:E.creds.appId,auth_key:E.creds.authKey};return"guest"in e?t.user=e:"login"in e&&"password"in e?t.user={login:e.login,password:e.password}:"email"in e&&"password"in e?t.user={email:e.email,password:e.password}:"provider"in e&&(t.provider=e.provider,"keys"in e&&(t.keys=e.keys),"firebase_phone"in e&&(t.firebase_phone=e.firebase_phone),"firebase_email"in e&&(t.firebase_email=e.firebase_email)),t},e}(),P="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function D(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function N(e){if(e.__esModule)return e;var t=e.default;if("function"==typeof t){var n=function e(){return this instanceof e?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};n.prototype=t.prototype}else n={};return Object.defineProperty(n,"__esModule",{value:!0}),Object.keys(e).forEach((function(t){var r=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(n,t,r.get?r:{enumerable:!0,get:function(){return e[t]}})})),n}var M,j,U,z,B,F,q,W,V={},G={};function J(){return j?M:(j=1,M=class extends Error{constructor(e){super(e),this.name="TimeoutError"}})}function H(){return z||(z=1,U=function(e){let t;const n=new Promise((n=>{t=setTimeout(n,e)}));return n.timeout=t,n}),U}function Z(){if(F)return B;F=1;const e=J(),t=H();return B=function(n,r){const i=t(r);return Promise.race([n.finally((function(){clearTimeout(i.timeout)})),i.then((()=>{throw new e}))])},B}function X(){if(W)return q;W=1;const e=J();return q=function(t,n,r="error",i){return new Promise(((o,s)=>{let a;const c=()=>{clearTimeout(a),t.removeListener(n,u),t.removeListener(r,l)};function l(e){s(e),c()}function u(e){o(e),c()}t.once(n,u),r&&t.once(r,l),i&&(a=setTimeout((()=>{c(),s(new e)}),i))}))},q}var Y,$,K,Q,ee={exports:{}};function te(){return Y||(Y=1,function(e){var t=Object.prototype.hasOwnProperty,n="~";function r(){}function i(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function o(e,t,r,o,s){if("function"!=typeof r)throw new TypeError("The listener must be a function");var a=new i(r,o||e,s),c=n?n+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],a]:e._events[c].push(a):(e._events[c]=a,e._eventsCount++),e}function s(e,t){0==--e._eventsCount?e._events=new r:delete e._events[t]}function a(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(n=!1)),a.prototype.eventNames=function(){var e,r,i=[];if(0===this._eventsCount)return i;for(r in e=this._events)t.call(e,r)&&i.push(n?r.slice(1):r);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(e)):i},a.prototype.listeners=function(e){var t=n?n+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var i=0,o=r.length,s=new Array(o);i<o;i++)s[i]=r[i].fn;return s},a.prototype.listenerCount=function(e){var t=n?n+e:e,r=this._events[t];return r?r.fn?1:r.length:0},a.prototype.emit=function(e,t,r,i,o,s){var a=n?n+e:e;if(!this._events[a])return!1;var c,l,u=this._events[a],d=arguments.length;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),d){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,r),!0;case 4:return u.fn.call(u.context,t,r,i),!0;case 5:return u.fn.call(u.context,t,r,i,o),!0;case 6:return u.fn.call(u.context,t,r,i,o,s),!0}for(l=1,c=new Array(d-1);l<d;l++)c[l-1]=arguments[l];u.fn.apply(u.context,c)}else{var h,f=u.length;for(l=0;l<f;l++)switch(u[l].once&&this.removeListener(e,u[l].fn,void 0,!0),d){case 1:u[l].fn.call(u[l].context);break;case 2:u[l].fn.call(u[l].context,t);break;case 3:u[l].fn.call(u[l].context,t,r);break;case 4:u[l].fn.call(u[l].context,t,r,i);break;default:if(!c)for(h=1,c=new Array(d-1);h<d;h++)c[h-1]=arguments[h];u[l].fn.apply(u[l].context,c)}}return!0},a.prototype.on=function(e,t,n){return o(this,e,t,n,!1)},a.prototype.once=function(e,t,n){return o(this,e,t,n,!0)},a.prototype.removeListener=function(e,t,r,i){var o=n?n+e:e;if(!this._events[o])return this;if(!t)return s(this,o),this;var a=this._events[o];if(a.fn)a.fn!==t||i&&!a.once||r&&a.context!==r||s(this,o);else{for(var c=0,l=[],u=a.length;c<u;c++)(a[c].fn!==t||i&&!a[c].once||r&&a[c].context!==r)&&l.push(a[c]);l.length?this._events[o]=1===l.length?l[0]:l:s(this,o)}return this},a.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&s(this,t)):(this._events=new r,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=n,a.EventEmitter=a,e.exports=a}(ee)),ee.exports}function ne(){return K||(K=1,$=function(){this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}),$}function re(){if(Q)return G;Q=1;const e=Z(),t=H(),n=J(),r=X(),i=te(),o=ne();return G.EventEmitter=i,G.timeout=e,G.delay=t,G.TimeoutError=n,G.promise=r,G.Deferred=o,G}var ie,oe,se,ae,ce,le,ue={exports:{}},de={};function he(){return ie||(ie=1,de.detect=function(e){if(!e)return!1;return-1!==e.replace(/\\20/g,"").replace(/\\22/g,"").replace(/\\26/g,"").replace(/\\27/g,"").replace(/\\2f/g,"").replace(/\\3a/g,"").replace(/\\3c/g,"").replace(/\\3e/g,"").replace(/\\40/g,"").replace(/\\5c/g,"").search(/[ "&'/:<>@\\]/g)},de.escape=function(e){return null===e?null:e.replace(/^\s+|\s+$/g,"").replace(/\\/g,"\\5c").replace(/ /g,"\\20").replace(/"/g,"\\22").replace(/&/g,"\\26").replace(/'/g,"\\27").replace(/\//g,"\\2f").replace(/:/g,"\\3a").replace(/</g,"\\3c").replace(/>/g,"\\3e").replace(/@/g,"\\40")},de.unescape=function(e){return null===e?null:e.replace(/\\20/g," ").replace(/\\22/g,'"').replace(/\\26/g,"&").replace(/\\27/g,"'").replace(/\\2f/g,"/").replace(/\\3a/g,":").replace(/\\3c/g,"<").replace(/\\3e/g,">").replace(/\\40/g,"@").replace(/\\5c/g,"\\")}),de}function fe(){if(se)return oe;se=1;const e=he();class t{constructor(e,t,n){if("string"!=typeof t||!t)throw new TypeError("Invalid domain.");this.setDomain(t),this.setLocal("string"==typeof e?e:""),this.setResource("string"==typeof n?n:"")}[Symbol.toPrimitive](e){return"number"===e?NaN:this.toString()}toString(e){let t=this._domain;return this._local&&(t=this.getLocal(e)+"@"+t),this._resource&&(t=t+"/"+this._resource),t}bare(){return this._resource?new t(this._local,this._domain,null):this}equals(e){return this._local===e._local&&this._domain===e._domain&&this._resource===e._resource}setLocal(t,n){return(n=n||e.detect(t))&&(t=e.escape(t)),this._local=t&&t.toLowerCase(),this}getLocal(t=!1){let n=null;return n=t?e.unescape(this._local):this._local,n}setDomain(e){return this._domain=e.toLowerCase(),this}getDomain(){return this._domain}setResource(e){return this._resource=e,this}getResource(){return this._resource}}return Object.defineProperty(t.prototype,"local",{get:t.prototype.getLocal,set:t.prototype.setLocal}),Object.defineProperty(t.prototype,"domain",{get:t.prototype.getDomain,set:t.prototype.setDomain}),Object.defineProperty(t.prototype,"resource",{get:t.prototype.getResource,set:t.prototype.setResource}),oe=t}function pe(){if(le)return ue.exports;le=1;const e=fe(),t=he(),n=function(){if(ce)return ae;ce=1;const e=fe();return ae=function(t){let n,r;const i=t.indexOf("/");-1!==i&&(r=t.slice(i+1),t=t.slice(0,i));const o=t.indexOf("@");return-1!==o&&(n=t.slice(0,o),t=t.slice(o+1)),new e(n,t,r)}}();function r(...t){return t[1]||t[2]?new e(...t):n(...t)}return ue.exports=r.bind(),ue.exports.jid=r,ue.exports.JID=e,ue.exports.equal=function(e,t){return e.equals(t)},ue.exports.detectEscape=t.detect,ue.exports.escapeLocal=t.escape,ue.exports.unescapeLocal=t.unescape,ue.exports.parse=n,ue.exports}var me,ge,ve,ye,be,_e,we,Se,Ee,Ce,ke,Te,xe,Ie,Re,Oe,Ae={exports:{}},Le={};function Pe(){if(me)return Le;me=1,Object.defineProperty(Le,"__esModule",{value:!0});const e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&apos;"};function t(t){return e[t]}const n={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&apos;":"'"};function r(e){if("#"===e[1]){const t="x"===e[2]?parseInt(e.slice(3),16):parseInt(e.slice(2),10);if(9===t||10===t||13===t||t>=32&&t<=55295||t>=57344&&t<=65533||t>=65536&&t<=1114111)return String.fromCodePoint(t);throw new Error("Illegal XML character 0x"+t.toString(16))}if(n[e])return n[e]||e;throw new Error("Illegal XML entity "+e)}return Le.escapeXML=function(e){return e.replace(/["&'<>]/g,t)},Le.escapeXMLText=function(e){return e.replace(/[&<>]/g,t)},Le.unescapeXML=function(e){let t="",n=-1,i=-1,o=0;for(;-1!==(n=e.indexOf("&",o))&&-1!==(i=e.indexOf(";",n+1));)t=t+e.slice(o,n)+r(e.slice(n,i+1)),o=i+1;return 0===o?e:(t+=e.substring(o),t)},Le.unescapeXMLText=function(e){return e.replace(/&(amp|#38|lt|#60|gt|#62);/g,r)},Le}function De(){if(ve)return ge;ve=1;var e=Pe();class t{constructor(e,t){this.name=e,this.parent=null,this.children=[],this.attrs={},this.setAttrs(t)}is(e,t){return this.getName()===e&&(!t||this.getNS()===t)}getName(){const e=this.name.indexOf(":");return e>=0?this.name.slice(e+1):this.name}getNS(){const e=this.name.indexOf(":");if(e>=0){const t=this.name.slice(0,e);return this.findNS(t)}return this.findNS()}findNS(e){if(e){const t="xmlns:"+e;if(this.attrs[t])return this.attrs[t];if(this.parent)return this.parent.findNS(e)}else{if(this.attrs.xmlns)return this.attrs.xmlns;if(this.parent)return this.parent.findNS()}}getXmlns(){let e={};this.parent&&(e=this.parent.getXmlns());for(const t in this.attrs){const n=t.match("xmlns:?(.*)");this.attrs.hasOwnProperty(t)&&n&&(e[this.attrs[t]]=n[1])}return e}setAttrs(e){"string"==typeof e?this.attrs.xmlns=e:e&&Object.assign(this.attrs,e)}getAttr(e,t){if(!t)return this.attrs[e];const n=this.getXmlns();return n[t]?this.attrs[[n[t],e].join(":")]:null}getChild(e,t){return this.getChildren(e,t)[0]}getChildren(e,t){const n=[];for(const r of this.children)!r.getName||r.getName()!==e||t&&r.getNS()!==t||n.push(r);return n}getChildByAttr(e,t,n,r){return this.getChildrenByAttr(e,t,n,r)[0]}getChildrenByAttr(e,t,n,r){let i=[];for(const o of this.children)!o.attrs||o.attrs[e]!==t||n&&o.getNS()!==n||i.push(o),r&&o.getChildrenByAttr&&i.push(o.getChildrenByAttr(e,t,n,!0));return r&&(i=i.flat()),i}getChildrenByFilter(e,t){let n=[];for(const r of this.children)e(r)&&n.push(r),t&&r.getChildrenByFilter&&n.push(r.getChildrenByFilter(e,!0));return t&&(n=n.flat()),n}getText(){let e="";for(const t of this.children)"string"!=typeof t&&"number"!=typeof t||(e+=t);return e}getChildText(e,t){const n=this.getChild(e,t);return n?n.getText():null}getChildElements(){return this.getChildrenByFilter((e=>e instanceof t))}root(){return this.parent?this.parent.root():this}up(){return this.parent?this.parent:this}c(e,n){return this.cnode(new t(e,n))}cnode(e){return this.children.push(e),"object"==typeof e&&(e.parent=this),e}append(...e){for(const t of e)this.children.push(t),"object"==typeof t&&(t.parent=this)}prepend(...e){for(const t of e)this.children.unshift(t),"object"==typeof t&&(t.parent=this)}t(e){return this.children.push(e),this}remove(e,t){const n="string"==typeof e?n=>!(n.is&&n.is(e,t)):t=>t!==e;return this.children=this.children.filter(n),this}text(e){return e&&1===this.children.length?(this.children[0]=e,this):this.getText()}attr(e,t){return void 0!==t||null===t?(this.attrs||(this.attrs={}),this.attrs[e]=t,this):this.attrs[e]}toString(){let e="";return this.write((t=>{e+=t})),e}_addChildren(t){t(">");for(const n of this.children)null!=n&&(n.write?n.write(t):"string"==typeof n?t(e.escapeXMLText(n)):n.toString&&t(e.escapeXMLText(n.toString(10))));t("</"),t(this.name),t(">")}write(t){t("<"),t(this.name);for(const n in this.attrs){const r=this.attrs[n];null!=r&&(t(" "),t(n),t('="'),t(e.escapeXML("string"==typeof r?r:r.toString(10))),t('"'))}0===this.children.length?t("/>"):this._addChildren(t)}}return t.prototype.tree=t.prototype.root,ge=t}function Ne(){return Ee?Se:(Ee=1,Se=class extends Error{constructor(...e){super(...e),this.name="XMLError"}})}function Me(){if(ke)return Ce;ke=1;const e=function(){if(we)return _e;we=1;var e=te(),t=Pe();class n extends e.EventEmitter{constructor(){super();let e,n,r,i,o,s,a,c,l,u=0,d=0;this._handleTagOpening=function(e,t,n){e?this.emit("endElement",t):(this.emit("startElement",t,n),s&&this.emit("endElement",t))},this.write=function(h){"string"!=typeof h&&(h=h.toString());let f=0;function p(){if("number"==typeof d){const e=h.slice(d,f);return d=void 0,e}}for(e&&(h=e+h,f+=n?0:e.length,n=!1,e=null);f<h.length;f++){switch(u){case 0:{const e=h.indexOf("<",f);-1!==e&&f!==e&&(f=e);break}case 8:{const e=h.indexOf(c,f);-1!==e&&(f=e);break}case 1:{const e=h.indexOf("--\x3e",f);-1!==e&&(f=e+2);break}case 10:{const e=h.indexOf("]]>",f);-1!==e&&(f=e+2);break}}const e=h.charCodeAt(f);switch(u){case 0:if(60===e){const e=p();e&&this.emit("text",t.unescapeXML(e)),u=3,d=f+1,i={}}break;case 9:if(93===e)if("]>"===h.substr(f+1,2)){const e=p();e&&this.emit("text",e),u=0}else h.length<f+2&&(n=!0,f=h.length);break;case 3:47===e&&d===f?(d=f+1,o=!0):33===e?"[CDATA["===h.substr(f+1,7)?(d=f+8,u=9):h.length<f+8&&"[CDATA[".startsWith(h.slice(f+1))?(n=!0,f=h.length):(d=void 0,u=1):63===e?(d=void 0,u=2):(e<=32||47===e||62===e)&&(r=p(),f--,u=4);break;case 1:if(62===e){const e=h.charCodeAt(f-1),t=h.charCodeAt(f-2);(45===e&&45===t||93===e&&93===t)&&(u=0)}break;case 2:62===e&&63===h.charCodeAt(f-1)&&(u=0);break;case 4:62===e?(this._handleTagOpening(o,r,i),r=void 0,i=void 0,o=void 0,s=void 0,u=0,d=f+1):47===e?s=!0:e>32&&(d=f,u=5);break;case 5:(e<=32||61===e)&&(l=p(),f--,u=6);break;case 6:61===e&&(u=7);break;case 7:34!==e&&39!==e||(a=e,c=34===e?'"':"'",u=8,d=f+1);break;case 8:if(e===a){const e=t.unescapeXML(p());i[l]=e,l=void 0,u=4}}}"number"==typeof d&&d<=h.length&&(e=h.slice(d),d=0)}}end(e){e&&this.write(e),this.write=function(){}}}return _e=n}(),t=De(),n=te(),r=Ne();class i extends n{constructor(){super();const t=new e;this.root=null,this.cursor=null,t.on("startElement",this.onStartElement.bind(this)),t.on("endElement",this.onEndElement.bind(this)),t.on("text",this.onText.bind(this)),this.parser=t}onStartElement(e,n){const r=new t(e,n),{root:i,cursor:o}=this;i?o!==i&&o.append(r):(this.root=r,this.emit("start",r)),this.cursor=r}onEndElement(e){const{root:t,cursor:n}=this;if(e===n.name){if(n!==t)return n.parent?void(this.cursor=n.parent):(n.parent=t,this.emit("element",n),void(this.cursor=t));this.emit("end",t)}else this.emit("error",new r(`${n.name} must be closed.`))}onText(e){const{cursor:t}=this;t?t.t(e):this.emit("error",new r(`${e} must be a child.`))}write(e){this.parser.write(e)}end(e){e&&this.parser.write(e)}}return i.XMLError=r,Ce=i}function je(){return Te||(Te=1,function(e){const t=De(),n=function(){if(be)return ye;be=1;var e=De();function t(e,n){if(Array.isArray(n))for(const r of n)t(e,r);else""!==n&&null!=n&&!0!==n&&!1!==n&&e.cnode(n)}return ye=function(n,r,...i){if("object"==typeof r&&null!==r){delete r.__source,delete r.__self;for(const[e,t]of Object.entries(r))null==t?delete r[e]:r[e]=t.toString(10)}const o=new e(n,r);for(const e of i)t(o,e);return o}}(),r=Me(),{escapeXML:i,unescapeXML:o,escapeXMLText:s,unescapeXMLText:a}=Pe(),c=Ne();e.exports=function(...e){return n(...e)},Object.assign(e.exports,{Element:t,createElement:n,Parser:r,escapeXML:i,unescapeXML:o,escapeXMLText:s,unescapeXMLText:a,XMLError:c})}(Ae)),Ae.exports}function Ue(){if(Ie)return xe;Ie=1;class e extends Error{constructor(e,t,n){super(e+(t?` - ${t}`:"")),this.name="XMPPError",this.condition=e,this.text=t,this.application=n}static fromElement(e){const[t,n,r]=e.children;let i,o;n&&(n.is("text")?i=n:n&&(o=n),r&&(o=r));const s=new this(t.name,i?i.text():"",o);return s.element=e,s}}return xe=e}var ze,Be,Fe,qe,We,Ve,Ge={exports:{}};function Je(){if(Fe)return Be;Fe=1;const{EventEmitter:e,promise:t}=re(),n=pe(),r=je(),i=function(){if(Oe)return Re;Oe=1;const e=Ue();return Re=class extends e{constructor(...e){super(...e),this.name="StreamError"}}}(),{parseHost:o,parseService:s}=(ze||(ze=1,function(e){function t(e){let{port:t,hostname:n,protocol:r}=new URL(e);return"[::1]"===n&&(n="::1"),{port:t,hostname:n,protocol:r}}function n(e){const{port:n,hostname:r}=t(`http://${e}`);return{port:n,hostname:r}}Object.assign(e.exports,{parseURI:t,parseHost:n,parseService:function(e){return e.includes("://")?t(e):n(e)}})}(Ge)),Ge.exports);class a extends e{constructor(e={}){super(),this.jid=null,this.timeout=2e3,this.options=e,this.socketListeners=Object.create(null),this.parserListeners=Object.create(null),this.status="offline",this.socket=null,this.parser=null,this.root=null}_reset(){this.jid=null,this.status="offline",this._detachSocket(),this._detachParser()}async _streamError(e,t){try{await this.send(r("stream:error",{},[r(e,{xmlns:"urn:ietf:params:xml:ns:xmpp-streams"},t)]))}catch{}return this._end()}_onData(e){const t=e.toString("utf8");this.emit("input",t),this.parser.write(t)}_onParserError(e){this._streamError("bad-format"),this._detachParser(),this.emit("error",e)}_attachSocket(e){this.socket=e;const t=this.socketListeners;t.data=this._onData.bind(this),t.close=(e,t)=>{this._reset(),this._status("disconnect",{clean:!e,event:t})},t.connect=()=>{this._status("connect")},t.error=e=>{this.emit("error",e)},this.socket.on("close",t.close),this.socket.on("data",t.data),this.socket.on("error",t.error),this.socket.on("connect",t.connect)}_detachSocket(){const{socketListeners:e,socket:t}=this;for(const n of Object.getOwnPropertyNames(e))t.removeListener(n,e[n]),delete e[n];return this.socket=null,t}_onElement(e){const t=e.is("error","http://etherx.jabber.org/streams");t&&this._onStreamError(e),this.emit("element",e),this.emit(this.isStanza(e)?"stanza":"nonza",e),t&&this._end()}_onStreamError(e){const t=i.fromElement(e);if("see-other-host"===t.condition)return this._onSeeOtherHost(t);this.emit("error",t)}async _onSeeOtherHost(e){const{protocol:n}=s(this.options.service),r=e.element.getChildText("see-other-host"),{port:i}=o(r);let a;a=i?`${n||"xmpp:"}//${r}`:(n?`${n}//`:"")+r;try{await t(this,"disconnect");const{domain:e,lang:n}=this.options;await this.connect(a),await this.open({domain:e,lang:n})}catch(e){this.emit("error",e)}}_attachParser(e){this.parser=e;const t=this.parserListeners;t.element=this._onElement.bind(this),t.error=this._onParserError.bind(this),t.end=e=>{this._detachParser(),this._status("close",e)},t.start=e=>{this._status("open",e)},this.parser.on("error",t.error),this.parser.on("element",t.element),this.parser.on("end",t.end),this.parser.on("start",t.start)}_detachParser(){const e=this.parserListeners;for(const t of Object.getOwnPropertyNames(e))this.parser.removeListener(t,e[t]),delete e[t];this.parser=null}_jid(e){return this.jid=n(e),this.jid}_status(e,...t){this.status=e,this.emit("status",e,...t),this.emit(e,...t)}async _end(){let e;try{e=await this.close()}catch{}try{await this.disconnect()}catch{}return e}async start(){if("offline"!==this.status)throw new Error("Connection is not offline");const{service:e,domain:n,lang:r}=this.options;await this.connect(e);const i=t(this,"online");return await this.open({domain:n,lang:r}),i}async connect(e){this._status("connecting",e);const n=new this.Socket;return this._attachSocket(n),n.connect(this.socketParameters(e)),t(n,"connect")}async disconnect(e=this.timeout){this.socket&&this._status("disconnecting"),this.socket.end(),await t(this.socket,"close","error",e)}async open(e){this._status("opening"),"string"==typeof e&&(e={domain:e});const{domain:n,lang:r,timeout:i=this.timeout}=e,o=this.headerElement();return o.attrs.to=n,o.attrs["xml:lang"]=r,this.root=o,this._attachParser(new this.Parser),await this.write(this.header(o)),t(this,"open","error",i)}async stop(){const e=await this._end();return"offline"!==this.status&&this._status("offline",e),e}async close(e=this.timeout){const n=this.footer(this.footerElement()),r=Promise.all([t(this.parser,"end","error",e),this.write(n)]);this.parser&&this.socket&&this._status("closing");const[i]=await r;return this.root=null,i}async restart(){this._detachParser();const{domain:e,lang:t}=this.options;return this.open({domain:e,lang:t})}async send(e){e.parent=this.root,await this.write(e.toString()),this.emit("send",e)}sendReceive(e,n=this.timeout){return Promise.all([this.send(e),t(this,"element","error",n)]).then((([,e])=>e))}write(e){return new Promise(((t,n)=>{"closing"!==this.status?this.socket.write(e,(r=>{if(r)return n(r);this.emit("output",e),t()})):n(new Error("Connection is closing"))}))}isStanza(e){const{name:t}=e;return"iq"===t||"message"===t||"presence"===t}isNonza(e){return!this.isStanza(e)}header(e){return e.toString()}headerElement(){return new r.Element("",{version:"1.0",xmlns:this.NS})}footer(e){return e.toString()}footerElement(){}socketParameters(){}}return a.prototype.NS="",a.prototype.Socket=null,a.prototype.Parser=null,Be=a}var He,Ze,Xe=function(){if(Ve)return V;Ve=1;const e=function(){if(We)return qe;We=1;const e=Je();class t extends e{constructor(e){super(e),this.transports=[]}send(e,...t){return this.Transport.prototype.send.call(this,e,...t)}sendMany(...e){return this.Transport.prototype.sendMany.call(this,...e)}_findTransport(e){return this.transports.find((t=>{try{return void 0!==t.prototype.socketParameters(e)}catch{return!1}}))}connect(e){const t=this._findTransport(e);if(!t)throw new Error("No compatible connection method found.");return this.Transport=t,this.Socket=t.prototype.Socket,this.Parser=t.prototype.Parser,super.connect(e)}socketParameters(...e){return this.Transport.prototype.socketParameters(...e)}header(...e){return this.Transport.prototype.header(...e)}headerElement(...e){return this.Transport.prototype.headerElement(...e)}footer(...e){return this.Transport.prototype.footer(...e)}footerElement(...e){return this.Transport.prototype.footerElement(...e)}}return t.prototype.NS="jabber:client",qe=t}(),t=je(),n=pe();return V.Client=e,V.xml=t,V.jid=n,V}();var Ye=function(){if(Ze)return He;Ze=1;const{EventEmitter:e}=re();class t extends e{constructor(e){super(),this.delay=1e3,this.entity=e,this._timeout=null}scheduleReconnect(){const{entity:e,delay:t,_timeout:n}=this;clearTimeout(n),this._timeout=setTimeout((async()=>{if("disconnect"===e.status)try{await this.reconnect()}catch{}}),t)}async reconnect(){const{entity:e}=this;this.emit("reconnecting");const{service:t,domain:n,lang:r}=e.options;await e.connect(t),await e.open({domain:n,lang:r}),this.emit("reconnected")}start(){const{entity:e}=this,t={};t.disconnect=()=>{this.scheduleReconnect()},this.listeners=t,e.on("disconnect",t.disconnect)}stop(){const{entity:e,listeners:t,_timeout:n}=this;e.removeListener("disconnect",t.disconnect),clearTimeout(n)}}return He=function({entity:e}){const n=new t(e);return n.start(),n}}(),$e=D(Ye),Ke="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},Qe=[],et=[],tt="undefined"!=typeof Uint8Array?Uint8Array:Array,nt=!1;function rt(){nt=!0;for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t=0;t<64;++t)Qe[t]=e[t],et[e.charCodeAt(t)]=t;et["-".charCodeAt(0)]=62,et["_".charCodeAt(0)]=63}function it(e,t,n){for(var r,i,o=[],s=t;s<n;s+=3)r=(e[s]<<16)+(e[s+1]<<8)+e[s+2],o.push(Qe[(i=r)>>18&63]+Qe[i>>12&63]+Qe[i>>6&63]+Qe[63&i]);return o.join("")}function ot(e){var t;nt||rt();for(var n=e.length,r=n%3,i="",o=[],s=16383,a=0,c=n-r;a<c;a+=s)o.push(it(e,a,a+s>c?c:a+s));return 1===r?(t=e[n-1],i+=Qe[t>>2],i+=Qe[t<<4&63],i+="=="):2===r&&(t=(e[n-2]<<8)+e[n-1],i+=Qe[t>>10],i+=Qe[t>>4&63],i+=Qe[t<<2&63],i+="="),o.push(i),o.join("")}function st(e,t,n,r,i){var o,s,a=8*i-r-1,c=(1<<a)-1,l=c>>1,u=-7,d=n?i-1:0,h=n?-1:1,f=e[t+d];for(d+=h,o=f&(1<<-u)-1,f>>=-u,u+=a;u>0;o=256*o+e[t+d],d+=h,u-=8);for(s=o&(1<<-u)-1,o>>=-u,u+=r;u>0;s=256*s+e[t+d],d+=h,u-=8);if(0===o)o=1-l;else{if(o===c)return s?NaN:1/0*(f?-1:1);s+=Math.pow(2,r),o-=l}return(f?-1:1)*s*Math.pow(2,o-r)}function at(e,t,n,r,i,o){var s,a,c,l=8*o-i-1,u=(1<<l)-1,d=u>>1,h=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,f=r?0:o-1,p=r?1:-1,m=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,s=u):(s=Math.floor(Math.log(t)/Math.LN2),t*(c=Math.pow(2,-s))<1&&(s--,c*=2),(t+=s+d>=1?h/c:h*Math.pow(2,1-d))*c>=2&&(s++,c/=2),s+d>=u?(a=0,s=u):s+d>=1?(a=(t*c-1)*Math.pow(2,i),s+=d):(a=t*Math.pow(2,d-1)*Math.pow(2,i),s=0));i>=8;e[n+f]=255&a,f+=p,a/=256,i-=8);for(s=s<<i|a,l+=i;l>0;e[n+f]=255&s,f+=p,s/=256,l-=8);e[n+f-p]|=128*m}var ct={}.toString,lt=Array.isArray||function(e){return"[object Array]"==ct.call(e)};ft.TYPED_ARRAY_SUPPORT=void 0===Ke.TYPED_ARRAY_SUPPORT||Ke.TYPED_ARRAY_SUPPORT;var ut=dt();function dt(){return ft.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function ht(e,t){if(dt()<t)throw new RangeError("Invalid typed array length");return ft.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t)).__proto__=ft.prototype:(null===e&&(e=new ft(t)),e.length=t),e}function ft(e,t,n){if(!(ft.TYPED_ARRAY_SUPPORT||this instanceof ft))return new ft(e,t,n);if("number"==typeof e){if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return gt(this,e)}return pt(this,e,t,n)}function pt(e,t,n,r){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer?function(e,t,n,r){if(t.byteLength,n<0||t.byteLength<n)throw new RangeError("'offset' is out of bounds");if(t.byteLength<n+(r||0))throw new RangeError("'length' is out of bounds");t=void 0===n&&void 0===r?new Uint8Array(t):void 0===r?new Uint8Array(t,n):new Uint8Array(t,n,r);ft.TYPED_ARRAY_SUPPORT?(e=t).__proto__=ft.prototype:e=vt(e,t);return e}(e,t,n,r):"string"==typeof t?function(e,t,n){"string"==typeof n&&""!==n||(n="utf8");if(!ft.isEncoding(n))throw new TypeError('"encoding" must be a valid string encoding');var r=0|_t(t,n);e=ht(e,r);var i=e.write(t,n);i!==r&&(e=e.slice(0,i));return e}(e,t,n):function(e,t){if(bt(t)){var n=0|yt(t.length);return 0===(e=ht(e,n)).length||t.copy(e,0,0,n),e}if(t){if("undefined"!=typeof ArrayBuffer&&t.buffer instanceof ArrayBuffer||"length"in t)return"number"!=typeof t.length||(r=t.length)!=r?ht(e,0):vt(e,t);if("Buffer"===t.type&&lt(t.data))return vt(e,t.data)}var r;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(e,t)}function mt(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number');if(e<0)throw new RangeError('"size" argument must not be negative')}function gt(e,t){if(mt(t),e=ht(e,t<0?0:0|yt(t)),!ft.TYPED_ARRAY_SUPPORT)for(var n=0;n<t;++n)e[n]=0;return e}function vt(e,t){var n=t.length<0?0:0|yt(t.length);e=ht(e,n);for(var r=0;r<n;r+=1)e[r]=255&t[r];return e}function yt(e){if(e>=dt())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+dt().toString(16)+" bytes");return 0|e}function bt(e){return!(null==e||!e._isBuffer)}function _t(e,t){if(bt(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;"string"!=typeof e&&(e=""+e);var n=e.length;if(0===n)return 0;for(var r=!1;;)switch(t){case"ascii":case"latin1":case"binary":return n;case"utf8":case"utf-8":case void 0:return Ht(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*n;case"hex":return n>>>1;case"base64":return Zt(e).length;default:if(r)return Ht(e).length;t=(""+t).toLowerCase(),r=!0}}function wt(e,t,n){var r=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===n||n>this.length)&&(n=this.length),n<=0)return"";if((n>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return Mt(this,t,n);case"utf8":case"utf-8":return Lt(this,t,n);case"ascii":return Dt(this,t,n);case"latin1":case"binary":return Nt(this,t,n);case"base64":return At(this,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return jt(this,t,n);default:if(r)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),r=!0}}function St(e,t,n){var r=e[t];e[t]=e[n],e[n]=r}function Et(e,t,n,r,i){if(0===e.length)return-1;if("string"==typeof n?(r=n,n=0):n>2147483647?n=2147483647:n<-2147483648&&(n=-2147483648),n=+n,isNaN(n)&&(n=i?0:e.length-1),n<0&&(n=e.length+n),n>=e.length){if(i)return-1;n=e.length-1}else if(n<0){if(!i)return-1;n=0}if("string"==typeof t&&(t=ft.from(t,r)),bt(t))return 0===t.length?-1:Ct(e,t,n,r,i);if("number"==typeof t)return t&=255,ft.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?i?Uint8Array.prototype.indexOf.call(e,t,n):Uint8Array.prototype.lastIndexOf.call(e,t,n):Ct(e,[t],n,r,i);throw new TypeError("val must be string, number or Buffer")}function Ct(e,t,n,r,i){var o,s=1,a=e.length,c=t.length;if(void 0!==r&&("ucs2"===(r=String(r).toLowerCase())||"ucs-2"===r||"utf16le"===r||"utf-16le"===r)){if(e.length<2||t.length<2)return-1;s=2,a/=2,c/=2,n/=2}function l(e,t){return 1===s?e[t]:e.readUInt16BE(t*s)}if(i){var u=-1;for(o=n;o<a;o++)if(l(e,o)===l(t,-1===u?0:o-u)){if(-1===u&&(u=o),o-u+1===c)return u*s}else-1!==u&&(o-=o-u),u=-1}else for(n+c>a&&(n=a-c),o=n;o>=0;o--){for(var d=!0,h=0;h<c;h++)if(l(e,o+h)!==l(t,h)){d=!1;break}if(d)return o}return-1}function kt(e,t,n,r){n=Number(n)||0;var i=e.length-n;r?(r=Number(r))>i&&(r=i):r=i;var o=t.length;if(o%2!=0)throw new TypeError("Invalid hex string");r>o/2&&(r=o/2);for(var s=0;s<r;++s){var a=parseInt(t.substr(2*s,2),16);if(isNaN(a))return s;e[n+s]=a}return s}function Tt(e,t,n,r){return Xt(Ht(t,e.length-n),e,n,r)}function xt(e,t,n,r){return Xt(function(e){for(var t=[],n=0;n<e.length;++n)t.push(255&e.charCodeAt(n));return t}(t),e,n,r)}function It(e,t,n,r){return xt(e,t,n,r)}function Rt(e,t,n,r){return Xt(Zt(t),e,n,r)}function Ot(e,t,n,r){return Xt(function(e,t){for(var n,r,i,o=[],s=0;s<e.length&&!((t-=2)<0);++s)r=(n=e.charCodeAt(s))>>8,i=n%256,o.push(i),o.push(r);return o}(t,e.length-n),e,n,r)}function At(e,t,n){return 0===t&&n===e.length?ot(e):ot(e.slice(t,n))}function Lt(e,t,n){n=Math.min(e.length,n);for(var r=[],i=t;i<n;){var o,s,a,c,l=e[i],u=null,d=l>239?4:l>223?3:l>191?2:1;if(i+d<=n)switch(d){case 1:l<128&&(u=l);break;case 2:128==(192&(o=e[i+1]))&&(c=(31&l)<<6|63&o)>127&&(u=c);break;case 3:o=e[i+1],s=e[i+2],128==(192&o)&&128==(192&s)&&(c=(15&l)<<12|(63&o)<<6|63&s)>2047&&(c<55296||c>57343)&&(u=c);break;case 4:o=e[i+1],s=e[i+2],a=e[i+3],128==(192&o)&&128==(192&s)&&128==(192&a)&&(c=(15&l)<<18|(63&o)<<12|(63&s)<<6|63&a)>65535&&c<1114112&&(u=c)}null===u?(u=65533,d=1):u>65535&&(u-=65536,r.push(u>>>10&1023|55296),u=56320|1023&u),r.push(u),i+=d}return function(e){var t=e.length;if(t<=Pt)return String.fromCharCode.apply(String,e);var n="",r=0;for(;r<t;)n+=String.fromCharCode.apply(String,e.slice(r,r+=Pt));return n}(r)}ft.poolSize=8192,ft._augment=function(e){return e.__proto__=ft.prototype,e},ft.from=function(e,t,n){return pt(null,e,t,n)},ft.TYPED_ARRAY_SUPPORT&&(ft.prototype.__proto__=Uint8Array.prototype,ft.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&ft[Symbol.species]),ft.alloc=function(e,t,n){return function(e,t,n,r){return mt(t),t<=0?ht(e,t):void 0!==n?"string"==typeof r?ht(e,t).fill(n,r):ht(e,t).fill(n):ht(e,t)}(null,e,t,n)},ft.allocUnsafe=function(e){return gt(null,e)},ft.allocUnsafeSlow=function(e){return gt(null,e)},ft.isBuffer=Yt,ft.compare=function(e,t){if(!bt(e)||!bt(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var n=e.length,r=t.length,i=0,o=Math.min(n,r);i<o;++i)if(e[i]!==t[i]){n=e[i],r=t[i];break}return n<r?-1:r<n?1:0},ft.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},ft.concat=function(e,t){if(!lt(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return ft.alloc(0);var n;if(void 0===t)for(t=0,n=0;n<e.length;++n)t+=e[n].length;var r=ft.allocUnsafe(t),i=0;for(n=0;n<e.length;++n){var o=e[n];if(!bt(o))throw new TypeError('"list" argument must be an Array of Buffers');o.copy(r,i),i+=o.length}return r},ft.byteLength=_t,ft.prototype._isBuffer=!0,ft.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)St(this,t,t+1);return this},ft.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)St(this,t,t+3),St(this,t+1,t+2);return this},ft.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)St(this,t,t+7),St(this,t+1,t+6),St(this,t+2,t+5),St(this,t+3,t+4);return this},ft.prototype.toString=function(){var e=0|this.length;return 0===e?"":0===arguments.length?Lt(this,0,e):wt.apply(this,arguments)},ft.prototype.equals=function(e){if(!bt(e))throw new TypeError("Argument must be a Buffer");return this===e||0===ft.compare(this,e)},ft.prototype.inspect=function(){var e="";return this.length>0&&(e=this.toString("hex",0,50).match(/.{2}/g).join(" "),this.length>50&&(e+=" ... ")),"<Buffer "+e+">"},ft.prototype.compare=function(e,t,n,r,i){if(!bt(e))throw new TypeError("Argument must be a Buffer");if(void 0===t&&(t=0),void 0===n&&(n=e?e.length:0),void 0===r&&(r=0),void 0===i&&(i=this.length),t<0||n>e.length||r<0||i>this.length)throw new RangeError("out of range index");if(r>=i&&t>=n)return 0;if(r>=i)return-1;if(t>=n)return 1;if(this===e)return 0;for(var o=(i>>>=0)-(r>>>=0),s=(n>>>=0)-(t>>>=0),a=Math.min(o,s),c=this.slice(r,i),l=e.slice(t,n),u=0;u<a;++u)if(c[u]!==l[u]){o=c[u],s=l[u];break}return o<s?-1:s<o?1:0},ft.prototype.includes=function(e,t,n){return-1!==this.indexOf(e,t,n)},ft.prototype.indexOf=function(e,t,n){return Et(this,e,t,n,!0)},ft.prototype.lastIndexOf=function(e,t,n){return Et(this,e,t,n,!1)},ft.prototype.write=function(e,t,n,r){if(void 0===t)r="utf8",n=this.length,t=0;else if(void 0===n&&"string"==typeof t)r=t,n=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t|=0,isFinite(n)?(n|=0,void 0===r&&(r="utf8")):(r=n,n=void 0)}var i=this.length-t;if((void 0===n||n>i)&&(n=i),e.length>0&&(n<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");r||(r="utf8");for(var o=!1;;)switch(r){case"hex":return kt(this,e,t,n);case"utf8":case"utf-8":return Tt(this,e,t,n);case"ascii":return xt(this,e,t,n);case"latin1":case"binary":return It(this,e,t,n);case"base64":return Rt(this,e,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return Ot(this,e,t,n);default:if(o)throw new TypeError("Unknown encoding: "+r);r=(""+r).toLowerCase(),o=!0}},ft.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var Pt=4096;function Dt(e,t,n){var r="";n=Math.min(e.length,n);for(var i=t;i<n;++i)r+=String.fromCharCode(127&e[i]);return r}function Nt(e,t,n){var r="";n=Math.min(e.length,n);for(var i=t;i<n;++i)r+=String.fromCharCode(e[i]);return r}function Mt(e,t,n){var r=e.length;(!t||t<0)&&(t=0),(!n||n<0||n>r)&&(n=r);for(var i="",o=t;o<n;++o)i+=Jt(e[o]);return i}function jt(e,t,n){for(var r=e.slice(t,n),i="",o=0;o<r.length;o+=2)i+=String.fromCharCode(r[o]+256*r[o+1]);return i}function Ut(e,t,n){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>n)throw new RangeError("Trying to access beyond buffer length")}function zt(e,t,n,r,i,o){if(!bt(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>i||t<o)throw new RangeError('"value" argument is out of bounds');if(n+r>e.length)throw new RangeError("Index out of range")}function Bt(e,t,n,r){t<0&&(t=65535+t+1);for(var i=0,o=Math.min(e.length-n,2);i<o;++i)e[n+i]=(t&255<<8*(r?i:1-i))>>>8*(r?i:1-i)}function Ft(e,t,n,r){t<0&&(t=4294967295+t+1);for(var i=0,o=Math.min(e.length-n,4);i<o;++i)e[n+i]=t>>>8*(r?i:3-i)&255}function qt(e,t,n,r,i,o){if(n+r>e.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("Index out of range")}function Wt(e,t,n,r,i){return i||qt(e,0,n,4),at(e,t,n,r,23,4),n+4}function Vt(e,t,n,r,i){return i||qt(e,0,n,8),at(e,t,n,r,52,8),n+8}ft.prototype.slice=function(e,t){var n,r=this.length;if((e=~~e)<0?(e+=r)<0&&(e=0):e>r&&(e=r),(t=void 0===t?r:~~t)<0?(t+=r)<0&&(t=0):t>r&&(t=r),t<e&&(t=e),ft.TYPED_ARRAY_SUPPORT)(n=this.subarray(e,t)).__proto__=ft.prototype;else{var i=t-e;n=new ft(i,void 0);for(var o=0;o<i;++o)n[o]=this[o+e]}return n},ft.prototype.readUIntLE=function(e,t,n){e|=0,t|=0,n||Ut(e,t,this.length);for(var r=this[e],i=1,o=0;++o<t&&(i*=256);)r+=this[e+o]*i;return r},ft.prototype.readUIntBE=function(e,t,n){e|=0,t|=0,n||Ut(e,t,this.length);for(var r=this[e+--t],i=1;t>0&&(i*=256);)r+=this[e+--t]*i;return r},ft.prototype.readUInt8=function(e,t){return t||Ut(e,1,this.length),this[e]},ft.prototype.readUInt16LE=function(e,t){return t||Ut(e,2,this.length),this[e]|this[e+1]<<8},ft.prototype.readUInt16BE=function(e,t){return t||Ut(e,2,this.length),this[e]<<8|this[e+1]},ft.prototype.readUInt32LE=function(e,t){return t||Ut(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},ft.prototype.readUInt32BE=function(e,t){return t||Ut(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},ft.prototype.readIntLE=function(e,t,n){e|=0,t|=0,n||Ut(e,t,this.length);for(var r=this[e],i=1,o=0;++o<t&&(i*=256);)r+=this[e+o]*i;return r>=(i*=128)&&(r-=Math.pow(2,8*t)),r},ft.prototype.readIntBE=function(e,t,n){e|=0,t|=0,n||Ut(e,t,this.length);for(var r=t,i=1,o=this[e+--r];r>0&&(i*=256);)o+=this[e+--r]*i;return o>=(i*=128)&&(o-=Math.pow(2,8*t)),o},ft.prototype.readInt8=function(e,t){return t||Ut(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},ft.prototype.readInt16LE=function(e,t){t||Ut(e,2,this.length);var n=this[e]|this[e+1]<<8;return 32768&n?4294901760|n:n},ft.prototype.readInt16BE=function(e,t){t||Ut(e,2,this.length);var n=this[e+1]|this[e]<<8;return 32768&n?4294901760|n:n},ft.prototype.readInt32LE=function(e,t){return t||Ut(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},ft.prototype.readInt32BE=function(e,t){return t||Ut(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},ft.prototype.readFloatLE=function(e,t){return t||Ut(e,4,this.length),st(this,e,!0,23,4)},ft.prototype.readFloatBE=function(e,t){return t||Ut(e,4,this.length),st(this,e,!1,23,4)},ft.prototype.readDoubleLE=function(e,t){return t||Ut(e,8,this.length),st(this,e,!0,52,8)},ft.prototype.readDoubleBE=function(e,t){return t||Ut(e,8,this.length),st(this,e,!1,52,8)},ft.prototype.writeUIntLE=function(e,t,n,r){(e=+e,t|=0,n|=0,r)||zt(this,e,t,n,Math.pow(2,8*n)-1,0);var i=1,o=0;for(this[t]=255&e;++o<n&&(i*=256);)this[t+o]=e/i&255;return t+n},ft.prototype.writeUIntBE=function(e,t,n,r){(e=+e,t|=0,n|=0,r)||zt(this,e,t,n,Math.pow(2,8*n)-1,0);var i=n-1,o=1;for(this[t+i]=255&e;--i>=0&&(o*=256);)this[t+i]=e/o&255;return t+n},ft.prototype.writeUInt8=function(e,t,n){return e=+e,t|=0,n||zt(this,e,t,1,255,0),ft.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},ft.prototype.writeUInt16LE=function(e,t,n){return e=+e,t|=0,n||zt(this,e,t,2,65535,0),ft.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):Bt(this,e,t,!0),t+2},ft.prototype.writeUInt16BE=function(e,t,n){return e=+e,t|=0,n||zt(this,e,t,2,65535,0),ft.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):Bt(this,e,t,!1),t+2},ft.prototype.writeUInt32LE=function(e,t,n){return e=+e,t|=0,n||zt(this,e,t,4,4294967295,0),ft.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):Ft(this,e,t,!0),t+4},ft.prototype.writeUInt32BE=function(e,t,n){return e=+e,t|=0,n||zt(this,e,t,4,4294967295,0),ft.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):Ft(this,e,t,!1),t+4},ft.prototype.writeIntLE=function(e,t,n,r){if(e=+e,t|=0,!r){var i=Math.pow(2,8*n-1);zt(this,e,t,n,i-1,-i)}var o=0,s=1,a=0;for(this[t]=255&e;++o<n&&(s*=256);)e<0&&0===a&&0!==this[t+o-1]&&(a=1),this[t+o]=(e/s|0)-a&255;return t+n},ft.prototype.writeIntBE=function(e,t,n,r){if(e=+e,t|=0,!r){var i=Math.pow(2,8*n-1);zt(this,e,t,n,i-1,-i)}var o=n-1,s=1,a=0;for(this[t+o]=255&e;--o>=0&&(s*=256);)e<0&&0===a&&0!==this[t+o+1]&&(a=1),this[t+o]=(e/s|0)-a&255;return t+n},ft.prototype.writeInt8=function(e,t,n){return e=+e,t|=0,n||zt(this,e,t,1,127,-128),ft.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),e<0&&(e=255+e+1),this[t]=255&e,t+1},ft.prototype.writeInt16LE=function(e,t,n){return e=+e,t|=0,n||zt(this,e,t,2,32767,-32768),ft.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):Bt(this,e,t,!0),t+2},ft.prototype.writeInt16BE=function(e,t,n){return e=+e,t|=0,n||zt(this,e,t,2,32767,-32768),ft.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):Bt(this,e,t,!1),t+2},ft.prototype.writeInt32LE=function(e,t,n){return e=+e,t|=0,n||zt(this,e,t,4,2147483647,-2147483648),ft.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):Ft(this,e,t,!0),t+4},ft.prototype.writeInt32BE=function(e,t,n){return e=+e,t|=0,n||zt(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),ft.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):Ft(this,e,t,!1),t+4},ft.prototype.writeFloatLE=function(e,t,n){return Wt(this,e,t,!0,n)},ft.prototype.writeFloatBE=function(e,t,n){return Wt(this,e,t,!1,n)},ft.prototype.writeDoubleLE=function(e,t,n){return Vt(this,e,t,!0,n)},ft.prototype.writeDoubleBE=function(e,t,n){return Vt(this,e,t,!1,n)},ft.prototype.copy=function(e,t,n,r){if(n||(n=0),r||0===r||(r=this.length),t>=e.length&&(t=e.length),t||(t=0),r>0&&r<n&&(r=n),r===n)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(n<0||n>=this.length)throw new RangeError("sourceStart out of bounds");if(r<0)throw new RangeError("sourceEnd out of bounds");r>this.length&&(r=this.length),e.length-t<r-n&&(r=e.length-t+n);var i,o=r-n;if(this===e&&n<t&&t<r)for(i=o-1;i>=0;--i)e[i+t]=this[i+n];else if(o<1e3||!ft.TYPED_ARRAY_SUPPORT)for(i=0;i<o;++i)e[i+t]=this[i+n];else Uint8Array.prototype.set.call(e,this.subarray(n,n+o),t);return o},ft.prototype.fill=function(e,t,n,r){if("string"==typeof e){if("string"==typeof t?(r=t,t=0,n=this.length):"string"==typeof n&&(r=n,n=this.length),1===e.length){var i=e.charCodeAt(0);i<256&&(e=i)}if(void 0!==r&&"string"!=typeof r)throw new TypeError("encoding must be a string");if("string"==typeof r&&!ft.isEncoding(r))throw new TypeError("Unknown encoding: "+r)}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<n)throw new RangeError("Out of range index");if(n<=t)return this;var o;if(t>>>=0,n=void 0===n?this.length:n>>>0,e||(e=0),"number"==typeof e)for(o=t;o<n;++o)this[o]=e;else{var s=bt(e)?e:Ht(new ft(e,r).toString()),a=s.length;for(o=0;o<n-t;++o)this[o+t]=s[o%a]}return this};var Gt=/[^+\/0-9A-Za-z-_]/g;function Jt(e){return e<16?"0"+e.toString(16):e.toString(16)}function Ht(e,t){var n;t=t||1/0;for(var r=e.length,i=null,o=[],s=0;s<r;++s){if((n=e.charCodeAt(s))>55295&&n<57344){if(!i){if(n>56319){(t-=3)>-1&&o.push(239,191,189);continue}if(s+1===r){(t-=3)>-1&&o.push(239,191,189);continue}i=n;continue}if(n<56320){(t-=3)>-1&&o.push(239,191,189),i=n;continue}n=65536+(i-55296<<10|n-56320)}else i&&(t-=3)>-1&&o.push(239,191,189);if(i=null,n<128){if((t-=1)<0)break;o.push(n)}else if(n<2048){if((t-=2)<0)break;o.push(n>>6|192,63&n|128)}else if(n<65536){if((t-=3)<0)break;o.push(n>>12|224,n>>6&63|128,63&n|128)}else{if(!(n<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;o.push(n>>18|240,n>>12&63|128,n>>6&63|128,63&n|128)}}return o}function Zt(e){return function(e){var t,n,r,i,o,s;nt||rt();var a=e.length;if(a%4>0)throw new Error("Invalid string. Length must be a multiple of 4");o="="===e[a-2]?2:"="===e[a-1]?1:0,s=new tt(3*a/4-o),r=o>0?a-4:a;var c=0;for(t=0,n=0;t<r;t+=4,n+=3)i=et[e.charCodeAt(t)]<<18|et[e.charCodeAt(t+1)]<<12|et[e.charCodeAt(t+2)]<<6|et[e.charCodeAt(t+3)],s[c++]=i>>16&255,s[c++]=i>>8&255,s[c++]=255&i;return 2===o?(i=et[e.charCodeAt(t)]<<2|et[e.charCodeAt(t+1)]>>4,s[c++]=255&i):1===o&&(i=et[e.charCodeAt(t)]<<10|et[e.charCodeAt(t+1)]<<4|et[e.charCodeAt(t+2)]>>2,s[c++]=i>>8&255,s[c++]=255&i),s}(function(e){if((e=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}(e).replace(Gt,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function Xt(e,t,n,r){for(var i=0;i<r&&!(i+n>=t.length||i>=e.length);++i)t[i+n]=e[i];return i}function Yt(e){return null!=e&&(!!e._isBuffer||$t(e)||function(e){return"function"==typeof e.readFloatLE&&"function"==typeof e.slice&&$t(e.slice(0,0))}(e))}function $t(e){return!!e.constructor&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)}var Kt=Object.freeze({__proto__:null,Buffer:ft,INSPECT_MAX_BYTES:50,SlowBuffer:function(e){return+e!=e&&(e=0),ft.alloc(+e)},isBuffer:Yt,kMaxLength:ut});function Qt(){throw new Error("setTimeout has not been defined")}function en(){throw new Error("clearTimeout has not been defined")}var tn=Qt,nn=en;function rn(e){if(tn===setTimeout)return setTimeout(e,0);if((tn===Qt||!tn)&&setTimeout)return tn=setTimeout,setTimeout(e,0);try{return tn(e,0)}catch(t){try{return tn.call(null,e,0)}catch(t){return tn.call(this,e,0)}}}"function"==typeof Ke.setTimeout&&(tn=setTimeout),"function"==typeof Ke.clearTimeout&&(nn=clearTimeout);var on,sn=[],an=!1,cn=-1;function ln(){an&&on&&(an=!1,on.length?sn=on.concat(sn):cn=-1,sn.length&&un())}function un(){if(!an){var e=rn(ln);an=!0;for(var t=sn.length;t;){for(on=sn,sn=[];++cn<t;)on&&on[cn].run();cn=-1,t=sn.length}on=null,an=!1,function(e){if(nn===clearTimeout)return clearTimeout(e);if((nn===en||!nn)&&clearTimeout)return nn=clearTimeout,clearTimeout(e);try{return nn(e)}catch(t){try{return nn.call(null,e)}catch(t){return nn.call(this,e)}}}(e)}}function dn(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];sn.push(new hn(e,t)),1!==sn.length||an||rn(un)}function hn(e,t){this.fun=e,this.array=t}hn.prototype.run=function(){this.fun.apply(null,this.array)};function fn(){}var pn=fn,mn=fn,gn=fn,vn=fn,yn=fn,bn=fn,_n=fn;var wn=Ke.performance||{},Sn=wn.now||wn.mozNow||wn.msNow||wn.oNow||wn.webkitNow||function(){return(new Date).getTime()};var En=new Date;var Cn,kn,Tn={nextTick:dn,title:"browser",browser:!0,env:{},argv:[],version:"",versions:{},on:pn,addListener:mn,once:gn,off:vn,removeListener:yn,removeAllListeners:bn,emit:_n,binding:function(e){throw new Error("process.binding is not supported")},cwd:function(){return"/"},chdir:function(e){throw new Error("process.chdir is not supported")},umask:function(){return 0},hrtime:function(e){var t=.001*Sn.call(wn),n=Math.floor(t),r=Math.floor(t%1*1e9);return e&&(n-=e[0],(r-=e[1])<0&&(n--,r+=1e9)),[n,r]},platform:"browser",release:{},config:{},uptime:function(){return(new Date-En)/1e3}},xn=jn(Ke.fetch)&&jn(Ke.ReadableStream);function In(e){kn||(kn=new Ke.XMLHttpRequest).open("GET",Ke.location.host?"/":"https://example.com");try{return kn.responseType=e,kn.responseType===e}catch(e){return!1}}var Rn,On=void 0!==Ke.ArrayBuffer,An=On&&jn(Ke.ArrayBuffer.prototype.slice),Ln=On&&In("arraybuffer"),Pn=!xn&&An&&In("ms-stream"),Dn=!xn&&On&&In("moz-chunked-arraybuffer"),Nn=jn(kn.overrideMimeType),Mn=jn(Ke.VBArray);function jn(e){return"function"==typeof e}kn=null,Rn="function"==typeof Object.create?function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})}:function(e,t){e.super_=t;var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e};var Un=/%[sdj%]/g;function zn(e){if(!$n(e)){for(var t=[],n=0;n<arguments.length;n++)t.push(Wn(arguments[n]));return t.join(" ")}n=1;for(var r=arguments,i=r.length,o=String(e).replace(Un,(function(e){if("%%"===e)return"%";if(n>=i)return e;switch(e){case"%s":return String(r[n++]);case"%d":return Number(r[n++]);case"%j":try{return JSON.stringify(r[n++])}catch(e){return"[Circular]"}default:return e}})),s=r[n];n<i;s=r[++n])Yn(s)||!er(s)?o+=" "+s:o+=" "+Wn(s);return o}function Bn(e,t){if(Kn(Ke.process))return function(){return Bn(e,t).apply(this,arguments)};if(!0===Tn.noDeprecation)return e;var n=!1;return function(){if(!n){if(Tn.throwDeprecation)throw new Error(t);Tn.traceDeprecation?console.trace(t):console.error(t),n=!0}return e.apply(this,arguments)}}var Fn,qn={};function Wn(e,t){var n={seen:[],stylize:Gn};return arguments.length>=3&&(n.depth=arguments[2]),arguments.length>=4&&(n.colors=arguments[3]),Xn(t)?n.showHidden=t:t&&function(e,t){if(!t||!er(t))return e;var n=Object.keys(t),r=n.length;for(;r--;)e[n[r]]=t[n[r]]}(n,t),Kn(n.showHidden)&&(n.showHidden=!1),Kn(n.depth)&&(n.depth=2),Kn(n.colors)&&(n.colors=!1),Kn(n.customInspect)&&(n.customInspect=!0),n.colors&&(n.stylize=Vn),Jn(n,e,n.depth)}function Vn(e,t){var n=Wn.styles[t];return n?"["+Wn.colors[n][0]+"m"+e+"["+Wn.colors[n][1]+"m":e}function Gn(e,t){return e}function Jn(e,t,n){if(e.customInspect&&t&&rr(t.inspect)&&t.inspect!==Wn&&(!t.constructor||t.constructor.prototype!==t)){var r=t.inspect(n,e);return $n(r)||(r=Jn(e,r,n)),r}var i=function(e,t){if(Kn(t))return e.stylize("undefined","undefined");if($n(t)){var n="'"+JSON.stringify(t).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return e.stylize(n,"string")}if(r=t,"number"==typeof r)return e.stylize(""+t,"number");var r;if(Xn(t))return e.stylize(""+t,"boolean");if(Yn(t))return e.stylize("null","null")}(e,t);if(i)return i;var o=Object.keys(t),s=function(e){var t={};return e.forEach((function(e,n){t[e]=!0})),t}(o);if(e.showHidden&&(o=Object.getOwnPropertyNames(t)),nr(t)&&(o.indexOf("message")>=0||o.indexOf("description")>=0))return Hn(t);if(0===o.length){if(rr(t)){var a=t.name?": "+t.name:"";return e.stylize("[Function"+a+"]","special")}if(Qn(t))return e.stylize(RegExp.prototype.toString.call(t),"regexp");if(tr(t))return e.stylize(Date.prototype.toString.call(t),"date");if(nr(t))return Hn(t)}var c,l,u="",d=!1,h=["{","}"];(c=t,Array.isArray(c)&&(d=!0,h=["[","]"]),rr(t))&&(u=" [Function"+(t.name?": "+t.name:"")+"]");return Qn(t)&&(u=" "+RegExp.prototype.toString.call(t)),tr(t)&&(u=" "+Date.prototype.toUTCString.call(t)),nr(t)&&(u=" "+Hn(t)),0!==o.length||d&&0!=t.length?n<0?Qn(t)?e.stylize(RegExp.prototype.toString.call(t),"regexp"):e.stylize("[Object]","special"):(e.seen.push(t),l=d?function(e,t,n,r,i){for(var o=[],s=0,a=t.length;s<a;++s)or(t,String(s))?o.push(Zn(e,t,n,r,String(s),!0)):o.push("");return i.forEach((function(i){i.match(/^\d+$/)||o.push(Zn(e,t,n,r,i,!0))})),o}(e,t,n,s,o):o.map((function(r){return Zn(e,t,n,s,r,d)})),e.seen.pop(),function(e,t,n){var r=e.reduce((function(e,t){return t.indexOf("\n"),e+t.replace(/\u001b\[\d\d?m/g,"").length+1}),0);if(r>60)return n[0]+(""===t?"":t+"\n ")+" "+e.join(",\n  ")+" "+n[1];return n[0]+t+" "+e.join(", ")+" "+n[1]}(l,u,h)):h[0]+u+h[1]}function Hn(e){return"["+Error.prototype.toString.call(e)+"]"}function Zn(e,t,n,r,i,o){var s,a,c;if((c=Object.getOwnPropertyDescriptor(t,i)||{value:t[i]}).get?a=c.set?e.stylize("[Getter/Setter]","special"):e.stylize("[Getter]","special"):c.set&&(a=e.stylize("[Setter]","special")),or(r,i)||(s="["+i+"]"),a||(e.seen.indexOf(c.value)<0?(a=Yn(n)?Jn(e,c.value,null):Jn(e,c.value,n-1)).indexOf("\n")>-1&&(a=o?a.split("\n").map((function(e){return"  "+e})).join("\n").substr(2):"\n"+a.split("\n").map((function(e){return"   "+e})).join("\n")):a=e.stylize("[Circular]","special")),Kn(s)){if(o&&i.match(/^\d+$/))return a;(s=JSON.stringify(""+i)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(s=s.substr(1,s.length-2),s=e.stylize(s,"name")):(s=s.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),s=e.stylize(s,"string"))}return s+": "+a}function Xn(e){return"boolean"==typeof e}function Yn(e){return null===e}function $n(e){return"string"==typeof e}function Kn(e){return void 0===e}function Qn(e){return er(e)&&"[object RegExp]"===ir(e)}function er(e){return"object"==typeof e&&null!==e}function tr(e){return er(e)&&"[object Date]"===ir(e)}function nr(e){return er(e)&&("[object Error]"===ir(e)||e instanceof Error)}function rr(e){return"function"==typeof e}function ir(e){return Object.prototype.toString.call(e)}function or(e,t){return Object.prototype.hasOwnProperty.call(e,t)}Wn.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},Wn.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"};var sr=D(te());function ar(){this.head=null,this.tail=null,this.length=0}ar.prototype.push=function(e){var t={data:e,next:null};this.length>0?this.tail.next=t:this.head=t,this.tail=t,++this.length},ar.prototype.unshift=function(e){var t={data:e,next:this.head};0===this.length&&(this.tail=t),this.head=t,++this.length},ar.prototype.shift=function(){if(0!==this.length){var e=this.head.data;return 1===this.length?this.head=this.tail=null:this.head=this.head.next,--this.length,e}},ar.prototype.clear=function(){this.head=this.tail=null,this.length=0},ar.prototype.join=function(e){if(0===this.length)return"";for(var t=this.head,n=""+t.data;t=t.next;)n+=e+t.data;return n},ar.prototype.concat=function(e){if(0===this.length)return ft.alloc(0);if(1===this.length)return this.head.data;for(var t=ft.allocUnsafe(e>>>0),n=this.head,r=0;n;)n.data.copy(t,r),r+=n.data.length,n=n.next;return t};var cr=ft.isEncoding||function(e){switch(e&&e.toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return!0;default:return!1}};function lr(e){switch(this.encoding=(e||"utf8").toLowerCase().replace(/[-_]/,""),function(e){if(e&&!cr(e))throw new Error("Unknown encoding: "+e)}(e),this.encoding){case"utf8":this.surrogateSize=3;break;case"ucs2":case"utf16le":this.surrogateSize=2,this.detectIncompleteChar=dr;break;case"base64":this.surrogateSize=3,this.detectIncompleteChar=hr;break;default:return void(this.write=ur)}this.charBuffer=new ft(6),this.charReceived=0,this.charLength=0}function ur(e){return e.toString(this.encoding)}function dr(e){this.charReceived=e.length%2,this.charLength=this.charReceived?2:0}function hr(e){this.charReceived=e.length%3,this.charLength=this.charReceived?3:0}lr.prototype.write=function(e){for(var t="";this.charLength;){var n=e.length>=this.charLength-this.charReceived?this.charLength-this.charReceived:e.length;if(e.copy(this.charBuffer,this.charReceived,0,n),this.charReceived+=n,this.charReceived<this.charLength)return"";if(e=e.slice(n,e.length),!((i=(t=this.charBuffer.slice(0,this.charLength).toString(this.encoding)).charCodeAt(t.length-1))>=55296&&i<=56319)){if(this.charReceived=this.charLength=0,0===e.length)return t;break}this.charLength+=this.surrogateSize,t=""}this.detectIncompleteChar(e);var r=e.length;this.charLength&&(e.copy(this.charBuffer,0,e.length-this.charReceived,r),r-=this.charReceived);var i;r=(t+=e.toString(this.encoding,0,r)).length-1;if((i=t.charCodeAt(r))>=55296&&i<=56319){var o=this.surrogateSize;return this.charLength+=o,this.charReceived+=o,this.charBuffer.copy(this.charBuffer,o,0,o),e.copy(this.charBuffer,0,0,o),t.substring(0,r)}return t},lr.prototype.detectIncompleteChar=function(e){for(var t=e.length>=3?3:e.length;t>0;t--){var n=e[e.length-t];if(1==t&&n>>5==6){this.charLength=2;break}if(t<=2&&n>>4==14){this.charLength=3;break}if(t<=3&&n>>3==30){this.charLength=4;break}}this.charReceived=t},lr.prototype.end=function(e){var t="";if(e&&e.length&&(t=this.write(e)),this.charReceived){var n=this.charReceived,r=this.charBuffer,i=this.encoding;t+=r.slice(0,n).toString(i)}return t},mr.ReadableState=pr;var fr=function(e){if(Kn(Fn)&&(Fn=Tn.env.NODE_DEBUG||""),e=e.toUpperCase(),!qn[e])if(new RegExp("\\b"+e+"\\b","i").test(Fn)){qn[e]=function(){var t=zn.apply(null,arguments);console.error("%s %d: %s",e,0,t)}}else qn[e]=function(){};return qn[e]}("stream");function pr(e,t){e=e||{},this.objectMode=!!e.objectMode,t instanceof Wr&&(this.objectMode=this.objectMode||!!e.readableObjectMode);var n=e.highWaterMark,r=this.objectMode?16:16384;this.highWaterMark=n||0===n?n:r,this.highWaterMark=~~this.highWaterMark,this.buffer=new ar,this.length=0,this.pipes=null,this.pipesCount=0,this.flowing=null,this.ended=!1,this.endEmitted=!1,this.reading=!1,this.sync=!0,this.needReadable=!1,this.emittedReadable=!1,this.readableListening=!1,this.resumeScheduled=!1,this.defaultEncoding=e.defaultEncoding||"utf8",this.ranOut=!1,this.awaitDrain=0,this.readingMore=!1,this.decoder=null,this.encoding=null,e.encoding&&(this.decoder=new lr(e.encoding),this.encoding=e.encoding)}function mr(e){if(!(this instanceof mr))return new mr(e);this._readableState=new pr(e,this),this.readable=!0,e&&"function"==typeof e.read&&(this._read=e.read),sr.call(this)}function gr(e,t,n,r,i){var o=function(e,t){var n=null;ft.isBuffer(t)||"string"==typeof t||null==t||e.objectMode||(n=new TypeError("Invalid non-string/buffer chunk"));return n}(t,n);if(o)e.emit("error",o);else if(null===n)t.reading=!1,function(e,t){if(t.ended)return;if(t.decoder){var n=t.decoder.end();n&&n.length&&(t.buffer.push(n),t.length+=t.objectMode?1:n.length)}t.ended=!0,br(e)}(e,t);else if(t.objectMode||n&&n.length>0)if(t.ended&&!i){var s=new Error("stream.push() after EOF");e.emit("error",s)}else if(t.endEmitted&&i){var a=new Error("stream.unshift() after end event");e.emit("error",a)}else{var c;!t.decoder||i||r||(n=t.decoder.write(n),c=!t.objectMode&&0===n.length),i||(t.reading=!1),c||(t.flowing&&0===t.length&&!t.sync?(e.emit("data",n),e.read(0)):(t.length+=t.objectMode?1:n.length,i?t.buffer.unshift(n):t.buffer.push(n),t.needReadable&&br(e))),function(e,t){t.readingMore||(t.readingMore=!0,dn(wr,e,t))}(e,t)}else i||(t.reading=!1);return function(e){return!e.ended&&(e.needReadable||e.length<e.highWaterMark||0===e.length)}(t)}Rn(mr,sr),mr.prototype.push=function(e,t){var n=this._readableState;return n.objectMode||"string"!=typeof e||(t=t||n.defaultEncoding)!==n.encoding&&(e=ft.from(e,t),t=""),gr(this,n,e,t,!1)},mr.prototype.unshift=function(e){return gr(this,this._readableState,e,"",!0)},mr.prototype.isPaused=function(){return!1===this._readableState.flowing},mr.prototype.setEncoding=function(e){return this._readableState.decoder=new lr(e),this._readableState.encoding=e,this};var vr=8388608;function yr(e,t){return e<=0||0===t.length&&t.ended?0:t.objectMode?1:e!=e?t.flowing&&t.length?t.buffer.head.data.length:t.length:(e>t.highWaterMark&&(t.highWaterMark=function(e){return e>=vr?e=vr:(e--,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,e|=e>>>16,e++),e}(e)),e<=t.length?e:t.ended?t.length:(t.needReadable=!0,0))}function br(e){var t=e._readableState;t.needReadable=!1,t.emittedReadable||(fr("emitReadable",t.flowing),t.emittedReadable=!0,t.sync?dn(_r,e):_r(e))}function _r(e){fr("emit readable"),e.emit("readable"),Cr(e)}function wr(e,t){for(var n=t.length;!t.reading&&!t.flowing&&!t.ended&&t.length<t.highWaterMark&&(fr("maybeReadMore read 0"),e.read(0),n!==t.length);)n=t.length;t.readingMore=!1}function Sr(e){fr("readable nexttick read 0"),e.read(0)}function Er(e,t){t.reading||(fr("resume read 0"),e.read(0)),t.resumeScheduled=!1,t.awaitDrain=0,e.emit("resume"),Cr(e),t.flowing&&!t.reading&&e.read(0)}function Cr(e){var t=e._readableState;for(fr("flow",t.flowing);t.flowing&&null!==e.read(););}function kr(e,t){return 0===t.length?null:(t.objectMode?n=t.buffer.shift():!e||e>=t.length?(n=t.decoder?t.buffer.join(""):1===t.buffer.length?t.buffer.head.data:t.buffer.concat(t.length),t.buffer.clear()):n=function(e,t,n){var r;e<t.head.data.length?(r=t.head.data.slice(0,e),t.head.data=t.head.data.slice(e)):r=e===t.head.data.length?t.shift():n?function(e,t){var n=t.head,r=1,i=n.data;e-=i.length;for(;n=n.next;){var o=n.data,s=e>o.length?o.length:e;if(s===o.length?i+=o:i+=o.slice(0,e),0===(e-=s)){s===o.length?(++r,n.next?t.head=n.next:t.head=t.tail=null):(t.head=n,n.data=o.slice(s));break}++r}return t.length-=r,i}(e,t):function(e,t){var n=ft.allocUnsafe(e),r=t.head,i=1;r.data.copy(n),e-=r.data.length;for(;r=r.next;){var o=r.data,s=e>o.length?o.length:e;if(o.copy(n,n.length-e,0,s),0===(e-=s)){s===o.length?(++i,r.next?t.head=r.next:t.head=t.tail=null):(t.head=r,r.data=o.slice(s));break}++i}return t.length-=i,n}(e,t);return r}(e,t.buffer,t.decoder),n);var n}function Tr(e){var t=e._readableState;if(t.length>0)throw new Error('"endReadable()" called on non-empty stream');t.endEmitted||(t.ended=!0,dn(xr,t,e))}function xr(e,t){e.endEmitted||0!==e.length||(e.endEmitted=!0,t.readable=!1,t.emit("end"))}function Ir(e,t){for(var n=0,r=e.length;n<r;n++)if(e[n]===t)return n;return-1}function Rr(){}function Or(e,t,n){this.chunk=e,this.encoding=t,this.callback=n,this.next=null}function Ar(e,t){Object.defineProperty(this,"buffer",{get:Bn((function(){return this.getBuffer()}),"_writableState.buffer is deprecated. Use _writableState.getBuffer instead.")}),e=e||{},this.objectMode=!!e.objectMode,t instanceof Wr&&(this.objectMode=this.objectMode||!!e.writableObjectMode);var n=e.highWaterMark,r=this.objectMode?16:16384;this.highWaterMark=n||0===n?n:r,this.highWaterMark=~~this.highWaterMark,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1;var i=!1===e.decodeStrings;this.decodeStrings=!i,this.defaultEncoding=e.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(e){!function(e,t){var n=e._writableState,r=n.sync,i=n.writecb;if(function(e){e.writing=!1,e.writecb=null,e.length-=e.writelen,e.writelen=0}(n),t)!function(e,t,n,r,i){--t.pendingcb,n?dn(i,r):i(r);e._writableState.errorEmitted=!0,e.emit("error",r)}(e,n,r,t,i);else{var o=Mr(n);o||n.corked||n.bufferProcessing||!n.bufferedRequest||Nr(e,n),r?dn(Dr,e,n,o,i):Dr(e,n,o,i)}}(t,e)},this.writecb=null,this.writelen=0,this.bufferedRequest=null,this.lastBufferedRequest=null,this.pendingcb=0,this.prefinished=!1,this.errorEmitted=!1,this.bufferedRequestCount=0,this.corkedRequestsFree=new zr(this)}function Lr(e){if(!(this instanceof Lr||this instanceof Wr))return new Lr(e);this._writableState=new Ar(e,this),this.writable=!0,e&&("function"==typeof e.write&&(this._write=e.write),"function"==typeof e.writev&&(this._writev=e.writev)),sr.call(this)}function Pr(e,t,n,r,i,o,s){t.writelen=r,t.writecb=s,t.writing=!0,t.sync=!0,n?e._writev(i,t.onwrite):e._write(i,o,t.onwrite),t.sync=!1}function Dr(e,t,n,r){n||function(e,t){0===t.length&&t.needDrain&&(t.needDrain=!1,e.emit("drain"))}(e,t),t.pendingcb--,r(),Ur(e,t)}function Nr(e,t){t.bufferProcessing=!0;var n=t.bufferedRequest;if(e._writev&&n&&n.next){var r=t.bufferedRequestCount,i=new Array(r),o=t.corkedRequestsFree;o.entry=n;for(var s=0;n;)i[s]=n,n=n.next,s+=1;Pr(e,t,!0,t.length,i,"",o.finish),t.pendingcb++,t.lastBufferedRequest=null,o.next?(t.corkedRequestsFree=o.next,o.next=null):t.corkedRequestsFree=new zr(t)}else{for(;n;){var a=n.chunk,c=n.encoding,l=n.callback;if(Pr(e,t,!1,t.objectMode?1:a.length,a,c,l),n=n.next,t.writing)break}null===n&&(t.lastBufferedRequest=null)}t.bufferedRequestCount=0,t.bufferedRequest=n,t.bufferProcessing=!1}function Mr(e){return e.ending&&0===e.length&&null===e.bufferedRequest&&!e.finished&&!e.writing}function jr(e,t){t.prefinished||(t.prefinished=!0,e.emit("prefinish"))}function Ur(e,t){var n=Mr(t);return n&&(0===t.pendingcb?(jr(e,t),t.finished=!0,e.emit("finish")):jr(e,t)),n}function zr(e){var t=this;this.next=null,this.entry=null,this.finish=function(n){var r=t.entry;for(t.entry=null;r;){var i=r.callback;e.pendingcb--,i(n),r=r.next}e.corkedRequestsFree?e.corkedRequestsFree.next=t:e.corkedRequestsFree=t}}mr.prototype.read=function(e){fr("read",e),e=parseInt(e,10);var t=this._readableState,n=e;if(0!==e&&(t.emittedReadable=!1),0===e&&t.needReadable&&(t.length>=t.highWaterMark||t.ended))return fr("read: emitReadable",t.length,t.ended),0===t.length&&t.ended?Tr(this):br(this),null;if(0===(e=yr(e,t))&&t.ended)return 0===t.length&&Tr(this),null;var r,i=t.needReadable;return fr("need readable",i),(0===t.length||t.length-e<t.highWaterMark)&&fr("length less than watermark",i=!0),t.ended||t.reading?fr("reading or ended",i=!1):i&&(fr("do read"),t.reading=!0,t.sync=!0,0===t.length&&(t.needReadable=!0),this._read(t.highWaterMark),t.sync=!1,t.reading||(e=yr(n,t))),null===(r=e>0?kr(e,t):null)?(t.needReadable=!0,e=0):t.length-=e,0===t.length&&(t.ended||(t.needReadable=!0),n!==e&&t.ended&&Tr(this)),null!==r&&this.emit("data",r),r},mr.prototype._read=function(e){this.emit("error",new Error("not implemented"))},mr.prototype.pipe=function(e,t){var n=this,r=this._readableState;switch(r.pipesCount){case 0:r.pipes=e;break;case 1:r.pipes=[r.pipes,e];break;default:r.pipes.push(e)}r.pipesCount+=1,fr("pipe count=%d opts=%j",r.pipesCount,t);var i=!t||!1!==t.end?s:l;function o(e){fr("onunpipe"),e===n&&l()}function s(){fr("onend"),e.end()}r.endEmitted?dn(i):n.once("end",i),e.on("unpipe",o);var a=function(e){return function(){var t=e._readableState;fr("pipeOnDrain",t.awaitDrain),t.awaitDrain&&t.awaitDrain--,0===t.awaitDrain&&e.listeners("data").length&&(t.flowing=!0,Cr(e))}}(n);e.on("drain",a);var c=!1;function l(){fr("cleanup"),e.removeListener("close",f),e.removeListener("finish",p),e.removeListener("drain",a),e.removeListener("error",h),e.removeListener("unpipe",o),n.removeListener("end",s),n.removeListener("end",l),n.removeListener("data",d),c=!0,!r.awaitDrain||e._writableState&&!e._writableState.needDrain||a()}var u=!1;function d(t){fr("ondata"),u=!1,!1!==e.write(t)||u||((1===r.pipesCount&&r.pipes===e||r.pipesCount>1&&-1!==Ir(r.pipes,e))&&!c&&(fr("false write response, pause",n._readableState.awaitDrain),n._readableState.awaitDrain++,u=!0),n.pause())}function h(t){var n;fr("onerror",t),m(),e.removeListener("error",h),0===(n="error",e.listeners(n).length)&&e.emit("error",t)}function f(){e.removeListener("finish",p),m()}function p(){fr("onfinish"),e.removeListener("close",f),m()}function m(){fr("unpipe"),n.unpipe(e)}return n.on("data",d),function(e,t,n){if("function"==typeof e.prependListener)return e.prependListener(t,n);e._events&&e._events[t]?Array.isArray(e._events[t])?e._events[t].unshift(n):e._events[t]=[n,e._events[t]]:e.on(t,n)}(e,"error",h),e.once("close",f),e.once("finish",p),e.emit("pipe",n),r.flowing||(fr("pipe resume"),n.resume()),e},mr.prototype.unpipe=function(e){var t=this._readableState;if(0===t.pipesCount)return this;if(1===t.pipesCount)return e&&e!==t.pipes||(e||(e=t.pipes),t.pipes=null,t.pipesCount=0,t.flowing=!1,e&&e.emit("unpipe",this)),this;if(!e){var n=t.pipes,r=t.pipesCount;t.pipes=null,t.pipesCount=0,t.flowing=!1;for(var i=0;i<r;i++)n[i].emit("unpipe",this);return this}var o=Ir(t.pipes,e);return-1===o||(t.pipes.splice(o,1),t.pipesCount-=1,1===t.pipesCount&&(t.pipes=t.pipes[0]),e.emit("unpipe",this)),this},mr.prototype.on=function(e,t){var n=sr.prototype.on.call(this,e,t);if("data"===e)!1!==this._readableState.flowing&&this.resume();else if("readable"===e){var r=this._readableState;r.endEmitted||r.readableListening||(r.readableListening=r.needReadable=!0,r.emittedReadable=!1,r.reading?r.length&&br(this):dn(Sr,this))}return n},mr.prototype.addListener=mr.prototype.on,mr.prototype.resume=function(){var e=this._readableState;return e.flowing||(fr("resume"),e.flowing=!0,function(e,t){t.resumeScheduled||(t.resumeScheduled=!0,dn(Er,e,t))}(this,e)),this},mr.prototype.pause=function(){return fr("call pause flowing=%j",this._readableState.flowing),!1!==this._readableState.flowing&&(fr("pause"),this._readableState.flowing=!1,this.emit("pause")),this},mr.prototype.wrap=function(e){var t=this._readableState,n=!1,r=this;for(var i in e.on("end",(function(){if(fr("wrapped end"),t.decoder&&!t.ended){var e=t.decoder.end();e&&e.length&&r.push(e)}r.push(null)})),e.on("data",(function(i){(fr("wrapped data"),t.decoder&&(i=t.decoder.write(i)),t.objectMode&&null==i)||(t.objectMode||i&&i.length)&&(r.push(i)||(n=!0,e.pause()))})),e)void 0===this[i]&&"function"==typeof e[i]&&(this[i]=function(t){return function(){return e[t].apply(e,arguments)}}(i));return function(e,t){for(var n=0,r=e.length;n<r;n++)t(e[n],n)}(["error","close","destroy","pause","resume"],(function(t){e.on(t,r.emit.bind(r,t))})),r._read=function(t){fr("wrapped _read",t),n&&(n=!1,e.resume())},r},mr._fromList=kr,Lr.WritableState=Ar,Rn(Lr,sr),Ar.prototype.getBuffer=function(){for(var e=this.bufferedRequest,t=[];e;)t.push(e),e=e.next;return t},Lr.prototype.pipe=function(){this.emit("error",new Error("Cannot pipe, not readable"))},Lr.prototype.write=function(e,t,n){var r=this._writableState,i=!1;return"function"==typeof t&&(n=t,t=null),ft.isBuffer(e)?t="buffer":t||(t=r.defaultEncoding),"function"!=typeof n&&(n=Rr),r.ended?function(e,t){var n=new Error("write after end");e.emit("error",n),dn(t,n)}(this,n):function(e,t,n,r){var i=!0,o=!1;return null===n?o=new TypeError("May not write null values to stream"):ft.isBuffer(n)||"string"==typeof n||void 0===n||t.objectMode||(o=new TypeError("Invalid non-string/buffer chunk")),o&&(e.emit("error",o),dn(r,o),i=!1),i}(this,r,e,n)&&(r.pendingcb++,i=function(e,t,n,r,i){n=function(e,t,n){e.objectMode||!1===e.decodeStrings||"string"!=typeof t||(t=ft.from(t,n));return t}(t,n,r),ft.isBuffer(n)&&(r="buffer");var o=t.objectMode?1:n.length;t.length+=o;var s=t.length<t.highWaterMark;s||(t.needDrain=!0);if(t.writing||t.corked){var a=t.lastBufferedRequest;t.lastBufferedRequest=new Or(n,r,i),a?a.next=t.lastBufferedRequest:t.bufferedRequest=t.lastBufferedRequest,t.bufferedRequestCount+=1}else Pr(e,t,!1,o,n,r,i);return s}(this,r,e,t,n)),i},Lr.prototype.cork=function(){this._writableState.corked++},Lr.prototype.uncork=function(){var e=this._writableState;e.corked&&(e.corked--,e.writing||e.corked||e.finished||e.bufferProcessing||!e.bufferedRequest||Nr(this,e))},Lr.prototype.setDefaultEncoding=function(e){if("string"==typeof e&&(e=e.toLowerCase()),!(["hex","utf8","utf-8","ascii","binary","base64","ucs2","ucs-2","utf16le","utf-16le","raw"].indexOf((e+"").toLowerCase())>-1))throw new TypeError("Unknown encoding: "+e);return this._writableState.defaultEncoding=e,this},Lr.prototype._write=function(e,t,n){n(new Error("not implemented"))},Lr.prototype._writev=null,Lr.prototype.end=function(e,t,n){var r=this._writableState;"function"==typeof e?(n=e,e=null,t=null):"function"==typeof t&&(n=t,t=null),null!=e&&this.write(e,t),r.corked&&(r.corked=1,this.uncork()),r.ending||r.finished||function(e,t,n){t.ending=!0,Ur(e,t),n&&(t.finished?dn(n):e.once("finish",n));t.ended=!0,e.writable=!1}(this,r,n)},Rn(Wr,mr);for(var Br=Object.keys(Lr.prototype),Fr=0;Fr<Br.length;Fr++){var qr=Br[Fr];Wr.prototype[qr]||(Wr.prototype[qr]=Lr.prototype[qr])}function Wr(e){if(!(this instanceof Wr))return new Wr(e);mr.call(this,e),Lr.call(this,e),e&&!1===e.readable&&(this.readable=!1),e&&!1===e.writable&&(this.writable=!1),this.allowHalfOpen=!0,e&&!1===e.allowHalfOpen&&(this.allowHalfOpen=!1),this.once("end",Vr)}function Vr(){this.allowHalfOpen||this._writableState.ended||dn(Gr,this)}function Gr(e){e.end()}function Jr(e){this.afterTransform=function(t,n){return function(e,t,n){var r=e._transformState;r.transforming=!1;var i=r.writecb;if(!i)return e.emit("error",new Error("no writecb in Transform class"));r.writechunk=null,r.writecb=null,null!=n&&e.push(n);i(t);var o=e._readableState;o.reading=!1,(o.needReadable||o.length<o.highWaterMark)&&e._read(o.highWaterMark)}(e,t,n)},this.needTransform=!1,this.transforming=!1,this.writecb=null,this.writechunk=null,this.writeencoding=null}function Hr(e){if(!(this instanceof Hr))return new Hr(e);Wr.call(this,e),this._transformState=new Jr(this);var t=this;this._readableState.needReadable=!0,this._readableState.sync=!1,e&&("function"==typeof e.transform&&(this._transform=e.transform),"function"==typeof e.flush&&(this._flush=e.flush)),this.once("prefinish",(function(){"function"==typeof this._flush?this._flush((function(e){Zr(t,e)})):Zr(t)}))}function Zr(e,t){if(t)return e.emit("error",t);var n=e._writableState,r=e._transformState;if(n.length)throw new Error("Calling transform done when ws.length != 0");if(r.transforming)throw new Error("Calling transform done when still transforming");return e.push(null)}function Xr(e){if(!(this instanceof Xr))return new Xr(e);Hr.call(this,e)}function Yr(){sr.call(this)}Rn(Hr,Wr),Hr.prototype.push=function(e,t){return this._transformState.needTransform=!1,Wr.prototype.push.call(this,e,t)},Hr.prototype._transform=function(e,t,n){throw new Error("Not implemented")},Hr.prototype._write=function(e,t,n){var r=this._transformState;if(r.writecb=n,r.writechunk=e,r.writeencoding=t,!r.transforming){var i=this._readableState;(r.needTransform||i.needReadable||i.length<i.highWaterMark)&&this._read(i.highWaterMark)}},Hr.prototype._read=function(e){var t=this._transformState;null!==t.writechunk&&t.writecb&&!t.transforming?(t.transforming=!0,this._transform(t.writechunk,t.writeencoding,t.afterTransform)):t.needTransform=!0},Rn(Xr,Hr),Xr.prototype._transform=function(e,t,n){n(null,e)},Rn(Yr,sr),Yr.Readable=mr,Yr.Writable=Lr,Yr.Duplex=Wr,Yr.Transform=Hr,Yr.PassThrough=Xr,Yr.Stream=Yr,Yr.prototype.pipe=function(e,t){var n=this;function r(t){e.writable&&!1===e.write(t)&&n.pause&&n.pause()}function i(){n.readable&&n.resume&&n.resume()}n.on("data",r),e.on("drain",i),e._isStdio||t&&!1===t.end||(n.on("end",s),n.on("close",a));var o=!1;function s(){o||(o=!0,e.end())}function a(){o||(o=!0,"function"==typeof e.destroy&&e.destroy())}function c(e){if(l(),0===sr.listenerCount(this,"error"))throw e}function l(){n.removeListener("data",r),e.removeListener("drain",i),n.removeListener("end",s),n.removeListener("close",a),n.removeListener("error",c),e.removeListener("error",c),n.removeListener("end",l),n.removeListener("close",l),e.removeListener("close",l)}return n.on("error",c),e.on("error",c),n.on("end",l),n.on("close",l),e.on("close",l),e.emit("pipe",n),e};var $r=Object.freeze({__proto__:null,Duplex:Wr,PassThrough:Xr,Readable:mr,Stream:Yr,Transform:Hr,Writable:Lr,default:Yr}),Kr=3,Qr=4;function ei(e,t,n){var r,i=this;if(mr.call(i),i._mode=n,i.headers={},i.rawHeaders=[],i.trailers={},i.rawTrailers=[],i.on("end",(function(){Tn.nextTick((function(){i.emit("close")}))})),"fetch"===n){i._fetchResponse=t,i.url=t.url,i.statusCode=t.status,i.statusMessage=t.statusText;for(var o,s,a=t.headers[Symbol.iterator]();o=(s=a.next()).value,!s.done;)i.headers[o[0].toLowerCase()]=o[1],i.rawHeaders.push(o[0],o[1]);var c=t.body.getReader();(r=function(){c.read().then((function(e){i._destroyed||(e.done?i.push(null):(i.push(new ft(e.value)),r()))}))})()}else{if(i._xhr=e,i._pos=0,i.url=e.responseURL,i.statusCode=e.status,i.statusMessage=e.statusText,e.getAllResponseHeaders().split(/\r?\n/).forEach((function(e){var t=e.match(/^([^:]+):\s*(.*)/);if(t){var n=t[1].toLowerCase();"set-cookie"===n?(void 0===i.headers[n]&&(i.headers[n]=[]),i.headers[n].push(t[2])):void 0!==i.headers[n]?i.headers[n]+=", "+t[2]:i.headers[n]=t[2],i.rawHeaders.push(t[1],t[2])}})),i._charset="x-user-defined",!Nn){var l=i.rawHeaders["mime-type"];if(l){var u=l.match(/;\s*charset=([^;])(;|$)/);u&&(i._charset=u[1].toLowerCase())}i._charset||(i._charset="utf-8")}}}function ti(e){var t,n=this;Lr.call(n),n._opts=e,n._body=[],n._headers={},e.auth&&n.setHeader("Authorization","Basic "+new ft(e.auth).toString("base64")),Object.keys(e.headers).forEach((function(t){n.setHeader(t,e.headers[t])}));var r=!0;if("disable-fetch"===e.mode)r=!1,t=!0;else if("prefer-streaming"===e.mode)t=!1;else if("allow-wrong-content-type"===e.mode)t=!Nn;else{if(e.mode&&"default"!==e.mode&&"prefer-fast"!==e.mode)throw new Error("Invalid value for opts.mode");t=!0}n._mode=function(e,t){return xn&&t?"fetch":Dn?"moz-chunked-arraybuffer":Pn?"ms-stream":Ln&&e?"arraybuffer":Mn&&e?"text:vbarray":"text"}(t,r),n.on("finish",(function(){n._onFinish()}))}Rn(ei,mr),ei.prototype._read=function(){},ei.prototype._onXHRProgress=function(){var e=this,t=e._xhr,n=null;switch(e._mode){case"text:vbarray":if(t.readyState!==Qr)break;try{n=new Ke.VBArray(t.responseBody).toArray()}catch(e){}if(null!==n){e.push(new ft(n));break}case"text":try{n=t.responseText}catch(t){e._mode="text:vbarray";break}if(n.length>e._pos){var r=n.substr(e._pos);if("x-user-defined"===e._charset){for(var i=new ft(r.length),o=0;o<r.length;o++)i[o]=255&r.charCodeAt(o);e.push(i)}else e.push(r,e._charset);e._pos=n.length}break;case"arraybuffer":if(t.readyState!==Qr||!t.response)break;n=t.response,e.push(new ft(new Uint8Array(n)));break;case"moz-chunked-arraybuffer":if(n=t.response,t.readyState!==Kr||!n)break;e.push(new ft(new Uint8Array(n)));break;case"ms-stream":if(n=t.response,t.readyState!==Kr)break;var s=new Ke.MSStreamReader;s.onprogress=function(){s.result.byteLength>e._pos&&(e.push(new ft(new Uint8Array(s.result.slice(e._pos)))),e._pos=s.result.byteLength)},s.onload=function(){e.push(null)},s.readAsArrayBuffer(n)}e._xhr.readyState===Qr&&"ms-stream"!==e._mode&&e.push(null)},Rn(ti,Lr);var ni=["accept-charset","accept-encoding","access-control-request-headers","access-control-request-method","connection","content-length","cookie","cookie2","date","dnt","expect","host","keep-alive","origin","referer","te","trailer","transfer-encoding","upgrade","user-agent","via"];ti.prototype.setHeader=function(e,t){var n=e.toLowerCase();-1===ni.indexOf(n)&&(this._headers[n]={name:e,value:t})},ti.prototype.getHeader=function(e){return this._headers[e.toLowerCase()].value},ti.prototype.removeHeader=function(e){delete this._headers[e.toLowerCase()]},ti.prototype._onFinish=function(){var e=this;if(!e._destroyed){var t,n=e._opts,r=e._headers;if("POST"!==n.method&&"PUT"!==n.method&&"PATCH"!==n.method||(t=function(){if(void 0!==Cn)return Cn;try{new Ke.Blob([new ArrayBuffer(1)]),Cn=!0}catch(e){Cn=!1}return Cn}()?new Ke.Blob(e._body.map((function(e){return function(e){if(e instanceof Uint8Array){if(0===e.byteOffset&&e.byteLength===e.buffer.byteLength)return e.buffer;if("function"==typeof e.buffer.slice)return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}if(Yt(e)){for(var t=new Uint8Array(e.length),n=e.length,r=0;r<n;r++)t[r]=e[r];return t.buffer}throw new Error("Argument must be a Buffer")}(e)})),{type:(r["content-type"]||{}).value||""}):ft.concat(e._body).toString()),"fetch"===e._mode){var i=Object.keys(r).map((function(e){return[r[e].name,r[e].value]}));Ke.fetch(e._opts.url,{method:e._opts.method,headers:i,body:t,mode:"cors",credentials:n.withCredentials?"include":"same-origin"}).then((function(t){e._fetchResponse=t,e._connect()}),(function(t){e.emit("error",t)}))}else{var o=e._xhr=new Ke.XMLHttpRequest;try{o.open(e._opts.method,e._opts.url,!0)}catch(t){return void Tn.nextTick((function(){e.emit("error",t)}))}"responseType"in o&&(o.responseType=e._mode.split(":")[0]),"withCredentials"in o&&(o.withCredentials=!!n.withCredentials),"text"===e._mode&&"overrideMimeType"in o&&o.overrideMimeType("text/plain; charset=x-user-defined"),Object.keys(r).forEach((function(e){o.setRequestHeader(r[e].name,r[e].value)})),e._response=null,o.onreadystatechange=function(){switch(o.readyState){case Kr:case Qr:e._onXHRProgress()}},"moz-chunked-arraybuffer"===e._mode&&(o.onprogress=function(){e._onXHRProgress()}),o.onerror=function(){e._destroyed||e.emit("error",new Error("XHR error"))};try{o.send(t)}catch(t){return void Tn.nextTick((function(){e.emit("error",t)}))}}}},ti.prototype._onXHRProgress=function(){var e=this;(function(e){try{var t=e.status;return null!==t&&0!==t}catch(e){return!1}})(e._xhr)&&!e._destroyed&&(e._response||e._connect(),e._response._onXHRProgress())},ti.prototype._connect=function(){var e=this;e._destroyed||(e._response=new ei(e._xhr,e._fetchResponse,e._mode),e.emit("response",e._response))},ti.prototype._write=function(e,t,n){this._body.push(e),n()},ti.prototype.abort=ti.prototype.destroy=function(){var e=this;e._destroyed=!0,e._response&&(e._response._destroyed=!0),e._xhr&&e._xhr.abort()},ti.prototype.end=function(e,t,n){"function"==typeof e&&(n=e,e=void 0),Lr.prototype.end.call(this,e,t,n)},ti.prototype.flushHeaders=function(){},ti.prototype.setTimeout=function(){},ti.prototype.setNoDelay=function(){},ti.prototype.setSocketKeepAlive=function(){};
/*! https://mths.be/punycode v1.4.1 by @mathias */
var ri=2147483647,ii=/[^\x20-\x7E]/,oi=/[\x2E\u3002\uFF0E\uFF61]/g,si={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},ai=Math.floor,ci=String.fromCharCode;function li(e){throw new RangeError(si[e])}function ui(e,t){return e+22+75*(e<26)-((0!=t)<<5)}function di(e,t,n){var r=0;for(e=n?ai(e/700):e>>1,e+=ai(e/t);e>455;r+=36)e=ai(e/35);return ai(r+36*e/(e+38))}function hi(e){return function(e,t){var n=e.split("@"),r="";n.length>1&&(r=n[0]+"@",e=n[1]);var i=function(e,t){for(var n=e.length,r=[];n--;)r[n]=t(e[n]);return r}((e=e.replace(oi,".")).split("."),t).join(".");return r+i}(e,(function(e){return ii.test(e)?"xn--"+function(e){var t,n,r,i,o,s,a,c,l,u,d,h,f,p,m,g=[];for(e=function(e){for(var t,n,r=[],i=0,o=e.length;i<o;)(t=e.charCodeAt(i++))>=55296&&t<=56319&&i<o?56320==(64512&(n=e.charCodeAt(i++)))?r.push(((1023&t)<<10)+(1023&n)+65536):(r.push(t),i--):r.push(t);return r}(e),h=e.length,t=128,n=0,o=72,s=0;s<h;++s)(d=e[s])<128&&g.push(ci(d));for(r=i=g.length,i&&g.push("-");r<h;){for(a=ri,s=0;s<h;++s)(d=e[s])>=t&&d<a&&(a=d);for(a-t>ai((ri-n)/(f=r+1))&&li("overflow"),n+=(a-t)*f,t=a,s=0;s<h;++s)if((d=e[s])<t&&++n>ri&&li("overflow"),d==t){for(c=n,l=36;!(c<(u=l<=o?1:l>=o+26?26:l-o));l+=36)m=c-u,p=36-u,g.push(ci(ui(u+m%p,0))),c=ai(m/p);g.push(ci(ui(c,0))),o=di(n,f,r==i),n=0,++r}++n,++t}return g.join("")}(e):e}))}function fi(e,t){return Object.prototype.hasOwnProperty.call(e,t)}var pi=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)};function mi(e){switch(typeof e){case"string":return e;case"boolean":return e?"true":"false";case"number":return isFinite(e)?e:"";default:return""}}function gi(e,t){if(e.map)return e.map(t);for(var n=[],r=0;r<e.length;r++)n.push(t(e[r],r));return n}var vi=Object.keys||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t};function yi(e,t,n,r){t=t||"&",n=n||"=";var i={};if("string"!=typeof e||0===e.length)return i;var o=/\+/g;e=e.split(t);var s=1e3;r&&"number"==typeof r.maxKeys&&(s=r.maxKeys);var a=e.length;s>0&&a>s&&(a=s);for(var c=0;c<a;++c){var l,u,d,h,f=e[c].replace(o,"%20"),p=f.indexOf(n);p>=0?(l=f.substr(0,p),u=f.substr(p+1)):(l=f,u=""),d=decodeURIComponent(l),h=decodeURIComponent(u),fi(i,d)?pi(i[d])?i[d].push(h):i[d]=[i[d],h]:i[d]=h}return i}const bi=Ke.URL,_i=Ke.URLSearchParams;var wi={parse:Mi,resolve:Fi,resolveObject:qi,fileURLToPath:Ui,format:zi,Url:Si,URL:bi,URLSearchParams:_i};function Si(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}var Ei=/^([a-z0-9.+-]+:)/i,Ci=/:[0-9]*$/,ki=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,Ti=["{","}","|","\\","^","`"].concat(["<",">",'"',"`"," ","\r","\n","\t"]),xi=["'"].concat(Ti),Ii=["%","/","?",";","#"].concat(xi),Ri=["/","?","#"],Oi=255,Ai=/^[+a-z0-9A-Z_-]{0,63}$/,Li=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,Pi={javascript:!0,"javascript:":!0},Di={javascript:!0,"javascript:":!0},Ni={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0};function Mi(e,t,n){if(e&&er(e)&&e instanceof Si)return e;var r=new Si;return r.parse(e,t,n),r}function ji(e,t,n,r){if(!$n(t))throw new TypeError("Parameter 'url' must be a string, not "+typeof t);var i=t.indexOf("?"),o=-1!==i&&i<t.indexOf("#")?"?":"#",s=t.split(o);s[0]=s[0].replace(/\\/g,"/");var a=t=s.join(o);if(a=a.trim(),!r&&1===t.split("#").length){var c=ki.exec(a);if(c)return e.path=a,e.href=a,e.pathname=c[1],c[2]?(e.search=c[2],e.query=n?yi(e.search.substr(1)):e.search.substr(1)):n&&(e.search="",e.query={}),e}var l,u,d,h,f=Ei.exec(a);if(f){var p=(f=f[0]).toLowerCase();e.protocol=p,a=a.substr(f.length)}if(r||f||a.match(/^\/\/[^@\/]+@[^@\/]+/)){var m="//"===a.substr(0,2);!m||f&&Di[f]||(a=a.substr(2),e.slashes=!0)}if(!Di[f]&&(m||f&&!Ni[f])){var g,v,y=-1;for(l=0;l<Ri.length;l++)-1!==(u=a.indexOf(Ri[l]))&&(-1===y||u<y)&&(y=u);for(-1!==(v=-1===y?a.lastIndexOf("@"):a.lastIndexOf("@",y))&&(g=a.slice(0,v),a=a.slice(v+1),e.auth=decodeURIComponent(g)),y=-1,l=0;l<Ii.length;l++)-1!==(u=a.indexOf(Ii[l]))&&(-1===y||u<y)&&(y=u);-1===y&&(y=a.length),e.host=a.slice(0,y),a=a.slice(y),Wi(e),e.hostname=e.hostname||"";var b="["===e.hostname[0]&&"]"===e.hostname[e.hostname.length-1];if(!b){var _=e.hostname.split(/\./);for(l=0,d=_.length;l<d;l++){var w=_[l];if(w&&!w.match(Ai)){for(var S="",E=0,C=w.length;E<C;E++)w.charCodeAt(E)>127?S+="x":S+=w[E];if(!S.match(Ai)){var k=_.slice(0,l),T=_.slice(l+1),x=w.match(Li);x&&(k.push(x[1]),T.unshift(x[2])),T.length&&(a="/"+T.join(".")+a),e.hostname=k.join(".");break}}}}e.hostname.length>Oi?e.hostname="":e.hostname=e.hostname.toLowerCase(),b||(e.hostname=hi(e.hostname)),h=e.port?":"+e.port:"";var I=e.hostname||"";e.host=I+h,e.href+=e.host,b&&(e.hostname=e.hostname.substr(1,e.hostname.length-2),"/"!==a[0]&&(a="/"+a))}if(!Pi[p])for(l=0,d=xi.length;l<d;l++){var R=xi[l];if(-1!==a.indexOf(R)){var O=encodeURIComponent(R);O===R&&(O=escape(R)),a=a.split(R).join(O)}}var A=a.indexOf("#");-1!==A&&(e.hash=a.substr(A),a=a.slice(0,A));var L=a.indexOf("?");if(-1!==L?(e.search=a.substr(L),e.query=a.substr(L+1),n&&(e.query=yi(e.query)),a=a.slice(0,L)):n&&(e.search="",e.query={}),a&&(e.pathname=a),Ni[p]&&e.hostname&&!e.pathname&&(e.pathname="/"),e.pathname||e.search){h=e.pathname||"";var P=e.search||"";e.path=h+P}return e.href=Bi(e),e}function Ui(e){if("string"==typeof e)e=(new Si).parse(e);else if(!(e instanceof Si))throw new TypeError('The "path" argument must be of type string or an instance of URL. Received type '+typeof e+String(e));if("file:"!==e.protocol)throw new TypeError("The URL must be of scheme file");return function(e){const t=e.pathname;for(let e=0;e<t.length;e++)if("%"===t[e]){const n=32|t.codePointAt(e+2);if("2"===t[e+1]&&102===n)throw new TypeError("must not include encoded / characters")}return decodeURIComponent(t)}(e)}function zi(e){return $n(e)&&(e=ji({},e)),Bi(e)}function Bi(e){var t=e.auth||"";t&&(t=(t=encodeURIComponent(t)).replace(/%3A/i,":"),t+="@");var n,r,i,o,s=e.protocol||"",a=e.pathname||"",c=e.hash||"",l=!1,u="";e.host?l=t+e.host:e.hostname&&(l=t+(-1===e.hostname.indexOf(":")?e.hostname:"["+this.hostname+"]"),e.port&&(l+=":"+e.port)),e.query&&er(e.query)&&Object.keys(e.query).length&&(n=e.query,r=r||"&",i=i||"=",null===n&&(n=void 0),u="object"==typeof n?gi(vi(n),(function(e){var t=encodeURIComponent(mi(e))+i;return pi(n[e])?gi(n[e],(function(e){return t+encodeURIComponent(mi(e))})).join(r):t+encodeURIComponent(mi(n[e]))})).join(r):o?encodeURIComponent(mi(o))+i+encodeURIComponent(mi(n)):"");var d=e.search||u&&"?"+u||"";return s&&":"!==s.substr(-1)&&(s+=":"),e.slashes||(!s||Ni[s])&&!1!==l?(l="//"+(l||""),a&&"/"!==a.charAt(0)&&(a="/"+a)):l||(l=""),c&&"#"!==c.charAt(0)&&(c="#"+c),d&&"?"!==d.charAt(0)&&(d="?"+d),s+l+(a=a.replace(/[?#]/g,(function(e){return encodeURIComponent(e)})))+(d=d.replace("#","%23"))+c}function Fi(e,t){return Mi(e,!1,!0).resolve(t)}function qi(e,t){return e?Mi(e,!1,!0).resolveObject(t):t}function Wi(e){var t=e.host,n=Ci.exec(t);n&&(":"!==(n=n[0])&&(e.port=n.substr(1)),t=t.substr(0,t.length-n.length)),t&&(e.hostname=t)}Si.prototype.parse=function(e,t,n){return ji(this,e,t,n)},Si.prototype.format=function(){return Bi(this)},Si.prototype.resolve=function(e){return this.resolveObject(Mi(e,!1,!0)).format()},Si.prototype.resolveObject=function(e){if($n(e)){var t=new Si;t.parse(e,!1,!0),e=t}for(var n,r=new Si,i=Object.keys(this),o=0;o<i.length;o++){var s=i[o];r[s]=this[s]}if(r.hash=e.hash,""===e.href)return r.href=r.format(),r;if(e.slashes&&!e.protocol){for(var a=Object.keys(e),c=0;c<a.length;c++){var l=a[c];"protocol"!==l&&(r[l]=e[l])}return Ni[r.protocol]&&r.hostname&&!r.pathname&&(r.path=r.pathname="/"),r.href=r.format(),r}if(e.protocol&&e.protocol!==r.protocol){if(!Ni[e.protocol]){for(var u=Object.keys(e),d=0;d<u.length;d++){var h=u[d];r[h]=e[h]}return r.href=r.format(),r}if(r.protocol=e.protocol,e.host||Di[e.protocol])r.pathname=e.pathname;else{for(n=(e.pathname||"").split("/");n.length&&!(e.host=n.shift()););e.host||(e.host=""),e.hostname||(e.hostname=""),""!==n[0]&&n.unshift(""),n.length<2&&n.unshift(""),r.pathname=n.join("/")}if(r.search=e.search,r.query=e.query,r.host=e.host||"",r.auth=e.auth,r.hostname=e.hostname||e.host,r.port=e.port,r.pathname||r.search){var f=r.pathname||"",p=r.search||"";r.path=f+p}return r.slashes=r.slashes||e.slashes,r.href=r.format(),r}var m,g=r.pathname&&"/"===r.pathname.charAt(0),v=e.host||e.pathname&&"/"===e.pathname.charAt(0),y=v||g||r.host&&e.pathname,b=y,_=r.pathname&&r.pathname.split("/")||[],w=r.protocol&&!Ni[r.protocol];if(n=e.pathname&&e.pathname.split("/")||[],w&&(r.hostname="",r.port=null,r.host&&(""===_[0]?_[0]=r.host:_.unshift(r.host)),r.host="",e.protocol&&(e.hostname=null,e.port=null,e.host&&(""===n[0]?n[0]=e.host:n.unshift(e.host)),e.host=null),y=y&&(""===n[0]||""===_[0])),v)r.host=e.host||""===e.host?e.host:r.host,r.hostname=e.hostname||""===e.hostname?e.hostname:r.hostname,r.search=e.search,r.query=e.query,_=n;else if(n.length)_||(_=[]),_.pop(),_=_.concat(n),r.search=e.search,r.query=e.query;else if(null!=e.search)return w&&(r.hostname=r.host=_.shift(),(m=!!(r.host&&r.host.indexOf("@")>0)&&r.host.split("@"))&&(r.auth=m.shift(),r.host=r.hostname=m.shift())),r.search=e.search,r.query=e.query,Yn(r.pathname)&&Yn(r.search)||(r.path=(r.pathname?r.pathname:"")+(r.search?r.search:"")),r.href=r.format(),r;if(!_.length)return r.pathname=null,r.search?r.path="/"+r.search:r.path=null,r.href=r.format(),r;for(var S=_.slice(-1)[0],E=(r.host||e.host||_.length>1)&&("."===S||".."===S)||""===S,C=0,k=_.length;k>=0;k--)"."===(S=_[k])?_.splice(k,1):".."===S?(_.splice(k,1),C++):C&&(_.splice(k,1),C--);if(!y&&!b)for(;C--;C)_.unshift("..");!y||""===_[0]||_[0]&&"/"===_[0].charAt(0)||_.unshift(""),E&&"/"!==_.join("/").substr(-1)&&_.push("");var T=""===_[0]||_[0]&&"/"===_[0].charAt(0);return w&&(r.hostname=r.host=T?"":_.length?_.shift():"",(m=!!(r.host&&r.host.indexOf("@")>0)&&r.host.split("@"))&&(r.auth=m.shift(),r.host=r.hostname=m.shift())),(y=y||r.host&&_.length)&&!T&&_.unshift(""),_.length?r.pathname=_.join("/"):(r.pathname=null,r.path=null),Yn(r.pathname)&&Yn(r.search)||(r.path=(r.pathname?r.pathname:"")+(r.search?r.search:"")),r.auth=e.auth||r.auth,r.slashes=r.slashes||e.slashes,r.href=r.format(),r},Si.prototype.parseHost=function(){return Wi(this)};var Vi=Object.freeze({__proto__:null,URL:bi,URLSearchParams:_i,Url:Si,default:wi,fileURLToPath:Ui,format:zi,parse:Mi,resolve:Fi,resolveObject:qi});function Gi(e,t){"string"==typeof e&&(e=Mi(e));var n=-1===Ke.location.protocol.search(/^https?:$/)?"http:":"",r=e.protocol||n,i=e.hostname||e.host,o=e.port,s=e.path||"/";i&&-1!==i.indexOf(":")&&(i="["+i+"]"),e.url=(i?r+"//"+i:"")+(o?":"+o:"")+s,e.method=(e.method||"GET").toUpperCase(),e.headers=e.headers||{};var a=new ti(e);return t&&a.on("response",t),a}function Ji(e,t){var n=Gi(e,t);return n.end(),n}function Hi(){}Hi.defaultMaxSockets=4;var Zi=["CHECKOUT","CONNECT","COPY","DELETE","GET","HEAD","LOCK","M-SEARCH","MERGE","MKACTIVITY","MKCOL","MOVE","NOTIFY","OPTIONS","PATCH","POST","PROPFIND","PROPPATCH","PURGE","PUT","REPORT","SEARCH","SUBSCRIBE","TRACE","UNLOCK","UNSUBSCRIBE"],Xi={100:"Continue",101:"Switching Protocols",102:"Processing",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",207:"Multi-Status",300:"Multiple Choices",301:"Moved Permanently",302:"Moved Temporarily",303:"See Other",304:"Not Modified",305:"Use Proxy",307:"Temporary Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Time-out",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Request Entity Too Large",414:"Request-URI Too Large",415:"Unsupported Media Type",416:"Requested Range Not Satisfiable",417:"Expectation Failed",418:"I'm a teapot",422:"Unprocessable Entity",423:"Locked",424:"Failed Dependency",425:"Unordered Collection",426:"Upgrade Required",428:"Precondition Required",429:"Too Many Requests",431:"Request Header Fields Too Large",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Time-out",505:"HTTP Version Not Supported",506:"Variant Also Negotiates",507:"Insufficient Storage",509:"Bandwidth Limit Exceeded",510:"Not Extended",511:"Network Authentication Required"},Yi={request:Gi,get:Ji,Agent:Hi,METHODS:Zi,STATUS_CODES:Xi},$i=N(Object.freeze({__proto__:null,Agent:Hi,METHODS:Zi,STATUS_CODES:Xi,default:Yi,get:Ji,request:Gi}));function Ki(e,t){"string"==typeof e&&(e=Mi(e));var n=-1===Ke.location.protocol.search(/^https?:$/)?"http:":"",r=e.protocol||n,i=e.hostname||e.host,o=e.port,s=e.path||"/";i&&-1!==i.indexOf(":")&&(i="["+i+"]"),e.url=(i?r+"//"+i:"")+(o?":"+o:"")+s,e.method=(e.method||"GET").toUpperCase(),e.headers=e.headers||{};var a=new ti(e);return t&&a.on("response",t),a}function Qi(e,t){var n=Ki(e,t);return n.end(),n}function eo(){}eo.defaultMaxSockets=4;var to=["CHECKOUT","CONNECT","COPY","DELETE","GET","HEAD","LOCK","M-SEARCH","MERGE","MKACTIVITY","MKCOL","MOVE","NOTIFY","OPTIONS","PATCH","POST","PROPFIND","PROPPATCH","PURGE","PUT","REPORT","SEARCH","SUBSCRIBE","TRACE","UNLOCK","UNSUBSCRIBE"],no={100:"Continue",101:"Switching Protocols",102:"Processing",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",207:"Multi-Status",300:"Multiple Choices",301:"Moved Permanently",302:"Moved Temporarily",303:"See Other",304:"Not Modified",305:"Use Proxy",307:"Temporary Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Time-out",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Request Entity Too Large",414:"Request-URI Too Large",415:"Unsupported Media Type",416:"Requested Range Not Satisfiable",417:"Expectation Failed",418:"I'm a teapot",422:"Unprocessable Entity",423:"Locked",424:"Failed Dependency",425:"Unordered Collection",426:"Upgrade Required",428:"Precondition Required",429:"Too Many Requests",431:"Request Header Fields Too Large",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Time-out",505:"HTTP Version Not Supported",506:"Variant Also Negotiates",507:"Insufficient Storage",509:"Bandwidth Limit Exceeded",510:"Not Extended",511:"Network Authentication Required"},ro={request:Ki,get:Qi,Agent:eo,METHODS:to,STATUS_CODES:no},io=N(Object.freeze({__proto__:null,Agent:eo,METHODS:to,STATUS_CODES:no,default:ro,get:Qi,request:Ki})),oo=N(Object.freeze({__proto__:null,default:{}})),so=N(Object.freeze({__proto__:null,default:{}})),ao=N(Object.freeze({__proto__:null,default:{}})),co=N($r),lo=N(Vi),uo={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"};function ho(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}function fo(e,t,n,r,i){if(t.subarray&&e.subarray)e.set(t.subarray(n,n+r),i);else for(var o=0;o<r;o++)e[i+o]=t[n+o]}var po=Uint8Array,mo=Uint16Array,go=Int32Array;function vo(e){for(var t=e.length;--t>=0;)e[t]=0}var yo=256,bo=286,_o=30,wo=15,So=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],Eo=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],Co=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],ko=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],To=new Array(576);vo(To);var xo=new Array(60);vo(xo);var Io=new Array(512);vo(Io);var Ro=new Array(256);vo(Ro);var Oo=new Array(29);vo(Oo);var Ao,Lo,Po,Do=new Array(_o);function No(e,t,n,r,i){this.static_tree=e,this.extra_bits=t,this.extra_base=n,this.elems=r,this.max_length=i,this.has_stree=e&&e.length}function Mo(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}function jo(e){return e<256?Io[e]:Io[256+(e>>>7)]}function Uo(e,t){e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255}function zo(e,t,n){e.bi_valid>16-n?(e.bi_buf|=t<<e.bi_valid&65535,Uo(e,e.bi_buf),e.bi_buf=t>>16-e.bi_valid,e.bi_valid+=n-16):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=n)}function Bo(e,t,n){zo(e,n[2*t],n[2*t+1])}function Fo(e,t){var n=0;do{n|=1&e,e>>>=1,n<<=1}while(--t>0);return n>>>1}function qo(e,t,n){var r,i,o=new Array(16),s=0;for(r=1;r<=wo;r++)o[r]=s=s+n[r-1]<<1;for(i=0;i<=t;i++){var a=e[2*i+1];0!==a&&(e[2*i]=Fo(o[a]++,a))}}function Wo(e){var t;for(t=0;t<bo;t++)e.dyn_ltree[2*t]=0;for(t=0;t<_o;t++)e.dyn_dtree[2*t]=0;for(t=0;t<19;t++)e.bl_tree[2*t]=0;e.dyn_ltree[512]=1,e.opt_len=e.static_len=0,e.last_lit=e.matches=0}function Vo(e){e.bi_valid>8?Uo(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0}function Go(e,t,n,r){var i=2*t,o=2*n;return e[i]<e[o]||e[i]===e[o]&&r[t]<=r[n]}function Jo(e,t,n){for(var r=e.heap[n],i=n<<1;i<=e.heap_len&&(i<e.heap_len&&Go(t,e.heap[i+1],e.heap[i],e.depth)&&i++,!Go(t,r,e.heap[i],e.depth));)e.heap[n]=e.heap[i],n=i,i<<=1;e.heap[n]=r}function Ho(e,t,n){var r,i,o,s,a=0;if(0!==e.last_lit)do{r=e.pending_buf[e.d_buf+2*a]<<8|e.pending_buf[e.d_buf+2*a+1],i=e.pending_buf[e.l_buf+a],a++,0===r?Bo(e,i,t):(Bo(e,(o=Ro[i])+yo+1,t),0!==(s=So[o])&&zo(e,i-=Oo[o],s),Bo(e,o=jo(--r),n),0!==(s=Eo[o])&&zo(e,r-=Do[o],s))}while(a<e.last_lit);Bo(e,256,t)}function Zo(e,t){var n,r,i,o=t.dyn_tree,s=t.stat_desc.static_tree,a=t.stat_desc.has_stree,c=t.stat_desc.elems,l=-1;for(e.heap_len=0,e.heap_max=573,n=0;n<c;n++)0!==o[2*n]?(e.heap[++e.heap_len]=l=n,e.depth[n]=0):o[2*n+1]=0;for(;e.heap_len<2;)o[2*(i=e.heap[++e.heap_len]=l<2?++l:0)]=1,e.depth[i]=0,e.opt_len--,a&&(e.static_len-=s[2*i+1]);for(t.max_code=l,n=e.heap_len>>1;n>=1;n--)Jo(e,o,n);i=c;do{n=e.heap[1],e.heap[1]=e.heap[e.heap_len--],Jo(e,o,1),r=e.heap[1],e.heap[--e.heap_max]=n,e.heap[--e.heap_max]=r,o[2*i]=o[2*n]+o[2*r],e.depth[i]=(e.depth[n]>=e.depth[r]?e.depth[n]:e.depth[r])+1,o[2*n+1]=o[2*r+1]=i,e.heap[1]=i++,Jo(e,o,1)}while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],function(e,t){var n,r,i,o,s,a,c=t.dyn_tree,l=t.max_code,u=t.stat_desc.static_tree,d=t.stat_desc.has_stree,h=t.stat_desc.extra_bits,f=t.stat_desc.extra_base,p=t.stat_desc.max_length,m=0;for(o=0;o<=wo;o++)e.bl_count[o]=0;for(c[2*e.heap[e.heap_max]+1]=0,n=e.heap_max+1;n<573;n++)(o=c[2*c[2*(r=e.heap[n])+1]+1]+1)>p&&(o=p,m++),c[2*r+1]=o,r>l||(e.bl_count[o]++,s=0,r>=f&&(s=h[r-f]),a=c[2*r],e.opt_len+=a*(o+s),d&&(e.static_len+=a*(u[2*r+1]+s)));if(0!==m){do{for(o=p-1;0===e.bl_count[o];)o--;e.bl_count[o]--,e.bl_count[o+1]+=2,e.bl_count[p]--,m-=2}while(m>0);for(o=p;0!==o;o--)for(r=e.bl_count[o];0!==r;)(i=e.heap[--n])>l||(c[2*i+1]!==o&&(e.opt_len+=(o-c[2*i+1])*c[2*i],c[2*i+1]=o),r--)}}(e,t),qo(o,l,e.bl_count)}function Xo(e,t,n){var r,i,o=-1,s=t[1],a=0,c=7,l=4;for(0===s&&(c=138,l=3),t[2*(n+1)+1]=65535,r=0;r<=n;r++)i=s,s=t[2*(r+1)+1],++a<c&&i===s||(a<l?e.bl_tree[2*i]+=a:0!==i?(i!==o&&e.bl_tree[2*i]++,e.bl_tree[32]++):a<=10?e.bl_tree[34]++:e.bl_tree[36]++,a=0,o=i,0===s?(c=138,l=3):i===s?(c=6,l=3):(c=7,l=4))}function Yo(e,t,n){var r,i,o=-1,s=t[1],a=0,c=7,l=4;for(0===s&&(c=138,l=3),r=0;r<=n;r++)if(i=s,s=t[2*(r+1)+1],!(++a<c&&i===s)){if(a<l)do{Bo(e,i,e.bl_tree)}while(0!=--a);else 0!==i?(i!==o&&(Bo(e,i,e.bl_tree),a--),Bo(e,16,e.bl_tree),zo(e,a-3,2)):a<=10?(Bo(e,17,e.bl_tree),zo(e,a-3,3)):(Bo(e,18,e.bl_tree),zo(e,a-11,7));a=0,o=i,0===s?(c=138,l=3):i===s?(c=6,l=3):(c=7,l=4)}}vo(Do);var $o=!1;function Ko(e){$o||(!function(){var e,t,n,r,i,o=new Array(16);for(n=0,r=0;r<28;r++)for(Oo[r]=n,e=0;e<1<<So[r];e++)Ro[n++]=r;for(Ro[n-1]=r,i=0,r=0;r<16;r++)for(Do[r]=i,e=0;e<1<<Eo[r];e++)Io[i++]=r;for(i>>=7;r<_o;r++)for(Do[r]=i<<7,e=0;e<1<<Eo[r]-7;e++)Io[256+i++]=r;for(t=0;t<=wo;t++)o[t]=0;for(e=0;e<=143;)To[2*e+1]=8,e++,o[8]++;for(;e<=255;)To[2*e+1]=9,e++,o[9]++;for(;e<=279;)To[2*e+1]=7,e++,o[7]++;for(;e<=287;)To[2*e+1]=8,e++,o[8]++;for(qo(To,287,o),e=0;e<_o;e++)xo[2*e+1]=5,xo[2*e]=Fo(e,5);Ao=new No(To,So,257,bo,wo),Lo=new No(xo,Eo,0,_o,wo),Po=new No(new Array(0),Co,0,19,7)}(),$o=!0),e.l_desc=new Mo(e.dyn_ltree,Ao),e.d_desc=new Mo(e.dyn_dtree,Lo),e.bl_desc=new Mo(e.bl_tree,Po),e.bi_buf=0,e.bi_valid=0,Wo(e)}function Qo(e,t,n,r){zo(e,0+(r?1:0),3),function(e,t,n){Vo(e),Uo(e,n),Uo(e,~n),fo(e.pending_buf,e.window,t,n,e.pending),e.pending+=n}(e,t,n)}function es(e){zo(e,2,3),Bo(e,256,To),function(e){16===e.bi_valid?(Uo(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)}(e)}function ts(e,t,n,r){var i,o,s=0;e.level>0?(2===e.strm.data_type&&(e.strm.data_type=function(e){var t,n=4093624447;for(t=0;t<=31;t++,n>>>=1)if(1&n&&0!==e.dyn_ltree[2*t])return 0;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return 1;for(t=32;t<yo;t++)if(0!==e.dyn_ltree[2*t])return 1;return 0}(e)),Zo(e,e.l_desc),Zo(e,e.d_desc),s=function(e){var t;for(Xo(e,e.dyn_ltree,e.l_desc.max_code),Xo(e,e.dyn_dtree,e.d_desc.max_code),Zo(e,e.bl_desc),t=18;t>=3&&0===e.bl_tree[2*ko[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t}(e),i=e.opt_len+3+7>>>3,(o=e.static_len+3+7>>>3)<=i&&(i=o)):i=o=n+5,n+4<=i&&-1!==t?Qo(e,t,n,r):4===e.strategy||o===i?(zo(e,2+(r?1:0),3),Ho(e,To,xo)):(zo(e,4+(r?1:0),3),function(e,t,n,r){var i;for(zo(e,t-257,5),zo(e,n-1,5),zo(e,r-4,4),i=0;i<r;i++)zo(e,e.bl_tree[2*ko[i]+1],3);Yo(e,e.dyn_ltree,t-1),Yo(e,e.dyn_dtree,n-1)}(e,e.l_desc.max_code+1,e.d_desc.max_code+1,s+1),Ho(e,e.dyn_ltree,e.dyn_dtree)),Wo(e),r&&Vo(e)}function ns(e,t,n){return e.pending_buf[e.d_buf+2*e.last_lit]=t>>>8&255,e.pending_buf[e.d_buf+2*e.last_lit+1]=255&t,e.pending_buf[e.l_buf+e.last_lit]=255&n,e.last_lit++,0===t?e.dyn_ltree[2*n]++:(e.matches++,t--,e.dyn_ltree[2*(Ro[n]+yo+1)]++,e.dyn_dtree[2*jo(t)]++),e.last_lit===e.lit_bufsize-1}function rs(e,t,n,r){for(var i=65535&e,o=e>>>16&65535,s=0;0!==n;){n-=s=n>2e3?2e3:n;do{o=o+(i=i+t[r++]|0)|0}while(--s);i%=65521,o%=65521}return i|o<<16}var is=function(){for(var e,t=[],n=0;n<256;n++){e=n;for(var r=0;r<8;r++)e=1&e?3988292384^e>>>1:e>>>1;t[n]=e}return t}();function os(e,t,n,r){var i=is,o=r+n;e^=-1;for(var s=r;s<o;s++)e=e>>>8^i[255&(e^t[s])];return~e}var ss,as=-2,cs=258,ls=262,us=103,ds=113,hs=666;function fs(e,t){return e.msg=uo[t],t}function ps(e){return(e<<1)-(e>4?9:0)}function ms(e){for(var t=e.length;--t>=0;)e[t]=0}function gs(e){var t=e.state,n=t.pending;n>e.avail_out&&(n=e.avail_out),0!==n&&(fo(e.output,t.pending_buf,t.pending_out,n,e.next_out),e.next_out+=n,t.pending_out+=n,e.total_out+=n,e.avail_out-=n,t.pending-=n,0===t.pending&&(t.pending_out=0))}function vs(e,t){ts(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,gs(e.strm)}function ys(e,t){e.pending_buf[e.pending++]=t}function bs(e,t){e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t}function _s(e,t){var n,r,i=e.max_chain_length,o=e.strstart,s=e.prev_length,a=e.nice_match,c=e.strstart>e.w_size-ls?e.strstart-(e.w_size-ls):0,l=e.window,u=e.w_mask,d=e.prev,h=e.strstart+cs,f=l[o+s-1],p=l[o+s];e.prev_length>=e.good_match&&(i>>=2),a>e.lookahead&&(a=e.lookahead);do{if(l[(n=t)+s]===p&&l[n+s-1]===f&&l[n]===l[o]&&l[++n]===l[o+1]){o+=2,n++;do{}while(l[++o]===l[++n]&&l[++o]===l[++n]&&l[++o]===l[++n]&&l[++o]===l[++n]&&l[++o]===l[++n]&&l[++o]===l[++n]&&l[++o]===l[++n]&&l[++o]===l[++n]&&o<h);if(r=cs-(h-o),o=h-cs,r>s){if(e.match_start=t,s=r,r>=a)break;f=l[o+s-1],p=l[o+s]}}}while((t=d[t&u])>c&&0!=--i);return s<=e.lookahead?s:e.lookahead}function ws(e){var t,n,r,i,o,s,a,c,l,u,d=e.w_size;do{if(i=e.window_size-e.lookahead-e.strstart,e.strstart>=d+(d-ls)){fo(e.window,e.window,d,d,0),e.match_start-=d,e.strstart-=d,e.block_start-=d,t=n=e.hash_size;do{r=e.head[--t],e.head[t]=r>=d?r-d:0}while(--n);t=n=d;do{r=e.prev[--t],e.prev[t]=r>=d?r-d:0}while(--n);i+=d}if(0===e.strm.avail_in)break;if(s=e.strm,a=e.window,c=e.strstart+e.lookahead,l=i,u=void 0,(u=s.avail_in)>l&&(u=l),n=0===u?0:(s.avail_in-=u,fo(a,s.input,s.next_in,u,c),1===s.state.wrap?s.adler=rs(s.adler,a,u,c):2===s.state.wrap&&(s.adler=os(s.adler,a,u,c)),s.next_in+=u,s.total_in+=u,u),e.lookahead+=n,e.lookahead+e.insert>=3)for(o=e.strstart-e.insert,e.ins_h=e.window[o],e.ins_h=(e.ins_h<<e.hash_shift^e.window[o+1])&e.hash_mask;e.insert&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[o+3-1])&e.hash_mask,e.prev[o&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=o,o++,e.insert--,!(e.lookahead+e.insert<3)););}while(e.lookahead<ls&&0!==e.strm.avail_in)}function Ss(e,t){for(var n,r;;){if(e.lookahead<ls){if(ws(e),e.lookahead<ls&&0===t)return 1;if(0===e.lookahead)break}if(n=0,e.lookahead>=3&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==n&&e.strstart-n<=e.w_size-ls&&(e.match_length=_s(e,n)),e.match_length>=3)if(r=ns(e,e.strstart-e.match_start,e.match_length-3),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=3){e.match_length--;do{e.strstart++,e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart}while(0!=--e.match_length);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+1])&e.hash_mask;else r=ns(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(r&&(vs(e,!1),0===e.strm.avail_out))return 1}return e.insert=e.strstart<2?e.strstart:2,4===t?(vs(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(vs(e,!1),0===e.strm.avail_out)?1:2}function Es(e,t){for(var n,r,i;;){if(e.lookahead<ls){if(ws(e),e.lookahead<ls&&0===t)return 1;if(0===e.lookahead)break}if(n=0,e.lookahead>=3&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=2,0!==n&&e.prev_length<e.max_lazy_match&&e.strstart-n<=e.w_size-ls&&(e.match_length=_s(e,n),e.match_length<=5&&(1===e.strategy||3===e.match_length&&e.strstart-e.match_start>4096)&&(e.match_length=2)),e.prev_length>=3&&e.match_length<=e.prev_length){i=e.strstart+e.lookahead-3,r=ns(e,e.strstart-1-e.prev_match,e.prev_length-3),e.lookahead-=e.prev_length-1,e.prev_length-=2;do{++e.strstart<=i&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart)}while(0!=--e.prev_length);if(e.match_available=0,e.match_length=2,e.strstart++,r&&(vs(e,!1),0===e.strm.avail_out))return 1}else if(e.match_available){if((r=ns(e,0,e.window[e.strstart-1]))&&vs(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return 1}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(r=ns(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<2?e.strstart:2,4===t?(vs(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(vs(e,!1),0===e.strm.avail_out)?1:2}function Cs(e,t,n,r,i){this.good_length=e,this.max_lazy=t,this.nice_length=n,this.max_chain=r,this.func=i}function ks(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=8,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new mo(1146),this.dyn_dtree=new mo(122),this.bl_tree=new mo(78),ms(this.dyn_ltree),ms(this.dyn_dtree),ms(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new mo(16),this.heap=new mo(573),ms(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new mo(573),ms(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function Ts(e){var t,n=function(e){var t;return e&&e.state?(e.total_in=e.total_out=0,e.data_type=2,(t=e.state).pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap?42:ds,e.adler=2===t.wrap?0:1,t.last_flush=0,Ko(t),0):fs(e,as)}(e);return 0===n&&((t=e.state).window_size=2*t.w_size,ms(t.head),t.max_lazy_match=ss[t.level].max_lazy,t.good_match=ss[t.level].good_length,t.nice_match=ss[t.level].nice_length,t.max_chain_length=ss[t.level].max_chain,t.strstart=0,t.block_start=0,t.lookahead=0,t.insert=0,t.match_length=t.prev_length=2,t.match_available=0,t.ins_h=0),n}function xs(e,t){var n,r,i,o;if(!e||!e.state||t>5||t<0)return e?fs(e,as):as;if(r=e.state,!e.output||!e.input&&0!==e.avail_in||r.status===hs&&4!==t)return fs(e,0===e.avail_out?-5:as);if(r.strm=e,n=r.last_flush,r.last_flush=t,42===r.status)if(2===r.wrap)e.adler=0,ys(r,31),ys(r,139),ys(r,8),r.gzhead?(ys(r,(r.gzhead.text?1:0)+(r.gzhead.hcrc?2:0)+(r.gzhead.extra?4:0)+(r.gzhead.name?8:0)+(r.gzhead.comment?16:0)),ys(r,255&r.gzhead.time),ys(r,r.gzhead.time>>8&255),ys(r,r.gzhead.time>>16&255),ys(r,r.gzhead.time>>24&255),ys(r,9===r.level?2:r.strategy>=2||r.level<2?4:0),ys(r,255&r.gzhead.os),r.gzhead.extra&&r.gzhead.extra.length&&(ys(r,255&r.gzhead.extra.length),ys(r,r.gzhead.extra.length>>8&255)),r.gzhead.hcrc&&(e.adler=os(e.adler,r.pending_buf,r.pending,0)),r.gzindex=0,r.status=69):(ys(r,0),ys(r,0),ys(r,0),ys(r,0),ys(r,0),ys(r,9===r.level?2:r.strategy>=2||r.level<2?4:0),ys(r,3),r.status=ds);else{var s=8+(r.w_bits-8<<4)<<8;s|=(r.strategy>=2||r.level<2?0:r.level<6?1:6===r.level?2:3)<<6,0!==r.strstart&&(s|=32),s+=31-s%31,r.status=ds,bs(r,s),0!==r.strstart&&(bs(r,e.adler>>>16),bs(r,65535&e.adler)),e.adler=1}if(69===r.status)if(r.gzhead.extra){for(i=r.pending;r.gzindex<(65535&r.gzhead.extra.length)&&(r.pending!==r.pending_buf_size||(r.gzhead.hcrc&&r.pending>i&&(e.adler=os(e.adler,r.pending_buf,r.pending-i,i)),gs(e),i=r.pending,r.pending!==r.pending_buf_size));)ys(r,255&r.gzhead.extra[r.gzindex]),r.gzindex++;r.gzhead.hcrc&&r.pending>i&&(e.adler=os(e.adler,r.pending_buf,r.pending-i,i)),r.gzindex===r.gzhead.extra.length&&(r.gzindex=0,r.status=73)}else r.status=73;if(73===r.status)if(r.gzhead.name){i=r.pending;do{if(r.pending===r.pending_buf_size&&(r.gzhead.hcrc&&r.pending>i&&(e.adler=os(e.adler,r.pending_buf,r.pending-i,i)),gs(e),i=r.pending,r.pending===r.pending_buf_size)){o=1;break}o=r.gzindex<r.gzhead.name.length?255&r.gzhead.name.charCodeAt(r.gzindex++):0,ys(r,o)}while(0!==o);r.gzhead.hcrc&&r.pending>i&&(e.adler=os(e.adler,r.pending_buf,r.pending-i,i)),0===o&&(r.gzindex=0,r.status=91)}else r.status=91;if(91===r.status)if(r.gzhead.comment){i=r.pending;do{if(r.pending===r.pending_buf_size&&(r.gzhead.hcrc&&r.pending>i&&(e.adler=os(e.adler,r.pending_buf,r.pending-i,i)),gs(e),i=r.pending,r.pending===r.pending_buf_size)){o=1;break}o=r.gzindex<r.gzhead.comment.length?255&r.gzhead.comment.charCodeAt(r.gzindex++):0,ys(r,o)}while(0!==o);r.gzhead.hcrc&&r.pending>i&&(e.adler=os(e.adler,r.pending_buf,r.pending-i,i)),0===o&&(r.status=us)}else r.status=us;if(r.status===us&&(r.gzhead.hcrc?(r.pending+2>r.pending_buf_size&&gs(e),r.pending+2<=r.pending_buf_size&&(ys(r,255&e.adler),ys(r,e.adler>>8&255),e.adler=0,r.status=ds)):r.status=ds),0!==r.pending){if(gs(e),0===e.avail_out)return r.last_flush=-1,0}else if(0===e.avail_in&&ps(t)<=ps(n)&&4!==t)return fs(e,-5);if(r.status===hs&&0!==e.avail_in)return fs(e,-5);if(0!==e.avail_in||0!==r.lookahead||0!==t&&r.status!==hs){var a=2===r.strategy?function(e,t){for(var n;;){if(0===e.lookahead&&(ws(e),0===e.lookahead)){if(0===t)return 1;break}if(e.match_length=0,n=ns(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,n&&(vs(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(vs(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(vs(e,!1),0===e.strm.avail_out)?1:2}(r,t):3===r.strategy?function(e,t){for(var n,r,i,o,s=e.window;;){if(e.lookahead<=cs){if(ws(e),e.lookahead<=cs&&0===t)return 1;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=3&&e.strstart>0&&(r=s[i=e.strstart-1])===s[++i]&&r===s[++i]&&r===s[++i]){o=e.strstart+cs;do{}while(r===s[++i]&&r===s[++i]&&r===s[++i]&&r===s[++i]&&r===s[++i]&&r===s[++i]&&r===s[++i]&&r===s[++i]&&i<o);e.match_length=cs-(o-i),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=3?(n=ns(e,1,e.match_length-3),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(n=ns(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),n&&(vs(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(vs(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(vs(e,!1),0===e.strm.avail_out)?1:2}(r,t):ss[r.level].func(r,t);if(3!==a&&4!==a||(r.status=hs),1===a||3===a)return 0===e.avail_out&&(r.last_flush=-1),0;if(2===a&&(1===t?es(r):5!==t&&(Qo(r,0,0,!1),3===t&&(ms(r.head),0===r.lookahead&&(r.strstart=0,r.block_start=0,r.insert=0))),gs(e),0===e.avail_out))return r.last_flush=-1,0}return 4!==t?0:r.wrap<=0?1:(2===r.wrap?(ys(r,255&e.adler),ys(r,e.adler>>8&255),ys(r,e.adler>>16&255),ys(r,e.adler>>24&255),ys(r,255&e.total_in),ys(r,e.total_in>>8&255),ys(r,e.total_in>>16&255),ys(r,e.total_in>>24&255)):(bs(r,e.adler>>>16),bs(r,65535&e.adler)),gs(e),r.wrap>0&&(r.wrap=-r.wrap),0!==r.pending?0:1)}ss=[new Cs(0,0,0,0,(function(e,t){var n=65535;for(n>e.pending_buf_size-5&&(n=e.pending_buf_size-5);;){if(e.lookahead<=1){if(ws(e),0===e.lookahead&&0===t)return 1;if(0===e.lookahead)break}e.strstart+=e.lookahead,e.lookahead=0;var r=e.block_start+n;if((0===e.strstart||e.strstart>=r)&&(e.lookahead=e.strstart-r,e.strstart=r,vs(e,!1),0===e.strm.avail_out))return 1;if(e.strstart-e.block_start>=e.w_size-ls&&(vs(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(vs(e,!0),0===e.strm.avail_out?3:4):(e.strstart>e.block_start&&(vs(e,!1),e.strm.avail_out),1)})),new Cs(4,4,8,4,Ss),new Cs(4,5,16,8,Ss),new Cs(4,6,32,32,Ss),new Cs(4,4,16,16,Es),new Cs(8,16,32,32,Es),new Cs(8,16,128,128,Es),new Cs(8,32,128,256,Es),new Cs(32,128,258,1024,Es),new Cs(32,258,258,4096,Es)];function Is(e,t){var n,r,i,o,s,a,c,l,u,d,h,f,p,m,g,v,y,b,_,w,S,E,C,k,T;n=e.state,r=e.next_in,k=e.input,i=r+(e.avail_in-5),o=e.next_out,T=e.output,s=o-(t-e.avail_out),a=o+(e.avail_out-257),c=n.dmax,l=n.wsize,u=n.whave,d=n.wnext,h=n.window,f=n.hold,p=n.bits,m=n.lencode,g=n.distcode,v=(1<<n.lenbits)-1,y=(1<<n.distbits)-1;e:do{p<15&&(f+=k[r++]<<p,p+=8,f+=k[r++]<<p,p+=8),b=m[f&v];t:for(;;){if(f>>>=_=b>>>24,p-=_,0===(_=b>>>16&255))T[o++]=65535&b;else{if(!(16&_)){if(64&_){if(32&_){n.mode=12;break e}e.msg="invalid literal/length code",n.mode=30;break e}b=m[(65535&b)+(f&(1<<_)-1)];continue t}for(w=65535&b,(_&=15)&&(p<_&&(f+=k[r++]<<p,p+=8),w+=f&(1<<_)-1,f>>>=_,p-=_),p<15&&(f+=k[r++]<<p,p+=8,f+=k[r++]<<p,p+=8),b=g[f&y];;){if(f>>>=_=b>>>24,p-=_,16&(_=b>>>16&255)){if(S=65535&b,p<(_&=15)&&(f+=k[r++]<<p,(p+=8)<_&&(f+=k[r++]<<p,p+=8)),(S+=f&(1<<_)-1)>c){e.msg="invalid distance too far back",n.mode=30;break e}if(f>>>=_,p-=_,S>(_=o-s)){if((_=S-_)>u&&n.sane){e.msg="invalid distance too far back",n.mode=30;break e}if(E=0,C=h,0===d){if(E+=l-_,_<w){w-=_;do{T[o++]=h[E++]}while(--_);E=o-S,C=T}}else if(d<_){if(E+=l+d-_,(_-=d)<w){w-=_;do{T[o++]=h[E++]}while(--_);if(E=0,d<w){w-=_=d;do{T[o++]=h[E++]}while(--_);E=o-S,C=T}}}else if(E+=d-_,_<w){w-=_;do{T[o++]=h[E++]}while(--_);E=o-S,C=T}for(;w>2;)T[o++]=C[E++],T[o++]=C[E++],T[o++]=C[E++],w-=3;w&&(T[o++]=C[E++],w>1&&(T[o++]=C[E++]))}else{E=o-S;do{T[o++]=T[E++],T[o++]=T[E++],T[o++]=T[E++],w-=3}while(w>2);w&&(T[o++]=T[E++],w>1&&(T[o++]=T[E++]))}break}if(64&_){e.msg="invalid distance code",n.mode=30;break e}b=g[(65535&b)+(f&(1<<_)-1)]}}break}}while(r<i&&o<a);r-=w=p>>3,f&=(1<<(p-=w<<3))-1,e.next_in=r,e.next_out=o,e.avail_in=r<i?i-r+5:5-(r-i),e.avail_out=o<a?a-o+257:257-(o-a),n.hold=f,n.bits=p}var Rs=15,Os=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],As=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],Ls=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],Ps=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];function Ds(e,t,n,r,i,o,s,a){var c,l,u,d,h,f,p,m,g,v=a.bits,y=0,b=0,_=0,w=0,S=0,E=0,C=0,k=0,T=0,x=0,I=null,R=0,O=new mo(16),A=new mo(16),L=null,P=0;for(y=0;y<=Rs;y++)O[y]=0;for(b=0;b<r;b++)O[t[n+b]]++;for(S=v,w=Rs;w>=1&&0===O[w];w--);if(S>w&&(S=w),0===w)return i[o++]=20971520,i[o++]=20971520,a.bits=1,0;for(_=1;_<w&&0===O[_];_++);for(S<_&&(S=_),k=1,y=1;y<=Rs;y++)if(k<<=1,(k-=O[y])<0)return-1;if(k>0&&(0===e||1!==w))return-1;for(A[1]=0,y=1;y<Rs;y++)A[y+1]=A[y]+O[y];for(b=0;b<r;b++)0!==t[n+b]&&(s[A[t[n+b]]++]=b);if(0===e?(I=L=s,f=19):1===e?(I=Os,R-=257,L=As,P-=257,f=256):(I=Ls,L=Ps,f=-1),x=0,b=0,y=_,h=o,E=S,C=0,u=-1,d=(T=1<<S)-1,1===e&&T>852||2===e&&T>592)return 1;for(;;){p=y-C,s[b]<f?(m=0,g=s[b]):s[b]>f?(m=L[P+s[b]],g=I[R+s[b]]):(m=96,g=0),c=1<<y-C,_=l=1<<E;do{i[h+(x>>C)+(l-=c)]=p<<24|m<<16|g}while(0!==l);for(c=1<<y-1;x&c;)c>>=1;if(0!==c?(x&=c-1,x+=c):x=0,b++,0==--O[y]){if(y===w)break;y=t[n+s[b]]}if(y>S&&(x&d)!==u){for(0===C&&(C=S),h+=_,k=1<<(E=y-C);E+C<w&&!((k-=O[E+C])<=0);)E++,k<<=1;if(T+=1<<E,1===e&&T>852||2===e&&T>592)return 1;i[u=x&d]=S<<24|E<<16|h-o}}return 0!==x&&(i[h+x]=y-C<<24|64<<16),a.bits=S,0}var Ns=-2,Ms=12,js=30;function Us(e){return(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)}function zs(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new mo(320),this.work=new mo(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function Bs(e){var t;return e&&e.state?((t=e.state).wsize=0,t.whave=0,t.wnext=0,function(e){var t;return e&&e.state?(t=e.state,e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=1,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new go(852),t.distcode=t.distdyn=new go(592),t.sane=1,t.back=-1,0):Ns}(e)):Ns}function Fs(e,t){var n,r;return e?(r=new zs,e.state=r,r.window=null,n=function(e,t){var n,r;return e&&e.state?(r=e.state,t<0?(n=0,t=-t):(n=1+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?Ns:(null!==r.window&&r.wbits!==t&&(r.window=null),r.wrap=n,r.wbits=t,Bs(e))):Ns}(e,t),0!==n&&(e.state=null),n):Ns}var qs,Ws,Vs=!0;function Gs(e){if(Vs){var t;for(qs=new go(512),Ws=new go(32),t=0;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(Ds(1,e.lens,0,288,qs,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;Ds(2,e.lens,0,32,Ws,0,e.work,{bits:5}),Vs=!1}e.lencode=qs,e.lenbits=9,e.distcode=Ws,e.distbits=5}function Js(e,t){var n,r,i,o,s,a,c,l,u,d,h,f,p,m,g,v,y,b,_,w,S,E,C,k,T=0,x=new po(4),I=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return Ns;(n=e.state).mode===Ms&&(n.mode=13),s=e.next_out,i=e.output,c=e.avail_out,o=e.next_in,r=e.input,a=e.avail_in,l=n.hold,u=n.bits,d=a,h=c,E=0;e:for(;;)switch(n.mode){case 1:if(0===n.wrap){n.mode=13;break}for(;u<16;){if(0===a)break e;a--,l+=r[o++]<<u,u+=8}if(2&n.wrap&&35615===l){n.check=0,x[0]=255&l,x[1]=l>>>8&255,n.check=os(n.check,x,2,0),l=0,u=0,n.mode=2;break}if(n.flags=0,n.head&&(n.head.done=!1),!(1&n.wrap)||(((255&l)<<8)+(l>>8))%31){e.msg="incorrect header check",n.mode=js;break}if(8!=(15&l)){e.msg="unknown compression method",n.mode=js;break}if(u-=4,S=8+(15&(l>>>=4)),0===n.wbits)n.wbits=S;else if(S>n.wbits){e.msg="invalid window size",n.mode=js;break}n.dmax=1<<S,e.adler=n.check=1,n.mode=512&l?10:Ms,l=0,u=0;break;case 2:for(;u<16;){if(0===a)break e;a--,l+=r[o++]<<u,u+=8}if(n.flags=l,8!=(255&n.flags)){e.msg="unknown compression method",n.mode=js;break}if(57344&n.flags){e.msg="unknown header flags set",n.mode=js;break}n.head&&(n.head.text=l>>8&1),512&n.flags&&(x[0]=255&l,x[1]=l>>>8&255,n.check=os(n.check,x,2,0)),l=0,u=0,n.mode=3;case 3:for(;u<32;){if(0===a)break e;a--,l+=r[o++]<<u,u+=8}n.head&&(n.head.time=l),512&n.flags&&(x[0]=255&l,x[1]=l>>>8&255,x[2]=l>>>16&255,x[3]=l>>>24&255,n.check=os(n.check,x,4,0)),l=0,u=0,n.mode=4;case 4:for(;u<16;){if(0===a)break e;a--,l+=r[o++]<<u,u+=8}n.head&&(n.head.xflags=255&l,n.head.os=l>>8),512&n.flags&&(x[0]=255&l,x[1]=l>>>8&255,n.check=os(n.check,x,2,0)),l=0,u=0,n.mode=5;case 5:if(1024&n.flags){for(;u<16;){if(0===a)break e;a--,l+=r[o++]<<u,u+=8}n.length=l,n.head&&(n.head.extra_len=l),512&n.flags&&(x[0]=255&l,x[1]=l>>>8&255,n.check=os(n.check,x,2,0)),l=0,u=0}else n.head&&(n.head.extra=null);n.mode=6;case 6:if(1024&n.flags&&((f=n.length)>a&&(f=a),f&&(n.head&&(S=n.head.extra_len-n.length,n.head.extra||(n.head.extra=new Array(n.head.extra_len)),fo(n.head.extra,r,o,f,S)),512&n.flags&&(n.check=os(n.check,r,f,o)),a-=f,o+=f,n.length-=f),n.length))break e;n.length=0,n.mode=7;case 7:if(2048&n.flags){if(0===a)break e;f=0;do{S=r[o+f++],n.head&&S&&n.length<65536&&(n.head.name+=String.fromCharCode(S))}while(S&&f<a);if(512&n.flags&&(n.check=os(n.check,r,f,o)),a-=f,o+=f,S)break e}else n.head&&(n.head.name=null);n.length=0,n.mode=8;case 8:if(4096&n.flags){if(0===a)break e;f=0;do{S=r[o+f++],n.head&&S&&n.length<65536&&(n.head.comment+=String.fromCharCode(S))}while(S&&f<a);if(512&n.flags&&(n.check=os(n.check,r,f,o)),a-=f,o+=f,S)break e}else n.head&&(n.head.comment=null);n.mode=9;case 9:if(512&n.flags){for(;u<16;){if(0===a)break e;a--,l+=r[o++]<<u,u+=8}if(l!==(65535&n.check)){e.msg="header crc mismatch",n.mode=js;break}l=0,u=0}n.head&&(n.head.hcrc=n.flags>>9&1,n.head.done=!0),e.adler=n.check=0,n.mode=Ms;break;case 10:for(;u<32;){if(0===a)break e;a--,l+=r[o++]<<u,u+=8}e.adler=n.check=Us(l),l=0,u=0,n.mode=11;case 11:if(0===n.havedict)return e.next_out=s,e.avail_out=c,e.next_in=o,e.avail_in=a,n.hold=l,n.bits=u,2;e.adler=n.check=1,n.mode=Ms;case Ms:if(5===t||6===t)break e;case 13:if(n.last){l>>>=7&u,u-=7&u,n.mode=27;break}for(;u<3;){if(0===a)break e;a--,l+=r[o++]<<u,u+=8}switch(n.last=1&l,u-=1,3&(l>>>=1)){case 0:n.mode=14;break;case 1:if(Gs(n),n.mode=20,6===t){l>>>=2,u-=2;break e}break;case 2:n.mode=17;break;case 3:e.msg="invalid block type",n.mode=js}l>>>=2,u-=2;break;case 14:for(l>>>=7&u,u-=7&u;u<32;){if(0===a)break e;a--,l+=r[o++]<<u,u+=8}if((65535&l)!=(l>>>16^65535)){e.msg="invalid stored block lengths",n.mode=js;break}if(n.length=65535&l,l=0,u=0,n.mode=15,6===t)break e;case 15:n.mode=16;case 16:if(f=n.length){if(f>a&&(f=a),f>c&&(f=c),0===f)break e;fo(i,r,o,f,s),a-=f,o+=f,c-=f,s+=f,n.length-=f;break}n.mode=Ms;break;case 17:for(;u<14;){if(0===a)break e;a--,l+=r[o++]<<u,u+=8}if(n.nlen=257+(31&l),l>>>=5,u-=5,n.ndist=1+(31&l),l>>>=5,u-=5,n.ncode=4+(15&l),l>>>=4,u-=4,n.nlen>286||n.ndist>30){e.msg="too many length or distance symbols",n.mode=js;break}n.have=0,n.mode=18;case 18:for(;n.have<n.ncode;){for(;u<3;){if(0===a)break e;a--,l+=r[o++]<<u,u+=8}n.lens[I[n.have++]]=7&l,l>>>=3,u-=3}for(;n.have<19;)n.lens[I[n.have++]]=0;if(n.lencode=n.lendyn,n.lenbits=7,C={bits:n.lenbits},E=Ds(0,n.lens,0,19,n.lencode,0,n.work,C),n.lenbits=C.bits,E){e.msg="invalid code lengths set",n.mode=js;break}n.have=0,n.mode=19;case 19:for(;n.have<n.nlen+n.ndist;){for(;v=(T=n.lencode[l&(1<<n.lenbits)-1])>>>16&255,y=65535&T,!((g=T>>>24)<=u);){if(0===a)break e;a--,l+=r[o++]<<u,u+=8}if(y<16)l>>>=g,u-=g,n.lens[n.have++]=y;else{if(16===y){for(k=g+2;u<k;){if(0===a)break e;a--,l+=r[o++]<<u,u+=8}if(l>>>=g,u-=g,0===n.have){e.msg="invalid bit length repeat",n.mode=js;break}S=n.lens[n.have-1],f=3+(3&l),l>>>=2,u-=2}else if(17===y){for(k=g+3;u<k;){if(0===a)break e;a--,l+=r[o++]<<u,u+=8}u-=g,S=0,f=3+(7&(l>>>=g)),l>>>=3,u-=3}else{for(k=g+7;u<k;){if(0===a)break e;a--,l+=r[o++]<<u,u+=8}u-=g,S=0,f=11+(127&(l>>>=g)),l>>>=7,u-=7}if(n.have+f>n.nlen+n.ndist){e.msg="invalid bit length repeat",n.mode=js;break}for(;f--;)n.lens[n.have++]=S}}if(n.mode===js)break;if(0===n.lens[256]){e.msg="invalid code -- missing end-of-block",n.mode=js;break}if(n.lenbits=9,C={bits:n.lenbits},E=Ds(1,n.lens,0,n.nlen,n.lencode,0,n.work,C),n.lenbits=C.bits,E){e.msg="invalid literal/lengths set",n.mode=js;break}if(n.distbits=6,n.distcode=n.distdyn,C={bits:n.distbits},E=Ds(2,n.lens,n.nlen,n.ndist,n.distcode,0,n.work,C),n.distbits=C.bits,E){e.msg="invalid distances set",n.mode=js;break}if(n.mode=20,6===t)break e;case 20:n.mode=21;case 21:if(a>=6&&c>=258){e.next_out=s,e.avail_out=c,e.next_in=o,e.avail_in=a,n.hold=l,n.bits=u,Is(e,h),s=e.next_out,i=e.output,c=e.avail_out,o=e.next_in,r=e.input,a=e.avail_in,l=n.hold,u=n.bits,n.mode===Ms&&(n.back=-1);break}for(n.back=0;v=(T=n.lencode[l&(1<<n.lenbits)-1])>>>16&255,y=65535&T,!((g=T>>>24)<=u);){if(0===a)break e;a--,l+=r[o++]<<u,u+=8}if(v&&!(240&v)){for(b=g,_=v,w=y;v=(T=n.lencode[w+((l&(1<<b+_)-1)>>b)])>>>16&255,y=65535&T,!(b+(g=T>>>24)<=u);){if(0===a)break e;a--,l+=r[o++]<<u,u+=8}l>>>=b,u-=b,n.back+=b}if(l>>>=g,u-=g,n.back+=g,n.length=y,0===v){n.mode=26;break}if(32&v){n.back=-1,n.mode=Ms;break}if(64&v){e.msg="invalid literal/length code",n.mode=js;break}n.extra=15&v,n.mode=22;case 22:if(n.extra){for(k=n.extra;u<k;){if(0===a)break e;a--,l+=r[o++]<<u,u+=8}n.length+=l&(1<<n.extra)-1,l>>>=n.extra,u-=n.extra,n.back+=n.extra}n.was=n.length,n.mode=23;case 23:for(;v=(T=n.distcode[l&(1<<n.distbits)-1])>>>16&255,y=65535&T,!((g=T>>>24)<=u);){if(0===a)break e;a--,l+=r[o++]<<u,u+=8}if(!(240&v)){for(b=g,_=v,w=y;v=(T=n.distcode[w+((l&(1<<b+_)-1)>>b)])>>>16&255,y=65535&T,!(b+(g=T>>>24)<=u);){if(0===a)break e;a--,l+=r[o++]<<u,u+=8}l>>>=b,u-=b,n.back+=b}if(l>>>=g,u-=g,n.back+=g,64&v){e.msg="invalid distance code",n.mode=js;break}n.offset=y,n.extra=15&v,n.mode=24;case 24:if(n.extra){for(k=n.extra;u<k;){if(0===a)break e;a--,l+=r[o++]<<u,u+=8}n.offset+=l&(1<<n.extra)-1,l>>>=n.extra,u-=n.extra,n.back+=n.extra}if(n.offset>n.dmax){e.msg="invalid distance too far back",n.mode=js;break}n.mode=25;case 25:if(0===c)break e;if(f=h-c,n.offset>f){if((f=n.offset-f)>n.whave&&n.sane){e.msg="invalid distance too far back",n.mode=js;break}f>n.wnext?(f-=n.wnext,p=n.wsize-f):p=n.wnext-f,f>n.length&&(f=n.length),m=n.window}else m=i,p=s-n.offset,f=n.length;f>c&&(f=c),c-=f,n.length-=f;do{i[s++]=m[p++]}while(--f);0===n.length&&(n.mode=21);break;case 26:if(0===c)break e;i[s++]=n.length,c--,n.mode=21;break;case 27:if(n.wrap){for(;u<32;){if(0===a)break e;a--,l|=r[o++]<<u,u+=8}if(h-=c,e.total_out+=h,n.total+=h,h&&(e.adler=n.check=n.flags?os(n.check,i,h,s-h):rs(n.check,i,h,s-h)),h=c,(n.flags?l:Us(l))!==n.check){e.msg="incorrect data check",n.mode=js;break}l=0,u=0}n.mode=28;case 28:if(n.wrap&&n.flags){for(;u<32;){if(0===a)break e;a--,l+=r[o++]<<u,u+=8}if(l!==(4294967295&n.total)){e.msg="incorrect length check",n.mode=js;break}l=0,u=0}n.mode=29;case 29:E=1;break e;case js:E=-3;break e;case 31:return-4;default:return Ns}return e.next_out=s,e.avail_out=c,e.next_in=o,e.avail_in=a,n.hold=l,n.bits=u,(n.wsize||h!==e.avail_out&&n.mode<js&&(n.mode<27||4!==t))&&function(e,t,n,r){var i,o=e.state;null===o.window&&(o.wsize=1<<o.wbits,o.wnext=0,o.whave=0,o.window=new po(o.wsize)),r>=o.wsize?(fo(o.window,t,n-o.wsize,o.wsize,0),o.wnext=0,o.whave=o.wsize):((i=o.wsize-o.wnext)>r&&(i=r),fo(o.window,t,n-r,i,o.wnext),(r-=i)?(fo(o.window,t,n-r,r,0),o.wnext=r,o.whave=o.wsize):(o.wnext+=i,o.wnext===o.wsize&&(o.wnext=0),o.whave<o.wsize&&(o.whave+=i)))}(e,e.output,e.next_out,h-e.avail_out),d-=e.avail_in,h-=e.avail_out,e.total_in+=d,e.total_out+=h,n.total+=h,n.wrap&&h&&(e.adler=n.check=n.flags?os(n.check,i,h,e.next_out-h):rs(n.check,i,h,e.next_out-h)),e.data_type=n.bits+(n.last?64:0)+(n.mode===Ms?128:0)+(20===n.mode||15===n.mode?256:0),(0===d&&0===h||4===t)&&0===E&&(E=-5),E}var Hs;function Zs(e){if(e<1||e>7)throw new TypeError("Bad argument");this.mode=e,this.init_done=!1,this.write_in_progress=!1,this.pending_close=!1,this.windowBits=0,this.level=0,this.memLevel=0,this.strategy=0,this.dictionary=null}function Xs(e,t){for(var n=0;n<e.length;n++)this[t+n]=e[n]}Zs.prototype.init=function(e,t,n,r,i){var o;switch(this.windowBits=e,this.level=t,this.memLevel=n,this.strategy=r,3!==this.mode&&4!==this.mode||(this.windowBits+=16),7===this.mode&&(this.windowBits+=32),5!==this.mode&&6!==this.mode||(this.windowBits=-this.windowBits),this.strm=new ho,this.mode){case 1:case 3:case 5:o=function(e,t,n,r,i,o){if(!e)return as;var s=1;if(-1===t&&(t=6),r<0?(s=0,r=-r):r>15&&(s=2,r-=16),i<1||i>9||8!==n||r<8||r>15||t<0||t>9||o<0||o>4)return fs(e,as);8===r&&(r=9);var a=new ks;return e.state=a,a.strm=e,a.wrap=s,a.gzhead=null,a.w_bits=r,a.w_size=1<<a.w_bits,a.w_mask=a.w_size-1,a.hash_bits=i+7,a.hash_size=1<<a.hash_bits,a.hash_mask=a.hash_size-1,a.hash_shift=~~((a.hash_bits+3-1)/3),a.window=new po(2*a.w_size),a.head=new mo(a.hash_size),a.prev=new mo(a.w_size),a.lit_bufsize=1<<i+6,a.pending_buf_size=4*a.lit_bufsize,a.pending_buf=new po(a.pending_buf_size),a.d_buf=1*a.lit_bufsize,a.l_buf=3*a.lit_bufsize,a.level=t,a.strategy=o,a.method=n,Ts(e)}(this.strm,this.level,8,this.windowBits,this.memLevel,this.strategy);break;case 2:case 4:case 6:case 7:o=Fs(this.strm,this.windowBits);break;default:throw new Error("Unknown mode "+this.mode)}0===o?(this.write_in_progress=!1,this.init_done=!0):this._error(o)},Zs.prototype.params=function(){throw new Error("deflateParams Not supported")},Zs.prototype._writeCheck=function(){if(!this.init_done)throw new Error("write before init");if(0===this.mode)throw new Error("already finalized");if(this.write_in_progress)throw new Error("write already in progress");if(this.pending_close)throw new Error("close is pending")},Zs.prototype.write=function(e,t,n,r,i,o,s){this._writeCheck(),this.write_in_progress=!0;var a=this;return Tn.nextTick((function(){a.write_in_progress=!1;var c=a._write(e,t,n,r,i,o,s);a.callback(c[0],c[1]),a.pending_close&&a.close()})),this},Zs.prototype.writeSync=function(e,t,n,r,i,o,s){return this._writeCheck(),this._write(e,t,n,r,i,o,s)},Zs.prototype._write=function(e,t,n,r,i,o,s){if(this.write_in_progress=!0,0!==e&&1!==e&&2!==e&&3!==e&&4!==e&&5!==e)throw new Error("Invalid flush value");null==t&&(t=new ft(0),r=0,n=0),i._set?i.set=i._set:i.set=Xs;var a,c=this.strm;switch(c.avail_in=r,c.input=t,c.next_in=n,c.avail_out=s,c.output=i,c.next_out=o,this.mode){case 1:case 3:case 5:a=xs(c,e);break;case 7:case 2:case 4:case 6:a=Js(c,e);break;default:throw new Error("Unknown mode "+this.mode)}return this._checkError(a,c,e)||this._error(a),this.write_in_progress=!1,[c.avail_in,c.avail_out]},Zs.prototype._checkError=function(e,t,n){switch(e){case 0:case-5:if(0!==t.avail_out&&4===n)return!1;break;case 1:break;default:return!1}return!0},Zs.prototype.close=function(){this.write_in_progress?this.pending_close=!0:(this.pending_close=!1,1===this.mode||3===this.mode||5===this.mode?function(e){var t;e&&e.state&&(42!==(t=e.state.status)&&69!==t&&73!==t&&91!==t&&t!==us&&t!==ds&&t!==hs?fs(e,as):(e.state=null,t===ds&&fs(e,-3)))}(this.strm):function(e){if(!e||!e.state)return Ns;var t=e.state;t.window&&(t.window=null),e.state=null}(this.strm),this.mode=0)},Zs.prototype.reset=function(){switch(this.mode){case 1:case 5:Hs=Ts(this.strm);break;case 2:case 6:Hs=Bs(this.strm)}0!==Hs&&this._error(Hs)},Zs.prototype._error=function(e){this.onerror(uo[e]+": "+this.strm.msg,e),this.write_in_progress=!1,this.pending_close&&this.close()};var Ys=Object.freeze({__proto__:null,DEFLATE:1,DEFLATERAW:5,GUNZIP:4,GZIP:3,INFLATE:2,INFLATERAW:6,NONE:0,UNZIP:7,Z_BEST_COMPRESSION:9,Z_BEST_SPEED:1,Z_BINARY:0,Z_BLOCK:5,Z_BUF_ERROR:-5,Z_DATA_ERROR:-3,Z_DEFAULT_COMPRESSION:-1,Z_DEFAULT_STRATEGY:0,Z_DEFLATED:8,Z_ERRNO:-1,Z_FILTERED:1,Z_FINISH:4,Z_FIXED:4,Z_FULL_FLUSH:3,Z_HUFFMAN_ONLY:2,Z_NEED_DICT:2,Z_NO_COMPRESSION:0,Z_NO_FLUSH:0,Z_OK:0,Z_PARTIAL_FLUSH:1,Z_RLE:3,Z_STREAM_END:1,Z_STREAM_ERROR:-2,Z_SYNC_FLUSH:2,Z_TEXT:1,Z_TREES:6,Z_UNKNOWN:2,Zlib:Zs});var $s={};Object.keys(Ys).forEach((function(e){$s[e]=Ys[e]})),$s.Z_MIN_WINDOWBITS=8,$s.Z_MAX_WINDOWBITS=15,$s.Z_DEFAULT_WINDOWBITS=15,$s.Z_MIN_CHUNK=64,$s.Z_MAX_CHUNK=1/0,$s.Z_DEFAULT_CHUNK=16384,$s.Z_MIN_MEMLEVEL=1,$s.Z_MAX_MEMLEVEL=9,$s.Z_DEFAULT_MEMLEVEL=8,$s.Z_MIN_LEVEL=-1,$s.Z_MAX_LEVEL=9,$s.Z_DEFAULT_LEVEL=$s.Z_DEFAULT_COMPRESSION;var Ks={Z_OK:$s.Z_OK,Z_STREAM_END:$s.Z_STREAM_END,Z_NEED_DICT:$s.Z_NEED_DICT,Z_ERRNO:$s.Z_ERRNO,Z_STREAM_ERROR:$s.Z_STREAM_ERROR,Z_DATA_ERROR:$s.Z_DATA_ERROR,Z_MEM_ERROR:$s.Z_MEM_ERROR,Z_BUF_ERROR:$s.Z_BUF_ERROR,Z_VERSION_ERROR:$s.Z_VERSION_ERROR};function Qs(e){return new Sa(e)}function ea(e){return new Ea(e)}function ta(e){return new Ta(e)}function na(e){return new xa(e)}function ra(e){return new Ca(e)}function ia(e){return new ka(e)}function oa(e){return new Ia(e)}function sa(e,t,n){return"function"==typeof t&&(n=t,t={}),_a(new Sa(t),e,n)}function aa(e,t){return wa(new Sa(t),e)}function ca(e,t,n){return"function"==typeof t&&(n=t,t={}),_a(new Ca(t),e,n)}function la(e,t){return wa(new Ca(t),e)}function ua(e,t,n){return"function"==typeof t&&(n=t,t={}),_a(new Ta(t),e,n)}function da(e,t){return wa(new Ta(t),e)}function ha(e,t,n){return"function"==typeof t&&(n=t,t={}),_a(new Ia(t),e,n)}function fa(e,t){return wa(new Ia(t),e)}function pa(e,t,n){return"function"==typeof t&&(n=t,t={}),_a(new Ea(t),e,n)}function ma(e,t){return wa(new Ea(t),e)}function ga(e,t,n){return"function"==typeof t&&(n=t,t={}),_a(new ka(t),e,n)}function va(e,t){return wa(new ka(t),e)}function ya(e,t,n){return"function"==typeof t&&(n=t,t={}),_a(new xa(t),e,n)}function ba(e,t){return wa(new xa(t),e)}function _a(e,t,n){var r=[],i=0;function o(){for(var t;null!==(t=e.read());)r.push(t),i+=t.length;e.once("readable",o)}function s(){var t=ft.concat(r,i);r=[],n(null,t),e.close()}e.on("error",(function(t){e.removeListener("end",s),e.removeListener("readable",o),n(t)})),e.on("end",s),e.end(t),o()}function wa(e,t){if("string"==typeof t&&(t=new ft(t)),!ft.isBuffer(t))throw new TypeError("Not a string or buffer");var n=$s.Z_FINISH;return e._processChunk(t,n)}function Sa(e){if(!(this instanceof Sa))return new Sa(e);Ra.call(this,e,$s.DEFLATE)}function Ea(e){if(!(this instanceof Ea))return new Ea(e);Ra.call(this,e,$s.INFLATE)}function Ca(e){if(!(this instanceof Ca))return new Ca(e);Ra.call(this,e,$s.GZIP)}function ka(e){if(!(this instanceof ka))return new ka(e);Ra.call(this,e,$s.GUNZIP)}function Ta(e){if(!(this instanceof Ta))return new Ta(e);Ra.call(this,e,$s.DEFLATERAW)}function xa(e){if(!(this instanceof xa))return new xa(e);Ra.call(this,e,$s.INFLATERAW)}function Ia(e){if(!(this instanceof Ia))return new Ia(e);Ra.call(this,e,$s.UNZIP)}function Ra(e,t){if(this._opts=e=e||{},this._chunkSize=e.chunkSize||$s.Z_DEFAULT_CHUNK,Hr.call(this,e),e.flush&&e.flush!==$s.Z_NO_FLUSH&&e.flush!==$s.Z_PARTIAL_FLUSH&&e.flush!==$s.Z_SYNC_FLUSH&&e.flush!==$s.Z_FULL_FLUSH&&e.flush!==$s.Z_FINISH&&e.flush!==$s.Z_BLOCK)throw new Error("Invalid flush flag: "+e.flush);if(this._flushFlag=e.flush||$s.Z_NO_FLUSH,e.chunkSize&&(e.chunkSize<$s.Z_MIN_CHUNK||e.chunkSize>$s.Z_MAX_CHUNK))throw new Error("Invalid chunk size: "+e.chunkSize);if(e.windowBits&&(e.windowBits<$s.Z_MIN_WINDOWBITS||e.windowBits>$s.Z_MAX_WINDOWBITS))throw new Error("Invalid windowBits: "+e.windowBits);if(e.level&&(e.level<$s.Z_MIN_LEVEL||e.level>$s.Z_MAX_LEVEL))throw new Error("Invalid compression level: "+e.level);if(e.memLevel&&(e.memLevel<$s.Z_MIN_MEMLEVEL||e.memLevel>$s.Z_MAX_MEMLEVEL))throw new Error("Invalid memLevel: "+e.memLevel);if(e.strategy&&e.strategy!=$s.Z_FILTERED&&e.strategy!=$s.Z_HUFFMAN_ONLY&&e.strategy!=$s.Z_RLE&&e.strategy!=$s.Z_FIXED&&e.strategy!=$s.Z_DEFAULT_STRATEGY)throw new Error("Invalid strategy: "+e.strategy);if(e.dictionary&&!ft.isBuffer(e.dictionary))throw new Error("Invalid dictionary: it should be a Buffer instance");this._binding=new $s.Zlib(t);var n=this;this._hadError=!1,this._binding.onerror=function(e,t){n._binding=null,n._hadError=!0;var r=new Error(e);r.errno=t,r.code=Ks[t],n.emit("error",r)};var r=$s.Z_DEFAULT_COMPRESSION;"number"==typeof e.level&&(r=e.level);var i=$s.Z_DEFAULT_STRATEGY;"number"==typeof e.strategy&&(i=e.strategy),this._binding.init(e.windowBits||$s.Z_DEFAULT_WINDOWBITS,r,e.memLevel||$s.Z_DEFAULT_MEMLEVEL,i,e.dictionary),this._buffer=new ft(this._chunkSize),this._offset=0,this._closed=!1,this._level=r,this._strategy=i,this.once("end",this.close)}Object.keys(Ks).forEach((function(e){Ks[Ks[e]]=e})),Rn(Ra,Hr),Ra.prototype.params=function(e,t,n){if(e<$s.Z_MIN_LEVEL||e>$s.Z_MAX_LEVEL)throw new RangeError("Invalid compression level: "+e);if(t!=$s.Z_FILTERED&&t!=$s.Z_HUFFMAN_ONLY&&t!=$s.Z_RLE&&t!=$s.Z_FIXED&&t!=$s.Z_DEFAULT_STRATEGY)throw new TypeError("Invalid strategy: "+t);if(this._level!==e||this._strategy!==t){var r=this;this.flush($s.Z_SYNC_FLUSH,(function(){r._binding.params(e,t),r._hadError||(r._level=e,r._strategy=t,n&&n())}))}else Tn.nextTick(n)},Ra.prototype.reset=function(){return this._binding.reset()},Ra.prototype._flush=function(e){this._transform(new ft(0),"",e)},Ra.prototype.flush=function(e,t){var n=this._writableState;if(("function"==typeof e||void 0===e&&!t)&&(t=e,e=$s.Z_FULL_FLUSH),n.ended)t&&Tn.nextTick(t);else if(n.ending)t&&this.once("end",t);else if(n.needDrain){var r=this;this.once("drain",(function(){r.flush(t)}))}else this._flushFlag=e,this.write(new ft(0),"",t)},Ra.prototype.close=function(e){if(e&&Tn.nextTick(e),!this._closed){this._closed=!0,this._binding.close();var t=this;Tn.nextTick((function(){t.emit("close")}))}},Ra.prototype._transform=function(e,t,n){var r,i=this._writableState,o=(i.ending||i.ended)&&(!e||i.length===e.length);if(null===!e&&!ft.isBuffer(e))return n(new Error("invalid input"));o?r=$s.Z_FINISH:(r=this._flushFlag,e.length>=i.length&&(this._flushFlag=this._opts.flush||$s.Z_NO_FLUSH)),this._processChunk(e,r,n)},Ra.prototype._processChunk=function(e,t,n){var r=e&&e.length,i=this._chunkSize-this._offset,o=0,s=this,a="function"==typeof n;if(!a){var c,l=[],u=0;this.on("error",(function(e){c=e}));do{var d=this._binding.writeSync(t,e,o,r,this._buffer,this._offset,i)}while(!this._hadError&&p(d[0],d[1]));if(this._hadError)throw c;var h=ft.concat(l,u);return this.close(),h}var f=this._binding.write(t,e,o,r,this._buffer,this._offset,i);function p(c,d){if(!s._hadError){var h=i-d;if(function(e,t){if(!e)throw new Error(t)}(h>=0,"have should not go down"),h>0){var f=s._buffer.slice(s._offset,s._offset+h);s._offset+=h,a?s.push(f):(l.push(f),u+=f.length)}if((0===d||s._offset>=s._chunkSize)&&(i=s._chunkSize,s._offset=0,s._buffer=new ft(s._chunkSize)),0===d){if(o+=r-c,r=c,!a)return!0;var m=s._binding.write(t,e,o,r,s._buffer,s._offset,s._chunkSize);return m.callback=p,void(m.buffer=e)}if(!a)return!1;n()}}f.buffer=e,f.callback=p},Rn(Sa,Ra),Rn(Ea,Ra),Rn(Ca,Ra),Rn(ka,Ra),Rn(Ta,Ra),Rn(xa,Ra),Rn(Ia,Ra);var Oa,Aa,La,Pa,Da,Na,Ma,ja={codes:Ks,createDeflate:Qs,createInflate:ea,createDeflateRaw:ta,createInflateRaw:na,createGzip:ra,createGunzip:ia,createUnzip:oa,deflate:sa,deflateSync:aa,gzip:ca,gzipSync:la,deflateRaw:ua,deflateRawSync:da,unzip:ha,unzipSync:fa,inflate:pa,inflateSync:ma,gunzip:ga,gunzipSync:va,inflateRaw:ya,inflateRawSync:ba,Deflate:Sa,Inflate:Ea,Gzip:Ca,Gunzip:ka,DeflateRaw:Ta,InflateRaw:xa,Unzip:Ia,Zlib:Ra},Ua=N(Object.freeze({__proto__:null,Deflate:Sa,DeflateRaw:Ta,Gunzip:ka,Gzip:Ca,Inflate:Ea,InflateRaw:xa,Unzip:Ia,Zlib:Ra,codes:Ks,createDeflate:Qs,createDeflateRaw:ta,createGunzip:ia,createGzip:ra,createInflate:ea,createInflateRaw:na,createUnzip:oa,default:ja,deflate:sa,deflateRaw:ua,deflateRawSync:da,deflateSync:aa,gunzip:ga,gunzipSync:va,gzip:ca,gzipSync:la,inflate:pa,inflateRaw:ya,inflateRawSync:ba,inflateSync:ma,unzip:ha,unzipSync:fa})),za={exports:{}};function Ba(){if(Aa)return Oa;Aa=1;const e=["nodebuffer","arraybuffer","fragments"],t="undefined"!=typeof Blob;return t&&e.push("blob"),Oa={BINARY_TYPES:e,EMPTY_BUFFER:ft.alloc(0),GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",hasBlob:t,kForOnEventAttribute:Symbol("kIsForOnEventAttribute"),kListener:Symbol("kListener"),kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),NOOP:()=>{}}}function Fa(){if(La)return za.exports;La=1;const{EMPTY_BUFFER:e}=Ba(),t=ft[Symbol.species];function n(e,t,n,r,i){for(let o=0;o<i;o++)n[r+o]=e[o]^t[3&o]}function r(e,t){for(let n=0;n<e.length;n++)e[n]^=t[3&n]}if(za.exports={concat:function(n,r){if(0===n.length)return e;if(1===n.length)return n[0];const i=ft.allocUnsafe(r);let o=0;for(let e=0;e<n.length;e++){const t=n[e];i.set(t,o),o+=t.length}return o<r?new t(i.buffer,i.byteOffset,o):i},mask:n,toArrayBuffer:function(e){return e.length===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.length)},toBuffer:function e(n){if(e.readOnly=!0,ft.isBuffer(n))return n;let r;return n instanceof ArrayBuffer?r=new t(n):ArrayBuffer.isView(n)?r=new t(n.buffer,n.byteOffset,n.byteLength):(r=ft.from(n),e.readOnly=!1),r},unmask:r},!Tn.env.WS_NO_BUFFER_UTIL)try{const e=require("bufferutil");za.exports.mask=function(t,r,i,o,s){s<48?n(t,r,i,o,s):e.mask(t,r,i,o,s)},za.exports.unmask=function(t,n){t.length<32?r(t,n):e.unmask(t,n)}}catch(e){}return za.exports}function qa(){if(Ma)return Na;Ma=1;const e=Ua,t=Fa(),n=function(){if(Da)return Pa;Da=1;const e=Symbol("kDone"),t=Symbol("kRun");return Pa=class{constructor(n){this[e]=()=>{this.pending--,this[t]()},this.concurrency=n||1/0,this.jobs=[],this.pending=0}add(e){this.jobs.push(e),this[t]()}[t](){if(this.pending!==this.concurrency&&this.jobs.length){const t=this.jobs.shift();this.pending++,t(this[e])}}}}(),{kStatusCode:r}=Ba(),i=ft[Symbol.species],o=ft.from([0,0,255,255]),s=Symbol("permessage-deflate"),a=Symbol("total-length"),c=Symbol("callback"),l=Symbol("buffers"),u=Symbol("error");let d;function h(e){this[l].push(e),this[a]+=e.length}function f(e){this[a]+=e.length,this[s]._maxPayload<1||this[a]<=this[s]._maxPayload?this[l].push(e):(this[u]=new RangeError("Max payload size exceeded"),this[u].code="WS_ERR_UNSUPPORTED_MESSAGE_LENGTH",this[u][r]=1009,this.removeListener("data",f),this.reset())}function p(e){this[s]._inflate=null,e[r]=1007,this[c](e)}return Na=class{constructor(e,t,r){if(this._maxPayload=0|r,this._options=e||{},this._threshold=void 0!==this._options.threshold?this._options.threshold:1024,this._isServer=!!t,this._deflate=null,this._inflate=null,this.params=null,!d){const e=void 0!==this._options.concurrencyLimit?this._options.concurrencyLimit:10;d=new n(e)}}static get extensionName(){return"permessage-deflate"}offer(){const e={};return this._options.serverNoContextTakeover&&(e.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(e.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(e.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?e.client_max_window_bits=this._options.clientMaxWindowBits:null==this._options.clientMaxWindowBits&&(e.client_max_window_bits=!0),e}accept(e){return e=this.normalizeParams(e),this.params=this._isServer?this.acceptAsServer(e):this.acceptAsClient(e),this.params}cleanup(){if(this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate){const e=this._deflate[c];this._deflate.close(),this._deflate=null,e&&e(new Error("The deflate stream was closed while data was being processed"))}}acceptAsServer(e){const t=this._options,n=e.find((e=>!(!1===t.serverNoContextTakeover&&e.server_no_context_takeover||e.server_max_window_bits&&(!1===t.serverMaxWindowBits||"number"==typeof t.serverMaxWindowBits&&t.serverMaxWindowBits>e.server_max_window_bits)||"number"==typeof t.clientMaxWindowBits&&!e.client_max_window_bits)));if(!n)throw new Error("None of the extension offers can be accepted");return t.serverNoContextTakeover&&(n.server_no_context_takeover=!0),t.clientNoContextTakeover&&(n.client_no_context_takeover=!0),"number"==typeof t.serverMaxWindowBits&&(n.server_max_window_bits=t.serverMaxWindowBits),"number"==typeof t.clientMaxWindowBits?n.client_max_window_bits=t.clientMaxWindowBits:!0!==n.client_max_window_bits&&!1!==t.clientMaxWindowBits||delete n.client_max_window_bits,n}acceptAsClient(e){const t=e[0];if(!1===this._options.clientNoContextTakeover&&t.client_no_context_takeover)throw new Error('Unexpected parameter "client_no_context_takeover"');if(t.client_max_window_bits){if(!1===this._options.clientMaxWindowBits||"number"==typeof this._options.clientMaxWindowBits&&t.client_max_window_bits>this._options.clientMaxWindowBits)throw new Error('Unexpected or invalid parameter "client_max_window_bits"')}else"number"==typeof this._options.clientMaxWindowBits&&(t.client_max_window_bits=this._options.clientMaxWindowBits);return t}normalizeParams(e){return e.forEach((e=>{Object.keys(e).forEach((t=>{let n=e[t];if(n.length>1)throw new Error(`Parameter "${t}" must have only a single value`);if(n=n[0],"client_max_window_bits"===t){if(!0!==n){const e=+n;if(!Number.isInteger(e)||e<8||e>15)throw new TypeError(`Invalid value for parameter "${t}": ${n}`);n=e}else if(!this._isServer)throw new TypeError(`Invalid value for parameter "${t}": ${n}`)}else if("server_max_window_bits"===t){const e=+n;if(!Number.isInteger(e)||e<8||e>15)throw new TypeError(`Invalid value for parameter "${t}": ${n}`);n=e}else{if("client_no_context_takeover"!==t&&"server_no_context_takeover"!==t)throw new Error(`Unknown parameter "${t}"`);if(!0!==n)throw new TypeError(`Invalid value for parameter "${t}": ${n}`)}e[t]=n}))})),e}decompress(e,t,n){d.add((r=>{this._decompress(e,t,((e,t)=>{r(),n(e,t)}))}))}compress(e,t,n){d.add((r=>{this._compress(e,t,((e,t)=>{r(),n(e,t)}))}))}_decompress(n,r,i){const d=this._isServer?"client":"server";if(!this._inflate){const t=`${d}_max_window_bits`,n="number"!=typeof this.params[t]?e.Z_DEFAULT_WINDOWBITS:this.params[t];this._inflate=e.createInflateRaw({...this._options.zlibInflateOptions,windowBits:n}),this._inflate[s]=this,this._inflate[a]=0,this._inflate[l]=[],this._inflate.on("error",p),this._inflate.on("data",f)}this._inflate[c]=i,this._inflate.write(n),r&&this._inflate.write(o),this._inflate.flush((()=>{const e=this._inflate[u];if(e)return this._inflate.close(),this._inflate=null,void i(e);const n=t.concat(this._inflate[l],this._inflate[a]);this._inflate._readableState.endEmitted?(this._inflate.close(),this._inflate=null):(this._inflate[a]=0,this._inflate[l]=[],r&&this.params[`${d}_no_context_takeover`]&&this._inflate.reset()),i(null,n)}))}_compress(n,r,o){const s=this._isServer?"server":"client";if(!this._deflate){const t=`${s}_max_window_bits`,n="number"!=typeof this.params[t]?e.Z_DEFAULT_WINDOWBITS:this.params[t];this._deflate=e.createDeflateRaw({...this._options.zlibDeflateOptions,windowBits:n}),this._deflate[a]=0,this._deflate[l]=[],this._deflate.on("data",h)}this._deflate[c]=o,this._deflate.write(n),this._deflate.flush(e.Z_SYNC_FLUSH,(()=>{if(!this._deflate)return;let e=t.concat(this._deflate[l],this._deflate[a]);r&&(e=new i(e.buffer,e.byteOffset,e.length-4)),this._deflate[c]=null,this._deflate[a]=0,this._deflate[l]=[],r&&this.params[`${s}_no_context_takeover`]&&this._deflate.reset(),o(null,e)}))}},Na}var Wa,Va,Ga,Ja,Ha,Za,Xa,Ya,$a,Ka,Qa,ec,tc,nc,rc,ic,oc,sc,ac,cc,lc,uc,dc,hc,fc,pc,mc,gc={exports:{}},vc=N(Kt);function yc(){if(Wa)return gc.exports;Wa=1;const{isUtf8:e}=vc,{hasBlob:t}=Ba();function n(e){const t=e.length;let n=0;for(;n<t;)if(128&e[n])if(192==(224&e[n])){if(n+1===t||128!=(192&e[n+1])||192==(254&e[n]))return!1;n+=2}else if(224==(240&e[n])){if(n+2>=t||128!=(192&e[n+1])||128!=(192&e[n+2])||224===e[n]&&128==(224&e[n+1])||237===e[n]&&160==(224&e[n+1]))return!1;n+=3}else{if(240!=(248&e[n]))return!1;if(n+3>=t||128!=(192&e[n+1])||128!=(192&e[n+2])||128!=(192&e[n+3])||240===e[n]&&128==(240&e[n+1])||244===e[n]&&e[n+1]>143||e[n]>244)return!1;n+=4}else n++;return!0}if(gc.exports={isBlob:function(e){return t&&"object"==typeof e&&"function"==typeof e.arrayBuffer&&"string"==typeof e.type&&"function"==typeof e.stream&&("Blob"===e[Symbol.toStringTag]||"File"===e[Symbol.toStringTag])},isValidStatusCode:function(e){return e>=1e3&&e<=1014&&1004!==e&&1005!==e&&1006!==e||e>=3e3&&e<=4999},isValidUTF8:n,tokenChars:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0]},e)gc.exports.isValidUTF8=function(t){return t.length<24?n(t):e(t)};else if(!Tn.env.WS_NO_UTF_8_VALIDATE)try{const e=require("utf-8-validate");gc.exports.isValidUTF8=function(t){return t.length<32?n(t):e(t)}}catch(e){}return gc.exports}function bc(){if(Ga)return Va;Ga=1;const{Writable:e}=co,t=qa(),{BINARY_TYPES:n,EMPTY_BUFFER:r,kStatusCode:i,kWebSocket:o}=Ba(),{concat:s,toArrayBuffer:a,unmask:c}=Fa(),{isValidStatusCode:l,isValidUTF8:u}=yc(),d=ft[Symbol.species];return Va=class extends e{constructor(e={}){super(),this._allowSynchronousEvents=void 0===e.allowSynchronousEvents||e.allowSynchronousEvents,this._binaryType=e.binaryType||n[0],this._extensions=e.extensions||{},this._isServer=!!e.isServer,this._maxPayload=0|e.maxPayload,this._skipUTF8Validation=!!e.skipUTF8Validation,this[o]=void 0,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._errored=!1,this._loop=!1,this._state=0}_write(e,t,n){if(8===this._opcode&&0==this._state)return n();this._bufferedBytes+=e.length,this._buffers.push(e),this.startLoop(n)}consume(e){if(this._bufferedBytes-=e,e===this._buffers[0].length)return this._buffers.shift();if(e<this._buffers[0].length){const t=this._buffers[0];return this._buffers[0]=new d(t.buffer,t.byteOffset+e,t.length-e),new d(t.buffer,t.byteOffset,e)}const t=ft.allocUnsafe(e);do{const n=this._buffers[0],r=t.length-e;e>=n.length?t.set(this._buffers.shift(),r):(t.set(new Uint8Array(n.buffer,n.byteOffset,e),r),this._buffers[0]=new d(n.buffer,n.byteOffset+e,n.length-e)),e-=n.length}while(e>0);return t}startLoop(e){this._loop=!0;do{switch(this._state){case 0:this.getInfo(e);break;case 1:this.getPayloadLength16(e);break;case 2:this.getPayloadLength64(e);break;case 3:this.getMask();break;case 4:this.getData(e);break;case 5:case 6:return void(this._loop=!1)}}while(this._loop);this._errored||e()}getInfo(e){if(this._bufferedBytes<2)return void(this._loop=!1);const n=this.consume(2);if(48&n[0]){return void e(this.createError(RangeError,"RSV2 and RSV3 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_2_3"))}const r=!(64&~n[0]);if(!r||this._extensions[t.extensionName]){if(this._fin=!(128&~n[0]),this._opcode=15&n[0],this._payloadLength=127&n[1],0===this._opcode){if(r){return void e(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"))}if(!this._fragmented){return void e(this.createError(RangeError,"invalid opcode 0",!0,1002,"WS_ERR_INVALID_OPCODE"))}this._opcode=this._fragmented}else if(1===this._opcode||2===this._opcode){if(this._fragmented){return void e(this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE"))}this._compressed=r}else{if(!(this._opcode>7&&this._opcode<11)){return void e(this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE"))}if(!this._fin){return void e(this.createError(RangeError,"FIN must be set",!0,1002,"WS_ERR_EXPECTED_FIN"))}if(r){return void e(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"))}if(this._payloadLength>125||8===this._opcode&&1===this._payloadLength){return void e(this.createError(RangeError,`invalid payload length ${this._payloadLength}`,!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH"))}}if(this._fin||this._fragmented||(this._fragmented=this._opcode),this._masked=!(128&~n[1]),this._isServer){if(!this._masked){return void e(this.createError(RangeError,"MASK must be set",!0,1002,"WS_ERR_EXPECTED_MASK"))}}else if(this._masked){return void e(this.createError(RangeError,"MASK must be clear",!0,1002,"WS_ERR_UNEXPECTED_MASK"))}126===this._payloadLength?this._state=1:127===this._payloadLength?this._state=2:this.haveLength(e)}else{e(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"))}}getPayloadLength16(e){this._bufferedBytes<2?this._loop=!1:(this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength(e))}getPayloadLength64(e){if(this._bufferedBytes<8)return void(this._loop=!1);const t=this.consume(8),n=t.readUInt32BE(0);if(n>Math.pow(2,21)-1){e(this.createError(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009,"WS_ERR_UNSUPPORTED_DATA_PAYLOAD_LENGTH"))}else this._payloadLength=n*Math.pow(2,32)+t.readUInt32BE(4),this.haveLength(e)}haveLength(e){if(this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0)){e(this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH"))}else this._masked?this._state=3:this._state=4}getMask(){this._bufferedBytes<4?this._loop=!1:(this._mask=this.consume(4),this._state=4)}getData(e){let t=r;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength)return void(this._loop=!1);t=this.consume(this._payloadLength),this._masked&&this._mask[0]|this._mask[1]|this._mask[2]|this._mask[3]&&c(t,this._mask)}if(this._opcode>7)this.controlMessage(t,e);else{if(this._compressed)return this._state=5,void this.decompress(t,e);t.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(t)),this.dataMessage(e)}}decompress(e,n){this._extensions[t.extensionName].decompress(e,this._fin,((e,t)=>{if(e)return n(e);if(t.length){if(this._messageLength+=t.length,this._messageLength>this._maxPayload&&this._maxPayload>0){const e=this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");return void n(e)}this._fragments.push(t)}this.dataMessage(n),0===this._state&&this.startLoop(n)}))}dataMessage(e){if(!this._fin)return void(this._state=0);const t=this._messageLength,n=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],2===this._opcode){let r;r="nodebuffer"===this._binaryType?s(n,t):"arraybuffer"===this._binaryType?a(s(n,t)):"blob"===this._binaryType?new Blob(n):n,this._allowSynchronousEvents?(this.emit("message",r,!0),this._state=0):(this._state=6,setImmediate((()=>{this.emit("message",r,!0),this._state=0,this.startLoop(e)})))}else{const r=s(n,t);if(!this._skipUTF8Validation&&!u(r)){const t=this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");return void e(t)}5===this._state||this._allowSynchronousEvents?(this.emit("message",r,!1),this._state=0):(this._state=6,setImmediate((()=>{this.emit("message",r,!1),this._state=0,this.startLoop(e)})))}}controlMessage(e,t){if(8!==this._opcode)this._allowSynchronousEvents?(this.emit(9===this._opcode?"ping":"pong",e),this._state=0):(this._state=6,setImmediate((()=>{this.emit(9===this._opcode?"ping":"pong",e),this._state=0,this.startLoop(t)})));else{if(0===e.length)this._loop=!1,this.emit("conclude",1005,r),this.end();else{const n=e.readUInt16BE(0);if(!l(n)){const e=this.createError(RangeError,`invalid status code ${n}`,!0,1002,"WS_ERR_INVALID_CLOSE_CODE");return void t(e)}const r=new d(e.buffer,e.byteOffset+2,e.length-2);if(!this._skipUTF8Validation&&!u(r)){const e=this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");return void t(e)}this._loop=!1,this.emit("conclude",n,r),this.end()}this._state=0}}createError(e,t,n,r,o){this._loop=!1,this._errored=!0;const s=new e(n?`Invalid WebSocket frame: ${t}`:t);return Error.captureStackTrace(s,this.createError),s.code=o,s[i]=r,s}},Va}function _c(){if(Ha)return Ja;Ha=1;const{randomFillSync:e}=ao,t=qa(),{EMPTY_BUFFER:n,kWebSocket:r,NOOP:i}=Ba(),{isBlob:o,isValidStatusCode:s}=yc(),{mask:a,toBuffer:c}=Fa(),l=Symbol("kByteLength"),u=ft.alloc(4),d=8192;let h,f=d;class p{constructor(e,t,n){this._extensions=t||{},n&&(this._generateMask=n,this._maskBuffer=ft.alloc(4)),this._socket=e,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._queue=[],this._state=0,this.onerror=i,this[r]=void 0}static frame(t,n){let r,i,o=!1,s=2,c=!1;n.mask&&(r=n.maskBuffer||u,n.generateMask?n.generateMask(r):(f===d&&(void 0===h&&(h=ft.alloc(d)),e(h,0,d),f=0),r[0]=h[f++],r[1]=h[f++],r[2]=h[f++],r[3]=h[f++]),c=!(r[0]|r[1]|r[2]|r[3]),s=6),"string"==typeof t?i=n.mask&&!c||void 0===n[l]?(t=ft.from(t)).length:n[l]:(i=t.length,o=n.mask&&n.readOnly&&!c);let p=i;i>=65536?(s+=8,p=127):i>125&&(s+=2,p=126);const m=ft.allocUnsafe(o?i+s:s);return m[0]=n.fin?128|n.opcode:n.opcode,n.rsv1&&(m[0]|=64),m[1]=p,126===p?m.writeUInt16BE(i,2):127===p&&(m[2]=m[3]=0,m.writeUIntBE(i,4,6)),n.mask?(m[1]|=128,m[s-4]=r[0],m[s-3]=r[1],m[s-2]=r[2],m[s-1]=r[3],c?[m,t]:o?(a(t,r,m,s,i),[m]):(a(t,r,t,0,i),[m,t])):[m,t]}close(e,t,r,i){let o;if(void 0===e)o=n;else{if("number"!=typeof e||!s(e))throw new TypeError("First argument must be a valid error code number");if(void 0!==t&&t.length){const n=ft.byteLength(t);if(n>123)throw new RangeError("The message must not be greater than 123 bytes");o=ft.allocUnsafe(2+n),o.writeUInt16BE(e,0),"string"==typeof t?o.write(t,2):o.set(t,2)}else o=ft.allocUnsafe(2),o.writeUInt16BE(e,0)}const a={[l]:o.length,fin:!0,generateMask:this._generateMask,mask:r,maskBuffer:this._maskBuffer,opcode:8,readOnly:!1,rsv1:!1};0!==this._state?this.enqueue([this.dispatch,o,!1,a,i]):this.sendFrame(p.frame(o,a),i)}ping(e,t,n){let r,i;if("string"==typeof e?(r=ft.byteLength(e),i=!1):o(e)?(r=e.size,i=!1):(r=(e=c(e)).length,i=c.readOnly),r>125)throw new RangeError("The data size must not be greater than 125 bytes");const s={[l]:r,fin:!0,generateMask:this._generateMask,mask:t,maskBuffer:this._maskBuffer,opcode:9,readOnly:i,rsv1:!1};o(e)?0!==this._state?this.enqueue([this.getBlobData,e,!1,s,n]):this.getBlobData(e,!1,s,n):0!==this._state?this.enqueue([this.dispatch,e,!1,s,n]):this.sendFrame(p.frame(e,s),n)}pong(e,t,n){let r,i;if("string"==typeof e?(r=ft.byteLength(e),i=!1):o(e)?(r=e.size,i=!1):(r=(e=c(e)).length,i=c.readOnly),r>125)throw new RangeError("The data size must not be greater than 125 bytes");const s={[l]:r,fin:!0,generateMask:this._generateMask,mask:t,maskBuffer:this._maskBuffer,opcode:10,readOnly:i,rsv1:!1};o(e)?0!==this._state?this.enqueue([this.getBlobData,e,!1,s,n]):this.getBlobData(e,!1,s,n):0!==this._state?this.enqueue([this.dispatch,e,!1,s,n]):this.sendFrame(p.frame(e,s),n)}send(e,n,r){const i=this._extensions[t.extensionName];let s,a,u=n.binary?2:1,d=n.compress;"string"==typeof e?(s=ft.byteLength(e),a=!1):o(e)?(s=e.size,a=!1):(s=(e=c(e)).length,a=c.readOnly),this._firstFragment?(this._firstFragment=!1,d&&i&&i.params[i._isServer?"server_no_context_takeover":"client_no_context_takeover"]&&(d=s>=i._threshold),this._compress=d):(d=!1,u=0),n.fin&&(this._firstFragment=!0);const h={[l]:s,fin:n.fin,generateMask:this._generateMask,mask:n.mask,maskBuffer:this._maskBuffer,opcode:u,readOnly:a,rsv1:d};o(e)?0!==this._state?this.enqueue([this.getBlobData,e,this._compress,h,r]):this.getBlobData(e,this._compress,h,r):0!==this._state?this.enqueue([this.dispatch,e,this._compress,h,r]):this.dispatch(e,this._compress,h,r)}getBlobData(e,t,n,r){this._bufferedBytes+=n[l],this._state=2,e.arrayBuffer().then((e=>{if(this._socket.destroyed){const e=new Error("The socket was closed while the blob was being read");return void Tn.nextTick(m,this,e,r)}this._bufferedBytes-=n[l];const i=c(e);t?this.dispatch(i,t,n,r):(this._state=0,this.sendFrame(p.frame(i,n),r),this.dequeue())})).catch((e=>{Tn.nextTick(g,this,e,r)}))}dispatch(e,n,r,i){if(!n)return void this.sendFrame(p.frame(e,r),i);const o=this._extensions[t.extensionName];this._bufferedBytes+=r[l],this._state=1,o.compress(e,r.fin,((e,t)=>{if(this._socket.destroyed){m(this,new Error("The socket was closed while data was being compressed"),i)}else this._bufferedBytes-=r[l],this._state=0,r.readOnly=!1,this.sendFrame(p.frame(t,r),i),this.dequeue()}))}dequeue(){for(;0===this._state&&this._queue.length;){const e=this._queue.shift();this._bufferedBytes-=e[3][l],Reflect.apply(e[0],this,e.slice(1))}}enqueue(e){this._bufferedBytes+=e[3][l],this._queue.push(e)}sendFrame(e,t){2===e.length?(this._socket.cork(),this._socket.write(e[0]),this._socket.write(e[1],t),this._socket.uncork()):this._socket.write(e[0],t)}}function m(e,t,n){"function"==typeof n&&n(t);for(let n=0;n<e._queue.length;n++){const r=e._queue[n],i=r[r.length-1];"function"==typeof i&&i(t)}}function g(e,t,n){m(e,t,n),e.onerror(t)}return Ja=p}function wc(){if($a)return Ya;$a=1;const{tokenChars:e}=yc();function t(e,t,n){void 0===e[t]?e[t]=[n]:e[t].push(n)}return Ya={format:function(e){return Object.keys(e).map((t=>{let n=e[t];return Array.isArray(n)||(n=[n]),n.map((e=>[t].concat(Object.keys(e).map((t=>{let n=e[t];return Array.isArray(n)||(n=[n]),n.map((e=>!0===e?t:`${t}=${e}`)).join("; ")}))).join("; "))).join(", ")})).join(", ")},parse:function(n){const r=Object.create(null);let i,o,s=Object.create(null),a=!1,c=!1,l=!1,u=-1,d=-1,h=-1,f=0;for(;f<n.length;f++)if(d=n.charCodeAt(f),void 0===i)if(-1===h&&1===e[d])-1===u&&(u=f);else if(0===f||32!==d&&9!==d){if(59!==d&&44!==d)throw new SyntaxError(`Unexpected character at index ${f}`);{if(-1===u)throw new SyntaxError(`Unexpected character at index ${f}`);-1===h&&(h=f);const e=n.slice(u,h);44===d?(t(r,e,s),s=Object.create(null)):i=e,u=h=-1}}else-1===h&&-1!==u&&(h=f);else if(void 0===o)if(-1===h&&1===e[d])-1===u&&(u=f);else if(32===d||9===d)-1===h&&-1!==u&&(h=f);else if(59===d||44===d){if(-1===u)throw new SyntaxError(`Unexpected character at index ${f}`);-1===h&&(h=f),t(s,n.slice(u,h),!0),44===d&&(t(r,i,s),s=Object.create(null),i=void 0),u=h=-1}else{if(61!==d||-1===u||-1!==h)throw new SyntaxError(`Unexpected character at index ${f}`);o=n.slice(u,f),u=h=-1}else if(c){if(1!==e[d])throw new SyntaxError(`Unexpected character at index ${f}`);-1===u?u=f:a||(a=!0),c=!1}else if(l)if(1===e[d])-1===u&&(u=f);else if(34===d&&-1!==u)l=!1,h=f;else{if(92!==d)throw new SyntaxError(`Unexpected character at index ${f}`);c=!0}else if(34===d&&61===n.charCodeAt(f-1))l=!0;else if(-1===h&&1===e[d])-1===u&&(u=f);else if(-1===u||32!==d&&9!==d){if(59!==d&&44!==d)throw new SyntaxError(`Unexpected character at index ${f}`);{if(-1===u)throw new SyntaxError(`Unexpected character at index ${f}`);-1===h&&(h=f);let e=n.slice(u,h);a&&(e=e.replace(/\\/g,""),a=!1),t(s,o,e),44===d&&(t(r,i,s),s=Object.create(null),i=void 0),o=void 0,u=h=-1}}else-1===h&&(h=f);if(-1===u||l||32===d||9===d)throw new SyntaxError("Unexpected end of input");-1===h&&(h=f);const p=n.slice(u,h);return void 0===i?t(r,p,s):(void 0===o?t(s,p,!0):t(s,o,a?p.replace(/\\/g,""):p),t(r,i,s)),r}},Ya}function Sc(){if(Qa)return Ka;Qa=1;const e=te(),t=$i,n=io,r=oo,i=so,{randomBytes:o,createHash:s}=ao,{URL:a}=lo,c=qa(),l=bc(),u=_c(),{isBlob:d}=yc(),{BINARY_TYPES:h,EMPTY_BUFFER:f,GUID:p,kForOnEventAttribute:m,kListener:g,kStatusCode:v,kWebSocket:y,NOOP:b}=Ba(),{EventTarget:{addEventListener:_,removeEventListener:w}}=function(){if(Xa)return Za;Xa=1;const{kForOnEventAttribute:e,kListener:t}=Ba(),n=Symbol("kCode"),r=Symbol("kData"),i=Symbol("kError"),o=Symbol("kMessage"),s=Symbol("kReason"),a=Symbol("kTarget"),c=Symbol("kType"),l=Symbol("kWasClean");class u{constructor(e){this[a]=null,this[c]=e}get target(){return this[a]}get type(){return this[c]}}Object.defineProperty(u.prototype,"target",{enumerable:!0}),Object.defineProperty(u.prototype,"type",{enumerable:!0});class d extends u{constructor(e,t={}){super(e),this[n]=void 0===t.code?0:t.code,this[s]=void 0===t.reason?"":t.reason,this[l]=void 0!==t.wasClean&&t.wasClean}get code(){return this[n]}get reason(){return this[s]}get wasClean(){return this[l]}}Object.defineProperty(d.prototype,"code",{enumerable:!0}),Object.defineProperty(d.prototype,"reason",{enumerable:!0}),Object.defineProperty(d.prototype,"wasClean",{enumerable:!0});class h extends u{constructor(e,t={}){super(e),this[i]=void 0===t.error?null:t.error,this[o]=void 0===t.message?"":t.message}get error(){return this[i]}get message(){return this[o]}}Object.defineProperty(h.prototype,"error",{enumerable:!0}),Object.defineProperty(h.prototype,"message",{enumerable:!0});class f extends u{constructor(e,t={}){super(e),this[r]=void 0===t.data?null:t.data}get data(){return this[r]}}Object.defineProperty(f.prototype,"data",{enumerable:!0});const p={addEventListener(n,r,i={}){for(const o of this.listeners(n))if(!i[e]&&o[t]===r&&!o[e])return;let o;if("message"===n)o=function(e,t){const n=new f("message",{data:t?e:e.toString()});n[a]=this,m(r,this,n)};else if("close"===n)o=function(e,t){const n=new d("close",{code:e,reason:t.toString(),wasClean:this._closeFrameReceived&&this._closeFrameSent});n[a]=this,m(r,this,n)};else if("error"===n)o=function(e){const t=new h("error",{error:e,message:e.message});t[a]=this,m(r,this,t)};else{if("open"!==n)return;o=function(){const e=new u("open");e[a]=this,m(r,this,e)}}o[e]=!!i[e],o[t]=r,i.once?this.once(n,o):this.on(n,o)},removeEventListener(n,r){for(const i of this.listeners(n))if(i[t]===r&&!i[e]){this.removeListener(n,i);break}}};function m(e,t,n){"object"==typeof e&&e.handleEvent?e.handleEvent.call(e,n):e.call(t,n)}return Za={CloseEvent:d,ErrorEvent:h,Event:u,EventTarget:p,MessageEvent:f}}(),{format:S,parse:E}=wc(),{toBuffer:C}=Fa(),k=Symbol("kAborted"),T=[8,13],x=["CONNECTING","OPEN","CLOSING","CLOSED"],I=/^[!#$%&'*+\-.0-9A-Z^_`|a-z~]+$/;class R extends e{constructor(e,t,n){super(),this._binaryType=h[0],this._closeCode=1006,this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage=f,this._closeTimer=null,this._errorEmitted=!1,this._extensions={},this._paused=!1,this._protocol="",this._readyState=R.CONNECTING,this._receiver=null,this._sender=null,this._socket=null,null!==e?(this._bufferedAmount=0,this._isServer=!1,this._redirects=0,void 0===t?t=[]:Array.isArray(t)||("object"==typeof t&&null!==t?(n=t,t=[]):t=[t]),O(this,e,t,n)):(this._autoPong=n.autoPong,this._isServer=!0)}get binaryType(){return this._binaryType}set binaryType(e){h.includes(e)&&(this._binaryType=e,this._receiver&&(this._receiver._binaryType=e))}get bufferedAmount(){return this._socket?this._socket._writableState.length+this._sender._bufferedBytes:this._bufferedAmount}get extensions(){return Object.keys(this._extensions).join()}get isPaused(){return this._paused}get onclose(){return null}get onerror(){return null}get onopen(){return null}get onmessage(){return null}get protocol(){return this._protocol}get readyState(){return this._readyState}get url(){return this._url}setSocket(e,t,n){const r=new l({allowSynchronousEvents:n.allowSynchronousEvents,binaryType:this.binaryType,extensions:this._extensions,isServer:this._isServer,maxPayload:n.maxPayload,skipUTF8Validation:n.skipUTF8Validation}),i=new u(e,this._extensions,n.generateMask);this._receiver=r,this._sender=i,this._socket=e,r[y]=this,i[y]=this,e[y]=this,r.on("conclude",M),r.on("drain",j),r.on("error",U),r.on("message",B),r.on("ping",F),r.on("pong",q),i.onerror=V,e.setTimeout&&e.setTimeout(0),e.setNoDelay&&e.setNoDelay(),t.length>0&&e.unshift(t),e.on("close",J),e.on("data",H),e.on("end",Z),e.on("error",X),this._readyState=R.OPEN,this.emit("open")}emitClose(){if(!this._socket)return this._readyState=R.CLOSED,void this.emit("close",this._closeCode,this._closeMessage);this._extensions[c.extensionName]&&this._extensions[c.extensionName].cleanup(),this._receiver.removeAllListeners(),this._readyState=R.CLOSED,this.emit("close",this._closeCode,this._closeMessage)}close(e,t){if(this.readyState!==R.CLOSED)if(this.readyState!==R.CONNECTING)this.readyState!==R.CLOSING?(this._readyState=R.CLOSING,this._sender.close(e,t,!this._isServer,(e=>{e||(this._closeFrameSent=!0,(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end())})),G(this)):this._closeFrameSent&&(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end();else{const e="WebSocket was closed before the connection was established";D(this,this._req,e)}}pause(){this.readyState!==R.CONNECTING&&this.readyState!==R.CLOSED&&(this._paused=!0,this._socket.pause())}ping(e,t,n){if(this.readyState===R.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");"function"==typeof e?(n=e,e=t=void 0):"function"==typeof t&&(n=t,t=void 0),"number"==typeof e&&(e=e.toString()),this.readyState===R.OPEN?(void 0===t&&(t=!this._isServer),this._sender.ping(e||f,t,n)):N(this,e,n)}pong(e,t,n){if(this.readyState===R.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");"function"==typeof e?(n=e,e=t=void 0):"function"==typeof t&&(n=t,t=void 0),"number"==typeof e&&(e=e.toString()),this.readyState===R.OPEN?(void 0===t&&(t=!this._isServer),this._sender.pong(e||f,t,n)):N(this,e,n)}resume(){this.readyState!==R.CONNECTING&&this.readyState!==R.CLOSED&&(this._paused=!1,this._receiver._writableState.needDrain||this._socket.resume())}send(e,t,n){if(this.readyState===R.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if("function"==typeof t&&(n=t,t={}),"number"==typeof e&&(e=e.toString()),this.readyState!==R.OPEN)return void N(this,e,n);const r={binary:"string"!=typeof e,mask:!this._isServer,compress:!0,fin:!0,...t};this._extensions[c.extensionName]||(r.compress=!1),this._sender.send(e||f,r,n)}terminate(){if(this.readyState!==R.CLOSED)if(this.readyState!==R.CONNECTING)this._socket&&(this._readyState=R.CLOSING,this._socket.destroy());else{const e="WebSocket was closed before the connection was established";D(this,this._req,e)}}}function O(e,r,i,l){const u={allowSynchronousEvents:!0,autoPong:!0,protocolVersion:T[1],maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10,...l,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:"GET",host:void 0,path:void 0,port:void 0};if(e._autoPong=u.autoPong,!T.includes(u.protocolVersion))throw new RangeError(`Unsupported protocol version: ${u.protocolVersion} (supported versions: ${T.join(", ")})`);let d;if(r instanceof a)d=r;else try{d=new a(r)}catch(e){throw new SyntaxError(`Invalid URL: ${r}`)}"http:"===d.protocol?d.protocol="ws:":"https:"===d.protocol&&(d.protocol="wss:"),e._url=d.href;const h="wss:"===d.protocol,f="ws+unix:"===d.protocol;let m;if("ws:"===d.protocol||h||f?f&&!d.pathname?m="The URL's pathname is empty":d.hash&&(m="The URL contains a fragment identifier"):m='The URL\'s protocol must be one of "ws:", "wss:", "http:", "https", or "ws+unix:"',m){const t=new SyntaxError(m);if(0===e._redirects)throw t;return void A(e,t)}const g=h?443:80,v=o(16).toString("base64"),y=h?t.request:n.request,b=new Set;let _,w;if(u.createConnection=u.createConnection||(h?P:L),u.defaultPort=u.defaultPort||g,u.port=d.port||g,u.host=d.hostname.startsWith("[")?d.hostname.slice(1,-1):d.hostname,u.headers={...u.headers,"Sec-WebSocket-Version":u.protocolVersion,"Sec-WebSocket-Key":v,Connection:"Upgrade",Upgrade:"websocket"},u.path=d.pathname+d.search,u.timeout=u.handshakeTimeout,u.perMessageDeflate&&(_=new c(!0!==u.perMessageDeflate?u.perMessageDeflate:{},!1,u.maxPayload),u.headers["Sec-WebSocket-Extensions"]=S({[c.extensionName]:_.offer()})),i.length){for(const e of i){if("string"!=typeof e||!I.test(e)||b.has(e))throw new SyntaxError("An invalid or duplicated subprotocol was specified");b.add(e)}u.headers["Sec-WebSocket-Protocol"]=i.join(",")}if(u.origin&&(u.protocolVersion<13?u.headers["Sec-WebSocket-Origin"]=u.origin:u.headers.Origin=u.origin),(d.username||d.password)&&(u.auth=`${d.username}:${d.password}`),f){const e=u.path.split(":");u.socketPath=e[0],u.path=e[1]}if(u.followRedirects){if(0===e._redirects){e._originalIpc=f,e._originalSecure=h,e._originalHostOrSocketPath=f?u.socketPath:d.host;const t=l&&l.headers;if(l={...l,headers:{}},t)for(const[e,n]of Object.entries(t))l.headers[e.toLowerCase()]=n}else if(0===e.listenerCount("redirect")){const t=f?!!e._originalIpc&&u.socketPath===e._originalHostOrSocketPath:!e._originalIpc&&d.host===e._originalHostOrSocketPath;(!t||e._originalSecure&&!h)&&(delete u.headers.authorization,delete u.headers.cookie,t||delete u.headers.host,u.auth=void 0)}u.auth&&!l.headers.authorization&&(l.headers.authorization="Basic "+ft.from(u.auth).toString("base64")),w=e._req=y(u),e._redirects&&e.emit("redirect",e.url,w)}else w=e._req=y(u);u.timeout&&w.on("timeout",(()=>{D(e,w,"Opening handshake has timed out")})),w.on("error",(t=>{null===w||w[k]||(w=e._req=null,A(e,t))})),w.on("response",(t=>{const n=t.headers.location,o=t.statusCode;if(n&&u.followRedirects&&o>=300&&o<400){if(++e._redirects>u.maxRedirects)return void D(e,w,"Maximum redirects exceeded");let t;w.abort();try{t=new a(n,r)}catch(t){const r=new SyntaxError(`Invalid URL: ${n}`);return void A(e,r)}O(e,t,i,l)}else e.emit("unexpected-response",w,t)||D(e,w,`Unexpected server response: ${t.statusCode}`)})),w.on("upgrade",((t,n,r)=>{if(e.emit("upgrade",t),e.readyState!==R.CONNECTING)return;w=e._req=null;const i=t.headers.upgrade;if(void 0===i||"websocket"!==i.toLowerCase())return void D(e,n,"Invalid Upgrade header");const o=s("sha1").update(v+p).digest("base64");if(t.headers["sec-websocket-accept"]!==o)return void D(e,n,"Invalid Sec-WebSocket-Accept header");const a=t.headers["sec-websocket-protocol"];let l;if(void 0!==a?b.size?b.has(a)||(l="Server sent an invalid subprotocol"):l="Server sent a subprotocol but none was requested":b.size&&(l="Server sent no subprotocol"),l)return void D(e,n,l);a&&(e._protocol=a);const d=t.headers["sec-websocket-extensions"];if(void 0!==d){if(!_){return void D(e,n,"Server sent a Sec-WebSocket-Extensions header but no extension was requested")}let t;try{t=E(d)}catch(t){return void D(e,n,"Invalid Sec-WebSocket-Extensions header")}const r=Object.keys(t);if(1!==r.length||r[0]!==c.extensionName){return void D(e,n,"Server indicated an extension that was not requested")}try{_.accept(t[c.extensionName])}catch(t){return void D(e,n,"Invalid Sec-WebSocket-Extensions header")}e._extensions[c.extensionName]=_}e.setSocket(n,r,{allowSynchronousEvents:u.allowSynchronousEvents,generateMask:u.generateMask,maxPayload:u.maxPayload,skipUTF8Validation:u.skipUTF8Validation})})),u.finishRequest?u.finishRequest(w,e):w.end()}function A(e,t){e._readyState=R.CLOSING,e._errorEmitted=!0,e.emit("error",t),e.emitClose()}function L(e){return e.path=e.socketPath,r.connect(e)}function P(e){return e.path=void 0,e.servername||""===e.servername||(e.servername=r.isIP(e.host)?"":e.host),i.connect(e)}function D(e,t,n){e._readyState=R.CLOSING;const r=new Error(n);Error.captureStackTrace(r,D),t.setHeader?(t[k]=!0,t.abort(),t.socket&&!t.socket.destroyed&&t.socket.destroy(),Tn.nextTick(A,e,r)):(t.destroy(r),t.once("error",e.emit.bind(e,"error")),t.once("close",e.emitClose.bind(e)))}function N(e,t,n){if(t){const n=d(t)?t.size:C(t).length;e._socket?e._sender._bufferedBytes+=n:e._bufferedAmount+=n}if(n){const t=new Error(`WebSocket is not open: readyState ${e.readyState} (${x[e.readyState]})`);Tn.nextTick(n,t)}}function M(e,t){const n=this[y];n._closeFrameReceived=!0,n._closeMessage=t,n._closeCode=e,void 0!==n._socket[y]&&(n._socket.removeListener("data",H),Tn.nextTick(W,n._socket),1005===e?n.close():n.close(e,t))}function j(){const e=this[y];e.isPaused||e._socket.resume()}function U(e){const t=this[y];void 0!==t._socket[y]&&(t._socket.removeListener("data",H),Tn.nextTick(W,t._socket),t.close(e[v])),t._errorEmitted||(t._errorEmitted=!0,t.emit("error",e))}function z(){this[y].emitClose()}function B(e,t){this[y].emit("message",e,t)}function F(e){const t=this[y];t._autoPong&&t.pong(e,!this._isServer,b),t.emit("ping",e)}function q(e){this[y].emit("pong",e)}function W(e){e.resume()}function V(e){const t=this[y];t.readyState!==R.CLOSED&&(t.readyState===R.OPEN&&(t._readyState=R.CLOSING,G(t)),this._socket.end(),t._errorEmitted||(t._errorEmitted=!0,t.emit("error",e)))}function G(e){e._closeTimer=setTimeout(e._socket.destroy.bind(e._socket),3e4)}function J(){const e=this[y];let t;this.removeListener("close",J),this.removeListener("data",H),this.removeListener("end",Z),e._readyState=R.CLOSING,this._readableState.endEmitted||e._closeFrameReceived||e._receiver._writableState.errorEmitted||null===(t=e._socket.read())||e._receiver.write(t),e._receiver.end(),this[y]=void 0,clearTimeout(e._closeTimer),e._receiver._writableState.finished||e._receiver._writableState.errorEmitted?e.emitClose():(e._receiver.on("error",z),e._receiver.on("finish",z))}function H(e){this[y]._receiver.write(e)||this.pause()}function Z(){const e=this[y];e._readyState=R.CLOSING,e._receiver.end(),this.end()}function X(){const e=this[y];this.removeListener("error",X),this.on("error",b),e&&(e._readyState=R.CLOSING,this.destroy())}return Object.defineProperty(R,"CONNECTING",{enumerable:!0,value:x.indexOf("CONNECTING")}),Object.defineProperty(R.prototype,"CONNECTING",{enumerable:!0,value:x.indexOf("CONNECTING")}),Object.defineProperty(R,"OPEN",{enumerable:!0,value:x.indexOf("OPEN")}),Object.defineProperty(R.prototype,"OPEN",{enumerable:!0,value:x.indexOf("OPEN")}),Object.defineProperty(R,"CLOSING",{enumerable:!0,value:x.indexOf("CLOSING")}),Object.defineProperty(R.prototype,"CLOSING",{enumerable:!0,value:x.indexOf("CLOSING")}),Object.defineProperty(R,"CLOSED",{enumerable:!0,value:x.indexOf("CLOSED")}),Object.defineProperty(R.prototype,"CLOSED",{enumerable:!0,value:x.indexOf("CLOSED")}),["binaryType","bufferedAmount","extensions","isPaused","protocol","readyState","url"].forEach((e=>{Object.defineProperty(R.prototype,e,{enumerable:!0})})),["open","error","close","message"].forEach((e=>{Object.defineProperty(R.prototype,`on${e}`,{enumerable:!0,get(){for(const t of this.listeners(e))if(t[m])return t[g];return null},set(t){for(const t of this.listeners(e))if(t[m]){this.removeListener(e,t);break}"function"==typeof t&&this.addEventListener(e,t,{[m]:!0})}})})),R.prototype.addEventListener=_,R.prototype.removeEventListener=w,Ka=R}function Ec(){if(rc)return nc;rc=1;const{tokenChars:e}=yc();return nc={parse:function(t){const n=new Set;let r=-1,i=-1,o=0;for(;o<t.length;o++){const s=t.charCodeAt(o);if(-1===i&&1===e[s])-1===r&&(r=o);else if(0===o||32!==s&&9!==s){if(44!==s)throw new SyntaxError(`Unexpected character at index ${o}`);{if(-1===r)throw new SyntaxError(`Unexpected character at index ${o}`);-1===i&&(i=o);const e=t.slice(r,i);if(n.has(e))throw new SyntaxError(`The "${e}" subprotocol is duplicated`);n.add(e),r=i=-1}}else-1===i&&-1!==r&&(i=o)}if(-1===r||-1!==i)throw new SyntaxError("Unexpected end of input");const s=t.slice(r,o);if(n.has(s))throw new SyntaxError(`The "${s}" subprotocol is duplicated`);return n.add(s),n}}}function Cc(){if(oc)return ic;oc=1;const e=te(),t=io,{createHash:n}=ao,r=wc(),i=qa(),o=Ec(),s=Sc(),{GUID:a,kWebSocket:c}=Ba(),l=/^[+/0-9A-Za-z]{22}==$/;function u(e){e._state=2,e.emit("close")}function d(){this.destroy()}function h(e,n,r,i){r=r||t.STATUS_CODES[n],i={Connection:"close","Content-Type":"text/html","Content-Length":ft.byteLength(r),...i},e.once("finish",e.destroy),e.end(`HTTP/1.1 ${n} ${t.STATUS_CODES[n]}\r\n`+Object.keys(i).map((e=>`${e}: ${i[e]}`)).join("\r\n")+"\r\n\r\n"+r)}function f(e,t,n,r,i){if(e.listenerCount("wsClientError")){const r=new Error(i);Error.captureStackTrace(r,f),e.emit("wsClientError",r,n,t)}else h(n,r,i)}return ic=class extends e{constructor(e,n){if(super(),null==(e={allowSynchronousEvents:!0,autoPong:!0,maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!1,handleProtocols:null,clientTracking:!0,verifyClient:null,noServer:!1,backlog:null,server:null,host:null,path:null,port:null,WebSocket:s,...e}).port&&!e.server&&!e.noServer||null!=e.port&&(e.server||e.noServer)||e.server&&e.noServer)throw new TypeError('One and only one of the "port", "server", or "noServer" options must be specified');if(null!=e.port?(this._server=t.createServer(((e,n)=>{const r=t.STATUS_CODES[426];n.writeHead(426,{"Content-Length":r.length,"Content-Type":"text/plain"}),n.end(r)})),this._server.listen(e.port,e.host,e.backlog,n)):e.server&&(this._server=e.server),this._server){const e=this.emit.bind(this,"connection");this._removeListeners=function(e,t){for(const n of Object.keys(t))e.on(n,t[n]);return function(){for(const n of Object.keys(t))e.removeListener(n,t[n])}}(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(t,n,r)=>{this.handleUpgrade(t,n,r,e)}})}!0===e.perMessageDeflate&&(e.perMessageDeflate={}),e.clientTracking&&(this.clients=new Set,this._shouldEmitClose=!1),this.options=e,this._state=0}address(){if(this.options.noServer)throw new Error('The server is operating in "noServer" mode');return this._server?this._server.address():null}close(e){if(2===this._state)return e&&this.once("close",(()=>{e(new Error("The server is not running"))})),void Tn.nextTick(u,this);if(e&&this.once("close",e),1!==this._state)if(this._state=1,this.options.noServer||this.options.server)this._server&&(this._removeListeners(),this._removeListeners=this._server=null),this.clients&&this.clients.size?this._shouldEmitClose=!0:Tn.nextTick(u,this);else{const e=this._server;this._removeListeners(),this._removeListeners=this._server=null,e.close((()=>{u(this)}))}}shouldHandle(e){if(this.options.path){const t=e.url.indexOf("?");if((-1!==t?e.url.slice(0,t):e.url)!==this.options.path)return!1}return!0}handleUpgrade(e,t,n,s){t.on("error",d);const a=e.headers["sec-websocket-key"],c=e.headers.upgrade,u=+e.headers["sec-websocket-version"];if("GET"!==e.method){return void f(this,e,t,405,"Invalid HTTP method")}if(void 0===c||"websocket"!==c.toLowerCase()){return void f(this,e,t,400,"Invalid Upgrade header")}if(void 0===a||!l.test(a)){return void f(this,e,t,400,"Missing or invalid Sec-WebSocket-Key header")}if(8!==u&&13!==u){return void f(this,e,t,400,"Missing or invalid Sec-WebSocket-Version header")}if(!this.shouldHandle(e))return void h(t,400);const p=e.headers["sec-websocket-protocol"];let m=new Set;if(void 0!==p)try{m=o.parse(p)}catch(n){return void f(this,e,t,400,"Invalid Sec-WebSocket-Protocol header")}const g=e.headers["sec-websocket-extensions"],v={};if(this.options.perMessageDeflate&&void 0!==g){const n=new i(this.options.perMessageDeflate,!0,this.options.maxPayload);try{const e=r.parse(g);e[i.extensionName]&&(n.accept(e[i.extensionName]),v[i.extensionName]=n)}catch(n){return void f(this,e,t,400,"Invalid or unacceptable Sec-WebSocket-Extensions header")}}if(this.options.verifyClient){const r={origin:e.headers[""+(8===u?"sec-websocket-origin":"origin")],secure:!(!e.socket.authorized&&!e.socket.encrypted),req:e};if(2===this.options.verifyClient.length)return void this.options.verifyClient(r,((r,i,o,c)=>{if(!r)return h(t,i||401,o,c);this.completeUpgrade(v,a,m,e,t,n,s)}));if(!this.options.verifyClient(r))return h(t,401)}this.completeUpgrade(v,a,m,e,t,n,s)}completeUpgrade(e,t,o,s,l,f,p){if(!l.readable||!l.writable)return l.destroy();if(l[c])throw new Error("server.handleUpgrade() was called more than once with the same socket, possibly due to a misconfiguration");if(this._state>0)return h(l,503);const m=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade",`Sec-WebSocket-Accept: ${n("sha1").update(t+a).digest("base64")}`],g=new this.options.WebSocket(null,void 0,this.options);if(o.size){const e=this.options.handleProtocols?this.options.handleProtocols(o,s):o.values().next().value;e&&(m.push(`Sec-WebSocket-Protocol: ${e}`),g._protocol=e)}if(e[i.extensionName]){const t=e[i.extensionName].params,n=r.format({[i.extensionName]:[t]});m.push(`Sec-WebSocket-Extensions: ${n}`),g._extensions=e}this.emit("headers",m,s),l.write(m.concat("\r\n").join("\r\n")),l.removeListener("error",d),g.setSocket(l,f,{allowSynchronousEvents:this.options.allowSynchronousEvents,maxPayload:this.options.maxPayload,skipUTF8Validation:this.options.skipUTF8Validation}),this.clients&&(this.clients.add(g),g.on("close",(()=>{this.clients.delete(g),this._shouldEmitClose&&!this.clients.size&&Tn.nextTick(u,this)}))),p(g,s)}},ic}function kc(){if(ac)return sc;ac=1;const e=Sc();return e.createWebSocketStream=function(){if(tc)return ec;tc=1;const{Duplex:e}=co;function t(e){e.emit("close")}function n(){!this.destroyed&&this._writableState.finished&&this.destroy()}function r(e){this.removeListener("error",r),this.destroy(),0===this.listenerCount("error")&&this.emit("error",e)}return ec=function(i,o){let s=!0;const a=new e({...o,autoDestroy:!1,emitClose:!1,objectMode:!1,writableObjectMode:!1});return i.on("message",(function(e,t){const n=!t&&a._readableState.objectMode?e.toString():e;a.push(n)||i.pause()})),i.once("error",(function(e){a.destroyed||(s=!1,a.destroy(e))})),i.once("close",(function(){a.destroyed||a.push(null)})),a._destroy=function(e,n){if(i.readyState===i.CLOSED)return n(e),void Tn.nextTick(t,a);let r=!1;i.once("error",(function(e){r=!0,n(e)})),i.once("close",(function(){r||n(e),Tn.nextTick(t,a)})),s&&i.terminate()},a._final=function(e){i.readyState!==i.CONNECTING?null!==i._socket&&(i._socket._writableState.finished?(e(),a._readableState.endEmitted&&a.destroy()):(i._socket.once("finish",(function(){e()})),i.close())):i.once("open",(function(){a._final(e)}))},a._read=function(){i.isPaused&&i.resume()},a._write=function(e,t,n){i.readyState!==i.CONNECTING?i.send(e,n):i.once("open",(function(){a._write(e,t,n)}))},a.on("end",n),a.on("error",r),a},ec}(),e.Server=Cc(),e.Receiver=bc(),e.Sender=_c(),e.WebSocket=e,e.WebSocketServer=e.Server,sc=e}function Tc(){if(fc)return hc;fc=1;const e=function(){if(lc)return cc;lc=1;const e=kc(),t=P.WebSocket||e,n=te(),r="ECONNERROR";return cc=class extends n{constructor(){super(),this.listeners=Object.create(null)}connect(e){this.url=e,this._attachSocket(new t(e,["xmpp"]))}_attachSocket(e){this.socket=e;const{listeners:t}=this;t.open=()=>{this.emit("connect")},t.message=({data:e})=>this.emit("data",e),t.error=e=>{const{url:t}=this;let{error:n}=e;n||(n=new Error(`WebSocket ${r} ${t}`),n.errno=r,n.code=r),n.event=e,n.url=t,this.emit("error",n)},t.close=e=>{this._detachSocket(),this.emit("close",!e.wasClean,e)},this.socket.addEventListener("open",t.open),this.socket.addEventListener("message",t.message),this.socket.addEventListener("error",t.error),this.socket.addEventListener("close",t.close)}_detachSocket(){delete this.url;const{socket:e,listeners:t}=this;for(const n of Object.getOwnPropertyNames(t))e.removeEventListener(n,t[n]),delete t[n];delete this.socket}end(){this.socket.close()}write(n,r){t===e?this.socket.send(n,r):(this.socket.send(n),r())}},cc}(),t=Je(),n=je(),r=function(){if(dc)return uc;dc=1;const{Parser:e,Element:t,XMLError:n}=je();return uc=class extends e{onStartElement(e,n){const r=new t(e,n),{cursor:i}=this;i&&i.append(r),this.cursor=r}onEndElement(e){const{cursor:t}=this;e===t.name?t.parent?this.cursor=t.parent:(t.is("open","urn:ietf:params:xml:ns:xmpp-framing")?this.emit("start",t):t.is("close","urn:ietf:params:xml:ns:xmpp-framing")?this.emit("end",t):this.emit("element",t),this.cursor=null):this.emit("error",new n(`${t.name} must be closed.`))}}}(),i="urn:ietf:params:xml:ns:xmpp-framing";class o extends t{send(e,...t){return!e.attrs.xmlns&&super.isStanza(e)&&(e.attrs.xmlns="jabber:client"),super.send(e,...t)}async sendMany(e){for(const t of e)await this.send(t)}footerElement(){return new n.Element("close",{xmlns:i})}headerElement(){const e=super.headerElement();return e.name="open",e.attrs.xmlns=i,e}socketParameters(e){return/^wss?:\/\//.test(e)?e:void 0}}return o.prototype.Socket=e,o.prototype.NS="jabber:client",o.prototype.Parser=r,hc=o}var xc,Ic,Rc,Oc,Ac,Lc,Pc,Dc,Nc,Mc,jc=D(function(){if(mc)return pc;mc=1;const e=Tc();return pc=function({entity:t}){t.transports.push(e)}}());function Uc(){return Oc||(Oc=1,Rc=class{constructor(e,t){this.stanza=t,this.entity=e;const{name:n,attrs:r}=t,{type:i,id:o}=r;this.name=n,this.id=o||"",this.type="message"===n?i||"normal":"presence"===n?i||"available":i||"",this.from=null,this.to=null,this.local="",this.domain="",this.resource=""}}),Rc}var zc,Bc,Fc,qc,Wc=function(){if(Mc)return Nc;Mc=1;const e=(Ic||(Ic=1,xc=function(e){if(!Array.isArray(e))throw new TypeError("Middleware stack must be an array!");for(const t of e)if("function"!=typeof t)throw new TypeError("Middleware must be composed of functions!");return function(t,n){let r=-1;return function i(o){if(o<=r)return Promise.reject(new Error("next() called multiple times"));r=o;let s=e[o];if(o===e.length&&(s=n),!s)return Promise.resolve();try{return Promise.resolve(s(t,i.bind(null,o+1)))}catch(e){return Promise.reject(e)}}(0)}}),xc),t=function(){if(Lc)return Ac;Lc=1;const e=Uc(),t=pe();return Ac=class extends e{constructor(e,n){super(e,n);const{jid:r,domain:i}=e,o=n.attrs.to||r&&r.toString(),s=n.attrs.from||i;o&&(this.to=new t(o)),s&&(this.from=new t(s),this.local=this.from.local,this.domain=this.from.domain,this.resource=this.from.resource)}},Ac}(),n=function(){if(Dc)return Pc;Dc=1;const e=Uc(),t=pe();return Pc=class extends e{constructor(e,n){super(e,n);const{jid:r,domain:i}=e,o=n.attrs.from||r&&r.toString(),s=n.attrs.to||i;o&&(this.from=new t(o)),s&&(this.to=new t(s),this.local=this.to.local,this.domain=this.to.domain,this.resource=this.to.resource)}},Pc}();function r(t,n,r){return i=>{const o=new r(t,i);return e(n)(o)}}function i(e){return(t,n)=>{n().then((t=>t&&e.send(t))).catch((t=>e.emit("error",t)))}}return Nc=function({entity:e}){const o=[i(e)],s=[],a=r(e,o,t),c=r(e,s,n);return e.on("element",a),e.hookOutgoing=c,{use:e=>(o.push(e),e),filter:e=>(s.push(e),e)}}}(),Vc=D(Wc);function Gc(){return Bc?zc:(Bc=1,zc=function(){return async({stanza:e,entity:t},n)=>{if(!e.is("features","http://etherx.jabber.org/streams"))return n();!await n()&&t.jid&&t._status("online",t.jid)}})}var Jc,Hc,Zc,Xc,Yc,$c,Kc=function(){if(qc)return Fc;qc=1;const e=Gc();return Fc=function({middleware:t}){return t.use(e()),{use:function(e,n,r){return t.use(((t,i)=>{const{stanza:o}=t;if(!o.is("features","http://etherx.jabber.org/streams"))return i();const s=o.getChild(e,n);return s?r(t,i,s):i()}))}}},Fc}(),Qc=D(Kc);var el,tl,nl=function(){if($c)return Yc;$c=1;const e=Hc?Jc:(Hc=1,Jc=function(){let e;for(;!e;)e=Math.random().toString(36).slice(2,12);return e}),t=function(){if(Xc)return Zc;Xc=1;const e=Ue();return Zc=class extends e{constructor(e,t,n,r){super(e,t,n),this.type=r,this.name="StanzaError"}static fromElement(e){const t=super.fromElement(e);return t.type=e.attrs.type,t}},Zc}(),{Deferred:n}=re(),r=re().timeout,i=je();class o{constructor({entity:e,middleware:t}){this.handlers=new Map,this.entity=e,this.middleware=t}start(){this.middleware.use(this._route.bind(this))}_route({type:e,name:n,id:r,stanza:i},o){if(!function({name:e,type:t}){return"iq"===e&&("error"===t||"result"===t)}({name:n,type:e}))return o();const s=this.handlers.get(r);if(!s)return o();"error"===e?s.reject(t.fromElement(i.getChild("error"))):s.resolve(i),this.handlers.delete(r)}async request(t,i=3e4){t.attrs.id||(t.attrs.id=e());const o=new n;this.handlers.set(t.attrs.id,o);try{await this.entity.send(t),await r(o.promise,i)}catch(e){throw this.handlers.delete(t.attrs.id),e}return o.promise}_childRequest(e,t,n,...r){const{name:o,attrs:{xmlns:s}}=t;return this.request(i("iq",{type:e,to:n},t),...r).then((e=>e.getChild(o,s)))}async get(...e){return this._childRequest("get",...e)}async set(...e){return this._childRequest("set",...e)}}return Yc=function(...e){const t=new o(...e);return t.start(),t}}(),rl=D(nl);var il,ol=function(){if(tl)return el;tl=1;const e=je();function t({stanza:t}){return e("iq",{to:t.attrs.from,from:t.attrs.to,id:t.attrs.id})}function n(e,n,r){const i=t(e);return i.attrs.type="error",r&&i.append(r),i.append(n),i}function r(t,n){return e("error",{type:t},e(n,"urn:ietf:params:xml:ns:xmpp-stanzas"))}function i(i){return async function(o,s){if(!function({name:e,type:t}){return"iq"===e&&"error"!==t&&"result"!==t}(o))return s();const{stanza:a}=o,c=a.getChildElements(),[l]=c;if(!function({type:e},t,n){return("get"===e||"set"===e)&&1===t.length&&!!n}(o,c,l))return n(o,r("modify","bad-request"),l);let u;o.element=l;try{u=await s()}catch(e){i.emit("error",e),u=r("cancel","internal-server-error")}return u||(u=r("cancel","service-unavailable")),u instanceof e.Element&&u.is("error")?n(o,u,l):function(e,n){const r=t(e);return r.attrs.type="result",n&&r.append(n),r}(o,u instanceof e.Element?u:void 0)}}function o(e,t,n,r){return(i,o)=>i.type!==e|!i.element||!i.element.is(n,t)?o():r(i,o)}return el=function({middleware:e,entity:t}){return e.use(i(t)),{get(t,n,r){e.use(o("get",t,n,r))},set(t,n,r){e.use(o("set",t,n,r))}}},el}(),sl=D(ol),al={exports:{}},cl={},ll=N(Object.freeze({__proto__:null,default:{}}));function ul(){if(il)return cl;il=1;const e=ll,t=["ENOTFOUND","ENODATA"];function n(t,n={}){return n.all=!0,new Promise(((r,i)=>{e.lookup(t,n,((e,t)=>{if(e)return i(e);const n=[];for(const{family:e,address:r}of t){const t=`://${4===e?r:"["+r+"]"}:`;n.push({family:e,address:r,uri:"xmpps"+t+"5223"},{family:e,address:r,uri:"xmpp"+t+"5222"})}r(n)}))}))}function r(n,{service:r,protocol:i}){return new Promise(((o,s)=>{e.resolveSrv(`_${r}._${i}.${n}`,((e,n)=>{e&&t.includes(e.code)?o([]):e?s(e):o(n.map((e=>Object.assign(e,{service:r,protocol:i}))))}))}))}function i(e){return e.sort(((e,t)=>{const n=e.priority-t.priority;if(0!==n)return n;const r=t.weight-e.weight;return 0!==r?r:0}))}function o(e,t){const r=[];return Promise.all(e.map((async e=>{const i=await n(e.name,t);for(const t of i){const{port:n,service:i}=e,o=t.address;r.push({...t,...e,uri:`${i.split("-")[0]}://${6===t.family?"["+o+"]":o}:${n}`})}}))).then((()=>r))}return cl.lookup=n,cl.resolveSrv=r,cl.lookupSrvs=o,cl.resolve=function(e,t={}){t.srv||(t.srv=[{service:"xmpps-client",protocol:"tcp"},{service:"xmpp-client",protocol:"tcp"},{service:"xmpps-server",protocol:"tcp"},{service:"xmpp-server",protocol:"tcp"},{service:"stun",protocol:"tcp"},{service:"stun",protocol:"udp"},{service:"stuns ",protcol:"tcp"},{service:"turn",protocol:"tcp"},{service:"turn",protocol:"udp"},{service:"turns",protcol:"tcp"}]);const s={options:t};return n(e,t).then((n=>Promise.all(t.srv.map((n=>r(e,{...n,family:s}).then((e=>o(e,t)))))).then((e=>[...i(e.flat()),...n]))))},cl.sortSrv=i,cl}var dl,hl,fl={};function pl(){if(hl)return dl;hl=1;const e=Me();return dl=function(t){const n=new e;let r=null,i=null;if(n.on("start",(e=>{r=e})),n.on("element",(e=>{r.append(e)})),n.on("error",(e=>{i=e})),n.write(t),n.end(),i)throw i;return r},dl}var ml,gl,vl,yl,bl,_l={};function wl(){if(gl)return fl;gl=1;const t=P.fetch||e,n=pl(),r=function(){if(ml)return _l;function e(e){return e.startsWith("https")||e.startsWith("wss")}return ml=1,_l.compare=function(t,n){let r,i;return r=e(t.uri)&&!e(n.uri)?-1:!e(t.uri)&&e(n.uri)?1:0,0!==r?r:(i=t.method===n.method?0:"websocket"===t.method?-1:"websocket"===n.method?1:"xbosh"===t.method?-1:"xbosh"===n.method?1:"httppoll"===t.method?-1:"httppoll"===n.method?1:0,0!==i?i:0)},_l}().compare;return fl.resolve=function(e){return t(`https://${e}/.well-known/host-meta`).then((e=>e.text())).then((e=>n(e).getChildren("Link").filter((e=>["urn:xmpp:alt-connections:websocket","urn:xmpp:alt-connections:httppoll","urn:xmpp:alt-connections:xbosh"].includes(e.attrs.rel))).map((({attrs:e})=>({rel:e.rel,href:e.href,method:e.rel.split(":").pop(),uri:e.href}))).sort(r))).catch((()=>[]))},fl}function Sl(){if(vl)return al.exports;vl=1;const e=ul(),t=wl();return al.exports=function(...n){return Promise.all([e.resolve?e.resolve(...n):Promise.resolve([]),t.resolve(...n)]).then((([e,t])=>[...e,...t]))},e.resolve&&(al.exports.dns=e),al.exports.http=t,al.exports}var El,Cl,kl,Tl,xl=function(){if(bl)return yl;bl=1;const e=Sl(),{promise:t}=re();async function n(t){const n=await e(t,{srv:[{service:"xmpps-client",protocol:"tcp"},{service:"xmpp-client",protocol:"tcp"}]});return[...new Set(n.map((e=>e.uri)))]}async function r(e,n){if(0===n.length)throw new Error("Couldn't connect");const i=n.shift(),o=e._findTransport(i);if(!o)return r(e,n);e._status("connecting",i);const s=o.prototype.socketParameters(i),a=new o.prototype.Socket;try{a.connect(s),await t(a,"connect")}catch{return r(e,n)}e._attachSocket(a),a.emit("connect"),e.Transport=o,e.Socket=o.prototype.Socket,e.Parser=o.prototype.Parser}return yl=function({entity:e}){const t=e.connect;e.connect=async function(i){if(!i||/:\/\//.test(i))return t.call(this,i);const o=function(e,t){return t.filter((t=>e._findTransport(t)))}(e,await n(i));if(0===o.length)throw new Error("No compatible transport found.");try{await r(e,o)}catch(t){throw e._reset(),e._status("disconnect"),t}}},yl}(),Il=D(xl),Rl={},Ol={exports:{}},Al=Ol.exports;function Ll(){if(Cl)return Rl;Cl=1;const{encode:e,decode:t}=(El||(El=1,function(e,t){!function(n){var r=t,i=e&&e.exports==r&&e,o="object"==typeof P&&P;o.global!==o&&o.window!==o||(n=o);var s=function(e){this.message=e};(s.prototype=new Error).name="InvalidCharacterError";var a=function(e){throw new s(e)},c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",l=/[\t\n\f\r ]/g,u={encode:function(e){e=String(e),/[^\0-\xFF]/.test(e)&&a("The string to be encoded contains characters outside of the Latin1 range.");for(var t,n,r,i,o=e.length%3,s="",l=-1,u=e.length-o;++l<u;)t=e.charCodeAt(l)<<16,n=e.charCodeAt(++l)<<8,r=e.charCodeAt(++l),s+=c.charAt((i=t+n+r)>>18&63)+c.charAt(i>>12&63)+c.charAt(i>>6&63)+c.charAt(63&i);return 2==o?(t=e.charCodeAt(l)<<8,n=e.charCodeAt(++l),s+=c.charAt((i=t+n)>>10)+c.charAt(i>>4&63)+c.charAt(i<<2&63)+"="):1==o&&(i=e.charCodeAt(l),s+=c.charAt(i>>2)+c.charAt(i<<4&63)+"=="),s},decode:function(e){var t=(e=String(e).replace(l,"")).length;t%4==0&&(t=(e=e.replace(/==?$/,"")).length),(t%4==1||/[^+a-zA-Z0-9/]/.test(e))&&a("Invalid character: the string to be decoded is not correctly encoded.");for(var n,r,i=0,o="",s=-1;++s<t;)r=c.indexOf(e.charAt(s)),n=i%4?64*n+r:r,i++%4&&(o+=String.fromCharCode(255&n>>(-2*i&6)));return o},version:"1.0.0"};if(r&&!r.nodeType)if(i)i.exports=u;else for(var d in u)u.hasOwnProperty(d)&&(r[d]=u[d]);else n.base64=u}(Al)}(Ol,Ol.exports)),Ol.exports);return Rl.encode=e,Rl.decode=t,Rl}var Pl,Dl={exports:{}},Nl={exports:{}};var Ml,jl,Ul;function zl(){return Ml||(Ml=1,function(e){!function(e,t,n){(t.exports=n).Factory=n}(0,e,(Pl||(Pl=1,function(e){!function(e,t){function n(){this._mechs=[]}n.prototype.use=function(e,t){return t||(e=(t=e).prototype.name),this._mechs.push({name:e,mech:t}),this},n.prototype.create=function(e){for(var t=0,n=this._mechs.length;t<n;t++)for(var r=0,i=e.length;r<i;r++){var o=this._mechs[t];if(o.name==e[r])return new o.mech}return null},t.exports=n}(0,e)}(Nl)),Nl.exports))}(Dl)),Dl.exports}var Bl,Fl,ql=function(){if(Ul)return jl;Ul=1;const{encode:e,decode:t}=Ll(),n=function(){if(Tl)return kl;Tl=1;const e=Ue();return kl=class extends e{constructor(...e){super(...e),this.name="SASLError"}}}(),r=je(),i=zl(),o="urn:ietf:params:xml:ns:xmpp-sasl";async function s(i,s,a,c){const l=i.create([a]);if(!l)throw new Error("No compatible mechanism");const{domain:u}=s.options,d={username:null,password:null,server:u,host:u,realm:u,serviceType:"xmpp",serviceName:u,...c};return new Promise(((i,a)=>{const c=u=>{if(u.attrs.xmlns===o)if("challenge"!==u.name)"failure"===u.name?a(n.fromElement(u)):"success"===u.name&&i(),s.removeListener("nonza",c);else{l.challenge(t(u.text()));const n=l.response(d);s.send(r("response",{xmlns:o,mechanism:l.name},"string"==typeof n?e(n):""))}};s.on("nonza",c),l.clientFirst&&s.send(r("auth",{xmlns:o,mechanism:l.name},e(l.response(d))))}))}return jl=function({streamFeatures:e},t){const n=new i;return e.use("mechanisms",o,(async({stanza:e,entity:r})=>{const i=e.getChild("mechanisms",o).children.map((e=>e.text()));const a=n._mechs.map((({name:e})=>e)).filter((e=>i.includes(e)));let c=a[0];"function"==typeof t?await t((e=>s(n,r,c,e)),c):(t.username||t.password||(c="ANONYMOUS"),await s(n,r,c,t)),await r.restart()})),{use:(...e)=>n.use(...e)}},jl}(),Wl=D(ql);var Vl,Gl,Jl=function(){if(Fl)return Bl;Fl=1;const e=je(),t="urn:ietf:params:xml:ns:xmpp-bind";async function n(n,r,i){const o=await r.set(function(n){return e("bind",{xmlns:t},n&&e("resource",{},n))}(i)),s=o.getChildText("jid");return n._jid(s),s}return Bl=function({streamFeatures:e,iqCaller:r},i){e.use("bind",t,function({iqCaller:e},t){return async({entity:r},i)=>{await("function"==typeof t?t((t=>n(r,e,t))):n(r,e,t)),i()}}({iqCaller:r},i))},Bl}(),Hl=D(Jl);var Zl,Xl=function(){if(Gl)return Vl;Gl=1;const e=je(),t="urn:ietf:params:xml:ns:xmpp-session";return Vl=function({iqCaller:n,streamFeatures:r}){r.use("session",t,(async(r,i,o)=>(o.getChild("optional")||await n.set(e("session",t)),i())))},Vl}(),Yl=D(Xl),$l={exports:{}},Kl={exports:{}};var Ql,eu,tu;function nu(){return Ql||(Ql=1,function(e){!function(e,t,n){(t.exports=n).Mechanism=n}(0,e,(Zl||(Zl=1,function(e){!function(e,t){function n(){}n.prototype.name="ANONYMOUS",n.prototype.clientFirst=!0,n.prototype.response=function(e){return e.trace||""},n.prototype.challenge=function(e){},t.exports=n}(0,e)}(Kl)),Kl.exports))}($l)),$l.exports}var ru,iu=function(){if(tu)return eu;tu=1;const e=nu();return eu=function(t){t.use(e)},eu}(),ou=D(iu),su={exports:{}},au={exports:{}};var cu,lu,uu;function du(){return cu||(cu=1,function(e){!function(e,t,n){(t.exports=n).Mechanism=n}(0,e,(ru||(ru=1,function(e){!function(e,t){function n(){}n.prototype.name="PLAIN",n.prototype.clientFirst=!0,n.prototype.response=function(e){var t="";return t+=e.authzid||"",t+="\0",t+=e.username,(t+="\0")+e.password},n.prototype.challenge=function(e){return this},t.exports=n}(0,e)}(au)),au.exports))}(su)),su.exports}var hu=function(){if(uu)return lu;uu=1;const e=du();return lu=function(t){t.use(e)},lu}(),fu=D(hu);function pu(e){var t=e.resource,n=e.credentials,r=e.username,i=e.password,o=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(n[r[i]]=e[r[i]])}return n}(e,["resource","credentials","username","password"]),s=o.domain,a=o.service;!s&&a&&(o.domain=(a.split("://")[1]||a).split(":")[0].split("/")[0]);var c=new Xe.Client(o),l=$e({entity:c}),u=jc({entity:c}),d=Vc({entity:c}),h=Qc({middleware:d}),f=rl({middleware:d,entity:c}),p=sl({middleware:d,entity:c}),m=Vc({entity:c}),g=Il({entity:c}),v=Wl({streamFeatures:h},n||{username:r,password:i}),y=Hl({iqCaller:f,streamFeatures:h},t),b=Yl({iqCaller:f,streamFeatures:h}),_=Object.entries({plain:fu,anonymous:ou}).map((function(e){var t,n=e[0],r=e[1];return(t={})[n]=r(v),t}));return Object.assign(c,{entity:c,reconnect:l,websocket:u,middleware:d,streamFeatures:h,iqCaller:f,iqCallee:p,starttls:m,resolve:g,sasl:v,resourceBinding:y,sessionEstablishment:b,mechanisms:_})}var mu,gu,vu,yu=Xe.xml,bu=function(){function e(e){this.route="".concat(E.urls.chat,"/Dialog"),this.subscribeToPublic=this.subscribe,this.unsubscribeFromPublic=this.unsubscribe,this.proxy=e}return e.prototype.list=function(){return k(this,arguments,void 0,(function(e){var t;return void 0===e&&(e={}),T(this,(function(n){return t={type:I.GET,url:O.getUrl(this.route),data:e},[2,this.proxy.ajax(t)]}))}))},e.prototype.create=function(){return k(this,arguments,void 0,(function(e){var t,n;return void 0===e&&(e={type:null}),T(this,(function(r){return t=O.cloneObject(e),O.isArray(null==t?void 0:t.occupants_ids)&&(t.occupants_ids=t.occupants_ids.join(", ")),O.isArray(null==t?void 0:t.admins_ids)&&(t.admins_ids=t.admins_ids.join(", ")),n={type:I.POST,url:O.getUrl(this.route),data:t},[2,this.proxy.ajax(n)]}))}))},e.prototype.update=function(e){return k(this,arguments,void 0,(function(e,t){var n;return void 0===t&&(t={}),T(this,(function(r){return n={type:I.PUT,url:O.getUrl(this.route,e),data:t},[2,this.proxy.ajax(n)]}))}))},e.prototype.delete=function(e){return k(this,arguments,void 0,(function(e,t){var n,r;return void 0===t&&(t={}),T(this,(function(i){return n="string"==typeof e?e.split(",").map((function(e){return e.trim()})):e,r={type:I.DELETE,url:O.getUrl(this.route,n.toString()),dataType:1===n.length?R.TEXT:R.JSON,data:t},[2,this.proxy.ajax(r)]}))}))},e.prototype.addAdmins=function(e,t){return k(this,void 0,void 0,(function(){var n;return T(this,(function(r){return n={type:I.PUT,url:O.getUrl(this.route,e,"admins"),data:{push_all:{admins_ids:t}}},[2,this.proxy.ajax(n)]}))}))},e.prototype.removeAdmins=function(e,t){return k(this,void 0,void 0,(function(){var n;return T(this,(function(r){return n={type:I.PUT,url:O.getUrl(this.route,e,"admins"),data:{pull_all:{admins_ids:t}}},[2,this.proxy.ajax(n)]}))}))},e.prototype.subscribe=function(e){return k(this,void 0,void 0,(function(){var t;return T(this,(function(n){return t={type:I.POST,url:O.getUrl(this.route,e,"subscribe")},[2,this.proxy.ajax(t)]}))}))},e.prototype.unsubscribe=function(e){return k(this,void 0,void 0,(function(){var t;return T(this,(function(n){return t={type:I.DELETE,url:O.getUrl(this.route,e,"subscribe"),dataType:R.TEXT},[2,this.proxy.ajax(t)]}))}))},e.prototype.updateNotificationsSettings=function(e,t){return k(this,void 0,void 0,(function(){var n;return T(this,(function(r){return n={type:I.PUT,url:O.getUrl(this.route,e,"notifications"),data:{enabled:t?1:0}},[2,this.proxy.ajax(n)]}))}))},e.prototype.getNotificationsSettings=function(e){return k(this,void 0,void 0,(function(){var t;return T(this,(function(n){return t={type:I.GET,url:O.getUrl(this.route,e,"notifications")},[2,this.proxy.ajax(t)]}))}))},e.prototype.getPublicOccupants=function(e){return k(this,arguments,void 0,(function(e,t){var n;return void 0===t&&(t={}),T(this,(function(r){return n={type:I.GET,url:O.getUrl(this.route,e,"occupants"),data:t},[2,this.proxy.ajax(n)]}))}))},e.prototype.clearHistory=function(e){return k(this,void 0,void 0,(function(){var t;return T(this,(function(n){return t={type:I.DELETE,url:O.getUrl(this.route,"clearHistory",e),dataType:R.TEXT},[2,this.proxy.ajax(t)]}))}))},e}(),_u=function(){function e(e){this.route="".concat(E.urls.chat,"/Message"),this.proxy=e}return e.prototype.list=function(){return k(this,arguments,void 0,(function(e){var t;return void 0===e&&(e={}),T(this,(function(n){return t={url:O.getUrl(this.route),data:e},[2,this.proxy.ajax(t)]}))}))},e.prototype.create=function(){return k(this,arguments,void 0,(function(e){var t;return void 0===e&&(e={}),T(this,(function(n){return t={url:O.getUrl(this.route),type:I.POST,data:e},[2,this.proxy.ajax(t)]}))}))},e.prototype.update=function(e){return k(this,arguments,void 0,(function(e,t){var n;return void 0===t&&(t={}),T(this,(function(r){return n={type:I.PUT,dataType:R.TEXT,url:O.getUrl(this.route,e),data:t},[2,this.proxy.ajax(n)]}))}))},e.prototype.delete=function(e,t){return k(this,void 0,void 0,(function(){var n;return T(this,(function(r){return n={url:O.getUrl(this.route,e),type:I.DELETE,dataType:R.TEXT,data:t},[2,this.proxy.ajax(n)]}))}))},e.prototype.createSystem=function(e){return k(this,void 0,void 0,(function(){var t;return T(this,(function(n){return t={type:I.POST,url:O.getUrl(this.route,"system"),data:e},[2,this.proxy.ajax(t)]}))}))},e.prototype.unreadCount=function(){return k(this,arguments,void 0,(function(e){var t,n;return void 0===e&&(e={}),T(this,(function(r){return(t=O.cloneObject(e))&&t.chat_dialog_ids&&O.isArray(t.chat_dialog_ids)&&(t.chat_dialog_ids=t.chat_dialog_ids.join(", ")),n={url:O.getUrl(this.route,"unread"),data:t},[2,this.proxy.ajax(n)]}))}))},e.prototype.listReactions=function(){return k(this,arguments,void 0,(function(e){var t;return void 0===e&&(e="_"),T(this,(function(n){return t={type:I.GET,dataType:R.JSON,url:O.getUrl(this.route,e,"reactions")},[2,this.proxy.ajax(t)]}))}))},e.prototype.addReaction=function(e,t){return k(this,void 0,void 0,(function(){return T(this,(function(n){return[2,this.updateReaction(e,t)]}))}))},e.prototype.removeReaction=function(e,t){return k(this,void 0,void 0,(function(){return T(this,(function(n){return[2,this.updateReaction(e,void 0,t)]}))}))},e.prototype.updateReaction=function(e,t,n){return k(this,void 0,void 0,(function(){return T(this,(function(r){return[2,this.putReaction(e,{add:t,remove:n})]}))}))},e.prototype.putReaction=function(e,t){return k(this,void 0,void 0,(function(){var n;return T(this,(function(r){return n={type:I.PUT,dataType:R.TEXT,url:O.getUrl(this.route,e,"reactions"),data:t},[2,this.proxy.ajax(n)]}))}))},e}(),wu=function(){function e(){}return e.buildUserJid=function(e){void 0===e&&(e={});var t=e.userId,n=e.resource,r=e.jid,i=E.creds.appId,o=E.endpoints.chat;return t?"".concat(t,"-").concat(i,"@").concat(o).concat(n?"/".concat(n):""):r},e.buildUserJidLocalPart=function(e){return"".concat(e,"-").concat(E.creds.appId)},e.createMessageStanza=function(e){return yu("message",e)},e.createIqStanza=function(e){return yu("iq",e)},e.createPresenceStanza=function(e){return yu("presence",e)},e.createNonza=function(e,t){return yu(e,t)},e.getAttr=function(e,t){return(null==e?void 0:e.getAttr(t))||(null==e?void 0:e.attrs[t])||null},e.getElement=function(e,t){return null==e?void 0:e.getChild(t)},e.getName=function(e){return(null==e?void 0:e.getName())||null},e.getText=function(e){return(null==e?void 0:e.getText())||null},e.getChildElements=function(e){return(null==e?void 0:e.getChildElements())||[]},e.isErrorStanza=function(e){return!!(null==e?void 0:e.getChild("error"))},e.getAllElements=function(e,t){return(null==e?void 0:e.getChildren(t))||[]},e.getElementText=function(e,t){return(null==e?void 0:e.getChildText(t))||null},e.getElementTreePath=function(t,n){return n.reduce((function(t,n){return t?e.getElement(t,n):t}),t)},e.assignObjectToXml=function(t,n,r){return t=t.c(r),Object.keys(n).forEach((function(r){"object"==typeof n[r]?e.assignObjectToXml(t,n[r],r):t=t.c(r).t(n[r]).up()})),t=t.up()},e.assignExtraParamsToXml=function(t,n){var r=e.getElement(t,"extraParams");return Object.keys(n).forEach((function(t){"attachments"===t?n[t].forEach((function(e){r.c("attachment",e).up()})):"object"==typeof n[t]?e.assignObjectToXml(r,n[t],t):r.c(t).t(n[t]).up()})),t.up(),t},e.assignXmlToObject=function(t,n){var r,i=t.children,o=t.name,s=((r={})[o]={},r);return i.forEach((function(t){"string"==typeof t?s[o]=t:t.children.length>0?e.assignXmlToObject(t,s[o]):s[o][t.name]=e.getText(t)})),Object.assign(n,s)},e.parseExtraParams=function(t){if(!t)return null;var n={attachments:[]},r=null;return t.children.forEach((function(i){if("string"!=typeof i){if("attachment"===i.name){var o={};Object.keys(i.attrs).forEach((function(e){o[e]="size"===e?parseInt(i.attrs.size):i.attrs[e]})),n.attachments.push(o)}else"dialog_id"===i.name&&(r=e.getElementText(t,"dialog_id"),n.dialog_id=r);i.children.length&&e.assignXmlToObject(i,n)}})),0===n.attachments.length&&delete n.attachments,n.moduleIdentifier&&delete n.moduleIdentifier,{extension:n,dialogId:r}},e.buildErrorFromXMPPErrorStanza=function(t){var n=e.getElement(t,"error");return{code:parseInt(e.getAttr(n,"code")),info:e.getElementText(n,"text")}},e.getUniqueId=function(e){var t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}));return"string"==typeof e||"number"==typeof e?"".concat(t,":").concat(e):t},e.parseReactions=function(t){return e.getChildElements(t).map((function(t){return{add:"true"===e.getAttr(t,"add"),remove:"true"===e.getAttr(t,"remove"),reaction:e.getAttr(t,"type")}})).reduce((function(e,t){var n=t.add,r=t.remove,i=t.reaction;return n?e.add=i:r&&(e.remove=i),e}),{})},e}(),Su=function(){function e(){this.getUniqueId=wu.getUniqueId,this.getBsonObjectId=O.getBsonObjectId,this.xmppJID=""}return Object.defineProperty(e.prototype,"userCurrentJid",{get:function(){return this.xmppJID},set:function(e){this.xmppJID=e||""},enumerable:!1,configurable:!0}),e.prototype.isNumeric=function(e){return/^-?\d+$/.test(e)||/^\d+\.\d+$/.test(e)},e.prototype.jidOrUserId=function(e){return"string"==typeof e?this.isNumeric(e)?this.getUserJid(e):e.includes("@")?e:this.getRoomJidFromDialogId(e):this.getUserJid(e)},e.prototype.typeChat=function(e){switch(typeof e){case"string":return this.isNumeric(e)?"chat":e.includes("@")?e.includes("muc")?"groupchat":"chat":"groupchat";case"number":return"chat";default:throw new Error("Unsupported chat type")}},e.prototype.getUserJid=function(e){return"".concat(e,"-").concat(E.creds.appId,"@").concat(E.endpoints.chat)},e.prototype.getUserNickWithMucDomain=function(e){return"".concat(E.endpoints.muc,"/").concat(e)},e.prototype.getUserIdFromJID=function(e){return void 0===e&&(e=this.userCurrentJid),(null==e?void 0:e.includes("@"))?parseInt(e.split("@")[0].split("-")[0]):null},e.prototype.getDialogIdFromJID=function(e){return(null==e?void 0:e.includes("@"))?e.split("@")[0].split("_")[1]:null},e.prototype.getRoomJidFromDialogId=function(e){return"".concat(E.creds.appId,"_").concat(e,"@").concat(E.endpoints.muc)},e.prototype.getRoomJid=function(e){return"".concat(e,"/").concat(this.getUserIdFromJID(this.userCurrentJid))},e.prototype.getIdFromResource=function(e){var t=e.split("/");return t.length>1?parseInt(t.slice(1).join("/")):null},e.prototype.getRoomJidFromRoomFullJid=function(e){var t=e.split("/");return t.length>1?t[0]:null},e.prototype.getUserIdFromRoomJid=function(e){var t=e.split("/");return t.length>1?parseInt(t[t.length-1]):null},e.prototype.getDialogJid=function(e){return e.indexOf("@")>0?e:this.getRoomJidFromDialogId(e)},e}(),Eu=function(){function e(){var e=this;this.xmlns="urn:xmpp:sm:3",this.enabled=!1,this.clientProcessedStanzasCounter=0,this.clientSentStanzasCounter=0,this.lastAck=0,this.unackedQueue=[],this.incomingStanzaHandler=function(t){if("enabled"!==t.name)if(wu.getAttr(t,"xmlns")!==e.xmlns&&++e.clientProcessedStanzasCounter,"r"!==t.name){if("a"===t.name){var n=parseInt(wu.getAttr(t,"h")),r=n-e.lastAck;O.DLog("[Chat][SM][checkCounterOnIncomeStanza]",r,n,e.lastAck);for(var i=0;i<r&&e.unackedQueue.length>0;i++)e.sentMessageCallback(null,e.unackedQueue.shift().message);e.lastAck=n}}else{var o={xmlns:e.xmlns,h:e.clientProcessedStanzasCounter},s=wu.createNonza("a",o);e.originalSend.call(e.xmppClient,s)}else e.enabled=!0}}return e.prototype.enable=function(e){this.enabled||(this.xmppClient=e,this.originalSend=this.xmppClient.send,this.xmppClient.send=this.send.bind(this)),this.clientProcessedStanzasCounter=0,this.clientSentStanzasCounter=0,this.lastAck=0,this.removeElementHandler(),this.addElementHandler();var t=wu.createNonza("enable",{xmlns:this.xmlns});this.xmppClient.send(t)},e.prototype.removeElementHandler=function(){this.xmppClient.removeListener("element",this.incomingStanzaHandler)},e.prototype.addElementHandler=function(){this.xmppClient.on("element",this.incomingStanzaHandler)},e.prototype.send=function(e,t){var n=wu.getAttr(e,"type"),r=wu.getElementText(e,"body"),i=wu.getAllElements(e,"attachment"),o="message"===e.name,s="chat"===n||"groupchat"===n,a=r||i.length;if(this.originalSend.call(this.xmppClient,e),this.enabled&&o&&s&&a){this.unackedQueue.push({message:t,expect:this.clientSentStanzasCounter});var c=wu.createNonza("r",{xmlns:this.xmlns});this.originalSend.call(this.xmppClient,c)}++this.clientSentStanzasCounter},e}(),Cu=function(){function e(e){this.xmlns="jabber:iq:roster",this.contacts={},this.helpers=e.helpers,this.xmppClient=e.xmppClient,this.stanzasCallbacks=e.stanzasCallbacks}return e.prototype.get=function(){return k(this,void 0,void 0,(function(){var e=this;return T(this,(function(t){return[2,new Promise((function(t,n){var r={},i=wu.getUniqueId("getRoster"),o=wu.createIqStanza({type:"get",from:e.helpers.userCurrentJid,id:i});o.c("query",{xmlns:e.xmlns}),e.stanzasCallbacks[i]=function(n){for(var i=wu.getAllElements(n,"query"),o=0,s=i.length;o<s;o++){var a=e.helpers.getUserIdFromJID(wu.getAttr(i[o],"jid")),c=wu.getAttr(i[o],"ask"),l=wu.getAttr(i[o],"subscription"),u=wu.getAttr(i[o],"name"),d="".concat(a,"-").concat(E.creds.appId)!==u;r[a]={subscription:l,ask:c||null,name:d?u:null}}t(r)},e.xmppClient.send(o)}))]}))}))},e.prototype.add=function(e){return k(this,void 0,void 0,(function(){var t=this;return T(this,(function(n){return[2,new Promise((function(n,r){var i="object"==typeof e?e.userId:e,o="object"==typeof e?e.name:null,s=t.helpers.jidOrUserId(i),a=wu.getUniqueId("addContactInRoster"),c=wu.createIqStanza({type:"set",from:t.helpers.userCurrentJid,id:a});c.c("query",{xmlns:t.xmlns}).c("item",{jid:s,name:o}),t.contacts[i]={subscription:"none",ask:"subscribe",name:o},t.stanzasCallbacks[a]=function(){t.sendSubscriptionPresence({jid:s,type:"subscribe"}),n()},t.xmppClient.send(c)}))]}))}))},e.prototype.confirm=function(e){return k(this,void 0,void 0,(function(){var t,n;return T(this,(function(r){switch(r.label){case 0:return t="object"==typeof e?e.userId:e,n=this.helpers.jidOrUserId(t),this.sendSubscriptionPresence({jid:n,type:"subscribed"}),E.chat.contactList.subscriptionMode.mutual?[4,this.add(e)]:[3,2];case 1:r.sent(),r.label=2;case 2:return[2]}}))}))},e.prototype.reject=function(e){return k(this,void 0,void 0,(function(){var t=this;return T(this,(function(n){return[2,new Promise((function(n,r){var i=t.helpers.jidOrUserId(e);t.contacts[e]={subscription:"none",ask:null},t.sendSubscriptionPresence({jid:i,type:"unsubscribed"}),n()}))]}))}))},e.prototype.updateName=function(e){return k(this,void 0,void 0,(function(){var t=this;return T(this,(function(n){return[2,new Promise((function(n,r){var i=e.userId,o=e.name,s=void 0===o?null:o,a=t.helpers.jidOrUserId(i),c=wu.getUniqueId("updateContactInRoster");if(O.isObject(t.contacts[i])){t.contacts[i].name=s;var l=wu.createIqStanza({type:"set",from:t.helpers.userCurrentJid,id:c});l.c("query",{xmlns:t.xmlns}).c("item",{jid:a,name:s}),t.stanzasCallbacks[c]=function(e){"result"===wu.getAttr(e,"type")?n():r(e)},t.xmppClient.send(l)}else r("No contact exists with provided user id")}))]}))}))},e.prototype.remove=function(e){return k(this,void 0,void 0,(function(){var t=this;return T(this,(function(n){return[2,new Promise((function(n,r){var i=t.helpers.jidOrUserId(e),o=wu.getUniqueId("removeContactInRoster"),s=wu.createIqStanza({type:"set",from:t.helpers.userCurrentJid,id:o});s.c("query",{xmlns:t.xmlns}).c("item",{jid:i,subscription:"remove"}),t.stanzasCallbacks[o]=function(){delete t.contacts[e],n()},t.xmppClient.send(s)}))]}))}))},e.prototype.sendSubscriptionPresence=function(e){var t={to:e.jid,type:e.type},n=wu.createPresenceStanza(t);this.xmppClient.send(n)},e}(),ku=function(){function e(e){this.xmlns="jabber:iq:privacy",this.helpers=e.helpers,this.xmppClient=e.xmppClient,this.stanzasCallbacks=e.stanzasCallbacks}return e.prototype.create=function(e){return k(this,void 0,void 0,(function(){var t=this;return T(this,(function(n){return[2,new Promise((function(n,r){var i=e.items.reduce((function(e,t){var n=t.user_id,r=t.action,i=t.mutualBlock;return e[n]={action:r,mutualBlock:i},e}),{}),o=Object.keys(i),s={type:"set",from:t.helpers.userCurrentJid,id:wu.getUniqueId("edit")},a=wu.createIqStanza(s);a.c("query",{xmlns:t.xmlns}).c("list",{name:e.name});for(var c=0,l=0,u=o.length;c<u;c++,l+=2){var d=o[c],h=i[d],f=h.action,p=h.mutualBlock&&"deny"===f,m=t.helpers.jidOrUserId(parseInt(d,10)),g=t.helpers.getUserNickWithMucDomain(d);t.assignPrivacyItem(a,{order:l+1,value:m,action:f,isMutual:p}),t.assignPrivacyItem(a,{order:l+2,value:g,action:f,isMutual:p})}t.stanzasCallbacks[s.id]=function(e){wu.isErrorStanza(e)?r(wu.buildErrorFromXMPPErrorStanza(e)):n()},t.xmppClient.send(a)}))]}))}))},e.prototype.getList=function(e){return k(this,void 0,void 0,(function(){var t=this;return T(this,(function(n){return[2,new Promise((function(n,r){var i=wu.getUniqueId("getlist"),o=wu.createIqStanza({type:"get",from:t.helpers.userCurrentJid,id:i});o.c("query",{xmlns:t.xmlns}).c("list",{name:e}),t.stanzasCallbacks[i]=function(e){var r=wu.getElement(e,"query"),o=wu.getElement(r,"list"),s={name:wu.getAttr(o,"name"),items:wu.getChildElements(o).map((function(e,n){if(n%2==0){var r=e.attrs,i=r.action,o=r.value;return{user_id:t.helpers.getUserIdFromJID(o),action:i}}return null})).filter((function(e){return null!==e}))};n(s),delete t.stanzasCallbacks[i]},t.xmppClient.send(o)}))]}))}))},e.prototype.update=function(e){return k(this,void 0,void 0,(function(){var t,n;return T(this,(function(r){switch(r.label){case 0:return r.trys.push([0,3,,4]),[4,this.getList(e.name)];case 1:return t=r.sent(),n={items:O.mergeArrays(t.items,e.items),name:e.name},[4,this.create(n)];case 2:return r.sent(),[3,4];case 3:throw r.sent();case 4:return[2]}}))}))},e.prototype.getNames=function(){return k(this,void 0,void 0,(function(){var e=this;return T(this,(function(t){return[2,new Promise((function(t,n){var r=wu.getUniqueId("getNames"),i=wu.createIqStanza({type:"get",from:e.helpers.userCurrentJid,id:r});i.c("query",{xmlns:e.xmlns}),e.stanzasCallbacks[r]=function(e){if(wu.isErrorStanza(e))n(wu.buildErrorFromXMPPErrorStanza(e));else{var r=wu.getElement(e,"query"),i=wu.getElement(r,"default"),o=wu.getElement(r,"active"),s=wu.getAttr(i,"name"),a=wu.getAttr(o,"name"),c=wu.getChildElements(r).map((function(e){return wu.getAttr(e,"name")}));t({default:s,active:a,names:c})}},e.xmppClient.send(i)}))]}))}))},e.prototype.delete=function(e){return k(this,void 0,void 0,(function(){var t=this;return T(this,(function(n){return[2,new Promise((function(n,r){var i=wu.getUniqueId("remove"),o=wu.createIqStanza({type:"set",from:t.helpers.userCurrentJid,id:i});o.c("query",{xmlns:t.xmlns}).c("list",{name:e||""}),t.stanzasCallbacks[i]=function(e){wu.isErrorStanza(e)?r(wu.buildErrorFromXMPPErrorStanza(e)):n()},t.xmppClient.send(o)}))]}))}))},e.prototype.setAsDefault=function(e){return k(this,void 0,void 0,(function(){var t=this;return T(this,(function(n){return[2,new Promise((function(n,r){var i=wu.getUniqueId("default"),o=wu.createIqStanza({type:"set",from:t.helpers.userCurrentJid,id:i});o.c("query",{xmlns:t.xmlns}).c("default",e&&e.length>0?{name:e}:{}),t.stanzasCallbacks[i]=function(e){wu.isErrorStanza(e)?r(wu.buildErrorFromXMPPErrorStanza(e)):n()},t.xmppClient.send(o)}))]}))}))},e.prototype.assignPrivacyItem=function(e,t){var n=t.value,r=t.action,i=t.order,o=t.isMutual,s=wu.getElement(e,"query"),a=wu.getElement(s,"list").c("item",{type:"jid",value:n,action:r,order:i});o?(a.up(),i%2==0&&e.up().up()):a.c("message",{}).up().c("presence-in",{}).up().c("presence-out",{}).up().c("iq",{}).up().up()},e}(),Tu=function(){function e(e){this.xmlns="http://jabber.org/protocol/muc",this.helpers=e.helpers,this.xmppClient=e.xmppClient,this.stanzasCallbacks=e.stanzasCallbacks}return e.prototype.join=function(e){return k(this,void 0,void 0,(function(){var t=this;return T(this,(function(n){return[2,new Promise((function(n,r){var i=wu.getUniqueId("join"),o=t.helpers.getDialogJid(e),s=wu.createPresenceStanza({id:i,from:t.helpers.userCurrentJid,to:t.helpers.getRoomJid(o)});s.c("x",{xmlns:t.xmlns}).c("history",{maxstanzas:0}),t.stanzasCallbacks[i]=function(e){var s=wu.getElement(e,"x"),a=wu.getElement(s,"status"),c=wu.getAttr(a,"code");if(a&&"110"==c)t.joinedRooms[o]=!0,n();else{var l=wu.getAttr(s,"xmlns")===t.xmlns&&i.endsWith(":join"),u="error"===wu.getAttr(e,"type");if(l&&u){var d=wu.getElement(e,"error"),h={code:wu.getAttr(d,"code"),message:wu.getElementText(d,"text")||"Unknown issue"};r(h)}}},t.xmppClient.send(s)}))]}))}))},e.prototype.leave=function(e){return k(this,void 0,void 0,(function(){var t=this;return T(this,(function(n){return[2,new Promise((function(n,r){var i=t.helpers.getDialogJid(e),o=wu.createPresenceStanza({type:"unavailable",from:t.helpers.userCurrentJid,to:t.helpers.getRoomJid(i)});delete t.joinedRooms[i],t.stanzasCallbacks["muc:leave"]=function(e){n()},t.xmppClient.send(o)}))]}))}))},e.prototype.listOnlineUsers=function(e){return k(this,void 0,void 0,(function(){var t=this;return T(this,(function(n){return[2,new Promise((function(n,r){var i=wu.getUniqueId("muc_disco_items"),o=wu.createIqStanza({type:"get",to:t.helpers.getDialogJid(e),from:t.helpers.userCurrentJid,id:i});o.c("query",{xmlns:"http://jabber.org/protocol/disco#items"}),t.stanzasCallbacks[i]=function(e){var r=wu.getAttr(e,"id");if(t.stanzasCallbacks[r]){var i=wu.getAttr(e,"query"),o=wu.getChildElements(i).map((function(e){var n=wu.getAttr(e,"jid");return t.helpers.getUserIdFromRoomJid(n)}));n(o)}},t.xmppClient.send(o)}))]}))}))},e}();!function(e){e.CHAT="chat",e.GROUPCHAT="groupchat"}(mu||(mu={})),function(e){e.STATUS="status",e.ERROR="error",e.DISCONNECTED="disconnected",e.RECONNECTED="reconnected",e.MESSAGE="message",e.SYSTEM_MESSAGE="system-message",e.ERROR_MESSAGE="error-message",e.TYPING_MESSAGE="typing-message",e.UPDATE_MESSAGE="update-message",e.DELETE_MESSAGE="delete-message",e.REACTIONS_MESSAGE="reactions-message",e.DELIVERED_MESSAGE="delivered-message",e.READ_MESSAGE="read-message",e.SENT_MESSAGE="sent-message",e.USER_LAST_ACTIVITY="user-last-activity",e.ROSTER_SUBSCRIBE="roster-subscribe",e.ROSTER_CONFIRM="roster-confirm",e.ROSTER_REJECT="roster-reject",e.ROSTER_LIST="roster-list",e.JOIN="join",e.LEAVE="leave",e.KICK="kick"}(gu||(gu={})),function(e){e.ALLOW="allow",e.DENY="deny"}(vu||(vu={}));var xu,Iu,Ru=function(){function e(e){var t=this;this.isConnected=!1,this.isConnecting=!1,this.isLogout=!1,this.isReconnect=!1,this.stanzasCallbacks={},this.xmppClientListeners=new Map,this.connectPromise=null,this.earlyIncomingMessagesQueue=[],this.pingTimer=null,this.proxy=e,this.dialog=new bu(e),this.message=new _u(e),this.helpers=new Su,this.xmppClient=pu({service:E.chatProtocol.websocket,credentials:function(e,n){return e({username:t.xmppClient.options.username||"",password:t.xmppClient.options.password||""})}}),E.chat.reconnect.enable&&(this.xmppClient.reconnect.delay=1e3*E.chat.reconnect.timeInterval);var n={xmppClient:this.xmppClient,helpers:this.helpers,stanzasCallbacks:this.stanzasCallbacks};this.contactlist=new Cu(n),this.privacylist=new ku(n),this.muc=new Tu(n),this.isStreamManagementSupported&&(this.streamManagement=new Eu)}return Object.defineProperty(e.prototype,"connectionStatus",{get:function(){return this.xmppClient.status},enumerable:!1,configurable:!0}),e.prototype.connect=function(e){return k(this,void 0,void 0,(function(){var t=this;return T(this,(function(n){return this.connectPromise=new Promise((function(n,r){return O.DLog("[Chat]","Connect with parameter:",e),t.isConnecting?(O.DLog("[Chat]","Warning! Already in CONNECTING state"),void n(!1)):t.isConnected?(O.DLog("[Chat]","Warning! Chat is already connected!"),void n(!1)):(t.isConnecting=!0,t.isLogout=!1,t.removeAllXMPPClientListeners(),t.addXMPPClientListener("connect",(function(){O.DLog("[Chat]",t.isReconnect?"RECONNECTING":"CONNECTING")})),t.addXMPPClientListener("online",(function(){O.DLog("[Chat]","ONLINE"),t.startPingTimer(),t.postConnectActions(),n(!0),t.connectPromise=null})),t.addXMPPClientListener("offline",(function(){O.DLog("[Chat]","OFFLINE")})),t.addXMPPClientListener("disconnect",(function(){O.DLog("[Chat]","DISCONNECTED"),O.safeCallbackCall(t.onDisconnectedListener)(),E.chat.reconnect.enable?(t.isConnected=!1,t.isConnecting=!1):t.disconnect(),t.stopPingTimer()})),t.addXMPPClientListener("status",(function(e,n){O.DLog("[Chat]","status - ".concat(e),"object"==typeof n?JSON.stringify(n):""),O.safeCallbackCall(t.onChatStatusListener)(e)})),t.addXMPPClientListener("stanza",(function(e){if(e.is("message")&&!t.isConnected)return t.earlyIncomingMessagesQueue.push(e),void O.DLog("[Chat]","on 'stanza': enqueue incoming stanza (isConnected=false)");e.is("presence")?t.onPresence(e):e.is("iq")?t.onIQ(e):e.is("message")&&("headline"===e.attrs.type?t.onSystemMessage(e):"error"===e.attrs.type?t.onMessageError(e):t.onMessage(e))})),t.addXMPPClientListener("error",(function(e){O.DLog("[Chat]","ERROR:",e,{isReconnect:t.isReconnect,connectPromise:!!t.connectPromise}),t.connectPromise?t.isReconnect||("SASLError"==e.name&&(e=e.condition),r(e),t.connectPromise=null):O.safeCallbackCall(t.onConnectionErrorListener)()})),t.addXMPPClientListener("output",(function(e){O.callTrafficUsageCallback("xmppDataWrite",{body:e}),O.DLog("[Chat]","SENT:",e)})),t.addXMPPClientListener("input",(function(e){O.callTrafficUsageCallback("xmppDataRead",{body:e}),O.DLog("[Chat]","RECV:",e)})),t.xmppClient.options.username=wu.buildUserJidLocalPart(e.userId),t.xmppClient.options.password=e.password,void t.xmppClient.start().catch((function(e){console.error("[Chat] xmppClient.start error",e),t.connectPromise?(r(e),t.connectPromise=null):O.safeCallbackCall(t.onConnectionErrorListener)()})))})),[2,this.connectPromise]}))}))},e.prototype.getContacts=function(){return k(this,void 0,void 0,(function(){var e;return T(this,(function(t){switch(t.label){case 0:console.warn("[Deprecated][Chat][ContactList][[XMPP][Roster]]","ConnectyCube.chat.getContacts() and the ConnectyCube.chat.contactlist class will be removed in the next major release."),t.label=1;case 1:return t.trys.push([1,3,,4]),[4,this.contactlist.get()];case 2:return e=t.sent(),this.contactlist.contacts=e,[2,e];case 3:throw t.sent();case 4:return[2]}}))}))},e.prototype.ping=function(){return k(this,void 0,void 0,(function(){var e=this;return T(this,(function(t){return[2,new Promise((function(t,n){var r=wu.getUniqueId("ping"),i=wu.createIqStanza({id:r,type:"get",to:E.endpoints.chat});i.c("ping",{xmlns:"urn:xmpp:ping"}),e.stanzasCallbacks[r]=function(e){var r=wu.getElement(e,"error");r?n(wu.buildErrorFromXMPPErrorStanza(r)):t()},e.xmppClient.send(i)}))]}))}))},e.prototype.pingWithTimeout=function(){return k(this,arguments,void 0,(function(e){return void 0===e&&(e=5e3),T(this,(function(t){return[2,Promise.race([this.ping(),new Promise((function(t,n){return setTimeout((function(){return n(new Error("Chat ping() timed out"))}),e)}))])]}))}))},e.prototype.startPingTimer=function(){var e=this;if(this.stopPingTimer(),E.chat.ping.enable){var t=E.chat.ping.timeInterval<30?30:E.chat.ping.timeInterval;this.pingTimer=setInterval((function(){e.ping()}),1e3*t)}},e.prototype.stopPingTimer=function(){this.pingTimer&&(clearInterval(this.pingTimer),this.pingTimer=null)},e.prototype.send=function(e,t){var n,r;void 0===t&&(t={});var i=null!==(n=t.id)&&void 0!==n?n:O.getBsonObjectId(),o=wu.createMessageStanza({from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e),type:null!==(r=t.type)&&void 0!==r?r:this.helpers.typeChat(e),id:i});return t.id||(t.id=i),t.body&&o.c("body").t(t.body).up(),t.markable&&o.c("markable",{xmlns:"urn:xmpp:chat-markers:0"}).up(),t.extension&&(o.c("extraParams",{xmlns:"jabber:client"}),wu.assignExtraParamsToXml(o,t.extension)),this.isStreamManagementSupported?this.xmppClient.send(o,t):this.xmppClient.send(o),i},e.prototype.sendSystemMessage=function(e,t){var n,r=null!==(n=t.id)&&void 0!==n?n:O.getBsonObjectId(),i=wu.createMessageStanza({type:"headline",id:r,to:this.helpers.jidOrUserId(e)});return t.body&&i.c("body").t(t.body).up(),t.extension&&(i.c("extraParams",{xmlns:"jabber:client"}).c("moduleIdentifier").t("SystemNotifications").up(),wu.assignExtraParamsToXml(i,t.extension)),this.xmppClient.send(i),r},e.prototype.sendIsTypingStatus=function(e){var t=wu.createMessageStanza({from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e),type:this.helpers.typeChat(e)});t.c("composing",{xmlns:"http://jabber.org/protocol/chatstates"}),this.xmppClient.send(t)},e.prototype.sendIsStopTypingStatus=function(e){var t=wu.createMessageStanza({from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e),type:this.helpers.typeChat(e)});t.c("paused",{xmlns:"http://jabber.org/protocol/chatstates"}),this.xmppClient.send(t)},e.prototype.sendDeliveredStatus=function(e){var t=wu.createMessageStanza({type:"chat",from:this.helpers.userCurrentJid,id:O.getBsonObjectId(),to:this.helpers.jidOrUserId(e.userId)});t.c("received",{xmlns:"urn:xmpp:chat-markers:0",id:e.messageId}).up(),t.c("extraParams",{xmlns:"jabber:client"}).c("dialog_id").t(e.dialogId),this.xmppClient.send(t)},e.prototype.sendReadStatus=function(e){var t=wu.createMessageStanza({type:"chat",from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e.userId),id:O.getBsonObjectId()});t.c("displayed",{xmlns:"urn:xmpp:chat-markers:0",id:e.messageId}).up(),t.c("extraParams",{xmlns:"jabber:client"}).c("dialog_id").t(e.dialogId),this.xmppClient.send(t)},e.prototype.editMessage=function(e){var t=wu.createMessageStanza({from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e.to),type:this.helpers.typeChat(e.to),id:O.getBsonObjectId()});t.c("body").t(e.body).up(),t.c("replace",{xmlns:"urn:xmpp:message-correct:0",id:e.originMessageId,last:e.last?"true":"false"}).up(),t.c("extraParams",{xmlns:"jabber:client"}).c("dialog_id").t(e.dialogId),e.extension&&wu.assignExtraParamsToXml(t,e.extension),this.xmppClient.send(t)},e.prototype.deleteMessage=function(e){var t=wu.createMessageStanza({from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e.to),type:this.helpers.typeChat(e.to),id:O.getBsonObjectId()});t.c("remove",{xmlns:"urn:xmpp:message-delete:0",id:e.messageId}).up(),t.c("extraParams",{xmlns:"jabber:client"}).c("dialog_id").t(e.dialogId),this.xmppClient.send(t)},e.prototype.getLastUserActivity=function(e){var t=this;return new Promise((function(n,r){var i=wu.getUniqueId("lastActivity"),o=wu.createIqStanza({type:"get",from:t.helpers.userCurrentJid,to:t.helpers.jidOrUserId(e),id:i});o.c("query",{xmlns:"jabber:iq:last"}),t.stanzasCallbacks[i]=function(e){wu.getElement(e,"error")?r(wu.buildErrorFromXMPPErrorStanza(e)):n(t.onLastActivityStanza(e))},t.xmppClient.send(o)}))},e.prototype.onLastActivityStanza=function(e){var t=wu.getAttr(e,"from"),n=this.helpers.getUserIdFromJID(t),r=wu.getElement(e,"query"),i=r?parseInt(wu.getAttr(r,"seconds")):0;return O.safeCallbackCall(this.onLastUserActivityListener)(n,i),{userId:n,seconds:i}},e.prototype.markActive=function(){var e=wu.createIqStanza({id:this.helpers.getUniqueId("markActive"),type:"set"});e.c("mobile",{xmlns:"http://tigase.org/protocol/mobile#v2",enable:"false"}),this.xmppClient.send(e)},e.prototype.markInactive=function(){var e=wu.createIqStanza({id:this.helpers.getUniqueId("markActive"),type:"set"});e.c("mobile",{xmlns:"http://tigase.org/protocol/mobile#v2",enable:"true"}),this.xmppClient.send(e)},e.prototype.disconnect=function(){return k(this,void 0,void 0,(function(){return T(this,(function(e){switch(e.label){case 0:if(O.DLog("[Chat]","disconnect"),this.isLogout)return O.DLog("[Chat]","Warning! Chat is already disconnected!"),[2,!0];this.muc.joinedRooms={},this.isConnected=!1,this.isConnecting=!1,this.isLogout=!0,this.isReconnect=!1,this.helpers.userCurrentJid="",this.isStreamManagementSupported&&this.streamManagement.removeElementHandler(),e.label=1;case 1:return e.trys.push([1,3,,4]),[4,this.xmppClient.stop()];case 2:return e.sent(),[2,!0];case 3:return e.sent(),[2,!1];case 4:return[2]}}))}))},e.prototype.search=function(e){return k(this,void 0,void 0,(function(){var t,n;return T(this,(function(r){return(t=Object.assign({},e)).start_date&&(t.start_date=new Date(t.start_date).toISOString()),t.end_date&&(t.end_date=new Date(t.end_date).toISOString()),O.isArray(t.chat_dialog_ids)&&(t.chat_dialog_ids=t.chat_dialog_ids.join(",")),n={type:I.GET,url:O.getUrl("".concat(E.urls.chat,"/search")),data:t},[2,this.proxy.ajax(n)]}))}))},e.prototype.onMessage=function(e){var t,n,r,i=wu.getElementTreePath(e,["sent","forwarded","message"]),o=i||e,s=wu.getAttr(o,"from"),a=wu.getAttr(o,"type"),c=wu.getElement(o,"invite"),l=(null===(t=this.xmppClient.jid)||void 0===t?void 0:t.getResource())||"",u="chat"===a;if(!(u&&s.includes(l)||c)){var d=wu.getAttr(o,"id"),h=wu.getElement(o,"markable"),f=wu.getElement(o,"received"),p=wu.getElement(o,"displayed"),m=wu.getElement(o,"replace"),g=wu.getElement(o,"reactions"),v=wu.getElement(o,"remove"),y=Boolean(wu.getElement(o,"composing")),b=wu.getElement(o,"paused"),_=wu.getElement(o,"delay"),w=wu.getElement(o,"extraParams"),S=wu.getElementText(o,"body"),E=Boolean(i),C="groupchat"===a,k=u?wu.getAttr(o,"to"):null,T=k?this.helpers.getUserIdFromJID(k):null,x=w?wu.parseExtraParams(w):null,I=x?x.extension:null,R=C?this.helpers.getDialogIdFromJID(s):null!==(n=null==x?void 0:x.dialogId)&&void 0!==n?n:null,A=C?this.helpers.getIdFromResource(s):this.helpers.getUserIdFromJID(s),L=null===(r=this.xmppClient.jid)||void 0===r?void 0:r.toString(),P=L?this.helpers.getUserIdFromJID(L):0;if(y||b)(u||C||!_)&&O.safeCallbackCall(this.onMessageTypingListener)(y,A,R);else if(m)O.safeCallbackCall(this.onMessageUpdateListener)(wu.getAttr(m,"id"),"true"===wu.getAttr(m,"last"),S,R,A,I);else if(g){if(E&&C)return;var D=wu.getAttr(g,"message_id"),N=parseInt(wu.getAttr(g,"user_id")),M=wu.parseReactions(g),j=M.add,U=M.remove;O.safeCallbackCall(this.onMessageReactionsListener)(D,N,R,j,U)}else if(v){var z=wu.getAttr(v,"id");O.safeCallbackCall(this.onMessageDeleteListener)(z,R,A)}else if(f||p){if(f&&u){var B=wu.getAttr(f,"id");O.safeCallbackCall(this.onDeliveredStatusListener)(B,R,A)}if(p&&u){B=wu.getAttr(p,"id");O.safeCallbackCall(this.onReadStatusListener)(B,R,A)}}else{h&&R&&A&&A!==P&&this.sendDeliveredStatus({messageId:d,dialogId:R,userId:A});var F={id:d,dialog_id:R,recipient_id:T,is_forwarded:E,type:a,body:S,extension:I,delay:_};h&&(F.markable=1),(u||C)&&O.safeCallbackCall(this.onMessageListener)(A,F)}}},e.prototype.onPresence=function(e){var t,n,r,i,o,s=wu.getAttr(e,"from"),a=wu.getAttr(e,"id"),c=wu.getAttr(e,"type"),l=null===(t=this.xmppClient.jid)||void 0===t?void 0:t.toString(),u=this.helpers.getUserIdFromJID(l),d=wu.getElement(e,"x"),h=d?wu.getAttr(d,"xmlns"):null,f=d?wu.getElement(d,"xmlns"):null,p=f?wu.getElementText(f,"code"):null;if(h&&h.startsWith("http://jabber.org/protocol/muc")){if("error"===c)return void(a.endsWith(":join")&&O.safeCallbackCall(this.stanzasCallbacks[a])(e));var m=this.helpers.getDialogIdFromJID(s),g=this.helpers.getUserIdFromRoomJid(s);if(f){if("301"===p){var v=wu.getElement(e,"item"),y=v?wu.getElement(v,"actor"):null,b=y?wu.getAttr(y,"jid"):null,_=this.helpers.getUserIdFromJID(b),w=this.helpers.getRoomJidFromRoomFullJid(s);return O.safeCallbackCall(this.onKickOccupant)(m,_),void(w&&delete this.muc.joinedRooms[w])}if("unavailable"===c)return void(f&&"110"===p&&O.safeCallbackCall(this.stanzasCallbacks["muc:leave"])(null));if(a.endsWith(":join")&&f&&"110"===p)return void(null===(r=(n=this.stanzasCallbacks)[a])||void 0===r||r.call(n,e))}else if(g!=u){var S="unavailable"===c?"onLeaveOccupant":"onJoinOccupant";return void O.safeCallbackCall(this[S])(m,g)}}var E=null!==(i=this.helpers.getUserIdFromJID(s))&&void 0!==i?i:0,C=null!==(o=this.contactlist.contacts[E])&&void 0!==o?o:{ask:null,subscription:null};switch(c){case"subscribe":"to"===(null==C?void 0:C.subscription)?(C.ask=null,C.subscription="both",this.contactlist.sendSubscriptionPresence({jid:s,type:"subscribed"})):O.safeCallbackCall(this.onSubscribeListener)(E);break;case"subscribed":"from"===(null==C?void 0:C.subscription)?(C.ask=null,C.subscription="both"):(C.ask=null,C.subscription="to",O.safeCallbackCall(this.onConfirmSubscribeListener)(E));break;case"unsubscribed":C.ask=null,C.subscription="none",O.safeCallbackCall(this.onRejectSubscribeListener)(E);break;case"unsubscribe":C.ask=null,C.subscription="to";break;case"unavailable":"none"!==(null==C?void 0:C.subscription)&&O.safeCallbackCall(this.onContactListListener)(E,"unavailable"),E===u&&this.xmppClient.send(wu.createPresenceStanza());break;default:"none"!==(null==C?void 0:C.subscription)&&O.safeCallbackCall(this.onContactListListener)(E,"available")}},e.prototype.onIQ=function(e){var t=wu.getAttr(e,"id");if(this.stanzasCallbacks[t])O.safeCallbackCall(this.stanzasCallbacks[t])(e),delete this.stanzasCallbacks[t];else{var n=wu.getAttr(e,"from"),r=wu.getElement(e,"query");n&&r&&this.onLastActivityStanza(e)}},e.prototype.onSystemMessage=function(e){var t=wu.getElementTreePath(e,["sent","forwarded","message"])||e,n=wu.getAttr(t,"from"),r=wu.getAttr(t,"id"),i=wu.getElement(t,"extraParams"),o=this.helpers.getUserIdFromJID(n),s=wu.getElement(t,"delay"),a=i?wu.getElementText(i,"moduleIdentifier"):null,c=wu.getElementText(t,"body"),l=i?wu.parseExtraParams(i):null,u=l?l.extension:null;switch(a){case"SystemNotifications":O.safeCallbackCall(this.onSystemMessageListener)({id:r,userId:o,body:c,extension:u});break;case"WebRTCVideoChat":this.webrtcSignalingProcessor&&!s&&O.safeCallbackCall(this.webrtcSignalingProcessor.onMessage)(o,i)}},e.prototype.onMessageError=function(e){var t=wu.getAttr(e,"id"),n=wu.buildErrorFromXMPPErrorStanza(e);O.safeCallbackCall(this.onMessageErrorListener)(t,n)},e.prototype.postConnectActions=function(){var e,t,n=this;O.DLog("[Chat]",this.isReconnect?"RECONNECTED":"CONNECTED");var r=wu.createPresenceStanza();if(this.isStreamManagementSupported&&(this.streamManagement.enable(this.xmppClient),this.streamManagement.sentMessageCallback=function(e,t){O.safeCallbackCall(n.onSentMessageCallback)(t?null:e,t)}),this.helpers.userCurrentJid=null!==(t=null===(e=this.xmppClient.jid)||void 0===e?void 0:e.toString())&&void 0!==t?t:null,this.isConnected=!0,this.isConnecting=!1,this.enableCarbons(),this.xmppClient.send(r),this.isReconnect?O.safeCallbackCall(this.onReconnectListener)():this.isReconnect=!0,this.earlyIncomingMessagesQueue.length>0){O.DLog("[Chat]","Flush 'earlyIncomingMessagesQueue' (length=".concat(this.earlyIncomingMessagesQueue.length,")"));var i=this.xmppClientListeners.get("stanza");this.earlyIncomingMessagesQueue.forEach((function(e){null==i||i(e)})),this.earlyIncomingMessagesQueue=[]}},e.prototype.enableCarbons=function(){var e=wu.createIqStanza({type:"set",from:this.helpers.userCurrentJid,id:wu.getUniqueId("enableCarbons")});e.c("enable",{xmlns:"urn:xmpp:carbons:2"}),this.xmppClient.send(e)},e.prototype.setSubscriptionToUserLastActivity=function(e,t){var n=wu.createIqStanza({id:this.helpers.getUniqueId("statusStreaming"),type:"set"});n.c("subscribe",{xmlns:"https://connectycube.com/protocol/status_streaming",user_jid:this.helpers.jidOrUserId(e),enable:t}),this.xmppClient.send(n)},e.prototype.subscribeToUserLastActivityStatus=function(e){this.setSubscriptionToUserLastActivity(e,!0)},e.prototype.unsubscribeFromUserLastActivityStatus=function(e){this.setSubscriptionToUserLastActivity(e,!1)},Object.defineProperty(e.prototype,"isStreamManagementSupported",{get:function(){var e,t=!!(null===(e=E.chat.streamManagement)||void 0===e?void 0:e.enable),n=2===E.chatProtocol.active;return t&&!n&&O.DLog("[Chat]","Stream Management is disabled for BOSH"),t&&n},enumerable:!1,configurable:!0}),e.prototype.addXMPPClientListener=function(e,t){this.xmppClient.on(e,t),this.xmppClientListeners.set(e,t)},e.prototype.removeXMPPClientListener=function(e){var t=this.xmppClientListeners.get(e);t&&this.xmppClient.removeListener(e,t),this.xmppClientListeners.delete(e)},e.prototype.removeAllXMPPClientListeners=function(){var e=this;this.xmppClientListeners.forEach((function(t,n){return e.removeXMPPClientListener(n)}))},e.prototype.getListenerByName=function(e){switch(e){case gu.STATUS:return"onChatStatusListener";case gu.ERROR:return"onConnectionErrorListener";case gu.DISCONNECTED:return"onDisconnectedListener";case gu.RECONNECTED:return"onReconnectListener";case gu.MESSAGE:return"onMessageListener";case gu.SYSTEM_MESSAGE:return"onSystemMessageListener";case gu.ERROR_MESSAGE:return"onMessageErrorListener";case gu.TYPING_MESSAGE:return"onMessageTypingListener";case gu.UPDATE_MESSAGE:return"onMessageUpdateListener";case gu.DELETE_MESSAGE:return"onMessageDeleteListener";case gu.REACTIONS_MESSAGE:return"onMessageReactionsListener";case gu.DELIVERED_MESSAGE:return"onDeliveredStatusListener";case gu.READ_MESSAGE:return"onReadStatusListener";case gu.SENT_MESSAGE:return"onSentMessageCallback";case gu.USER_LAST_ACTIVITY:return"onLastUserActivityListener";case gu.ROSTER_SUBSCRIBE:return"onSubscribeListener";case gu.ROSTER_CONFIRM:return"onConfirmSubscribeListener";case gu.ROSTER_REJECT:return"onRejectSubscribeListener";case gu.ROSTER_LIST:return"onContactListListener";case gu.JOIN:return"onJoinOccupant";case gu.LEAVE:return"onLeaveOccupant";case gu.KICK:return"onKickOccupant";default:return null}},e.prototype.addListener=function(e,t){var n=this.getListenerByName(e);return n&&(this[n]=t),this.removeListener.bind(this,e)},e.prototype.removeListener=function(e){var t=this.getListenerByName(e);t&&(this[t]=void 0)},e.prototype.removeAllListeners=function(){var e=this;Object.keys(this).forEach((function(t){t.startsWith("on")&&t.endsWith("Listener")&&"function"==typeof e[t]&&(e[t]=void 0)}))},e}(),Ou=N(w);var Au,Lu,Pu,Du,Nu,Mu=function(){if(Iu)return xu;Iu=1;const{adapter:e,navigator:t,MediaStream:n,MediaStreamTrack:r,RTCPeerConnection:i,RTCRtpReceiver:o,RTCRtpSender:s,isReactNative:a}=Ou;l.sessions={},l.mobile=a,l.isExtensionEnabled=function(){if(l.mobile)return!1;if(t.mediaDevices&&t.mediaDevices.getDisplayMedia)return!0;if(window.navigator.userAgent.match("Chrome")){let e=parseInt(window.navigator.userAgent.match(/Chrome\/(.*) /)[1],10),t=33;return window.navigator.userAgent.match("Linux")&&(t=35),e>=26&&e<=t||l.extension.isInstalled()}return!0};const c={extensionId:"hapfgfdkleiggjjpfpenajgdnfckjpaj",isInstalled:function(){return!l.mobile&&null!==document.querySelector("#janus-extension-installed")},getScreen:function(e){if(l.mobile)e();else{let t=window.setTimeout((function(){let t=new Error("NavigatorUserMediaError");return t.name='The required Chrome extension is not installed: click <a href="#">here</a> to install it. (NOTE: this will need you to refresh the page)',e(t)}),1e3);this.cache[t]=e,window.postMessage({type:"janusGetScreen",id:t},"*")}},init:function(){let e={};this.cache=e,l.mobile||window.addEventListener("message",(function(t){if(t.origin==window.location.origin)if("janusGotScreen"==t.data.type&&e[t.data.id]){let n=e[t.data.id];if(delete e[t.data.id],""===t.data.sourceId){let e=new Error("NavigatorUserMediaError");e.name="You cancelled the request for permission, giving up...",n(e)}else n(null,t.data.sourceId)}else"janusGetScreenPending"==t.data.type&&window.clearTimeout(t.data.id)}))}};function l(e){if((e=e||{}).success="function"==typeof e.success?e.success:l.noop,e.error="function"==typeof e.error?e.error:l.noop,e.destroyed="function"==typeof e.destroyed?e.destroyed:l.noop,!l.initDone)return e.error("Library not initialized"),{};if(!l.isWebrtcSupported())return e.error("WebRTC not supported by this browser"),{};if(l.log("Library initialized: "+l.initDone),!e.server)return e.error("Invalid server url"),{};let a=!1,c=null,u={},d=null,h=null,f=0,p=e.server;l.isArray(p)?(l.log("Multiple servers provided ("+p.length+"), will use the first that works"),p=null,h=e.server,l.debug(h)):0===p.indexOf("ws")?(a=!0,l.log("Using WebSockets to contact Janus: "+p)):(a=!1,l.log("Using REST API to contact Janus: "+p));let m=e.iceServers||[{urls:"stun:stun.l.google.com:19302"}],g=e.iceTransportPolicy,v=e.bundlePolicy,y=!1;void 0!==e.withCredentials&&null!==e.withCredentials&&(y=!0===e.withCredentials);let b=10;void 0!==e.max_poll_events&&null!==e.max_poll_events&&(b=e.max_poll_events),b<1&&(b=1);let _=null;void 0!==e.token&&null!==e.token&&(_=e.token);let w=null;void 0!==e.apisecret&&null!==e.apisecret&&(w=e.apisecret),this.destroyOnUnload=!0,void 0!==e.destroyOnUnload&&null!==e.destroyOnUnload&&(this.destroyOnUnload=!0===e.destroyOnUnload);let S=25e3;void 0!==e.keepAlivePeriod&&null!==e.keepAlivePeriod&&(S=e.keepAlivePeriod),isNaN(S)&&(S=25e3);let E=6e4;function C(e){let t={high:9e5,medium:3e5,low:1e5};return null!=e&&(e.high&&(t.high=e.high),e.medium&&(t.medium=e.medium),e.low&&(t.low=e.low)),t}void 0!==e.longPollTimeout&&null!==e.longPollTimeout&&(E=e.longPollTimeout),isNaN(E)&&(E=6e4);let k=!1,T=null,x={},I=this,R=0,O={};function A(){if(null==T)return;if(l.debug("Long poll..."),!k)return void l.warn("Is the server down? (connected=false)");let t=p+"/"+T+"?rid="+(new Date).getTime();b&&(t=t+"&maxev="+b),_&&(t=t+"&token="+encodeURIComponent(_)),w&&(t=t+"&apisecret="+encodeURIComponent(w)),l.httpAPICall(t,{verb:"GET",withCredentials:y,success:L,timeout:E,error:function(t,n){if(l.error(t+":",n),R++,R>3)return k=!1,void e.error("Lost connection to the server (is it down?)");A()}})}function L(e,t){if(R=0,a||null==T||!0===t||A(),a||!l.isArray(e))if("keepalive"!==e.janus)if("server_info"!==e.janus)if("ack"!==e.janus)if("success"!==e.janus)if("trickle"===e.janus){const t=e.sender;if(!t)return void l.warn("Missing sender...");const n=x[t];if(!n)return void l.debug("This handle is not attached to this session");let r=e.candidate;l.debug("Got a trickled candidate on session "+T),l.debug(r);let i=n.webrtcStuff;i.pc&&i.remoteSdp?(l.debug("Adding remote candidate:",r),r&&!0!==r.completed?i.pc.addIceCandidate(r):i.pc.addIceCandidate(l.endOfCandidates)):(l.debug("We didn't do setRemoteDescription (trickle got here before the offer?), caching candidate"),i.candidates||(i.candidates=[]),i.candidates.push(r),l.debug(i.candidates))}else{if("webrtcup"===e.janus){l.debug("Got a webrtcup event on session "+T),l.debug(e);const t=e.sender;if(!t)return void l.warn("Missing sender...");const n=x[t];return n?void n.webrtcState(!0):void l.debug("This handle is not attached to this session")}if("hangup"===e.janus){l.debug("Got a hangup event on session "+T),l.debug(e);const t=e.sender;if(!t)return void l.warn("Missing sender...");const n=x[t];if(!n)return void l.debug("This handle is not attached to this session");n.webrtcState(!1,e.reason),n.hangup()}else if("detached"===e.janus){l.debug("Got a detached event on session "+T),l.debug(e);const t=e.sender;if(!t)return void l.warn("Missing sender...");const n=x[t];if(!n)return;n.ondetached(),n.detach()}else if("media"===e.janus){l.debug("Got a media event on session "+T),l.debug(e);const t=e.sender;if(!t)return void l.warn("Missing sender...");const n=x[t];if(!n)return void l.debug("This handle is not attached to this session");n.mediaState(e.type,e.receiving,e.mid)}else if("slowlink"===e.janus){l.debug("Got a slowlink event on session "+T),l.debug(e);const t=e.sender;if(!t)return void l.warn("Missing sender...");const n=x[t];if(!n)return void l.debug("This handle is not attached to this session");n.slowLink(e.uplink,e.lost,e.mid)}else{if("error"===e.janus){l.error("Ooops: "+e.error.code+" "+e.error.reason),l.debug(e);let t=e.transaction;if(t){let n=O[t];n&&n(e),delete O[t]}return}if("event"===e.janus){l.debug("Got a plugin event on session "+T),l.debug(e);const t=e.sender;if(!t)return void l.warn("Missing sender...");let n=e.plugindata;if(!n)return void l.warn("Missing plugindata...");l.debug("  -- Event is coming from "+t+" ("+n.plugin+")");let r=n.data;l.debug(r);const i=x[t];if(!i)return void l.warn("This handle is not attached to this session");let o=e.jsep;o&&(l.debug("Handling SDP as well..."),l.debug(o));let s=i.onmessage;s?(l.debug("Notifying application..."),s(r,o)):l.debug("No provided notification callback")}else{if("timeout"===e.janus)return l.error("Timeout on session "+T),l.debug(e),void(a&&c.close(3504,"Gateway timeout"));l.warn("Unknown message/event  '"+e.janus+"' on session "+T),l.debug(e)}}}else{l.debug("Got a success on session "+T),l.debug(e);const t=e.transaction;if(t){const n=O[t];n&&n(e),delete O[t]}}else{l.debug("Got an ack on session "+T),l.debug(e);const t=e.transaction;if(t){const n=O[t];n&&n(e),delete O[t]}}else{l.debug("Got info on the Janus instance"),l.debug(e);const t=e.transaction;if(t){const n=O[t];n&&n(e),delete O[t]}}else l.vdebug("Got a keepalive on session "+T);else for(let t=0;t<e.length;t++)L(e[t],!0)}function P(){if(!p||!a||!k)return;d=setTimeout(P,S);let e={janus:"keepalive",session_id:T,transaction:l.randomString(12)};_&&(e.token=_),w&&(e.apisecret=w),c.send(JSON.stringify(e))}function D(t){let n=l.randomString(12),r={janus:"create",transaction:n};if(t.reconnect&&(k=!1,r.janus="claim",r.session_id=T,c&&(c.onopen=null,c.onerror=null,c.onclose=null,d&&(clearTimeout(d),d=null))),_&&(r.token=_),w&&(r.apisecret=w),!p&&l.isArray(h)&&(p=h[f],0===p.indexOf("ws")?(a=!0,l.log("Server #"+(f+1)+": trying WebSockets to contact Janus ("+p+")")):(a=!1,l.log("Server #"+(f+1)+": trying REST API to contact Janus ("+p+")"))),a){c=l.newWebSocket(p,"janus-protocol"),u={error:function(){if(l.error("Error connecting to the Janus WebSockets server... "+p),l.isArray(h)&&!t.reconnect)return f++,f===h.length?void t.error("Error connecting to any of the provided Janus servers: Is the server down?"):(p=null,void setTimeout((function(){D(t)}),200));t.error("Error connecting to the Janus WebSockets server: Is the server down?")},open:function(){O[n]=function(e){if(l.debug(e),"success"!==e.janus)return l.error("Ooops: "+e.error.code+" "+e.error.reason),void t.error(e.error.reason);d=setTimeout(P,S),k=!0,T=e.session_id?e.session_id:e.data.id,t.reconnect?l.log("Claimed session: "+T):l.log("Created session: "+T),l.sessions[T]=I,t.success()},c.send(JSON.stringify(r))},message:function(e){L(JSON.parse(e.data))},close:function(){p&&k&&(k=!1,e.error("Lost connection to the server (is it down?)"))}};for(let e in u)c.addEventListener(e,u[e])}else l.httpAPICall(p,{verb:"POST",withCredentials:y,body:r,success:function(e){if(l.debug(e),"success"!==e.janus)return l.error("Ooops: "+e.error.code+" "+e.error.reason),void t.error(e.error.reason);k=!0,T=e.session_id?e.session_id:e.data.id,t.reconnect?l.log("Claimed session: "+T):l.log("Created session: "+T),l.sessions[T]=I,A(),t.success()},error:function(e,n){if(l.error(e+":",n),l.isArray(h)&&!t.reconnect)return f++,f===h.length?void t.error("Error connecting to any of the provided Janus servers: Is the server down?"):(p=null,void setTimeout((function(){D(t)}),200));""===n?t.error(e+": Is the server down?"):n&&n.error?t.error(e+": "+n.error.message):t.error(e+": "+n)}})}function N(e,t){if((t=t||{}).success="function"==typeof t.success?t.success:l.noop,t.error="function"==typeof t.error?t.error:l.noop,!k)return l.warn("Is the server down? (connected=false)"),void t.error("Is the server down? (connected=false)");let n=x[e];if(!n||!n.webrtcStuff)return l.warn("Invalid handle"),void t.error("Invalid handle");let r=t.message,i=t.jsep,o=l.randomString(12),s={janus:"message",body:r,transaction:o};if(n.token&&(s.token=n.token),w&&(s.apisecret=w),i&&(s.jsep={type:i.type,sdp:i.sdp},i.e2ee&&(s.jsep.e2ee=!0),"hml"!==i.rid_order&&"lmh"!==i.rid_order||(s.jsep.rid_order=i.rid_order),i.force_relay&&(s.jsep.force_relay=!0)),l.debug("Sending message to plugin (handle="+e+"):"),l.debug(s),a)return s.session_id=T,s.handle_id=e,O[o]=function(e){if(l.debug("Message sent!"),l.debug(e),"success"===e.janus){let n=e.plugindata;if(!n)return l.warn("Request succeeded, but missing plugindata..."),void t.success();l.log("Synchronous transaction successful ("+n.plugin+")");let r=n.data;return l.debug(r),void t.success(r)}"ack"===e.janus?t.success():e.error?(l.error("Ooops: "+e.error.code+" "+e.error.reason),t.error(e.error.code+" "+e.error.reason)):(l.error("Unknown error"),t.error("Unknown error"))},void c.send(JSON.stringify(s));l.httpAPICall(p+"/"+T+"/"+e,{verb:"POST",withCredentials:y,body:s,success:function(e){if(l.debug("Message sent!"),l.debug(e),"success"===e.janus){let n=e.plugindata;if(!n)return l.warn("Request succeeded, but missing plugindata..."),void t.success();l.log("Synchronous transaction successful ("+n.plugin+")");let r=n.data;return l.debug(r),void t.success(r)}"ack"===e.janus?t.success():e.error?(l.error("Ooops: "+e.error.code+" "+e.error.reason),t.error(e.error.code+" "+e.error.reason)):(l.error("Unknown error"),t.error("Unknown error"))},error:function(e,n){l.error(e+":",n),t.error(e+": "+n)}})}function M(e,t){if(!k)return void l.warn("Is the server down? (connected=false)");let n=x[e];if(!n||!n.webrtcStuff)return void l.warn("Invalid handle");let r={janus:"trickle",candidate:t,transaction:l.randomString(12)};if(n.token&&(r.token=n.token),w&&(r.apisecret=w),l.vdebug("Sending trickle candidate (handle="+e+"):"),l.vdebug(r),a)return r.session_id=T,r.handle_id=e,void c.send(JSON.stringify(r));l.httpAPICall(p+"/"+T+"/"+e,{verb:"POST",withCredentials:y,body:r,success:function(e){l.vdebug("Candidate sent!"),l.vdebug(e),"ack"===e.janus||l.error("Ooops: "+e.error.code+" "+e.error.reason)},error:function(e,t){l.error(e+":",t)}})}function j(e,t,n,r,i){let o=x[e];if(!o||!o.webrtcStuff)return void l.warn("Invalid handle");let s=o.webrtcStuff;if(!s.pc)return void l.warn("Invalid PeerConnection");let a=function(e){l.log("Received state change on data channel:",e);let t=e.target.label,n=e.target.protocol,r=s.dataChannel[t]?s.dataChannel[t].readyState:"null";if(l.log("State change on <"+t+"> data channel: "+r),"open"===r){if(s.dataChannel[t].pending&&s.dataChannel[t].pending.length>0){l.log("Sending pending messages on <"+t+">:",s.dataChannel[t].pending.length);for(let e of s.dataChannel[t].pending)l.log("Sending data on data channel <"+t+">"),l.debug(e),s.dataChannel[t].send(e);s.dataChannel[t].pending=[]}o.ondataopen(t,n)}};if(r)s.dataChannel[t]=r;else{let e=s.dataChannelOptions;n&&(e.protocol=n),s.dataChannel[t]=s.pc.createDataChannel(t,e)}s.dataChannel[t].onmessage=function(e){l.log("Received message on data channel:",e);let t=e.target.label;o.ondata(e.data,t)},s.dataChannel[t].onopen=a,s.dataChannel[t].onclose=a,s.dataChannel[t].onerror=function(e){l.error("Got error on data channel:",e)},s.dataChannel[t].pending=[],i&&s.dataChannel[t].pending.push(i)}function U(e,t){(t=t||{}).success="function"==typeof t.success?t.success:l.noop,t.error="function"==typeof t.error?t.error:l.noop;let n=x[e];if(!n||!n.webrtcStuff)return l.warn("Invalid handle"),void t.error("Invalid handle");let r=n.webrtcStuff,i=t.text||t.data;if(!i)return l.warn("Invalid data"),void t.error("Invalid data");let o=t.label?t.label:l.dataChanDefaultLabel;return r.dataChannel[o]?"open"!==r.dataChannel[o].readyState?(r.dataChannel[o].pending.push(i),void t.success()):(l.log("Sending data on data channel <"+o+">"),l.debug(i),r.dataChannel[o].send(i),void t.success()):(j(e,o,t.protocol,!1,i,t.protocol),void t.success())}function z(e,t){(t=t||{}).success="function"==typeof t.success?t.success:l.noop,t.error="function"==typeof t.error?t.error:l.noop;let n=x[e];if(!n||!n.webrtcStuff)return l.warn("Invalid handle"),void t.error("Invalid handle");let r=n.webrtcStuff;if(!r.dtmfSender){if(r.pc){let e=r.pc.getSenders().find((function(e){return e.track&&"audio"===e.track.kind}));if(!e)return l.warn("Invalid DTMF configuration (no audio track)"),void t.error("Invalid DTMF configuration (no audio track)");r.dtmfSender=e.dtmf,r.dtmfSender&&(l.log("Created DTMF Sender"),r.dtmfSender.ontonechange=function(e){l.debug("Sent DTMF tone: "+e.tone)})}if(!r.dtmfSender)return l.warn("Invalid DTMF configuration"),void t.error("Invalid DTMF configuration")}let i=t.dtmf;if(!i)return l.warn("Invalid DTMF parameters"),void t.error("Invalid DTMF parameters");let o=i.tones;if(!o)return l.warn("Invalid DTMF string"),void t.error("Invalid DTMF string");let s="number"==typeof i.duration?i.duration:500,a="number"==typeof i.gap?i.gap:50;l.debug("Sending DTMF string "+o+" (duration "+s+"ms, gap "+a+"ms)"),r.dtmfSender.insertDTMF(o,s,a),t.success()}function B(e,t){(t=t||{}).success="function"==typeof t.success?t.success:l.noop,t.error="function"==typeof t.error?t.error:l.noop;let n=!0===t.noRequest;l.log("Destroying handle "+e+" (only-locally="+n+")"),ee(e);let r=x[e];if(!r||r.detached)return delete x[e],void t.success();if(r.detached=!0,n)return delete x[e],void t.success();if(!k)return l.warn("Is the server down? (connected=false)"),void t.error("Is the server down? (connected=false)");let i={janus:"detach",transaction:l.randomString(12)};if(r.token&&(i.token=r.token),w&&(i.apisecret=w),a)return i.session_id=T,i.handle_id=e,c.send(JSON.stringify(i)),delete x[e],void t.success();l.httpAPICall(p+"/"+T+"/"+e,{verb:"POST",withCredentials:y,body:i,success:function(n){l.log("Destroyed handle:"),l.debug(n),"success"!==n.janus&&l.error("Ooops: "+n.error.code+" "+n.error.reason),delete x[e],t.success()},error:function(n,r){l.error(n+":",r),delete x[e],t.success()}})}function F(e,t){let n=x[e];if(!n||!n.webrtcStuff)throw l.warn("Invalid handle"),"Invalid handle";let r=n.webrtcStuff;if(r.pc)return;let o={iceServers:m,iceTransportPolicy:g,bundlePolicy:v,sdpSemantics:"unified-plan"},a=!1;if(t.tracks)for(let e of t.tracks)if(e.transforms&&(e.transforms.sender||e.transforms.receiver)){a=!0;break}s&&(s.prototype.createEncodedStreams||s.prototype.createEncodedAudioStreams&&s.prototype.createEncodedVideoStreams)&&a&&(r.insertableStreams=!0,o.forceEncodedAudioInsertableStreams=!0,o.forceEncodedVideoInsertableStreams=!0,o.encodedInsertableStreams=!0),l.log("Creating PeerConnection"),r.pc=new i(o),l.debug(r.pc),r.pc.getStats&&(r.volume={},r.bitrate.value="0 kbits/sec"),l.log("Preparing local SDP and gathering candidates (trickle="+r.trickle+")"),r.pc.oniceconnectionstatechange=function(){r.pc&&n.iceState(r.pc.iceConnectionState)},r.pc.onicecandidate=function(n){if(!n.candidate||n.candidate.candidate&&n.candidate.candidate.indexOf("endOfCandidates")>0)l.log("End of candidates."),r.iceDone=!0,!0===r.trickle?M(e,{completed:!0}):function(e,t){t=t||{},t.success="function"==typeof t.success?t.success:l.noop,t.error="function"==typeof t.error?t.error:l.noop;let n=x[e];if(!n||!n.webrtcStuff)return void l.warn("Invalid handle, not sending anything");let r=n.webrtcStuff;if(l.log("Sending offer/answer SDP..."),!r.mySdp)return void l.warn("Local SDP instance is invalid, not sending anything...");r.mySdp={type:r.pc.localDescription.type,sdp:r.pc.localDescription.sdp},!1===r.trickle&&(r.mySdp.trickle=!1);l.debug(t),r.sdpSent=!0,t.success(r.mySdp)}(e,t);else{let t={candidate:n.candidate.candidate,sdpMid:n.candidate.sdpMid,sdpMLineIndex:n.candidate.sdpMLineIndex};!0===r.trickle&&M(e,t)}},r.pc.ontrack=function(e){if(l.log("Handling Remote Track",e),!e.streams)return;if(!e.track)return;let t=e.transceiver?e.transceiver.mid||e.transceiver._mid:e.track.id;try{n.onremotetrack(e.track,t,!0,{reason:"created"})}catch(e){l.error("Error calling onremotetrack",e)}if(e.track.onended)return;let i=null;l.log("Adding onended callback to track:",e.track),e.track.onended=function(e){l.log("Remote track removed:",e),clearTimeout(i);let t=r.pc?r.pc.getTransceivers():null,o=t?t.find((t=>{const n=t.receiver||t._receiver;return(n.track||n._track)===e.target})):null,s=o?o.mid||o._mid:e.target.id;try{n.onremotetrack(e.target,s,!1,{reason:"ended"})}catch(e){l.error("Error calling onremotetrack on removal",e)}},e.track.onmute=function(e){if(l.log("Remote track muted:",e),!i){const t=e.target;i=setTimeout((function(){l.log("Removing remote track");let e=r.pc?r.pc.getTransceivers():null,o=e?e.find((e=>{const n=e.receiver||e._receiver;return(n.track||n._track)===t})):null,s=o?o.mid||o._mid:t.id;try{n.onremotetrack(t,s,!1,{reason:"mute"})}catch(e){l.error("Error calling onremotetrack on mute",e)}i=null}),2520)}},e.track.onunmute=function(e){if(l.log("Remote track flowing again:",e),null!=i)clearTimeout(i),i=null;else try{let t=r.pc?r.pc.getTransceivers():null,i=t?t.find((t=>{const n=t.receiver||t._receiver;return(n.track||n._track)===e.target})):null,o=i?i.mid||i._mid:e.target.id;n.onremotetrack(e.target,o,!0,{reason:"unmute"})}catch(e){l.error("Error calling onremotetrack on unmute",e)}}}}async function q(e,t,n){(n=n||{}).success="function"==typeof n.success?n.success:l.noop,n.error="function"==typeof n.error?n.error:Q;let r=n.jsep;if(t&&r)return l.error("Provided a JSEP to a createOffer"),void n.error("Provided a JSEP to a createOffer");if(!(t||r&&r.type&&r.sdp))return l.error("A valid JSEP is required for createAnswer"),void n.error("A valid JSEP is required for createAnswer");if(n.media&&!n.tracks){if(n.tracks=l.mediaToTracks(n.media),!0===n.simulcast||!0===n.simulcast2||n.svc)for(let e of n.tracks)if("video"===e.type){!0===n.simulcast||!0===n.simulcast2?e.simulcast=!0:n.svc&&(e.svc=n.svc);break}l.warn("Deprecated media object passed, use tracks instead. Automatically translated to:",n.tracks)}if(n.tracks&&!Array.isArray(n.tracks))return l.error("Tracks must be an array"),void n.error("Tracks must be an array");let i=x[e];if(!i||!i.webrtcStuff)return l.warn("Invalid handle"),void n.error("Invalid handle");let o=i.webrtcStuff;var s;o.trickle=(s=n.trickle,l.debug("isTrickleEnabled:",s),!1!==s);try{if(F(e,n),t&&await G(e,n),r){if(await o.pc.setRemoteDescription(r),l.log("Remote description accepted!"),o.remoteSdp=r.sdp,o.candidates&&o.candidates.length>0){for(let e=0;e<o.candidates.length;e++){let t=o.candidates[e];l.debug("Adding remote candidate:",t),t&&!0!==t.completed?o.pc.addIceCandidate(t):o.pc.addIceCandidate(l.endOfCandidates)}o.candidates=[]}await G(e,n);let t=await async function(e,t){t=t||{},t.customizeSdp="function"==typeof t.customizeSdp?t.customizeSdp:l.noop;let n=x[e];if(!n||!n.webrtcStuff)throw l.warn("Invalid handle"),"Invalid handle";let r=n.webrtcStuff;l.log("Creating answer (iceDone="+r.iceDone+")");let i=await r.pc.createAnswer();l.debug(i);let o={type:"answer",sdp:i.sdp};if(t.customizeSdp(o),i.sdp=o.sdp,l.log("Setting local description"),r.mySdp={type:"answer",sdp:i.sdp},await r.pc.setLocalDescription(i),!r.iceDone&&!r.trickle)return l.log("Waiting for all candidates..."),null;r.insertableStreams&&(i.e2ee=!0);return i}(e,n);n.success(t)}else{let t=await async function(e,t){t=t||{},t.customizeSdp="function"==typeof t.customizeSdp?t.customizeSdp:l.noop;let n=x[e];if(!n||!n.webrtcStuff)throw l.warn("Invalid handle"),"Invalid handle";let r=n.webrtcStuff;l.log("Creating offer (iceDone="+r.iceDone+")");let i={},o=!0===t.iceRestart;o&&(i.iceRestart=!0);l.debug(i);let s=await r.pc.createOffer(i);l.debug(s);let a={type:"offer",sdp:s.sdp};if(t.customizeSdp(a),s.sdp=a.sdp,l.log("Setting local description"),r.mySdp={type:"offer",sdp:s.sdp},await r.pc.setLocalDescription(s),r.mediaConstraints=i,!r.iceDone&&!r.trickle)return l.log("Waiting for all candidates..."),null;r.insertableStreams&&(s.e2ee=!0);return s}(e,n);n.success(t)}}catch(e){l.error(e),n.error(e)}}function W(e,t){(t=t||{}).success="function"==typeof t.success?t.success:l.noop,t.error="function"==typeof t.error?t.error:Q,t.customizeSdp="function"==typeof t.customizeSdp?t.customizeSdp:l.noop;let n=t.jsep,r=x[e];if(!r||!r.webrtcStuff)return l.warn("Invalid handle"),void t.error("Invalid handle");let i=r.webrtcStuff;if(n){if(!i.pc)return l.warn("Wait, no PeerConnection?? if this is an answer, use createAnswer and not handleRemoteJsep"),void t.error("No PeerConnection: if this is an answer, use createAnswer and not handleRemoteJsep");t.customizeSdp(n),i.pc.setRemoteDescription(n).then((function(){if(l.log("Remote description accepted!"),i.remoteSdp=n.sdp,i.candidates&&i.candidates.length>0){for(let e=0;e<i.candidates.length;e++){let t=i.candidates[e];l.debug("Adding remote candidate:",t),t&&!0!==t.completed?i.pc.addIceCandidate(t):i.pc.addIceCandidate(l.endOfCandidates)}i.candidates=[]}t.success()}),t.error)}else t.error("Invalid JSEP")}async function V(e,t){if((t=t||{}).success="function"==typeof t.success?t.success:l.noop,t.error="function"==typeof t.error?t.error:l.noop,t.tracks&&!Array.isArray(t.tracks))return l.error("Tracks must be an array"),void t.error("Tracks must be an array");for(let e of t.tracks)(e.add||!e.replace&&!e.remove)&&(e.replace=!0);try{await G(e,t),t.success()}catch(e){l.error(e),t.error(e)}}async function G(e,i){let a=x[e];if(!a||!a.webrtcStuff)throw l.warn("Invalid handle, not sending anything"),"Invalid handle";let c=a.webrtcStuff;if(!c.pc)throw l.warn("Invalid PeerConnection"),"Invalid PeerConnection";let u=i.tracks;if(!u||!Array.isArray(u)||0===u.length)return;let d=!1,h={};for(let e of u){if(delete e.gumGroup,!e.type||!["audio","video"].includes(e.type))continue;if(!e.capture||e.capture instanceof r)continue;let t=e.group?e.group:"default";h[t]||(h[t]={}),h[t][e.type]||(e.gumGroup=t,h[t][e.type]=e)}let f=Object.keys(h);for(let e of f){let t=h[e];t.audio&&t.video||(t.audio&&delete t.audio.gumGroup,t.video&&delete t.video.gumGroup,delete h[e])}let p=!!i.jsep;for(let i of u){if(!i.type){l.warn("Missing track type:",i);continue}if("data"===i.type){if(c.pc.ondatachannel){l.warn("Data channel exists already, not creating another one");continue}l.log("Creating default data channel"),j(e,l.dataChanDefaultLabel,null,!1),c.pc.ondatachannel=function(t){l.log("Data channel created by Janus:",t),j(e,t.channel.label,t.channel.protocol,t.channel)};continue}if(void 0===i.add&&null===i.add&&void 0===i.remove&&null===i.remove&&void 0===i.replace&&null===i.replace&&(i.add=!0),i.add&&i.remove||i.add&&i.remove&&i.replace){l.warn("Conflicting actions for track, ignoring:",i);continue}i.add&&i.replace?(l.warn("Both add and replace provided, falling back to replace:",i),delete i.add):i.remove&&i.replace&&(l.warn("Both remove and replace provided, falling back to remove:",i),delete i.replace);let u=i.type;"screen"===i.type&&(u="video");let f=null,m=null;if(f=i.mid?c.pc.getTransceivers().find((e=>e.mid===i.mid&&e.receiver.track.kind===u)):c.pc.getTransceivers().find((e=>e.receiver.track.kind===u)),i.replace||i.remove){if(!f){l.warn("Couldn't find a transceiver for track:",i);continue}if(!f.sender){l.warn("No sender in the transceiver for track:",i);continue}m=f.sender}if(p&&!f&&(f=c.pc.getTransceivers().find((e=>e.receiver.track.kind===u)),!f)){l.warn("Couldn't find a transceiver for track:",i);continue}let g=null,v=null;if(i.remove)l.log("Removing track from PeerConnection",i),v=m.track?m.track.id:null,await m.replaceTrack(null);else if(i.capture){if(i.gumGroup&&h[i.gumGroup]&&h[i.gumGroup].stream){let e=h[i.gumGroup].stream;g="audio"===i.type?e.getAudioTracks()[0]:e.getVideoTracks()[0],delete h[i.gumGroup].stream,delete h[i.gumGroup],delete i.gumGroup}else if(i.capture instanceof r)g=i.capture;else{d||(d=!0,a.consentDialog(!0));let e=l.trackConstraints(i),n=null;if("audio"===i.type||"video"===i.type){if(i.gumGroup){let t="audio"===i.type?"video":"audio";if(h[i.gumGroup]&&h[i.gumGroup][t]){let n=h[i.gumGroup][t],r=l.trackConstraints(n);e[t]=r[t]}}n=await t.mediaDevices.getUserMedia(e),i.gumGroup&&e.audio&&e.video&&(h[i.gumGroup].stream=n,delete i.gumGroup)}else n=await t.mediaDevices.getDisplayMedia(e);g="audio"===i.type?n.getAudioTracks()[0]:n.getVideoTracks()[0]}if(i.replace){await m.replaceTrack(g);let e="sendrecv";!1!==i.recv&&"inactive"!==f.direction&&"sendonly"!==f.direction||(e="sendonly"),f.setDirection?f.setDirection(e):f.direction=e}else{if(c.myStream||(c.myStream=new n),"audio"===u||!i.simulcast&&!i.svc)m=c.pc.addTrack(g,c.myStream),f=c.pc.getTransceivers().find((e=>e.sender===m));else if(i.simulcast){if("firefox"!==l.webRTCAdapter.browserDetails.browser){l.log("Enabling rid-based simulcasting:",g);let e=C(i.simulcastMaxBitrates);f=c.pc.addTransceiver(g,{direction:"sendrecv",streams:[c.myStream],sendEncodings:i.sendEncodings||[{rid:"h",active:!0,maxBitrate:e.high},{rid:"m",active:!0,maxBitrate:e.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:e.low,scaleResolutionDownBy:4}]})}else if(l.log("Enabling Simulcasting for Firefox (RID)"),f=c.pc.addTransceiver(g,{direction:"sendrecv",streams:[c.myStream]}),m=f?f.sender:null,m){let e=m.getParameters();e||(e={});let t=C(i.simulcastMaxBitrates);e.encodings=i.sendEncodings||[{rid:"h",active:!0,maxBitrate:t.high},{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:t.low,scaleResolutionDownBy:4}],m.setParameters(e)}}else l.log("Enabling SVC ("+i.svc+"):",g),f=c.pc.addTransceiver(g,{direction:"sendrecv",streams:[c.myStream],sendEncodings:[{scalabilityMode:i.svc}]});if(m||(m=f?f.sender:null),i.codec)if("firefox"===l.webRTCAdapter.browserDetails.browser)l.warn("setCodecPreferences not supported in Firefox, ignoring codec for track:",i);else if("string"!=typeof i.codec)l.warn("Invalid codec value, ignoring for track:",i);else{let e=u+"/"+i.codec.toLowerCase(),t=o.getCapabilities(u).codecs.filter((function(t){return t.mimeType.toLowerCase()===e}));if(t&&0!==t.length){if(f)try{f.setCodecPreferences(t)}catch(e){l.warn("Failed enforcing codec for this "+u+" track:",e)}}else l.warn("Codec not supported in this browser for this track, ignoring:",i)}if(i.bitrate)if(i.simulcast||i.svc)l.warn("Ignoring bitrate for simulcast/SVC track, use sendEncodings for that");else if(isNaN(i.bitrate)||i.bitrate<0)l.warn("Ignoring invalid bitrate for track:",i);else if(m){let e=m.getParameters();e&&e.encodings&&0!==e.encodings.length?(e.encodings[0].maxBitrate=i.bitrate,await m.setParameters(e)):l.warn("No encodings in the sender parameters, ignoring bitrate for track:",i)}if("video"===u&&i.framerate)if(i.simulcast||i.svc)l.warn("Ignoring framerate for simulcast/SVC track, use sendEncodings for that");else if(isNaN(i.framerate)||i.framerate<0)l.warn("Ignoring invalid framerate for track:",i);else if(m){let e=m.getParameters();e&&e.encodings&&0!==e.encodings.length?(e.encodings[0].maxFramerate=i.framerate,await m.setParameters(e)):l.warn("No encodings in the sender parameters, ignoring framerate for track:",i)}if(i.transforms){if(m&&i.transforms.sender){let e=null;s.prototype.createEncodedStreams?e=m.createEncodedStreams():(s.prototype.createAudioEncodedStreams||s.prototype.createEncodedVideoStreams)&&("audio"===u?e=m.createEncodedAudioStreams():"video"===u&&(e=m.createEncodedVideoStreams())),e&&(l.log("Insertable Streams sender transform:",e),e.readableStream&&e.writableStream?e.readableStream.pipeThrough(i.transforms.sender).pipeTo(e.writableStream):e.readable&&e.writable&&e.readable.pipeThrough(i.transforms.sender).pipeTo(e.writable))}if(f&&f.receiver&&i.transforms.receiver){let e=null;o.prototype.createEncodedStreams?e=f.receiver.createEncodedStreams():(o.prototype.createAudioEncodedStreams||o.prototype.createEncodedVideoStreams)&&("audio"===u?e=f.receiver.createEncodedAudioStreams():"video"===u&&(e=f.receiver.createEncodedVideoStreams())),e&&(l.log("Insertable Streams receiver transform:",e),e.readableStream&&e.writableStream?e.readableStream.pipeThrough(i.transforms.receiver).pipeTo(e.writableStream):e.readable&&e.writable&&e.readable.pipeThrough(i.transforms.receiver).pipeTo(e.writable))}}}g&&!0===i.dontStop&&(g.dontStop=!0)}else if(i.recv&&!f&&(f=c.pc.addTransceiver(u),f)){if(i.codec)if("firefox"===l.webRTCAdapter.browserDetails.browser)l.warn("setCodecPreferences not supported in Firefox, ignoring codec for track:",i);else if("string"!=typeof i.codec)l.warn("Invalid codec value, ignoring for track:",i);else{let e=u+"/"+i.codec.toLowerCase(),t=o.getCapabilities(u).codecs.filter((function(t){return t.mimeType.toLowerCase()===e}));if(t&&0!==t.length)try{f.setCodecPreferences(t)}catch(e){l.warn("Failed enforcing codec for this "+u+" track:",e)}else l.warn("Codec not supported in this browser for this track, ignoring:",i)}if(f.receiver&&i.transforms&&i.transforms.receiver){let e=null;o.prototype.createEncodedStreams?e=f.receiver.createEncodedStreams():(o.prototype.createAudioEncodedStreams||o.prototype.createEncodedVideoStreams)&&("audio"===u?e=f.receiver.createEncodedAudioStreams():"video"===u&&(e=f.receiver.createEncodedVideoStreams())),e&&(l.log("Insertable Streams receiver transform:",e),e.readableStream&&e.writableStream?e.readableStream.pipeThrough(i.transforms.receiver).pipeTo(e.writableStream):e.readable&&e.writable&&e.readable.pipeThrough(i.transforms.receiver).pipeTo(e.writable))}}if(v&&c.myStream){let e=null;if("audio"===u&&c.myStream.getAudioTracks()&&c.myStream.getAudioTracks().length)for(let t of c.myStream.getAudioTracks())t.id===v&&(e=t,l.log("Removing audio track:",e));else if("video"===u&&c.myStream.getVideoTracks()&&c.myStream.getVideoTracks().length)for(let t of c.myStream.getVideoTracks())t.id===v&&(e=t,l.log("Removing video track:",e));if(e){try{c.myStream.removeTrack(e),a.onlocaltrack(e,!1)}catch(e){l.error("Error calling onlocaltrack on removal for renegotiation",e)}if(!0!==e.dontStop)try{e.stop()}catch(e){}}}if(g){c.myStream.addTrack(g),g.onended=function(e){l.log("Local track removed:",e);try{a.onlocaltrack(e.target,!1)}catch(e){l.error("Error calling onlocaltrack following end",e)}};try{a.onlocaltrack(g,!0)}catch(e){l.error("Error calling onlocaltrack for track add",e)}}if(f){let e=f.direction,t=null,n=g&&f.sender.track,r=!1!==i.recv&&f.receiver.track;n&&r?t="sendrecv":n&&!r?t="sendonly":!n&&r?t="recvonly":n||r||(t="inactive"),t&&t!==e&&(l.warn("Changing direction of transceiver to "+t+" (was "+e+")",i),f.setDirection?f.setDirection(t):f.direction=t)}}d&&a.consentDialog(!1)}function J(e){let t=x[e];if(!t||!t.webrtcStuff)return l.warn("Invalid handle"),null;let n=t.webrtcStuff;if(!n.pc)return l.warn("Invalid PeerConnection"),null;let r=[],i=n.pc.getTransceivers();for(let e of i){let t=null;e.sender&&e.sender.track&&(t={mid:e.mid},t.type=e.sender.track.kind,t.id=e.sender.track.id,t.label=e.sender.track.label),t&&r.push(t)}return r}function H(e){let t=x[e];if(!t||!t.webrtcStuff)return l.warn("Invalid handle"),null;let n=t.webrtcStuff;if(!n.pc)return l.warn("Invalid PeerConnection"),null;let r=[],i=n.pc.getTransceivers();for(let e of i){let t=null;e.receiver&&e.receiver.track&&(t={mid:e.mid},t.type=e.receiver.track.kind,t.id=e.receiver.track.id,t.label=e.receiver.track.label),t&&r.push(t)}return r}function Z(e,t,n,r){r="function"==typeof r?r:l.noop;let i=x[e];if(!i||!i.webrtcStuff)return l.warn("Invalid handle"),void r(0);let o=n?"remote":"local",s=i.webrtcStuff;if(s.volume[o]||(s.volume[o]={value:0}),s.pc&&s.pc.getStats&&("chrome"===l.webRTCAdapter.browserDetails.browser||"safari"===l.webRTCAdapter.browserDetails.browser)){let e=s.pc;if(t){let i=s.pc.getTransceivers().find((e=>e.mid===t&&"audio"===e.receiver.track.kind));if(!i)return l.warn("No audio transceiver with mid "+t),void r(0);if(n&&!i.receiver)return l.warn("Remote transceiver track unavailable"),void r(0);if(!n&&!i.sender)return l.warn("Local transceiver track unavailable"),void r(0);e=n?i.receiver:i.sender}return e.getStats().then((function(e){e.forEach((function(e){e&&"audio"===e.kind&&(n&&!e.remoteSource||!n&&"media-source"!==e.type||r(e.audioLevel?e.audioLevel:0))}))})),s.volume[o].value}return l.warn("Getting the "+o+" volume unsupported by browser"),void r(0)}function X(e,t,n){let r=x[e];if(!r||!r.webrtcStuff)return l.warn("Invalid handle"),!0;let i=r.webrtcStuff;if(!i.pc)return l.warn("Invalid PeerConnection"),!0;if(!i.myStream)return l.warn("Invalid local MediaStream"),!0;if(n){if(!i.myStream.getVideoTracks()||0===i.myStream.getVideoTracks().length)return l.warn("No video track"),!0;if(t){let e=i.pc.getTransceivers().find((e=>e.mid===t&&"video"===e.receiver.track.kind));return e?e.sender&&e.sender.track?!e.sender.track.enabled:(l.warn("No video sender with mid "+t),!0):(l.warn("No video transceiver with mid "+t),!0)}return!i.myStream.getVideoTracks()[0].enabled}if(!i.myStream.getAudioTracks()||0===i.myStream.getAudioTracks().length)return l.warn("No audio track"),!0;if(t){let e=i.pc.getTransceivers().find((e=>e.mid===t&&"audio"===e.receiver.track.kind));return e?e.sender&&e.sender.track?!e.sender.track.enabled:(l.warn("No audio sender with mid "+t),!0):(l.warn("No audio transceiver with mid "+t),!0)}return!i.myStream.getAudioTracks()[0].enabled}function Y(e,t,n,r){let i=x[e];if(!i||!i.webrtcStuff)return l.warn("Invalid handle"),!1;let o=i.webrtcStuff;if(!o.pc)return l.warn("Invalid PeerConnection"),!1;if(!o.myStream)return l.warn("Invalid local MediaStream"),!1;if(n){if(!o.myStream.getVideoTracks()||0===o.myStream.getVideoTracks().length)return l.warn("No video track"),!1;if(t){let e=o.pc.getTransceivers().find((e=>e.mid===t&&"video"===e.receiver.track.kind));if(!e)return l.warn("No video transceiver with mid "+t),!1;if(!e.sender||!e.sender.track)return l.warn("No video sender with mid "+t),!1;e.sender.track.enabled=!r}else for(const e of o.myStream.getVideoTracks())e.enabled=!r}else{if(!o.myStream.getAudioTracks()||0===o.myStream.getAudioTracks().length)return l.warn("No audio track"),!1;if(t){let e=o.pc.getTransceivers().find((e=>e.mid===t&&"audio"===e.receiver.track.kind));if(!e)return l.warn("No audio transceiver with mid "+t),!1;if(!e.sender||!e.sender.track)return l.warn("No audio sender with mid "+t),!1;e.sender.track.enabled=!r}else for(const e of o.myStream.getAudioTracks())e.enabled=!r}return!0}function $(e,t){let n=x[e];if(!n||!n.webrtcStuff)return l.warn("Invalid handle"),"Invalid handle";let r=n.webrtcStuff;if(!r.pc)return"Invalid PeerConnection";if(r.pc.getStats){let e=r.pc,n=t||"default";if(t){let n=r.pc.getTransceivers().find((e=>e.mid===t&&"video"===e.receiver.track.kind));if(!n)return l.warn("No video transceiver with mid "+t),"No video transceiver with mid "+t;if(!n.receiver)return l.warn("No video receiver with mid "+t),"No video receiver with mid "+t;e=n.receiver}return r.bitrate[n]||(r.bitrate[n]={timer:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,value:"0 kbits/sec"}),r.bitrate[n].timer?r.bitrate[n].value:(l.log("Starting bitrate timer"+(t?" for mid "+t:"")+" (via getStats)"),r.bitrate[n].timer=setInterval((function(){e.getStats().then((function(e){e.forEach((function(e){if(!e)return;let t=!1;if(("video"===e.mediaType||e.id.toLowerCase().indexOf("video")>-1)&&"inbound-rtp"===e.type&&e.id.indexOf("rtcp")<0?t=!0:"ssrc"!=e.type||!e.bytesReceived||"VP8"!==e.googCodecName&&""!==e.googCodecName||(t=!0),t)if(r.bitrate[n].bsnow=e.bytesReceived,r.bitrate[n].tsnow=e.timestamp,null===r.bitrate[n].bsbefore||null===r.bitrate[n].tsbefore)r.bitrate[n].bsbefore=r.bitrate[n].bsnow,r.bitrate[n].tsbefore=r.bitrate[n].tsnow;else{let e=r.bitrate[n].tsnow-r.bitrate[n].tsbefore;"safari"===l.webRTCAdapter.browserDetails.browser&&(e/=1e3);let t=Math.round(8*(r.bitrate[n].bsnow-r.bitrate[n].bsbefore)/e);"safari"===l.webRTCAdapter.browserDetails.browser&&(t=parseInt(t/1e3)),r.bitrate[n].value=t+" kbits/sec",r.bitrate[n].bsbefore=r.bitrate[n].bsnow,r.bitrate[n].tsbefore=r.bitrate[n].tsnow}}))}))}),1e3),"0 kbits/sec")}return l.warn("Getting the video bitrate unsupported by browser"),"Feature unsupported by browser"}function K(e,t,n){let r=x[e];if(!r||!r.webrtcStuff)return void l.warn("Invalid handle");let i=r.webrtcStuff;if(!i.pc)return void l.warn("Invalid PeerConnection");let o=i.pc.getTransceivers().find((e=>e.mid===t));if(!o)return void l.warn("No transceiver with mid",t);if(!o.sender)return void l.warn("No sender for transceiver with mid",t);let s=o.sender.getParameters();s&&s.encodings&&0!==s.encodings.length?s.encodings.length>1?l.warn("Ignoring bitrate for simulcast track, use sendEncodings for that"):isNaN(n)||n<0?l.warn("Invalid bitrate (must be a positive integer)"):(s.encodings[0].maxBitrate=n,o.sender.setParameters(s)):l.warn("No parameters encodings")}function Q(e){l.error("WebRTC error:",e)}function ee(e,t){l.log("Cleaning WebRTC stuff");let n=x[e];if(!n)return;let r=n.webrtcStuff;if(r){if(!0===t){let t={janus:"hangup",transaction:l.randomString(12)};n.token&&(t.token=n.token),w&&(t.apisecret=w),l.debug("Sending hangup request (handle="+e+"):"),l.debug(t),a?(t.session_id=T,t.handle_id=e,c.send(JSON.stringify(t))):l.httpAPICall(p+"/"+T+"/"+e,{verb:"POST",withCredentials:y,body:t})}r.volume&&(r.volume.local&&r.volume.local.timer&&clearInterval(r.volume.local.timer),r.volume.remote&&r.volume.remote.timer&&clearInterval(r.volume.remote.timer));for(let e in r.bitrate)r.bitrate[e].timer&&clearInterval(r.bitrate[e].timer);r.bitrate={},!r.streamExternal&&r.myStream&&(l.log("Stopping local stream tracks"),l.stopAllTracks(r.myStream)),r.streamExternal=!1,r.myStream=null;try{r.pc.close()}catch(e){}r.pc=null,r.candidates=null,r.mySdp=null,r.remoteSdp=null,r.iceDone=!1,r.dataChannel={},r.dtmfSender=null,r.insertableStreams=!1}n.oncleanup()}D(e),this.getServer=function(){return p},this.isConnected=function(){return k},this.reconnect=function(e){(e=e||{}).success="function"==typeof e.success?e.success:l.noop,e.error="function"==typeof e.error?e.error:l.noop,e.reconnect=!0,D(e)},this.getSessionId=function(){return T},this.getInfo=function(e){!function(e){if(e=e||{},e.success="function"==typeof e.success?e.success:l.noop,e.error="function"==typeof e.error?e.error:l.noop,l.log("Getting info on Janus instance"),!k)return l.warn("Is the server down? (connected=false)"),void e.error("Is the server down? (connected=false)");let t=l.randomString(12),n={janus:"info",transaction:t};_&&(n.token=_);w&&(n.apisecret=w);if(a)return O[t]=function(t){l.log("Server info:"),l.debug(t),"server_info"!==t.janus&&l.error("Ooops: "+t.error.code+" "+t.error.reason),e.success(t)},void c.send(JSON.stringify(n));l.httpAPICall(p,{verb:"POST",withCredentials:y,body:n,success:function(t){l.log("Server info:"),l.debug(t),"server_info"!==t.janus&&l.error("Ooops: "+t.error.code+" "+t.error.reason),e.success(t)},error:function(t,n){l.error(t+":",n),""===n?e.error(t+": Is the server down?"):e.error(t+": "+n)}})}(e)},this.destroy=function(n){!function(n){n=n||{},n.success="function"==typeof n.success?n.success:l.noop,n.error="function"==typeof n.error?n.error:l.noop;let r=!0===n.unload,i=!0;void 0!==n.notifyDestroyed&&null!==n.notifyDestroyed&&(i=!0===n.notifyDestroyed);let o=!0===n.cleanupHandles;if(l.log("Destroying session "+T+" (unload="+r+")"),!T)return l.warn("No session to destroy"),n.success(),void(i&&e.destroyed());if(o)for(let e in x)B(e,{noRequest:!0});if(!k)return l.warn("Is the server down? (connected=false)"),T=null,void n.success();let s={janus:"destroy",transaction:l.randomString(12)};_&&(s.token=_);w&&(s.apisecret=w);if(r)return a?(c.onclose=null,c.close(),c=null):t.sendBeacon(p+"/"+T,JSON.stringify(s)),l.log("Destroyed session:"),T=null,k=!1,n.success(),void(i&&e.destroyed());if(a){s.session_id=T;let t=function(){for(let e in u)c.removeEventListener(e,u[e]);c.removeEventListener("message",r),c.removeEventListener("error",o),d&&clearTimeout(d),c.close()},r=function(r){let o=JSON.parse(r.data);o.session_id==s.session_id&&o.transaction==s.transaction&&(t(),n.success(),i&&e.destroyed())},o=function(){t(),n.error("Failed to destroy the server: Is the server down?"),i&&e.destroyed()};return c.addEventListener("message",r),c.addEventListener("error",o),void(1===c.readyState?c.send(JSON.stringify(s)):o())}l.httpAPICall(p+"/"+T,{verb:"POST",withCredentials:y,body:s,success:function(t){l.log("Destroyed session:"),l.debug(t),T=null,k=!1,"success"!==t.janus&&l.error("Ooops: "+t.error.code+" "+t.error.reason),n.success(),i&&e.destroyed()},error:function(t,r){l.error(t+":",r),T=null,k=!1,n.success(),i&&e.destroyed()}})}(n)},this.attach=function(e){!function(e){if(e=e||{},e.success="function"==typeof e.success?e.success:l.noop,e.error="function"==typeof e.error?e.error:l.noop,e.dataChannelOptions=e.dataChannelOptions||{ordered:!0},e.consentDialog="function"==typeof e.consentDialog?e.consentDialog:l.noop,e.iceState="function"==typeof e.iceState?e.iceState:l.noop,e.mediaState="function"==typeof e.mediaState?e.mediaState:l.noop,e.webrtcState="function"==typeof e.webrtcState?e.webrtcState:l.noop,e.slowLink="function"==typeof e.slowLink?e.slowLink:l.noop,e.onmessage="function"==typeof e.onmessage?e.onmessage:l.noop,e.onlocaltrack="function"==typeof e.onlocaltrack?e.onlocaltrack:l.noop,e.onremotetrack="function"==typeof e.onremotetrack?e.onremotetrack:l.noop,e.ondata="function"==typeof e.ondata?e.ondata:l.noop,e.ondataopen="function"==typeof e.ondataopen?e.ondataopen:l.noop,e.oncleanup="function"==typeof e.oncleanup?e.oncleanup:l.noop,e.ondetached="function"==typeof e.ondetached?e.ondetached:l.noop,!k)return l.warn("Is the server down? (connected=false)"),void e.error("Is the server down? (connected=false)");let t=e.plugin;if(!t)return l.error("Invalid plugin"),void e.error("Invalid plugin");let n=e.opaqueId,r=e.loopIndex,i=e.token?e.token:_,o=l.randomString(12),s={janus:"attach",plugin:t,opaque_id:n,loop_index:r,transaction:o};i&&(s.token=i);w&&(s.apisecret=w);if(a)return O[o]=function(n){if(l.debug(n),"success"!==n.janus)return l.error("Ooops: "+n.error.code+" "+n.error.reason),void e.error("Ooops: "+n.error.code+" "+n.error.reason);let r=n.data.id;l.log("Created handle: "+r);let o={session:I,plugin:t,id:r,token:i,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,mySdp:null,mediaConstraints:null,pc:null,dataChannelOptions:e.dataChannelOptions,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,bitrate:{}},getId:function(){return r},getPlugin:function(){return t},getVolume:function(e,t){return Z(r,e,!0,t)},getRemoteVolume:function(e,t){return Z(r,e,!0,t)},getLocalVolume:function(e,t){return Z(r,e,!1,t)},isAudioMuted:function(e){return X(r,e,!1)},muteAudio:function(e){return Y(r,e,!1,!0)},unmuteAudio:function(e){return Y(r,e,!1,!1)},isVideoMuted:function(e){return X(r,e,!0)},muteVideo:function(e){return Y(r,e,!0,!0)},unmuteVideo:function(e){return Y(r,e,!0,!1)},getBitrate:function(e){return $(r,e)},setMaxBitrate:function(e,t){return K(r,e,t)},send:function(e){N(r,e)},data:function(e){U(r,e)},dtmf:function(e){z(r,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){q(r,!0,e)},createAnswer:function(e){q(r,!1,e)},handleRemoteJsep:function(e){W(r,e)},replaceTracks:function(e){V(r,e)},getLocalTracks:function(){return J(r)},getRemoteTracks:function(){return H(r)},onlocaltrack:e.onlocaltrack,onremotetrack:e.onremotetrack,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){ee(r,!0===e)},detach:function(e){B(r,e)}};x[r]=o,e.success(o)},s.session_id=T,void c.send(JSON.stringify(s));l.httpAPICall(p+"/"+T,{verb:"POST",withCredentials:y,body:s,success:function(n){if(l.debug(n),"success"!==n.janus)return l.error("Ooops: "+n.error.code+" "+n.error.reason),void e.error("Ooops: "+n.error.code+" "+n.error.reason);let r=n.data.id;l.log("Created handle: "+r);let o={session:I,plugin:t,id:r,token:i,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,mySdp:null,mediaConstraints:null,pc:null,dataChannelOptions:e.dataChannelOptions,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,bitrate:{}},getId:function(){return r},getPlugin:function(){return t},getVolume:function(e,t){return Z(r,e,!0,t)},getRemoteVolume:function(e,t){return Z(r,e,!0,t)},getLocalVolume:function(e,t){return Z(r,e,!1,t)},isAudioMuted:function(e){return X(r,e,!1)},muteAudio:function(e){return Y(r,e,!1,!0)},unmuteAudio:function(e){return Y(r,e,!1,!1)},isVideoMuted:function(e){return X(r,e,!0)},muteVideo:function(e){return Y(r,e,!0,!0)},unmuteVideo:function(e){return Y(r,e,!0,!1)},getBitrate:function(e){return $(r,e)},setMaxBitrate:function(e,t){return K(r,e,t)},send:function(e){N(r,e)},data:function(e){U(r,e)},dtmf:function(e){z(r,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){q(r,!0,e)},createAnswer:function(e){q(r,!1,e)},handleRemoteJsep:function(e){W(r,e)},replaceTracks:function(e){V(r,e)},getLocalTracks:function(){return J(r)},getRemoteTracks:function(){return H(r)},onlocaltrack:e.onlocaltrack,onremotetrack:e.onremotetrack,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){ee(r,!0===e)},detach:function(e){B(r,e)}};x[r]=o,e.success(o)},error:function(t,n){l.error(t+":",n),""===n?e.error(t+": Is the server down?"):e.error(t+": "+n)}})}(e)}}return l.useDefaultDependencies=function(t){let n=t&&t.fetch||fetch,r=t&&t.Promise||Promise,i=t&&t.WebSocket||WebSocket;return{newWebSocket:function(e,t){return new i(e,t)},extension:t&&t.extension||c,isArray:function(e){return Array.isArray(e)},webRTCAdapter:t&&t.adapter||e,httpAPICall:function(e,t){let i={method:t.verb,headers:{Accept:"application/json, text/plain, */*"},cache:"no-cache"};"POST"===t.verb&&(i.headers["Content-Type"]="application/json"),void 0!==t.withCredentials&&(i.credentials=!0===t.withCredentials?"include":t.withCredentials?t.withCredentials:"omit"),t.body&&(i.body=JSON.stringify(t.body));let o=n(e,i).catch((function(e){return r.reject({message:"Probably a network error, is the server down?",error:e})}));if(t.timeout){let e=new r((function(e,n){let r=setTimeout((function(){return clearTimeout(r),n({message:"Request timed out",timeout:t.timeout})}),t.timeout)}));o=r.race([o,e])}return o.then((function(e){return e.ok?typeof t.success==typeof l.noop?e.json().then((function(e){try{t.success(e)}catch(e){l.error("Unhandled httpAPICall success callback error",e)}}),(function(t){return r.reject({message:"Failed to parse response body",error:t,response:e})})):void 0:r.reject({message:"API call failed",response:e})})).catch((function(e){typeof t.error==typeof l.noop&&t.error(e.message||"<< internal error >>",e)})),o}}},l.useOldDependencies=function(t){let n=t&&t.jQuery||jQuery,r=t&&t.WebSocket||WebSocket;return{newWebSocket:function(e,t){return new r(e,t)},isArray:function(e){return n.isArray(e)},extension:t&&t.extension||c,webRTCAdapter:t&&t.adapter||e,httpAPICall:function(e,t){let r=void 0!==t.body?{contentType:"application/json",data:JSON.stringify(t.body)}:{},i=void 0!==t.withCredentials?{xhrFields:{withCredentials:t.withCredentials}}:{};return n.ajax(n.extend(r,i,{url:e,type:t.verb,cache:!1,dataType:"json",async:t.async,timeout:t.timeout,success:function(e){typeof t.success==typeof l.noop&&t.success(e)},error:function(e,n,r){typeof t.error==typeof l.noop&&t.error(n,r)}}))}}},l.mediaToTracks=function(e){let t=[];if(e){if(!e.keepAudio&&!1!==e.audio&&(void 0===e.audio||e.audio||e.audioSend||e.audioRecv||e.addAudio||e.replaceAudio||e.removeAudio)){let n={type:"audio"};e.removeAudio?n.remove=!0:(e.addAudio?n.add=!0:e.replaceAudio&&(n.replace=!0),!1!==e.audioSend&&(n.capture=e.audio||!0),!1!==e.audioRecv&&(n.recv=!0)),(n.remove||n.capture||n.recv)&&t.push(n)}if(!e.keepVideo&&!1!==e.video&&(void 0===e.video||e.video||e.videoSend||e.videoRecv||e.addVideo||e.replaceVideo||e.removeVideo)){let n={type:"video"};e.removeVideo?n.remove=!0:(e.addVideo?n.add=!0:e.replaceVideo&&(n.replace=!0),!1!==e.videoSend&&(n.capture=e.video||!0,["screen","window","desktop"].includes(n.capture)&&(n.type="screen",n.capture={video:{}},e.screenshareFrameRate&&(n.capture.frameRate=e.screenshareFrameRate),e.screenshareHeight&&(n.capture.height=e.screenshareHeight),e.screenshareWidth&&(n.capture.width=e.screenshareWidth))),!1!==e.videoRecv&&(n.recv=!0)),(n.remove||n.capture||n.recv)&&t.push(n)}e.data&&t.push({type:"data"})}else t.push({type:"audio",capture:!0,recv:!0}),t.push({type:"video",capture:!0,recv:!0});return t},l.trackConstraints=function(e){let t={};if(!e||!e.capture)return t;if("audio"===e.type)t.audio=e.capture;else if("video"===e.type)if((e.simulcast||e.svc)&&!0===e.capture&&(e.capture="hires"),!0===e.capture||"object"==typeof e.capture)t.video=e.capture;else{let n=0,r=0;"lowres"===e.capture?(n=320,r=240):"lowres-16:9"===e.capture?(n=320,r=180):"hires"===e.capture||"hires-16:9"===e.capture||"hdres"===e.capture?(n=1280,r=720):"fhdres"===e.capture?(n=1920,r=1080):"4kres"===e.capture?(n=3840,r=2160):"stdres"===e.capture?(n=640,r=480):"stdres-16:9"===e.capture?(n=640,r=360):(l.log("Default video setting is stdres 4:3"),n=640,r=480),t.video={width:{ideal:n},height:{ideal:r}}}else"screen"===e.type&&(t.video=e.capture);return t},l.noop=function(){},l.dataChanDefaultLabel="JanusDataChannel",l.endOfCandidates=null,l.stopAllTracks=function(e){try{let t=e.getTracks();for(let e of t)l.log(e),e&&!0!==e.dontStop&&e.stop()}catch(e){}},l.init=function(e){if((e=e||{}).callback="function"==typeof e.callback?e.callback:l.noop,l.initDone)e.callback();else{if(void 0===console.log&&(console.log=function(){}),l.trace=l.noop,l.debug=l.noop,l.vdebug=l.noop,l.log=l.noop,l.warn=l.noop,l.error=l.noop,!0===e.debug||"all"===e.debug)l.trace=console.trace.bind(console),l.debug=console.debug.bind(console),l.vdebug=console.debug.bind(console),l.log=console.log.bind(console),l.warn=console.warn.bind(console),l.error=console.error.bind(console);else if(Array.isArray(e.debug))for(let t of e.debug)switch(t){case"trace":l.trace=console.trace.bind(console);break;case"debug":l.debug=console.debug.bind(console);break;case"vdebug":l.vdebug=console.debug.bind(console);break;case"log":l.log=console.log.bind(console);break;case"warn":l.warn=console.warn.bind(console);break;case"error":l.error=console.error.bind(console);break;default:console.error("Unknown debugging option '"+t+"' (supported: 'trace', 'debug', 'vdebug', 'log', warn', 'error')")}l.log("Initializing library");let n=e.dependencies||l.useDefaultDependencies();if(l.isArray=n.isArray,l.webRTCAdapter=n.webRTCAdapter,l.httpAPICall=n.httpAPICall,l.newWebSocket=n.newWebSocket,l.extension=n.extension,l.extension.init(),l.listDevices=function(e,n){e="function"==typeof e?e:l.noop,n||(n={audio:!0,video:!0}),l.isGetUserMediaAvailable()?t.mediaDevices.getUserMedia(n).then((function(n){t.mediaDevices.enumerateDevices().then((function(t){l.debug(t),e(t),l.stopAllTracks(n)}))})).catch((function(t){l.error(t),e([])})):(l.warn("navigator.mediaDevices unavailable"),e([]))},l.safariVp8=!1,"safari"===l.webRTCAdapter.browserDetails.browser&&l.webRTCAdapter.browserDetails.version>=605)if(s&&s.getCapabilities&&s.getCapabilities("video")&&s.getCapabilities("video").codecs&&s.getCapabilities("video").codecs.length){for(let e of s.getCapabilities("video").codecs)if(e&&e.mimeType&&"video/vp8"===e.mimeType.toLowerCase()){l.safariVp8=!0;break}l.safariVp8?l.log("This version of Safari supports VP8"):l.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu")}else{let e=new i({});e.createOffer({offerToReceiveVideo:!0}).then((function(t){l.safariVp8=-1!==t.sdp.indexOf("VP8"),l.safariVp8?l.log("This version of Safari supports VP8"):l.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu"),e.close(),e=null}))}l.initDone=!0,e.callback()}},l.isWebrtcSupported=function(){return!!i},l.isGetUserMediaAvailable=function(){return t.mediaDevices&&t.mediaDevices.getUserMedia},l.randomString=function(e){let t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n="";for(let r=0;r<e;r++){let e=Math.floor(62*Math.random());n+=t.charAt(e)}return n},xu=l}(),ju=D(Mu);!function(e){e.VIDEO="video",e.AUDIO="audio"}(Au||(Au={})),function(e){e.VIDEO="videoinput",e.AUDIO="audioinput"}(Lu||(Lu={})),function(e){e.PARTICIPANT_JOINED="participant_joined",e.PARTICIPANT_LEFT="participant_left",e.LOCAL_STREAM="local_stream",e.REMOTE_STREAM="remote_stream",e.REMOTE_TRACKS_UPDATED="remote_tracks_updated",e.DATA_CHANNEL_OPEN="data_channel_open",e.DATA_CHANNEL_MESSAGE="data_channel_message",e.ERROR="error"}(Pu||(Pu={})),function(e){e.CREATED="created",e.ENDED="ended",e.MUTE="mute",e.UNMUTE="unmute"}(Du||(Du={})),function(e){e.JOIN="join",e.LEFT="left",e.SLOW_LINK="slow-link",e.REMOTE_TRACKS_UPDATED="remote-tracks",e.REMOTE_STREAM="remote-stream",e.REMOTE_CONNECTION_STATE="remote-connection-state",e.DATA_CHANNEL_OPENED="data-channel-opened",e.DATA_CHANNEL_MESSAGE="data-channel-message",e.SESSION_CONNECTION_STATE="session-connection-state",e.ERROR="error"}(Nu||(Nu={}));var Uu,zu,Bu,Fu,qu,Wu,Vu=function(){function e(e){var t;if(this.videoRoomPlugin=null,this.isOnlyAudio=!1,this.currentRoomId=null,this.currentUserId=null,this.remoteFeeds={},this.remoteJseps={},this.remoteFeedsAttachingInProgress={},this.bitrateTimers={},this.emitter=new sr,!O.env.isReactNative&&!_)throw"Error: in order to use this library please connect adapter.js. More info https://github.com/webrtc/adapter";if(this.token=e,this.server=E.conference.server,this.debug=null!==(t=E.conference.debug)&&void 0!==t?t:n.ALL,!this.server)throw"'server' parameter is mandatory";this.server.includes("http")&&(this.server+="/janus")}return e.prototype.createSession=function(e){var t=this,n=e.success,r=void 0===n?function(){}:n,i=e.error,o=void 0===i?function(){}:i,s=e.destroyed,a=void 0===s?function(){}:s,c=e.timeoutSessionCallback,l=void 0===c?function(){}:c;ju.init({debug:this.debug,callback:function(){ju.isWebrtcSupported()?t.engine=new ju({server:t.server,iceServers:E.videochat.iceServers,token:t.token,success:function(){return O.safeCallbackCall(r)()},error:function(e){return O.safeCallbackCall(o)(e)},destroyed:function(){return O.safeCallbackCall(a)()},timeoutSessionCallback:function(){return O.safeCallbackCall(l)()}}):O.safeCallbackCall(o)("Your browser does not support WebRTC, so you can't use this functionality.")}})},e.prototype.getSessionId=function(){var e,t;return null!==(t=null===(e=this.engine)||void 0===e?void 0:e.getSessionId())&&void 0!==t?t:null},e.prototype.destroySession=function(e){var t=e.success,n=void 0===t?function(){}:t,r=e.error,i=void 0===r?function(){}:r;this.engine.destroy({success:function(){return O.safeCallbackCall(n)()},error:function(e){return O.safeCallbackCall(i)(e)}})},e.prototype.attachVideoConferencingPlugin=function(e,t,n,r){var i=this,o=null,s=r.localStream;delete r.localStream;var a=r.displayName;delete r.displayName,this.engine.attach({plugin:"janus.plugin.videoroom",success:function(n){if(e){(o=n).userId=t,i.remoteFeedsAttachingInProgress[t]=o;var s={request:"join",room:i.currentRoomId,ptype:"listener",feed:t,display:a};null==o||o.send({message:s})}else i.videoRoomPlugin=n;O.safeCallbackCall(r.success)()},error:function(e){O.safeCallbackCall(r.error)(e)},consentDialog:function(e){O.safeCallbackCall(r.consentDialog)(e)},mediaState:function(e,t){O.safeCallbackCall(r.mediaState)(e,t)},webrtcState:function(e){O.safeCallbackCall(r.webrtcState)(e)},slowLink:function(e,t){O.safeCallbackCall(r.slowLink)(e,t)},iceState:function(e){O.safeCallbackCall(r.iceState)(e)},onmessage:function(t,o){var a=t.videoroom;if(e){if(a)if("attached"===a){var c=t.id;i.remoteFeeds[c]=i.remoteFeedsAttachingInProgress[c],i.remoteFeedsAttachingInProgress[c]=null}else t.error&&O.safeCallbackCall(r.error)(t.error);if(o){c=t.id;i.remoteJseps[c]=o,i.createAnswer({remoteFeed:i.remoteFeeds[c],jsep:o},s,{success:function(){},error:function(e){O.safeCallbackCall(r.error)(e)}})}}else{if(a)if("joined"===a){var l={media:n?{audio:!1,video:!1}:{audio:!0,video:!0},stream:n?void 0:s};i.createOffer(l,{success:function(){if(t.publishers){var e=t.publishers;for(var n in e){var r=e[n].id,o=e[n].display;i.emitter.emit(Pu.PARTICIPANT_JOINED,r,o,!0)}}},error:function(e){O.safeCallbackCall(r.error)(e)}})}else if("event"===a)if(t.publishers){var u=t.publishers;for(var d in u){var h=u[d].id,f=u[d].display;i.emitter.emit(Pu.PARTICIPANT_JOINED,h,f,!1)}}else if(t.leaving){c=t.leaving;i.detachRemoteFeed(c)&&i.emitter.emit(Pu.PARTICIPANT_LEFT,c,null)}else if(t.unpublished){if("ok"!=(c=t.unpublished))i.detachRemoteFeed(c)&&i.emitter.emit(Pu.PARTICIPANT_LEFT,c,null)}else t.error&&(O.DLog("[janus error message]",t.error),i.emitter.emit(Pu.ERROR,t),O.safeCallbackCall(r.error)(t.error));o&&i.videoRoomPlugin.handleRemoteJsep({jsep:o})}},onlocaltrack:function(e,t){O.DLog("[onlocaltrack]",e,t),i.onLocalTrack(e,t)},onremotetrack:function(e,t,n,r){O.DLog("[onremotetrack]",e,t,n,r),i.onRemoteTrack(o,e,t,n,r)},ondataopen:function(e){O.DLog("[ondataopen]",e),i.emitter.emit(Pu.DATA_CHANNEL_OPEN,e)},ondata:function(e,t){O.DLog("[ondata]",t,e),i.emitter.emit(Pu.DATA_CHANNEL_MESSAGE,t,e)},oncleanup:function(){O.safeCallbackCall(r.oncleanup)()},detached:function(){}})},e.prototype.onLocalTrack=function(e,t){},e.prototype.onRemoteTrack=function(e,t,n,r,i){var o,s=i&&i.reason;if(s===Du.CREATED){var a=!e.stream||!e.tracks;a?(e.tracks=((o={})[n]=t,o),e.stream=new h([t])):(e.tracks[n]=t,e.stream.addTrack(t)),a&&this.emitter.emit(Pu.REMOTE_STREAM,e.userId,e.stream)}else if(s===Du.ENDED){delete e.tracks[n];var c=e.stream.getTracks().find((function(e){return e.kind===t.kind}));e.stream.removeTrack(c)}this.emitter.emit(Pu.REMOTE_TRACKS_UPDATED,e.userId,t,s)},e.prototype.getPluginId=function(){var e,t;return null!==(t=null===(e=this.videoRoomPlugin)||void 0===e?void 0:e.getId())&&void 0!==t?t:null},e.prototype.detachVideoConferencingPlugin=function(e){var t=this,n=function(){t.videoRoomPlugin=null,Object.keys(t.remoteFeeds).forEach((function(e){t.detachRemoteFeed(Number(e))})),t.remoteFeeds={},t.remoteJseps={}};this.videoRoomPlugin.detach({success:function(){n(),O.safeCallbackCall(e.success)()},error:function(t){n(),O.safeCallbackCall(e.error)(t)}})},e.prototype.join=function(e,t,n,r){var i=this,o=r.displayName;delete r.displayName,this.isOnlyAudio=n,O.DLog("isOnlyAudio: "+this.isOnlyAudio);var s={request:"join",room:e,ptype:"publisher",id:t,display:o};this.videoRoomPlugin.send({message:s,success:function(n){i.currentRoomId=e,i.currentUserId=t,O.safeCallbackCall(r.success)()},error:function(e){O.safeCallbackCall(r.error)(e)}})},e.prototype.leave=function(e){if(O.DLog("leave"),this.engine.isConnected()){var t={request:"leave",room:this.currentRoomId,id:this.currentUserId};this.videoRoomPlugin&&this.videoRoomPlugin.send({message:t}),this.currentRoomId=null,this.currentUserId=null,O.safeCallbackCall(e.success)()}else O.safeCallbackCall(e.success)()},e.prototype.listOnlineParticipants=function(e,t){var n={request:"listparticipants",room:e};this.videoRoomPlugin.send({message:n,success:function(e){var n=e?e.participants:[];O.safeCallbackCall(t.success)(n)},error:function(e){O.safeCallbackCall(t.error)(e)}})},e.prototype.toggleAudioMute=function(){return this.videoRoomPlugin.isAudioMuted()?this.videoRoomPlugin.unmuteAudio():this.videoRoomPlugin.muteAudio(),this.videoRoomPlugin.isAudioMuted()},e.prototype.isAudioMuted=function(){return this.videoRoomPlugin.isAudioMuted()},e.prototype.toggleRemoteAudioMute=function(e){var t=this.remoteFeeds[e];if(!t)return!1;var n=t.stream.getAudioTracks();if(n&&n.length>0){for(var r=0;r<n.length;++r)n[r].enabled=!n[r].enabled;return!n[0].enabled}return!1},e.prototype.isRemoteAudioMuted=function(e){var t=this.remoteFeeds[e];if(!t)return!1;var n=t.stream.getAudioTracks();return!!(n&&n.length>0)&&!n[0].enabled},e.prototype.toggleVideoMute=function(){return this.videoRoomPlugin.isVideoMuted()?this.videoRoomPlugin.unmuteVideo():this.videoRoomPlugin.muteVideo(),this.videoRoomPlugin.isVideoMuted()},e.prototype.isVideoMuted=function(){return this.videoRoomPlugin.isVideoMuted()},e.prototype.toggleRemoteVideoMute=function(e){var t=this.remoteFeeds[e];if(!t)return!1;var n=t.stream.getVideoTracks();if(n&&n.length>0){for(var r=0;r<n.length;++r)n[r].enabled=!n[r].enabled;return!n[0].enabled}return!1},e.prototype.isRemoteVideoMuted=function(e){var t=this.remoteFeeds[e];if(!t)return!1;var n=t.stream.getVideoTracks();return!!(n&&n.length>0)&&!n[0].enabled},e.prototype.sendKeyframeRequest=function(e,t){var n={request:"configure",room:e,keyframe:!0};this.videoRoomPlugin.send({message:n,success:function(e){O.safeCallbackCall(t.success)(e)},error:function(e){O.safeCallbackCall(t.error)(e)}})},e.prototype.getTracksFromStream=function(e){var t=[],n=e.getAudioTracks();if(n.length){var r=n[0];t.push({type:"audio",capture:r,recv:!1})}var i=e.getVideoTracks();if(i.length){var o=i[0];t.push({type:"video",capture:o,recv:!1})}return t},e.prototype.createOffer=function(e,t){var n=this;O.DLog("[JanusWrapper][createOffer]",e);var r=e.stream,i=e.media,o=e.replace,s={tracks:[{type:"data"}]};if(r){var a=this.getTracksFromStream(r);s.tracks=s.tracks.concat(a)}else if(i){var c=[];i.audio&&c.push({type:"audio",capture:i.audio,recv:!1,replace:!!o}),i.video&&c.push({type:"video",capture:i.video,recv:!1,replace:!!o}),s.tracks=s.tracks.concat(c)}else s.tracks=s.tracks.concat([{type:"audio",capture:!0,recv:!1,replace:!!o},{type:"video",capture:!0,recv:!1,replace:!!o}]);O.DLog("[JanusWrapper][createOffer][params]",s),s.customizeSdp=function(e){},s.success=function(e){var r={request:"configure",audio:!!i.audio,video:!!i.video};O.DLog("[JanusWrapper][createOffer][success]",r),n.videoRoomPlugin.send({message:r,jsep:e}),O.safeCallbackCall(t.success)()},s.error=function(e){O.DLog("[JanusWrapper][createOffer][error]",e),i.audio?n.createOffer({media:{video:!1,audio:!1}},t):O.safeCallbackCall(t.error)(e)},this.videoRoomPlugin.createOffer(s)},e.prototype.getTracksMidsFromStream=function(e){var t=[],n=e.getAudioTracks();if(n.length){var r=n[0];t.push({type:"audio",mid:r.id,recv:!0})}var i=e.getVideoTracks();if(i.length){var o=i[0];t.push({type:"video",mid:o.id,recv:!0})}return t},e.prototype.createAnswer=function(e,t,n){var r=this,i=e.remoteFeed,o=e.jsep;O.DLog("[JanusWrapper][createAnswer]",o,t);var s=[{type:"data"}];if(t){var a=this.getTracksMidsFromStream(t);s=s.concat(a)}O.DLog("[JanusWrapper][createAnswer][tracks]",s),i.createAnswer({jsep:o,tracks:s,success:function(e){var t={request:"start",room:r.currentRoomId};O.DLog("[JanusWrapper][createAnswer][success]",t),i.send({message:t,jsep:e}),O.safeCallbackCall(n.success)()},error:function(e){O.DLog("[JanusWrapper][createAnswer][error]",e),O.safeCallbackCall(n.error)(e)}})},e.prototype.detachRemoteFeed=function(e){var t=this.remoteFeeds[e];return!!t&&(t.detach(),this.remoteFeeds[e]=null,this.remoteJseps[e]=null,!0)},e.prototype.getUserBitrate=function(e){return this.remoteFeeds[e].getBitrate()},e.prototype.getVolume=function(e){return this.videoRoomPlugin.getLocalVolume(null,e)},e.prototype.getUserVolume=function(e,t){return this.remoteFeeds[e].getRemoteVolume(null,t)},e.prototype.showBitrate=function(e,t){var n=this.remoteFeeds[e];O.env.isReactNative||"chrome"!==_.browserDetails.browser&&"firefox"!==_.browserDetails.browser||(this.bitrateTimers[e]=setInterval((function(){var e=n.getBitrate();t.text(e)}),1e3))},e.prototype.hideBitrate=function(e,t){this.bitrateTimers[e]&&clearInterval(this.bitrateTimers[e]),this.bitrateTimers[e]=null,t.text=null},e.prototype.on=function(e,t){return this.emitter.addListener(e,t)},e.prototype.removeAllListeners=function(e){return this.emitter.removeAllListeners(e)},e}(),Gu=function(){function e(e){var t=this;this.id="".concat(Math.random()),this.mediaParams={},this.onParticipantJoined=function(e,n,r){O.DLog("[onParticipantJoined]",e,n,r),t.createHandler(e,!0,!1),O.safeCallbackCall(t.onParticipantJoinedListener)(t,e,n,r)},this.onParticipantLeft=function(e,n){O.DLog("[onParticipantLeft]",e,n),O.safeCallbackCall(t.onParticipantLeftListener)(t,e,n)},this.onError=function(e){O.DLog("[onError]",JSON.stringify(e)),O.safeCallbackCall(t.onErrorListener)(t,e)},this.onDataChannelOpen=function(e){O.DLog("[onDataChannelOpen]",e),O.safeCallbackCall(t.onDataChannelOpenedListener)(t,e)},this.onDataChannelMessage=function(e,n){O.DLog("[onDataChannelMessage]",e,n),O.safeCallbackCall(t.onDataChannelMessageListener)(t,e,n)},this.onLocalIceStateChanged=function(e){O.DLog("[onLocalIceStateChanged]",e),O.safeCallbackCall(t.onSessionConnectionStateChangedListener)(t,e)},this.onRemoteIceStateChanged=function(e,n){O.DLog("[onRemoteIceStateChanged]",e,n),O.safeCallbackCall(t.onRemoteConnectionStateChangedListener)(t,e,n)},this.onRemoteStream=function(e,n){O.DLog("[onRemoteStream]",e,n),O.safeCallbackCall(t.onRemoteStreamListener)(t,e,n)},this.onRemoteTracksUpdated=function(e,n,r){O.DLog("[onRemoteTracksUpdated]",e,n,r),O.safeCallbackCall(t.onRemoteTracksUpdatedListener)(t,e,n,r)},this.onSlowLink=function(e,n,r){O.DLog("[onSlowLink]",e,n,r),O.safeCallbackCall(t.onSlowLinkListener)(t,e,n,r)},this.client=new Vu(e),this.client.on(Pu.PARTICIPANT_JOINED,this.onParticipantJoined),this.client.on(Pu.PARTICIPANT_LEFT,this.onParticipantLeft),this.client.on(Pu.REMOTE_STREAM,this.onRemoteStream),this.client.on(Pu.REMOTE_TRACKS_UPDATED,this.onRemoteTracksUpdated),this.client.on(Pu.DATA_CHANNEL_OPEN,this.onDataChannelOpen),this.client.on(Pu.DATA_CHANNEL_MESSAGE,this.onDataChannelMessage),this.client.on(Pu.ERROR,this.onError)}return Object.defineProperty(e.prototype,"currentRoomId",{get:function(){return this.client.currentRoomId},set:function(e){this.client.currentRoomId=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currentPublisherPC",{get:function(){return this.client.videoRoomPlugin.webrtcStuff.pc},enumerable:!1,configurable:!0}),e.prototype.createSession=function(){return k(this,void 0,void 0,(function(){var e,t=this;return T(this,(function(n){return e=!1,[2,new Promise((function(n,r){t.client.createSession({success:function(){e=!0,n(void 0)},error:function(n){e?t.onError(n):r(n)}})}))]}))}))},e.prototype.join=function(e,t,n){return k(this,void 0,void 0,(function(){return T(this,(function(r){switch(r.label){case 0:return this.currentUserDisplayName=n,this.currentRoomId=e,[4,this.createSession()];case 1:return r.sent(),[4,this.createHandler(t,!1,!1)];case 2:return r.sent(),[4,this.joinInternal(this.currentRoomId,t)];case 3:return r.sent(),[2]}}))}))},e.prototype.joinAsListener=function(e,t,n){return k(this,void 0,void 0,(function(){return T(this,(function(r){switch(r.label){case 0:return this.currentUserDisplayName=n,this.currentRoomId=e,[4,this.createSession()];case 1:return r.sent(),[4,this.createHandler(t,!1,!0)];case 2:return r.sent(),[4,this.joinInternal(this.currentRoomId,t)];case 3:return r.sent(),[2]}}))}))},e.prototype.sendKeyframeRequest=function(e){return k(this,void 0,void 0,(function(){var t=this;return T(this,(function(n){return[2,new Promise((function(n,r){t.client.sendKeyframeRequest(e,{success:n,error:r})}))]}))}))},e.prototype.createHandler=function(e,t){return k(this,arguments,void 0,(function(e,t,n){var r=this;return void 0===n&&(n=!1),T(this,(function(i){return[2,new Promise((function(i,o){r.client.attachVideoConferencingPlugin(t,e,n,{success:i,error:o,iceState:t?function(t){return r.onRemoteIceStateChanged(e,t)}:function(e){return r.onLocalIceStateChanged(e)},slowLink:t?function(t,n){return r.onSlowLink(e,t,n)}:function(e,t){return r.onSlowLink(null,e,t)},localStream:r.localStream,displayName:r.currentUserDisplayName})}))]}))}))},e.prototype.joinInternal=function(e,t){return k(this,void 0,void 0,(function(){var n=this;return T(this,(function(r){return[2,new Promise((function(r,i){n.client.join(e,t,!1,{success:r,error:i,displayName:n.currentUserDisplayName})}))]}))}))},e.prototype.listOfOnlineParticipants=function(){return k(this,void 0,void 0,(function(){var e=this;return T(this,(function(t){return[2,new Promise((function(t,n){e.currentRoomId?e.client.listOnlineParticipants(e.currentRoomId,{success:t,error:n}):n("Room ID is not set")}))]}))}))},e.prototype.leave=function(){return k(this,void 0,void 0,(function(){return T(this,(function(e){switch(e.label){case 0:return this.currentRoomId=null,this.currentUserDisplayName=void 0,[4,this.leaveGroup()];case 1:return e.sent(),[4,this.detachVideoConferencingPlugin()];case 2:return e.sent(),[4,this.destroy()];case 3:return e.sent(),this.localStream&&(this.localStream.getTracks().forEach((function(e){return e.stop()})),this.localStream=void 0,this.mediaParams={}),[2]}}))}))},e.prototype.leaveGroup=function(){return k(this,void 0,void 0,(function(){var e=this;return T(this,(function(t){return[2,new Promise((function(t,n){e.client.leave({success:t,error:n})}))]}))}))},e.prototype.destroy=function(){return k(this,void 0,void 0,(function(){var e=this;return T(this,(function(t){return[2,new Promise((function(t,n){e.client.destroySession({success:t,error:n})}))]}))}))},e.prototype.detachVideoConferencingPlugin=function(){return k(this,void 0,void 0,(function(){var e=this;return T(this,(function(t){return[2,new Promise((function(t,n){e.client.detachVideoConferencingPlugin({success:t,error:n})}))]}))}))},e.prototype.getDisplayMedia=function(e){return k(this,void 0,void 0,(function(){var t,n,r,i;return T(this,(function(o){switch(o.label){case 0:if(!d.getDisplayMedia)throw new Error("Your environment does not support 'getDisplayMedia' API");t=e&&e.elementId,n=e&&e.options,r=C({},e),this.mediaParams=r,delete r.elementId,delete r.options,o.label=1;case 1:return o.trys.push([1,3,,4]),[4,d.getDisplayMedia(r)];case 2:return i=o.sent(),[2,this.upsertStream(i,t,n)];case 3:throw o.sent();case 4:return[2]}}))}))},e.prototype.getUserMedia=function(e){return k(this,void 0,void 0,(function(){var t,n,r,i;return T(this,(function(o){switch(o.label){case 0:t=e&&e.elementId,n=e&&e.options,r=C({},e),this.mediaParams=r,delete r.elementId,delete r.options,o.label=1;case 1:return o.trys.push([1,3,,4]),[4,d.getUserMedia(r)];case 2:return i=o.sent(),[2,this.upsertStream(i,t,n)];case 3:throw o.sent();case 4:return[2]}}))}))},e.prototype.upsertStream=function(e,t,n){void 0===t&&(t=null),void 0===n&&(n={});var r=!!this.localStream;if(r?this.replaceTracks(e):this.localStream=e,!this.localStream)throw new Error("Local stream is not defined");return t&&(r&&this.detachMediaStream(t,n),this.attachMediaStream(t,this.localStream,n)),this.localStream},e.prototype.replaceTracks=function(e){var t,n=this;if(null===(t=this.localStream)||void 0===t||t.getTracks().forEach((function(t){var r;t.kind===Au.AUDIO&&0===e.getAudioTracks().length||(t.stop(),null===(r=n.localStream)||void 0===r||r.removeTrack(t))})),e.getTracks().forEach((function(e){var t,r,i,o,s,a=n.currentPublisherPC.getSenders().find((function(t){var n=t.track;return e.kind===n.kind}));e.kind===Au.AUDIO?e.enabled=null===(r=null===(t=n.localStream)||void 0===t?void 0:t.getAudioTracks().every((function(e){return e.enabled})))||void 0===r||r:e.enabled=null===(o=null===(i=n.localStream)||void 0===i?void 0:i.getVideoTracks().every((function(e){return e.enabled})))||void 0===o||o,a?(a.replaceTrack(e),null===(s=n.localStream)||void 0===s||s.addTrack(e)):console.warn("No sender found for track kind: ".concat(e.kind))})),!this.localStream)throw new Error("Local stream is not defined");return this.localStream},e.prototype.switchMediaTracks=function(e){return k(this,void 0,void 0,(function(){var t,n,r,i,o,s,a=this;return T(this,(function(c){switch(c.label){case 0:[Au.AUDIO,Au.VIDEO].forEach((function(t){var n,r=t===Au.AUDIO?e.audio:t===Au.VIDEO?e.video:{},i="string"==typeof r?r:null!==(n=null==r?void 0:r.deviceId)&&void 0!==n?n:null;i&&("object"==typeof a.mediaParams[t]?a.mediaParams[t].deviceId=i:a.mediaParams[t]={deviceId:i})})),c.label=1;case 1:return c.trys.push([1,3,,4]),t={audio:null!==(i=null===(r=this.mediaParams)||void 0===r?void 0:r.audio)&&void 0!==i&&i,video:null!==(s=null===(o=this.mediaParams)||void 0===o?void 0:o.video)&&void 0!==s&&s},[4,d.getDisplayMedia(t)];case 2:return n=c.sent(),[2,this.replaceTracks(n)];case 3:throw c.sent();case 4:return[2]}}))}))},e.prototype.muteVideo=function(){this.isVideoMuted()||this.client.toggleVideoMute()},e.prototype.unmuteVideo=function(){this.isVideoMuted()&&this.client.toggleVideoMute()},e.prototype.muteAudio=function(){this.isAudioMuted()||this.client.toggleAudioMute()},e.prototype.unmuteAudio=function(){this.isAudioMuted()&&this.client.toggleAudioMute()},e.prototype.isVideoMuted=function(){return this.client.isVideoMuted()},e.prototype.isAudioMuted=function(){return this.client.isAudioMuted()},e.prototype.getUserVolume=function(){return k(this,void 0,void 0,(function(){var e=this;return T(this,(function(t){return[2,new Promise((function(t,n){return e.client.getVolume(t)}))]}))}))},e.prototype.getRemoteUserBitrate=function(e){return this.client.getUserBitrate(e)},e.prototype.getRemoteUserVolume=function(e){return k(this,void 0,void 0,(function(){var t=this;return T(this,(function(n){return[2,new Promise((function(n,r){return t.client.getUserVolume(e,n)}))]}))}))},e.prototype.attachMediaStream=function(e,t,n){var r=document.getElementById(e);if(!("srcObject"in r))throw new Error("Unable to attach media stream, element #".concat(e," is undefined"));r.srcObject=t,r.style.transform=(null==n?void 0:n.mirror)?"scaleX(-1)":"none","boolean"==typeof(null==n?void 0:n.muted)&&(r.muted=null==n?void 0:n.muted),r.onloadedmetadata=function(e){r.play()}},e.prototype.detachMediaStream=function(e,t){var n=document.getElementById(e);if(!("srcObject"in n))throw new Error("Unable to attach media stream, element #".concat(e," is undefined"));n.pause(),n.srcObject=null,n.style.transform=(null==t?void 0:t.mirror)?"scaleX(-1)":"none","boolean"==typeof(null==t?void 0:t.muted)&&(n.muted=null==t?void 0:t.muted)},e.prototype.sendData=function(e,t){return k(this,void 0,void 0,(function(){var n=this;return T(this,(function(r){return[2,new Promise((function(r,i){n.client.videoRoomPlugin.data({data:e,label:t,success:r,error:i})}))]}))}))},e}(),Ju=function(){function e(e){this.DeviceInputType=Lu,this.CallType=Au,this.sessionsStore={},this.proxy=e}return e.prototype.createNewSession=function(){var e=new Gu(this.getCurrentSessionToken());return this.sessionsStore[e.id]=e,e.onParticipantJoinedListener=this.onParticipantJoinedListener,e.onParticipantLeftListener=this.onParticipantLeftListener,e.onSlowLinkListener=this.onSlowLinkListener,e.onRemoteStreamListener=this.onRemoteStreamListener,e.onRemoteTracksUpdatedListener=this.onRemoteTracksUpdatedListener,e.onRemoteConnectionStateChangedListener=this.onRemoteConnectionStateChangedListener,e.onDataChannelOpenedListener=this.onDataChannelOpenedListener,e.onDataChannelMessageListener=this.onDataChannelMessageListener,e.onSessionConnectionStateChangedListener=this.onSessionConnectionStateChangedListener,e.onErrorListener=this.onErrorListener,e},e.prototype.getMediaDevices=function(e){return k(this,void 0,void 0,(function(){var t;return T(this,(function(n){switch(n.label){case 0:return(null==d?void 0:d.enumerateDevices)?[4,d.enumerateDevices()]:[3,2];case 1:return t=n.sent(),[2,e?t.filter((function(t){return t.kind===e})):t];case 2:throw new Error("No 'enumerateDevices' API supported")}}))}))},e.prototype.clearSession=function(e){delete this.sessionsStore[e]},e.prototype.getCurrentSessionToken=function(){var e=this.proxy.getSession();if(null==e?void 0:e.token)return e.token;throw new Error("Session does not exist")},e.prototype.getListenerByName=function(e){switch(e){case Nu.JOIN:return"onParticipantJoinedListener";case Nu.LEFT:return"onParticipantLeftListener";case Nu.SLOW_LINK:return"onSlowLinkListener";case Nu.REMOTE_STREAM:return"onRemoteStreamListener";case Nu.REMOTE_TRACKS_UPDATED:return"onRemoteTracksUpdatedListener";case Nu.REMOTE_CONNECTION_STATE:return"onRemoteConnectionStateChangedListener";case Nu.DATA_CHANNEL_OPENED:return"onDataChannelOpenedListener";case Nu.DATA_CHANNEL_MESSAGE:return"onDataChannelMessageListener";case Nu.SESSION_CONNECTION_STATE:return"onSessionConnectionStateChangedListener";case Nu.ERROR:return"onErrorListener";default:return null}},e.prototype.addListener=function(e,t){var n=this.getListenerByName(e);return n&&(this[n]=t),this.removeListener.bind(this,e)},e.prototype.removeListener=function(e){var t=this.getListenerByName(e);t&&(this[t]=void 0)},e.prototype.removeAllListeners=function(){var e=this;Object.keys(this).forEach((function(t){t.startsWith("on")&&t.endsWith("Listener")&&"function"==typeof e[t]&&(e[t]=void 0)}))},e}(),Hu=function(){function e(e){this.route=E.urls.data,this.proxy=e}return e.prototype.create=function(e){return k(this,arguments,void 0,(function(e,t){var n,r,i;return void 0===t&&(t={}),T(this,(function(o){return n=O.isArray(t),r=n?"multi":void 0,i={type:I.POST,url:O.getUrl(this.route,e,r),data:n?{record:this.createRecord(t)}:t},[2,this.proxy.ajax(i)]}))}))},e.prototype.list=function(e){return k(this,arguments,void 0,(function(e,t){var n,r;return void 0===t&&(t={}),T(this,(function(i){return n="string"==typeof t?t:O.isArray(t)?t.toString():void 0,r={url:O.getUrl(this.route,e,n),data:n?void 0:t},[2,this.proxy.ajax(r)]}))}))},e.prototype.readPermissions=function(e,t){return k(this,void 0,void 0,(function(){var n;return T(this,(function(r){return n={url:O.getUrl(this.route,e,t),data:{permissions:1}},[2,this.proxy.ajax(n)]}))}))},e.prototype.update=function(e){return k(this,arguments,void 0,(function(e,t){var n,r,i,o;return void 0===t&&(t={}),T(this,(function(s){return n=O.isArray(t),r=!n&&t.search_criteria,i=n?"multi":r?"by_criteria":t.id||t._id,o={type:I.PUT,url:O.getUrl(this.route,e,i),data:n?{record:this.createRecord(t)}:t},[2,this.proxy.ajax(o)]}))}))},e.prototype.delete=function(e,t){return k(this,void 0,void 0,(function(){var n,r,i,o;return T(this,(function(s){return n=O.isObject(t),r="string"==typeof t||O.isArray(t)&&1===t.length,i=n?"by_criteria":t.toString(),o={type:I.DELETE,url:O.getUrl(this.route,e,i),data:n?t:void 0,dataType:r?R.TEXT:void 0},[2,this.proxy.ajax(o)]}))}))},e.prototype.createRecord=function(e){return void 0===e&&(e=[]),e.reduce((function(e,t,n){var r,i=n+1,o=t.id||t._id,s=o?C(C({},t),{id:o}):t;return C(C({},e),((r={})[i]=s,r))}),{})},e}(),Zu=function(){function e(e){this.route=E.urls.meetings,this.proxy=e}return e.prototype.get=function(){return k(this,arguments,void 0,(function(e){var t;return void 0===e&&(e={}),T(this,(function(n){return t={type:I.GET,url:O.getUrl(this.route),data:e},[2,this.proxy.ajax(t)]}))}))},e.prototype.create=function(){return k(this,arguments,void 0,(function(e){var t,n,r,i,o;return void 0===e&&(e={}),T(this,(function(s){return t=Math.ceil(Date.now()/1e3),n=t+3600,r=new Date(t).toLocaleString("en",{year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric"}),i={name:r,start_date:t,end_date:n,attendees:[],record:!1,chat:!1},o={type:I.POST,url:O.getUrl(this.route),data:C(C({},i),e)},[2,this.proxy.ajax(o)]}))}))},e.prototype.update=function(e,t){return k(this,void 0,void 0,(function(){var n;return T(this,(function(r){return n={type:I.PUT,url:O.getUrl(this.route,e),data:t},[2,this.proxy.ajax(n)]}))}))},e.prototype.delete=function(e){return k(this,void 0,void 0,(function(){var t;return T(this,(function(n){return t={type:I.DELETE,url:O.getUrl(this.route,e),dataType:R.TEXT},[2,this.proxy.ajax(t)]}))}))},e.prototype.getRecordings=function(e){return k(this,void 0,void 0,(function(){var t;return T(this,(function(n){return t={type:I.GET,url:O.getUrl(this.route,"recordings",e)},[2,this.proxy.ajax(t)]}))}))},e}(),Xu=function(){function e(){this.sdkInstance={config:E,session:null},this.requestsNumber=0,this.fetchImpl=c,this.abortControllersMap={},this.requestMethod=I,this.responseType=R}return e.prototype.setSession=function(e){this.sdkInstance.session=e,e&&e.user_id&&this.setCurrentUserId(e.user_id)},e.prototype.getSession=function(){return this.sdkInstance.session},e.prototype.setCurrentUserId=function(e){this.currentUserId=e||void 0},e.prototype.getCurrentUserId=function(){return this.currentUserId},e.prototype.logRequest=function(e,t){O.DLog("[Request][".concat(t,"]"),"".concat(e.type||"GET"," ").concat(e.url),e)},e.prototype.logResponse=function(e,t){O.DLog("[Response][".concat(t,"]"),e)},e.prototype.buildRequestAndURL=function(e){var t,n=!e.type||"GET"===e.type||"HEAD"===e.type,r=!!e.type&&("POST"===e.type||"PUT"===e.type),i=this.sdkInstance&&this.sdkInstance.session&&this.sdkInstance.session.token,o=-1===e.url.indexOf("s3.amazonaws.com"),s=!1===e.contentType,a=e.authKey,c=e.url,l={};return l.method=e.type||"GET",e.data&&(t=this.buildRequestBody(e,s,r),n?c+="?".concat(t):l.body=t),s||(l.headers={"Content-Type":r?"application/json;charset=utf-8":"application/x-www-form-urlencoded; charset=UTF-8"}),o&&(l.headers||(l.headers={}),l.headers["CB-SDK"]="JS ".concat(E.version," - Client"),i?l.headers["CB-Token"]=i:a&&(l.headers["CB-AuthKey"]=a)),E.timeout&&(l.timeout=E.timeout),[l,c]},e.prototype.buildRequestBody=function(e,t,n){var r,i=e.data,o=e.useArrayQuery;return t?(r=new l,Object.keys(i).forEach((function(t){e.fileToCustomObject&&"file"===t?r.append(t,i[t].data,i[t].name):r.append(t,e.data[t])}))):r=n?JSON.stringify(i):this.serializeQueryParams(i,"",o,0),r},e.prototype.serializeQueryParams=function(e,t,n,r){void 0===r&&(r=0);var i=[];for(var o in e){var s=this.encodeURIComponent(o);O.isArray(e)&&(s="");var a=t?t+"[".concat(s,"]"):s,c=e[o],l=O.isArray(c);l&&(n||0===r)||O.isObject(c)?i.push(this.serializeQueryParams(c,a,n,++r)):(c=l?c.sort().join(","):c,i.push("".concat(a,"=").concat(this.encodeURIComponent(c))))}return i.sort().join("&")},e.prototype.encodeURIComponent=function(e){return encodeURIComponent(e).replace(/[#$&+,/:;=?@\[\]]/g,(function(e){return"%".concat(e.charCodeAt(0).toString(16))}))},e.prototype.abortRequest=function(e){this.abortControllersMap[e]&&(this.abortControllersMap[e].controllers||[]).forEach((function(e){e.abort()}))},e.prototype.processSuccessfulOrFailedRequest=function(e){if(e&&this.abortControllersMap[e]){var t=this.abortControllersMap[e].controllers||[];this.abortControllersMap[e].doneRequestsCount?this.abortControllersMap[e].doneRequestsCount+=1:this.abortControllersMap[e].doneRequestsCount=1,this.abortControllersMap[e].doneRequestsCount===t.length&&delete this.abortControllersMap[e]}},e.prototype.ajax=function(e){return k(this,void 0,void 0,(function(){var t,n=this;return T(this,(function(r){return t=++this.requestsNumber,[2,new Promise((function(r,i){n.logRequest(e,t);var o,s=n.buildRequestAndURL(e),a=s[0],l=s[1],u=e.abort_id;if(u){var d=0;if(n.abortControllersMap[u]){var h=n.abortControllersMap[u].controllers||[];n.abortControllersMap[u].controllers.push(new AbortController),d=h.length-1}else n.abortControllersMap[u]={controllers:[new AbortController]};var f=n.abortControllersMap[u].controllers[d].signal;Object.assign(a,{signal:f})}c(l,a).then((function(t){return o=t,(e.dataType||R.JSON)===R.TEXT?o.text():o.json()})).then((function(s){n.processSuccessfulOrFailedRequest(u),o.ok?n.processAjaxResponse(s,r,t):n.processAjaxError(o,s,null,i,r,e,t)})).catch((function(s){n.processSuccessfulOrFailedRequest(u),n.processAjaxError(o," ",s,i,r,e,t)}))}))]}))}))},e.prototype.processAjaxResponse=function(e,t,n){var r=e&&" "!==e?e:"empty body";this.logResponse(r,n),t(e)},e.prototype.processAjaxError=function(e,t,n,r,i,o,s){if(e||!n||n.code){var a=null==e?void 0:e.status,c={code:e&&a||n&&n.code,info:(t&&"string"==typeof t&&" "!==t?JSON.parse(t):t)||n&&n.errno},l=t||n||t.errors;this.logResponse(l,s),-1===(null==e?void 0:e.url.indexOf(E.urls.session))&&this.isExpiredSessionError(c)&&"function"==typeof E.on.sessionExpired?this.handleExpiredSessionResponse(c,null,r,i,o):r(c)}else r(n)},e.prototype.handleExpiredSessionResponse=function(e,t,n,r,i){var o=this;"function"==typeof E.on.sessionExpired&&E.on.sessionExpired((function(){e?n(e):r(t)}),(function(e){e&&(o.setSession(e),o.ajax(i).then(r).catch(n))}))},e.prototype.isExpiredSessionError=function(e){var t,n,r;try{return e&&401===e.code&&"Required session does not exist"===(null===(r=null===(n=null===(t=e.info)||void 0===t?void 0:t.errors)||void 0===n?void 0:n.base)||void 0===r?void 0:r[0])}catch(e){return!1}},e}(),Yu=function(e){this.base64Encode=r,this.proxy=e,this.subscriptions=new $u(e),this.events=new Ku(e)},$u=function(){function e(e){this.route=E.urls.subscriptions,this.proxy=e}return e.prototype.create=function(e){return k(this,void 0,void 0,(function(){var t;return T(this,(function(n){return t={type:I.POST,url:O.getUrl(this.route),data:e},[2,this.proxy.ajax(t)]}))}))},e.prototype.list=function(){return k(this,void 0,void 0,(function(){var e;return T(this,(function(t){return e={type:I.GET,url:O.getUrl(this.route)},[2,this.proxy.ajax(e)]}))}))},e.prototype.delete=function(e){return k(this,void 0,void 0,(function(){var t;return T(this,(function(n){return t={type:I.DELETE,dataType:R.TEXT,url:O.getUrl(this.route,e)},[2,this.proxy.ajax(t)]}))}))},e}(),Ku=function(){function e(e){this.route=E.urls.events,this.proxy=e}return e.prototype.create=function(e){return k(this,void 0,void 0,(function(){var t;return T(this,(function(n){return t={type:I.POST,url:O.getUrl(this.route),data:{event:e}},[2,this.proxy.ajax(t)]}))}))},e}(),Qu=function(){function e(e){this.route=E.urls.blobs,this.proxy=e}return e.prototype.list=function(){return k(this,arguments,void 0,(function(e){var t;return void 0===e&&(e={}),T(this,(function(n){return t={type:I.GET,url:O.getUrl(this.route),data:e},[2,this.proxy.ajax(t)]}))}))},e.prototype.create=function(e){return k(this,void 0,void 0,(function(){var t;return T(this,(function(n){return t={type:I.POST,url:O.getUrl(this.route),data:{blob:e}},[2,this.proxy.ajax(t)]}))}))},e.prototype.delete=function(e){return k(this,void 0,void 0,(function(){var t;return T(this,(function(n){return t={type:I.DELETE,url:O.getUrl(this.route,e),dataType:R.TEXT},[2,this.proxy.ajax(t)]}))}))},e.prototype.createAndUpload=function(e){return k(this,void 0,void 0,(function(){var t,n,r,i,o,s,a,c,l=this;return T(this,(function(u){return t=e.name,n=e.file,r=e.size,i=e.abort_id,o=e.type,s=e.public,a={name:t,content_type:o,public:void 0===s||s},[2,this.create(a).then((function(e){var t,r=e.blob;c=r;var o=l.parseUri(null===(t=c.blob_object_access)||void 0===t?void 0:t.params),s={url:"".concat(o.protocol,"://").concat(o.authority).concat(o.path),data:{}};return i&&(s.abort_id=i),Object.keys(o.queryKey).forEach((function(e){s.data[e]=decodeURIComponent(o.queryKey[e])})),s.data.file=n,l.upload(s).then((function(){return c}))})).then((function(e){return l.markUploaded({id:e.id,size:r}).then((function(){return e}))})).then((function(e){return C(C({},e),{size:r})}))]}))}))},e.prototype.upload=function(e){return k(this,void 0,void 0,(function(){var t;return T(this,(function(n){return t=C(C({},e),{type:I.POST,dataType:R.TEXT,contentType:!1}),[2,this.proxy.ajax(t)]}))}))},e.prototype.markUploaded=function(e){return k(this,void 0,void 0,(function(){var t;return T(this,(function(n){return t={type:I.PUT,url:O.getUrl(this.route,e.id,"complete"),data:{size:e.size},dataType:R.TEXT},[2,this.proxy.ajax(t)]}))}))},e.prototype.getInfo=function(e){return k(this,void 0,void 0,(function(){var t;return T(this,(function(n){return t={url:O.getUrl(this.route,e)},[2,this.proxy.ajax(t)]}))}))},e.prototype.getFile=function(e){return k(this,void 0,void 0,(function(){var t;return T(this,(function(n){return t={url:O.getUrl(this.route,e)},[2,this.proxy.ajax(t)]}))}))},e.prototype.getFileObject=function(e,t){return k(this,void 0,void 0,(function(){var n;return T(this,(function(r){return n={type:I.GET,url:O.getUrl(this.route,e,"object"),data:t},[2,this.proxy.ajax(n)]}))}))},e.prototype.update=function(e){return k(this,void 0,void 0,(function(){var t,n;return T(this,(function(r){return t={blob:{}},void 0!==e.name&&(t.blob.name=e.name),n={url:O.getUrl(this.route,e.id),data:t},[2,this.proxy.ajax(n)]}))}))},e.prototype.privateUrl=function(e){var t;return void 0===e&&(e=""),"https://".concat(E.endpoints.api,"/blobs/").concat(e,"?token=").concat(null===(t=this.proxy.getSession())||void 0===t?void 0:t.token)},e.prototype.publicUrl=function(e){return void 0===e&&(e=""),"https://".concat(E.endpoints.api,"/blobs/").concat(e)},e.prototype.parseUri=function(e){var t;void 0===e&&(e="");for(var n={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},r=null!==(t=n.parser.loose.exec(e))&&void 0!==t?t:{},i={},o=14;o--;)i[n.key[o]]=r[o]||"";return i[n.q.name]={},i[n.key[12]].replace(n.q.parser,(function(e,t,r){t&&(i[n.q.name][t]=r)})),i},e}(),ed=function(){function e(e){this.route=E.urls.users,this.proxy=e}return e.prototype.getV2=function(e){return k(this,void 0,void 0,(function(){var t;return T(this,(function(n){return t={type:I.GET,url:O.getUrl(this.route,"v2"),useArrayQuery:!0,data:e},[2,this.proxy.ajax(t)]}))}))},e.prototype.signup=function(e,t){return k(this,void 0,void 0,(function(){var n;return T(this,(function(r){return n={authKey:null!=t?t:E.creds.authKey,type:I.POST,url:O.getUrl(this.route),data:{user:e}},[2,this.proxy.ajax(n)]}))}))},e.prototype.update=function(){return k(this,arguments,void 0,(function(e){var t;return void 0===e&&(e={}),T(this,(function(n){return t={type:I.PUT,url:O.getUrl(this.route,this.proxy.getCurrentUserId()),data:{user:e}},[2,this.proxy.ajax(t)]}))}))},e.prototype.delete=function(){return k(this,void 0,void 0,(function(){var e;return T(this,(function(t){return e={type:I.DELETE,url:O.getUrl(this.route,this.proxy.getCurrentUserId()),dataType:R.TEXT},[2,this.proxy.ajax(e)]}))}))},e.prototype.resetPassword=function(){return k(this,arguments,void 0,(function(e){var t;return void 0===e&&(e=""),T(this,(function(n){return t={type:I.POST,url:O.getUrl(this.route,"password","reset"),data:{email:e},dataType:R.TEXT},[2,this.proxy.ajax(t)]}))}))},e.prototype.get=function(e){return k(this,void 0,void 0,(function(){function t(e){var t=O.cloneObject(e),n=o.includes(t.field)?"date":typeof t.value;return O.isArray(t.value)&&("object"===n&&(n=typeof t.value[0]),t.value=t.value.toString()),[n,t.field,t.param,t.value].join(" ")}var n,r,i,o,s,a,c,l,u;return T(this,(function(d){if(n=O.cloneObject(e),r="",i=[],o=["created_at","updated_at","last_request_at"],s=["id","external_user_id"],a={login:"by_login",full_name:"by_full_name",facebook_id:"by_facebook_id",twitter_id:"by_twitter_id",phone:"phone",email:"by_email",tags:"by_tags",external:"external"},n.order&&(c=n.order.field in o?"date":n.order.field in s?"number":"string",n.order=[n.order.sort,c,n.order.field].join(" ")),n&&n.filter&&(O.isArray(n.filter)?n.filter.forEach((function(e){i.push(t(e))})):i.push(t(n.filter)),n.filter=i),"number"==typeof n)r=n,n=void 0;else for(l in a)if(n[l]){r=a[l],l===a.external&&(r+="/".concat(n[a.external]),n=void 0);break}return u={type:I.GET,url:O.getUrl(this.route,r),data:n},[2,this.proxy.ajax(u)]}))}))},e}(),td=function(){function e(){}return e.getUserJid=function(e){return"".concat(e,"-").concat(E.creds.appId,"@").concat(E.endpoints.chat)},e.getUserIdFromJID=function(e){return(null==e?void 0:e.includes("@"))?parseInt(e.split("@")[0].split("-")[0]):null},e.trace=function(e){E.debug&&console.log("[VideoChat]:",e)},e.traceWarning=function(e){E.debug&&console.warn("[VideoChat]:",e)},e.traceError=function(e){E.debug&&console.error("[VideoChat]:",e)},Object.defineProperty(e,"getVersionFirefox",{get:function(){var e,t=null!==(e=null===navigator||void 0===navigator?void 0:navigator.userAgent)&&void 0!==e?e:null,n=0;if(t){var r=t.match(/(?:firefox)[ \/](\d+)/i)||[];n=r[1]?+r[1]:0}return"string"==typeof n?parseInt(n):n},enumerable:!1,configurable:!0}),Object.defineProperty(e,"getVersionSafari",{get:function(){var e,t=null!==(e=null===navigator||void 0===navigator?void 0:navigator.userAgent)&&void 0!==e?e:null,n=0;if(t&&(t.match(/(?:safari)[ \/](\d+)/i)||[]).length){var r=t.match(/(?:version)[ \/](\d+)/i)||[];r&&(n=r[1]?+r[1]:0)}return"string"==typeof n?parseInt(n):n},enumerable:!1,configurable:!0}),e}();!function(e){e.CALL="call",e.ACCEPT="accept",e.REJECT="reject",e.STOP="hangUp",e.RESTART="iceRestart",e.RESTART_ACCEPT="iceRestartAccept",e.CANDIDATE="iceCandidates"}(Uu||(Uu={})),function(e){e[e.UNDEFINED=0]="UNDEFINED",e[e.CONNECTING=1]="CONNECTING",e[e.CONNECTED=2]="CONNECTED",e[e.FAILED=3]="FAILED",e[e.DISCONNECTED=4]="DISCONNECTED",e[e.CLOSED=5]="CLOSED",e[e.COMPLETED=6]="COMPLETED"}(zu||(zu={})),function(e){e[e.NEW=1]="NEW",e[e.ACTIVE=2]="ACTIVE",e[e.HUNGUP=3]="HUNGUP",e[e.REJECTED=4]="REJECTED",e[e.CLOSED=5]="CLOSED"}(Bu||(Bu={})),function(e){e[e.NEW=1]="NEW",e[e.CONNECTING=2]="CONNECTING",e[e.CHECKING=3]="CHECKING",e[e.CONNECTED=4]="CONNECTED",e[e.DISCONNECTED=5]="DISCONNECTED",e[e.FAILED=6]="FAILED",e[e.CLOSED=7]="CLOSED",e[e.COMPLETED=8]="COMPLETED"}(Fu||(Fu={})),function(e){e[e.VIDEO=1]="VIDEO",e[e.AUDIO=2]="AUDIO"}(qu||(qu={})),function(e){e.CALL="call",e.ACCEPT="accept",e.REJECT="reject",e.HUNG_UP="hang-up",e.INVALID="invalid",e.NOT_ANSWER="not-answer",e.REMOTE_STREAM="remote-stream",e.CONNECTION_STATE="connection-state",e.CLOSE="close",e.STATS_REPORT="stats-report",e.DEVICES="devices"}(Wu||(Wu={}));var nd=function(){function e(e,t,n){var r=this;this.remoteSDP=null,this.state=Fu.NEW,this.iceCandidates=[],this.remoteStream=new h,this.answerTimeInterval=0,this.onStatusClosedChecker=null,this.dialingTimer=null,this.statsReportTimer=null,this.waitingReconnectTimeoutCallback=null,this.released=!1,this.onMediaTrackHandler=function(e){r.remoteStream.addTrack(e.track),(1==r.session.callType&&r.remoteStream.getVideoTracks().length||2==r.session.callType&&r.remoteStream.getAudioTracks().length)&&r.session.onRemoteStream(r.userID,r.remoteStream),r.getWrappedStats()},this.onIceCandidateHandler=function(e){if(e.candidate){var t=e.candidate,n={sdpMLineIndex:t.sdpMLineIndex,sdpMid:t.sdpMid,candidate:t.candidate};"stable"===r.signalingState?r.session.processIceCandidates(r.userID,[n]):r.iceCandidates.push(n)}},this.onSignalingStateHandler=function(){td.trace("onSignalingStateHandler: ".concat(r.signalingState)),"stable"===r.signalingState&&r.iceCandidates.length>0&&(r.session.processIceCandidates(r.userID,r.iceCandidates),r.iceCandidates.length=0)},this.onIceConnectionStateHandler=function(){switch(td.trace("onIceConnectionStateHandler: ".concat(r.iceConnectionState)),r.onStatusClosedChecker&&td.getVersionSafari>=11&&clearTimeout(r.onStatusClosedChecker),r.iceConnectionState){case"checking":r.state=Fu.CHECKING,r.session.onSessionConnectionStateChanged(r.userID,zu.CONNECTING);break;case"connected":r.state=Fu.CONNECTED,r.clearWaitingReconnectTimer(),r.session.onSessionConnectionStateChanged(r.userID,zu.CONNECTED);break;case"completed":r.state=Fu.COMPLETED,r.clearWaitingReconnectTimer(),r.session.onSessionConnectionStateChanged(r.userID,zu.COMPLETED);break;case"failed":r.state=Fu.FAILED,r.session.onSessionConnectionStateChanged(r.userID,zu.FAILED);break;case"disconnected":r.state=Fu.DISCONNECTED,r.startWaitingReconnectTimer(),r.session.onSessionConnectionStateChanged(r.userID,zu.DISCONNECTED),td.getVersionSafari>=11&&(r.onStatusClosedChecker=setTimeout((function(){r.onIceConnectionStateHandler()}),500));break;case"closed":r.state=Fu.CLOSED,r.clearWaitingReconnectTimer(),r.session.onSessionConnectionStateChanged(r.userID,zu.CLOSED)}},this.create(),this.setup(e,t,n)}return e.prototype.create=function(){var e={iceTransportPolicy:E.videochat.alwaysRelayCalls?"relay":"all",iceServers:E.videochat.iceServers.map((function(e){var t;return{urls:null!==(t=e.urls)&&void 0!==t?t:e.url,username:e.username,credential:e.credential}}))};this.original=m?new m(e):{},td.trace("new RTCPeerConnection(".concat(JSON.stringify(e,null,2),")"))},e.prototype.setup=function(e,t,n){this.type=n,this.userID=t,this.session=e,this.session.startCallTime=new Date,this.original.ontrack=this.onMediaTrackHandler,this.original.onicecandidate=this.onIceCandidateHandler,this.original.onsignalingstatechange=this.onSignalingStateHandler,this.original.oniceconnectionstatechange=this.onIceConnectionStateHandler,td.trace("RTCPeerConnection init. userID: ".concat(t,", sessionID: ").concat(e.ID,", type: ").concat(n))},e.prototype.clearWaitingReconnectTimer=function(){this.waitingReconnectTimeoutCallback&&(td.trace("clearWaitingReconnectTimer"),clearTimeout(this.waitingReconnectTimeoutCallback),this.waitingReconnectTimeoutCallback=null)},e.prototype.startWaitingReconnectTimer=function(){var e=this,t=1e3*E.videochat.disconnectTimeInterval;td.trace("startWaitingReconnectTimer, timeout: ".concat(t)),this.waitingReconnectTimeoutCallback=setTimeout((function(){td.trace("waitingReconnectTimeoutCallback"),e.waitingReconnectTimeoutCallback&&clearTimeout(e.waitingReconnectTimeoutCallback),e.release(),e.session.closeSessionIfAllConnectionsClosed()}),t)},e.prototype.clearStatsReportTimer=function(){this.statsReportTimer&&(clearInterval(this.statsReportTimer),this.statsReportTimer=null)},e.prototype.addCandidates=function(e){return k(this,void 0,void 0,(function(){var t,n=this;return T(this,(function(r){return t=e.reduce((function(e,t){var r=t.sdpMLineIndex,i=t.sdpMid,o=t.candidate;if(o){var s=new p({sdpMLineIndex:r,sdpMid:i,candidate:o}),a=n.addIceCandidate(s).catch((function(e){td.traceError("Error on 'addIceCandidate': ".concat(e))}));e.push(a)}return e}),[]),[2,Promise.all(t)]}))}))},e.prototype.release=function(){this.clearDialingTimer(),this.clearStatsReportTimer(),this.close(),td.getVersionSafari>=11&&this.onIceConnectionStateHandler(),this.released=!0},e.prototype.clearDialingTimer=function(){this.dialingTimer&&(td.trace("clearDialingTimer"),clearInterval(this.dialingTimer),this.dialingTimer=null,this.answerTimeInterval=0)},e.prototype.getAndSetLocalSessionDescription=function(e){return k(this,arguments,void 0,(function(e,t){var n,r,i;return void 0===t&&(t=!1),T(this,(function(o){switch(o.label){case 0:this.state=Fu.CONNECTING,o.label=1;case 1:return o.trys.push([1,8,,9]),n=t?{iceRestart:t}:void 0,"offer"!==this.type?[3,3]:[4,this.createOffer(n)];case 2:return i=o.sent(),[3,5];case 3:return[4,this.createAnswer()];case 4:i=o.sent(),o.label=5;case 5:return r=i,[4,this.setLocalDescription(r)];case 6:return o.sent(),[4,this.setRTCRtpSenderMaxBandwidth(e)];case 7:return o.sent(),[2,r];case 8:throw o.sent();case 9:return[2]}}))}))},e.prototype.setRTCRtpSenderMaxBandwidth=function(e){return k(this,void 0,void 0,(function(){var t,n,r=this;return T(this,(function(i){return t=this.getSenders()||[],n=t.reduce((function(t,n){var i,o;if("video"===(null===(i=n.track)||void 0===i?void 0:i.kind)){var s=n.getParameters();s.encodings||(s.encodings=[]),e?s.encodings[0].maxBitrate=1e3*e:null===(o=s.encodings[0])||void 0===o||delete o.maxBitrate,t.push(n.setParameters(s).then((function(){td.trace("Set maxBandwidth success [".concat(r.userID,"]: ").concat(e," kbps"))})).catch((function(e){td.trace("Set maxBandwidth error [".concat(r.userID,"]: ").concat(e))})))}return t}),[]),[2,Promise.all(n)]}))}))},e.prototype.startDialingTimer=function(e,t){var n=this,r=1e3*E.videochat.dialingTimeInterval;td.trace("startDialingTimer, dialingTimeInterval: ".concat(JSON.stringify(r)));var i=function(e,t,r){r||(n.answerTimeInterval+=1e3*E.videochat.dialingTimeInterval),td.trace("dialingCallback, extension: ".concat(JSON.stringify(e))),n.answerTimeInterval>=1e3*E.videochat.answerTimeInterval?(n.clearDialingTimer(),t&&n.session.processOnNotAnswer(n)):n.session.processCall(n,e)};this.dialingTimer=setInterval(i,r,e,t,!1),i(e,t,!0)},e.prototype.setRemoteSessionDescription=function(e,t){return k(this,void 0,void 0,(function(){var n;return T(this,(function(r){return n=new y({sdp:t,type:e}),[2,this.setRemoteDescription(n)]}))}))},e.prototype.getWrappedStats=function(){var e,t=this;E.videochat.statsReportTimeInterval&&(td.trace("Stats tracker has been started"),this.statsReportTimer=setInterval((function(){t.getStatsCustom(e,(function(n,r){e=r,t.session.onCallStatsReport(t.userID,n)}),(function(e){td.traceError("Get stats error. ".concat(e.name,": ").concat(e.message)),t.session.onCallStatsReport(t.userID,null,e)}))}),1e3*E.videochat.statsReportTimeInterval))},Object.defineProperty(e.prototype,"sdpRemote",{get:function(){return this.remoteSDP},set:function(e){e&&(this.remoteSDP=e)},enumerable:!1,configurable:!0}),e.prototype.toString=function(){return"sessionID: ".concat(this.session.ID,", userID: ").concat(this.userID,", type: ").concat(this.type,", state: ").concat(this.state)},e.prototype.getStatsCustom=function(e,t,n){var r=this,i={audio:{},video:{},candidate:{}},o={local:Object.assign({},i),remote:Object.assign({},i)};if(td.getVersionFirefox){var s=this.session.localStream,a=null==s?void 0:s.getVideoTracks()[0].getSettings();a&&(o.local.video.frameHeight=a.height,o.local.video.frameWidth=a.width)}this.getStats().then((function(n){n.forEach((function(t){var n;t.bytesReceived&&"inbound-rtp"===t.type?((n=o.remote[t.mediaType]).bitrate=r.getBitratePerSecond(t,e,!1),n.bytesReceived=t.bytesReceived,n.packetsReceived=t.packetsReceived,n.timestamp=t.timestamp,"video"===t.mediaType&&t.framerateMean&&(n.framesPerSecond=Math.round(10*t.framerateMean)/10)):t.bytesSent&&"outbound-rtp"===t.type?((n=o.local[t.mediaType]).bitrate=r.getBitratePerSecond(t,e,!0),n.bytesSent=t.bytesSent,n.packetsSent=t.packetsSent,n.timestamp=t.timestamp,"video"===t.mediaType&&t.framerateMean&&(n.framesPerSecond=Math.round(10*t.framerateMean)/10)):"local-candidate"===t.type?(n=o.local.candidate,"host"===t.candidateType&&"udp"===t.mozLocalTransport&&"udp"===t.transport?(n.protocol=t.transport,n.ip=t.ipAddress,n.port=t.portNumber):td.getVersionFirefox||(n.protocol=t.protocol,n.ip=t.ip,n.port=t.port)):"remote-candidate"===t.type?((n=o.remote.candidate).protocol=t.protocol||t.transport,n.ip=t.ip||t.ipAddress,n.port=t.port||t.portNumber):"track"!==t.type||"video"!==t.kind||td.getVersionFirefox||(t.remoteSource?((n=o.remote.video).frameHeight=t.frameHeight,n.frameWidth=t.frameWidth,n.framesPerSecond=r.getFramesPerSecond(t,e,!1)):((n=o.local.video).frameHeight=t.frameHeight,n.frameWidth=t.frameWidth,n.framesPerSecond=r.getFramesPerSecond(t,e,!0)))})),t(o,n)}),n)},e.prototype.getBitratePerSecond=function(e,t,n){var r=t.get(e.id),i=r?(e.timestamp-r.timestamp)/1e3:5,o=r?n?8*(e.bytesSent-r.bytesSent)/(1024*i):8*(e.bytesReceived-r.bytesReceived)/(1024*i):0;return Math.round(o)},e.prototype.getFramesPerSecond=function(e,t,n){var r=t&&t.get(e.id),i=r?(e.timestamp-r.timestamp)/1e3:5,o=r?n?(e.framesSent-r.framesSent)/i:(e.framesReceived-r.framesReceived)/i:0;return Math.round(10*o)/10},e.prototype.getSenders=function(){var e,t,n;return null!==(n=null===(t=(e=this.original).getSenders)||void 0===t?void 0:t.call(e))&&void 0!==n?n:[]},e.prototype.createOffer=function(e){var t,n,r;return null!==(r=null===(n=(t=this.original).createOffer)||void 0===n?void 0:n.call(t,e))&&void 0!==r?r:Promise.resolve({})},e.prototype.createAnswer=function(e){var t,n,r;return null!==(r=null===(n=(t=this.original).createAnswer)||void 0===n?void 0:n.call(t,e))&&void 0!==r?r:Promise.resolve({})},e.prototype.setRemoteDescription=function(e){var t,n,r;return null!==(r=null===(n=(t=this.original).setRemoteDescription)||void 0===n?void 0:n.call(t,e))&&void 0!==r?r:Promise.resolve()},e.prototype.setLocalDescription=function(e){var t,n,r;return null!==(r=null===(n=(t=this.original).setLocalDescription)||void 0===n?void 0:n.call(t,e))&&void 0!==r?r:Promise.resolve()},e.prototype.getStats=function(){var e,t,n;return null!==(n=null===(t=(e=this.original).getStats)||void 0===t?void 0:t.call(e))&&void 0!==n?n:Promise.resolve(new Map)},e.prototype.close=function(){var e,t;null===(t=(e=this.original).close)||void 0===t||t.call(e)},e.prototype.addIceCandidate=function(e){var t,n,r;return null!==(r=null===(n=(t=this.original).addIceCandidate)||void 0===n?void 0:n.call(t,e))&&void 0!==r?r:Promise.resolve()},e.prototype.addTrack=function(e,t){var n,r,i;return null!==(i=null===(r=(n=this.original).addTrack)||void 0===r?void 0:r.call(n,e,t))&&void 0!==i?i:{}},Object.defineProperty(e.prototype,"localDescription",{get:function(){var e;return null!==(e=this.original.localDescription)&&void 0!==e?e:{type:"",sdp:""}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"signalingState",{get:function(){var e;return null!==(e=this.original.signalingState)&&void 0!==e?e:"closed"},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"iceConnectionState",{get:function(){var e;return null!==(e=this.original.iceConnectionState)&&void 0!==e?e:"closed"},enumerable:!1,configurable:!0}),e}(),rd=function(){function e(e){var t,n,r;this.ID=null,this.state=Bu.NEW,this.maxBandwidth=0,this.peerConnections={},this.mediaParams={},this.answerTimer=null,this.waitingOfferOrAnswerTimer=null,Object.assign(this,e,{ID:null!==(t=e.ID)&&void 0!==t?t:(n=(new Date).getTime(),r="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=(n+16*Math.random())%16|0;return n=Math.floor(n/16),("x"==e?t:3&t|8).toString(16)})),r)})}return e.prototype.getDisplayMedia=function(e){return k(this,void 0,void 0,(function(){var t,n,r,i;return T(this,(function(o){switch(o.label){case 0:if(!d.getDisplayMedia)throw new Error("Your environment does not support 'getDisplayMedia' API");t=e&&e.elementId,n=e&&e.options,r=C({},e),this.mediaParams=r,delete r.elementId,delete r.options,o.label=1;case 1:return o.trys.push([1,3,,4]),[4,d.getDisplayMedia(r)];case 2:return i=o.sent(),[2,this.upsertStream(i,t,n)];case 3:throw o.sent();case 4:return[2]}}))}))},e.prototype.getUserMedia=function(e){return k(this,void 0,void 0,(function(){var t,n,r,i;return T(this,(function(o){switch(o.label){case 0:t=e&&e.elementId,n=e&&e.options,r=C({},e),this.mediaParams=r,delete r.elementId,delete r.options,o.label=1;case 1:return o.trys.push([1,3,,4]),[4,d.getUserMedia(r)];case 2:return i=o.sent(),[2,this.upsertStream(i,t,n)];case 3:throw o.sent();case 4:return[2]}}))}))},e.prototype.upsertStream=function(e,t,n){var r=!!this.localStream;if(r?this.replaceTracks(e):this.localStream=e,!this.localStream)throw new Error("Local stream is not defined");return t&&(r&&this.detachMediaStream(t,n),this.attachMediaStream(t,this.localStream,n)),this.localStream},e.prototype.replaceTracks=function(e){var t,n=this;if(null===(t=this.localStream)||void 0===t||t.getTracks().forEach((function(t){var r;"audio"===t.kind&&0===e.getAudioTracks().length||(t.stop(),null===(r=n.localStream)||void 0===r||r.removeTrack(t))})),e.getTracks().forEach((function(e){var t,r,i,o,s;"audio"===e.kind?e.enabled=null===(r=null===(t=n.localStream)||void 0===t?void 0:t.getAudioTracks().every((function(e){return e.enabled})))||void 0===r||r:e.enabled=null===(o=null===(i=n.localStream)||void 0===i?void 0:i.getVideoTracks().every((function(e){return e.enabled})))||void 0===o||o,e&&(Object.values(n.peerConnections).forEach((function(t){var n;null===(n=t.getSenders().find((function(t){var n=t.track;return e.kind===(null==n?void 0:n.kind)})))||void 0===n||n.replaceTrack(e)})),null===(s=n.localStream)||void 0===s||s.addTrack(e))})),!this.localStream)throw new Error("Local stream is not defined");return this.localStream},e.prototype.setMaxBandwidth=function(e){return k(this,void 0,void 0,(function(){var t,n;return T(this,(function(r){return t=this.peerConnections,(n=Object.keys(t)).length<1?(td.trace("No 'RTCPeerConnection' to set 'maxBandwidth'"),[2]):[2,Promise.all(n.map((function(n){return t[n].setRTCRtpSenderMaxBandwidth(e)})))]}))}))},e.prototype.connectionStateForUser=function(e){var t=this.peerConnections[e];return t?t.state:null},e.prototype.attachMediaStream=function(e,t,n){var r=document.getElementById(e);if(!("srcObject"in r))throw new Error("Unable to attach media stream, element #".concat(e," is undefined"));r.srcObject=t,r.style.transform=(null==n?void 0:n.mirror)?"scaleX(-1)":"none","boolean"==typeof(null==n?void 0:n.muted)&&(r.muted=null==n?void 0:n.muted),r.onloadedmetadata=function(e){r.play()}},e.prototype.detachMediaStream=function(e,t){var n=document.getElementById(e);if(!("srcObject"in n))throw new Error("Unable to attach media stream, element #".concat(e," is undefined"));n.pause(),n.srcObject=null,n.style.transform=(null==t?void 0:t.mirror)?"scaleX(-1)":"none","boolean"==typeof(null==t?void 0:t.muted)&&(n.muted=null==t?void 0:t.muted)},e.prototype.switchMediaTracks=function(){return k(this,arguments,void 0,(function(e){var t,n,r=this;return void 0===e&&(e={}),T(this,(function(i){switch(i.label){case 0:O.DLog("switchMediaTracks:",e),["audio","video"].forEach((function(t){var n="audio"===t?e.audio:"audio"===t?e.video:{},i="string"==typeof n?n:null==n?void 0:n.deviceId;i&&("object"!=typeof r.mediaParams[t]?r.mediaParams[t].deviceId=i:r.mediaParams[t]={deviceId:i})})),i.label=1;case 1:return i.trys.push([1,3,,4]),t={audio:this.mediaParams.audio||!1,video:this.mediaParams.video||!1},[4,d.getUserMedia(t)];case 2:return n=i.sent(),[2,this.replaceTracks(n)];case 3:throw i.sent();case 4:return[2]}}))}))},e.prototype.call=function(e){var t,n,r=this;void 0===e&&(e={});var i=id(e);td.trace("Call, extension: ".concat(JSON.stringify(i))),this.state=Bu.ACTIVE,this.maxBandwidth=Number(null!==(n=null===(t=i.userInfo)||void 0===t?void 0:t.maxBandwidth)&&void 0!==n?n:0),this.opponentsIDs.forEach((function(e){r.callInternal(e,i,!0)}))},e.prototype.callInternal=function(e,t,n){return k(this,void 0,void 0,(function(){var r,i,o,s=this;return T(this,(function(a){switch(a.label){case 0:r=new nd(this,e,"offer"),null===(o=this.localStream)||void 0===o||o.getTracks().forEach((function(e){s.localStream&&r.addTrack(e,s.localStream)})),this.peerConnections[e]=r,a.label=1;case 1:return a.trys.push([1,3,,4]),[4,r.getAndSetLocalSessionDescription(this.maxBandwidth)];case 2:return a.sent(),r.startDialingTimer(t,n),td.trace("getAndSetLocalSessionDescription success"),[3,4];case 3:return i=a.sent(),td.traceError("getAndSetLocalSessionDescription error: ".concat(i)),[3,4];case 4:return[2]}}))}))},e.prototype.accept=function(e){var t=this;void 0===e&&(e={});var n=id(e);if(td.trace("Accept, extension: ".concat(JSON.stringify(n))),this.state!==Bu.ACTIVE){if(this.state===Bu.CLOSED)return td.traceError("Can't accept, the session is already closed, return"),void this.stop({});this.state=Bu.ACTIVE,this.acceptCallTime=new Date,this.clearAnswerTimer(),this.acceptInternal(this.initiatorID,n);var r=this.opponentsIDs.filter((function(e){return e!==t.initiatorID}));r.length>0&&(this.startWaitingOfferOrAnswerTimer(),r.forEach((function(n){t.currentUserID>n&&t.callInternal(n,e,!0)})))}else td.traceError("Can't accept, the session is already active, return")},e.prototype.acceptInternal=function(e,t){return k(this,void 0,void 0,(function(){var n,r,i,o,s=this;return T(this,(function(a){switch(a.label){case 0:if(!(n=this.peerConnections[e])||!n.sdpRemote)return td.traceError("Can't accept the call, there is no information about peer connection by some reason"),[2];null===(o=this.localStream)||void 0===o||o.getTracks().forEach((function(e){s.localStream&&n.addTrack(e,s.localStream)})),a.label=1;case 1:return a.trys.push([1,4,,5]),[4,n.setRemoteSessionDescription("offer",n.sdpRemote)];case 2:return a.sent(),[4,n.getAndSetLocalSessionDescription(this.maxBandwidth)];case 3:return a.sent(),r=Object.assign({},t,{sessionID:this.ID,callType:this.callType,callerID:this.initiatorID,opponentsIDs:this.opponentsIDs,sdp:n.localDescription.sdp}),this.signalingProvider.sendMessage(e,r,Uu.ACCEPT),[3,5];case 4:return i=a.sent(),td.traceError("[acceptInternal] Error: ".concat(i)),[3,5];case 5:return[2]}}))}))},e.prototype.reject=function(e){var t=this;void 0===e&&(e={});var n=id(e);td.trace("Reject, extension: ".concat(JSON.stringify(n.userInfo))),this.state=Bu.REJECTED,this.clearAnswerTimer(),Object.assign(n,{sessionID:this.ID,callType:this.callType,callerID:this.initiatorID,opponentsIDs:this.opponentsIDs}),Object.keys(this.peerConnections).forEach((function(e){t.signalingProvider.sendMessage(Number(e),n,Uu.REJECT)})),this.close()},e.prototype.stop=function(e){var t=this;void 0===e&&(e={});var n=id(e);td.trace("Stop, extension: ".concat(JSON.stringify(n.userInfo))),this.state=Bu.HUNGUP,this.answerTimer&&this.clearAnswerTimer(),Object.assign(n,{sessionID:this.ID,callType:this.callType,callerID:this.initiatorID,opponentsIDs:this.opponentsIDs}),Object.keys(this.peerConnections).forEach((function(e){t.signalingProvider.sendMessage(Number(e),n,Uu.STOP)})),this.close()},e.prototype.canInitiateIceRestart=function(e){var t;return"offer"===(null===(t=this.peerConnections[e])||void 0===t?void 0:t.type)},e.prototype.iceRestart=function(e){return k(this,void 0,void 0,(function(){var t,n,r,i,o;return T(this,(function(s){switch(s.label){case 0:if(!(t=this.peerConnections[e]))return td.traceError("Can't restart ice, there is no information about peer connection by some reason"),[2];s.label=1;case 1:return s.trys.push([1,3,,4]),[4,t.getAndSetLocalSessionDescription(this.maxBandwidth,!0)];case 2:return n=s.sent().sdp,r={sessionID:null!==(o=this.ID)&&void 0!==o?o:"",sdp:n},this.signalingProvider.sendMessage(e,r,Uu.RESTART),td.trace("[iceRestart] OK"),[3,4];case 3:return i=s.sent(),td.traceError("[iceRestart] Error: ".concat(i)),[3,4];case 4:return[2]}}))}))},e.prototype.processOnCall=function(e,t){var n=this;x([this.initiatorID],this.opponentsIDs.filter((function(e){return e!==n.currentUserID})),!0).forEach((function(r){var i=n.peerConnections[r];if(i)r===e&&(i.sdpRemote=t.sdp,e!==n.initiatorID&&n.state===Bu.ACTIVE&&n.acceptInternal(e,t));else{var o=r!==e&&n.currentUserID>r?"offer":"answer",s=new nd(n,r,o);r===e&&(s.sdpRemote=t.sdp,n.startAnswerTimer()),n.peerConnections[r]=s}}))},e.prototype.processOnAccept=function(e,t){return k(this,void 0,void 0,(function(){var n,r;return T(this,(function(i){switch(i.label){case 0:(n=this.peerConnections[e])||td.traceWarning("Ignore 'OnAccept', there is no information about peer connection by some reason"),i.label=1;case 1:return i.trys.push([1,3,,4]),n.clearDialingTimer(),[4,n.setRemoteSessionDescription("answer",t.sdp)];case 2:return i.sent(),td.trace("'setRemoteSessionDescription' success"),[3,4];case 3:return r=i.sent(),td.traceError("'setRemoteSessionDescription' error: ".concat(r)),[3,4];case 4:return[2]}}))}))},e.prototype.processOnReject=function(e){var t=this.peerConnections[e];this.clearWaitingOfferOrAnswerTimer(),t?t.release():td.traceWarning("Ignore 'OnReject', there is no information about peer connection by some reason"),this.closeSessionIfAllConnectionsClosed()},e.prototype.processOnStop=function(e){var t=this;if(this.clearAnswerTimer(),e===this.initiatorID){var n=Object.keys(this.peerConnections);n.length>0?n.forEach((function(e){t.peerConnections[e].release()})):td.traceWarning("Ignore 'OnStop', there is no information about peer connections by some reason")}else{var r=this.peerConnections[e];r?r.release():td.traceWarning('Ignore "OnStop", there is no information about peer connection by some reason')}this.closeSessionIfAllConnectionsClosed()},e.prototype.processOnIceCandidates=function(e,t){return k(this,void 0,void 0,(function(){var n;return T(this,(function(r){switch(r.label){case 0:return(n=this.peerConnections[e])||td.traceWarning('Ignore "OnIceCandidates", there is no information about peer connection by some reason'),t.iceCandidates?[4,n.addCandidates(t.iceCandidates)]:[3,2];case 1:r.sent(),r.label=2;case 2:return[2]}}))}))},e.prototype.processOnIceRestart=function(e,t){return k(this,void 0,void 0,(function(){var n,r,i,o,s;return T(this,(function(a){switch(a.label){case 0:(n=this.peerConnections[e])||td.traceWarning('Ignore "OnIceRestart", there is no information about peer connection by some reason'),a.label=1;case 1:return a.trys.push([1,4,,5]),[4,n.setRemoteSessionDescription("offer",t.sdp)];case 2:return a.sent(),[4,n.getAndSetLocalSessionDescription(this.maxBandwidth)];case 3:return r=a.sent().sdp,i={sessionID:null!==(s=this.ID)&&void 0!==s?s:"",sdp:r},this.signalingProvider.sendMessage(e,i,Uu.RESTART_ACCEPT),td.trace("[processOnIceRestart] Success"),[3,5];case 4:return o=a.sent(),td.traceError("[processOnIceRestart] Error: ".concat(o)),[3,5];case 5:return[2]}}))}))},e.prototype.processOnIceRestartAccept=function(e,t){return k(this,void 0,void 0,(function(){var n,r;return T(this,(function(i){switch(i.label){case 0:(n=this.peerConnections[e])||td.traceWarning('Ignore "OnIceRestartAccept", there is no information about peer connection by some reason'),i.label=1;case 1:return i.trys.push([1,3,,4]),[4,n.setRemoteSessionDescription("answer",t.sdp)];case 2:return i.sent(),td.trace("[processOnIceRestartAccept] Success"),[3,4];case 3:return r=i.sent(),td.traceError("[processOnIceRestartAccept] Error: ".concat(r)),[3,4];case 4:return[2]}}))}))},e.prototype.processCall=function(e,t){void 0===t&&(t={});var n=Object.assign({userInfo:{}},t,{sessionID:this.ID,callType:this.callType,callerID:this.initiatorID,opponentsIDs:this.opponentsIDs,sdp:e.localDescription.sdp});this.signalingProvider.sendMessage(e.userID,n,Uu.CALL)},e.prototype.processIceCandidates=function(e,t){var n,r={sessionID:null!==(n=this.ID)&&void 0!==n?n:"",callType:this.callType,callerID:this.initiatorID,opponentsIDs:this.opponentsIDs};this.signalingProvider.sendCandidate(e,t,r)},e.prototype.processOnNotAnswer=function(e){td.trace("Answer timeout callback for session ".concat(this.ID," for user ").concat(e.userID)),this.clearWaitingOfferOrAnswerTimer(),e.release(),O.safeCallbackCall(this.onUserNotAnswerListener)(this,e.userID),this.closeSessionIfAllConnectionsClosed()},e.prototype.onRemoteStream=function(e,t){O.safeCallbackCall(this.onRemoteStreamListener)(this,e,t)},e.prototype.onCallStatsReport=function(e,t,n){O.safeCallbackCall(this.onCallStatsReportListener)(this,e,t,n)},e.prototype.onSessionConnectionStateChanged=function(e,t){O.safeCallbackCall(this.onSessionConnectionStateChangedListener)(this,e,t)},e.prototype.close=function(){Object.values(this.peerConnections).forEach((function(e){try{e.release()}catch(e){O.DLog("Peer close error: ".concat(e))}})),this.closeLocalMediaStream(),this.state=Bu.CLOSED,O.safeCallbackCall(this.onSessionCloseListener)(this)},e.prototype.closeSessionIfAllConnectionsClosed=function(){var e=!0;Object.values(this.peerConnections).forEach((function(t){var n=!1;try{n="closed"===t.iceConnectionState||"closed"===t.signalingState||t.released}catch(e){td.traceError(e),n=!0}e=n})),td.trace("All peer connections closed: ".concat(e)),e&&(this.closeLocalMediaStream(),O.safeCallbackCall(this.onSessionCloseListener)(this),this.state=Bu.CLOSED)},e.prototype.closeLocalMediaStream=function(){this.localStream&&(this.localStream.getTracks().forEach((function(e){return e.stop()})),this.localStream=void 0,this.mediaParams={})},e.prototype.mute=function(e){this.muteStream(!1,e)},e.prototype.unmute=function(e){this.muteStream(!0,e)},e.prototype.muteStream=function(e,t){var n,r;void 0===t&&(t="none");var i="audio"===t?null===(n=this.localStream)||void 0===n?void 0:n.getAudioTracks():"video"===t?null===(r=this.localStream)||void 0===r?void 0:r.getVideoTracks():[];null==i||i.forEach((function(t){t.enabled=e}))},e.prototype.clearAnswerTimer=function(){this.answerTimer&&(td.trace("clearAnswerTimer"),clearTimeout(this.answerTimer),this.answerTimer=null)},e.prototype.startAnswerTimer=function(){var e=this;td.trace("startAnswerTimer"),this.answerTimer=setTimeout((function(){td.trace("answerTimeoutCallback"),e.close(),e.answerTimer=null}),1e3*E.videochat.answerTimeInterval)},e.prototype.clearWaitingOfferOrAnswerTimer=function(){this.waitingOfferOrAnswerTimer&&(td.trace("clearWaitingOfferOrAnswerTimer"),clearTimeout(this.waitingOfferOrAnswerTimer),this.waitingOfferOrAnswerTimer=null)},e.prototype.startWaitingOfferOrAnswerTimer=function(){var e=this,t=(this.acceptCallTime-this.startCallTime)/1e3,n=Math.max(E.videochat.answerTimeInterval-t,1);td.trace("startWaitingOfferOrAnswerTimer, timeout: ".concat(n)),this.waitingOfferOrAnswerTimer=setTimeout((function(){td.trace("waitingOfferOrAnswerTimeoutCallback"),Object.values(e.peerConnections).forEach((function(t){t.state!==Fu.CONNECTING&&t.state!==Fu.NEW||e.processOnNotAnswer(t)})),e.waitingOfferOrAnswerTimer=null}),1e3*n)},e.prototype.toString=function(){return"ID: ".concat(this.ID,", initiatorID: ").concat(this.initiatorID,", opponentsIDs: ").concat(this.opponentsIDs,", state: ").concat(this.state,", callType: ").concat(this.callType)},Object.defineProperty(e.prototype,"startCallTime",{get:function(){return this.startCallDate.getTime()},set:function(e){this.startCallDate=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"acceptCallTime",{get:function(){return this.acceptCallDate.getTime()},set:function(e){this.acceptCallDate=e},enumerable:!1,configurable:!0}),e}();function id(e){void 0===e&&(e={});var t={userInfo:e};try{O.isObject(e)?t.userInfo=O.cloneObject(e,!0):td.traceWarning('Ignore "prepareExtension", must be an object')}catch(e){td.traceWarning(e.message)}return t}var od=function(){function e(e){var t=this;this.onMessage=function(e,n){var r,i=t.getExtension(n),o=null!==(r=null==i?void 0:i.sessionID)&&void 0!==r?r:"",s=null==i?void 0:i.signalType;switch(null==i||delete i.moduleIdentifier,null==i||delete i.sessionID,null==i||delete i.signalType,s){case Uu.CALL:t.delegate.onCallHandler(e,o,i);break;case Uu.ACCEPT:t.delegate.onAcceptHandler(e,o,i);break;case Uu.REJECT:t.delegate.onRejectHandler(e,o,i);break;case Uu.STOP:t.delegate.onStopHandler(e,o,i);break;case Uu.CANDIDATE:t.delegate.onIceCandidatesHandler(e,o,i);break;case Uu.RESTART:t.delegate.onIceRestartHandler(e,o,i);break;case Uu.RESTART_ACCEPT:t.delegate.onIceRestartAcceptHandler(e,o,i)}},this.delegate=e}return e.prototype.getExtension=function(e){var t,n;if(!e)return{};var r={iceCandidates:[],opponentsIDs:[]};return wu.getChildElements(e).forEach((function(e){var t,n=wu.getChildElements(e),i=null!==(t=wu.getName(e))&&void 0!==t?t:"";switch(i){case"callerID":r[i]=parseInt(wu.getText(e)||"0");break;case"callType":var o=wu.getText(e);r[i]="1"===o?qu.VIDEO:"2"===o?qu.AUDIO:void 0;break;case"iceCandidates":n.forEach((function(e){var t,n={};wu.getChildElements(e).forEach((function(e){var t=wu.getName(e)||"",r=wu.getText(e);n[t]="sdpMLineIndex"===t?parseInt(r||"0"):r})),null===(t=r.iceCandidates)||void 0===t||t.push(n)}));break;case"opponentsIDs":n.forEach((function(e){var t;null===(t=r.opponentsIDs)||void 0===t||t.push(parseInt(wu.getText(e)||"0"))}));break;default:n.length>1?(wu.getText(e)||"").length>4096?r[i]=n.reduce((function(e,t){return e+wu.getText(t)}),""):wu.assignXmlToObject(e,r):"userInfo"===i?wu.assignXmlToObject(e,r):r[i]=wu.getText(e)}})),0===(null===(t=r.iceCandidates)||void 0===t?void 0:t.length)&&delete r.iceCandidates,0===(null===(n=r.opponentsIDs)||void 0===n?void 0:n.length)&&delete r.opponentsIDs,r},e}(),sd=function(){function e(e){this.signalingConnection=e}return e.prototype.sendCandidate=function(e,t,n){void 0===n&&(n={});var r=Object.assign({},n,{iceCandidates:t});this.sendMessage(e,r,Uu.CANDIDATE)},e.prototype.sendMessage=function(e,t,n){var r=Object.assign({},t);r.moduleIdentifier="WebRTCVideoChat",r.signalType=n,r.platform=O.env.isBrowser?"web":O.env.isReactNative||O.env.isExpo?"mobile":"node",r.userInfo&&(Object.keys(r.userInfo).length?0===r.userInfo.maxBandwidth&&delete r.userInfo.maxBandwidth:delete r.userInfo);var i=wu.createMessageStanza({to:td.getUserJid(e),type:"headline",id:O.getBsonObjectId()}).c("extraParams",{xmlns:"jabber:client"});Object.keys(r).forEach((function(e){var t=r[e];"iceCandidates"===e?(i=i.c("iceCandidates"),t.forEach((function(e){i=i.c("iceCandidate"),Object.keys(e).forEach((function(t){i=i.c(t).t(e[t]).up()})),i=i.up()})),i=i.up()):"opponentsIDs"===e?(i=i.c("opponentsIDs"),t.forEach((function(e){i=i.c("opponentID").t(e).up()})),i=i.up()):"object"==typeof t?wu.assignObjectToXml(i,t,e):i=i.c(e).t(t).up()})),i=i.up(),this.signalingConnection.send(i)},e}(),ad=function(){function e(e,t){this.SessionConnectionState=zu,this.PeerConnectionState=Fu,this.CallType=qu,this.sessions={},this.onDevicesChangeListener=function(){},this.connection=e,this.proxy=t,this.signalingProcessor=new od(this),this.signalingProvider=new sd(e),d&&(d.ondevicechange=O.safeCallbackCall(this.onDevicesChangeListener))}return e.prototype.getMediaDevices=function(e){return k(this,void 0,void 0,(function(){var t;return T(this,(function(n){switch(n.label){case 0:return(null==d?void 0:d.enumerateDevices)?[4,d.enumerateDevices()]:[3,2];case 1:return t=n.sent(),[2,e?t.filter((function(t){return t.kind===e})):t];case 2:throw new Error("No 'enumerateDevices' API supported")}}))}))},e.prototype.createNewSession=function(e,t,n){var r,i,o,s,a=null!==(i=null===(r=this.connection.jid)||void 0===r?void 0:r.toString())&&void 0!==i?i:"",c=null!==(o=td.getUserIdFromJID(a))&&void 0!==o?o:0,l=null!==(s=(null==n?void 0:n.maxBandwidth)||(null==n?void 0:n.bandwidth))&&void 0!==s?s:0;if(!e)throw new Error("Can't create a session without opponentsIDs");return this.createAndStoreSession(null,c,e,t,l)},e.prototype.createAndStoreSession=function(e,t,n,r,i){var o,s,a;void 0===i&&(i=0);var c=null!==(s=null===(o=this.connection.jid)||void 0===o?void 0:o.toString())&&void 0!==s?s:"",l=null!==(a=td.getUserIdFromJID(c))&&void 0!==a?a:0,u=new rd({ID:e,initiatorID:t,opponentsIDs:n,callType:r,signalingProvider:this.signalingProvider,currentUserID:l,maxBandwidth:i});return u.onUserNotAnswerListener=this.onUserNotAnswerListener,u.onRemoteStreamListener=this.onRemoteStreamListener,u.onSessionConnectionStateChangedListener=this.onSessionConnectionStateChangedListener,u.onSessionCloseListener=this.onSessionCloseListener,u.onCallStatsReportListener=this.onCallStatsReport,(null==u?void 0:u.ID)&&(this.sessions[u.ID]=u),u},e.prototype.clearSession=function(e){delete this.sessions[e]},e.prototype.callRejectRequest=function(e){var t={type:I.POST,url:O.getUrl(E.urls.calls,"reject"),data:e};return this.proxy.ajax(t)},e.prototype.onCallHandler=function(e,t,n){var r,i=n.userInfo||{},o=Number(null!==(r=i.maxBandwidth)&&void 0!==r?r:0),s=this.sessions[t];td.trace("onCall. userID: ".concat(e,", sessionID: ").concat(t,", extension: ").concat(JSON.stringify(n))),s||(s=this.createAndStoreSession(t,n.callerID||0,n.opponentsIDs||[],n.callType||qu.VIDEO,o),O.safeCallbackCall(this.onCallListener)(s,i)),s.processOnCall(e,n)},e.prototype.onAcceptHandler=function(e,t,n){var r=this.sessions[t],i=n.userInfo||{};td.trace("onAccept. UserID: ".concat(e,", sessionID: ").concat(t,", extension: ").concat(JSON.stringify(n))),!r||r.state!==Bu.ACTIVE&&r.state!==Bu.NEW?td.traceWarning("Ignore 'onAccept', there is no information about session ".concat(t)):(O.safeCallbackCall(this.onAcceptCallListener)(r,e,i),r.processOnAccept(e,n))},e.prototype.onRejectHandler=function(e,t,n){var r=this.sessions[t];if(td.trace("onReject. UserID: ".concat(e,", sessionID: ").concat(t,", extension: ").concat(JSON.stringify(n))),r){var i=n.userInfo||{};O.safeCallbackCall(this.onRejectCallListener)(r,e,i),r.processOnReject(e)}else td.traceWarning("Ignore 'onReject', there is no information about session ".concat(t))},e.prototype.onStopHandler=function(e,t,n){td.trace("onStop. UserID: ".concat(e,", sessionID: ").concat(t,", extension: ").concat(JSON.stringify(n)));var r=this.sessions[t],i=n.userInfo||{};!r||r.state!==Bu.ACTIVE&&r.state!==Bu.NEW?(O.safeCallbackCall(this.onInvalidEventsListener)(r,e,i),td.traceWarning("Ignore 'onStop', there is no information about session ".concat(t," by some reason"))):(r.processOnStop(e),O.safeCallbackCall(this.onStopCallListener)(r,e,i))},e.prototype.onIceCandidatesHandler=function(e,t,n){var r,i,o=this.sessions[t];td.trace("onIceCandidates. UserID: ".concat(e,". SessionID: ").concat(t,". ICE candidates count: ").concat(null!==(i=null===(r=n.iceCandidates)||void 0===r?void 0:r.length)&&void 0!==i?i:0)),o?o.state===Bu.ACTIVE?o.processOnIceCandidates(e,n):td.traceWarning("Ignore 'OnIceCandidates', the session ( ".concat(t," ) has invalid state")):td.traceWarning("Ignore 'OnIceCandidates', there is no information about session ".concat(t))},e.prototype.onIceRestartHandler=function(e,t,n){var r=this.sessions[t];td.trace("onIceRestart. UserID: ".concat(e,". SessionID: ").concat(t,". Extension: ").concat(JSON.stringify(n))),r?r.state===Bu.ACTIVE?r.processOnIceRestart(e,n):td.traceWarning("Ignore 'OnIceRestart', the session (".concat(t,") has invalid state")):td.traceWarning("Ignore 'OnIceRestart', there is no information about session ".concat(t))},e.prototype.onIceRestartAcceptHandler=function(e,t,n){var r=this.sessions[t];td.trace("onIceRestartAccept. UserID: ".concat(e,". SessionID: ").concat(t,". Extension: ").concat(JSON.stringify(n))),r?r.state===Bu.ACTIVE?r.processOnIceRestartAccept(e,n):td.traceWarning("Ignore 'onIceRestartAccept', the session (".concat(t,") has invalid state")):td.traceWarning("Ignore 'onIceRestartAccept', there is no information about session ".concat(t))},e.prototype.getListenerByName=function(e){switch(e){case Wu.CALL:return"onCallListener";case Wu.ACCEPT:return"onAcceptCallListener";case Wu.REJECT:return"onRejectCallListener";case Wu.HUNG_UP:return"onStopCallListener";case Wu.INVALID:return"onInvalidEventsListener";case Wu.NOT_ANSWER:return"onUserNotAnswerListener";case Wu.REMOTE_STREAM:return"onRemoteStreamListener";case Wu.CONNECTION_STATE:return"onSessionConnectionStateChangedListener";case Wu.CLOSE:return"onSessionCloseListener";case Wu.STATS_REPORT:return"onCallStatsReport";case Wu.DEVICES:return"onDevicesChangeListener";default:return null}},e.prototype.addListener=function(e,t){var n=this.getListenerByName(e);return n&&(this[n]=t),this.removeListener.bind(this,e)},e.prototype.removeListener=function(e){var t=this.getListenerByName(e);t&&(this[t]=e===Wu.DEVICES?function(){}:void 0)},e.prototype.removeAllListeners=function(){var e=this;Object.keys(this).forEach((function(t){t.startsWith("on")&&t.endsWith("Listener")&&"function"==typeof e[t]&&(e[t]="onDevicesChangeListener"===t?function(){}:void 0)}))},e}(),cd=function(){function e(e){this.route=E.urls.whiteboards,this.server=E.whiteboard.server,this.proxy=e}return e.prototype.getURL=function(e){var t=e.id,n=e.title,r=e.username;return"".concat(this.server,"?whiteboardid=").concat(t,"&username=").concat(r,"&title=").concat(n)},e.prototype.get=function(e){return k(this,void 0,void 0,(function(){var t;return T(this,(function(n){return t={type:I.GET,url:O.getUrl(this.route),data:"string"==typeof e?{chat_dialog_id:e}:e},[2,this.proxy.ajax(t)]}))}))},e.prototype.create=function(e){return k(this,void 0,void 0,(function(){var t;return T(this,(function(n){return t={type:I.POST,url:O.getUrl(this.route),data:e},[2,this.proxy.ajax(t)]}))}))},e.prototype.update=function(e,t){return k(this,void 0,void 0,(function(){var n;return T(this,(function(r){return n={type:I.PUT,url:O.getUrl(this.route,e),data:t},[2,this.proxy.ajax(n)]}))}))},e.prototype.delete=function(e){return k(this,void 0,void 0,(function(){var t;return T(this,(function(n){return t={type:I.DELETE,url:O.getUrl(this.route,e),dataType:R.TEXT},[2,this.proxy.ajax(t)]}))}))},e}();return new(function(){function e(){this.ConnectyCube=e}return e.prototype.init=function(e,t){void 0===t&&(t={}),t&&"object"==typeof t&&E.set(t),this.utils=O,this.service=new Xu,this.auth=new L(this.service),this.users=new ed(this.service),this.storage=new Qu(this.service),this.pushnotifications=new Yu(this.service),this.data=new Hu(this.service),this.addressbook=new A(this.service),this.chat=new Ru(this.service),this.meeting=new Zu(this.service),this.whiteboard=new cd(this.service),b&&(this.videochat=new ad(this.chat.xmppClient,this.service),this.videochatconference=new Ju(this.service),this.chat.webrtcSignalingProcessor=this.videochat.signalingProcessor),e.token?(E.creds.appId=e.appId,this.service.setSession({token:e.token})):(E.creds.appId=e.appId,E.creds.authKey=e.authKey),this.setSession=this.auth.setSession,this.getSession=this.auth.getSession,this.createSession=this.auth.createSession,this.destroySession=this.auth.destroySession,this.login=this.auth.login,this.logout=this.auth.logout},e}())}));
//# sourceMappingURL=connectycube.min.js.map
